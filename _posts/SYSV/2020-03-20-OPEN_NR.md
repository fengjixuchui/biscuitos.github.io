---
layout: post
title:  "sys_open: æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°é—®é¢˜"
date:   2019-11-27 08:35:30 +0800
categories: [HW]
excerpt: syscall.
tags:
  - syscall
---

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

#### ç›®å½•

> - [é—®é¢˜ä»‹ç»](#A0)
>
> - é—®é¢˜å®è·µ
>
>   - [è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ•°å¤ªå¤šå¯¼è‡´å¤±è´¥é—®é¢˜](#B250)
>
>   - [è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦è¶…è¿‡ sysctl_nr_open å¯¼è‡´æ‰“å¼€å¤±è´¥é—®é¢˜](#B251)
>
>   - [sysctl_nr_open ä¸èƒ½å¤Ÿå‡†ç¡®æ§åˆ¶æ‰“å¼€æ–‡ä»¶çš„æ•°é‡é—®é¢˜](#B252)
>
>   - [ä¸åŒæ–‡ä»¶ç³»ç»Ÿæ”¯æŒè¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°é—®é¢˜](#B253)
>
> - [é™„å½•/æèµ ](#Z0)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000P.jpg)

#### é—®é¢˜ä»‹ç»

{% highlight c %}
current->files->fdt->max_fds
{% endhighlight %}

è¿›ç¨‹å°†ä¸æ–‡ä»¶ç›¸å…³çš„ä¿¡æ¯å­˜å‚¨åœ¨ struct task_struct çš„ files æˆå‘˜é‡Œï¼Œfiles æ˜¯
ä¸€ä¸ª struct files_struct çš„ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«äº† fdt æˆå‘˜ï¼Œè¯¥æˆå‘˜ç”¨äºç»´æŠ¤è¿›ç¨‹
æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å½“è¿›ç¨‹æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ°æ–‡ä»¶æè¿°ç¬¦è¡¨ fdt ä¸­åˆ†é…
ä¸€ä¸ªå¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥æ–‡ä»¶æè¿°ç¬¦å°†ä½œä¸ºæ–°æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦ã€‚

é‚£ä¹ˆæ ¹æ®å®è·µå’Œä¸Šé¢çš„ä»‹ç»ï¼Œæå‡ºä»¥ä¸‹å‡ ä¸ªç–‘é—®:

> - ä¸€ä¸ªè¿›ç¨‹èƒ½å¤Ÿæ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°æ˜¯å¤šå°‘?
>
> - å¦‚æœå½“å‰æ‰“å¼€æ–‡ä»¶æ•°è¶…è¿‡è¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ï¼Œé‚£ä¹ˆè¿›ç¨‹èƒ½å¦æ‰©å……æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°?
>
> - VFS è§„å®šçš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°æ˜¯å¤šå°‘?
>
> - å†…æ ¸å¯ä»¥å‘ç”¨æˆ·æä¾›é‚£äº›å‚æ•°æ¥åŠ¨æ€ä¿®æ”¹è¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°çš„é™åˆ¶?
>
> - è¿›ç¨‹æ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°æ˜¯å¦ä¸å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿæœ‰å…³?

ä¸‹é¢æ˜¯ä¸é—®é¢˜ç›¸å…³çš„èµ„æ–™æˆ–ä¿¡æ¯:

> - [struct files_struct ç»“æ„è§£æ](https://biscuitos.github.io/blog/SYSCALL_sys_open/#A00011D)
>
> - [struct fdtable ç»“æ„è§£æ](https://biscuitos.github.io/blog/SYSCALL_sys_open/#header)
>
> - [VFS åˆ†é…æ–‡ä»¶æè¿°ç¬¦æºç è§£æ](https://biscuitos.github.io/blog/OPEN_SOURCE_CODE/#A0000014)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

<span id="B250"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000T.jpg)

#### è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ•°å¤ªå¤šå¯¼è‡´å¤±è´¥é—®é¢˜

> - [é—®é¢˜æè¿°](#B2500)
>
> - [é—®é¢˜å®è·µ](#B2501)
>
> - [é—®é¢˜åˆ†æä¸è§£å†³](#B2502)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

#### <span id="B2500">é—®é¢˜æè¿°</span>

åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œé»˜è®¤è®¾ç½®äº†æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ï¼Œå…¶å€¼é€šè¿‡å¦‚ä¸‹å¯ä»¥è®¿é—®:

{% highlight c %}
current->files->fdt->max_fds
{% endhighlight %}

é€šè¿‡ä¸Šé¢çš„å…³ç³»ï¼Œå¯ä»¥è·å¾—å½“å‰è¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ï¼Œå½“è¿›ç¨‹çš„æ–‡ä»¶æ‰“å¼€æ•°è¶…è¿‡è¿™ä¸ª
é™å®šä¹‹åï¼Œå†…æ ¸ä¼šè§¦å‘ç›¸åº”çš„æ“ä½œï¼Œä¾‹å¦‚å¢å¤§è¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ï¼Œä»¥ä¾¿æ”¯æŒæ›´å¤š
çš„æ–‡ä»¶æ‰“å¼€æ•°ï¼Œæˆ–è€…ç”±äºæ–‡ä»¶æ‰“å¼€æ•°å·²ç»è¶…è¿‡æŸä¸ªé™åˆ¶ï¼Œé‚£ä¹ˆæ–‡ä»¶æ‰“å¼€æ“ä½œå°±æŠ¥é”™ï¼Œ
ä¹Ÿè®¸ä¹Ÿä¼šå› ä¸ºç‰¹å®šçš„æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ä¹Ÿå­˜åœ¨ä¸åŒã€‚ä»¥ä¸Šçš„ç§ç§åŸå› 
éƒ½æœ‰å¯èƒ½å‡ºç°ï¼Œæœ¬èŠ‚å°†ç ”ç©¶æ¶‰åŠçš„å†…å®¹ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="B2501">é—®é¢˜å®è·µ</span>

ä¸ºäº†è®©å¼€å‘è€…èƒ½å¤Ÿå®è·µè¿™ä¸ªé—®é¢˜ï¼ŒBiscuitOS æä¾›äº†ç›¸å…³çš„å®è·µå·¥å…·å’Œç¯å¢ƒï¼Œ
å¼€å‘è€…å¯ä»¥å‚è€ƒä¸‹é¢æ–‡æ¡£æŸ¥çœ‹å·¥å…·çš„å…·ä½“ä½¿ç”¨:

> - [BiscuitOS æ‰“å¼€ä»»æ„ä¸ªæ–‡ä»¶å·¥å…·](https://biscuitos.github.io/blog/SYSCALL_sys_open/#C2)

éƒ¨ç½²å¥½ç¯å¢ƒå’Œå·¥å…·ä¹‹åï¼Œè¿è¡Œ BiscuitOS å¹¶ä½¿ç”¨å¦‚ä¸‹æµ‹è¯•å‘½ä»¤:

{% highlight c %}
number_open_common-0.0.1 -n 8 -d 7 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
ls -l BiscuitOS*
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000682.png)

é€šè¿‡ä¸Šé¢çš„å‘½ä»¤ï¼Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­åˆ›å»ºäº† 8 ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¾æ¬¡ä» 3 å¢åŠ åˆ° 10ï¼Œ
æ–‡ä»¶æ­£ç¡®è¢«åˆ›å»ºï¼Œæ­¤æ—¶å¯ä»¥åœ¨å†…æ ¸æºç ä¸­ "\_\_alloc_fd()" å‡½æ•°é‡Œæ·»åŠ å¦‚ä¸‹:

> - [get_unused_fd_flags() æºç è§£æ](https://biscuitos.github.io/blog/OPEN_SOURCE_CODE/#A0000014)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000683.png)

é‡æ–°ç¼–è¯‘å†…æ ¸å†è¿è¡Œ BiscuitOS, ä½¿ç”¨å’Œä¸Šé¢ä¸€æ ·çš„æµ‹è¯•å‘½ä»¤:

{% highlight c %}
number_open_common-0.0.1 -n 8 -d 7 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000684.png)

ä»ä¸Šé¢çš„è¿è¡Œæ•ˆæœå¯ä»¥çœ‹å‡ºï¼Œå½“å‰è¿›ç¨‹æ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°æ˜¯ 32ï¼Œé‚£ä¹ˆæ¥ç€ä½¿ç”¨
å¦‚ä¸‹æµ‹è¯•å‘½ä»¤:

{% highlight c %}
number_open_common-0.0.1 -n 30 -d 29 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000685.png)

ä»ä¸Šé¢çš„è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œè¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ç”± 32 å˜æˆäº† 256ã€‚å› æ­¤
å¯ä»¥ç¡®å®šè¿›ç¨‹æ˜¯å¯ä»¥åŠ¨æ€å¢åŠ æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ï¼Œä½†æ˜¯ä¸æ˜¯å¯ä»¥æ— é™å¢å¤§å‘¢? ç»§ç»­
ä½¿ç”¨æµ‹è¯•å‘½ä»¤:

{% highlight c %}
number_open_common-0.0.1 -n 254 -d 253 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000686.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œè¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ç”± 256 å¢åŠ åˆ° 512ï¼Œç»§ç»­ä½¿ç”¨æµ‹è¯•å‘½ä»¤:

{% highlight c %}
number_open_common-0.0.1 -n 510 -d 509 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000687.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œè¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ç”± 512 å¢åŠ åˆ° 1024ï¼Œç»§ç»­ä½¿ç”¨æµ‹è¯•å‘½ä»¤:

{% highlight c %}
number_open_common-0.0.1 -n 1021 -d 1020 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000688.png)

æ­¤æ—¶åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æ‰“å¼€ 1021 ä¸ªæ–‡ä»¶æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œé‚£ä¹ˆæ‰“å¼€ 1022 ä¸ªæ–‡ä»¶å‘¢? ä½¿ç”¨
æµ‹è¯•å‘½ä»¤:

{% highlight c %}
number_open_common-0.0.1 -n 1022 -d 1021 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000689.png)

æ­¤æ—¶ç³»ç»Ÿæ— æ³•ä¸ºè¿›ç¨‹åˆ†é…æ–‡ä»¶æè¿°ç¬¦ä¸º 1024 çš„æ–‡ä»¶ï¼Œæ–‡ä»¶æ‰“å¼€å¤±è´¥ã€‚å½“å‰ä½¿ç”¨çš„
æ–‡ä»¶ç³»ç»Ÿæ˜¯ rootfsï¼Œé‚£ä¹ˆæ¢ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ tmpfs è¿›è¡Œæµ‹è¯•:

{% highlight c %}
cd /tmp
number_open_common-0.0.1 -n 1022 -d 1021 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000690.png)

æ¢äº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä¸€ä¸ªè¿›ç¨‹æ‰“å¼€ 1022 ä¸ªæ–‡ä»¶çš„æ—¶å€™è¿˜æ˜¯å¤±è´¥äº†ã€‚é—®é¢˜æœ€ç»ˆå¤ç°
æ­£å¦‚ä¸Šé¢æ‰€æè¿°çš„ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="B2502">é—®é¢˜åˆ†æä¸è§£å†³</span>

å¯¹äºè§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ç›´æ¥è·Ÿè¸ªæºç è¿›è¡Œé—®é¢˜çš„è¿½è¸ªï¼Œå…·ä½“æºç å¦‚ä¸‹:

> - [\_\_alloc_fd() å‡½æ•°è§£æ](https://biscuitos.github.io/blog/OPEN_SOURCE_CODE/#A0000003)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000593.png)

è¯¥å‡½æ•°å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦åˆ†é…çš„æ ¸å¿ƒå‡½æ•°ï¼Œä¿®æ”¹æºç å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000692.png)

é‡æ–°ç¼–è¯‘æºç å¹¶è¿è¡Œ BiscuitOS, ä½¿ç”¨å¦‚ä¸‹æµ‹è¯•å‘½ä»¤:

{% highlight c %}
number_open_common-0.0.1 -n 1022 -d 1021 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000693.png)

ä»ä¸Šé¢è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œå½“æ‰“å¼€ç¬¬ 1022 ä¸ªæ–‡ä»¶æ—¶å€™ï¼Œæ­¤æ—¶éœ€è¦åˆ†é…çš„æ–‡ä»¶æè¿°ç¬¦
æ­£å¥½æ˜¯ 1024ï¼Œä½†è¿™è¶…å‡ºäº† \_\_alloc_fd() å‡½æ•°çš„ end å‚æ•°é™åˆ¶ï¼Œå› æ­¤å‡½æ•°åˆ¤æ–­
å‡ºç°é”™è¯¯ï¼Œå¹¶è¿”å› -EMFILE, å…¶é”™è¯¯å€¼æ­£å¥½æ˜¯ 24ï¼Œä¸€åˆ‡å»åˆï¼Œé‚£ä¹ˆä¸Šé¢é‡åˆ°çš„é—®é¢˜
å°±æ˜¯ç”±è¿™é‡Œå¼•èµ·çš„ã€‚æ¥ä¸‹é‡Œåˆ†æå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

------------------------------------------------

#### é—®é¢˜è§£å†³

é¦–å…ˆè¿™ä¸ªé—®é¢˜æ˜¯åœ¨åˆ†é…æ–‡ä»¶æè¿°ç¬¦çš„è¿‡ç¨‹ä¸­ï¼Œå¾…åˆ†é…çš„æ–‡ä»¶æè¿°ç¬¦è¶…è¿‡ \_\_alloc_fd()
å‡½æ•° end å‚æ•°èŒƒå›´çš„é™å®šå¯¼è‡´çš„ã€‚æ ¹æ®ä¸‹å›¾å›æº¯åˆ°è°ƒç”¨ \_\_alloc_fd() å‡½æ•°çš„åœ°æ–¹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000593.png)

> - [get_unused_fd_flags() å‡½æ•°è§£æ](https://biscuitos.github.io/blog/OPEN_SOURCE_CODE/#A0000014)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000671.png)

åœ¨è°ƒç”¨ \_\_alloc_fd() å‡½æ•°çš„ä¹‹åï¼Œget_unused_fd_flags() å‡½æ•°ä¼ é€’äº† 0 å’Œ
"rlimit(RLIMIT_NOFILE)" å‚æ•°ä½œä¸ºæ–‡ä»¶æè¿°ç¬¦çš„èŒƒå›´ï¼Œå› æ­¤ "rlimit(RLIMIT_NOFILE)"
å°±æ˜¯é—®é¢˜çš„æ ¸å¿ƒ, å¼€å‘è€…å¯ä»¥äº†è§£å‡½æ•°çš„å…·ä½“å®ç°:

> - [rlimit() å‡½æ•°è§£æ](https://biscuitos.github.io/blog/OPEN_SOURCE_CODE/#A0000015)

é€šè¿‡ rlimit() å‡½æ•°çš„äº†è§£ï¼ŒRLIMIT_NOFILE èµ„æºåœ¨è¿›ç¨‹åˆ›å»ºçš„æ—¶å€™è®¾ç½®äº†ä¸€ä¸ªåˆå§‹å€¼
ä¸º 1024ï¼Œå¦‚æœè¦è®©è¿›ç¨‹æ”¯æŒæ›´å¤šæ–‡ä»¶æ‰“å¼€æ•°ï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹ RLIMIT_NOFILE å¯¹åº”çš„
èµ„æºé™åˆ¶ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ ulimit å·¥å…·åŠ¨æ€ä¿®æ”¹ã€‚å¼€å‘è€…å¯ä»¥åœ¨ BiscuitOS
ä¸Šä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œå¦‚ä¸‹:

{% highlight c %}
ulimit -a
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000698.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º "-n: file descriptors" çš„é™åˆ¶æ˜¯ 1024ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ ulimit
å·¥å…·åŠ¨æ€ä¿®æ”¹è¿™ä¸ªé™åˆ¶ï¼Œå¦‚ä¸‹:

{% highlight c %}
ulimit -n
ulimit -n 4096
ulimit -n
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000699.png)

ä¿®æ”¹æˆåŠŸä¹‹åï¼Œç„¶åå¼€å‘è€…ä½¿ç”¨è¿™å‰å¤±è´¥çš„æµ‹è¯•å‘½ä»¤:

{% highlight c %}
number_open_common-0.0.1 -n 1022 -d 1021 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000700.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œå½“å‰è¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°å·²ç»è¶…è¿‡ 1024 äº†ï¼Œé—®é¢˜å¾—åˆ°è§£å†³ã€‚é€šè¿‡
ä¸Šé¢çš„åˆ†æå¯ä»¥çŸ¥é“ rlimit(RLIMIT_NOFILE) æ˜¯ä¼šé™åˆ¶è¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ï¼Œä½†ä¸æ˜¯
å”¯ä¸€é™åˆ¶æ–‡ä»¶æœ€å¤§æ‰“å¼€æ•°çš„æ¡ä»¶ã€‚

ä¸‹å›¾æ˜¯è§£å†³è¿‡ç¨‹ä¸­è®¨è®ºè¿‡ç¨‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000701.jpg)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

<span id="B251"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000I.jpg)

#### è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦è¶…è¿‡ sysctl_nr_open å¯¼è‡´æ‰“å¼€å¤±è´¥é—®é¢˜

> - [é—®é¢˜æè¿°](#B2510)
>
> - [é—®é¢˜å®è·µ](#B2511)
>
> - [é—®é¢˜åˆ†æä¸è§£å†³](#B2512)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

#### <span id="B2510">é—®é¢˜æè¿°</span>

ä¸€ä¸ªè¿›ç¨‹æ˜¯ä¸å¯èƒ½æ— é™åˆ¶æ‰“å¼€æ–‡ä»¶ï¼Œå› æ­¤å†…æ ¸ä¼šå¯¹è¿›ç¨‹æˆ–è€…æ‰“å¼€çš„è¿‡ç¨‹è¿›è¡Œé™åˆ¶ã€‚
é‚£ä¹ˆæœ¬èŠ‚å°±æ¥ç ”ç©¶ sysctl_nr_open å¯¹è¿›ç¨‹æ–‡ä»¶æ‰“å¼€æ•°é‡çš„å½±å“ã€‚é€šè¿‡é—®é¢˜:

> - [è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ•°å¤ªå¤šå¯¼è‡´å¤±è´¥é—®é¢˜](#B250)

é€šè¿‡ä¸Šé¢é—®é¢˜çš„è®¨è®ºï¼Œå¯ä»¥çŸ¥é“ rlimit(NOFILE) ä¼šå¯¹è¿›ç¨‹æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°æœ‰
å½±å“ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿›ç¨‹åªèƒ½æ”¯æŒæœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°æ˜¯ 1024,ã€‚å¦‚æœé€šè¿‡ ulimit åŠ¨æ€
ä¿®æ”¹ï¼Œä¸‹ä¸€ä¸ªé™åˆ¶æ–‡ä»¶æ‰“å¼€æ•°çš„å› æ•°æ˜¯ sysctl_nr_open, å¼€å‘è€…å¯ä»¥åœ¨ Linux 
ä¸ŠæŸ¥çœ‹æˆ–è€…åŠ¨æ€ä¿®æ”¹:

{% highlight c %}
cat /proc/sys/fs/nr_open
{% endhighlight %}

nr_open å¯ä¾›ç”¨æˆ·åŠ¨æ€ä¿®æ”¹ VFS æ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ã€‚ä¾‹å¦‚:

{% highlight c %}
echo 512 > /proc/sys/fs/nr_open
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

#### <span id="B2511">é—®é¢˜å®è·µ</span>

ä¸ºäº†è®©å¼€å‘è€…èƒ½å¤Ÿå®è·µè¿™ä¸ªé—®é¢˜ï¼ŒBiscuitOS æä¾›äº†ç›¸å…³çš„å®è·µå·¥å…·å’Œç¯å¢ƒï¼Œ
å¼€å‘è€…å¯ä»¥å‚è€ƒä¸‹é¢æ–‡æ¡£æŸ¥çœ‹å·¥å…·çš„å…·ä½“ä½¿ç”¨:

> - [BiscuitOS æ‰“å¼€ä»»æ„é•¿åº¦æ–‡ä»¶åå·¥å…·](https://biscuitos.github.io/blog/SYSCALL_sys_open/#C1)

éƒ¨ç½²å¥½ç¯å¢ƒå’Œå·¥å…·ä¹‹åï¼Œè¿è¡Œ BiscuitOS, ä¸ºäº†æ’é™¤ "rlimit(NOFILE)" å¯¹æµ‹è¯•
çš„å½±å“ï¼Œå¯ä»¥å°† VFS æ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ•°è®¾ç½®çš„æ¯” "rlimit(NOFILE)" å°ï¼Œä¾‹å¦‚
ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

{% highlight c %}
echo 512 > /proc/sys/fs/nr_open
number_open_common-0.0.1 -n 510 -d 509 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000703.png)

ä»ä¸Šå›¾è¿è¡Œçš„ç»“æœå¯ä»¥çœ‹å‡ºå½“æ’é™¤å…¶ä»–å½±å“å› æ•°ä¹‹åï¼Œå½“å¾…åˆ†é…æ–‡ä»¶æè¿°ç¬¦å¤§äºæˆ–
ç­‰äº sysctl_nr_open çš„æ—¶å€™ï¼Œè¿›ç¨‹æ‰“å¼€æ–‡ä»¶ä¼šå¤±è´¥ï¼Œå¹¶è¿”å› -EMFILE é”™è¯¯ç ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

#### <span id="B2511">é—®é¢˜åˆ†æä¸è§£å†³</span>

å½“æ’é™¤å…¶ä»–å› æ•°çš„å‰æä¸‹ï¼ŒåŠ¨æ€ä¿®æ”¹ sysctl_nr_open çš„å€¼ä¹Ÿä¼šå½±å“è¿›ç¨‹æ–‡ä»¶æ‰“å¼€ï¼Œ
å…¶ç›¸å…³çš„æºç å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000711.png)

> - [expand_files å‡½æ•°è§£æ](https://biscuitos.github.io/blog/OPEN_SOURCE_CODE/#A0000005)

åœ¨ä¸Šé¢çš„å‡½æ•°ä¸­ä¿®æ”¹æºç å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000702.png)

é‡æ–°ç¼–è¯‘å†…æ ¸å¹¶è¿è¡Œ BiscuitOSï¼Œä½¿ç”¨å¦‚ä¸‹æµ‹è¯•å‘½ä»¤:

{% highlight c %}
echo 512 > /proc/sys/fs/nr_open
number_open_common-0.0.1 -n 510 -d 509 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

ä»ä¸Šé¢çš„è¿è¡Œæƒ…å†µå·²ç»å®šä½äº†é—®é¢˜å‡ºç°çš„ä»£ç ã€‚å› æ­¤å½“è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„æ—¶å€™ï¼Œä¹Ÿè¦
è€ƒè™‘ sysctl_nr_open çš„é™åˆ¶ã€‚

-------------------------------

#### è§£å†³åŠæ³•

å½“ç¡®å®šæ˜¯ sysctl_nr_open å¯¹è¿›ç¨‹æ–‡ä»¶æ‰“å¼€è¿‡ç¨‹äº§ç”Ÿäº†å½±å“ï¼Œé‚£ä¹ˆå¯ä»¥ç»™ sysctl_nr_open
åŠ¨æ€è®¾ç½®ä¸€ä¸ªåˆé€‚çš„å€¼ï¼Œä»¥ä¾¿è§£å†³é‡åˆ°çš„é—®é¢˜ï¼Œå¦‚ä¸‹åœ¨ BiscuitOS è¿›è¡Œæµ‹è¯•:

{% highlight c %}
echo 544 > /proc/sys/fs/nr_open
number_open_common-0.0.1 -n 510 -d 509 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000704.png)

é€šè¿‡ä¸Šé¢çš„ä¿®æ”¹é—®é¢˜å¾—åˆ°è§£å†³ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000703.png)

-----------------------------------------------

<span id="B252"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000Q.jpg)

#### sysctl_nr_open ä¸èƒ½å¤Ÿå‡†ç¡®æ§åˆ¶æ‰“å¼€æ–‡ä»¶çš„æ•°é‡é—®é¢˜

> - [é—®é¢˜æè¿°](#B2520)
>
> - [é—®é¢˜å®è·µ](#B2521)
>
> - [é—®é¢˜åˆ†æä¸è§£å†³](#B2522)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

#### <span id="B2520">é—®é¢˜æè¿°</span>

VFS é€šè¿‡ sysctl_nr_open æ§åˆ¶è¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ï¼Œå½“è°ƒç”¨ open ç³»ç»Ÿè°ƒç”¨çš„
è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ sysctl_nr_open çš„å€¼å°äº rlimit(NOFILE) çš„é™åˆ¶å€¼ï¼Œé‚£ä¹ˆè¿›ç¨‹çš„
æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ç”±  sysctl_nr_open é™åˆ¶ã€‚å¼€å‘è€…å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤
åŠ¨æ€ä¿®æ”¹ sysctl_nr_open:

{% highlight c %}
echo 512 > /proc/sys/fs/nr_open
{% endhighlight %}

å½“ä¸Šé¢çš„å€¼é™å®šå¥½ä¹‹åï¼Œè¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°å°±æœ‰ sysctl_nr_open å†³å®šï¼Œé‚£ä¹ˆ
æ˜¯å¦ sysctl_nr_open èƒ½å¤Ÿç²¾å‡†é™åˆ¶æ–‡ä»¶æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°å—?

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

#### <span id="B2521">é—®é¢˜å®è·µ</span>

ä¸ºäº†è®©å¼€å‘è€…èƒ½å¤Ÿå®è·µè¿™ä¸ªé—®é¢˜ï¼ŒBiscuitOS æä¾›äº†ç›¸å…³çš„å®è·µå·¥å…·å’Œç¯å¢ƒï¼Œ
å¼€å‘è€…å¯ä»¥å‚è€ƒä¸‹é¢æ–‡æ¡£æŸ¥çœ‹å·¥å…·çš„å…·ä½“ä½¿ç”¨:

> - [BiscuitOS æ‰“å¼€ä»»æ„é•¿åº¦æ–‡ä»¶åå·¥å…·](https://biscuitos.github.io/blog/SYSCALL_sys_open/#C1)

éƒ¨ç½²å¥½ç¯å¢ƒå’Œå·¥å…·ä¹‹åï¼Œè¿è¡Œ BiscuitOS, ä¸ºäº†æ’é™¤ "rlimit(NOFILE)" å¯¹æµ‹è¯•
çš„å½±å“ï¼Œå¯ä»¥å°† VFS æ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ•°è®¾ç½®çš„æ¯” "rlimit(NOFILE)" å°ï¼Œä¾‹å¦‚
ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

{% highlight c %}
echo 522 > /proc/sys/fs/nr_open
number_open_common-0.0.1 -n 530 -d 529 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000705.png)

ä»ä¸Šå›¾è¿è¡Œçš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œå·²ç»å°†è¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°é™åˆ¶åœ¨ 522ï¼Œä½†ç›®å‰è¿˜æ˜¯
å¯ä»¥è¿›ç¨‹å¯ä»¥åˆ†é…æ–‡ä»¶æè¿°ç¬¦æ˜¯ 532, å·²ç»è¶…è¿‡ 522. è¿™å°±æ˜¯é—®é¢˜çš„å¤ç°.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

#### <span id="B2521">é—®é¢˜åˆ†æä¸è§£å†³</span>

å½“æ’é™¤å…¶ä»–å› æ•°çš„å‰æä¸‹ï¼ŒåŠ¨æ€ä¿®æ”¹ sysctl_nr_open çš„å€¼ä¹Ÿä¼šå½±å“è¿›ç¨‹æ–‡ä»¶æ‰“å¼€ï¼Œ
å…¶ç›¸å…³çš„æºç å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000707.png)

> - [alloc_fdtable() å‡½æ•°è§£æ](https://biscuitos.github.io/blog/OPEN_SOURCE_CODE/#A0000005)

åœ¨ä¸Šé¢çš„å‡½æ•°ä¸­ä¿®æ”¹æºç å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000706.png)

é‡æ–°ç¼–è¯‘æºç ï¼Œè¿è¡Œ BiscuitOSï¼Œå¹¶ä½¿ç”¨å¦‚ä¸‹æµ‹è¯•å‘½ä»¤:

{% highlight c %}
echo 522 > /proc/sys/fs/nr_open
number_open_common-0.0.1 -n 510 -d 509 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000708.png)

ä»è¿è¡Œçš„ç»“æœçœ‹å‡ºï¼Œå‡½æ•°å‡†å¤‡å°†è¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°è®¾ç½®ä¸º 1024ï¼Œä½† 1024 å¤§äº
äº† sysctl_nr_open è®¾ç½®çš„ 522ï¼Œå› æ­¤æ­¤æ—¶è¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°æœ‰ sysctl_nr_open
æ§åˆ¶ï¼Œç”±æºç å¯ä»¥çŸ¥é“ï¼Œsysctl_nr_open å¹¶ä¸çŸ¥ç›´æ¥å°±è¢«é‡‡ç”¨åšä¸ºè¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€
æ•°ï¼Œè€Œæ˜¯è¦å°†å½“å‰å€¼å‘ä¸Šå¯¹ BITS_PER_LONG è¿›è¡Œå¯¹é½ï¼Œå¯¹é½ä¹‹åçš„å€¼æ‰æ˜¯æœ€ç»ˆé‡‡ç”¨
çš„é™åˆ¶å€¼ï¼Œä¾‹å¦‚ 522 åœ¨ 32bit ç³»ç»Ÿä¸Šå‘ä¸Šåš BITS_PER_LONG å¯¹é½ä¹‹åï¼Œå…¶å€¼å°±æ˜¯
544ï¼Œå› æ­¤æ­¤æ—¶è¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°æ˜¯ 544. å¼€å‘è€…å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯•:

{% highlight c %}
echo 522 > /proc/sys/fs/nr_open
number_open_common-0.0.1 -n 541 -d 540 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000709.png)

æ­¤æ—¶è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„ä¸ªæ•°æ˜¯ 540 ä¸ªï¼Œæœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ˜¯ 543ï¼Œå¹¶æœªè¶…è¿‡ sysctl_nr_open
é™å®šçš„å€¼ï¼Œå› æ­¤å¯ä»¥æ­£ç¡®æ‰“å¼€ï¼Œæ¥ä¸‹æ¥ä½¿ç”¨å¦‚ä¸‹æµ‹è¯•å‘½ä»¤:

{% highlight c %}
echo 522 > /proc/sys/fs/nr_open
number_open_common-0.0.1 -n 542 -d 541 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000710.png)

ä»ä¸Šé¢çš„è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œå½“è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦æ˜¯ 544 çš„æ—¶å€™ï¼Œç³»ç»Ÿè°ƒç”¨
è¿”å› -EMFILE, æ­£å¥½æ˜¯ 24ï¼Œä»£è¡¨æ²¡æœ‰é‚£ä¹ˆå¤šæ–‡ä»¶ã€‚

--------------------------

#### é—®é¢˜è§£å†³

é€šè¿‡ä¸Šé¢çš„å®è·µå’Œåˆ†æï¼Œåœ¨ç»™ sysctl_nr_open åšé™å®šçš„æ—¶å€™ï¼Œä¸€å®šè¦æŒ‰ BITS_PER_LONG
å¯¹é½ï¼Œå¦åˆ™ç³»ç»Ÿä¼šè‡ªåŠ¨å°† sysctl_nr_open åšå‘ä¸Š BITS_PER_LONG å¯¹é½ï¼Œå¹¶
å°†å…¶å€¼ä½œä¸ºè¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°, è¿™æ ·å°±éšå½¢çš„çªç ´äº†åŸå…ˆçš„è®¾å®šã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

<span id="B253"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000F.jpg)

#### ä¸åŒæ–‡ä»¶ç³»ç»Ÿæ”¯æŒè¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°é—®é¢˜

> - [é—®é¢˜æè¿°](#B2530)
>
> - [é—®é¢˜å®è·µ](#B2531)
>
> - [é—®é¢˜åˆ†æä¸è§£å†³](#B2532)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

#### <span id="B2530">é—®é¢˜æè¿°</span>

Linux å¯ä»¥æ”¯æŒä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨æ¯ç§æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ­¤æ—¶å°† "rlimit(NOFILE)"
å’Œ sysctl_nr_open è®¾ç½®å¾ˆå¤§ï¼Œè®©è¿›ç¨‹ä¸åœçš„æ‰“å¼€æ–‡ä»¶ï¼Œç›´åˆ°æ‰“å¼€æ–‡ä»¶å¤±è´¥ï¼Œ
ä»¥æ­¤ç¡®è®¤æ–‡ä»¶ç³»ç»Ÿä¹‹é—´å¯¹è¿›ç¨‹æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°å­˜åœ¨å·®å¼‚ã€‚

----------------------------------------------

#### <span id="B2531">é—®é¢˜å®è·µ</span>

ä¸ºäº†è®©å¼€å‘è€…èƒ½å¤Ÿå®è·µè¿™ä¸ªé—®é¢˜ï¼ŒBiscuitOS æä¾›äº†ç›¸å…³çš„å®è·µå·¥å…·å’Œç¯å¢ƒï¼Œ
å¼€å‘è€…å¯ä»¥å‚è€ƒä¸‹é¢æ–‡æ¡£æŸ¥çœ‹å·¥å…·çš„å…·ä½“ä½¿ç”¨:

> - [BiscuitOS æ‰“å¼€ä»»æ„é•¿åº¦æ–‡ä»¶åå·¥å…·](https://biscuitos.github.io/blog/SYSCALL_sys_open/#C1)

éƒ¨ç½²å¥½ç¯å¢ƒå’Œå·¥å…·ä¹‹åï¼Œè¿è¡Œ BiscuitOS, ä¸ºäº†æ’é™¤ "rlimit(NOFILE)" å’Œ 
sysctl_nr_open å¯¹æµ‹è¯•çš„å½±å“ï¼Œå¯ä»¥å°†ä¸¤ä¸ªå€¼è®¾ç½®å¾ˆå¤§ï¼Œä¾‹å¦‚ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

{% highlight c %}
echo 999999 > /proc/sys/fs/nr_open
cat /proc/sys/fs/nr_open
ulimit -n 999999
ulimit -n
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000712.png)

æ¥ä¸‹æ¥åœ¨ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶ç³»ç»Ÿä¸Šè¿›è¡Œæµ‹è¯•ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨ mount å‘½ä»¤æŸ¥çœ‹
å½“å‰æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ï¼Œå¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000715.png)

æ ¹ç›®å½•å°±æ˜¯ EXT4 æ–‡ä»¶ç³»ç»Ÿï¼Œæ¥ä¸‹æ¥åœ¨ EXT4 æ–‡ä»¶ç³»ç»Ÿä¸Šè¿›è¡Œå®è·µï¼Œä½¿ç”¨å¦‚ä¸‹æµ‹è¯•å‘½ä»¤:

{% highlight c %}
number_open_common-0.0.1 -n 81920 -d 81919 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000713.png)

ä»è¿è¡Œçš„æ•ˆæœæ¥çœ‹ï¼Œè¿›ç¨‹åœ¨æ‰“å¼€ç¬¬ 37935 ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œæ–‡ä»¶æè¿°ç¬¦æ˜¯ 37938ï¼Œ
æ­¤æ—¶è¿›ç¨‹æ‰“å¼€æ–‡ä»¶å¤±è´¥ï¼Œå¹¶è¿”å› ENOSPC. æŸ¥çœ‹ç£ç›˜æ¶ˆè€—:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000714.png)

å½“å‰ç£ç›˜æ‰ä½¿ç”¨äº† 76%, å¹¶æœªå› ä¸ºç£ç›˜å­˜å‚¨ç©ºé—´ä¸å¤Ÿå¼•èµ·çš„ã€‚æ¥ç€æ¢å…¶ä»–æ–‡ä»¶ç³»ç»Ÿ
æµ‹è¯•ï¼Œå¯ä»¥åœ¨ /tmp ç›®å½•ä¸‹æµ‹è¯• tmpfsã€‚ä¸ºäº†æ’é™¤ä¹‹å‰çš„æµ‹è¯•å½±å“ï¼Œå°†ä¹‹å‰ç”Ÿæˆçš„
æ–‡ä»¶åˆ é™¤ï¼Œç„¶åé‡å¯ BiscuitOS è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•å‘½ä»¤å’Œåœ¨ EXT4 æ–‡ä»¶ç³»ç»Ÿä¸€è‡´:

{% highlight c %}
echo 999999 > /proc/sys/fs/nr_open
cat /proc/sys/fs/nr_open
ulimit -n 999999
ulimit -n
cd /tmp
number_open_common-0.0.1 -n 81920 -d 81919 -f O_RDWR,O_CREAT -m S_IRUSR,S_IRGRP
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000716.png)

ä»ä¸Šé¢çš„æµ‹è¯•å¯ä»¥çœ‹å‡ºï¼Œåœ¨ tmpfs é‡Œï¼Œè¿›ç¨‹æœ€å¤šå¯ä»¥æ‰“å¼€ 63694 ä¸ªæ–‡ä»¶ã€‚ä¹‹å
æ‰“å¼€æŠ¥é”™ï¼Œå¹¶è¿”å› ENOSPC. æŸ¥çœ‹ç£ç›˜æ¶ˆè€—å¦‚ä¸Šã€‚ä»¥ä¸Šä¾¿æ˜¯é—®é¢˜çš„å¤ç°ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

#### <span id="B2531">é—®é¢˜åˆ†æä¸è§£å†³</span>

ä»ä¸Šé¢çš„å®è·µç»“æœå¯ä»¥åŸºæœ¬æ¨æµ‹ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ä¸åŒã€‚
å…·ä½“åŸå› å¾…åˆ†æ.

------------------------------------------------

#### <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>

#### æèµ ä¸€ä¸‹å§ ğŸ™‚

![MMU](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
