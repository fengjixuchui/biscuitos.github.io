---
layout: post
title:  "ç³»ç»Ÿè°ƒç”¨: open()"
date:   2019-12-12 09:23:30 +0800
categories: [HW]
excerpt: SysCall open.
tags:
  - [SysCall]
---

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

## ç›®å½•

> - [Open ç³»ç»Ÿè°ƒç”¨åŸç†](#A0)
>
> - [Open ç³»ç»Ÿè°ƒç”¨å®è·µ](#B0)
>
> - [Open æºç åˆ†æ](#C0)
>
> - [Open è¿›é˜¶ç ”ç©¶](#D0)
>
> - [é™„å½•/æèµ ](#Z0)

----------------------------------

<span id="A0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000P.jpg)

## Open ç³»ç»Ÿè°ƒç”¨åŸç†

----------------------------------

<span id="B0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000G.jpg)

## Open ç³»ç»Ÿè°ƒç”¨å®è·µ

----------------------------------

<span id="C0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000K.jpg)

## Open æºç åˆ†æ

> - [getname_flags](#C00001)


---------------------------------

## <span id="C00001">getname_flags</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000000.png)

å‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯é€šè¿‡

å‚æ•°

å‡½æ•°å®šä¹‰äº†ä¸‰ä¸ªå±€éƒ¨å˜é‡, åˆ†åˆ«æ˜¯ struct filename ç»“æ„çš„ "result",
å­—ç¬¦æŒ‡é’ˆ "kname", ä»¥åŠç”¨äºè¡¨è¾¾é•¿åº¦çš„æ•´å½¢å˜é‡ "len". 
"struct filename" å®šä¹‰åœ¨ "linux/fs.h", å…¶å®šä¹‰å¦‚ä¸‹:

{% highlight c %}
/* fs/open.c */
struct audit_names;
struct filename {
        const char              *name;  /* pointer to actual string */
        const __user char       *uptr;  /* original userland pointer */
        int                     refcnt;
        struct audit_names      *aname;
        const char              iname[];
};
{% endhighlight %}

å‡½æ•°é¦–å…ˆè°ƒç”¨ "BUILD_BUG_ON()" å®å¯¹ "struct filename" ä¸­çš„ iname
ä½ç½®è¿›è¡Œåˆ¤æ–­ï¼Œè¿™é‡Œä½¿ç”¨äº† offsetof() å®è¿›è¡Œåˆ¤æ–­ï¼Œè¯¥å®å¯ä»¥è®¡ç®—å‡º
ç»“æ„ä½“æˆå‘˜åœ¨ç»“æ„ä½“ä¸­çš„ä½ç½®ï¼Œå³èµ·å§‹åç§»ï¼Œä¾‹å¦‚ä½¿ç”¨è¯¥å®å¯¹ "struct filename"
çš„ç»“æ„ä½“è¿›è¡Œ offsetof è§£æä¹‹åï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœ:

{% highlight c %}
offsetof(struct filename, name)       ---> 0
offsetof(strcut filename, uptr)       ---> 4
offsetof(strcut filename, refcnt)     ---> 8
offsetof(strcut filename, anme)       ---> 12
offsetof(strcut filename, iname)      ---> 16
offsetof(strcut filename, iname[0])   ---> 16
offsetof(strcut filename, iname[1])   ---> 17
{% endhighlight %}

å› æ­¤ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œ"BUILD_BUG_ON()" å®åœ¨æ­¤å¤„æ£€æŸ¥ 
"struct filename" çš„ iname å…¶å®åœ°å€æ˜¯å¦æŒ‰åœ°å€æ€»çº¿é•¿åº¦å¯¹é½ï¼Œ
ç”±äº "sizeof()" çš„å¯¹è±¡æ˜¯ longï¼Œé‚£ä¹ˆèµ·é•¿åº¦å°±æ˜¯åœ°å€æ€»çº¿çš„
é•¿åº¦ã€‚æ­¤å¤„ï¼Œå¦‚æœ iname æˆå‘˜æ²¡æœ‰æŒ‰è¦æ±‚å¯¹å…¶ï¼Œé‚£ä¹ˆå†…æ ¸å°†ä½œä¸º
BUG è¿›è¡ŒæŠ¥é”™ã€‚

{% highlight c %}
        result = audit_reusename(filename);
        if (result)
                return result;
{% endhighlight %}

audit_reusename() å‡½æ•°ç”¨äºå¯¹ä»ç”¨æˆ·ç©ºé—´çš„ filename è¿›è¡Œç»Ÿè®¡ï¼Œ
å¦‚æœå†…æ ¸æ²¡æœ‰å¼€å¯ CONFIG_AUDIT å®ï¼Œå‡½æ•°å®ç°ä¸ºç©ºã€‚

{% highlight c %}
        result = __getname();
        if (unlikely(!result))
                return ERR_PTR(-ENOMEM);
{% endhighlight %}

\_\_getname() å‡½æ•°ç”¨äºä» "names_cachep" ç¼“å­˜ä¸­åˆ†é…ä¸€ä¸ª "struct filename"
ç»“æ„å®ä¾‹ï¼Œnames_cachep æ˜¯å†…æ ¸æ„å»ºçš„ä¸€ä¸ª "struct filename" ç¼“å­˜ï¼Œç³»ç»Ÿ
åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ vfs_caches_init() å‡½æ•°è¿›è¡Œåˆ›å»ºï¼Œå…¶å®ç°å¦‚ä¸‹:

{% highlight c %}
struct kmem_cache *names_cachep __read_mostly;
#define PIPE_BUF        4096    /* # bytes in atomic write to a pipe */

void __init vfs_caches_init(void)
{
        names_cachep = kmem_cache_create_usercopy("names_cache", PATH_MAX, 0,
                        SLAB_HWCACHE_ALIGN|SLAB_PANIC, 0, PATH_MAX, NULL);
}

#define __getname()             kmem_cache_alloc(names_cachep, GFP_KERNEL)
{% endhighlight %}

ä»ä¸Šé¢çš„å®ç°å¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿä¸º "struct filename" åˆ›å»ºçš„ç¼“å­˜å¤§å°ä¸º
PATH_MAX, é•¿åº¦ä¸º 4096ï¼Œä½†ä» "struct filename" çš„å®šä¹‰æ¥çœ‹ï¼Œå…¶åŒ…å«äº†
ä¸€ä¸ªç©ºçš„å­—ç¬¦æ•°ç»„ï¼Œå› æ­¤ç¼“å­˜å¤§å°å®šä¹‰ä¸º PATH_MAX ä¹‹åï¼Œé™¤å» struct filename
æœ¬èº«çš„å¤§å°ï¼Œå‰©ä½™çš„ç©ºé—´éƒ½é€šè¿‡ struct filename çš„ iname æ•°ç»„è¿›è¡Œç®¡ç†ï¼Œ
å…¶å¤§å°ä¸º:

{% highlight c %}
length = PATH_MAX - offsetof(struct filename, iname) = 4096 - 16 = 4080
{% endhighlight %}

å› æ­¤é€šè¿‡ __getname() è·å¾—çš„ struct filename å°±åŒ…å«äº†ä¸€ä¸ªé•¿åº¦
ä¸º 4080 çš„å­—ç¬¦æ•°ç»„ã€‚

{% highlight c %}
#define EMBEDDED_NAME_MAX       (PATH_MAX - offsetof(struct filename, iname))

        /*
         * First, try to embed the struct filename inside the name_cache
         * allocation.
         */ 
        kname = (char *)result->iname;
        result->name = kname;

        len = strncpy_from_user(kname, filename, EMBEDDED_NAME_MAX);
        if (unlikely(len < 0)) {
                __putname(result);
                return ERR_PTR(len);
        }
{% endhighlight %}

å‡½æ•°æ¥ä¸‹æ¥å°† struct filename çš„ name æˆå‘˜æŒ‡å‘äº† iname æŒ‡å‘çš„
å­—ç¬¦æ•°ç»„ï¼Œæ­¤æ—¶ kname å˜é‡æŒ‡å‘äº† struct filename çš„å­—ç¬¦æ•°ç»„ç©ºé—´ï¼Œ
è¯¥å­—ç¬¦ç©ºé—´ç”¨äºå­˜å‚¨ç”¨æˆ·ç©ºé—´ä¼ é€’çš„å­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²ç”¨äºå­˜å‚¨è¦æ‰“å¼€
æ–‡ä»¶çš„è·¯å¾„åã€‚æ¥ç€å‡½æ•°ä½¿ç”¨ strncpy_from_user() å‡½æ•°å°†ç”¨æˆ·ç©ºé—´
çš„ filename å­—ç¬¦ä¸²å®‰å…¨æ‹·è´åˆ°å†…æ ¸çš„ kname æŒ‡å‘çš„å†…å­˜ç©ºé—´ï¼Œæ‹·è´
çš„é•¿åº¦ä¸º EMBEDDED_NAME_MAX, é€šè¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥çŸ¥é“è¯¥é•¿åº¦ä¸º
4080ï¼Œä¹Ÿå°±æ˜¯ struct filename å¯ä»¥å­˜å‚¨çš„æœ€å¤§å­—ç¬¦æ•°ã€‚å¦‚æœå‡½æ•°æ‰§è¡Œ
å¤±è´¥ï¼Œé‚£ä¹ˆè°ƒç”¨ \_\_putname() å‡½æ•°å°†ä» names_cachep åˆ†é…çš„ 
struct filename ç»“æ„è¿”è¿˜ç»™ names_cachep, å¹¶è¿”å›é”™è¯¯ä»£ç  
"ERR_PTR(len)"; åä¹‹å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆ struct filename 
çš„ name å’Œ iname éƒ½æŒ‡å‘äº†ä»ç”¨æˆ·ç©ºé—´æ‹·è´è¿‡æ¥çš„å­—ç¬¦ä¸²ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000001.png)

{% highlight c %}
        /*
         * Uh-oh. We have a name that's approaching PATH_MAX. Allocate a
         * separate struct filename so we can dedicate the entire
         * name_cache allocation for the pathname, and re-do the copy from
         * userland.
         */
        if (unlikely(len == EMBEDDED_NAME_MAX)) {
                const size_t size = offsetof(struct filename, iname[1]);
                kname = (char *)result;
{% endhighlight %}

å¦‚æœç”¨æˆ·ç©ºé—´ open æ‰“å¼€çš„æ–‡ä»¶åå­—çš„é•¿åº¦ä»‹äº EMBEDDED_NAME_MAX 
ä¸ PATH_MAX ä¹‹é—´, é‚£ä¹ˆå‡½æ•°å°±æ–°åˆ†é…ä¸€ä¸ªåˆ†ç¦»çš„ "struct filename",
ç”¨äºå­˜å‚¨ open çš„è·¯å¾„åï¼Œä»¥ä¾¿åŒºåˆ† "struct filename" æ˜¯ names_cachep
åˆ†é…è¿˜æ˜¯ç‹¬ç«‹åˆ†é…çš„ï¼Œä½†å¦‚æœ open æ‰“å¼€çš„è·¯å¾„åé•¿åº¦è¶…è¿‡æˆ–ç­‰äº
PATH_MAX, é‚£ä¹ˆç³»ç»Ÿå°±ç›¸åº”çš„æŠ¥é”™ï¼Œä»¥æ­¤å¥ å®šå†…æ ¸æ”¯æŒçš„æœ€å¤§è·¯å¾„åã€‚ 
å‡½æ•°é¦–å…ˆè°ƒç”¨ "offsetof(struct filename, iname[1])" è·å¾—
"struct filename" çš„åŸå§‹é•¿åº¦ï¼Œè¯¥é•¿åº¦ä¸åŒ…å« names_cachep åˆ†é…
çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œå¹¶å°† kname æŒ‡å‘äº†åŸå…ˆçš„ struct filename ç»“æ„ï¼Œ

{% highlight c %}
                /*
                 * size is chosen that way we to guarantee that
                 * result->iname[0] is within the same object and that
                 * kname can't be equal to result->iname, no matter what.
                 */
                result = kzalloc(size, GFP_KERNEL);
                if (unlikely(!result)) {
                        __putname(kname);
                        return ERR_PTR(-ENOMEM);
                }
                result->name = kname;
                len = strncpy_from_user(kname, filename, PATH_MAX);
                if (unlikely(len < 0)) {
                        __putname(kname);
                        kfree(result);
                        return ERR_PTR(len);
                }
                if (unlikely(len == PATH_MAX)) {
                        __putname(kname);
                        kfree(result);
                        return ERR_PTR(-ENAMETOOLONG);
                }
{% endhighlight %}

å‡½æ•°æ¥ç€è°ƒç”¨ kzalloc() å‡½æ•°ä» SLAB å­ç³»ç»Ÿä¸­åˆ†é…äº†ä¸€å—å†…å­˜ç”¨äºå­˜å‚¨
æ–°çš„ "struct filename", å¹¶è°ƒç”¨ "result->name = kname" ä»£ç ï¼Œå°†æ–°çš„
"struct filename" çš„ name æŒ‡å‘äº†åŸå§‹ "struct filename" ç»“æ„, æ¥ç€
è°ƒç”¨ strncpy_from_user() å‡½æ•°ä»ç”¨æˆ·ç©ºé—´æ‹·è´é•¿åº¦ä¸º PATH_MAX çš„å­—ç¬¦ä¸²ï¼Œ
å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼ŒåŸå§‹çš„ "struct filename" å°±ç”¨æ¥å…¨éƒ¨å­˜å‚¨å­—ç¬¦ä¸²ã€‚å¦‚æœ
æ­¤æ—¶ len çš„å€¼å°±æ‹·è´å­—ç¬¦ä¸²é•¿åº¦ä¸º PATH_MAXï¼Œä»£è¡¨ open æ‰“å¼€æ–‡ä»¶åè¶…è¿‡
äº† PATH_MAX, æ­¤æ—¶å‡½æ•°å°±è¿”å› -ENAMETOOLONG, ä»¥æ­¤è¡¨ç¤ºæ‰“å¼€çš„æ–‡ä»¶å
å¤ªé•¿ã€‚å¦‚æœåå­—é•¿åº¦åœ¨ EMBEDDED_NAME_MAX åˆ° PATH_MAX ä¹‹é—´ï¼Œé‚£ä¹ˆ
æ–°æ—§ "struct filename" çš„é€»è¾‘å…³ç³»å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000002.png)

{% highlight c %}
        result->refcnt = 1;
        /* The empty path is special. */
        if (unlikely(!len)) {
                if (empty)
                        *empty = 1;
                if (!(flags & LOOKUP_EMPTY)) {
                        putname(result);
                        return ERR_PTR(-ENOENT);
                }
        }

        result->uptr = filename;
        result->aname = NULL;
        audit_getname(result);
        return result;
{% endhighlight %}

å‡½æ•°ç›®å‰å·²ç»ä½¿ç”¨ä¸€ä¸ª struct filename ç®¡ç†ä»ç”¨æˆ·ç©ºé—´è·å¾—çš„è·¯å¾„åï¼Œ
ç”±äºä¸Šé¢åˆ†æäº†ä¸åŒé•¿åº¦è·¯å¾„åé‡‡ç”¨ä¸åŒçš„ "struct filename" ç®¡ç†
ç­–ç•¥ï¼Œå‡½æ•°è®²æœ€ç»ˆä½¿ç”¨çš„ "struct filename" çš„ refcnt è®¾ç½®ä¸º 1ï¼Œ
ä»¥æ­¤è¡¨ç¤ºè¯¥ "struct filename" æ­£åœ¨ä½¿ç”¨ã€‚å¦‚æœ len ä¸ºé›¶ï¼Œè¡¨ç¤ºç‰¹æ®Šçš„
è·¯å¾„ï¼Œè¿™é‡Œä¸åšè¯¦ç»†åˆ†æã€‚æ¥ç€å‡½æ•°è®² "struct filename" çš„ uptr æŒ‡å‘
äº†ç”¨æˆ·ç©ºé—´çš„ filename å­—ç¬¦ä¸²ï¼Œå¹¶å°† aname è®¾ç½®ä¸º NULLã€‚å‡½æ•°æœ€åè¿”å›
"struct filename"ã€‚

ç ”ç©¶å®Œæºç ä¹‹åï¼Œè¿™é‡Œå¯¹ open æ‰“å¼€çš„è·¯å¾„åè¿›è¡Œè¿›ä¸€æ­¥ç ”ç©¶ï¼Œ
ç›¸å…³çš„ç ”ç©¶æ–‡æ¡£å¦‚ä¸‹:

> - [Open æ‰“å¼€è·¯å¾„é•¿åº¦ç ”ç©¶](https://biscuitos.github.io/blog/open-namelen/)

-------------------------------------------


{% highlight c %}

{% endhighlight %}



----------------------------------

<span id="D0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L.jpg)

## Open è¿›é˜¶ç ”ç©¶

> - [Open æ‰“å¼€è·¯å¾„é•¿åº¦ç ”ç©¶](https://biscuitos.github.io/blog/open-namelen/)

-----------------------------------------------

# <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
