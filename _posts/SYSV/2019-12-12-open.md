---
layout: post
title:  "ç³»ç»Ÿè°ƒç”¨: open()"
date:   2019-12-12 09:23:30 +0800
categories: [HW]
excerpt: SysCall open.
tags:
  - [SysCall]
---

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

## ç›®å½•

> - [Open ç³»ç»Ÿè°ƒç”¨åŸç†](#A0)
>
> - [Open ç³»ç»Ÿè°ƒç”¨å®è·µ](#B0)
>
> - [Open æºç åˆ†æ](#C0)
>
> - [Open è¿›é˜¶ç ”ç©¶](#D0)
>
> - [é™„å½•/æèµ ](#Z0)

----------------------------------

<span id="A0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000P.jpg)

## Open ç³»ç»Ÿè°ƒç”¨åŸç†

## é‡è¦æ•°æ®ç»“æ„

> - [struct filename](#A00010)
>
> - [struct files_struct](#A00011)
>
> - [struct fdtable](#A00012)
>
> - [struct nameidata](#A00013)
>
> - [struct path](#A00014)
>
> - [struct qstr](#A00015)
>
> - [filp_cachep](#A00016)
>
> - [open_flags](#A00017)


-------------------------------------

#### <span id="A00010">struct filename</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000021.png)

"struct filename" ç»“æ„å®šä¹‰åœ¨ "include/linux/fs.h"ï¼Œç”¨äºç®¡ç†
ç”¨æˆ·ç©ºé—´ä¼ é€’ä¸‹æ¥çš„è·¯å¾„åã€‚æˆå‘˜ name ç”¨äºæŒ‡å‘ç”¨æˆ·ç©ºé—´è·¯å¾„åæ‹·è´åˆ°
å†…æ ¸ç©ºé—´çš„ä½ç½®; å‚æ•° uptr ç”¨äºæŒ‡å‘ç”¨æˆ·ç©ºé—´æ–‡ä»¶è·¯å¾„å; å‚æ•°
refcnt ç”¨äºæŒ‡å®šè¯¥æ–‡ä»¶è·¯å¾„åå¼•ç”¨çš„æ¬¡æ•°; aname å‚æ•°ç”¨äºå†…æ ¸çš„
å®¡è®¡åŠŸèƒ½ï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨ CONFIG_AUDIT, é‚£ä¹ˆè¯¥æˆå‘˜è®¾ç½®ä¸º NULL;
å‚æ•° iname ä¸ºä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼Œå¦‚æœé‡‡ç”¨ä¸‹é¢ä»‹ç»çš„ç¬¬ä¸€ç§ç®¡ç†æ–¹å¼ï¼Œ
é‚£ä¹ˆè¯¥æˆå‘˜å’Œæˆå‘˜ name ä¸€è‡´æŒ‡å‘ç”¨æˆ·ç©ºé—´è·¯å¾„åæ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„
ä½ç½®ï¼Œå¦‚æœé‡‡ç”¨ç¬¬äºŒç§ç®¡ç†æ–¹å¼ï¼Œé‚£ä¹ˆè¯¥æˆå‘˜ä¸ä½¿ç”¨ã€‚

###### å†…æ ¸æ–‡ä»¶è·¯å¾„åç®¡ç†ç­–ç•¥

å†…æ ¸é‡‡ç”¨ä¸¤ç§æ–¹å¼ç®¡ç†æ–‡ä»¶è·¯å¾„åï¼Œç¬¬ä¸€
ç§é’ˆå¯¹çš„æ˜¯æ–‡ä»¶è·¯å¾„åé•¿åº¦å°äº EMBEDDED_NAME_MAX çš„æ–‡ä»¶è·¯å¾„åï¼Œ
å†…æ ¸ä» names_cachep ç¼“å­˜ä¸­åˆ†é…å¤§å°ä¸º PATH_MAX çš„å†…å­˜ç©ºé—´ï¼Œ
"struct filename" ç»“æ„å ç”¨äº†è¿™éƒ¨åˆ†å†…å­˜çš„å¤´éƒ¨ï¼Œå‰©ä½™çš„éƒ¨åˆ†ç”¨äº
å­˜å‚¨ä»ç”¨æˆ·ç©ºé—´ä¼ é€’ä¸‹æ¥çš„è·¯å¾„åï¼Œå¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000001.png)

ç¬¬äºŒç§é’ˆå¯¹æ–‡ä»¶è·¯å¾„åé•¿åº¦å¤§äºç­‰äº EMBEDDED_NAME_MAX è€Œå°äº 
PATH_MAX çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå†…æ ¸é¦–å…ˆä» names_cachep ä¸­åˆ†é…
ä¸€ä¸ªç¼“å­˜ï¼Œå…¶é•¿åº¦ä¹Ÿæ˜¯ PATH_MAX, ç„¶åå†ä» SLAB ä¸­åˆ†é…ä¸€ä¸ª
"struct filename" å¤§å°çš„å†…å­˜ï¼Œä½¿ç”¨è¿™ä¸ª "struct filename" 
çš„ name æˆå‘˜æŒ‡å‘äº†ä» names_cachep ä¸­åˆ†é…å‡ºæ¥çš„å†…å­˜ï¼Œè¿™ä¸ªå†…å­˜
å°±ç”¨æ¥å­˜å‚¨ç”¨æˆ·ç©ºé—´ä¼ é€’ä¸‹æ¥çš„æ–‡ä»¶è·¯å¾„åï¼Œå…¶é€»è¾‘å¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000002.png)

-----------------------------------

#### <span id="A00011">struct files_struct</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000022.png)

-----------------------------------

#### <span id="A00012">struct fdtable</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000023.png)

struct fdtable æ•°æ®ç»“æ„ç”¨äºç®¡ç†å’Œç»´æŠ¤å½“å‰è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚åœ¨ Linux å†…æ ¸
ä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¹äºåŒä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹å¯ä»¥ä½¿ç”¨å”¯ä¸€çš„
æ–‡ä»¶æè¿°ç¬¦ç®¡ç†ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶; è€Œå¯¹äºä¸åŒçš„ä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ï¼Œè™½ç„¶æ–‡ä»¶
æè¿°ç¬¦ç›¸åŒï¼Œä½†ä¸ä¸€å®šæŒ‡å‘åŒä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ã€‚å› æ­¤æ–‡ä»¶æè¿°ç¬¦å†è¿›ç¨‹å†…è®¨è®º
æ‰æœ‰æ„ä¹‰ã€‚struct fdtbale ç»“æ„çš„ max_fds ç”¨äºè¡¨ç¤ºå½“å‰è¿›ç¨‹æ”¯æŒçš„æœ€å¤§
æ–‡ä»¶æè¿°ç¬¦æ•°; close_on_exec æˆå‘˜æ˜¯ä¸€ä¸ª bitmapï¼Œæ¯ä¸ª bitmap å¯¹åº”ä¸€ä¸ª
æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¯ä¸ª bit çš„ä»£è¡¨ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºç¡®å®šåœ¨è°ƒç”¨ç³»ç»Ÿè°ƒ
ç”¨ execve() æ—¶éœ€è¦å…³é—­çš„æ–‡ä»¶å¥æŸ„ã€‚å½“ä¸€ä¸ªç¨‹åºä½¿ç”¨ fork() å‡½æ•°åˆ›å»ºäº†ä¸€
ä¸ªå­è¿›ç¨‹æ—¶ï¼Œé€šå¸¸ä¼šåœ¨è¯¥å­è¿›ç¨‹ä¸­è°ƒç”¨ execve() å‡½æ•°åŠ è½½æ‰§è¡Œå¦ä¸€ä¸ªæ–°ç¨‹åºã€‚
æ­¤æ—¶å­è¿›ç¨‹å°†å®Œå…¨è¢«æ–°ç¨‹åºæ›¿æ¢æ‰ï¼Œå¹¶åœ¨å­è¿›ç¨‹ä¸­å¼€å§‹æ‰§è¡Œæ–°ç¨‹åºã€‚è‹¥ä¸€ä¸ªæ–‡ä»¶
æè¿°ç¬¦åœ¨ close_on_exec ä¸­çš„å¯¹åº”æ¯”ç‰¹ä½è¢«è®¾ç½®ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œ execve() æ—¶
è¯¥æè¿°ç¬¦å°†è¢«å…³é—­ï¼Œå¦åˆ™è¯¥æè¿°ç¬¦å°†å§‹ç»ˆå¤„äºæ‰“å¼€çŠ¶æ€ã€‚å½“æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œ
é»˜è®¤æƒ…å†µä¸‹æ–‡ä»¶å¥æŸ„åœ¨å­è¿›ç¨‹ä¸­ä¹Ÿå¤„äºæ‰“å¼€çŠ¶æ€ã€‚å› æ­¤ sys_open() ä¸­è¦å¤ä½
å¯¹åº”æ¯”ç‰¹ä½ã€‚

struct fdtable ç»“æ„ä¸­ full_fds_bits å’Œ open_fds éƒ½æ˜¯ bitmapï¼Œ
max_fds ä»£è¡¨è¯¥ç»“æ„èƒ½å¤Ÿç»´æŠ¤æœ€å¤§æ–‡ä»¶æè¿°æ•°ï¼Œmax_fds çš„å€¼å†³å®š
äº† open_fds çš„ bits æ•°ã€‚åœ¨ open_fds æŒ‡å‘çš„ bitmap ä¸­ï¼Œbit
ä»ä½ä½å¼€å§‹ç¼–ç ï¼Œæ¯ä¸ª bit å¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå³ bit0 ä»£è¡¨
çš„æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯ 0ï¼Œbit1 ä»£è¡¨çš„æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯ 1. åœ¨
open_fds çš„ bitmap ä¸­ï¼Œç½®ä½çš„ bit å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å·²ç»åˆ†é…ï¼Œ
åä¹‹è¯¥ bit æ¸…é›¶åˆ™è¡¨ç¤ºè¯¥æ–‡ä»¶æè¿°ç¬¦æ²¡æœ‰åˆ†é…ã€‚åŒç† full_fds_bits
ä¹Ÿæ˜¯ä¸€ä¸ª bitmapï¼Œå¹¶ä¸”ä»ä½ä½å¼€å§‹ç¼–ç ï¼Œä½† full_fds_bits çš„æ¯ä¸ª
bit æŒ‡ä»£ open_fds ä¸­çš„ 32 ä¸ª bitï¼Œå³ full_fds_bits çš„ bit0
ä»£è¡¨äº† open_fds çš„ 0 åˆ° 31 bit, full_fds_bits çš„ bit-1
ä»£è¡¨äº† open_fds çš„ 32 åˆ° 63 bit, å¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000025.png)

-------------------------------------

#### <span id="A00013">struct nameidata</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000030.png)

-------------------------------------

#### <span id="A00016">filp_cachep</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000033.png)

filp_cachep æ˜¯ä¸€ä¸ª "struct file" çš„ç¼“å­˜ã€‚ç”±äºå†…æ ¸è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦
å¤§é‡çš„ç”³è¯·å’Œé‡Šæ”¾ "struct file" ç»“æ„ï¼Œä¸ºäº†å‡å°è¿™æ ·æ“ä½œå¸¦æ¥çš„å¼€é”€ï¼Œ
ç³»ç»Ÿåœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä» SLAB ä¸­åˆ†é…äº†ä¸€æ®µç¼“å­˜ç”¨äº "struct file" çš„åˆ†é…
å’Œé‡Šæ”¾ã€‚

filp_cachep çš„åˆå§‹åŒ–å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000034.png)

ç³»ç»Ÿåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ files_init() å‡½æ•°ï¼Œå¹¶åœ¨å‡½æ•°å†…éƒ¨è°ƒç”¨
kmem_cache_create() å‡½æ•°åˆ†é…ç¼“å­˜ï¼Œç¼“å­˜çš„åå­—æ˜¯ "filp", å¤§å°ä¸º
"sizeof(struct file)".

-------------------------------------

#### <span id="A00017">open_flags</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000038.png)

struct open_flags æ•°æ®ç»“æ„ç”¨äºç®¡ç†æ–‡ä»¶æ‰“å¼€çš„æ ‡å¿—ï¼Œè®¿é—®æƒé™ã€è·¯å¾„æŸ¥æ‰¾ä»¥åŠ
æ„å›¾ç­‰ä¿¡æ¯ã€‚open_flag ç”¨äºå­˜å‚¨æ–‡ä»¶æ‰“å¼€çš„æ ‡å¿—ï¼Œå…¶åŒ…å«äº† VALID_OPEN_FLAGS
æ‰€æ”¯æŒçš„æ ‡å¿—ï¼Œå¹¶ç»è¿‡å†…æ ¸çš„å¤„ç†ï¼Œæ— æ•ˆçš„æ ‡å¿—å·²è¢«å‰”é™¤ã€‚mode æˆå‘˜ç”¨äºç»´æŠ¤
æ–‡ä»¶æ‰“å¼€çš„æƒé™ï¼Œè¯¥æƒé™ç”¨äºç®¡ç†è®¿é—®æ–‡ä»¶æ—¶å€™ï¼Œæ–‡ä»¶æ‹¥æœ‰è€…ã€æ–‡ä»¶æ‰€å±ç»„ã€
å…¶ä»–ç”¨æˆ·å…·æœ‰çš„æƒé™ã€‚acc_mode æˆå‘˜æ–‡ä»¶çš„è®¿é—®æƒé™ï¼Œå…¶ä»æ–‡ä»¶æ‰“å¼€æ ‡å¿—ä¸­ï¼Œ
é€šè¿‡ ACC_MODE() å®å’Œç›¸å…³å¤„ç†ï¼Œè·å¾—æ–‡ä»¶çš„è®¿é—®æ¨¡å¼ã€‚intent ç”¨äºå­˜å‚¨æ–‡ä»¶
æ‰“å¼€çš„æ„å›¾ï¼ŒåŒ…æ‹¬æ–‡ä»¶è·¯å¾„å¯¹äºçš„æ˜¯æ–‡ä»¶è¿˜æ˜¯è·¯å¾„ç­‰ä¿¡æ¯ã€‚lookup_flags æˆå‘˜
ç”¨äºå­˜å‚¨æ–‡ä»¶æ‰“å¼€æ˜¯å¯¹è·¯å¾„ç­‰æŸ¥æ‰¾è¿‡ç¨‹ä½¿ç”¨çš„æ ‡å¿—ã€‚æ›´å¤šæ–‡ä»¶æ ‡å¿—ä¿¡æ¯å¯ä»¥å‚è€ƒ:

> - [æ–‡ä»¶æ ‡å¿—è¯¦è§£](https://biscuitos.github.io/blog/open-flags/)

----------------------------------

<span id="B0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000G.jpg)

## Open ç³»ç»Ÿè°ƒç”¨å®è·µ

----------------------------------

<span id="C0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000K.jpg)

## Open æºç åˆ†æ

> - [getname_flags](#C00001)
>
> - [find_next_fd](#C00002)
>
> - [\_\_set_open_fd](#C00003)
>
> - [\_\_set_close_on_exec](#C00004)
>
> - [\_\_set_clear_on_exec](#C00005)
>
> - [\_\_alloc_fd](#C00006)
>
> - [\_\_alloc_file](#C00007)
>
> - [alloc_empty_file](#C00008)
>
> - [ACC_MODE](#C00009)
>
> - [build_open_flags](#C0000A)


---------------------------------

#### <span id="C00001">getname_flags</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000000.png)

å‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯é€šè¿‡æ£€æŸ¥ç”¨æˆ·ç©ºé—´ä¼ é€’çš„æ–‡ä»¶è·¯å¾„åé•¿åº¦æ˜¯å¦åˆæ³•ï¼Œå¦‚æœ
åˆæ³•å†…æ ¸å°±ä½¿ç”¨ "struct filename" å°†è·¯å¾„åç®¡ç†èµ·æ¥ã€‚
å‚æ•° filename æŒ‡å‘ç”¨æˆ·ç©ºé—´çš„æ–‡ä»¶è·¯å¾„åï¼Œå‚æ•° flags ä»£è¡¨æ–‡ä»¶è·¯å¾„å¤„ç†
æ ‡å¿—ï¼Œempty å‚æ•°ç”¨äºç‰¹å®šçš„ç©ºè·¯å¾„å¤„ç†ã€‚
å‡½æ•°å®šä¹‰äº†ä¸‰ä¸ªå±€éƒ¨å˜é‡, åˆ†åˆ«æ˜¯ struct filename ç»“æ„çš„ "result",
å­—ç¬¦æŒ‡é’ˆ "kname", ä»¥åŠç”¨äºè¡¨è¾¾é•¿åº¦çš„æ•´å½¢å˜é‡ "len". 
"struct filename" å®šä¹‰åœ¨ "linux/fs.h", å…¶å®šä¹‰å¦‚ä¸‹:

{% highlight c %}
/* fs/open.c */
struct audit_names;
struct filename {
        const char              *name;  /* pointer to actual string */
        const __user char       *uptr;  /* original userland pointer */
        int                     refcnt;
        struct audit_names      *aname;
        const char              iname[];
};
{% endhighlight %}

å‡½æ•°é¦–å…ˆè°ƒç”¨ "BUILD_BUG_ON()" å®å¯¹ "struct filename" ä¸­çš„ iname
ä½ç½®è¿›è¡Œåˆ¤æ–­ï¼Œè¿™é‡Œä½¿ç”¨äº† offsetof() å®è¿›è¡Œåˆ¤æ–­ï¼Œè¯¥å®å¯ä»¥è®¡ç®—å‡º
ç»“æ„ä½“æˆå‘˜åœ¨ç»“æ„ä½“ä¸­çš„ä½ç½®ï¼Œå³èµ·å§‹åç§»ï¼Œä¾‹å¦‚ä½¿ç”¨è¯¥å®å¯¹ "struct filename"
çš„ç»“æ„ä½“è¿›è¡Œ offsetof è§£æä¹‹åï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœ:

{% highlight c %}
offsetof(struct filename, name)       ---> 0
offsetof(strcut filename, uptr)       ---> 4
offsetof(strcut filename, refcnt)     ---> 8
offsetof(strcut filename, anme)       ---> 12
offsetof(strcut filename, iname)      ---> 16
offsetof(strcut filename, iname[0])   ---> 16
offsetof(strcut filename, iname[1])   ---> 17
{% endhighlight %}

å› æ­¤ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œ"BUILD_BUG_ON()" å®åœ¨æ­¤å¤„æ£€æŸ¥ 
"struct filename" çš„ iname å…¶å®åœ°å€æ˜¯å¦æŒ‰åœ°å€æ€»çº¿é•¿åº¦å¯¹é½ï¼Œ
ç”±äº "sizeof()" çš„å¯¹è±¡æ˜¯ longï¼Œé‚£ä¹ˆèµ·é•¿åº¦å°±æ˜¯åœ°å€æ€»çº¿çš„
é•¿åº¦ã€‚æ­¤å¤„ï¼Œå¦‚æœ iname æˆå‘˜æ²¡æœ‰æŒ‰è¦æ±‚å¯¹å…¶ï¼Œé‚£ä¹ˆå†…æ ¸å°†ä½œä¸º
BUG è¿›è¡ŒæŠ¥é”™ã€‚

{% highlight c %}
        result = audit_reusename(filename);
        if (result)
                return result;
{% endhighlight %}

audit_reusename() å‡½æ•°ç”¨äºå¯¹ä»ç”¨æˆ·ç©ºé—´çš„ filename è¿›è¡Œç»Ÿè®¡ï¼Œ
å¦‚æœå†…æ ¸æ²¡æœ‰å¼€å¯ CONFIG_AUDIT å®ï¼Œå‡½æ•°å®ç°ä¸ºç©ºã€‚

{% highlight c %}
        result = __getname();
        if (unlikely(!result))
                return ERR_PTR(-ENOMEM);
{% endhighlight %}

\_\_getname() å‡½æ•°ç”¨äºä» "names_cachep" ç¼“å­˜ä¸­åˆ†é…ä¸€ä¸ª "struct filename"
ç»“æ„å®ä¾‹ï¼Œnames_cachep æ˜¯å†…æ ¸æ„å»ºçš„ä¸€ä¸ª "struct filename" ç¼“å­˜ï¼Œç³»ç»Ÿ
åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ vfs_caches_init() å‡½æ•°è¿›è¡Œåˆ›å»ºï¼Œå…¶å®ç°å¦‚ä¸‹:

{% highlight c %}
struct kmem_cache *names_cachep __read_mostly;
#define PIPE_BUF        4096    /* # bytes in atomic write to a pipe */

void __init vfs_caches_init(void)
{
        names_cachep = kmem_cache_create_usercopy("names_cache", PATH_MAX, 0,
                        SLAB_HWCACHE_ALIGN|SLAB_PANIC, 0, PATH_MAX, NULL);
}

#define __getname()             kmem_cache_alloc(names_cachep, GFP_KERNEL)
{% endhighlight %}

ä»ä¸Šé¢çš„å®ç°å¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿä¸º "struct filename" åˆ›å»ºçš„ç¼“å­˜å¤§å°ä¸º
PATH_MAX, é•¿åº¦ä¸º 4096ï¼Œä½†ä» "struct filename" çš„å®šä¹‰æ¥çœ‹ï¼Œå…¶åŒ…å«äº†
ä¸€ä¸ªç©ºçš„å­—ç¬¦æ•°ç»„ï¼Œå› æ­¤ç¼“å­˜å¤§å°å®šä¹‰ä¸º PATH_MAX ä¹‹åï¼Œé™¤å» struct filename
æœ¬èº«çš„å¤§å°ï¼Œå‰©ä½™çš„ç©ºé—´éƒ½é€šè¿‡ struct filename çš„ iname æ•°ç»„è¿›è¡Œç®¡ç†ï¼Œ
å…¶å¤§å°ä¸º:

{% highlight c %}
length = PATH_MAX - offsetof(struct filename, iname) = 4096 - 16 = 4080
{% endhighlight %}

å› æ­¤é€šè¿‡ __getname() è·å¾—çš„ struct filename å°±åŒ…å«äº†ä¸€ä¸ªé•¿åº¦
ä¸º 4080 çš„å­—ç¬¦æ•°ç»„ã€‚

{% highlight c %}
#define EMBEDDED_NAME_MAX       (PATH_MAX - offsetof(struct filename, iname))

        /*
         * First, try to embed the struct filename inside the name_cache
         * allocation.
         */ 
        kname = (char *)result->iname;
        result->name = kname;

        len = strncpy_from_user(kname, filename, EMBEDDED_NAME_MAX);
        if (unlikely(len < 0)) {
                __putname(result);
                return ERR_PTR(len);
        }
{% endhighlight %}

å‡½æ•°æ¥ä¸‹æ¥å°† struct filename çš„ name æˆå‘˜æŒ‡å‘äº† iname æŒ‡å‘çš„
å­—ç¬¦æ•°ç»„ï¼Œæ­¤æ—¶ kname å˜é‡æŒ‡å‘äº† struct filename çš„å­—ç¬¦æ•°ç»„ç©ºé—´ï¼Œ
è¯¥å­—ç¬¦ç©ºé—´ç”¨äºå­˜å‚¨ç”¨æˆ·ç©ºé—´ä¼ é€’çš„å­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²ç”¨äºå­˜å‚¨è¦æ‰“å¼€
æ–‡ä»¶çš„è·¯å¾„åã€‚æ¥ç€å‡½æ•°ä½¿ç”¨ strncpy_from_user() å‡½æ•°å°†ç”¨æˆ·ç©ºé—´
çš„ filename å­—ç¬¦ä¸²å®‰å…¨æ‹·è´åˆ°å†…æ ¸çš„ kname æŒ‡å‘çš„å†…å­˜ç©ºé—´ï¼Œæ‹·è´
çš„é•¿åº¦ä¸º EMBEDDED_NAME_MAX, é€šè¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥çŸ¥é“è¯¥é•¿åº¦ä¸º
4080ï¼Œä¹Ÿå°±æ˜¯ struct filename å¯ä»¥å­˜å‚¨çš„æœ€å¤§å­—ç¬¦æ•°ã€‚å¦‚æœå‡½æ•°æ‰§è¡Œ
å¤±è´¥ï¼Œé‚£ä¹ˆè°ƒç”¨ \_\_putname() å‡½æ•°å°†ä» names_cachep åˆ†é…çš„ 
struct filename ç»“æ„è¿”è¿˜ç»™ names_cachep, å¹¶è¿”å›é”™è¯¯ä»£ç  
"ERR_PTR(len)"; åä¹‹å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆ struct filename 
çš„ name å’Œ iname éƒ½æŒ‡å‘äº†ä»ç”¨æˆ·ç©ºé—´æ‹·è´è¿‡æ¥çš„å­—ç¬¦ä¸²ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000001.png)

{% highlight c %}
        /*
         * Uh-oh. We have a name that's approaching PATH_MAX. Allocate a
         * separate struct filename so we can dedicate the entire
         * name_cache allocation for the pathname, and re-do the copy from
         * userland.
         */
        if (unlikely(len == EMBEDDED_NAME_MAX)) {
                const size_t size = offsetof(struct filename, iname[1]);
                kname = (char *)result;
{% endhighlight %}

å¦‚æœç”¨æˆ·ç©ºé—´ open æ‰“å¼€çš„æ–‡ä»¶åå­—çš„é•¿åº¦ä»‹äº EMBEDDED_NAME_MAX 
ä¸ PATH_MAX ä¹‹é—´, é‚£ä¹ˆå‡½æ•°å°±æ–°åˆ†é…ä¸€ä¸ªåˆ†ç¦»çš„ "struct filename",
ç”¨äºå­˜å‚¨ open çš„è·¯å¾„åï¼Œä»¥ä¾¿åŒºåˆ† "struct filename" æ˜¯ names_cachep
åˆ†é…è¿˜æ˜¯ç‹¬ç«‹åˆ†é…çš„ï¼Œä½†å¦‚æœ open æ‰“å¼€çš„è·¯å¾„åé•¿åº¦è¶…è¿‡æˆ–ç­‰äº
PATH_MAX, é‚£ä¹ˆç³»ç»Ÿå°±ç›¸åº”çš„æŠ¥é”™ï¼Œä»¥æ­¤å¥ å®šå†…æ ¸æ”¯æŒçš„æœ€å¤§è·¯å¾„åã€‚ 
å‡½æ•°é¦–å…ˆè°ƒç”¨ "offsetof(struct filename, iname[1])" è·å¾—
"struct filename" çš„åŸå§‹é•¿åº¦ï¼Œè¯¥é•¿åº¦ä¸åŒ…å« names_cachep åˆ†é…
çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œå¹¶å°† kname æŒ‡å‘äº†åŸå…ˆçš„ struct filename ç»“æ„ï¼Œ

{% highlight c %}
                /*
                 * size is chosen that way we to guarantee that
                 * result->iname[0] is within the same object and that
                 * kname can't be equal to result->iname, no matter what.
                 */
                result = kzalloc(size, GFP_KERNEL);
                if (unlikely(!result)) {
                        __putname(kname);
                        return ERR_PTR(-ENOMEM);
                }
                result->name = kname;
                len = strncpy_from_user(kname, filename, PATH_MAX);
                if (unlikely(len < 0)) {
                        __putname(kname);
                        kfree(result);
                        return ERR_PTR(len);
                }
                if (unlikely(len == PATH_MAX)) {
                        __putname(kname);
                        kfree(result);
                        return ERR_PTR(-ENAMETOOLONG);
                }
{% endhighlight %}

å‡½æ•°æ¥ç€è°ƒç”¨ kzalloc() å‡½æ•°ä» SLAB å­ç³»ç»Ÿä¸­åˆ†é…äº†ä¸€å—å†…å­˜ç”¨äºå­˜å‚¨
æ–°çš„ "struct filename", å¹¶è°ƒç”¨ "result->name = kname" ä»£ç ï¼Œå°†æ–°çš„
"struct filename" çš„ name æŒ‡å‘äº†åŸå§‹ "struct filename" ç»“æ„, æ¥ç€
è°ƒç”¨ strncpy_from_user() å‡½æ•°ä»ç”¨æˆ·ç©ºé—´æ‹·è´é•¿åº¦ä¸º PATH_MAX çš„å­—ç¬¦ä¸²ï¼Œ
å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼ŒåŸå§‹çš„ "struct filename" å°±ç”¨æ¥å…¨éƒ¨å­˜å‚¨å­—ç¬¦ä¸²ã€‚å¦‚æœ
æ­¤æ—¶ len çš„å€¼å°±æ‹·è´å­—ç¬¦ä¸²é•¿åº¦ä¸º PATH_MAXï¼Œä»£è¡¨ open æ‰“å¼€æ–‡ä»¶åè¶…è¿‡
äº† PATH_MAX, æ­¤æ—¶å‡½æ•°å°±è¿”å› -ENAMETOOLONG, ä»¥æ­¤è¡¨ç¤ºæ‰“å¼€çš„æ–‡ä»¶å
å¤ªé•¿ã€‚å¦‚æœåå­—é•¿åº¦åœ¨ EMBEDDED_NAME_MAX åˆ° PATH_MAX ä¹‹é—´ï¼Œé‚£ä¹ˆ
æ–°æ—§ "struct filename" çš„é€»è¾‘å…³ç³»å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000002.png)

{% highlight c %}
        result->refcnt = 1;
        /* The empty path is special. */
        if (unlikely(!len)) {
                if (empty)
                        *empty = 1;
                if (!(flags & LOOKUP_EMPTY)) {
                        putname(result);
                        return ERR_PTR(-ENOENT);
                }
        }

        result->uptr = filename;
        result->aname = NULL;
        audit_getname(result);
        return result;
{% endhighlight %}

å‡½æ•°ç›®å‰å·²ç»ä½¿ç”¨ä¸€ä¸ª struct filename ç®¡ç†ä»ç”¨æˆ·ç©ºé—´è·å¾—çš„è·¯å¾„åï¼Œ
ç”±äºä¸Šé¢åˆ†æäº†ä¸åŒé•¿åº¦è·¯å¾„åé‡‡ç”¨ä¸åŒçš„ "struct filename" ç®¡ç†
ç­–ç•¥ï¼Œå‡½æ•°è®²æœ€ç»ˆä½¿ç”¨çš„ "struct filename" çš„ refcnt è®¾ç½®ä¸º 1ï¼Œ
ä»¥æ­¤è¡¨ç¤ºè¯¥ "struct filename" æ­£åœ¨ä½¿ç”¨ã€‚å¦‚æœ len ä¸ºé›¶ï¼Œè¡¨ç¤ºç‰¹æ®Šçš„
è·¯å¾„ï¼Œè¿™é‡Œä¸åšè¯¦ç»†åˆ†æã€‚æ¥ç€å‡½æ•°è®² "struct filename" çš„ uptr æŒ‡å‘
äº†ç”¨æˆ·ç©ºé—´çš„ filename å­—ç¬¦ä¸²ï¼Œå¹¶å°† aname è®¾ç½®ä¸º NULLã€‚å‡½æ•°æœ€åè¿”å›
"struct filename"ã€‚

ç ”ç©¶å®Œæºç ä¹‹åï¼Œè¿™é‡Œå¯¹ open æ‰“å¼€çš„è·¯å¾„åè¿›è¡Œè¿›ä¸€æ­¥ç ”ç©¶ï¼Œ
ç›¸å…³çš„ç ”ç©¶æ–‡æ¡£å¦‚ä¸‹:

> - [Open æ‰“å¼€è·¯å¾„é•¿åº¦ç ”ç©¶](https://biscuitos.github.io/blog/open-namelen/)

---------------------------------

#### <span id="C00002">find_next_fd</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000024.png)

find_next_fd() å‡½æ•°ç”¨äºä»å½“å‰è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ä¸­è·å¾—ä¸€ä¸ªæœªä½¿ç”¨çš„
æ–‡ä»¶æè¿°ç¬¦ã€‚å‚æ•° fdt æŒ‡å‘æ–‡ä»¶æè¿°ç¬¦ç»“æ„ "struct fdtable"ï¼Œå‚æ•°
start ä»£è¡¨å¼€å§‹æŸ¥æ‰¾çš„æ–‡ä»¶æè¿°ç¬¦ã€‚

å†…æ ¸ä¸­æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ç€å½“å‰è¿›ç¨‹æ‰€æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½ä½¿ç”¨å½“å‰è¿›ç¨‹èƒ½å¤Ÿ
åŒºåˆ†çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ç¤ºã€‚å¯¹äºå½“å‰è¿›ç¨‹ï¼Œæ–‡ä»¶æè¿°ç¬¦å°±æ˜¯ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°ï¼Œä½†
å¯¹äºå…¶ä»–è¿›ç¨‹æ˜¯ä¸å”¯ä¸€çš„ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶æè¿°ç¬¦å€¼ç›¸åŒï¼Œä½†ä¸ä¸€å®šæ˜¯åŒä¸€ä¸ªæ–‡ä»¶ã€‚
å†…æ ¸ä½¿ç”¨ struct fdtable ç»“æ„ç»´æŠ¤å½“å‰è¿›ç¨‹æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å…¶å®šä¹‰
å¦‚ä¸‹:

{% highlight c %}
struct fdtable {
        unsigned int max_fds;
        struct file __rcu **fd;      /* current fd array */
        unsigned long *close_on_exec;
        unsigned long *open_fds;
        unsigned long *full_fds_bits;
        struct rcu_head rcu;
};
{% endhighlight %}

struct fdtable ç»“æ„ä¸­ full_fds_bits å’Œ open_fds éƒ½æ˜¯ bitmapï¼Œ
max_fds ä»£è¡¨è¯¥ç»“æ„èƒ½å¤Ÿç»´æŠ¤æœ€å¤§æ–‡ä»¶æè¿°æ•°ï¼Œmax_fds çš„å€¼å†³å®š
äº† open_fds çš„ bits æ•°ã€‚åœ¨ open_fds æŒ‡å‘çš„ bitmap ä¸­ï¼Œbit 
ä»ä½ä½å¼€å§‹ç¼–ç ï¼Œæ¯ä¸ª bit å¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå³ bit0 ä»£è¡¨
çš„æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯ 0ï¼Œbit1 ä»£è¡¨çš„æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯ 1. åœ¨ 
open_fds çš„ bitmap ä¸­ï¼Œç½®ä½çš„ bit å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å·²ç»åˆ†é…ï¼Œ
åä¹‹è¯¥ bit æ¸…é›¶åˆ™è¡¨ç¤ºè¯¥æ–‡ä»¶æè¿°ç¬¦æ²¡æœ‰åˆ†é…ã€‚åŒç† full_fds_bits
ä¹Ÿæ˜¯ä¸€ä¸ª bitmapï¼Œå¹¶ä¸”ä»ä½ä½å¼€å§‹ç¼–ç ï¼Œä½† full_fds_bits çš„æ¯ä¸ª
bit æŒ‡ä»£ open_fds ä¸­çš„ 32 ä¸ª bitï¼Œå³ full_fds_bits çš„ bit0
ä»£è¡¨äº† open_fds çš„ 0 åˆ° 31 bit, full_fds_bits çš„ bit-1
ä»£è¡¨äº† open_fds çš„ 32 åˆ° 63 bit, å¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000025.png)

å·¥å…·ä¸Šé¢çš„åŸç†å¯ä»¥çŸ¥é“ï¼Œå‡½æ•°é¦–å…ˆè·å¾— struct fdtable æ”¯æŒçš„
æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼ï¼Œå³ max_fds çš„å€¼ã€‚æ¥ç€è®¡ç®— max_fds ä½äº 
ä½äº full_fds_bits çš„ä½ç½®ï¼Œæ­¤å¤„è°ƒç”¨ find_next_zero_bit()
å‡½æ•°å¯ä»¥ä» start å¼€å§‹æŸ¥æ‰¾ full_fds_bits ä¸­ç¬¬ä¸€ä¸ªæ¸…é›¶çš„ä½ç½®ï¼Œ
åœ¨ full_fds_bis ä¸­ï¼Œå¦‚æœæŸä¸ª bit ç½®ä½ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¯¥ bit å¯¹äº
çš„ 32 ä¸ªæ–‡ä»¶æè¿°ç¬¦éƒ½å·²ç»åˆ†é…äº†ã€‚æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨çš„ bit ä¹‹åï¼Œ
è¿›è€Œè·å¾—è¯¥ bit åœ¨ open_fds ä¸­èµ·å§‹ bitã€‚æ¥ä¸‹æ¥å°±æ˜¯åˆ¤æ–­è¯¥
èµ·å§‹åœ°å€æ˜¯å¦è¶…è¿‡ "struct fdtable" ç»´æŠ¤çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦ï¼Œ
å¦‚æœè¶…è¿‡ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› maxfdã€‚å¦‚æœæ‰¾åˆ°çš„æ–‡ä»¶æè¿°ç¬¦å€¼æ¯” start
å¤§ï¼Œé‚£ä¹ˆå°† start è®¾ç½®ä¸º bitbit. æœ€åè°ƒç”¨ find_next_zero_bit()
å‡½æ•°ä» start å¼€å§‹åˆ° maxfd ç»“æŸï¼Œåœ¨ open_fds ä¸­æŸ¥æ‰¾ä¸€ä¸ª
æœªä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦.

> - [find_next_zero_bit å‡½æ•°å®è·µ](https://biscuitos.github.io/blog/BITMAP_find_next_zero_bit/)

---------------------------------

#### <span id="C00003">\_\_set_open_fd</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000026.png)

\_\_set_open_fd() å‡½æ•°ç”¨äºç½®ä½ open_fds ä¸­çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å‚æ•° fd
è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå‚æ•° fdt æŒ‡å‘å½“å‰è¿›è¡Œçš„ struct fdtable ç»“æ„ã€‚
struct fdtable ç»“æ„ä¸­ full_fds_bits å’Œ open_fds éƒ½æ˜¯ bitmapï¼Œ
max_fds ä»£è¡¨è¯¥ç»“æ„èƒ½å¤Ÿç»´æŠ¤æœ€å¤§æ–‡ä»¶æè¿°æ•°ï¼Œmax_fds çš„å€¼å†³å®š
äº† open_fds çš„ bits æ•°ã€‚åœ¨ open_fds æŒ‡å‘çš„ bitmap ä¸­ï¼Œbit
ä»ä½ä½å¼€å§‹ç¼–ç ï¼Œæ¯ä¸ª bit å¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå³ bit0 ä»£è¡¨
çš„æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯ 0ï¼Œbit1 ä»£è¡¨çš„æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯ 1. åœ¨
open_fds çš„ bitmap ä¸­ï¼Œç½®ä½çš„ bit å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å·²ç»åˆ†é…ï¼Œ
åä¹‹è¯¥ bit æ¸…é›¶åˆ™è¡¨ç¤ºè¯¥æ–‡ä»¶æè¿°ç¬¦æ²¡æœ‰åˆ†é…ã€‚åŒç† full_fds_bits
ä¹Ÿæ˜¯ä¸€ä¸ª bitmapï¼Œå¹¶ä¸”ä»ä½ä½å¼€å§‹ç¼–ç ï¼Œä½† full_fds_bits çš„æ¯ä¸ª
bit æŒ‡ä»£ open_fds ä¸­çš„ 32 ä¸ª bitï¼Œå³ full_fds_bits çš„ bit0
ä»£è¡¨äº† open_fds çš„ 0 åˆ° 31 bit, full_fds_bits çš„ bit-1
ä»£è¡¨äº† open_fds çš„ 32 åˆ° 63 bit, å¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000025.png)

å‡½æ•°é¦–å…ˆä½¿ç”¨ __set_bit() å‡½æ•°å°† fd å¯¹åº”çš„ open_fds bit ä½ç½®ä½ï¼Œ
ç„¶åæ£€æŸ¥è¯¥ bit ä½å¯¹äºçš„ full_fds_bits çš„ 32 ä¸ª bits æ˜¯å¦éƒ½å·²ç»
ç½®ä½ï¼Œå¦‚æœç½®ä½ï¼Œé‚£ä¹ˆå°†å¯¹åº”çš„ full_fds_bits ç½®ä½.

> - [\_\_set_bit() å‡½æ•°å®è·µ](https://biscuitos.github.io/blog/BITMAP___set_bit/)

---------------------------------

#### <span id="C00004">\_\_set_close_on_exec</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000027.png)

__set_close_on_exec() å‡½æ•°ç”¨äºå°†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ° struct fdtable
ç»“æ„çš„ close_on_exec bitmap ä¸­ã€‚å‚æ•° fd æŒ‡å‘æ–‡ä»¶æè¿°ç¬¦ï¼Œå‚æ•° fdt
æŒ‡å‘å½“å‰è¿›ç¨‹çš„ struct fdtable æ•°æ®ç»“æ„ã€‚

close_on_exec æ˜¯ä¸€ä¸ªè¿›ç¨‹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ–‡ä»¶å¥æŸ„ï¼‰çš„ä½å›¾æ ‡å¿—ï¼Œæ¯ä¸ªæ¯”ç‰¹
ä½ä»£è¡¨ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºç¡®å®šåœ¨è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ execve() æ—¶éœ€è¦å…³é—­
çš„æ–‡ä»¶å¥æŸ„ã€‚å½“ä¸€ä¸ªç¨‹åºä½¿ç”¨ fork() å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªå­è¿›ç¨‹æ—¶ï¼Œé€šå¸¸ä¼šåœ¨è¯¥å­
è¿›ç¨‹ä¸­è°ƒç”¨ execve() å‡½æ•°åŠ è½½æ‰§è¡Œå¦ä¸€ä¸ªæ–°ç¨‹åºã€‚æ­¤æ—¶å­è¿›ç¨‹å°†å®Œå…¨è¢«æ–°ç¨‹åº
æ›¿æ¢æ‰ï¼Œå¹¶åœ¨å­è¿›ç¨‹ä¸­å¼€å§‹æ‰§è¡Œæ–°ç¨‹åºã€‚

è‹¥ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦åœ¨ close_on_exec ä¸­çš„å¯¹åº”æ¯”ç‰¹ä½è¢«è®¾ç½®ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œ
execve() æ—¶è¯¥æè¿°ç¬¦å°†è¢«å…³é—­ï¼Œå¦åˆ™è¯¥æè¿°ç¬¦å°†å§‹ç»ˆå¤„äºæ‰“å¼€çŠ¶æ€ã€‚å½“æ‰“å¼€
ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹æ–‡ä»¶å¥æŸ„åœ¨å­è¿›ç¨‹ä¸­ä¹Ÿå¤„äºæ‰“å¼€çŠ¶æ€ã€‚å› æ­¤
sys_open() ä¸­è¦å¤ä½å¯¹åº”æ¯”ç‰¹ä½ã€‚

> - [\_\_set_bit() å‡½æ•°å®è·µ](https://biscuitos.github.io/blog/BITMAP___set_bit/)

---------------------------------

#### <span id="C00005">\_\_clear_close_on_exec</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000028.png)

__clear_close_on_exec() å‡½æ•°ç”¨äºå°†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä»å½“å‰è¿›ç¨‹çš„
struct fdtable ç»“æ„ close_on_exec ä¸­ç§»é™¤ã€‚ å‚æ•° fd ä»£è¡¨æ–‡ä»¶æè¿°ç¬¦ï¼Œ
fdt æŒ‡å‘å½“å‰è¿›è¡Œçš„ fdtableã€‚

close_on_exec æ˜¯ä¸€ä¸ªè¿›ç¨‹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ–‡ä»¶å¥æŸ„ï¼‰çš„ä½å›¾æ ‡å¿—ï¼Œæ¯ä¸ªæ¯”ç‰¹
ä½ä»£è¡¨ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºç¡®å®šåœ¨è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ execve() æ—¶éœ€è¦å…³é—­
çš„æ–‡ä»¶å¥æŸ„ã€‚å½“ä¸€ä¸ªç¨‹åºä½¿ç”¨ fork() å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªå­è¿›ç¨‹æ—¶ï¼Œé€šå¸¸ä¼šåœ¨è¯¥å­
è¿›ç¨‹ä¸­è°ƒç”¨ execve() å‡½æ•°åŠ è½½æ‰§è¡Œå¦ä¸€ä¸ªæ–°ç¨‹åºã€‚æ­¤æ—¶å­è¿›ç¨‹å°†å®Œå…¨è¢«æ–°ç¨‹åº
æ›¿æ¢æ‰ï¼Œå¹¶åœ¨å­è¿›ç¨‹ä¸­å¼€å§‹æ‰§è¡Œæ–°ç¨‹åºã€‚

è‹¥ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦åœ¨ close_on_exec ä¸­çš„å¯¹åº”æ¯”ç‰¹ä½è¢«è®¾ç½®ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œ
execve() æ—¶è¯¥æè¿°ç¬¦å°†è¢«å…³é—­ï¼Œå¦åˆ™è¯¥æè¿°ç¬¦å°†å§‹ç»ˆå¤„äºæ‰“å¼€çŠ¶æ€ã€‚å½“æ‰“å¼€
ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹æ–‡ä»¶å¥æŸ„åœ¨å­è¿›ç¨‹ä¸­ä¹Ÿå¤„äºæ‰“å¼€çŠ¶æ€ã€‚å› æ­¤
sys_open() ä¸­è¦å¤ä½å¯¹åº”æ¯”ç‰¹ä½ã€‚

> - [\_\_clear_bit() å‡½æ•°å®è·µ](https://biscuitos.github.io/blog/BITMAP___clear_bit/)

---------------------------------

#### <span id="C00006">\_\_alloc_fd</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000029.png)

__alloc_fd() å‡½æ•°ç”¨äºä»å½“å‰è¿›ç¨‹ä¸­è·å¾—ä¸€ä¸ªå¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚
å‚æ•° files æŒ‡å‘å½“å‰è¿›è¡Œçš„ struct files_struct, å‚æ•° start
æŒ‡å‘æ–‡ä»¶æè¿°ç¬¦å¼€å§‹æŸ¥æ‰¾çš„ä½ç½®ï¼Œå‚æ•° end æŒ‡å‘æ–‡ä»¶æè¿°ç¬¦ç»“æŸ
çš„ä½ç½®ï¼Œflags å‚æ•°åŒ…å«è·å¾—æ–‡ä»¶æè¿°ç¬¦çš„æ ‡å¿—ã€‚å‡½æ•°å®šä¹‰äº†ä¸‰ä¸ª
å±€éƒ¨å˜é‡ï¼Œfd ç”¨äºå­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œerror ç”¨äºå­˜å‚¨é”™è¯¯ä»£ç ï¼Œ
å‚æ•° fdt ç”¨äºæŒ‡å‘ä¸€ä¸ª struct fdtable.

{% highlight c %}
        spin_lock(&files->file_lock);
repeat:
        fdt = files_fdtable(files);
        fd = start;
        if (fd < files->next_fd)
                fd = files->next_fd;

        if (fd < fdt->max_fds)
                fd = find_next_fd(fdt, fd);
{% endhighlight %}

å‡½æ•°é¦–å…ˆè°ƒç”¨ spin_lock() åŠ ä¸Šé”ï¼Œç„¶åè°ƒç”¨ files_fdtable() å‡½æ•°
è·å¾— files å‚æ•°å¯¹äºçš„ struct fdtable ç»“æ„ï¼Œå¹¶å°†å±€éƒ¨å˜é‡ fd è®¾ç½®
æˆ startã€‚struct files_struct ç»“æ„ next_fd æˆå‘˜åŒ…å«äº†å½“å‰è¿›ç¨‹
ä¸‹ä¸€ä¸ªå¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæ­¤æ—¶ fd å½“å‰è¿›ç¨‹ä¸‹ä¸€ä¸ªå¯ç”¨æ–‡ä»¶æè¿°ç¬¦ï¼Œ
é‚£ä¹ˆå°† fd è®¾ç½®ä¸º files->next_fd. å¦‚æœæ­¤æ—¶ fd çš„å€¼å°äºå½“å‰è¿›ç¨‹æ”¯æŒ
çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ä¹ˆå‡½æ•°å°±è°ƒç”¨ find_next_fd() å‡½æ•°åœ¨å½“å‰è¿›ç¨‹
ä¸­æŸ¥æ‰¾ä¸€ä¸ªå¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚

åœ¨å†…æ ¸ä¸­ï¼Œå½“å‰è¿›ç¨‹ä¸æ–‡ä»¶ç›¸å…³çš„æ•°æ®ç»“æ„ç»´æŠ¤åœ¨ struct task_struct 
çš„ files æˆå‘˜é‡Œï¼Œå…¶æ˜¯ä¸€ä¸ª struct files ç»“æ„ã€‚struct files ç»“æ„
ä¸­åŒ…å«äº†æˆå‘˜ fdtab æˆå‘˜ï¼Œè¯¥æˆå‘˜å±äº struct fdtable ç»“æ„ï¼Œè¯¥ç»“æ„
ä¸“é—¨ç”¨äºç®¡ç†è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå…¶å®šä¹‰å¦‚ä¸‹:

{% highlight c %}
struct fdtable {
        unsigned int max_fds;
        struct file __rcu **fd;      /* current fd array */
        unsigned long *close_on_exec;
        unsigned long *open_fds;
        unsigned long *full_fds_bits;
        struct rcu_head rcu;
};
{% endhighlight %}

struct fdtable å­˜åœ¨ä¸‰ä¸ª bitmapï¼Œåœ¨è¿™é‡Œæ¶‰åŠåˆ° open_fds å’Œ full_fds_bits 
ä¸¤ä¸ª bitmapï¼Œé€šè¿‡ä¸¤ä¸ª bitmap å¯ä»¥è·å¾—ä¸€ä¸ªå¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé€»è¾‘å…³ç³»å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000025.png)

æ›´å¤š struct fdtable ä¿¡æ¯è¯·æŸ¥çœ‹:

> - [struct fdtable](#A00012)
>
> - [find_next_fd](#C00002)

{% highlight c %}
        /*
         * N.B. For clone tasks sharing a files structure, this test
         * will limit the total number of files that can be opened.
         */
        error = -EMFILE;
        if (fd >= end)
                goto out;

        error = expand_files(files, fd);
        if (error < 0)
                goto out;
{% endhighlight %}

å‡½æ•°ç»§ç»­æ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼Œæ¯å½“å½“å‰è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°é‡è¶…è¿‡ fdtable
æ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ•°ä¸”å°äºç³»ç»Ÿæ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ•°ï¼Œé‚£ä¹ˆå‡½æ•°å°±ä¼šè°ƒç”¨ 
expand_files() å‡½æ•°ï¼Œä»¥æ­¤æ‰©å¤§å½“å‰è¿›ç¨‹æ‰€æ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ•°ã€‚

{% highlight c %}
        /*
         * If we needed to expand the fs array we
         * might have blocked - try again.
         */
        if (error)
                goto repeat;

        if (start <= files->next_fd)
                files->next_fd = fd + 1;

        __set_open_fd(fd, fdt);
        if (flags & O_CLOEXEC)
                __set_close_on_exec(fd, fdt);
        else
                __clear_close_on_exec(fd, fdt);
        error = fd;
{% endhighlight %}

å‡½æ•°åœ¨è·å¾—ä¸€ä¸ªå¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ä¹‹åï¼Œå‡½æ•°æ›´æ–°å½“å‰è¿›ç¨‹ä¸‹ä¸€ä¸ª
å¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå³ "files->next_fd = fd + 1", å‡½æ•°æ¥ç€
è°ƒç”¨ __set_open_fd() å‡½æ•°å°†è·å¾—çš„æ–‡ä»¶æè¿°ç¬¦åœ¨å½“å‰è¿›ç¨‹çš„
fdtable é‡Œé¢æ ‡è®°ï¼Œä»¥æ­¤è¡¨ç¤ºè¯¥æ–‡ä»¶æè¿°ç¬¦å·²ç»è¢«ä½¿ç”¨ã€‚å‡½æ•°æ¥ç€åˆ¤æ–­
flags å‚æ•°æ˜¯å¦åŒ…å« O_CLOEXEC æ ‡å¿—ï¼Œå¦‚æœåŒ…å«ï¼Œé‚£ä¹ˆå‡½æ•°ä¼šè®¾ç½®
fdtable çš„ close_on_exec ä½å›¾ï¼Œè¯¥ä½å›¾ç”¨äº execv() è¿”å›æ—¶è¦
å…³é—­çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦‚æœæ”¯æŒ O_CLOEXEC, é‚£ä¹ˆå‡½æ•°è°ƒç”¨ __set_close_on_exec()
å‡½æ•°å°†æ–‡ä»¶æè¿°ç¬¦å† close_on_exec å¯¹äºçš„ bit ä½ç½®ä½ï¼›åä¹‹
åˆ™è°ƒç”¨ __clear_on_exec() å‡½æ•°å°†æ–‡ä»¶æè¿°ç¬¦ä» close_on_exec ä½å›¾
ä¸­ç§»é™¤ã€‚æ›´å¤šç»†èŠ‚å¯ä»¥å‚è€ƒ:

> - [\_\_set_open_fd](#C00003)
>
> - [\_\_set_close_on_exec](#C00004)
>
> - [\_\_set_clear_on_exec](#C00005)

{% highlight c %}
        /* Sanity check */
        if (rcu_access_pointer(fdt->fd[fd]) != NULL) {
                printk("alloc_fd: slot %d not NULL!\n", fd);
                rcu_assign_pointer(fdt->fd[fd], NULL);
        }

out:
        spin_unlock(&files->file_lock);
        return error;
{% endhighlight %}

å‡½æ•°æœ€åå¯¹ fdt->fd[fd] è¿›è¡Œæ£€æµ‹ï¼Œä»¥æ­¤ç¡®ä¿è¯¥æ–‡ä»¶æè¿°ç¬¦æ²¡æœ‰
å¯¹åº”ä¸€ä¸ªå·²ç»æ‰“å¼€çš„æ–‡ä»¶ã€‚å¦‚æœæ­¤æ—¶å·²ç»å¯¹åº”ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆ
ç³»ç»Ÿæç¤ºç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚å‡½æ•°æœ€åè°ƒç”¨ spin_unlock() å‡½æ•°è¿›è¡Œ
è§£é”å¹¶è¿”å› error é”™è¯¯å€¼ã€‚


---------------------------------

#### <span id="C00007">\_\_alloc_file</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000031.png)

__alloc_file() å‡½æ•°ç”¨äºåˆ†é…ä¸€ä¸ªæ–°çš„ "struct file" ç»“æ„ï¼Œå¹¶åˆå§‹åŒ–
"struct file" çš„åŸºç¡€å†…å®¹ã€‚å‚æ•° flags åŒ…å«äº†æ‰“å¼€æ–‡ä»¶çš„æ ‡å¿—ï¼Œå‚æ•°
cred æ˜¯ä¸è®¤è¯å’Œä»¤ç‰Œç›¸å…³çš„ä¿¡æ¯ã€‚å‡½æ•°å®šä¹‰äº†ä¸¤ä¸ªå±€éƒ¨å˜é‡ï¼Œf æ˜¯ä¸€ä¸ª
æ–‡ä»¶åªåšï¼Œerror å˜é‡ç”¨äºå­˜å‚¨é”™è¯¯ä¿¡æ¯ã€‚

å‡½æ•°é¦–å…ˆè°ƒç”¨ kmem_cache_zalloc() ä» file_cachep ç¼“å­˜ä¸­åˆ†é…ä¸€ä¸ª
"struct file" çš„ç©ºé—´ç»™ fï¼Œå¦‚æœåˆ†é…å¤±è´¥ï¼Œåˆ™è¿”å› ENOMEMã€‚æ¥ä¸‹æ¥
åˆå§‹åŒ–è¯¥ struct file. å°† struct file çš„ f_cred è®¾ç½®ä¸º get_cred(cred),
ä»¥æ­¤è®¾ç½® struct file çš„è®¤è¯ä¿¡æ¯ã€‚å¦‚æœå†…æ ¸æ²¡æœ‰å¼€å¯ CONFIG_SECURITY
åŠŸèƒ½ï¼Œé‚£ä¹ˆ security_file_alloc() å‡½æ•°æ²¡æœ‰ä»»ä½•ä½œç”¨ï¼Œç›´æ¥è¿”å› 0ã€‚
å‡½æ•°ç»§ç»­å°† struct file çš„ f_count è®¾ç½®ä¸º 1ï¼Œä»¥æ­¤è¡¨ç¤ºæœ‰ä¸€ä¸ªä½¿ç”¨è€…ï¼Œ
æ¥ç€åˆå§‹åŒ– struct file çš„è¯»å†™é”ï¼Œmutex é”ä»¥åŠè‡ªæ—‹é”ã€‚æ¥ç€å‡½æ•°è°ƒç”¨
eventpoll_init_file() å‡½æ•°åˆå§‹åŒ– struct file çš„ epollï¼Œè¯¥è®¾ç½®å¿…é¡»åœ¨
å†…æ ¸å¯ç”¨ CONFIG_EPOLL çš„å‰æä¸‹æœ‰æ•ˆã€‚ç„¶åå°† struct file çš„ f_flags
è®¾ç½®ä¸ºå‚æ•° flagsï¼Œä»¥åŠæ‰“å¼€æ¨¡å¼ f_mode è®¾ç½®ä¸º OPEN_FMODE(flags) çš„å€¼ã€‚
ç»è¿‡ä¸Šé¢çš„å¤„ç†ï¼Œstruct file çš„åŸºç¡€æ•°æ®å·²ç»è¢«åˆå§‹åŒ–ã€‚

---------------------------------

#### <span id="C00008">alloc_empty_file</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000032.png)

alloc_empty_file() å‡½æ•°ç”¨äºåˆ†é…ä¸€ä¸ªæœªä½¿ç”¨çš„ "struct file"ï¼Œåˆå§‹åŒ–åŸºç¡€
æ•°æ®ä¹‹åè¿”å›æŒ‡å‘ "struct file" çš„æŒ‡é’ˆã€‚å‚æ•° flags åŒ…å«æ‰“å¼€æ–‡ä»¶çš„æ ‡å¿—ä¿¡æ¯ï¼Œ
å‚æ•° cred æŒ‡å‘ä»¤ç‰Œå’Œè®¤è¯ä¿¡æ¯ã€‚å‡½æ•°å®šä¹‰äº†ä¸¤ä¸ªå±€éƒ¨å˜é‡ï¼Œold_max å˜é‡ç”¨äºå‚¨å­˜
å†…æ ¸æ”¯æŒçš„æ‰“å¼€æ–‡ä»¶æ•°ï¼Œå‚æ•° f æ˜¯ä¸€ä¸ªæŒ‡å‘ struct file çš„æŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘
æœªä½¿ç”¨çš„ struct file.

{% highlight c %}
        /*
         * Privileged users can go above max_files
         */
        if (get_nr_files() >= files_stat.max_files && 
                                                !capable(CAP_SYS_ADMIN)) {
                /*
                 * percpu_counters are inaccurate. Do an expensive check before
                 * we go and fail.
                 */
                if (percpu_counter_sum_positive(&nr_files) >=
                                                        files_stat.max_files)
                        goto over;
        }
{% endhighlight %}

å‡½æ•°é¦–å…ˆè°ƒ get_nr_files() è·å¾—å½“å‰ç³»ç»Ÿè¿›ç¨‹æ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ï¼Œé»˜è®¤ä¸º 32ï¼Œ
"files_stat.max_files" ä»£ç å¯ä»¥è·å¾—å½“å‰ç³»ç»Ÿå¯ä»¥æ”¯æŒçš„æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°é‡ã€‚
"capable(CAP_SYS_ADMIN)" ä»£ç ç”¨äºæ£€æŸ¥æ˜¯å¦æ”¯æŒ CAP_SYS_ADMIN, è¯¥æƒé™å…è®¸
æ‰§è¡Œç³»ç»Ÿç®¡ç†ä»»åŠ¡ï¼šåŠ è½½/å¸è½½æ–‡ä»¶ç³»ç»Ÿã€è®¾ç½®ç£ç›˜é…é¢ã€å¼€/å…³äº¤æ¢è®¾å¤‡å’Œæ–‡ä»¶ç­‰ã€‚
å‡½æ•°åœ¨è¿™æ®µä»£ç ç‰‡æ®µä¸­é¦–å…ˆåˆ¤æ–­å½“å‰è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ•°æ˜¯å¦å·²ç»è¶…è¿‡ç³»ç»Ÿæ”¯æŒçš„æœ€å¤§
æ–‡ä»¶æ‰“å¼€æ•°ï¼Œå¦‚æœå¤§äºï¼Œé‚£ä¹ˆå‡½æ•°æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å…·æœ‰ CAP_SYS_ADMIN æƒé™ï¼Œå¦‚æœ
æ­¤æ—¶æ²¡æœ‰è¯¥æƒé™ï¼Œé‚£ä¹ˆå‡½æ•°å°±æ‰§è¡Œè¿™æ®µä»£ç ã€‚è¿›å…¥è¿™æ®µä»£ç ä¹‹åï¼Œå‡½æ•°å†æ¬¡è°ƒç”¨
percpu_counter_sum_positive() å‡½æ•°ç¡®å®šå½“å‰è¿›ç¨‹æ‰“å¼€æ•°æ˜¯å¦å¤§äºå½“å‰ç³»ç»Ÿæœ€å¤§
æ”¯æŒæ‰“å¼€æ–‡ä»¶æ•°ã€‚å¦‚æœçœŸçš„å¤§äºï¼Œé‚£ä¹ˆè·³è½¬åˆ° overã€‚

{% highlight c %}
over:
        /* Ran out of filps - report that */
        if (get_nr_files() > old_max) {
                pr_info("VFS: file-max limit %lu reached\n", get_max_files());
                old_max = get_nr_files();
        }
        return ERR_PTR(-ENFILE);
{% endhighlight %}

å¦‚æœå‡½æ•°è·³è½¬åˆ° over å¤„ï¼Œé‚£ä¹ˆå‡½æ•°åˆ¤æ–­ get_nr_files() æ˜¯å¦å¤§äº old_max,
é‚£ä¹ˆç³»ç»Ÿè¿›è¡ŒæŠ¥é”™ï¼Œå¹¶è¿”å› ERR_PTR(-ENFILE).

{% highlight c %}
        f = __alloc_file(flags, cred);
        if (!IS_ERR(f))
                percpu_counter_inc(&nr_files);

        return f;
{% endhighlight %}

å¦‚æœå½“å‰è¿›ç¨‹æ–‡ä»¶æ‰“å¼€æ•°æ²¡æœ‰è¶…è¿‡ç³»ç»Ÿæœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ï¼Œé‚£ä¹ˆå‡½æ•°è°ƒç”¨
__alloc_file() å‡½æ•°è·å¾—ä¸€ä¸ª "struct file", å¹¶ä½¿ç”¨ f æŒ‡å‘è¯¥ 
"struct file", å¦‚æœè·å–è¿‡ç¨‹ä¸­æ²¡æœ‰æŠ¥é”™ï¼Œé‚£ä¹ˆå‡½æ•°è°ƒç”¨
"percpu_counter_inc()" å‡½æ•°å¢åŠ  nr_files çš„æ•°é‡ã€‚æœ€å
è¿”å› f æŒ‡é’ˆã€‚

> - [\_\_alloc_file](#C00007)

---------------------------------

#### <span id="C00009">ACC_MODE</span>

{% highlight c %}
#define O_ACCMODE       00000003
#define ACC_MODE(x) ("\004\002\006\006"[(x)&O_ACCMODE])
{% endhighlight %}

ACC_MODE() å®ç”¨äºè¿‡æ»¤å¹¶è·å¾—æ‰“å¼€æ–‡ä»¶çš„è®¿é—®æƒé™ã€‚åœ¨ç”¨æˆ·ç©ºé—´å†æ‰“å¼€æ–‡ä»¶
çš„æ—¶å€™ä¼ å…¥ç›¸åº”çš„è®¿é—®æƒé™ï¼Œæ¯”å¦‚: O_RDONLY(0x00), O_WRONLY(0x01),
O_RDWR(0x02)ã€‚å› æ­¤è®¿é—®æ¨¡å¼å°±æ˜¯åŒ…æ‹¬åªè¯»ï¼Œåªå†™ä»¥åŠå¯è¯»å¯å†™ã€‚

{% highlight c %}
ACC_MODE[0]        ----> 0x4
ACC_MODE[1]        ----> 0x2
ACC_MODE[2]        ----> 0x6
ACC_MODE[3]        ----> 0x6
{% endhighlight %}

---------------------------------

#### <span id="C0000A">build_open_flags</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000037.png)

build_open_flags() å‡½æ•°ç”¨äºå¤„ç†æ‰“å¼€æ–‡ä»¶çš„æ ‡å¿—å’Œæ¨¡å¼ä¿¡æ¯ã€‚å‚æ•° flags
æŒ‡å‘æ‰“å¼€æ–‡ä»¶çš„æ ‡å¿—ï¼Œmode å‚æ•°æŒ‡å‘æ‰“å¼€æ–‡ä»¶çš„æ¨¡å¼ï¼Œop å‚æ•°æ˜¯ä¸€ä¸ª
open_flags ç»“æ„ã€‚å‡½æ•°è¿˜å®šä¹‰äº†ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ lookup_flags ç”¨äº
æ–‡ä»¶æŸ¥æ‰¾æ—¶ä½¿ç”¨çš„æ ‡å¿—ä¿¡æ¯ï¼Œç¬¬äºŒä¸ª acc_mode ç”¨äºå­˜å‚¨æ–‡ä»¶çš„æ¨¡å¼ä¿¡æ¯ã€‚
å†…æ ¸ä½¿ç”¨ struct open_flags ç»“æ„å­˜å‚¨æ–‡ä»¶æ‰“å¼€æ ‡å¿—ï¼Œè®¿é—®æ¨¡å¼ä»¥åŠæŸ¥æ‰¾æ ‡å¿—
ç­‰ä¿¡æ¯ï¼Œå®šä¹‰å¦‚ä¸‹:

{% highlight c %}
/*
 * open.c
 */
struct open_flags {
        int open_flag;
        umode_t mode;
        int acc_mode;
        int intent;
        int lookup_flags;
};
{% endhighlight %}

struct open_flags ç»“æ„ä¸­ï¼Œopen_flag ç”¨äºå­˜å‚¨æ‰“å¼€æ–‡ä»¶çš„æ ‡å¿—ï¼Œmode ç”¨äº
å­˜å‚¨æ‰“å¼€æ–‡ä»¶çš„æ¨¡å¼ï¼Œacc_mode ç”¨äºå­˜å‚¨æ–‡ä»¶çš„è®¿é—®æ¨¡å¼ï¼Œlookup_flags ç”¨äº
å­˜å‚¨æ–‡ä»¶æŸ¥æ‰¾çš„æ ‡å¿—ã€‚

å‡½æ•°é¦–å…ˆä½¿ç”¨ ACC_MODE() å®ä»æ–‡ä»¶æ‰“å¼€æ ‡å¿—ä¸­è·å¾—è®¿é—®æ¨¡å¼ï¼Œå†…æ ¸æ”¯æŒ
ä¸‰ç§è®¿é—®æ¨¡å¼: O_RDONLYã€O_WRONLY å’Œ O_RDWR. æ¥ç€å°†æ‰“å¼€æ–‡ä»¶çš„æ ‡å¿—
ä¸ VALID_OPEN_FLAGS ç›¸ä¸ï¼ŒVALID_OPEN_FLAGS å†…åŒ…å«äº†å†…æ ¸æ”¯æŒçš„æ‰“å¼€
æ–‡ä»¶æ ‡å¿—ï¼Œä»¥æ­¤è¿‡æ»¤è°ƒä¸ç¬¦åˆè¦æ±‚çš„æ‰“å¼€æ ‡å¿—ï¼Œå…¶å®šä¹‰å¦‚ä¸‹:

{% highlight c %}
#define VALID_OPEN_FLAGS \ 
        (O_RDONLY | O_WRONLY | O_RDWR | O_CREAT | O_EXCL | O_NOCTTY | O_TRUNC | \       
         O_APPEND | O_NDELAY | O_NONBLOCK | O_NDELAY | __O_SYNC | O_DSYNC | \
         FASYNC | O_DIRECT | O_LARGEFILE | O_DIRECTORY | O_NOFOLLOW | \
         O_NOATIME | O_CLOEXEC | O_PATH | __O_TMPFILE)
{% endhighlight %}

å…·ä½“æ¯ä¸ªæ ‡å¿—çš„å«ä¹‰ï¼Œè¯·å‚è€ƒä¸‹é¢æ–‡ç« :

> - [open æ‰“å¼€æ ‡å¿—è¯¦è§£](https://biscuitos.github.io/blog/open-flags/)

{% highlight c %}
        if (flags & (O_CREAT | __O_TMPFILE))
                op->mode = (mode & S_IALLUGO) | S_IFREG;
        else
                op->mode = 0;
{% endhighlight %}

O_CREAT æ ‡å¿—è¡¨ç¤ºå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œ__O_TMPFILE æ ‡è¯†
è¡¨ç¤ºåˆ›å»ºä¸€ä¸ªæ— åçš„ä¸´æ—¶æ–‡ä»¶ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸­ä¼šåˆ›å»ºä¸€ä¸ªæ— åçš„ inodeï¼Œå½“
æœ€åä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¢«å…³é—­çš„æ—¶å€™ï¼Œæ‰€æœ‰å†™å…¥è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹éƒ½ä¼šä¸¢ å¤±
é™¤éåœ¨æ­¤ä¹‹å‰ç»™äº†å®ƒä¸€ä¸ªåå­—. å‡½æ•°é¦–å…ˆåˆ¤æ–­æ‰“å¼€æ ‡å¿—æ˜¯å¦åŒ…å«
O_CREATE å’Œ __O_TMPFILE ä¸¤ä¸ªæ ‡å¿—ï¼Œè¿™ä¸¤ä¸ªæ ‡å¿—éƒ½ä¼šè§¦å‘ç³»ç»Ÿåˆ›å»º
æ–°æ–‡ä»¶ï¼Œå¹¶ä¸”æ–‡ä»¶åˆ›å»ºæ—¶ï¼Œopen ç³»ç»Ÿè°ƒç”¨éœ€è¦åŒ…å«æ–‡ä»¶æ¨¡å¼ä¿¡æ¯ã€‚
å¦‚æœåŒ…å«ï¼Œé‚£ä¹ˆå°† struct open_flags çš„ mode æˆå‘˜ä¸­æ·»æ–‡ä»¶æ‰“å¼€æ–‡ä»¶
æ¨¡å¼ä¿¡æ¯ï¼Œè¿™é‡Œ S_IALLUGO æ˜¯æ–‡ä»¶æ‹¥æœ‰è€…ï¼Œæ–‡ä»¶æ‹¥æœ‰ç»„ä»¥åŠå…¶ä»–ç”¨æˆ·çš„
æ¨¡å¼æ©ç ï¼Œå†è¿™ç§æƒ…å†µä¸‹ï¼Œå°†æ‰“å¼€æ–‡ä»¶çš„æ¨¡å¼ä¿¡æ¯åŠ ä¸Š S_IFREG æ ‡å¿—ï¼Œ
ä»¥æ­¤è¡¨ç¤ºåˆ›å»ºçš„æ˜¯ä¸€ä¸ªæ–‡ä»¶; åä¹‹ç³»ç»Ÿä¸ç”¨åˆ›å»ºæ–‡ä»¶ï¼Œé‚£ä¹ˆ struct open_flags
çš„ mode æˆå‘˜ä¸º 0ï¼Œä¹Ÿå°±æ˜¯ä¸ä½¿ç”¨ã€‚

{% highlight c %}
        /* Must never be set by userspace */
        flags &= ~FMODE_NONOTIFY & ~O_CLOEXEC;
{% endhighlight %}

å‡½æ•°ä»æ‰“å¼€æ–‡ä»¶æ ‡å¿—ä¸­å‰”é™¤äº† FMODE_NONOTIFY å’Œ O_CLOEXECï¼Œ
å†…æ ¸è§„å®šç”¨æˆ·ç©ºé—´æ‰“å¼€æ ‡å¿—ä¸èƒ½åŒ…å«ä»¥ä¸Šä¸¤ä¸ªæ ‡å¿—ã€‚

{% highlight c %}
        /*
         * O_SYNC is implemented as __O_SYNC|O_DSYNC. As many places only
         * check for O_DSYNC if the need any syncing at all we enforce it's
         * always set instead of having to deal with possibly weird behaviour
         * for malicious applications setting only __O_SYNC.
         */
        if (flags & __O_SYNC)
                flags |= O_DSYNC;
{% endhighlight %}

å‡½æ•°ç»§ç»­æ£€æŸ¥æ‰“å¼€æ ‡æ˜¯å¦åŒ…å« __O_SYNC, åœ¨æœ‰çš„ä½“ç³»ä¸­ï¼Œå¯¹äºåŒæ­¥æ“ä½œï¼Œä¸€èˆ¬
ä½¿ç”¨ O_DSYNC, O_DSYNC è¡¨ç¤ºæ ¹æ®åŒæ­¥ I/O æ•°æ®å®Œæ•´æ€§çš„å®Œæˆè¦æ±‚æ¥æ‰§è¡Œæ–‡ä»¶
å†™æ“ä½œã€‚

{% highlight c %}
        if (flags & __O_TMPFILE) {
                if ((flags & O_TMPFILE_MASK) != O_TMPFILE)
                        return -EINVAL;
                if (!(acc_mode & MAY_WRITE))
                        return -EINVAL;
        } else if (flags & O_PATH) {
{% endhighlight %}

å‡½æ•°ç»§ç»­æ£€æŸ¥æ‰“å¼€æ ‡å¿—æ˜¯å¦åŒ…å« __O_TMPFILE, å³è¡¨ç¤ºç³»ç»Ÿæ˜¯å¦åˆ›å»ºä¸€ä¸ª
é›¶æ—¶æ–‡ä»¶ã€‚å¦‚æœåŒ…å«ï¼Œé‚£ä¹ˆæ–‡ä»¶ç³»ç»Ÿä¸­ä¼šåˆ›å»ºä¸€ä¸ªæ— åçš„ inodeï¼Œå½“
æœ€åä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¢«å…³é—­çš„æ—¶å€™ï¼Œæ‰€æœ‰å†™å…¥è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹éƒ½ä¼šä¸¢ å¤±
é™¤éåœ¨æ­¤ä¹‹å‰ç»™äº†å®ƒä¸€ä¸ªåå­—. æ­¤å¤„å‡½æ•°é¦–å…ˆåˆ¤æ–­æ‰“å¼€æ–‡ä»¶æ˜¯å¦åŒ…å«
__O_TMPFILE æ ‡å¿—ï¼Œå¦‚æœåŒ…å«ï¼Œå¦‚æœå‡½æ•°æ­¤æ—¶æ£€æŸ¥åˆ°æ‰“å¼€æ–‡ä»¶ä¸­ä¸åŒ…å«
O_TMPFILEï¼Œé‚£ä¹ˆç³»ç»Ÿå°±è¿”å› -EINVAL. ç”±äºç³»ç»Ÿéœ€è¦åˆ›å»ºä¸€ä¸ªé›¶æ—¶æ–‡ä»¶ï¼Œ
å› æ­¤æ–‡ä»¶æ¨¡å¼å¿…é¡»åŒ…å«å†™æƒé™ï¼Œå› æ­¤å‡½æ•°ç»§ç»­æ£€æŸ¥ acc_mode æ˜¯å¦åŒ…å«
äº† MAY_WRITE å†™æƒé™ï¼Œå¦‚æœä¸åŒ…å«ï¼Œå‡½æ•°ç›´æ¥è¿”å› -EINVAL.

{% highlight c %}
        } else if (flags & O_PATH) {
                /*
                 * If we have O_PATH in the open flag. Then we
                 * cannot have anything other than the below set of flags
                 */
                flags &= O_DIRECTORY | O_NOFOLLOW | O_PATH;
                acc_mode = 0;
        }
{% endhighlight %}

å¦‚æœæ­¤æ—¶å‡½æ•°æ‰“å¼€æ ‡å¿—ä¸­ä¸åŒ…å« __O_TMPFILE, é‚£ä¹ˆå‡½æ•°ç»§ç»­æ£€æŸ¥æ‰“å¼€
æ ‡å¿—æ˜¯å¦åŒ…å« O_PATH æ ‡å¿—ï¼ŒO_PATH æ ‡å¿—è¡¨ç¤ºè·å¾—ä¸€ä¸ªèƒ½è¡¨ç¤ºæ–‡ä»¶åœ¨æ–‡
ä»¶ç³»ç»Ÿä¸­ä½ç½®çš„æ–‡ä»¶æè¿°ç¬¦ã€‚é‚£ä¹ˆæ‰“å¼€æ ‡å¿—åªèƒ½åŒ…å« O_DIRECTORYã€O_PATH
å’Œ O_NOFOLLOW æ ‡å¿—ï¼Œå¹¶ä¸”è®¿é—®æ¨¡å¼è®¾ç½®ä¸º 0ï¼Œå³å¿½ç•¥è®¿é—®æ¨¡å¼ä¿¡æ¯ã€‚

{% highlight c %}
        op->open_flag = flags;

        /* O_TRUNC implies we need access checks for write permission */
        if (flags & O_TRUNC)
                acc_mode |= MAY_WRITE;
{% endhighlight %}

å‡½æ•°å°†å¤„ç†å¥½çš„æ‰“å¼€æ–‡ä»¶æ ‡å¿—å­˜å‚¨åœ¨ struct open_flags çš„ flag æˆå‘˜é‡Œã€‚
å‡½æ•°ç»§ç»­æ£€æŸ¥æ‰“å¼€æ ‡å¿—ä¸­æ˜¯å¦åŒ…å« O_TRUNC æ ‡å¿—ï¼Œè¯¥æ ‡å¿—è¡¨ç¤ºå¦‚æœæ–‡ä»¶å·²ç»
å­˜åœ¨ä¸”ä¸ºæ™®é€šæ–‡ä»¶ï¼Œé‚£ä¹ˆæ¸…ç©ºæ–‡ä»¶å†…å®¹ï¼Œå°†å…¶é•¿åº¦ç½®ä¸º 0. åœ¨ Linux ä¸‹ä½¿ç”¨
æ­¤æ ‡å¿—ï¼Œæ— è®ºä»¥è¯»ã€å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œéƒ½å¯æ¸…ç©ºæ–‡ä»¶ å†…å®¹ (åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ
éƒ½å¿…é¡»æ‹¥æœ‰å¯¹æ–‡ä»¶çš„å†™æƒé™), å› æ­¤åœ¨è®¿é—®æƒé™ä¸­æ·»åŠ å¯å†™æ ‡å¿— MAY_WRITE.

{% highlight c %}
        /* Allow the LSM permission hook to distinguish append
         * access from general write access.
         */
        if (flags & O_APPEND)
                acc_mode |= MAY_APPEND;

        op->acc_mode = acc_mode;
        op->intent = flags & O_PATH ? 0 : LOOKUP_OPEN;
{% endhighlight %}

å‡½æ•°ç»§ç»­åˆ¤æ–­æ‰“å¼€æ ‡å¿—ä¸­æ˜¯å¦åŒ…å« O_APPEND æ ‡å¿—ï¼Œå¦‚æœåŒ…å«ï¼Œé‚£ä¹ˆ
ç³»ç»Ÿè¿è¡Œä½¿ç”¨ hookï¼Œå¹¶åŠ å…¥ MAY_APPEND æ ‡å¿—ï¼Œä»¥æ­¤åŒºåˆ†æ­£å¸¸çš„æœ«å°¾
å†™æ“ä½œã€‚å‡½æ•°ç»§ç»­å°† acc_mode çš„å€¼å­˜å‚¨åˆ°åœ¨ struct open_flags ç»“æ„
çš„ acc_mode æˆå‘˜é‡Œã€‚å¦‚æœæ‰“å¼€æ–‡ä»¶åŒ…å«äº† O_PATH æ ‡å¿—ï¼Œé‚£ä¹ˆå‡½æ•°
å°±å°† struct open_flags çš„ intent è®¾ç½®ä¸º 0; åä¹‹è®¾ç½®ä¸º LOOKUP_OPEN
è¡¨ç¤ºæŸ¥æ‰¾çš„å†…å®¹æ˜¯æ–‡ä»¶è€Œä¸æ˜¯ç›®å½•ã€‚

{% highlight c %}
        if (flags & O_CREAT) {
                op->intent |= LOOKUP_CREATE;
                if (flags & O_EXCL)
                        op->intent |= LOOKUP_EXCL;
        }
{% endhighlight %}

å‡½æ•°å¦‚æœæ£€æŸ¥åˆ°æ–‡ä»¶æ‰“å¼€æ ‡å¿—ä¸­å«æœ‰ O_CREAT æ ‡å¿—ï¼Œé‚£ä¹ˆæ„å›¾æ˜¯å»åˆ›å»º
ä¸€ä¸ªæ–‡ä»¶ï¼Œå› æ­¤å‡½æ•°å°† LOOKUP_CREATE åŠ å…¥åˆ° struct open_flags çš„ 
intent æˆå‘˜é‡Œï¼Œå‘Šè¯‰ä½¿ç”¨è¯¥ç»“æ„ä½“çš„å‡½æ•°ï¼Œå†…æ ¸è¯•å›¾åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ã€‚å¦‚æœ
æ­¤æ—¶æ–‡ä»¶æ‰“å¼€æ ‡å¿—ä¸­è¿˜åŒ…å«äº† O_EXCL æ ‡å¿—ï¼Œé‚£ä¹ˆå‡½æ•°å°† LOOKUP_EXCL 
æ ‡å¿—ï¼Œä»¥æ­¤è¡¨ç¤ºå†…æ ¸è¯•å›¾åˆ›å»ºä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ã€‚

{% highlight c %}
        if (flags & O_DIRECTORY)
                lookup_flags |= LOOKUP_DIRECTORY;
        if (!(flags & O_NOFOLLOW))
                lookup_flags |= LOOKUP_FOLLOW;
        op->lookup_flags = lookup_flags;
        return 0;
{% endhighlight %}

å‡½æ•°æ¥ç€æ£€æŸ¥ flags æ˜¯å¦åŒ…å« O_DIRECTORY, å¦‚æœåŒ…å«ï¼Œé‚£ä¹ˆå‡½æ•°æ·»åŠ 
LOOKUP_DIRECTORY æ ‡å¿—ï¼Œä»¥æ­¤è¡¨ç¤ºå†…æ ¸è¯•å›¾æ‰¾åˆ°ä¸€ä¸ªç›®å½•ã€‚å‡½æ•°æ¥ç€
æ£€æŸ¥ flags ä¸­æ˜¯å¦åŒ…å« O_NOFOLLOW æ ‡å¿—ï¼Œå¦‚æœä¸åŒ…å«ï¼Œé‚£ä¹ˆå‡½æ•°æ·»åŠ 
LOOKUP_NOFOLLOW æ ‡å¿—ï¼Œä»¥æ­¤è¡¨ç¤ºç³»ç»Ÿæ­£åœ¨æŸ¥æ‰¾ä¸€ä¸ªé“¾æ¥æ–‡ä»¶ã€‚æœ€å
å°† lookup_flags æ”¶é›†åˆ°çš„ä¿¡æ¯å­˜å‚¨åˆ°äº† struct open_flags çš„ intent
æˆå‘˜é‡Œï¼Œæœ€åè¿”å› 0.

> - [æ–‡ä»¶æ‰“å¼€ç›¸å…³æ ‡å¿—è¯¦è§£](https://biscuitos.github.io/blog/open-flags/)

----------------------------------------------------













{% highlight c %}

{% endhighlight %}



----------------------------------

<span id="D0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L.jpg)

## Open è¿›é˜¶ç ”ç©¶

> - [Open æ‰“å¼€è·¯å¾„é•¿åº¦ç ”ç©¶](https://biscuitos.github.io/blog/open-namelen/)
>
> - [Open æ–‡ä»¶æ‰“å¼€æ ‡å¿—ã€æ–‡ä»¶æƒé™æ ‡å¿—ã€æŸ¥æ‰¾æ ‡å¿—ç ”ç©¶](https://biscuitos.github.io/blog/open-flags/)

-----------------------------------------------

# <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
