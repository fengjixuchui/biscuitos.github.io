---
layout: post
title:  "AT24C08"
date:   2019-10-13 13:17:30 +0800
categories: [HW]
excerpt: I2C AT24CXX.
tags:
  - LDD
---

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/IND00000I.jpg)

> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

## ç›®å½•

> - [AT24C08 ç®€ä»‹](#A00)
>
> - [å®è·µå‡†å¤‡](#A010)
>
> - [AT24C08 é©±åŠ¨](#A011)
>
>   - [AT24C08 é©±åŠ¨åˆ†æ](#B00)
>
>   - [AT24C08 BiscuitOS-RaspberryPi å®è·µéƒ¨ç½²](#B01)
>
>   - [AT24C08 å·¥ç¨‹å®è·µéƒ¨ç½²](#B02)
>
> - [AT24C08 å·¥å…·](#A012)
>
> - [AT24C08 åº”ç”¨ç¨‹åº](#A013)
>
>   - [AT24C08 æºç åˆ†æ](#B03)
>
>   - [AT24C08 BiscuitOS-RaspberryPi ä¸­ä½¿ç”¨](#B04)
>
>   - [AT24C08 å·¥ç¨‹å®è·µéƒ¨ç½²](#B05)
>
> - [AT24C08 ç¡¬ä»¶æµ‹è¯•](#A014)
>
>   - [AT24C08 è¯»å†™æµ‹è¯•](#B05)
>
>   - [AT24C08 å‹åŠ›æµ‹è¯•](#B06)
>
>   - [AT24C08 æ³¢å½¢åˆ†æ](#B07)
>
> - [AT24C08 è½¯ä»¶æµ‹è¯•](#A015)
>
>   - [AT24C08 è¯»å†™æµ‹è¯•](#B08)
>
>   - [AT24C08 å‹åŠ›æµ‹è¯•](#B09)
>
> - [AT24C08 åº”ç”¨](#A016)
>
> - [AT24C08 é—®é¢˜åˆé›†](#B10)
>
> - [é™„å½•](#A017)

------------------------------------------

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/IND00000A.jpg)

## <span id="A00">AT24C08 ç®€ä»‹</span>

AT24C08 æ˜¯ä¸€ä¸ªæä¾› 8192 bits çš„ä¸²è¡Œå¯æ“¦é™¤å’Œç¼–ç¨‹çš„åªè¯»å†…å­˜ (EEPROM),
å…¶åŒ…å«äº† 1024 ä¸ª 8 bit çš„å­—èŠ‚ã€‚AT24C08 é’ˆå¯¹è®¸å¤šå·¥ä¸šå’Œå•†ä¸šåº”ç”¨è¿›è¡Œäº†
ä¼˜åŒ–ï¼Œåœ¨è¿™äº›åº”ç”¨ä¸­ï¼Œä½åŠŸè€—å’Œä½ç”µå‹çš„ç‰¹å®šæ˜¾å¾—ç‰¹åˆ«çªå‡ºã€‚AT24C08 æä¾›èŠ‚çœ
ç©ºé—´çš„ 8-lead PDIPï¼Œ8-lead JEDEC SOICï¼Œ8-ball dBGA2, 8-leap MAP,
8-lead TSSOP, ä»¥åŠ 5-lead SOT23 å°è£…ã€‚AT24C08 æä¾›äº†æ ‡å‡†çš„ I2C æ¥å£ï¼Œ
å¯ä»¥é€šè¿‡ä¸¤çº¿çš„ I2C æ€»çº¿è®¿é—® AT24C08. AT24C08 æä¾›äº† 2.7V-5.5V çš„ç‰ˆæœ¬ï¼Œ
ä»¥åŠ 1.8V è‡³ 5.5V ç‰ˆæœ¬ã€‚AT24C08 Datasheet é“¾æ¥å¦‚ä¸‹ï¼š

> [AT24C08 Datasheet](https://github.com/BiscuitOS/Documentation/blob/master/Datasheet/I2C/AT24C08.pdf)

å¸‚é¢ä¸Šä¹Ÿæä¾›äº†å¾ˆè¿‡é’ˆå¯¹ AT24C08 çš„æ¨¡å—è®¾è®¡ï¼Œä¾‹å¦‚ä¸‹å›¾ï¼š

------------------------------------------

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/IND00000H.jpg)

## <span id="A10">å®è·µå‡†å¤‡</span>

BiscuitOS å·²ç»æ”¯æŒ AT24C08 çš„ç¡¬ä»¶å®è·µï¼Œä½†åœ¨å®è·µå‰éœ€è¦ä½œç›¸åº”çš„å‡†å¤‡ï¼Œ
å¿…é¡»è¦çš„å‡†å¤‡æœ‰ï¼š

RaspberryPi 4B å¼€å‘æ¿ä¸€å—

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000016.png)

AT24C08 æ¨¡å—æ¿ä¸€å—ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000017.jpg)

åŸºäº Linux 5.0 å†…æ ¸çš„ RaspberryPi 4B å¼€å‘ç¯å¢ƒï¼Œè¯·å‚è€ƒå¦‚ä¸‹æ–‡æ¡£
è¿›è¡Œæ­å»ºï¼š

> - [BiscuitOS RaspberryPi 4B ç¯å¢ƒéƒ¨ç½²]()

ç¤ºæ³¢å™¨ä»¥åŠé€»è¾‘åˆ†æä»ªä¸ºå¯é€‰å·¥å…·ï¼Œå¼€å‘è€…æ ¹æ®è‡ªèº«æƒ…å†µå‡†å¤‡ã€‚
æœ¬æ–‡ä½¿ç”¨ DSLogic é€»è¾‘åˆ†æä»ªå’Œ DSCope æ•°å­—ç¤ºæ³¢å™¨è¿›è¡Œæ•°æ®
åˆ†æå’Œæ³¢å½¢æŠ“å–ã€‚

DSLogic é€»è¾‘åˆ†æä»ªï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000012.jpg)

DSLogic é€»è¾‘åˆ†æä»ªæ•°æ®å·¥å…·ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000006.png)

DSCope æ•°å­—ç¤ºæ³¢å™¨ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000013.jpg)

DSCope æ•°å­—ç¤ºæ³¢å™¨æ•°æ®å·¥å…·ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000006.png)

------------------------------------------

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/IND00000T.jpg)

## <span id="A011">AT24C08 é©±åŠ¨</span>

BiscuitOS ä¸º AT24C08 æä¾›äº†å®Œæ•´çš„å†…æ ¸é©±åŠ¨æ”¯æŒï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒæœ¬èŠ‚
å†…å®¹ï¼Œå¯¹ AT24C08 è¿›è¡Œå®è·µéƒ¨ç½²ã€‚

> - [AT24C08 é©±åŠ¨åˆ†æ](#B00)
>
> - [AT24C08 BiscuitOS-RaspberryPi å®è·µéƒ¨ç½²](#B01)
>
> - [AT24C08 å·¥ç¨‹å®è·µéƒ¨ç½²](#B02)

------------------------------------------

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/IND00000W.jpg)

## <span id="B00">AT24C08 é©±åŠ¨åˆ†æ</span>

BiscuitOS å·²ç»æ”¯æŒæœ€æ–°çš„ AT24C08 èŠ¯ç‰‡ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨ BiscuitOS æä¾›
çš„é©±åŠ¨å¯¹ AT24C08 è¿›è¡Œä½¿ç”¨ï¼Œé©±åŠ¨æºç  GithuB åœ°å€å¦‚ä¸‹ï¼š

> - [AT24C08 EEPROM Device Driver for BiscuitOS](https://github.com/BiscuitOS/HardStack/tree/master/Device-Driver/i2c/Device/AT24C08/kernel)
>
> - [AT24C08 Datasheet](https://github.com/BiscuitOS/Documentation/blob/master/Datasheet/I2C/AT24C08.pdf)

BiscuitOS æä¾›çš„å®Œæ•´é©±åŠ¨å¦‚ä¸‹ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000018.png)

é©±åŠ¨åˆ†ä½œä¸‰ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯ AT24C08 è®¾å¤‡æ³¨å†Œåˆ°å¯¹åº”æ€»çº¿ä¸Šï¼›ç¬¬äºŒéƒ¨åˆ†æ˜¯ AT24C08
æä¾› EEPROM çš„è¯»å†™æ¥å£ï¼›ç¬¬ä¸‰éƒ¨åˆ†æ˜¯é©±åŠ¨å¯¹ EEPROM çš„ä½¿ç”¨ã€‚æ¥ä¸‹æ¥çš„å†…å®¹å°†è¯¦ç»†åˆ†æ
æ¯ä¸€éƒ¨åˆ†ä»£ç çš„æ„æˆã€‚

#### AT24C08 è®¾å¤‡æ³¨å†Œ

æ–°ç‰ˆæœ¬å†…æ ¸ä¸­ï¼ŒI2C å­ç³»ç»Ÿæä¾›äº†ä¸€å¥—ç®€å•çš„æ¥å£å°±å¯ä»¥å°†ä¸€ä¸ª I2C è®¾å¤‡
æ³¨å†Œåˆ° I2C å­ç³»ç»Ÿã€‚æœ¬ä¾‹ç¨‹é€šè¿‡å‘ DTS ä¸­æ·»åŠ  AT24C08ï¼Œå¹¶å°† AT24C08
æ³¨å†Œåˆ° I2C å­ç³»ç»Ÿã€‚é¦–å…ˆå¦‚ä¸‹å›¾ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000020.jpg)

å‡½æ•°é¦–å…ˆå®šä¹‰ä¸€ä¸ª struct i2c_driver ç»“æ„ä½“ï¼Œç„¶åå¡«å……è¯¥ç»“æ„ä½“ã€‚ç»“æ„ä½“ä¸­æä¾›äº†
driver æˆå‘˜ï¼Œåœ¨ AT24C08 ä¸­éœ€è¦æä¾› name, owner, ä»¥åŠ of_match_table ä¸‰ä¸ª
æˆå‘˜ï¼Œå…¶ä¸­ of_match_table æ˜¯ä¸€ä¸ª struct of_device_id ç»“æ„ï¼Œè¯¥ç»“æ„ç”¨äºä¸ DTS
ä¸­çš„èŠ‚ç‚¹ compatible å±æ€§è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœç›¸åŒï¼Œå³ä» DTS ä¸­æ‰¾åˆ°é©±åŠ¨å¯¹åº”çš„èŠ‚ç‚¹ï¼Œ
ä¾‹å¦‚åœ¨æœ¬ä¾‹ç¨‹ä¸­ï¼Œcompatible å±æ€§çš„å±æ€§å€¼æ˜¯ "BiscuitOS,at24c08"; name æˆå‘˜å¿…é¡»
ä¸ struct i2c_device_id ç»“æ„çš„ name æˆå‘˜ç›¸åŒï¼Œå³æ€»çº¿ä¸Šçš„é©±åŠ¨å’Œè®¾å¤‡é€šè¿‡åå­—è¿›è¡Œ
åŒ¹é…ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­å³ at24c08_id ç»“æœçš„ name è®¾ç½®çš„ä¸ at24c08_driver ç»“æ„çš„
driver æˆå‘˜çš„ name ä¸€è‡´ï¼›è‡³äº owner æˆå‘˜ï¼Œç”±äºé©±åŠ¨ä»¥æ¨¡å—çš„å½¢å¼æ·»åŠ åˆ°å†…æ ¸ï¼Œé‚£ä¹ˆ
owner è®¾ç½®ä¸º THIS_MODULE å°±è¡Œã€‚æœ€åæä¾› I2C è®¾å¤‡éœ€è¦çš„ probe å’Œ remove æ¥å£ã€‚

ä»¥ä¸Šå°±æ˜¯ç®€å•çš„é©±åŠ¨ç«¯ç¨‹åºè®¾ç½®ï¼Œè®¾ç½®å®Œæ¯•ä¹‹åè°ƒç”¨ module_i2c_driver() å‡½æ•°
å°† at24c08_driver å¯¹åº”çš„é©±åŠ¨æ³¨å†Œåˆ° I2C å­ç³»ç»Ÿä¸Šã€‚æä¾›é©±åŠ¨ä»£ç è¿˜ä¸èƒ½è®©é©±åŠ¨
æ­£å¸¸çš„å·¥ä½œï¼Œè¿˜éœ€ DTS ä¸­æ·»åŠ  at24c08 å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹ã€‚å¼€å‘è€…å¯ä»¥å‚è€ƒ BiscuitOS
æä¾›çš„ RaspberryPi 4B é¡¹ç›®çš„æ–¹æ³•è¿›è¡Œæ·»åŠ ã€‚åœ¨ RaspberryPi 4B ä¸­ï¼ŒDTS ä½äº
å†…æ ¸æºç  arch/arm/boot/dts/bcm2711-rpi-4-b.dts, æ·»åŠ å¦‚ä¸‹ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000021.png)

åœ¨ä¸Šé¢çš„ DTS æ–‡ä»¶ä¸­ï¼ŒèŠ‚ç‚¹åå­—ä¸º at24c08ï¼Œä¸é©±åŠ¨ä¸­çš„ struct i2c_device_id
name æˆå‘˜ç›¸åŒã€‚ç‰¹åˆ«å€¼å¾—æ³¨æ„çš„æ˜¯èŠ‚ç‚¹ reg å±æ€§å€¼å¿…é¡»ä¸èŠ‚ç‚¹åå­— @ ç¬¦å·åé¢çš„æ•°å­—
ç›¸åŒï¼Œè¿™ç¬¦åˆ DTS è¯­æ³•ã€‚reg å±æ€§å³ AT24C08 I2C çš„ä»è®¾å¤‡åœ°å€ã€‚èŠ‚ç‚¹çš„ compatible
å±æ€§å€¼å¿…é¡»ä¸é©±åŠ¨çš„ struct of_device_id ä¸€è‡´ã€‚é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œç³»ç»Ÿå¯åŠ¨åå¯ä»¥
å‘ç³»ç»Ÿæ³¨å†Œä¸€ä¸ªç®€å•çš„ AT24C08 æ¨¡å—ã€‚

#### AT24C08 I2C æ¥å£

é€šè¿‡ AT24C08 çš„æ•°æ®æ‰‹å†Œå¯ä»¥çŸ¥é“ï¼ŒAT24C08 æä¾›äº†ä¸‰ç§æ–¹å¼çš„è¯»ï¼ŒåŒ…æ‹¬éšæœºåœ°å€è¯»æ“ä½œï¼Œ
è¿ç»­è¯»æ“ä½œï¼Œä»¥åŠå½“å‰åœ°å€è¯»æ“ä½œã€‚AT24C08 ä¹Ÿæä¾›äº†ä¸¤ç§æ–¹å¼çš„å†™ï¼ŒåŒ…æ‹¬æŒ‰å­—èŠ‚å†™ï¼Œä»¥åŠ
æŒ‰é¡µå†™æ“ä½œã€‚æ¥ä¸‹é‡Œåˆ†åˆ«ä»‹ç»æ¯ç§æ“ä½œå¦‚ä½•ç¼–å†™ä»£ç ã€‚

###### AT24C08 éšæœºåœ°å€è¯»æ“ä½œ

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000022.png)

ä¸Šå›¾ä¸º AT24C08 å®šä¹‰çš„ Random Read æ“ä½œçš„ I2C æ—¶åºå›¾ï¼Œåˆ†æä¸Šå›¾æ—¶åºå›¾ï¼Œå¯ä»¥
è¯»å‡ºç®€å•çš„è¯»å†™è§„åˆ™ï¼šåœ¨ SDA ä¿¡å·çº¿ä¸Šäº§ç”Ÿä¸€ä¸ª START æ¡ä»¶ä¹‹åï¼ŒAT24C08 åœ¨ä¸€ä¸ª
I2C Message å‘¨æœŸå†…å°†å°† AT24C08 çš„ä»è®¾å¤‡åœ°å€å’Œè¯»åœ°å€å†™å…¥åˆ° I2C æ€»çº¿ä¸Šï¼Œåœ¨
è¿™ä¸ªå‘¨æœŸä¸­ï¼ŒI2C æ§åˆ¶å™¨å‘ I2C æ€»çº¿ä¸ŠæŒ‰ MSB åˆ° LSB çš„æ–¹å¼ï¼Œå‘é€ä»è®¾å¤‡åœ°å€åˆ°
I2C æ€»çº¿ä¸Šï¼Œå ç”¨äº† 7 ä¸ª SCL å‘¨æœŸï¼Œæ¥ä¸‹æ¥æ˜¯ä¸€ä¸ª bit ä»£è¡¨ R/W ä¿¡å·ï¼Œæ­¤æ—¶ I2C
ä¸»æ§å‘é€ä¸€ä¸ªä½ç”µå¹³ï¼Œä»¥æ­¤ä»£è¡¨è¿™æ¬¡æ˜¯ä¸€ä¸ªå†™æ“ä½œã€‚æ“ä½œå®Œæ¯•ä¹‹åï¼Œç­‰å¾…ä»è®¾å¤‡çš„ ACKï¼Œ
å¦‚æœ ACK æ²¡æœ‰å›åº”ï¼Œé‚£ä¹ˆä¸»æ§äº§ç”Ÿä¸€ä¸ª STOP æ¡ä»¶ï¼Œåœæ­¢ä¼ è¾“ï¼›å¦‚æœä»è®¾å¤‡ ACK åº”ç­”ï¼Œ
é‚£ä¹ˆ I2C ä¸»æ§ç»§ç»­å°†è¯»åœ°å€æŒ‰ MSB åˆ° LSB çš„æ–¹å‘å†™åˆ° I2C æ€»çº¿ä¸Šï¼Œå†™å®Œçš„ç¬¬ä¹ä¸ªå‘¨æœŸï¼Œ
å¦‚æœä»è®¾å¤‡æ²¡æœ‰åº”ç­”ï¼Œé‚£ä¹ˆæ“ä½œå¤±è´¥ï¼›å¦‚æœä»è®¾å¤‡å›åº”ï¼Œé‚£ä¹ˆä»è®¾å¤‡ä¼šäº§ç”Ÿä¸€ä¸ªä½ç”µå¹³å°†
I2C æ€»çº¿åœ¨è¿™ä¸ªå‘¨æœŸå†…æ‹‰ä½ï¼Œæ­¤æ—¶ä¸»æ§æ”¶åˆ°è¿™ä¸ª ACK ä¹‹åï¼Œä¸»æ§å°†ç‹¬ç«‹äº§ç”Ÿä¸€ä¸ª START
æ¡ä»¶ï¼Œç´§éšå…¶åçš„ä»è®¾å¤‡åœ°å€ï¼ŒæŒ‰ MSB åˆ° LSB çš„æ–¹å‘å†™åˆ° I2C æ€»çº¿ä¸Šï¼Œä»åœ°å€å†™å®Œçš„
ä¸‹ä¸€ä¸ªå‘¨æœŸï¼Œä¸»æ§äº§ç”Ÿä¸€ä¸ªé«˜ç”µå¹³ï¼Œä»¥æ­¤è¡¨ç¤ºæ­¤æ—¶æ“ä½œæ˜¯ READ æ“ä½œã€‚ä¹‹åä¸»æ§ç­‰å¾…ä»
è®¾å¤‡çš„ ACKï¼Œä»è®¾å¤‡å¦‚æœåº”ç­”ï¼Œé‚£ä¹ˆä¼šå°† I2C æ€»çº¿æ‹‰ä½ï¼Œå¹¶å°† 8-bit çš„æ•°æ®å†™åˆ°æ€»çº¿
ä¸Šï¼Œä¸»æ§æ¥æ”¶åˆ°ä»¥ä¸Šä¿¡å·åï¼Œè‡ªåŠ¨å°†è¿™ 8-bit æŠ“å–ä¸‹æ¥ï¼Œä»¥æ­¤ä½œä¸ºè¯»åˆ°çš„æ•°æ®ã€‚æœ€å
ä»è®¾å¤‡ä¸åº”ç­”ï¼Œæ‰€ä»¥ä¸»æ§äº§ç”Ÿä¸€ä¸ª STOP æ¡ä»¶ã€‚å¦‚æœä»¥ä¸Šæ“ä½œå®Œæˆï¼Œé‚£ä¹ˆä¸€ä¸ª
Random Read æ“ä½œå°±ç®—å®Œæˆã€‚ç”±äºç¬¬ä¸€ä¸ª I2C Message çš„ R/W å‘¨æœŸä¸ºä½ï¼Œä¸ºå†™æ“ä½œï¼Œ
å› æ­¤ç§°è¯¥ I2C message å‘¨æœŸä¸º DUMMY WRITEã€‚

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000027.png)

ä¸Šå›¾å³æ˜¯æ ¹æ®ä¿¡å·åè®®ç¼–å†™çš„ Random Readã€‚åœ¨å†…æ ¸ä¸­ï¼ŒI2C å­ç³»ç»Ÿå®šä¹‰äº†
struct i2c_msg ç»“æ„ä¸ºä¸€ä¸ª I2C å¸§ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

{% highlight c %}
struct i2c_msg {
        __u16 addr;     /* slave address                        */
        __u16 flags;
#define I2C_M_RD                0x0001  /* read data, from slave to master */
                                        /* I2C_M_RD is guaranteed to be 0x0001! */
#define I2C_M_TEN               0x0010  /* this is a ten bit chip address */
#define I2C_M_DMA_SAFE          0x0200  /* the buffer of this message is DMA safe */
                                        /* makes only sense in kernelspace */
                                        /* userspace buffers are copied anyway */
#define I2C_M_RECV_LEN          0x0400  /* length will be first received byte */
#define I2C_M_NO_RD_ACK         0x0800  /* if I2C_FUNC_PROTOCOL_MANGLING */
#define I2C_M_IGNORE_NAK        0x1000  /* if I2C_FUNC_PROTOCOL_MANGLING */
#define I2C_M_REV_DIR_ADDR      0x2000  /* if I2C_FUNC_PROTOCOL_MANGLING */
#define I2C_M_NOSTART           0x4000  /* if I2C_FUNC_NOSTART */
#define I2C_M_STOP              0x8000  /* if I2C_FUNC_PROTOCOL_MANGLING */
        __u16 len;              /* msg length                           */
        __u8 *buf;              /* pointer to msg data                  */
};
{% endhighlight %}

æ ¹æ® Random Read çš„ä¿¡å·å®šä¹‰ï¼Œåœ¨ä»£ç ä¸­é¦–å…ˆå®šä¹‰ä¸¤ä¸ª i2c_msg ç»“æ„ä½“ï¼Œ
ç¬¬ä¸€ä¸ª i2c_msg ç”¨äºç”Ÿæˆ Dummy Write å¸§ï¼Œi2c_msg çš„ addr æˆå‘˜å¯¹åº”
Random Read ä¿¡å·çš„ Device Addressï¼Œå…¶å€¼è®¾ç½®ä¸º client->addr, å³
AT24C08 çš„ä»è®¾å¤‡åœ°å€ï¼›æ¥ä¸‹æ¥è®¾ç½® i2c_msg çš„ flags æˆå‘˜ï¼Œæ­¤æ—¶ä¸
åŒ…æ‹¬ I2C_M_RD å®ï¼Œæ­¤æ¬¡äº§ç”Ÿ Random Read çš„ R/D å‘¨æœŸçš„ä½ç”µå¹³ï¼›i2c_msg
çš„ len æˆå‘˜è¡¨ç¤º I2C msg çš„é•¿åº¦ï¼Œç”± Random Read çš„ Dummy Write
å®šä¹‰å¯ä»¥çŸ¥é“ï¼Œå…¶ååªç”¨è·Ÿéšä¸€ä¸ª 8-bit çš„è¯»åœ°å€ï¼Œå› æ­¤ i2c_msg çš„ len
è®¾ç½®ä¸º 1ï¼Œå¹¶ä¸” buf æˆå‘˜å°±æ˜¯æŒ‡å‘è¯»åœ°å€ã€‚

ç¬¬äºŒä¸ª i2c_msg ç”¨äºä¸»æ§åœ¨è·å¾—ä»è®¾å¤‡çš„ ACK ä¹‹åä» I2C æ€»çº¿è¯»å–ä¸€ä¸ª
å­—èŠ‚çš„æ•°æ®ã€‚æ ¹æ® Random Read çš„å®šä¹‰å¯ä»¥çŸ¥é“ï¼Œå½“ dummy write å¸§å‘é€
å®Œæ¯•ä¹‹åï¼Œä»è®¾å¤‡åº”ç­”ï¼Œé‚£ä¹ˆä¸»æ§ä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ª START æ¡ä»¶ï¼Œéšåè·Ÿéš
ä¸€ä¸ª AT24C08 çš„ä»è®¾å¤‡åœ°å€ï¼Œå› æ­¤ç¬¬äºŒä¸ª i2c_msg çš„ addr åŒæ ·æŒ‡å‘
AT24C08 çš„åœ°å€ï¼Œå³ client->addr; æ­¤æ—¶å‘ I2C æ€»çº¿å‘é€å®Œ Device
Address ä¹‹åï¼Œä¸»æ§éœ€è¦äº§ç”Ÿä¸€ä¸ªé«˜ç”µå¹³ï¼Œå› æ­¤æ­¤æ—¶éœ€è¦å°† i2c_msg çš„
flags è®¾ç½®ä¸º I2C_M_RD, æ¥ç€ä¸»æ§ä¼šä»æ€»çº¿ä¸Šè·å¾—ä»è®¾å¤‡çš„åº”ç­”ä¿¡å·ï¼Œ
é‚£ä¹ˆä»æ€»çº¿ä¸Šå°† 8bit çš„æ•°æ®å­˜å‚¨åœ¨ i2c_msg çš„ buf æˆå‘˜é‡Œï¼Œå› æ­¤
i2c_msg çš„ len æˆå‘˜è®¾ç½®ä¸º 1ï¼Œå¹¶ä¸” buf æŒ‡å‘å­˜å‚¨çš„ä½ç½®ã€‚

ä»¥ä¸Šå‡†å¤‡å¥½ i2c_msg ä¹‹åï¼Œç»§ç»­è°ƒç”¨ i2c_transfer() å‡½æ•°ï¼Œå°† i2c_msg
ä¼ é€’ç»™ I2C æ ¸å¿ƒå±‚ï¼Œæœ€ç»ˆåˆ°è¾¾ I2C æ§åˆ¶å™¨çš„æ”¶å‘å™¨ä¸Šå‘é€ã€‚æ¥ä¸‹æ¥ä½¿ç”¨
ç¤ºæ³¢å™¨å’Œé€»è¾‘åˆ†æä»ªå®é™…çš„æŠ“èµ·æ³¢å½¢åˆ†æï¼Œå…·ä½“å¦‚ä¸‹ï¼š

--------------------------------------------

###### AT24C08 è¿ç»­è¯»æ“ä½œ

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000023.png)

ä¸Šå›¾ä¸º AT24C08 å®šä¹‰çš„ Sequential Read æ“ä½œçš„ I2C æ—¶åºå›¾ï¼Œåˆ†æä¸Šå›¾æ—¶åºå›¾ï¼Œå¯ä»¥
è¯»å‡ºç®€å•çš„è¯»å†™è§„åˆ™ï¼šè¿ç»­è¯»æ“ä½œçš„å‰éƒ¨æ“ä½œå’Œ Random Read ä¸€è‡´ï¼Œåªæ˜¯è¿ç»­è¯»ä» AT24C08
ä¸Šè¿ç»­è¯»å¤šä¸ªï¼Œæ¯è¯»ä¸€ä¸ªæ•°æ®ï¼Œä¸»æ§éƒ½ä¼šäº§ç”Ÿä¸€ä¸ª ACKï¼Œä»è®¾å¤‡æ¥æ”¶åˆ° ACK ä¹‹åï¼Œå°±ä¼šå‘æ€»çº¿
ä¸Šå‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®ã€‚ä¸»æ§åœ¨è¯»å®Œæ•°æ®ä¹‹åï¼Œå°±ä¸ä¼šäº§ç”Ÿ ACKï¼Œé‚£ä¹ˆä»è®¾å¤‡ä¹Ÿä¸ä¼šå‘æ€»çº¿å‘é€
æ•°æ®ï¼Œæœ€ç»ˆä¸»æ§äº§ç”Ÿä¸€ä¸ª STOP æ¡ä»¶ï¼Œæ­¤æ—¶è¿ç»­è¯»æ“ä½œå®Œæ¯•ã€‚å¦‚æœè¿ç»­è¯»çš„åœ°å€è¶…è¿‡äº† AT24C08
æœ€å¤§åœ°å€ï¼Œé‚£ä¹ˆ AT24C08 ä¼šé‡æ–°è¿”å›åˆ° 0 åœ°å€å¼€å§‹ç»§ç»­ä¼ è¾“æ•°æ®ã€‚

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000028.png)

ä¸Šå›¾å³æ˜¯æ ¹æ®ä¿¡å·åè®®ç¼–å†™çš„ Sequential Readã€‚åœ¨å†…æ ¸ä¸­ï¼ŒI2C å­ç³»ç»Ÿå®šä¹‰äº†
struct i2c_msg ç»“æ„ä¸ºä¸€ä¸ª I2C å¸§ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

{% highlight c %}
struct i2c_msg {
        __u16 addr;     /* slave address                        */
        __u16 flags;
#define I2C_M_RD                0x0001  /* read data, from slave to master */
                                        /* I2C_M_RD is guaranteed to be 0x0001! */
#define I2C_M_TEN               0x0010  /* this is a ten bit chip address */
#define I2C_M_DMA_SAFE          0x0200  /* the buffer of this message is DMA safe */
                                        /* makes only sense in kernelspace */
                                        /* userspace buffers are copied anyway */
#define I2C_M_RECV_LEN          0x0400  /* length will be first received byte */
#define I2C_M_NO_RD_ACK         0x0800  /* if I2C_FUNC_PROTOCOL_MANGLING */
#define I2C_M_IGNORE_NAK        0x1000  /* if I2C_FUNC_PROTOCOL_MANGLING */
#define I2C_M_REV_DIR_ADDR      0x2000  /* if I2C_FUNC_PROTOCOL_MANGLING */
#define I2C_M_NOSTART           0x4000  /* if I2C_FUNC_NOSTART */
#define I2C_M_STOP              0x8000  /* if I2C_FUNC_PROTOCOL_MANGLING */
        __u16 len;              /* msg length                           */
        __u8 *buf;              /* pointer to msg data                  */
};
{% endhighlight %}

æ ¹æ® Sequential Read çš„ä¿¡å·å®šä¹‰ï¼Œç¬¬ä¸€ä¸ª i2c_msg ä¸ Random Readï¼Œ
æˆ– Current Address Read ä¸€è‡´ï¼Œéƒ½æ˜¯ä¼ é€’ Device Address ä¸è¯»åœ°å€ï¼Œ
æˆ–è€…åªä¼  Device Addressï¼Œå› æ­¤ i2c_msg åªç”¨å°† AT24C08 çš„ä»è®¾å¤‡åœ°å€
å†™å…¥åˆ° i2c_msg addr æˆå‘˜é‡Œï¼Œç”±äº R/D å‘¨æœŸä¸ºä½ç”µå¹³ï¼Œå› æ­¤ i2c_msg çš„
flags ä¸ç”¨æ·»åŠ  I2C_M_RDï¼›å¦‚æœæ˜¯ Dummy Readï¼Œé‚£ä¹ˆéœ€è¦ä¼ é€’è¯»åœ°å€ï¼Œè¯¥
åœ°å€å ç”¨ 8bitï¼Œå› æ­¤ i2c_msg çš„ len æˆå‘˜è®¾ç½®ä¸º 1ï¼Œå¹¶ä¸” buf æˆå‘˜æŒ‡å‘
offsetã€‚

ç¬¬äºŒä¸ª i2c_msg ç”¨äºä¸»æ§åœ¨è·å¾—ä»è®¾å¤‡çš„ ACK ä¹‹åä» I2C æ€»çº¿è¯»å–å¤šä¸ª
å­—èŠ‚çš„æ•°æ®ï¼Œæ¯ä¸ªæ•°æ®å ç”¨ä¸€ä¸ªå­—èŠ‚ã€‚æ ¹æ® Random Read çš„å®šä¹‰å¯ä»¥çŸ¥é“ï¼Œ
å½“ dummy write å¸§å‘é€å®Œæ¯•ä¹‹åï¼Œä»è®¾å¤‡åº”ç­”ï¼Œé‚£ä¹ˆä¸»æ§ä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ª
START æ¡ä»¶ï¼Œéšåè·Ÿéšä¸€ä¸ª AT24C08 çš„ä»è®¾å¤‡åœ°å€ï¼Œå› æ­¤ç¬¬äºŒä¸ª i2c_msg çš„
addr åŒæ ·æŒ‡å‘ AT24C08 çš„åœ°å€ï¼Œå³ client->addr; ç”±äºä¸»æ§éœ€è¦è¯»å–å¤šä¸ª
å­—èŠ‚ï¼Œé‚£ä¹ˆå°† i2c_msg çš„ len è®¾ç½®ä¸º n ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”ä½¿ç”¨ buf æŒ‡å‘å­˜å‚¨
æ•°æ®çš„ä½ç½®ã€‚

ä»¥ä¸Šå‡†å¤‡å¥½ i2c_msg ä¹‹åï¼Œç»§ç»­è°ƒç”¨ i2c_transfer() å‡½æ•°ï¼Œå°† i2c_msg
ä¼ é€’ç»™ I2C æ ¸å¿ƒå±‚ï¼Œæœ€ç»ˆåˆ°è¾¾ I2C æ§åˆ¶å™¨çš„æ”¶å‘å™¨ä¸Šå‘é€ã€‚æ¥ä¸‹æ¥ä½¿ç”¨
ç¤ºæ³¢å™¨å’Œé€»è¾‘åˆ†æä»ªå®é™…çš„æŠ“èµ·æ³¢å½¢åˆ†æï¼Œå…·ä½“å¦‚ä¸‹ï¼š

----------------------------------------

###### AT24C08 å½“å‰åœ°å€è¯»æ“ä½œ

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000024.png)

ä¸Šå›¾ä¸º AT24C08 å®šä¹‰çš„ Current Address Read æ“ä½œçš„ I2C æ—¶åºå›¾ï¼Œåˆ†æä¸Šå›¾æ—¶åºå›¾ï¼Œå¯ä»¥
è¯»å‡ºç®€å•çš„è¯»å†™è§„åˆ™ï¼šä¸»æ§åœ¨è·å¾— START æ¡ä»¶ä¹‹åï¼Œåªéœ€æŒ‰ MSB åˆ° LSB çš„æ–¹å‘å‘é€ä»
è®¾å¤‡çš„åœ°å€ï¼Œå¹¶ä¸” R/D å‘¨æœŸä¸»æ§äº§ç”Ÿä¸€ä¸ªé«˜ç”µå¹³ã€‚å¦‚æœæ­¤æ—¶ä»è®¾å¤‡åº”ç­”ï¼Œé‚£ä¹ˆä¸»æ§å°±ä»
I2C æ€»çº¿ä¸Šè¯»å– 8bit æˆ–è€…æ›´å¤š (Sequential Read)ï¼Œè¯»å®Œæ¯•ä¹‹åï¼Œä¸»æ§ä¸»åŠ¨åœ¨ ACK
å‘¨æœŸäº§ç”Ÿä¸€ä¸ªé«˜ç”µå¹³ï¼Œå› æ­¤å‘Šè¯‰ä»è®¾å¤‡è¯»æ“ä½œå®Œæ¯•ï¼Œéšåäº§ç”Ÿä¸€ä¸ª STOP æ¡ä»¶ã€‚

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000029.png)

ä¸Šå›¾å³æ˜¯æ ¹æ®ä¿¡å·åè®®ç¼–å†™çš„ Current Address Readã€‚åœ¨å†…æ ¸ä¸­ï¼ŒI2C å­ç³»ç»Ÿå®šä¹‰äº†
struct i2c_msg ç»“æ„ä¸ºä¸€ä¸ª I2C å¸§ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

{% highlight c %}
struct i2c_msg {
        __u16 addr;     /* slave address                        */
        __u16 flags;
#define I2C_M_RD                0x0001  /* read data, from slave to master */
                                        /* I2C_M_RD is guaranteed to be 0x0001! */
#define I2C_M_TEN               0x0010  /* this is a ten bit chip address */
#define I2C_M_DMA_SAFE          0x0200  /* the buffer of this message is DMA safe */
                                        /* makes only sense in kernelspace */
                                        /* userspace buffers are copied anyway */
#define I2C_M_RECV_LEN          0x0400  /* length will be first received byte */
#define I2C_M_NO_RD_ACK         0x0800  /* if I2C_FUNC_PROTOCOL_MANGLING */
#define I2C_M_IGNORE_NAK        0x1000  /* if I2C_FUNC_PROTOCOL_MANGLING */
#define I2C_M_REV_DIR_ADDR      0x2000  /* if I2C_FUNC_PROTOCOL_MANGLING */
#define I2C_M_NOSTART           0x4000  /* if I2C_FUNC_NOSTART */
#define I2C_M_STOP              0x8000  /* if I2C_FUNC_PROTOCOL_MANGLING */
        __u16 len;              /* msg length                           */
        __u8 *buf;              /* pointer to msg data                  */
};
{% endhighlight %}

AT24C08 æ”¯æŒå½“å‰åœ°å€è¯»ï¼Œä¹Ÿå°±æ˜¯åœ¨ AT24C08 å†…éƒ¨æœ‰ä¸€ä¸ªåœ°å€è®¡æ•°å™¨ï¼Œè¯¥
å¯„å­˜å™¨ä¼šé”å­˜ä¸Šä¸€ä¸ªæ¬¡è¯»å†™åœ°å€åŠ ä¸Š 1 çš„åœ°å€ï¼Œå› æ­¤åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œä¸»æ§åªéœ€å‘
ä»è®¾å¤‡å‘é€éœ€è¦è¯»çš„åœ°å€å°±å¯ä»¥è¯»å–å¯¹åº”çš„å€¼ã€‚å› æ­¤ä¸€ä¸ª i2c_msg å°±æ»¡è¶³éœ€æ±‚ã€‚
åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œé¦–å…ˆä¹Ÿæ˜¯å‘ I2C æ€»çº¿ä¸Šä¼ è¾“ä»è®¾å¤‡çš„åœ°å€ï¼Œå› æ­¤ i2c_msg çš„
addr å€¼ä¸º client->addr ä¹Ÿå°±æ˜¯ AT24C08 çš„ä»è®¾å¤‡åœ°å€ï¼ŒR/D å‘¨æœŸä¸»æ§
å°†ç”µå¹³æ‹‰ä½ï¼Œå¹¶åœ¨ ACK å‘¨æœŸäº§ç”Ÿä¸€ä¸ªä½ç”µå¹³ï¼Œå› æ­¤ i2c_msg çš„ flags æ·»åŠ 
I2C_M_RD è¡¨ç¤ºã€‚ç”±äºåªéœ€ä¼ é€’ 8bit çš„è¯»åœ°å€ï¼Œå› æ­¤ i2c_msg len ä¸º 1ï¼Œ
ä¸” buf æŒ‡å‘ offsetã€‚

ä»¥ä¸Šå‡†å¤‡å¥½ i2c_msg ä¹‹åï¼Œç»§ç»­è°ƒç”¨ i2c_transfer() å‡½æ•°ï¼Œå°† i2c_msg
ä¼ é€’ç»™ I2C æ ¸å¿ƒå±‚ï¼Œæœ€ç»ˆåˆ°è¾¾ I2C æ§åˆ¶å™¨çš„æ”¶å‘å™¨ä¸Šå‘é€ã€‚æ¥ä¸‹æ¥ä½¿ç”¨
ç¤ºæ³¢å™¨å’Œé€»è¾‘åˆ†æä»ªå®é™…çš„æŠ“èµ·æ³¢å½¢åˆ†æï¼Œå…·ä½“å¦‚ä¸‹ï¼š


------------------------------------------

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/IND00000E.jpg)

## <span id="B10">AT24C08 é—®é¢˜åˆé›†</span>

> - [I2C æ€»çº¿æ— æ³•æ‰¾åˆ° AT24C08](#C00)

----------------------------------------------

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/IND00000K.jpg)

## <span id="C00">I2C æ€»çº¿æ— æ³•æ‰¾åˆ° AT24C08</span>

å°† AT24C08 è¿æ¥åˆ° RPI-4B çš„ I2C-1 æ€»çº¿ä¸Šï¼Œå…·ä½“è¿æ¥å¦‚ä¸‹å›¾ï¼ŒAT24C08
æ¨¡å— VCC è¿æ¥åˆ° RPI-4B 1 å·è„š VCCï¼›GND è¿æ¥åˆ° RPI-4B 9 å·è„šï¼›SDL è¿æ¥åˆ°
RPI-4B 5 å·è„šï¼›SDA è¿æ¥åˆ° RPI-4B 3 å·è„šã€‚

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000008.png)

æ¥ç€åœ¨ RPI-4B ä¸Šï¼ŒI2C æ€»çº¿æ³¨å†Œä½¿ç”¨çš„æ˜¯ /dev/i2c-1, æ­¤æ—¶ä½¿ç”¨ BiscuitOS
ç³»ç»Ÿä¸Šè‡ªå¸¦çš„å·¥å…· i2cdetect å¯¹ I2C-1 æ€»çº¿è¿›è¡Œ detect æ“ä½œï¼Œè¿è¡Œ
ç»“æœå¦‚ä¸‹ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000009.png)

ä»ç»“æœå¯ä»¥çœ‹å‡º i2cdetect å·¥å…·å¹¶æœªåœ¨ I2C-1 æ€»çº¿ä¸Šæ‰¾åˆ°ä»»ä½•ä»è®¾å¤‡ã€‚
æ¥ç€ä½¿ç”¨æµ‹è¯•ç¨‹åºå¯¹ AT24C08 è¿›è¡Œè¯»æ“ä½œï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

> - [æµ‹è¯•ä»£ç  Github ä½ç½®](https://github.com/BiscuitOS/HardStack/tree/master/Device-Driver/i2c/Error/Detect/userland)

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000010.png)

åŸºäºä¸Šé¢çš„ä»£ç ï¼Œä½¿ç”¨ DSCope ç¤ºæ³¢å™¨å¯¹ SDL å’Œ SDA ä¿¡å·è¿›è¡ŒæŠ“å–ï¼Œæ›´å¤š
DSCope çš„ä½¿ç”¨è¯·å‚é˜…ä¸‹é¢æ–‡æ¡£ï¼š

> - [DSCope ç”¨æˆ·æ‰‹å†Œ]()

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000013.jpg)

åœ¨æŠ“å–æ³¢å½¢ä¹‹å‰ï¼Œå…ˆåˆ†æä¸€ä¸‹ AT24C08 I2C è¯»æ“ä½œçš„ä¿¡å·å®šä¹‰ï¼ŒAT24C08 æ•°æ®æ‰‹å†Œ
è¯·å‚é˜…ï¼š

> - [AT24C08 EEPROM](https://github.com/BiscuitOS/Documentation/blob/master/Datasheet/I2C/AT24C08.pdf)

å…¶ä¸­å¯¹åº”è¯»æ“ä½œï¼Œä»£ç ä¸­ä½¿ç”¨çš„æ˜¯ AT24C98 çš„ Random Readï¼Œå…¶ä¿¡å·å®šä¹‰å¦‚ä¸‹ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000014.png)

åœ¨ AT24C08 çš„ Random Read ä¿¡å·ä¸­ï¼Œé¦–å…ˆæ˜¯ START ä¿¡å·ï¼Œè¯¥ä¿¡å·æ˜¯ SDA é¦–å…ˆäº§ç”Ÿ
ä¸€ä¸ªä¸‹é™æ²¿ï¼Œå¦‚æœæ­¤æ—¶ SCL ä»»å¤„äºé«˜ç”µå¹³ï¼Œé‚£ä¹ˆ I2C è®¤ä¸ºå…¶ä¸º START ä¿¡å·ã€‚å¦‚ä¸‹å›¾ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000015.png)

START ä¿¡å·ä¹‹åï¼ŒI2C Master ä¼ é€’ 7 bit çš„ Slave åœ°å€ï¼ŒSlave åœ°å€é¦–å…ˆä¼  MSB
éƒ¨åˆ†ï¼Œå³ Slave åœ°å€çš„é«˜å­—èŠ‚ï¼Œç„¶åä¼ ä½å­—èŠ‚ã€‚ä¼ é€’å®Œæ¯•ä¹‹åæ˜¯ W/R æ ‡å¿—ä½ï¼Œæ­¤æ—¶
W/R bit ä½ä¸ºä½ç”µå¹³ï¼ŒW/R ä½ä¸ºä½ä»£è¡¨å†™æ“ä½œã€‚W/R ä¿¡å·ä¹‹åæ˜¯ ACK ä¿¡å·ï¼Œæ­¤æ—¶å¦‚
æœæŒ‡å®šçš„ Slave è®¾å¤‡æ²¡æœ‰åº”ç­”ï¼Œé‚£ä¹ˆ ACK å°†ä¼šæ˜¯é«˜ç”µå¹³ï¼Œæ­¤æ—¶ Master ä¼šé‡ä¼ ä¸€æ¬¡
æŒ‡å®š Slave è®¾å¤‡çš„åœ°å€ï¼Œå¦‚æœ Slave è®¾å¤‡è¿˜æ˜¯æ²¡æœ‰åº”ç­”ï¼Œé‚£ä¹ˆ Master å°±å‘å‡ºä¸€ä¸ª
STOP ä¿¡å·ï¼›å¦‚æœæŒ‡å®šçš„ Slave è®¾å¤‡åº”ç­”ï¼Œé‚£ä¹ˆ ACK ä¿¡å·ä¼šå°† SDA æ‹‰ä½ã€‚ACK ä¿¡å·
ä¹‹åæ˜¯ 8 bit çš„è¯»åœ°å€ï¼Œå³éœ€è¦åœ¨ AT24C08 ä¸Šè¯»å–æ•°æ®çš„åœ°å€ï¼Œå…¶ä¹Ÿæ˜¯å…ˆä¼  MSB
åˆ° LSB çš„ä¼ ä¿¡å·ã€‚è‡³æ­¤ï¼Œä¹‹å‰ä¼ è¾“çš„ä¿¡å·ç§°ä¸º "DUMMY WRITE"ï¼Œå› ä¸ºåœ¨è¿™æ®µä¿¡å·ä¸­ï¼Œ
W/R ä¿¡å·ä¸ºä½ï¼Œä»£è¡¨ä¸€æ¬¡å†™ï¼Œä½†åˆä¸æ˜¯ I2C å†™æ“ä½œï¼Œå› æ­¤ç§°ä¸ºå‡çš„å†™æ“ä½œã€‚æ¥ä¸‹æ¥
Master ç»§ç»­äº§ç”Ÿä¸€ä¸ª START ä¿¡å·ï¼Œå¹¶å†æ¬¡æŒ‰ MSB åˆ° LSB çš„æ–¹å¼ä¼ è¾“ä»è®¾å¤‡çš„åœ°å€ã€‚
æ¥ä¸‹æ¥ä¼ é€’ä¸€ä¸ª READ ä¿¡å·ï¼Œä¸ºé«˜ç”µå¹³ï¼Œä»£è¡¨çœŸæ­£çš„è¯»æ“ä½œï¼Œæ­¤æ—¶å¦‚æœ Slave è®¾å¤‡å‡†å¤‡
å¥½æ•°æ®ï¼Œé‚£ä¹ˆ Slave è®¾å¤‡å°±ä¼šå°† SDA æ€»çº¿æ‹‰ä½ï¼Œä»¥æ­¤ç”Ÿæˆä¸€ä¸ª ACK ä¿¡å·ï¼Œæ¥ç€
Slave è®¾å¤‡å°†æ•°æ®å†™å…¥åˆ° SDA ä¿¡å·çº¿ä¸Šï¼›å¦‚æœæ­¤æ—¶ Slave è®¾å¤‡æ²¡æœ‰åº”ç­”ï¼Œé‚£ä¹ˆ Master
ä¼šé‡ä¼  Slave åœ°å€åˆ° SDA ä¿¡å·çº¿ä¸Šã€‚åœ¨ Slave è®¾å¤‡ä¼ è¾“å®Œæ•°æ®ä¹‹åï¼Œå¦‚æœ
æ²¡æœ‰å…¶ä»–æ“ä½œï¼Œé‚£ä¹ˆåˆ°ç¬¬ 9 ä¸ªå‘¨æœŸ Slave å°†ä¸ä¼šäº§ç”Ÿ ACK ä¿¡å·ï¼ŒSDA ä¿¡å·çº¿å˜é«˜ï¼Œ
æ­¤æ—¶å¦‚æœ Master æ— å…¶ä»–æ“ä½œï¼Œé‚£ä¹ˆ Master å°†ä¼šäº§ç”Ÿä¸€ä¸ª STOP ä¿¡å·ã€‚è‡³æ­¤ï¼Œä¸€æ¬¡
I2C çš„ Random Read æ“ä½œå®Œæˆã€‚

#### æ—  Slave è®¾å¤‡ I2C Read æ“ä½œ

é¦–å…ˆåœ¨ I2C æ€»çº¿ä¸Šä¸æŒ‚è½½ä»»ä½•ä»è®¾å¤‡çš„æƒ…å†µä¸‹ï¼Œè¿›è¡Œ I2C çš„ Random Read æ“ä½œã€‚
æ­å»ºå¥½æµ‹è¯•ç¯å¢ƒä¹‹åï¼Œè¿è¡Œ DSView ç¨‹åºã€‚ç‚¹å‡»è§¦å‘æŒ‰é’®ï¼Œå°†å³ä¾§ "è§¦å‘ä½ç½®" è°ƒæ•´
ä¸º 10%ï¼Œä»¥ä¾¿èƒ½ä» I2C èµ·å§‹ä¿¡å·å¤„å¼€å§‹æŠ“å–æ³¢å½¢ï¼›æ­¤æ—¶é€šé“ 0 è¿æ¥ SDA ä¿¡å·çº¿ï¼Œæ ¹æ®
I2C ä¿¡å·å¯çŸ¥ï¼Œå½“ SDA äº§ç”Ÿä¸€ä¸ªä¸‹é™æ²¿ä¹‹åï¼ŒSCL æ¥ç€ä¹Ÿäº§ç”Ÿä¸€ä¸ªä¸‹é™æ²¿ï¼Œé‚£ä¹ˆè®¤ä¸º
æ˜¯ I2C å¼€å§‹ä¼ è¾“ä¿¡å·ï¼Œå› æ­¤å°† SDA çš„ä¸‹é™æ²¿ä½œä¸ºè§¦å‘ä¿¡å·ã€‚è®¾ç½®å¥½ä¹‹åç‚¹å‡» "å•æ¬¡"
æŒ‰é’®ï¼Œå¯¹ä¿¡å·è¿›è¡Œæ•æ‰ã€‚ä½¿ç”¨ä¸Šé¢çš„æµ‹è¯•ç¨‹åºï¼Œå¯¹ 0x50 çš„ 0x00 åœ°å€è¯»å– 1 ä¸ªå­—èŠ‚
çš„æ“ä½œï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000006.png)

ä»æ•è·çš„æ³¢å½¢å¯ä»¥çœ‹å‡ºï¼Œç»¿è‰²ä¸º SCL ä¿¡å·ï¼Œé»„è‰²ä¸º SDA ä¿¡å·ã€‚åœ¨å‰ 8 ä¸ªå‘¨æœŸä¸­ï¼Œ
ä»è®¾å¤‡åœ°å€ä¸º 0x50ï¼ŒR/W ä¸º 0ï¼ŒACK æ²¡æœ‰åº”ç­”ï¼Œå› æ­¤ Master åœ¨é‡å‘ä¸€æ¬¡ï¼Œæ­¤æ—¶
ACK è¿˜æ˜¯æ²¡æœ‰åº”ç­”ï¼Œäºæ˜¯ Master å‘é€ä¸€ä¸ª STOP ä¿¡å·ã€‚æ­¤æ¬¡æ“ä½œé¢„è®¡ç»“æœç¬¦åˆé¢„æœŸã€‚

#### æŒ‚è½½ AT24C08 I2C Read æ“ä½œ

é¦–å…ˆå°† AT24C08 è¿æ¥åˆ° RPI-4B ä¸Šï¼Œè¿›è¡Œ I2C çš„ Random Read æ“ä½œã€‚
æ­å»ºå¥½æµ‹è¯•ç¯å¢ƒä¹‹åï¼Œè¿è¡Œ DSView ç¨‹åºã€‚ç‚¹å‡»è§¦å‘æŒ‰é’®ï¼Œå°†å³ä¾§ "è§¦å‘ä½ç½®" è°ƒæ•´
ä¸º 10%ï¼Œä»¥ä¾¿èƒ½ä» I2C èµ·å§‹ä¿¡å·å¤„å¼€å§‹æŠ“å–æ³¢å½¢ï¼›æ­¤æ—¶é€šé“ 0 è¿æ¥ SDA ä¿¡å·çº¿ï¼Œæ ¹æ®
I2C ä¿¡å·å¯çŸ¥ï¼Œå½“ SDA äº§ç”Ÿä¸€ä¸ªä¸‹é™æ²¿ä¹‹åï¼ŒSCL æ¥ç€ä¹Ÿäº§ç”Ÿä¸€ä¸ªä¸‹é™æ²¿ï¼Œé‚£ä¹ˆè®¤ä¸º
æ˜¯ I2C å¼€å§‹ä¼ è¾“ä¿¡å·ï¼Œå› æ­¤å°† SDA çš„ä¸‹é™æ²¿ä½œä¸ºè§¦å‘ä¿¡å·ã€‚è®¾ç½®å¥½ä¹‹åç‚¹å‡» "å•æ¬¡"
æŒ‰é’®ï¼Œå¯¹ä¿¡å·è¿›è¡Œæ•æ‰ã€‚ä½¿ç”¨ä¸Šé¢çš„æµ‹è¯•ç¨‹åºï¼Œå¯¹ 0x50 çš„ 0x00 åœ°å€è¯»å– 1 ä¸ªå­—èŠ‚
çš„æ“ä½œï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000007.png)

ä»æ•è·çš„æ³¢å½¢å¯ä»¥çœ‹å‡ºï¼Œç»¿è‰²ä¸º SCL ä¿¡å·ï¼Œé»„è‰²ä¸º SDA ä¿¡å·ã€‚åœ¨å‰ 8 ä¸ªå‘¨æœŸä¸­ï¼Œ
ä»è®¾å¤‡åœ°å€ä¸º 0x50ï¼ŒR/W ä¸º 0ï¼ŒACK æ²¡æœ‰åº”ç­”ï¼Œå› æ­¤ Master é‡ä¼ äº†ä¸€æ¬¡ï¼Œåˆ°äº†
ç¬¬ 9 ä¸ªå‘¨æœŸè¿˜æ˜¯æ²¡æœ‰åº”ç­”ã€‚å› æ­¤å‘ç°é—®é¢˜ Slave è®¾å¤‡æ— æ³•è¯†åˆ«ã€‚

#### é—®é¢˜æ’é™¤

é¦–å…ˆä½¿ç”¨ç”µå‹è¡¨æµ‹é‡ AT24C08 çš„ç”µå‹ï¼ŒVCC ä¸º 3.2Vï¼ŒSDA ä¸ SCL å‡ä¸º 3.1Vï¼š
åœ¨è¿™å¬å–ç¤¾åŒºæœ‹å‹çš„å»ºè®®ï¼Œå¯¹ RPI 4B I2C çš„é¢‘ç‡è¿›è¡Œä¿®æ”¹ï¼Œåˆ†åˆ«æµ‹è¯•äº† 400K, 100K,
50K, ä»¥åŠ 10Kï¼Œéƒ½æ— æ³•æ‰¾åˆ° I2C ä»è®¾å¤‡ã€‚
æ¥ç€æŸ¥çœ‹ BCM2835 å…³äº I2C æ§åˆ¶å™¨çš„æ–‡æ¡£ï¼Œä»¥åŠå¯¹åº”çš„çš„é©±åŠ¨ç¨‹åºï¼Œåœ¨å…¶ä¸­å‘ç°ä¸€ä¸ª
åä¸º "Clock Stretching" çš„é—®é¢˜ï¼Œå³ç”±äºä¸»æ§åœ¨ I2C æ€»çº¿ä¸Šå‘ä»è®¾å¤‡å‘é€æ•°æ®ä¹‹åï¼Œ
ä»è®¾å¤‡å›åº”æ—¶é—´è¶…è¿‡äº† Master ç­‰å¾…æ—¶é—´ï¼Œè¿™ç§°ä¸ºæ—¶é’Ÿæ‹‰å‡é—®é¢˜ã€‚ä¸‹é¢æ˜¯å¯¹è¯¥é—®é¢˜çš„è®¨è®ºï¼š

> - [Raspberry Pi I2C clock-stretching bug](http://www.advamation.com/knowhow/raspberrypi/rpi-i2c-bug.html)
>
> - [I2C clock stretching](https://www.raspberrypi.org/forums/viewtopic.php?p=146272)

é€šè¿‡ä¸Šé¢çš„æ–‡æ¡£ï¼Œä¹Ÿå‘ç°äº†æŒ‚è½½ AT24C08 çš„æ—¶å€™ï¼Œä¹Ÿå‡ºç°äº†å‘¨æœŸæ‹‰å‡é—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/RPI/RPI000007.png)

å› æ­¤ç¡®å®šé—®é¢˜å°±æ˜¯ Master æ­£å¸¸å‘é€æ³¢å½¢ï¼Œåªæ˜¯ Slave æ²¡æœ‰æˆ–è€…æ²¡æœ‰åŠæ—¶åº”ç­”ï¼Œ
å› æ­¤ç»§ç»­æŸ¥æ‰¾æ ¹æœ¬åŸå› ã€‚äºæ˜¯æˆ‘æ‰¾äº†ä¸€ä¸ªé«˜é€Ÿçš„ I2C è®¾å¤‡ "LM75A" é«˜ç²¾åº¦æ¸©åº¦
ä¼ æ„Ÿå™¨ã€‚ä½¿ç”¨åŒæ ·çš„å®‰è£…åŠæ³•ï¼Œç»“æœè¿˜æ˜¯åŒæ ·çš„é—®é¢˜ï¼ŒRPI 4B æ— æ³•æ‰¾åˆ° Slave
è®¾å¤‡ã€‚

ç¤¾åŒºæœ‹å‹å»ºè®®åœ¨ AT24C08 èŠ¯ç‰‡å¼•è„šä¸Šç¡®è®¤æ˜¯å¦æœ‰ SDA å’Œ SCL ä¿¡å·ä¼ è¾“è¿‡æ¥ï¼Œ
ç»“æœé€šè¿‡ç¤ºæ³¢å™¨å‘ç° SCL ä¿¡å·å¹¶æœªæ¥æ”¶åˆ°ï¼Œäºæ˜¯æ’æŸ¥é“¾æ¥é—®é¢˜ã€‚æœ€åå‘ç°è¿æ¥
AT24C08 çš„æœé‚¦çº¿å¤´å¤„å‡ºç°æ¾åŠ¨ï¼Œå¯¼è‡´è™šæ¥ã€‚å°†çº¿è¿æ¥å¥½åï¼ŒRPI 4B å¯ä»¥æ­£å¸¸
æ‰¾åˆ° Slave è®¾å¤‡ã€‚

#### é—®é¢˜æ€»ç»“

ä¸ºäº†å¤„ç†è¿™ä¸ªé—®é¢˜ï¼ŒèŠ±è´¹äº†å¾ˆå¤šæ—¶é—´æŸ¥æ‰¾å„æ–¹é¢çš„åŸå› ï¼Œé€šè¿‡ä¸æ–­çš„æŸ¥æ‰¾ï¼Œç¦»çœŸç›¸è¶Šæ¥
è¶Šè¿‘ã€‚æœ€åå‘ç°é—®é¢˜æ˜¯å› ä¸ºæœé‚¦çº¿è¿æ¥é—®é¢˜ï¼Œè¿™é‡Œæ›¾ç»æ˜¯è‡ªå·±æ²¡æœ‰å®é™…æµ‹é‡ä½†è®¤ä¸º
æ²¡æœ‰é—®é¢˜çš„åœ°æ–¹ï¼Œæœ€åè¿™é‡Œæˆä¸ºé—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚é€šè¿‡è¿™æ¬¡é—®é¢˜çš„è§£å†³ï¼Œè™½ç„¶ç»•äº†
ä¸€å¤§åœˆï¼Œä½†å¯¹ I2C çš„å¤šä¸ªæ–¹é¢ä¹Ÿæœ‰äº†æ›´å¤šçš„ç†è§£ï¼Œæ¯”å¦‚ I2C æ§åˆ¶å™¨ï¼ŒI2C å¹³å°æ€»çº¿ï¼Œ
I2C è®¾å¤‡æ–¹é¢ã€‚ä½†æœ€ç»ˆé—®é¢˜è¿˜æ˜¯ç”±äºè‡ªå·±å¯¹ç¡¬ä»¶è¿çº¿å¤„ç†ä¸å¤Ÿè°¨æ…å¼•èµ·çš„ã€‚

-----------------------------------------------

# <span id="BBB">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](https://biscuitos.github.io/blog/Kernel_Build/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>
> [æ­å»ºé«˜æ•ˆçš„ Linux å¼€å‘ç¯å¢ƒ](https://biscuitos.github.io/blog/Linux-debug-tools/)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/HAB000036.jpg)
