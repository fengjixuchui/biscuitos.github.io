---
layout: post
title:  "THP: Transport Huge Pages Mechanism"
date:   2022-05-06 09:00:00 +0800
categories: [HW]
excerpt: THP.
tags:
  - é€æ˜å¤§é¡µ
  - AnonHugePages
  - ShmemHugePages
  - ShmemPmdMapped
---

![](/assets/PDB/BiscuitOS/kernel/IND00000L0.PNG)

![](/assets/PDB/RPI/RPI100100.png)

#### ç›®å½•

> - [THP åŸºç¡€çŸ¥è¯†](#A)
>
> - [THP å®è·µæ”»ç•¥](#B)
>
> - [THP ä½¿ç”¨æ‰‹å†Œ](#C)
>
> - [THP æºç åˆ†æ](#D)
>
> - [THP å¼€æºå·¥å…·](#E)
>
> - THP è¿›é˜¶ç ”ç©¶

######  ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ æèµ ä¸€ä¸‹å§ ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚

![BiscuitOS](/assets/PDB/BiscuitOS/kernel/HAB000036.jpg)

-------------------------------------------

<span id="C"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000Q.jpg)

#### THP ä½¿ç”¨æ‰‹å†Œ

![](/assets/PDB/HK/TH001565.png)

æœ¬èŠ‚åŸºäºä¸°å¯Œçš„å®ä¾‹æ¡ˆä¾‹æ¥ä»‹ç» THP çš„ä½¿ç”¨ï¼Œå®è·µæ¡ˆä¾‹å·²ç»åœ¨ BiscuitOS é€‚é…ï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒéƒ¨ç½²æµç¨‹åœ¨ BiscuitOS ç›´æ¥å®è·µæ¡ˆä¾‹:

> - [åŒ¿åå…±äº«æ˜ å°„ç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage å¤§é¡µ](#C00C00)
>
> - [æ–‡ä»¶(ç§æœ‰/å…±äº«)æ˜ å°„ç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage å¤§é¡µ](#C00C01)
>
> - [åŒ¿åç§æœ‰æ˜ å°„ç›´æ¥åˆ†é…ä¸€ä¸ª AnonHugepage å¤§é¡µ](#C00C02)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C00"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000Q.jpg)

#### åŒ¿åå…±äº«æ˜ å°„ç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage å¤§é¡µ

åœ¨å¯ç”¨é€æ˜å¤§é¡µçš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœå¯¹ ShmemHugepage çš„ç­–ç•¥æ˜¯ always æ—¶ï¼Œè¿›ç¨‹é€šè¿‡åŒ¿åå…±äº«æ–¹å¼åˆ†é… 2MiB è™šæ‹Ÿå†…å­˜æ—¶ï¼Œåªè¦è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜ä»»æ„ä½ç½®æ˜¯ï¼Œç³»ç»Ÿç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage ç‰©ç†é¡µä¸ 2MiB è™šæ‹Ÿå†…å­˜å»ºç«‹é¡µè¡¨æ˜ å°„å…³ç³»ã€‚ä¸ºäº†æ›´å¥½å®è·µ ShmemHugepagesï¼Œå†…æ ¸å¿…é¡»å¯ç”¨ **CONFIG_TRANSPARENT_HUGEPAGE** å®å’Œ **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** å®ã€‚æœ¬èŠ‚ç”¨äºä»‹ç»åº”ç”¨ç¨‹åºåˆ†é… ShmemHugepage çš„æ–¹æ³•, BiscuitOS æä¾›äº†ä½¿ç”¨æ¡ˆä¾‹ï¼Œå…¶åœ¨ BiscuitOS ä¸Šéƒ¨ç½²é€»è¾‘å¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: å†…æ ¸ç‰ˆæœ¬å­—æ®µ e.g. 5.0
# ARCHITECTURE: æ¶æ„å­—æ®µ e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*]  THP: Alloc an Anonymous ShmemHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-anonymous-default/
# ä¸‹è½½æ¡ˆä¾‹æºç 
make download
{% endhighlight %} 

> [BiscuitOS-THP-ShmemHugepage-anonymous-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-ShmemHugepage-anonymous)
>
> [BiscuitOS ç‹¬ç«‹æ¨¡å—éƒ¨ç½²æ‰‹å†Œ](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![](/assets/PDB/HK/TH001502.png)
![](/assets/PDB/HK/TH001607.png)
![](/assets/PDB/HK/TH001608.png)
![](/assets/PDB/HK/TH001609.png)
![](/assets/PDB/HK/TH001610.png)

æ¡ˆä¾‹æºç é€šè¿‡ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå±•ç¤ºï¼Œåº”ç”¨ç¨‹åºé¦–å…ˆåœ¨ 29 è¡Œè°ƒç”¨ mmap() å‡½æ•°ï¼Œé€šè¿‡åŒ¿åå…±äº«æ˜ å°„çš„æ–¹å¼åˆ†é…äº† BISCUITOS_MAP_SIZE çš„è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡å®å®šä¹‰å¯ä»¥çŸ¥é“è™šæ‹Ÿå†…å­˜å¤§å°ä¸º 8MiBï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åœ¨ 44-47 è¡Œåˆ†åˆ«æŒ‰ 2MiB çš„åç§»å¯¹è™šæ‹Ÿå†…å­˜è¿›è¡Œè®¿é—®ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ª 2MiB çš„è™šæ‹ŸåŒºåŸŸéƒ½è¢«è®¿é—®äº†ä¸€æ¬¡ã€‚ä¸ºäº†è°ƒè¯•æ–¹ä¾¿è¿›ç¨‹åœ¨ 50 è¡Œå¤„è°ƒç”¨ sleep(-1) ä¿æŒä¸é€€å‡º. è‡³æ­¤ç¨‹åºçš„åŠŸèƒ½å®Œç»“ï¼Œæ¡ˆä¾‹ä»£ç å¾ˆç²¾ç®€ï¼Œå¦å¤–å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åéœ€è¦è®¾ç½® THP çš„ ShmemHugepage ç­–ç•¥ä¸º always, é‚£ä¹ˆæ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åœ¨ BiscuitOS ä¸Šè¿›è¡Œå®è·µ:

{% highlight bash %}
# è¿›å…¥æºç ç›®å½•
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-anonymous-default/
# ç¼–è¯‘æºç 
make
# å®‰è£…é©±åŠ¨
make install
# Rootfs æ‰“åŒ…
make pack
# è¿è¡Œ BiscuitOS
make run

# THP Enable ShmemHugepage always
echo always > /sys/kernel/mm/transparent_hugepage/shmem_enabled

# åå°æ–¹å¼è¿è¡Œç¨‹åº
BiscuitOS-THP-ShmemHugepage-anonymous-default &

# æŸ¥çœ‹ ShmemHugepage ä½¿ç”¨æƒ…å†µ
cat /proc/meminfo | grep Huge
{% endhighlight %}

![](/assets/PDB/HK/TH001611.png)

å¯ä»¥çœ‹åˆ°å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åï¼Œå‘ "/sys/kernel/mm/transparent_hugepage/shmem_enabled" å†™å…¥ always æ—¶ï¼Œé‚£ä¹ˆ THP çš„ ShmemHugepage ç­–ç•¥å°±æ˜¯ç›´æ¥åˆ†é…. æ¥ç€åå°è¿è¡Œåº”ç”¨ç¨‹åº BiscuitOS-THP-ShmemHugepage-anonymous-defaultï¼Œæ­¤æ—¶æŸ¥çœ‹ ShmemHugepage çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºæ­¤æ—¶è¿›ç¨‹å ç”¨äº† 4 ä¸ª ShmemHugepage å¤§é¡µï¼Œæ€»å…± 8MiB ç‰©ç†å†…å­˜ï¼Œè¿™ä¸æºç è®¿é—® 8MiB è™šæ‹Ÿå†…å­˜å¯¹åº”. è‡³æ­¤å®è·µå®Œæ¯•ç¬¦åˆé¢„æœŸ.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C01"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000T.jpg)

#### æ–‡ä»¶(ç§æœ‰/å…±äº«)æ˜ å°„ç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage å¤§é¡µ

åœ¨å¯ç”¨é€æ˜å¤§é¡µçš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœæŒ‚è½½äº†ä¸€ä¸ªå¸¦ "huge=always" å‚æ•°çš„ tmpfs æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œè¿›ç¨‹åœ¨è¯¥ tmpfs æ–‡ä»¶ç³»ç»Ÿä¸‹é€šè¿‡æ–‡ä»¶(å…±äº«/ç§æœ‰)æ˜ å°„æ–¹å¼åˆ†é… 2MiB è™šæ‹Ÿå†…å­˜æ—¶ï¼Œåªè¦è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜ä»»æ„ä½ç½®æ˜¯ï¼Œç³»ç»Ÿç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage ç‰©ç†é¡µä¸ 2MiB è™šæ‹Ÿå†…å­˜å»ºç«‹é¡µè¡¨æ˜ å°„å…³ç³»ã€‚ä¸ºäº†æ›´å¥½å®è·µ ShmemHugepagesï¼Œå†…æ ¸å¿…é¡»å¯ç”¨ **CONFIG_TRANSPARENT_HUGEPAGE** å®å’Œ **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** å®ã€‚æœ¬èŠ‚ç”¨äºä»‹ç»åº”ç”¨ç¨‹åºåˆ†é… ShmemHugepage çš„æ–¹æ³•, BiscuitOS æä¾›äº†ä½¿ç”¨æ¡ˆä¾‹ï¼Œå…¶åœ¨ BiscuitOS ä¸Šéƒ¨ç½²é€»è¾‘å¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: å†…æ ¸ç‰ˆæœ¬å­—æ®µ e.g. 5.0
# ARCHITECTURE: æ¶æ„å­—æ®µ e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*]  THP: Alloc an File ShmemHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-file-default/
# ä¸‹è½½æ¡ˆä¾‹æºç 
make download
{% endhighlight %} 

> [BiscuitOS-THP-ShmemHugepage-file-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-ShmemHugepage-file)
>
> [BiscuitOS ç‹¬ç«‹æ¨¡å—éƒ¨ç½²æ‰‹å†Œ](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![](/assets/PDB/HK/TH001502.png)
![](/assets/PDB/HK/TH001607.png)
![](/assets/PDB/HK/TH001612.png)
![](/assets/PDB/HK/TH001613.png)
![](/assets/PDB/HK/TH001614.png)

æ¡ˆä¾‹æºç é€šè¿‡ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå±•ç¤ºï¼Œåº”ç”¨ç¨‹åºé¦–å…ˆåœ¨ 31 è¡Œé€šè¿‡ open() å‡½æ•°ä»¥å¯è¯»å¯å†™çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶ BiscuitOS ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ›å»º BiscuitOS æ–‡ä»¶ï¼Œç¨‹åºæ¥ç€åœ¨ 38 è¡Œè°ƒç”¨ write() å‡½æ•°å‘ BiscuitOS æ–‡ä»¶åç«¯å†™å…¥æ•°æ®ã€‚ç„¶åç¨‹åºåœ¨ 41 è¡Œè°ƒç”¨ mmap() å‡½æ•°ï¼Œé€šè¿‡æ–‡ä»¶å…±äº«(ä¹Ÿå¯ä»¥æ˜¯ç§æœ‰)æ˜ å°„çš„æ–¹å¼åˆ†é…äº† BISCUITOS_MAP_SIZE çš„è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡å®å®šä¹‰å¯ä»¥çŸ¥é“è™šæ‹Ÿå†…å­˜å¤§å°ä¸º 8MiBï¼Œè¯¥è™šæ‹Ÿå†…å­˜ç”¨äºæ˜ å°„ BiscuitOS æ–‡ä»¶ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥åœ¨ 57 è¡Œå¯¹è™šæ‹Ÿå†…å­˜è¿›è¡Œè®¿é—®ã€‚ä¸ºäº†è°ƒè¯•æ–¹ä¾¿è¿›ç¨‹åœ¨ 60 è¡Œå¤„è°ƒç”¨ sleep(-1) ä¿æŒä¸é€€å‡º. è‡³æ­¤ç¨‹åºçš„åŠŸèƒ½å®Œç»“ï¼Œæ¡ˆä¾‹ä»£ç å¾ˆç²¾ç®€ï¼Œå¦å¤–å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åéœ€è¦æŒ‚è½½ä¸€ä¸ªå¸¦ "huge=always" å‚æ•°çš„ tmpfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ‰“å¼€è¯¥æ–‡ä»¶, é‚£ä¹ˆæ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åœ¨ BiscuitOS ä¸Šè¿›è¡Œå®è·µ:

{% highlight bash %}
# è¿›å…¥æºç ç›®å½•
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-file-default/
# ç¼–è¯‘æºç 
make
# å®‰è£…é©±åŠ¨
make install
# Rootfs æ‰“åŒ…
make pack
# è¿è¡Œ BiscuitOS
make run

# æŒ‚è½½ huge tmpfs
mkdir -p /BiscuitOS-tmpfs/
mount -t tmpfs nodev -o huge=always /BiscuitOS-tmpfs/

# åå°æ–¹å¼è¿è¡Œç¨‹åº
BiscuitOS-THP-ShmemHugepage-file-default &

# æŸ¥çœ‹ ShmemHugepage ä½¿ç”¨æƒ…å†µ
cat /proc/meminfo | grep Huge
{% endhighlight %}

![](/assets/PDB/HK/TH001615.png)

å¯ä»¥çœ‹åˆ°å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åï¼ŒæŒ‚è½½ä¸€ä¸ª huge tmpfs ä¹‹ååœ¨åå°è¿è¡Œåº”ç”¨ç¨‹åº BiscuitOS-THP-ShmemHugepage-file-defaultï¼Œæ­¤æ—¶æŸ¥çœ‹ ShmemHugepage çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºæ­¤æ—¶è¿›ç¨‹å ç”¨äº† 1 ä¸ª ShmemHugepage å¤§é¡µï¼Œæ€»å…± 2MiB ç‰©ç†å†…å­˜ï¼Œè¿™ä¸æºç è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜å¯¹åº”. è‡³æ­¤å®è·µå®Œæ¯•ç¬¦åˆé¢„æœŸ.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C02"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000I.jpg)

#### åŒ¿åç§æœ‰æ˜ å°„ç›´æ¥åˆ†é…ä¸€ä¸ª AnonHugepage å¤§é¡µ

åœ¨å¯ç”¨é€æ˜å¤§é¡µçš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœå¯¹ THP çš„ç­–ç•¥æ˜¯ always æ—¶ï¼Œå¹¶ä¸”ç³»ç»Ÿç‰©ç†å†…å­˜å¤§äº 512MiBï¼Œé‚£ä¹ˆè¿›ç¨‹é€šè¿‡åŒ¿åç§æœ‰æ–¹å¼åˆ†é… 2MiB è™šæ‹Ÿå†…å­˜æ—¶ï¼Œåªè¦è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜ä»»æ„ä½ç½®æ˜¯ï¼Œç³»ç»Ÿç›´æ¥åˆ†é…ä¸€ä¸ª AnonHugepage ç‰©ç†é¡µä¸ 2MiB è™šæ‹Ÿå†…å­˜å»ºç«‹é¡µè¡¨æ˜ å°„å…³ç³»ã€‚ä¸ºäº†æ›´å¥½å®è·µ AnonHugepagesï¼Œå†…æ ¸å¿…é¡»å¯ç”¨ **CONFIG_TRANSPARENT_HUGEPAGE** å®å’Œ **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** å®, å¹¶ä¸”ç³»ç»Ÿç‰©ç†å†…å­˜å¤§äº 512MiBã€‚æœ¬èŠ‚ç”¨äºä»‹ç»åº”ç”¨ç¨‹åºåˆ†é… AnonHugepage çš„æ–¹æ³•, BiscuitOS æä¾›äº†ä½¿ç”¨æ¡ˆä¾‹ï¼Œå…¶åœ¨ BiscuitOS ä¸Šéƒ¨ç½²é€»è¾‘å¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: å†…æ ¸ç‰ˆæœ¬å­—æ®µ e.g. 5.0
# ARCHITECTURE: æ¶æ„å­—æ®µ e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*]  THP: Alloc an AnonHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-AnonHugepage-default/
# ä¸‹è½½æ¡ˆä¾‹æºç 
make download
{% endhighlight %} 

> [BiscuitOS-THP-AnonHugepage-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-AnonHugepage)
>
> [BiscuitOS ç‹¬ç«‹æ¨¡å—éƒ¨ç½²æ‰‹å†Œ](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![](/assets/PDB/HK/TH001502.png)
![](/assets/PDB/HK/TH001607.png)
![](/assets/PDB/HK/TH001616.png)
![](/assets/PDB/HK/TH001617.png)
![](/assets/PDB/HK/TH001618.png)

æ¡ˆä¾‹æºç é€šè¿‡ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå±•ç¤ºï¼Œåº”ç”¨ç¨‹åºé¦–å…ˆåœ¨ 29 è¡Œè°ƒç”¨ mmap() å‡½æ•°ï¼Œé€šè¿‡åŒ¿åç§æœ‰æ˜ å°„çš„æ–¹å¼åˆ†é…äº† BISCUITOS_MAP_SIZE çš„è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡å®å®šä¹‰å¯ä»¥çŸ¥é“è™šæ‹Ÿå†…å­˜å¤§å°ä¸º 8MiBï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åœ¨ 44-47 è¡Œåˆ†åˆ«æŒ‰ 2MiB çš„åç§»å¯¹è™šæ‹Ÿå†…å­˜è¿›è¡Œè®¿é—®ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ª 2MiB çš„è™šæ‹ŸåŒºåŸŸéƒ½è¢«è®¿é—®äº†ä¸€æ¬¡ã€‚ä¸ºäº†è°ƒè¯•æ–¹ä¾¿è¿›ç¨‹åœ¨ 50 è¡Œå¤„è°ƒç”¨ sleep(-1) ä¿æŒä¸é€€å‡º. è‡³æ­¤ç¨‹åºçš„åŠŸèƒ½å®Œç»“ï¼Œæ¡ˆä¾‹ä»£ç å¾ˆç²¾ç®€ï¼Œå¦å¤–å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åéœ€è¦è®¾ç½® THP çš„ç­–ç•¥ä¸º always, é‚£ä¹ˆæ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åœ¨ BiscuitOS ä¸Šè¿›è¡Œå®è·µ:

{% highlight bash %}
# ä¿®æ”¹ç³»ç»Ÿç‰©ç†å†…å­˜å¤§äº 512MiB
vi BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/RunBiscuitOS.sh
- RAM_SIZE=512
+ RAM_SIZE=1024

# è¿›å…¥æºç ç›®å½•
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-anonymous-default/
# ç¼–è¯‘æºç 
make
# å®‰è£…é©±åŠ¨
make install
# Rootfs æ‰“åŒ…
make pack
# è¿è¡Œ BiscuitOS
make run

# THP Enable always
echo always > /sys/kernel/mm/transparent_hugepage/enabled

# åå°æ–¹å¼è¿è¡Œç¨‹åº
BiscuitOS-THP-AnonHugepage-default &

# æŸ¥çœ‹ ShmemHugepage ä½¿ç”¨æƒ…å†µ
cat /proc/meminfo | grep Huge
{% endhighlight %}

![](/assets/PDB/HK/TH001619.png)

å¯ä»¥çœ‹åˆ°å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åï¼Œå‘ "/sys/kernel/mm/transparent_hugepage/enabled" å†™å…¥ always æ—¶ï¼Œé‚£ä¹ˆ THP çš„ç­–ç•¥å°±æ˜¯ç›´æ¥åˆ†é…. æ¥ç€åå°è¿è¡Œåº”ç”¨ç¨‹åº BiscuitOS-THP-AnonHugepage-defaultï¼Œæ­¤æ—¶æŸ¥çœ‹ AnonHugepage çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºæ­¤æ—¶è¿›ç¨‹å ç”¨äº† 4 ä¸ª AnonHugepage å¤§é¡µï¼Œæ€»å…± 8MiB ç‰©ç†å†…å­˜ï¼Œè¿™ä¸æºç è®¿é—® 8MiB è™šæ‹Ÿå†…å­˜å¯¹åº”. è‡³æ­¤å®è·µå®Œæ¯•ç¬¦åˆé¢„æœŸ.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

