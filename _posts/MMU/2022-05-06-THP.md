---
layout: post
title:  "THP: Transport Huge Pages Mechanism"
date:   2022-05-06 09:00:00 +0800
categories: [HW]
excerpt: THP.
tags:
  - é€æ˜å¤§é¡µ
  - AnonHugePages
  - ShmemHugePages
  - ShmemPmdMapped
---

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND00000L0.PNG)

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/RPI/RPI100100.png)

#### ç›®å½•

> - [THP åŸºç¡€çŸ¥è¯†](#A)
>
> - [THP å®è·µæ”»ç•¥](#B)
>
> - [THP ä½¿ç”¨æ‰‹å†Œ](#C)
>
> - [THP æºç åˆ†æ](#D)
>
> - [THP å¼€æºå·¥å…·](#E)
>
> - THP è¿›é˜¶ç ”ç©¶

######  ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ æèµ ä¸€ä¸‹å§ ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚ğŸ™‚

![BiscuitOS](/assets/PDB/BiscuitOS/kernel/HAB000036.jpg)

-------------------------------------------

<span id="C"></span>

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND00000Q.jpg)

#### THP ä½¿ç”¨æ‰‹å†Œ

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001565.png)

æœ¬èŠ‚åŸºäºä¸°å¯Œçš„å®ä¾‹æ¡ˆä¾‹æ¥ä»‹ç» THP çš„ä½¿ç”¨ï¼Œå®è·µæ¡ˆä¾‹å·²ç»åœ¨ BiscuitOS é€‚é…ï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒéƒ¨ç½²æµç¨‹åœ¨ BiscuitOS ç›´æ¥å®è·µæ¡ˆä¾‹:

> - [åŒ¿åå…±äº«æ˜ å°„: ç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage å¤§é¡µ](#C00C00)
>
> - [æ–‡ä»¶ç§æœ‰æ˜ å°„: ç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage å¤§é¡µ](#C00C05)
>
> - [æ–‡ä»¶å…±äº«æ˜ å°„: ç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage å¤§é¡µ](#C00C01)
>
> - [åŒ¿åç§æœ‰æ˜ å°„: ç›´æ¥åˆ†é…ä¸€ä¸ª AnonHugepage å¤§é¡µ](#C00C02)
>
> - [åŒ¿åç§æœ‰æ˜ å°„: åˆå¹¶ 4K-Page ä¸º AnonHugepage å¤§é¡µ](#C00C03)
>
> - [åŒ¿åç§æœ‰æ˜ å°„: Madvise 4K-Page ä¸º AnonHugepage å¤§é¡µ](#C00C04)

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C00"></span>

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND00000G.jpg)

#### åŒ¿åå…±äº«æ˜ å°„: ç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage å¤§é¡µ

åœ¨å¯ç”¨é€æ˜å¤§é¡µçš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœå¯¹ ShmemHugepage çš„ç­–ç•¥æ˜¯ always æ—¶ï¼Œè¿›ç¨‹é€šè¿‡åŒ¿åå…±äº«æ–¹å¼åˆ†é… 2MiB è™šæ‹Ÿå†…å­˜æ—¶ï¼Œåªè¦è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜ä»»æ„ä½ç½®æ˜¯ï¼Œç³»ç»Ÿç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage ç‰©ç†é¡µä¸ 2MiB è™šæ‹Ÿå†…å­˜å»ºç«‹é¡µè¡¨æ˜ å°„å…³ç³»ã€‚ä¸ºäº†æ›´å¥½å®è·µ ShmemHugepagesï¼Œå†…æ ¸å¿…é¡»å¯ç”¨ **CONFIG_TRANSPARENT_HUGEPAGE** å®å’Œ **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** å®ã€‚æœ¬èŠ‚ç”¨äºä»‹ç»åº”ç”¨ç¨‹åºåˆ†é… ShmemHugepage çš„æ–¹æ³•, BiscuitOS æä¾›äº†ä½¿ç”¨æ¡ˆä¾‹ï¼Œå…¶åœ¨ BiscuitOS ä¸Šéƒ¨ç½²é€»è¾‘å¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: å†…æ ¸ç‰ˆæœ¬å­—æ®µ e.g. 5.0
# ARCHITECTURE: æ¶æ„å­—æ®µ e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*]  THP: Alloc an Anonymous ShmemHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-anonymous-default/
# ä¸‹è½½æ¡ˆä¾‹æºç 
make download
{% endhighlight %} 

> [BiscuitOS-THP-ShmemHugepage-anonymous-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-ShmemHugepage-anonymous)
>
> [BiscuitOS ç‹¬ç«‹æ¨¡å—éƒ¨ç½²æ‰‹å†Œ](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001502.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001607.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001608.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001609.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001610.png)

æ¡ˆä¾‹æºç é€šè¿‡ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå±•ç¤ºï¼Œåº”ç”¨ç¨‹åºé¦–å…ˆåœ¨ 29 è¡Œè°ƒç”¨ mmap() å‡½æ•°ï¼Œé€šè¿‡åŒ¿åå…±äº«æ˜ å°„çš„æ–¹å¼åˆ†é…äº† BISCUITOS_MAP_SIZE çš„è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡å®å®šä¹‰å¯ä»¥çŸ¥é“è™šæ‹Ÿå†…å­˜å¤§å°ä¸º 8MiBï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åœ¨ 44-47 è¡Œåˆ†åˆ«æŒ‰ 2MiB çš„åç§»å¯¹è™šæ‹Ÿå†…å­˜è¿›è¡Œè®¿é—®ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ª 2MiB çš„è™šæ‹ŸåŒºåŸŸéƒ½è¢«è®¿é—®äº†ä¸€æ¬¡ã€‚ä¸ºäº†è°ƒè¯•æ–¹ä¾¿è¿›ç¨‹åœ¨ 50 è¡Œå¤„è°ƒç”¨ sleep(-1) ä¿æŒä¸é€€å‡º. è‡³æ­¤ç¨‹åºçš„åŠŸèƒ½å®Œç»“ï¼Œæ¡ˆä¾‹ä»£ç å¾ˆç²¾ç®€ï¼Œå¦å¤–å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åéœ€è¦è®¾ç½® THP çš„ ShmemHugepage ç­–ç•¥ä¸º always, é‚£ä¹ˆæ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åœ¨ BiscuitOS ä¸Šè¿›è¡Œå®è·µ:

{% highlight bash %}
# è¿›å…¥æºç ç›®å½•
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-anonymous-default/
# ç¼–è¯‘æºç 
make
# å®‰è£…é©±åŠ¨
make install
# Rootfs æ‰“åŒ…
make pack
# è¿è¡Œ BiscuitOS
make run

# THP Enable ShmemHugepage always
echo always > /sys/kernel/mm/transparent_hugepage/shmem_enabled

# åå°æ–¹å¼è¿è¡Œç¨‹åº
BiscuitOS-THP-ShmemHugepage-anonymous-default &

# æŸ¥çœ‹ ShmemHugepage ä½¿ç”¨æƒ…å†µ
cat /proc/meminfo | grep Huge
{% endhighlight %}

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001611.png)

å¯ä»¥çœ‹åˆ°å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åï¼Œå‘ "/sys/kernel/mm/transparent_hugepage/shmem_enabled" å†™å…¥ always æ—¶ï¼Œé‚£ä¹ˆ THP çš„ ShmemHugepage ç­–ç•¥å°±æ˜¯ç›´æ¥åˆ†é…. æ¥ç€åå°è¿è¡Œåº”ç”¨ç¨‹åº BiscuitOS-THP-ShmemHugepage-anonymous-defaultï¼Œæ­¤æ—¶æŸ¥çœ‹ ShmemHugepage çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºæ­¤æ—¶è¿›ç¨‹å ç”¨äº† 4 ä¸ª ShmemHugepage å¤§é¡µï¼Œæ€»å…± 8MiB ç‰©ç†å†…å­˜ï¼Œè¿™ä¸æºç è®¿é—® 8MiB è™šæ‹Ÿå†…å­˜å¯¹åº”. è‡³æ­¤å®è·µå®Œæ¯•ç¬¦åˆé¢„æœŸ.

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C01"></span>

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND00000T.jpg)

#### æ–‡ä»¶å…±äº«æ˜ å°„: ç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage å¤§é¡µ

åœ¨å¯ç”¨é€æ˜å¤§é¡µçš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœæŒ‚è½½äº†ä¸€ä¸ªå¸¦ "huge=always" å‚æ•°çš„ tmpfs æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œè¿›ç¨‹åœ¨è¯¥ tmpfs æ–‡ä»¶ç³»ç»Ÿä¸‹é€šè¿‡æ–‡ä»¶å…±äº«æ˜ å°„æ–¹å¼åˆ†é… 2MiB è™šæ‹Ÿå†…å­˜æ—¶ï¼Œåªè¦è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜ä»»æ„ä½ç½®æ˜¯ï¼Œç³»ç»Ÿç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage ç‰©ç†é¡µä¸ 2MiB è™šæ‹Ÿå†…å­˜å»ºç«‹é¡µè¡¨æ˜ å°„å…³ç³»ã€‚ä¸ºäº†æ›´å¥½å®è·µ ShmemHugepagesï¼Œå†…æ ¸å¿…é¡»å¯ç”¨ **CONFIG_TRANSPARENT_HUGEPAGE** å®å’Œ **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** å®ã€‚æœ¬èŠ‚ç”¨äºä»‹ç»åº”ç”¨ç¨‹åºåˆ†é… ShmemHugepage çš„æ–¹æ³•, BiscuitOS æä¾›äº†ä½¿ç”¨æ¡ˆä¾‹ï¼Œå…¶åœ¨ BiscuitOS ä¸Šéƒ¨ç½²é€»è¾‘å¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: å†…æ ¸ç‰ˆæœ¬å­—æ®µ e.g. 5.0
# ARCHITECTURE: æ¶æ„å­—æ®µ e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*]  THP: Alloc an File Shared ShmemHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-file-shared-default/
# ä¸‹è½½æ¡ˆä¾‹æºç 
make download
{% endhighlight %} 

> [BiscuitOS-THP-ShmemHugepage-file-shared-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-ShmemHugepage-file-shared)
>
> [BiscuitOS ç‹¬ç«‹æ¨¡å—éƒ¨ç½²æ‰‹å†Œ](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001502.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001607.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001612.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001613.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001614.png)

æ¡ˆä¾‹æºç é€šè¿‡ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå±•ç¤ºï¼Œåº”ç”¨ç¨‹åºé¦–å…ˆåœ¨ 31 è¡Œé€šè¿‡ open() å‡½æ•°ä»¥å¯è¯»å¯å†™çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶ BiscuitOS ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ›å»º BiscuitOS æ–‡ä»¶ï¼Œç¨‹åºæ¥ç€åœ¨ 38 è¡Œè°ƒç”¨ write() å‡½æ•°å‘ BiscuitOS æ–‡ä»¶åç«¯å†™å…¥æ•°æ®ã€‚ç„¶åç¨‹åºåœ¨ 41 è¡Œè°ƒç”¨ mmap() å‡½æ•°ï¼Œé€šè¿‡æ–‡ä»¶å…±äº«æ˜ å°„çš„æ–¹å¼åˆ†é…äº† BISCUITOS_MAP_SIZE çš„è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡å®å®šä¹‰å¯ä»¥çŸ¥é“è™šæ‹Ÿå†…å­˜å¤§å°ä¸º 8MiBï¼Œè¯¥è™šæ‹Ÿå†…å­˜ç”¨äºæ˜ å°„ BiscuitOS æ–‡ä»¶ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥åœ¨ 57 è¡Œå¯¹è™šæ‹Ÿå†…å­˜è¿›è¡Œè®¿é—®ã€‚ä¸ºäº†è°ƒè¯•æ–¹ä¾¿è¿›ç¨‹åœ¨ 60 è¡Œå¤„è°ƒç”¨ sleep(-1) ä¿æŒä¸é€€å‡º. è‡³æ­¤ç¨‹åºçš„åŠŸèƒ½å®Œç»“ï¼Œæ¡ˆä¾‹ä»£ç å¾ˆç²¾ç®€ï¼Œå¦å¤–å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åéœ€è¦æŒ‚è½½ä¸€ä¸ªå¸¦ "huge=always" å‚æ•°çš„ tmpfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ‰“å¼€è¯¥æ–‡ä»¶, é‚£ä¹ˆæ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åœ¨ BiscuitOS ä¸Šè¿›è¡Œå®è·µ:

{% highlight bash %}
# è¿›å…¥æºç ç›®å½•
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-file-shared-default/
# ç¼–è¯‘æºç 
make
# å®‰è£…é©±åŠ¨
make install
# Rootfs æ‰“åŒ…
make pack
# è¿è¡Œ BiscuitOS
make run

# æŒ‚è½½ huge tmpfs
mkdir -p /BiscuitOS-tmpfs/
mount -t tmpfs nodev -o huge=always /BiscuitOS-tmpfs/

# åå°æ–¹å¼è¿è¡Œç¨‹åº
BiscuitOS-THP-ShmemHugepage-file-shared-default &

# æŸ¥çœ‹ ShmemHugepage ä½¿ç”¨æƒ…å†µ
cat /proc/meminfo | grep Huge
{% endhighlight %}

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001615.png)

å¯ä»¥çœ‹åˆ°å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åï¼ŒæŒ‚è½½ä¸€ä¸ª huge tmpfs ä¹‹ååœ¨åå°è¿è¡Œåº”ç”¨ç¨‹åº BiscuitOS-THP-ShmemHugepage-file-shared-defaultï¼Œæ­¤æ—¶æŸ¥çœ‹ ShmemHugepage çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºæ­¤æ—¶è¿›ç¨‹å ç”¨äº† 1 ä¸ª ShmemHugepage å¤§é¡µï¼Œæ€»å…± 2MiB ç‰©ç†å†…å­˜ï¼Œè¿™ä¸æºç è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜å¯¹åº”. è‡³æ­¤å®è·µå®Œæ¯•ç¬¦åˆé¢„æœŸ.

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C05"></span>

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND00000F.jpg)

#### æ–‡ä»¶ç§æœ‰æ˜ å°„: ç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage å¤§é¡µ

åœ¨å¯ç”¨é€æ˜å¤§é¡µçš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœæŒ‚è½½äº†ä¸€ä¸ªå¸¦ "huge=always" å‚æ•°çš„ tmpfs æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œè¿›ç¨‹åœ¨è¯¥ tmpfs æ–‡ä»¶ç³»ç»Ÿä¸‹é€šè¿‡æ–‡ä»¶ç§æœ‰æ˜ å°„æ–¹å¼åˆ†é… 2MiB è™šæ‹Ÿå†…å­˜æ—¶ï¼Œåªè¦è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜ä»»æ„ä½ç½®æ˜¯ï¼Œç³»ç»Ÿç›´æ¥åˆ†é…ä¸€ä¸ª ShmemHugepage ç‰©ç†é¡µä¸ 2MiB è™šæ‹Ÿå†…å­˜å»ºç«‹é¡µè¡¨æ˜ å°„å…³ç³»ã€‚ä¸ºäº†æ›´å¥½å®è·µ ShmemHugepagesï¼Œå†…æ ¸å¿…é¡»å¯ç”¨ **CONFIG_TRANSPARENT_HUGEPAGE** å®å’Œ **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** å®ã€‚æœ¬èŠ‚ç”¨äºä»‹ç»åº”ç”¨ç¨‹åºåˆ†é… ShmemHugepage çš„æ–¹æ³•, BiscuitOS æä¾›äº†ä½¿ç”¨æ¡ˆä¾‹ï¼Œå…¶åœ¨ BiscuitOS ä¸Šéƒ¨ç½²é€»è¾‘å¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: å†…æ ¸ç‰ˆæœ¬å­—æ®µ e.g. 5.0
# ARCHITECTURE: æ¶æ„å­—æ®µ e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*]  THP: Alloc an File Private ShmemHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-file-private-default/
# ä¸‹è½½æ¡ˆä¾‹æºç 
make download
{% endhighlight %} 

> [BiscuitOS-THP-ShmemHugepage-file-private-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-ShmemHugepage-file-private)
>
> [BiscuitOS ç‹¬ç«‹æ¨¡å—éƒ¨ç½²æ‰‹å†Œ](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001502.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001607.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001624.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001625.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001626.png)

æ¡ˆä¾‹æºç é€šè¿‡ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå±•ç¤ºï¼Œåº”ç”¨ç¨‹åºé¦–å…ˆåœ¨ 31 è¡Œé€šè¿‡ open() å‡½æ•°ä»¥å¯è¯»å¯å†™çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶ BiscuitOS ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ›å»º BiscuitOS æ–‡ä»¶ï¼Œç¨‹åºæ¥ç€åœ¨ 38 è¡Œè°ƒç”¨ write() å‡½æ•°å‘ BiscuitOS æ–‡ä»¶åç«¯å†™å…¥æ•°æ®ã€‚ç„¶åç¨‹åºåœ¨ 41 è¡Œè°ƒç”¨ mmap() å‡½æ•°ï¼Œé€šè¿‡æ–‡ä»¶ç§æœ‰æ˜ å°„çš„æ–¹å¼åˆ†é…äº† BISCUITOS_MAP_SIZE çš„è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡å®å®šä¹‰å¯ä»¥çŸ¥é“è™šæ‹Ÿå†…å­˜å¤§å°ä¸º 8MiBï¼Œè¯¥è™šæ‹Ÿå†…å­˜ç”¨äºæ˜ å°„ BiscuitOS æ–‡ä»¶ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥åœ¨ 57 è¡Œå¯¹è™šæ‹Ÿå†…å­˜è¿›è¡Œè®¿é—®ã€‚ä¸ºäº†è°ƒè¯•æ–¹ä¾¿è¿›ç¨‹åœ¨ 60 è¡Œå¤„è°ƒç”¨ sleep(-1) ä¿æŒä¸é€€å‡º. è‡³æ­¤ç¨‹åºçš„åŠŸèƒ½å®Œç»“ï¼Œæ¡ˆä¾‹ä»£ç å¾ˆç²¾ç®€ï¼Œå¦å¤–å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åéœ€è¦æŒ‚è½½ä¸€ä¸ªå¸¦ "huge=always" å‚æ•°çš„ tmpfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ‰“å¼€è¯¥æ–‡ä»¶, é‚£ä¹ˆæ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åœ¨ BiscuitOS ä¸Šè¿›è¡Œå®è·µ:

{% highlight bash %}
# è¿›å…¥æºç ç›®å½•
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-file-private-default/
# ç¼–è¯‘æºç 
make
# å®‰è£…é©±åŠ¨
make install
# Rootfs æ‰“åŒ…
make pack
# è¿è¡Œ BiscuitOS
make run

# æŒ‚è½½ huge tmpfs
mkdir -p /BiscuitOS-tmpfs/
mount -t tmpfs nodev -o huge=always /BiscuitOS-tmpfs/

# åå°æ–¹å¼è¿è¡Œç¨‹åº
BiscuitOS-THP-ShmemHugepage-file-private-default &

# æŸ¥çœ‹ ShmemHugepage ä½¿ç”¨æƒ…å†µ
cat /proc/meminfo | grep Huge
{% endhighlight %}

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001627.png)

å¯ä»¥çœ‹åˆ°å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åï¼ŒæŒ‚è½½ä¸€ä¸ª huge tmpfs ä¹‹ååœ¨åå°è¿è¡Œåº”ç”¨ç¨‹åº BiscuitOS-THP-ShmemHugepage-file-private-defaultï¼Œæ­¤æ—¶æŸ¥çœ‹ ShmemHugepage çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºæ­¤æ—¶è¿›ç¨‹å ç”¨äº† 1 ä¸ª ShmemHugepage å¤§é¡µï¼Œæ€»å…± 2MiB ç‰©ç†å†…å­˜ï¼Œè¿™ä¸æºç è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜å¯¹åº”. è‡³æ­¤å®è·µå®Œæ¯•ç¬¦åˆé¢„æœŸ.

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C02"></span>

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND00000I.jpg)

#### åŒ¿åç§æœ‰æ˜ å°„: ç›´æ¥åˆ†é…ä¸€ä¸ª AnonHugepage å¤§é¡µ

åœ¨å¯ç”¨é€æ˜å¤§é¡µçš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœå¯¹ THP çš„ç­–ç•¥æ˜¯ always æ—¶ï¼Œå¹¶ä¸”ç³»ç»Ÿç‰©ç†å†…å­˜å¤§äº 512MiBï¼Œé‚£ä¹ˆè¿›ç¨‹é€šè¿‡åŒ¿åç§æœ‰æ–¹å¼åˆ†é… 2MiB è™šæ‹Ÿå†…å­˜æ—¶ï¼Œåªè¦è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜ä»»æ„ä½ç½®æ˜¯ï¼Œç³»ç»Ÿç›´æ¥åˆ†é…ä¸€ä¸ª AnonHugepage ç‰©ç†é¡µä¸ 2MiB è™šæ‹Ÿå†…å­˜å»ºç«‹é¡µè¡¨æ˜ å°„å…³ç³»ã€‚ä¸ºäº†æ›´å¥½å®è·µ AnonHugepagesï¼Œå†…æ ¸å¿…é¡»å¯ç”¨ **CONFIG_TRANSPARENT_HUGEPAGE** å®å’Œ **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** å®, å¹¶ä¸”ç³»ç»Ÿç‰©ç†å†…å­˜å¤§äº 512MiBã€‚æœ¬èŠ‚ç”¨äºä»‹ç»åº”ç”¨ç¨‹åºåˆ†é… AnonHugepage çš„æ–¹æ³•, BiscuitOS æä¾›äº†ä½¿ç”¨æ¡ˆä¾‹ï¼Œå…¶åœ¨ BiscuitOS ä¸Šéƒ¨ç½²é€»è¾‘å¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: å†…æ ¸ç‰ˆæœ¬å­—æ®µ e.g. 5.0
# ARCHITECTURE: æ¶æ„å­—æ®µ e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*]  THP: Alloc an AnonHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-AnonHugepage-default/
# ä¸‹è½½æ¡ˆä¾‹æºç 
make download
{% endhighlight %} 

> [BiscuitOS-THP-AnonHugepage-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-AnonHugepage)
>
> [BiscuitOS ç‹¬ç«‹æ¨¡å—éƒ¨ç½²æ‰‹å†Œ](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001502.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001607.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001616.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001617.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001618.png)

æ¡ˆä¾‹æºç é€šè¿‡ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå±•ç¤ºï¼Œåº”ç”¨ç¨‹åºé¦–å…ˆåœ¨ 29 è¡Œè°ƒç”¨ mmap() å‡½æ•°ï¼Œé€šè¿‡åŒ¿åç§æœ‰æ˜ å°„çš„æ–¹å¼åˆ†é…äº† BISCUITOS_MAP_SIZE çš„è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡å®å®šä¹‰å¯ä»¥çŸ¥é“è™šæ‹Ÿå†…å­˜å¤§å°ä¸º 8MiBï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åœ¨ 44-47 è¡Œåˆ†åˆ«æŒ‰ 2MiB çš„åç§»å¯¹è™šæ‹Ÿå†…å­˜è¿›è¡Œè®¿é—®ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ª 2MiB çš„è™šæ‹ŸåŒºåŸŸéƒ½è¢«è®¿é—®äº†ä¸€æ¬¡ã€‚ä¸ºäº†è°ƒè¯•æ–¹ä¾¿è¿›ç¨‹åœ¨ 50 è¡Œå¤„è°ƒç”¨ sleep(-1) ä¿æŒä¸é€€å‡º. è‡³æ­¤ç¨‹åºçš„åŠŸèƒ½å®Œç»“ï¼Œæ¡ˆä¾‹ä»£ç å¾ˆç²¾ç®€ï¼Œå¦å¤–å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åéœ€è¦è®¾ç½® THP çš„ç­–ç•¥ä¸º always, é‚£ä¹ˆæ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åœ¨ BiscuitOS ä¸Šè¿›è¡Œå®è·µ:

{% highlight bash %}
# ä¿®æ”¹ç³»ç»Ÿç‰©ç†å†…å­˜å¤§äº 512MiB
vi BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/RunBiscuitOS.sh
- RAM_SIZE=512
+ RAM_SIZE=1024

# è¿›å…¥æºç ç›®å½•
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-AnonHugepage-default/
# ç¼–è¯‘æºç 
make
# å®‰è£…é©±åŠ¨
make install
# Rootfs æ‰“åŒ…
make pack
# è¿è¡Œ BiscuitOS
make run

# THP Enable always
echo always > /sys/kernel/mm/transparent_hugepage/enabled

# åå°æ–¹å¼è¿è¡Œç¨‹åº
BiscuitOS-THP-AnonHugepage-default &

# æŸ¥çœ‹ AnonHugepage ä½¿ç”¨æƒ…å†µ
cat /proc/meminfo | grep Huge
{% endhighlight %}

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001619.png)

å¯ä»¥çœ‹åˆ°å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åï¼Œå‘ "/sys/kernel/mm/transparent_hugepage/enabled" å†™å…¥ always æ—¶ï¼Œé‚£ä¹ˆ THP çš„ç­–ç•¥å°±æ˜¯ç›´æ¥åˆ†é…. æ¥ç€åå°è¿è¡Œåº”ç”¨ç¨‹åº BiscuitOS-THP-AnonHugepage-defaultï¼Œæ­¤æ—¶æŸ¥çœ‹ AnonHugepage çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºæ­¤æ—¶è¿›ç¨‹å ç”¨äº† 4 ä¸ª AnonHugepage å¤§é¡µï¼Œæ€»å…± 8MiB ç‰©ç†å†…å­˜ï¼Œè¿™ä¸æºç è®¿é—® 8MiB è™šæ‹Ÿå†…å­˜å¯¹åº”. è‡³æ­¤å®è·µå®Œæ¯•ç¬¦åˆé¢„æœŸ.

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C03"></span>

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND00000M.jpg)

#### åŒ¿åç§æœ‰æ˜ å°„: åˆå¹¶ 4K-Page ä¸º AnonHugepage å¤§é¡µ

åœ¨å¯ç”¨é€æ˜å¤§é¡µçš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœå¯¹ THP çš„ç­–ç•¥æ˜¯ always æ—¶ï¼Œå¹¶ä¸”ç³»ç»Ÿç‰©ç†å†…å­˜å¤§äº 512MiBï¼Œé‚£ä¹ˆè¿›ç¨‹é€šè¿‡åŒ¿åç§æœ‰æ–¹å¼åˆ†é…è™šæ‹Ÿå†…å­˜ï¼Œå¹¶ä¸ 4KiB ç‰©ç†é¡µå»ºç«‹é¡µè¡¨ï¼Œåªè¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆå†…æ ¸ä¼šå°† 4KiB ç‰©ç†é¡µåˆå¹¶æˆä¸€ä¸ª AnonHugePage 2MiB çš„å¤§é¡µ: ç¬¬ä¸€ä¸ªæ¡ä»¶æ˜¯è™šæ‹Ÿå†…å­˜çš„é•¿åº¦ä¸å°äº 2MiB; ç¬¬äºŒä¸ªæ¡ä»¶æ˜¯è™šæ‹Ÿå†…å­˜ä¸­å·²ç»æœ‰ 50% çš„è™šæ‹Ÿå†…å­˜ä¸ 4KiB ç‰©ç†é¡µå»ºç«‹é¡µè¡¨ã€‚åªè¦æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼ŒTHP æœºåˆ¶ç«‹å³å°†è™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°ä¸€ä¸ª 2MiB çš„ AnonHugepage å¤§é¡µä¸Šã€‚ä¸ºäº†æ›´å¥½å®è·µ AnonHugepagesï¼Œå†…æ ¸å¿…é¡»å¯ç”¨ **CONFIG_TRANSPARENT_HUGEPAGE** å®å’Œ **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** å®, å¹¶ä¸”ç³»ç»Ÿç‰©ç†å†…å­˜å¤§äº 512MiBã€‚æœ¬èŠ‚ç”¨äºä»‹ç»åº”ç”¨ç¨‹åºåˆ†é…çš„ 4KiB ç‰©ç†é¡µåˆå¹¶æˆ AnonHugepage çš„æ–¹æ³•, BiscuitOS æä¾›äº†ä½¿ç”¨æ¡ˆä¾‹ï¼Œå…¶åœ¨ BiscuitOS ä¸Šéƒ¨ç½²é€»è¾‘å¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: å†…æ ¸ç‰ˆæœ¬å­—æ®µ e.g. 5.0
# ARCHITECTURE: æ¶æ„å­—æ®µ e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*] THP: Merge Page to AnonHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-AnonHugepage-merge-default/
# ä¸‹è½½æ¡ˆä¾‹æºç 
make download
{% endhighlight %} 

> [BiscuitOS-THP-AnonHugepage-merge-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-AnonHugepage-merge)
>
> [BiscuitOS ç‹¬ç«‹æ¨¡å—éƒ¨ç½²æ‰‹å†Œ](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001502.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001607.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001620.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001621.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001622.png)

æ¡ˆä¾‹æºç é€šè¿‡ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå±•ç¤ºï¼Œç¨‹åºåœ¨ 26-36 è¡Œå®šä¹‰äº†å‡½æ•° BiscuitOS_alloc() å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºä»è¿›ç¨‹çš„åœ°å€ç©ºé—´ vaddr å¤„åˆ†é…é•¿åº¦ä¸º size çš„è™šæ‹Ÿå†…å­˜ï¼Œå¦‚æœå‚æ•° populate ä¸º 1ï¼Œé‚£ä¹ˆå‡½æ•°ä¼šä¸ºåˆ†é…çš„è™šæ‹Ÿå†…å­˜æ˜ å°„å®é™…çš„ 4KiB ç‰©ç†é¡µ. æ¥ç€è¿›å…¥ main() å‡½æ•°ï¼Œåœ¨ 42 è¡Œå¤„åˆ†é…ä¸€æ®µè™šæ‹Ÿå†…å­˜ï¼Œå…¶èŒƒå›´æ˜¯ \[0x6000000000, 0x6000080000), å¹¶ä¸ºè¿™æ®µè™šæ‹Ÿå†…å­˜ç›´æ¥åˆ†é…ç‰©ç†å†…å­˜ä¸ä¹‹å»ºç«‹é¡µè¡¨ï¼Œæ­¤æ—¶å¯ä»¥è·å¾—çš„åŒºé—´å¤§å°ä¸ºä¸€ä¸ªå¤§é¡µçš„ 25%ï¼Œç‰©ç†å†…å­˜ä¹Ÿä¸ºä¸€ä¸ªå¤§é¡µçš„ 25%ã€‚æ¥ç€ 44 è¡Œåˆ†é…ç¬¬äºŒæ®µè™šæ‹Ÿå†…å­˜ï¼Œå…¶èŒƒå›´æ˜¯ \[0x6000080000, 0x6000100000), ä½†æ²¡æœ‰ä¸ºå…¶åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¦å¤–ç”±äºæ–°åˆ†é…çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸä¸ä¸Šä¸€å—åˆ†é…çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸç›¸é‚»ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šå°†å…¶åˆå¹¶æˆä¸€å—æ›´å¤§çš„è™šæ‹ŸåŒºåŸŸï¼Œå…¶èŒƒå›´æ˜¯ \[0x6000000000, 0x6000100000), æ–°çš„è™šæ‹ŸåŒºåŸŸå…¶é•¿åº¦ä¸ºä¸€ä¸ªå¤§é¡µçš„ 50%ï¼Œç‰©ç†å†…å­˜ä¸ºä¸€ä¸ªå¤§é¡µçš„ 25%. ç¨‹åºæ¥ç€åœ¨ 46 è¡Œåˆ†é…ä¸€æ®µè™šæ‹Ÿå†…å­˜ï¼Œå…¶èŒƒå›´æ˜¯ \[0x6000100000, 0x6000140000), å¹¶ä¸ºè¿™æ®µè™šæ‹Ÿå†…å­˜åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¦å¤–ç”±äºæ–°åˆ†é…çš„åŒºåŸŸä¸ä¸Šä¸€å—åŒºåŸŸç›¸é‚»ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†ä¸¤æ®µè™šæ‹Ÿå†…å­˜åŒºåŸŸå†æ¬¡åˆå¹¶æˆä¸€å—æ›´å¤§çš„åŒºåŸŸï¼Œæ­¤æ—¶æ–°åŒºåŸŸçš„èŒƒå›´æ˜¯ \[0x6000000000, 0x6000140000), æ–°çš„è™šæ‹ŸåŒºåŸŸå…¶é•¿åº¦ä¸ºä¸€ä¸ªå¤§é¡µçš„ 62.5%ï¼Œç‰©ç†å†…å­˜ä¸ºä¸€ä¸ªå¤§é¡µçš„ 37.5%. ç¨‹åºç»§ç»­åœ¨ 48 è¡Œåˆ†é…ä¸€æ®µè™šæ‹Ÿå†…å­˜ï¼Œå…¶èŒƒå›´æ˜¯ \[0x6000140000, 0x6000180000), å¹¶ä¸ºè¿™æ®µè™šæ‹Ÿå†…å­˜åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¦å¤–ç”±äºæ–°åˆ†é…çš„åŒºåŸŸä¸ä¸Šä¸€å—åŒºåŸŸç›¸é‚»ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†ä¸¤æ®µè™šæ‹Ÿå†…å­˜åŒºåŸŸå†æ¬¡åˆå¹¶æˆä¸€å—æ›´å¤§çš„åŒºåŸŸï¼Œæ­¤æ—¶æ–°åŒºåŸŸçš„èŒƒå›´æ˜¯ \[0x6000000000, 0x6000180000), æ–°çš„è™šæ‹ŸåŒºåŸŸå…¶é•¿åº¦ä¸ºä¸€ä¸ªå¤§é¡µçš„ 75%ï¼Œç‰©ç†å†…å­˜ä¸ºä¸€ä¸ªå¤§é¡µçš„ 50%, æ­¤æ—¶å·²ç»æ»¡è¶³åˆå¹¶ç‰©ç†å†…å­˜ä¸å°äº 2MiB å¤§é¡µçš„ 50% æ¡ä»¶ï¼Œä½†è™šæ‹Ÿå†…å­˜é•¿åº¦æ²¡æœ‰è¾¾åˆ° 2MiBã€‚ç¨‹åºæ¥ç€åœ¨ 52 è¡Œè¡Œåˆ†é…ä¸€æ®µè™šæ‹Ÿå†…å­˜ï¼Œå…¶èŒƒå›´æ˜¯ \[0x6000180000, 0x6000200000), å¹¶æ²¡æœ‰ä¸ºè¿™æ®µè™šæ‹Ÿå†…å­˜åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¦å¤–ç”±äºæ–°åˆ†é…çš„åŒºåŸŸä¸ä¸Šä¸€å—åŒºåŸŸç›¸é‚»ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†ä¸¤æ®µè™šæ‹Ÿå†…å­˜åŒºåŸŸå†æ¬¡åˆå¹¶æˆä¸€å—æ›´å¤§çš„åŒºåŸŸï¼Œæ­¤æ—¶æ–°åŒºåŸŸçš„èŒƒå›´æ˜¯ \[0x6000000000, 0x6000200000), æ–°çš„è™šæ‹ŸåŒºåŸŸå…¶é•¿åº¦ä¸ºä¸€ä¸ªå¤§é¡µçš„ 100%ï¼Œç‰©ç†å†…å­˜ä¸ºä¸€ä¸ªå¤§é¡µçš„ 50%, æ­¤æ—¶å·²ç»æ»¡è¶³åˆå¹¶çš„ä¸¤ä¸ªæ¡ä»¶ï¼Œç³»ç»Ÿå°† 2MiB åŒºåŸŸä½¿ç”¨çš„ 4KiB ç‰©ç†é¡µåˆå¹¶æˆä¸€ä¸ª 2MiB çš„ AnonHugepage å¤§é¡µ. è‡³æ­¤ç¨‹åºçš„åŠŸèƒ½å®Œç»“ï¼Œæ¡ˆä¾‹ä»£ç å¾ˆç²¾ç®€ï¼Œå¦å¤–å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åéœ€è¦è®¾ç½® THP çš„ç­–ç•¥ä¸º always, é‚£ä¹ˆæ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åœ¨ BiscuitOS ä¸Šè¿›è¡Œå®è·µ:

{% highlight bash %}
# ä¿®æ”¹ç³»ç»Ÿç‰©ç†å†…å­˜å¤§äº 512MiB
vi BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/RunBiscuitOS.sh
- RAM_SIZE=512
+ RAM_SIZE=1024

# è¿›å…¥æºç ç›®å½•
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-AnonHugepage-merge-default/
# ç¼–è¯‘æºç 
make
# å®‰è£…é©±åŠ¨
make install
# Rootfs æ‰“åŒ…
make pack
# è¿è¡Œ BiscuitOS
make run

# THP Enable always
echo always > /sys/kernel/mm/transparent_hugepage/enabled

# åå°æ–¹å¼è¿è¡Œç¨‹åº
BiscuitOS-THP-AnonHugepage-merge-default &

# æŸ¥çœ‹ AnonHugepage ä½¿ç”¨æƒ…å†µ
cat /proc/meminfo | grep Huge
{% endhighlight %}

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001623.png)

å¯ä»¥çœ‹åˆ°å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åï¼Œå‘ "/sys/kernel/mm/transparent_hugepage/enabled" å†™å…¥ always æ—¶ï¼Œé‚£ä¹ˆ THP çš„ç­–ç•¥å°±æ˜¯æ»¡è¶³æ¡ä»¶ç›´æ¥åˆ†é…. æ¥ç€åå°è¿è¡Œåº”ç”¨ç¨‹åº BiscuitOS-THP-AnonHugepage-merge-defaultï¼Œæ­¤æ—¶æŸ¥çœ‹ AnonHugepage çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºæ­¤æ—¶è¿›ç¨‹å ç”¨äº† 1 ä¸ª AnonHugepage å¤§é¡µï¼Œæ€»å…± 2MiB ç‰©ç†å†…å­˜ï¼Œè¿™ä¸æºç è®¿é—® 2MiB è™šæ‹Ÿå†…å­˜å¯¹åº”. è‡³æ­¤å®è·µå®Œæ¯•ç¬¦åˆé¢„æœŸ.

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C04"></span>

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND00000D.jpg)

#### åŒ¿åç§æœ‰æ˜ å°„: Madvise 4K-Page ä¸º AnonHugepage å¤§é¡µ

åœ¨å¯ç”¨é€æ˜å¤§é¡µçš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœå¯¹ THP çš„ç­–ç•¥æ˜¯ madvise æ—¶ï¼Œé‚£ä¹ˆè¿›ç¨‹é€šè¿‡åŒ¿åç§æœ‰æ–¹å¼åˆ†é…è™šæ‹Ÿå†…å­˜ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ madvise() å‡½æ•°ä¸ MADV_HUGEPAGE å‚æ•°é…åˆå°†æŒ‡å®šçš„è™šæ‹Ÿå†…å­˜å¯¹åº”çš„ 4KiB ç‰©ç†é¡µåˆå¹¶ä¸º AnonHugepage å¤§é¡µã€‚madvise() ä½œç”¨çš„ä½ç½®ä¸åŒå¯¼è‡´çš„ç­–ç•¥ä¸åŒï¼Œå¦‚æœè™šæ‹Ÿå†…å­˜å·²ç»æ˜ å°„äº† 4KiB ç‰©ç†é¡µï¼Œé‚£ä¹ˆè°ƒç”¨ madvise() å‡½æ•°ä¼šå°†å¯¹åº”çš„ 4KiB é¡µåˆå¹¶æˆä¸€ä¸ª AnonHugepage å¤§é¡µ; å¦‚æœè™šæ‹Ÿå†…å­˜æ²¡æœ‰æ˜ å°„ä»»ä½• 4KiB ç‰©ç†é¡µï¼Œé‚£ä¹ˆè°ƒç”¨ madvise() å‡½æ•°æ—¶ä¸ä¼šåˆ†é…ä»»ä½• AnonHugepage å¤§é¡µï¼Œåªæœ‰è®¿é—® madvise() æŒ‡å®šè™šæ‹ŸåŒºåŸŸçš„ä»»ä¸€ä¸ªä½ç½®ï¼Œé‚£ä¹ˆç³»ç»Ÿç›´æ¥ä¸ºè™šæ‹ŸåŒºåŸŸåˆ†é…ä¸€ä¸ª AnonHugepage å¤§é¡µ. ä¸ºäº†æ›´å¥½å®è·µ AnonHugepagesï¼Œå†…æ ¸å¿…é¡»å¯ç”¨ **CONFIG_TRANSPARENT_HUGEPAGE** å®å’Œ **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** å®ã€‚æœ¬èŠ‚ç”¨äºä»‹ç»åº”ç”¨ç¨‹åºé€šè¿‡ madvise() å‡½æ•°å°†åˆ†é…çš„ 4KiB ç‰©ç†é¡µåˆå¹¶æˆ AnonHugepage çš„æ–¹æ³•, BiscuitOS æä¾›äº†ä½¿ç”¨æ¡ˆä¾‹ï¼Œå…¶åœ¨ BiscuitOS ä¸Šéƒ¨ç½²é€»è¾‘å¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: å†…æ ¸ç‰ˆæœ¬å­—æ®µ e.g. 5.0
# ARCHITECTURE: æ¶æ„å­—æ®µ e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*] THP: Madvise Page to AnonHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-AnonHugepage-madvise-default/
# ä¸‹è½½æ¡ˆä¾‹æºç 
make download
{% endhighlight %} 

> [BiscuitOS-THP-AnonHugepage-madvise-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-AnonHugepage-madvise)
>
> [BiscuitOS ç‹¬ç«‹æ¨¡å—éƒ¨ç½²æ‰‹å†Œ](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001502.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001607.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001628.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001629.png)
![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001630.png)

æ¡ˆä¾‹æºç é€šè¿‡ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå±•ç¤ºï¼Œç¨‹åºåœ¨ 29-39 è¡Œé€šè¿‡ mmap() å‡½æ•°ä»¥åŒ¿åç§æœ‰çš„æ–¹å¼åˆ†é…äº† 8MiB çš„è™šæ‹Ÿå†…å­˜ï¼Œç”±äºä½¿ç”¨äº† MAP_POPULATE æ ‡å¿—ï¼Œç³»ç»ŸåŒæ—¶åˆ†é…äº† 8MiB çš„ç‰©ç†å†…å­˜å¹¶ä¸è™šæ‹Ÿå†…å­˜å»ºç«‹é¡µè¡¨ã€‚æ¥ç€åœ¨ 45 è¡Œè°ƒç”¨ madvise() å‡½æ•°ç»“åˆ MADV_HUGEPAGE å‚æ•°å»ºè®®å°† \[0x0x6000000000, 0x6000200000) åŒºåŸŸä½¿ç”¨ AnonHugepage å¤§é¡µï¼Œç”±äº madvise() å‡½æ•°ä¹‹å‰è¯¥åŒºåŸŸå…¨éƒ¨ç”± 4KiB çš„ç‰©ç†é¡µæ„æˆï¼Œé‚£ä¹ˆå½“è°ƒç”¨ madvise() å‡½æ•°æ—¶å°±ä¼šç›´æ¥è§¦å‘ 4KiB ç‰©ç†é¡µ Merge åˆ° AnonHugepageã€‚ç¨‹åº 48-50 è¡Œçš„ä½œç”¨æ˜¯å¯¹å‰©ä½™çš„ 3 æ®µ 2MiB è™šæ‹Ÿå†…å­˜è¿›è¡Œè®¿é—®ï¼Œå…¶å¯¹åº”çš„ç‰©ç†å†…å­˜ç”± 4KiB æ„æˆ. è‡³æ­¤ç¨‹åºçš„åŠŸèƒ½å®Œç»“ï¼Œæ¡ˆä¾‹ä»£ç å¾ˆç²¾ç®€ï¼Œå¦å¤–å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åéœ€è¦è®¾ç½® THP çš„ç­–ç•¥ä¸º always, é‚£ä¹ˆæ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åœ¨ BiscuitOS ä¸Šè¿›è¡Œå®è·µ:

{% highlight bash %}
# ä¿®æ”¹ç³»ç»Ÿç‰©ç†å†…å­˜å¤§äº 512MiB
vi BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/RunBiscuitOS.sh
- RAM_SIZE=512
+ RAM_SIZE=1024

# è¿›å…¥æºç ç›®å½•
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-AnonHugepage-madvise-default/
# ç¼–è¯‘æºç 
make
# å®‰è£…é©±åŠ¨
make install
# Rootfs æ‰“åŒ…
make pack
# è¿è¡Œ BiscuitOS
make run

# THP Enable always
echo madvise > /sys/kernel/mm/transparent_hugepage/enabled

# åå°æ–¹å¼è¿è¡Œç¨‹åº
BiscuitOS-THP-AnonHugepage-madvise-default &

# æŸ¥çœ‹ AnonHugepage ä½¿ç”¨æƒ…å†µ
cat /proc/meminfo | grep Huge
{% endhighlight %}

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/HK/TH001631.png)

å¯ä»¥çœ‹åˆ°å½“ç³»ç»Ÿå¯åŠ¨ä¹‹åï¼Œå‘ "/sys/kernel/mm/transparent_hugepage/enabled" å†™å…¥ madvise æ—¶ï¼Œé‚£ä¹ˆ THP çš„ç­–ç•¥å°±æ˜¯å»ºè®®æŒ‡å®šåŒºåŸŸä½¿ç”¨ AnonHugepage. æ¥ç€åå°è¿è¡Œåº”ç”¨ç¨‹åº BiscuitOS-THP-AnonHugepage-madvise-defaultï¼Œæ­¤æ—¶æŸ¥çœ‹ AnonHugepage çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºæ­¤æ—¶è¿›ç¨‹å ç”¨äº† 1 ä¸ª AnonHugepage å¤§é¡µï¼Œæ€»å…± 8MiB ç‰©ç†å†…å­˜ï¼Œè¿™ä¸æºç è®¿é—® 8MiB è™šæ‹Ÿå†…å­˜å¯¹åº”. è‡³æ­¤å®è·µå®Œæ¯•ç¬¦åˆé¢„æœŸ.

![ç­‰å¾…å›¾ç‰‡åŠ è½½](/assets/PDB/BiscuitOS/kernel/IND000100.png)

