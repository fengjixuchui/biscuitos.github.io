---
layout: post
title:  "Early_Res Memory Allocator"
date:   2020-10-24 19:39:30 +0800
categories: [HW]
excerpt: MMU.
tags:
  - MMU
---

![](/assets/PDB/BiscuitOS/kernel/IND00000L0.PNG)

![](/assets/PDB/RPI/RPI100100.png)

#### ç›®å½•

> - [Early_Res å†…å­˜åˆ†é…å™¨åŸç†](#A)
>
> - [Early_Res å†…å­˜åˆ†é…å™¨ä½¿ç”¨](#B)
>
> - [Early_Res å†…å­˜åˆ†é…å™¨å®è·µ](#C)
>
> - [Early_Res å†…å­˜åˆ†é…å™¨æºç åˆ†æ](#D)
>
> - [é™„å½•/æèµ ](#Z0)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000Z.jpg)

#### Early_Res å†…å­˜åˆ†é…å™¨åŸç†

![](/assets/PDB/HK/HK000675.png)

Linux å†…æ ¸åœ¨å¯åŠ¨é˜¶æ®µä» BIOS/CMDLINE ä¸­è·å¾—ç‰©ç†å†…å­˜çš„ç›¸å…³ä¿¡æ¯ï¼Œå¹¶å°†è¿™äº›å†…å­˜ä¿¡æ¯ä¾æ‰˜ E820 å†…å­˜ç®¡ç†å™¨è¿›è¡Œç®¡ç†ã€‚å†…æ ¸å¯åŠ¨åˆ° boot-time é˜¶æ®µï¼ŒE820 å†…å­˜ç®¡ç†å™¨å°†ç³»ç»Ÿå¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸçš„ä¿¡æ¯ä¼ é€’ç»™ Early_Res åˆ†é…å™¨ï¼ŒEarly_Res åˆ†é…å™¨è·å¾—å¯ç”¨ç‰©ç†å†…å­˜ä¿¡æ¯ä¹‹åï¼Œæ„å»ºå¹¶åˆå§‹åŒ– Early_Res åˆ†é…å™¨ï¼Œå¹¶åœ¨æ¥ä¸‹æ¥çš„é˜¶æ®µä¸ºå†…æ ¸å…¶ä»–æ¨¡å—æä¾›ç‰©ç†å†…å­˜çš„åˆ†é…ã€å›æ”¶ã€ä»¥åŠç‰©ç†å†…å­˜åŒºåŸŸçš„é¢„ç•™åŠŸèƒ½ã€‚å½“ç³»ç»Ÿåˆå§‹åŒ–åˆ°ä¸€å®šé˜¶æ®µä¹‹åï¼ŒEarly_Res å†…å­˜åˆ†é…å™¨å°†å¯ç”¨çš„ç‰©ç†å†…å­˜è½¬ç§»ç»™ Buddy åˆ†é…å™¨ï¼Œä»¥ä¾¿ Buddy å†…å­˜åˆ†é…å™¨çš„æ„å»ºï¼Œå½“ä¼ é€’å®Œæ¯•ä¹‹åï¼ŒEarly_Res åˆ†é…å™¨çš„å†å²ä»»åŠ¡å·²ç»å®Œæˆ. å…·ä½“ä»£ç æµç¨‹è¯·å‚è€ƒ:

> [Early_Res æ¶æ„é€»è¾‘åˆ†æ](#D00)

![](/assets/PDB/HK/HK000676.png)

Early_Res åˆ†é…å™¨çš„å®ç°å¾ˆç®€å•ï¼ŒEarly_Res åˆ†é…å™¨ä¸€å…±ç»´æŠ¤ä¸¤ä¸ªæ•°ç»„ï¼Œç¬¬ä¸€ä¸ªæ•°ç»„åä¸º "early_node_map", è¿™ä¸ªæ•°ç»„ç”± struct node_active_region æ•°æ®ç»“æ„æ„æˆã€‚å†…æ ¸åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒE820 å†…å­˜ç®¡ç†å™¨å°†å½“å‰ç³»ç»Ÿå¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸä¿¡æ¯ä¼ é€’ç»™ Early_Res åˆ†é…å™¨ï¼Œæ¯ä¸ªå¯ç”¨å†…å­˜åˆ†é…å™¨ä½¿ç”¨ early_node_map[] æ•°ç»„çš„ä¸€ä¸ªæˆå‘˜ï¼Œnr_nodemap_entries å˜é‡ç”¨äºæè¿° Early_Res åˆ†é…å™¨ä¸­ç»´æŠ¤å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸçš„æ•°é‡; Early_Res åˆ†é…å™¨ç»´æŠ¤çš„ç¬¬äºŒä¸ªæ•°ç»„å°±æ˜¯ "early_res" æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„ç”± struct early_res æ•°æ®ç»“æ„æ„æˆã€‚å½“ Early_Res åˆ†é…å™¨æ–°å¢ä¸€ä¸ªé¢„ç•™åŒºï¼Œé‚£ä¹ˆ early_res æ•°ç»„å°±ä¼šå°†é¢„ç•™åŒºçš„ä¿¡æ¯å¡«å……åˆ°æŒ‡å®šæˆå‘˜é‡Œï¼Œearly_res_count å˜é‡ç»´æŠ¤ early_res[] æ•°ç»„å·²ç»ä½¿ç”¨æˆå‘˜çš„æ•°é‡ã€‚Early_Res åˆ†é…å™¨å¯¹ç‰©ç†å†…å­˜çš„æè¿°éƒ½ä½¿ç”¨åŒºåŸŸè¿›è¡Œæè¿°ï¼Œå³é€šè¿‡èµ·å§‹ç‰©ç†åœ°å€ã€é•¿åº¦ã€ç»“æŸåœ°å€ç­‰ä¿¡æ¯è¿›è¡Œæè¿°ã€‚

Early_Res åˆ†é…å™¨åŸºäºä¸Šé¢çš„é€»è¾‘æ¶æ„å®ç°äº†ç‰©ç†å†…å­˜çš„åˆ†é…ã€å›æ”¶å’Œé¢„ç•™ã€‚å½“éœ€è¦ä» Early_Res åˆ†é…å™¨ä¸­åˆ†é…ç‰©ç†å†…å­˜æ—¶ï¼ŒEarly_Res åˆ†é…å™¨é¦–å…ˆä» early_node_map[] æ•°ç»„ä¸­éå†æ‰€æœ‰çš„æˆå‘˜ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæˆå‘˜ï¼Œè¯¥æˆå‘˜åŒ…å«äº†æŒ‡å®šåˆ†é…èŒƒå›´çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼Œæ¥ç€å‡½æ•°åœ¨è¿™ä¸ªç‰©ç†å†…å­˜åŒºåŸŸæŸ¥æ‰¾ä¸€å—ç¬¦åˆè¦æ±‚çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼Œä¸”è¿™å—ç‰©ç†å†…å­˜åŒºåŸŸä¸åœ¨é¢„ç•™åŒºå†…ï¼Œé‚£ä¹ˆç³»ç»Ÿç›´æ¥å°†è¿™æ®µç‰©ç†å†…å­˜å¯¹åº”çš„è™šæ‹Ÿåœ°å€è¿”å›ç»™è°ƒç”¨è€…; å¦‚æœæœŸåˆæŸ¥æ‰¾åˆ°çš„ç‰©ç†å†…å­˜åŒºåŸŸå·²ç»åœ¨é¢„ç•™åŒºå†…ï¼Œé‚£ä¹ˆ Early_Res åˆ†é…å™¨ç»§ç»­åœ¨ early_node_map æ•°ç»„ä¸­æŸ¥çœ‹å…¶ä»–å¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸã€‚å½“ä½¿ç”¨å®Œä» Early_Res åˆ†é…å™¨ä¸­åˆ†é…çš„ç‰©ç†å†…å­˜ï¼Œé‚£ä¹ˆå°†è¿™äº›ç‰©ç†å†…å­˜å½’è¿˜ç»™ Early_Res åˆ†é…å™¨ï¼ŒEarly_Res åˆ†é…å™¨ä»…ä»…ä» early_res[] æ•°ç»„ä¸­å°†è¿™æ®µç‰©ç†å†…å­˜ä¿¡æ¯æŠ¹é™¤å³å¯. æœ€åå½“éœ€è¦é¢„ç•™ä¸€æ®µç‰©ç†å†…å­˜ï¼Œä»…éœ€å°†é¢„ç•™çš„ç‰©ç†å†…å­˜ä¿¡æ¯å¡«å……åœ¨ early_res[] æ•°ç»„ä¸­å³å¯ã€‚Early_Res åˆ†é…å™¨åˆ†é…ã€é‡Šæ”¾ã€é¢„ç•™å…·ä½“ä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒ:

> [Early_Res åˆ†é…å™¨çš„ä½¿ç”¨](#B)

Early_Res åˆ†é…å™¨çš„å­˜åœ¨ä¸ Bootmem æ˜¯äº’æ–¥çš„ï¼Œå› æ­¤ä¸¤ä¸ªåˆ†é…å™¨ä¹‹é—´ä¸€å®šå­˜åœ¨ä¸å¯è°ƒå’Œçš„å·®å¼‚ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®è‡ªèº«çš„å®é™…æƒ…å†µé€‰æ‹©ä½¿ç”¨ï¼Œä¸¤è€…çš„æ¯”è¾ƒæ€»ç»“å¦‚ä¸‹:

###### ç›¸åŒç‚¹

åœ¨ boot-time é˜¶æ®µä¸ºç³»ç»Ÿå…¶ä»–åŠŸèƒ½æä¾›ç‰©ç†å†…å­˜çš„åˆ†é…ã€å›æ”¶å’Œé¢„ç•™åŠŸèƒ½ã€‚éƒ½æ˜¯ä» E820 å†…å­˜ç®¡ç†å™¨å¤„è·å¾—å¯ç”¨ç‰©ç†å†…å­˜ä¿¡æ¯ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯ç”¨äºæ„å»ºæœ¬èº«åˆ†é…å™¨ï¼Œå½“ç³»ç»Ÿåˆå§‹åŒ–åˆ°ä¸€å®šé˜¶æ®µï¼Œä¸¤ä¸ªåˆ†é…å™¨éƒ½ä¼šå°†ç³»ç»Ÿå¯ç”¨ç‰©ç†å†…å­˜é€šè¿‡ struct page çš„æ–¹å¼ä¼ é€’ç»™ Buddy å†…å­˜åˆ†é…å™¨ï¼Œè€Œé¢„ç•™å†…å­˜åˆ™ä¸ä¼šä¼ é€’ç»™ Buddy å†…å­˜åˆ†é…å™¨ã€‚ä¸¤ä¸ªåˆ†é…å™¨å¯¹å¤–æ¥å£å¯ä»¥å…¼å®¹ï¼Œå…¶ä»–å†…æ ¸å­ç³»ç»Ÿåœ¨ boot-time é˜¶æ®µæ„ŸçŸ¥ä¸åˆ°åº•å±‚å†…å­˜åˆ†é…å™¨æ˜¯ Early_Res æä¾›è¿˜æ˜¯ Bootmem æä¾›ï¼Œä½†éƒ½å¯ä»¥ä½¿ç”¨ç»Ÿä¸€æ¥å£è¿›è¡Œå†…å­˜åˆ†é…
å›æ”¶å’Œé¢„ç•™ã€‚

###### ä¸åŒç‚¹

Bootmem åˆ†é…å™¨ä½¿ç”¨ bitmap è¿›è¡Œç®¡ç†ï¼Œå…¶ä¼šä¸ºä½ç«¯ç‰©ç†å†…å­˜çš„æ¯ä¸ª PAGE_SIZE é•¿åº¦çš„ç‰©ç†å†…å­˜åŒºåŸŸåˆ†é…ä¸€ä¸ª bitï¼Œå½“ä½ç«¯ç‰©ç†å†…å­˜ç‰¹åˆ«å·¨å¤§çš„æ—¶å€™ï¼Œä¸” boot-time é˜¶æ®µç‰©ç†å†…å­˜åˆ†é…è·å¾—ä¸æ˜¯å¾ˆé¢‘ç¹ï¼Œè€Œä¸”åˆ†é…çš„ç‰©ç†å†…å­˜ä¹Ÿä¸å¤šï¼Œè¿™æ ·å¤§é¢ç§¯çš„ bitmap åŠ¿å¿…é€ æˆç‰©ç†å†…å­˜çš„æµªè´¹ã€‚Early_Res åˆ†é…å™¨åˆ™ä½¿ç”¨å†…å­˜åŒºåŸŸçš„æ¦‚å¿µç®¡ç†ç‰©ç†å†…å­˜åŒºåŸŸï¼Œå¥½å¤„æ˜¯åœ¨åˆ†é…ä¸æ˜¯å¾ˆé¢‘ç¹å’Œåˆ†é…çš„ç‰©ç†å†…å­˜ä¸æ˜¯å¾ˆå¤šçš„æƒ…å†µä¸‹ï¼ŒEarly_Res åˆ†é…å™¨ç®¡ç†æ•°æ®æ–¹é¢æœ¬çœä¼šå ç”¨å¾ˆå°‘çš„ç‰©ç†å†…å­˜ã€‚æœ€å Early_Res åˆ†é…å™¨çš„åˆå§‹åŒ–æ—©äº Bootmem åˆ†é…å™¨.

----------------------------------

<span id="B"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000T.jpg)

#### Early_Res å†…å­˜åˆ†é…å™¨çš„ä½¿ç”¨

Early_Res åˆ†é…å™¨å’Œ Bootmem åˆ†é…å™¨æ˜¯äº’æ–¥å­˜åœ¨çš„ï¼Œå› æ­¤ Early_Res åˆ†é…å™¨ä¹Ÿè¦æä¾› Bootmem åˆ†é…å™¨èƒ½æä¾›çš„åŸºç¡€å†…å­˜åˆ†é…å™¨è¡Œä¸º:

> [> åˆ†é…ä¸€æ®µç‰©ç†å†…å­˜](#B0)
>
> [> é‡Šæ”¾ä¸€æ®µç‰©ç†å†…å­˜](#B1)
>
> [> é¢„ç•™ä¸€æ®µç‰©ç†å†…å­˜](#B2)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

--------------------------

<span id="B0"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000I.jpg)

#### åˆ†é…ä¸€æ®µç‰©ç†å†…å­˜

Early_Res å†…å­˜åˆ†é…å™¨åœ¨ Boot Stage é˜¶æ®µæä¾›äº†æ¥å£ç”¨äºä¸åŒåœºæ™¯çš„ç‰©ç†å†…å­˜åˆ†é…ï¼Œç”±äº Early_Res å†…å­˜åˆ†é…å™¨äº’æ–¥ï¼Œå› æ­¤ä¸€äº› Bootmem çš„åˆ†é…æ¥å£ä¹Ÿå¯ä»¥ç”¨äºä» Early_Res åˆ†é…å™¨ä¸­åˆ†é…ç‰©ç†å†…å­˜ï¼Œä¸è¿‡ Early_Res åˆ†é…å™¨ä¹Ÿæä¾›çš„ç‹¬ç«‹çš„æ¥å£ç”¨äºç‰©ç†å†…å­˜åˆ†é…ï¼Œå…·ä½“æ¥å£å¦‚ä¸‹:

> [find_early_area](#D30003)
>
> [find_early_area_size](#D30025)
>
> [alloc_bootmem](/blog/HISTORY-bootmem/#D30018)
>
> [alloc_bootmem_low](/blog/HISTORY-bootmem/#D30028)
>
> [alloc_bootmem_low_pages](/blog/HISTORY-bootmem/#D30029)
>
> [alloc_bootmem_low_pages_node](/blog/HISTORY-bootmem/#D30030)
>
> [alloc_bootmem_node](/blog/HISTORY-bootmem/#D30024)
>
> [alloc_bootmem_pages](/blog/HISTORY-bootmem/#D30020)
>
> [alloc_bootmem_pages_node](/blog/HISTORY-bootmem/#D30025)
>
> [alloc_bootmem_pages_node_nopanic](/blog/HISTORY-bootmem/#D30026)
>
> [alloc_bootmem_pages_nopanic](/blog/HISTORY-bootmem/#D30021)
>
> [alloc_bootmem_nopanic](/blog/HISTORY-bootmem/#D30019)

ä½¿ç”¨ Early_Res åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¯ä»¥ä½¿ç”¨å…¼å®¹ Bootmem åˆ†é…å™¨æä¾›çš„æ¥å£ã€‚åŒç† Bootmem å†…å­˜åˆ†é…å™¨ç›¸å…³çš„æ¥å£å¯ä»¥å‚è€ƒå¦‚ä¸‹è¿›è¡Œä½¿ç”¨:

> [Bootmem å†…å­˜åˆ†é…åˆ†é…ç‰©ç†å†…å­˜](/blog/HISTORY-bootmem/#B000)

åœ¨å†…æ ¸ Boot-time é˜¶æ®µé€šè¿‡ Early_Res åˆ†é…å™¨åˆ†é…ä¸€æ®µç‰©ç†å†…å­˜ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç  (è¿™é‡Œ Boot Stage é˜¶æ®µç‰¹æŒ‡ start_kernel()->mm_init() å‡½æ•°ä¹‹å‰>çš„é˜¶æ®µ):

{% highlight c %}
#include <linux/bootmem.h>

static int BiscuitOS_Demo(void)
{
        char *buffer = NULL;
        int size = 0x20;

        /* Alloc memory from Early_Res */
        buffer = (char *)alloc_bootmem(size);
        if (!buffer) {
                printk("ERROR: Alloc memory failed.\n");
                return -ENOMEM;
        }

        /* Use */
        sprintf(buffer, "BiscuitOS-%s", "Buddy");
        printk("=> %s\n", buffer);

        return 0;
}
{% endhighlight %}

åœ¨ä¸Šé¢ä¾‹å­ä¸­ï¼Œè°ƒç”¨ alloc_bootmem() å‡½æ•°ä» Bootmem åˆ†é…å™¨ä¸­åˆ†é…é•¿åº¦ä¸º 0x20 çš„ç‰©ç†å†…å­˜ï¼Œå¹¶è¿”å›ç‰©ç†å†…å­˜å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œç„¶åä½¿ç”¨è¿™æ®µå†…å­˜å­˜å‚¨ä¸€æ®µå­—ç¬¦ä¸²ï¼Œå¹¶ä½¿ç”¨ printk æ‰“å°è¿™æ®µå­—ç¬¦ä¸²ã€‚å¦‚æœå°†è¿™ä¸ªå‡½æ•°æ”¾åˆ° start_kernel() å‡½æ•°é‡Œé¢ mm_init() çš„å‰é¢è¿›è¡Œè°ƒç”¨ï¼Œé‚£ä¹ˆè¿è¡Œç»“æœå¦‚ä¸‹:

![](/assets/PDB/HK/HK000674.png)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

--------------------------

<span id="B1"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000I.jpg)

#### é‡Šæ”¾ä¸€æ®µç‰©ç†å†…å­˜

å½“ Boot-time é˜¶æ®µä» Early_Res åˆ†é…å™¨ä¸­åˆ†é…ä¸€æ®µç‰©ç†å†…å­˜ä¹‹åï¼Œå½“ä½¿ç”¨å®Œæ¯•ä¹‹åï¼Œéœ€è¦å°†è¿™æ®µç‰©ç†å†…å­˜å½’è¿˜ç»™ Early_Res åˆ†é…å™¨ã€‚Early_Res æä¾›äº†ç”¨äºç‰©ç†å†…å­˜å›æ”¶çš„å‡½æ•°ï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç è¿›è¡Œä½¿ç”¨ (è¿™é‡Œ Boot Stage é˜¶æ®µç‰¹æŒ‡ start_kernel()->mm_init() å‡½æ•°ä¹‹å‰>çš„é˜¶æ®µ):

{% highlight c %}
#include <linux/bootmem.h>

static int BiscuitOS_Demo(void)
{
        char *buffer = NULL;
        int size = 0x20;

        /* Alloc memory from Early_Res */
        buffer = (char *)alloc_bootmem(size);
        if (!buffer) {
                printk("ERROR: Alloc memory failed.\n");
                return -ENOMEM;
        }

        /* Use */
        sprintf(buffer, "BiscuitOS-%s", "Buddy");
        printk("=> %s\n", buffer);

	/* Free */
	free_early(__pa(buffer), __pa(buffer) + size);

        return 0;
}
{% endhighlight %}

åœ¨ä¸Šé¢ä¾‹å­ä¸­ï¼Œè°ƒç”¨ alloc_bootmem() å‡½æ•°ä» Bootmem åˆ†é…å™¨ä¸­åˆ†é…é•¿åº¦ä¸º 0x20 çš„ç‰©ç†å†…å­˜ï¼Œå¹¶è¿”å›ç‰©ç†å†…å­˜å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œç„¶åä½¿ç”¨è¿™æ®µå†…å­˜å­˜å‚¨ä¸€æ®µå­—ç¬¦ä¸²ï¼Œå¹¶ä½¿ç”¨ printk æ‰“å°è¿™æ®µå­—ç¬¦ä¸²ã€‚å¦‚æœå°†è¿™ä¸ªå‡½æ•°æ”¾åˆ° start_kernel() å‡½æ•°é‡Œé¢ mm_init() çš„å‰é¢è¿›è¡Œè°ƒç”¨ï¼Œé‚£ä¹ˆè¿è¡Œç»“æœå¦‚ä¸‹:

![](/assets/PDB/HK/HK000674.png)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

--------------------------

<span id="B2"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000I.jpg)

#### é¢„ç•™ä¸€æ®µç‰©ç†å†…å­˜

å½“ Boot-time é˜¶æ®µä» Early_Res åˆ†é…å™¨ä¸­é¢„ç•™ä¸€æ®µç‰©ç†å†…å­˜ï¼Œè¿™æ®µç‰©ç†å†…å­˜å°±ä¼šè¢«åŠ å…¥åˆ° Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…ã€‚Early_Res åˆ†é…å™¨æä¾›äº†ç‹¬ç«‹çš„å‡½æ•°å®ç°è¯¥åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Bootmem åˆ†é…å™¨æä¾›çš„æ¥å£è¿›è¡Œé¢„ç•™ã€‚Early_Res æä¾›äº†ç”¨äºç‰©ç†å†…å­˜é¢„ç•™çš„å‡½æ•°ï¼Œ>å¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç è¿›è¡Œä½¿ç”¨ (è¿™é‡Œ Boot Stage é˜¶æ®µç‰¹æŒ‡ start_kernel()->mm_ini
t() å‡½æ•°ä¹‹å‰>çš„é˜¶æ®µ):

{% highlight c %}
#include <linux/bootmem.h>

static int BiscuitOS_Demo(void)
{
	u64 start = 0x10000000;
	u64 size  = 0x100000;
	u64 end   = start + size;

	/* Reserve memory */
	reserve_early(start, end, "BiscuitOS");

        return 0;
}
{% endhighlight %}

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè°ƒç”¨ reserve_early() å‡½æ•°å°†ç‰©ç†å†…å­˜åŒºåŸŸ 0x10000000 - 0x10100000 è¿›è¡Œäº†é¢„ç•™. å¯ä»¥å°†è¿™ä¸ªå‡½æ•°æ”¾åˆ° start_kernel() å‡½æ•°é‡Œé¢ mm_init() çš„å‰é¢è¿›è¡Œè°ƒç”¨ã€‚

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------------------

<span id="C"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000F.jpg)

#### Early_Res åˆ†é…å™¨å®è·µ

> - [å®è·µå‡†å¤‡](#C1000)
>
> - [å®è·µéƒ¨ç½²](#C1001)
>
> - [å®è·µæ‰§è¡Œ](#C1002)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

--------------------------------------------

#### <span id="C1000">å®è·µå‡†å¤‡</span>

æœ¬å®è·µåªæ”¯æŒ i386 æ¶æ„å’Œ X86_64 æ¶æ„ï¼Œå…¶åªæ”¯æŒä½ç‰ˆæœ¬å†…æ ¸ï¼Œæœ¬æ–‡ä»¥ linux 2.6.36 i386 æ¶æ„è¿›è¡Œè®²è§£ï¼Œè‡³äº x86 æ¶æ„å®è·µå¯ä»¥å‚è€ƒ i386 è¿›è¡Œå®è·µ. é¦–å…ˆå¼€å‘è€…éœ€è¦æ­å»ºåŸºäº i386 ç»“æ„çš„ linux 2.6.36 å®è·µç¯å¢ƒï¼Œè¯·å‚è€ƒå¦‚ä¸‹é—®é¢˜:

> [> BiscuitOS Linux 2.x i386 Usermanual](/blog/Linux-2.x-i386-Usermanual/#header)
>
> [> BiscuitOS Linux 2.x x86_64 Usermanual](/blog/Linux-2.x-x86_64-Usermanual/)

--------------------------------------------

#### <span id="C1001">å®è·µéƒ¨ç½²</span>

åœ¨éƒ¨ç½²å®Œæ¯•å¼€å‘ç¯å¢ƒä¹‹åï¼Œå¼€å‘è€…åº”è¯¥ç¡®ä¿ä¸€ä¸‹å†…æ ¸å®æ˜¯æ‰“å¼€çš„ï¼Œå‚è€ƒå¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/output/linux-2.6.36-i386/linux/linux
make ARCH=i386 menuconfig

  Processor type and features  --->
    [*] Disable Bootmem code
{% endhighlight %}

å¼€å‘è€…ä¸€å®šè¦ç¡®è®¤ä¸Šé¢çš„é€‰é¡¹æ˜¯å¼€å¯çš„çš„ï¼Œç¡®è®¤ä¿®æ”¹ä¹‹åé‡æ–°ç¼–è¯‘å†…æ ¸ä½¿ç”¨ã€‚

--------------------------------------------

#### <span id="C1002">å®è·µæ‰§è¡Œ</span>

ç¯å¢ƒéƒ¨ç½²å®Œæ¯•ä¹‹åï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥è¿è¡Œ BiscuitOS, æ­¤æ—¶ boot-time é˜¶æ®µä½¿ç”¨çš„å°±æ˜¯ Early_Res åˆ†é…å™¨. è¿è¡Œçš„æƒ…å†µï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

{% highlight bash %}
cd BiscuitOS/output/linux-5.0-i386/
./RunBiscuitOS.sh
{% endhighlight %}

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="D"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000B.jpg)

#### Early_Res åˆ†é…å™¨æºç åˆ†æ

> - [Early_Res åˆ†é…å™¨æ¶æ„](#D00)
>
> - Early_Res åˆ†é…å™¨æ•°æ®ç»“æ„
>
>   - [struct node_active_region](#D201)
>
>   - [early_node_map](#D202)
>
>   - [struct early_res](#D205)
>
>   - [early_res](#D206)
>
>   - [early_res_count](#D207)
>
>   - [max_early_res](#D204)
>
>   - [nr_nodemap_entries](#D203)
>
> - Early_Res åˆ†é…å™¨ API
>
>   - [add_active_range](#D30000)
>
>   - [\_\_\_alloc_bootmem_nopanic](#D30013)
>
>   - [\_\_alloc_bootmem_nopanic](#D30014)
>
>   - [\_\_alloc_memory_core_early](#D30009)
>
>   - [bad_addr](#D30002)
>
>   - [bad_addr_size](#D30024)
>
>   - [\_\_check_and_double_early_res](#D30007)
>
>   - [drop_range](#D30015)
>
>   - [drop_range_partial](#D30018)
>
>   - [drop_overlaps_that_are_ok](#D30022)
>
>   - [find_early_area](#D30003)
>
>   - [find_early_area_size](#D30025)
>
>   - [find_e820_area](#D30004)
>
>   - [find_fw_memmap_area](#D30005)
>
>   - [find_overlapped_early](#D30001)
>
>   - [first_active_region_index_in_nid](#D30010)
>
>   - [for_each_active_range_index_in_nid](#D30012)
>
>   - [free_bootmem](#D30017)
>
>   - [free_early](#D30016)
>
>   - [free_early_partial](#D30019)
>
>   - [get_max_mapped](#D30006)
>
>   - [next_active_region_index_in_nid](#D30011)
>
>   - [\_\_reserve_early](#D30020)
>
>   - [reserve_early](#D30023)
>
>   - [reserve_early_overlap_ok](#D30021)
>
>   - [reserve_early_without_check](#D30008)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

--------------------------------------

<span id="D00"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000M.jpg)

#### Early_Res åˆ†é…å™¨æ¶æ„

![](/assets/PDB/HK/HK000664.png)

Early_Res åˆ†é…å™¨ä¸ Bootmem åˆ†é…å™¨æ˜¯äº’æ–¥å­˜åœ¨çš„ï¼Œå½“ç³»ç»Ÿå¯ç”¨çš„ CONFIG_NO_BOOTMEM å®ä¹‹åï¼ŒX86 æ¶æ„çš„ç³»ç»Ÿå°†åœ¨ Buddy åˆ†é…å™¨åˆå§‹åŒ–ä¹‹å‰çš„æœ€åä¸€ä¸ªç‰©ç†å†…å­˜åˆ†é…å™¨ã€‚ä¸ Bootmem åˆ†é…å™¨ä¸€æ ·ï¼ŒEarly_Res åˆ†é…å™¨ä» E820 å†…å­˜ç®¡ç†å™¨ä¸­è·å¾—å¯ç”¨ç‰©ç†å†…å­˜ä¿¡æ¯ä¹‹åï¼ŒåŸºäºè¿™äº›ä¿¡æ¯æ„å»º Early_Res åˆ†é…å™¨ï¼Œå¹¶ä¸ºç³»ç»Ÿå…¶ä»–æ¨¡å—æä¾›ç‰©ç†å†…å­˜çš„åˆ†é…ã€å›æ”¶ã€ä»¥åŠé¢„ç•™ä½œç”¨ã€‚å†…æ ¸åˆå§‹åŒ–åˆ° mem_init() å‡½æ•°ä¹‹åï¼ŒEarly_Res åˆ†é…å™¨å°†æ‰€æœ‰å¯ç”¨çš„ç‰©ç†å†…å­˜ä¼ é€’ç»™ Buddy åˆ†é…å™¨ï¼Œè‡³æ­¤ Early_Res åˆ†é…å™¨çš„ä»»åŠ¡å®Œæˆã€‚

> [> initmem_init](#D001)
>
> [> mem_init](#D002)
>
> [> free_all_memory_core_early](#D003)
>
> [> get_free_all_memory_range](#D004)
>
> [> \_\_free_pages_memory](#D005)

<span id="D001"></span>

![](/assets/PDB/HK/HK000665.png)

X86 æ¶æ„å†…æ ¸åˆå§‹åŒ–åˆ° initmem_init() å‡½æ•°ï¼Œæ— è®ºæ”¯æŒé«˜ç«¯ç‰©ç†å†…å­˜ï¼Œåœ¨ E820 å†…å­˜ç®¡ç†å™¨åˆå§‹åŒ–å®Œæ¯•ä¹‹åï¼Œå‡½æ•°é€šè¿‡è°ƒç”¨ e820_register_active_regions() å‡½æ•°å°†æ‰€æœ‰å¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸåŠ å…¥åˆ° Early_Res åˆ†é…å™¨çš„ early_node_map[] æ•°ç»„ï¼Œè¯¥æ•°ç»„å°±æ˜¯ Early_Res åˆ†é…å™¨çš„æ ¸å¿ƒï¼Œæ•°ç»„åŒ…å«äº†å¤šä¸ªå¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸã€‚å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åï¼ŒEarly_Res åˆ†é…å™¨å·²ç»è·å¾—ç³»ç»Ÿæ‰€æœ‰å¯ç”¨ç‰©ç†å†…å­˜ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥ Early_Res åˆ†é…å™¨ä¸ºç³»ç»Ÿå…¶ä»–æ¨¡å—æä¾›ç‰©ç†å†…å­˜çš„åˆ†é…ã€å›æ”¶å’Œé¢„ç•™åŠŸèƒ½ã€‚

> [add_active_range](#D30000)
>
> [> find_early_area: ä» Early_Res åˆ†é…å™¨ä¸­åˆ†é…ç‰©ç†å†…å­˜](#D30003)
>
> [> free_early: é‡Šæ”¾ç‰©ç†å†…å­˜åˆ° Early_Res åˆ†é…å™¨](#D30016)
>
> [> reserve_early: åœ¨ Early_Res åˆ†é…å™¨é¢„ç•™ä¸€å—ç‰©ç†å†…å­˜](#D30023)

<span id="D002"></span>

![](/assets/PDB/HK/HK000666.png)

å†…æ ¸åˆå§‹åŒ–åˆ°ä¸€å®šé˜¶æ®µä¹‹åï¼Œå‡½æ•°åœ¨ mem_init() å‡½æ•°å†…ä¼šå°† Early_Res åˆ†é…å™¨ç®¡ç†çš„å¯ç”¨ç‰©ç†å†…å­˜è½¬ç§»ç»™ Buddy å†…å­˜åˆ†é…å™¨. å¦‚ä¸Šå›¾ï¼Œå‡½æ•°è°ƒç”¨ free_all_bootmem() å‡½æ•°å®ç°è½¬æ¢ã€‚

![](/assets/PDB/HK/HK000667.png)

åœ¨ free_all_bootmem å‡½æ•°é‡Œï¼ŒEarly_Res åˆ†é…å™¨è°ƒç”¨ free_all_memory_core_early() å‡½æ•°å°†å¯ç”¨ç‰©ç†å†…å­˜è½¬ç§»ç»™ Buddy åˆ†é…å™¨.

<span id="D003"></span>

![](/assets/PDB/HK/HK000668.png)

åœ¨ free_all_memory_core_early() å‡½æ•°ä¸­ï¼Œå‡½æ•°é¦–å…ˆè°ƒç”¨ get_free_all_memory_range() å‡½æ•°å°† Early_Res å†…å­˜åˆ†é…å™¨ç®¡ç†çš„ç‰©ç†å†…å­˜è½¬æ¢ä¸º struct range è¿›è¡Œç»´æŠ¤ï¼Œç„¶åå°† Early_Res åˆ†é…å™¨ä¸­çš„é¢„ç•™åŒºä» struct range ç»´æŠ¤çš„åŒºåŸŸä¸­ç§»é™¤ï¼Œæœ€ååœ¨å¯¹æ‰€æœ‰ range è¿›è¡Œæ’åºï¼Œæœ€åè¿”å› range æ•°ç»„.

<span id="D004"></span>

![](/assets/PDB/HK/HK000669.png)

get_free_all_memory_range() å‡½æ•°ä¸»è¦ç”¨äºä» Early_Res åˆ†é…å™¨ä¸­è·å¾—æœ€ç»ˆå¯ä»¥çš„ç‰©ç†å†…å­˜ã€‚å‡½æ•°é¦–å…ˆé€šè¿‡ find_fw_memmap_area() å‡½æ•°é€šè¿‡ Early_Res åˆ†é…å™¨åˆ†é…ä¸€å—ç‰©ç†å†…å­˜ç”¨äºå­˜å‚¨ç³»ç»Ÿ struct range æ•°ç»„.

![](/assets/PDB/HK/HK000670.png)

get_free_all_memory_range() å‡½æ•°æ¥ç€åœ¨ 430 è¡Œè°ƒç”¨ add_from_early_node_map() å‡½æ•°å°† Early_Res åˆ†é…å™¨ä¸­æ‰€æœ‰å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸå¡«å……åˆ° struct range æ•°ç»„é‡Œï¼Œæ¥ç€è°ƒç”¨ subtract_early_res() å‡½æ•°å°† Early_Res åˆ†é…å™¨ä¸­é¢„ç•™åŒºä¸­çš„ç‰©ç†å†…å­˜åŒºåŸŸä» struct range æ•°ç»„ä¸­å¯¹åº”çš„åŒºåŸŸç§»é™¤ï¼Œç§»é™¤å®Œæ¯•ä¹‹åè°ƒç”¨ clean_sort_range() å‡½æ•°æ¸…é›¶ä¸€ä¸‹ struct range æ•°ç»„å’Œé‡æ–°æ’åº struct range æ•°ç»„ã€‚æœ€åå‡½æ•°åœ¨ 438-443 è¡Œå°† Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºåŸŸå…¨éƒ¨æ¸…é™¤ï¼Œæœ€åå°† struct range æ•°ç»„çš„åœ°å€å­˜å‚¨åˆ° rangep å‚æ•°ï¼Œå¹¶è¿”å› struct range æ•°ç»„çš„ä¸ªæ•°ã€‚

<span id="D005"></span>

![](/assets/PDB/HK/HK000671.png)

\_\_free_pages_memory() å‡½æ•°çš„ä½œç”¨å°±æ˜¯å°† Early_Res åˆ†é…å™¨ä¸­æœ€åè·å¾—å¯ä»¥ç‰©ç†å†…å­˜å­˜å‚¨åœ¨ struct range æ•°ç»„ä¸­ï¼Œè¯¥æ•°ç»„çš„æ¯ä¸ªæˆå‘˜å°±æ˜¯ä¸€æ®µå¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼Œå‡½æ•°å°†æ¯æ®µå¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸæœ€ç»ˆé€šè¿‡ pfn_to_page() å‡½æ•°è·å¾—å¯¹åº”çš„ struct page ç»“æ„ï¼Œæœ€åè°ƒç”¨ \_\_free_pages_bootmem() å‡½æ•°å°†è¿™äº›ç‰©ç†é¡µä¼ é€’ç»™ Buddy ç‰©ç†å†…å­˜åˆ†é…å™¨ã€‚è‡³æ­¤ï¼ŒEarly_Res åˆ†é…å™¨ä»»åŠ¡å®Œæˆã€‚

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D207">early_res_count</span>

{% highlight bash %}
static int early_res_count __initdata;
{% endhighlight %}

early_res_count å˜é‡ç”¨äºæè¿° Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºåŸŸä¸­é¢„ç•™åŒºçš„æ•°é‡.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D206">early_res</span>

{% highlight bash %}
static struct early_res early_res_x[MAX_EARLY_RES_X] __initdata;

static struct early_res *early_res __initdata = &early_res_x[0];
{% endhighlight %}

early_res æ•°ç»„ç”¨äºå­˜å‚¨ Early_Res åˆ†é…å™¨çš„æ‰€æœ‰é¢„ç•™å†…å­˜åŒºã€‚

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D205">struct early_res</span>

![](/assets/PDB/HK/HK000672.png)

struct early_res æ•°æ®ç»“æ„ç”¨äºæè¿° Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºä¸­çš„ä¸€ä¸ªé¢„ç•™ç‰©ç†å†…å­˜åŒºåŸŸã€‚start å’Œ end æˆå‘˜ç”¨äºæè¿°é¢„ç•™åŒºåŸŸçš„èŒƒå›´ï¼Œæˆå‘˜ name ç”¨äºæè¿°é¢„ç•™åŒºçš„åå­—ï¼Œæˆå‘˜ overlap_ok ç”¨äºæè¿°é¢„ç•™åŒºæ˜¯å¦å¯ä»¥é‡å ï¼Œ1 ä»£è¡¨æ”¯æŒé‡å ï¼Œ0 ä»£è¡¨ä¸æ”¯æŒé‡å .

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30025">find_early_area_size</span>

![](/assets/PDB/HK/HK000673.png)

find_early_area_size() å‡½æ•°ç”¨äºä» Early_Res åˆ†é…å™¨ä¸­æ‰¾åˆ°ä¸€å—å¯ç”¨çš„ç‰©ç†å†…å­˜ã€‚å‚æ•° ei_start å’Œ ei_last è¡¨ç¤ºä¸€å—å¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼Œstart å’Œ sizep å‚æ•°ç”¨äºæŒ‡å‘éœ€è¦æŸ¥æ‰¾çš„ä¸€å—ç‰©ç†å†…å­˜ï¼Œalign å‚æ•°ç”¨äºå¯¹é½ã€‚

å‡½æ•°åœ¨ 574-577 è¡Œç”¨äºé‡æ–°å®šä½æŸ¥æ‰¾åŒºåŸŸçš„èŒƒå›´ï¼Œå‡½æ•° 579 è¡Œç”¨äºé‡æ–°è®¡ç®— sizep çš„é•¿åº¦ï¼Œå³ä¸€å—å­˜åœ¨ç‰©ç†å†…å­˜çš„èŒƒå›´ï¼Œæ¥ç€å‡½æ•°è°ƒç”¨ while å¾ªç¯ï¼Œå¹¶åœ¨å¾ªç¯ä¸­è°ƒç”¨ bad_addr_size() å‡½æ•°åœ¨æŒ‡å®šçš„ç‰©ç†å†…å­˜åŒºåŸŸèŒƒå›´å†…æŸ¥æ‰¾ä¸€å—å¯ç”¨çš„ç‰©ç†å†…å­˜ï¼Œå¦‚æœè¿™å—ç‰©ç†å†…å­˜å·²ç»é¢„ç•™ï¼Œé‚£ä¹ˆå‡½æ•°ç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€å—å¯ç”¨çš„ç‰©ç†å†…å­˜ï¼ŒçŸ¥é“éå†å®Œæ‰€æœ‰å¯ç”¨ç‰©ç†å†…å­˜ä¸ºæ­¢ã€‚å½“éå†ç»“æŸä¹‹åï¼Œå‡½æ•°åœ¨ 582 è¡Œè®¡ç®—æ‰¾åˆ°çš„ä¸€å—åŒºåŸŸçš„ç»“æŸåœ°å€ï¼Œå¦‚æœ last åœ°å€å°äºå½“å‰ç‰©ç†å†…å­˜åŒºåŸŸçš„ç»“æŸåœ°å€ï¼Œé‚£ä¹ˆå‡½æ•°å°†è¿”å›æ‰¾åˆ°çš„èµ·å§‹ç‰©ç†åœ°å€ã€‚åä¹‹è¿”å›é”™è¯¯ã€‚

> [bad_addr_size](#D30024)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30024">bad_addr_size</span>

![](/assets/PDB/HK/HK000663.png)

bad_addr_size() å‡½æ•°ç”¨äºç¡®è®¤æŸä¸ªé¢„ç•™åŒºçš„èŒƒå›´æ˜¯å¦æ”¹å˜ï¼Œå¹¶è·å¾—æœ€æ–°çš„èŒƒå›´ã€‚å‚æ•° addrp å’Œ sizep å‚æ•°ç”¨äºæŒ‡å‘ä¸€ä¸ªé¢„ç•™åŒºèŒƒå›´ï¼Œalign å‚æ•°ç”¨äºå¯¹é½ã€‚å‡½æ•°é¦–å…ˆåœ¨ 510 å’Œ 511 è¡Œè·å¾—æœŸæœ›é¢„ç•™åŒºçš„èŒƒå›´ï¼Œç„¶ååœ¨ 514 è¡Œè·å¾—æœŸæœ›é¢„ç•™åŒºçš„ç»“æŸåœ°å€ã€‚å‡½æ•°ä½¿ç”¨ for å¾ªç¯éå† Early_Res åˆ†é…å™¨é¢„ç•™åŒºåŸŸå†…çš„æ‰€æœ‰é¢„ç•™åŒºï¼Œæ¯å½“éå†ä¸€ä¸ªé¢„ç•™åŒºï¼Œå¦‚æœéå†åˆ°çš„é¢„ç•™åŒºä¸æœŸç›¼çš„é¢„ç•™åŒºæ­£å¥½é‡åˆï¼Œé‚£ä¹ˆå‡½æ•°å°† sizep çš„å€¼åŠ  1 å¹¶è¿”å›; åä¹‹éå†åˆ°çš„é¢„ç•™åŒºå’ŒæœŸç›¼çš„é¢„ç•™åŒºå­˜åœ¨éƒ¨åˆ†é‡åˆï¼Œé‚£ä¹ˆå‡½æ•°é‡æ–°è®¡ç®— size çš„å€¼ï¼Œå¹¶æ›´æ–° addr çš„å€¼ï¼Œç„¶åå°† changed è®¾ç½®ä¸º 1ï¼Œä»¥æ­¤è¡¨ç¤ºä¸æœŸç›¼çš„é¢„ç•™åŒºå·²ç»è¢«ä¿®æ”¹ï¼Œæ¥ç€å‡½æ•°è·³è½¬åˆ° again å¤„é‡æ–°æŸ¥æ‰¾ã€‚å½“éå†å®Œæ‰€æœ‰çš„é¢„ç•™åŒºä¹‹åï¼Œå¦‚æœ changed çš„å€¼ä¸º 1ï¼Œé‚£ä¹ˆè¡¨ç¤ºæœŸç›¼çš„é¢„ç•™åŒºèŒƒå›´å·²ç»æ”¹å˜ï¼Œå› æ­¤æ­¤æ—¶å°†é¢„ç•™åŒºæ–°çš„åœ°å€èŒƒå›´æ›´æ–°åˆ° addrp å’Œ sizep æŒ‡é’ˆä¸Šï¼Œæœ€åè¿”å› changed çš„å€¼ã€‚

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30023">reserve_early</span>

![](/assets/PDB/HK/HK000662.png)

reserve_early() å‡½æ•°ç”¨äºå°†ä¸€æ®µç‰©ç†å†…å­˜è¿›è¡Œé¢„ç•™ã€‚å‚æ•° start å’Œ end ç”¨äºæŒ‡æ˜ä¸€æ®µéœ€è¦é¢„ç•™çš„å†…å­˜åŒºåŸŸï¼Œname å‚æ•°ç”¨äºæŒ‡æ˜é¢„ç•™åŒºåŸŸçš„åå­—ã€‚

å‡½æ•°åœ¨ 294 è¡Œè°ƒç”¨ \_\_check_and_double_early_res() å‡½æ•°ç”¨äºæ£€æµ‹ Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºæ˜¯å¦èƒ½å®¹çº³æ›´å¤šçš„é¢„ç•™åŒºï¼Œå¦‚æœä¸èƒ½å°±å°†åŸæœ‰çš„é¢„ç•™åŒºæ•°é‡æ‰©å¤§ä¸¤å€ã€‚å‡½æ•°åœ¨ 296 è¡Œè°ƒç”¨ drop_overlaps_that_are_ok() å‡½æ•°å°† Early_Res åˆ†é…å™¨é¢„ç•™åŒºä¸ start å’Œ end é‡å çš„é¢„ç•™åŒºæ‹†åˆ†æˆé‡å éƒ¨åˆ†å’Œä¸é‡å éƒ¨åˆ†ï¼Œç„¶åå°†åŸå§‹é¢„ç•™åŒºåˆ é™¤ä¹‹åå°†ä¸é‡å éƒ¨åˆ†é‡æ–°æ’å…¥åˆ° Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…ã€‚å‡½æ•°æœ€åè°ƒç”¨ \_\_reserve_early() å‡½æ•°å°†å‚æ•°å¯¹åº”çš„é¢„ç•™åŒºæ’å…¥åˆ° Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…ï¼Œå¹¶å°†æ–°æ’å…¥çš„é¢„ç•™åŒºæ ‡è®°ä¸ºä¸å¯é‡å .

> [> \_\_check_and_double_early_res](#D30007)
>
> [> drop_overlaps_that_are_ok](#D30022)
>
> [> \_\_reserve_early](#D30020)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30022">reserve_early_overlap_ok</span>

![](/assets/PDB/HK/HK000661.png)

reserve_early_overlap_ok() å‡½æ•°ç”¨äºç¡®è®¤ä¸€æ®µå†…å­˜åŒºåŸŸæ˜¯å¦é‡å ï¼Œå¦‚æœé‡å å°†åŸå§‹åŒºåŸŸè¿›è¡Œåˆ‡å‰²ï¼Œå°†æ–°ç”Ÿæˆçš„åŒºåŸŸé‡æ–°æ’å…¥åˆ°é¢„ç•™åŒºå†…ã€‚å‚æ•° start å’Œ end æŒ‡å‘å³å°†é¢„ç•™çš„å†…å­˜åŒºåŸŸã€‚

å‡½æ•°é¦–å…ˆåœ¨ 128 è¡Œè°ƒç”¨ for å¾ªç¯éå† Early_Res åˆ†é…å™¨çš„æ‰€æœ‰é¢„ç•™åŒºï¼Œå¦‚æœéå†åˆ°çš„é¢„ç•™åŒºä¸å‚æ•°å¯¹åº”çš„åŒºåŸŸä¸å­˜åœ¨é‡å éƒ¨åˆ†ï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 133 è¡Œè¿›è¡Œè¿”å›; åä¹‹éå†åˆ°çš„é¢„ç•™åŒºä¸å‚æ•°å¯¹åº”çš„åŒºåŸŸå­˜åœ¨é‡å éƒ¨åˆ†ï¼Œé‚£ä¹ˆå‡½æ•°ç»§ç»­æ£€æµ‹éå†åˆ°çš„é¢„ç•™åŒºæ˜¯å¦æ”¯æŒé‡å ï¼Œå¦‚æœä¸æ”¯æŒï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 141 è¡Œè¿”å›; åä¹‹æ”¯æŒé‡å ï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 151 è¡Œæ‹·è´é¢„ç•™åŒºçš„åå­—åˆ° name éå†ï¼Œå¹¶ä¸”åœ¨ 153-162 è¡Œå°†éå†åˆ°çš„é¢„ç•™åŒºå’Œæ’å…¥çš„é¢„ç•™åŒºåŸŸé‡å ä¹‹åï¼Œè¢«åˆ†æˆå¤šä¸ªæ–°çš„åŒºåŸŸï¼Œé‚£ä¹ˆå‡½æ•°å°†å½“å‰éå†åˆ°çš„é¢„ç•™åŒºä» Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…ç§»é™¤ï¼Œç„¶åå°†å‰éƒ¨åˆ†ä¸é‡å å’Œåéƒ¨åˆ†ä¸é‡å åŒºåŸŸé€šè¿‡ reserve_early_overlap_ok() å‡½æ•°æ’å…¥åˆ° Early_Res åˆ†é…çš„é¢„ç•™åŒºå†…ã€‚

> [reserve_early_overlap_ok](#D30021)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30021">reserve_early_overlap_ok</span>

![](/assets/PDB/HK/HK000660.png)

reserve_early_overlap_ok() å‡½æ•°ç”¨äºå°†ä¸€æ®µå†…å­˜åŒºåŸŸæ’å…¥åˆ° Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…ã€‚å‚æ•° start å’Œ end æŒ‡å‘å³å°†æ’å…¥çš„é¢„ç•™åŒºå†…ï¼Œname å‚æ•°æŒ‡æ˜é¢„ç•™åŒºçš„åå­—ã€‚

å‡½æ•°åœ¨ 222 è¡Œè°ƒç”¨ drop_overlap_that_are_ok() å‡½æ•°ç¡®è®¤ start å’Œ end å‚æ•°å¯¹åº”å†…å­˜åŒºåŸŸåœ¨ Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…æ²¡æœ‰é‡å ï¼Œå¦‚æœé‡å ï¼Œå°†é‡å çš„éƒ¨åˆ†ç‹¬ç«‹æˆæ–°çš„é¢„ç•™åŒº; å¦‚æœæ²¡æœ‰é‡å ï¼Œé‚£ä¹ˆå°†æ–°çš„åŒºåŸŸé€šè¿‡ \_\_reserve_early() å‡½æ•°å°† start åˆ° end çš„åŒºåŸŸæ’å…¥åˆ° Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…ï¼Œå¹¶å°†æ–°é¢„ç•™åŒºæ ‡è®°ä¸ºå¯é‡å åŒºåŸŸ.

> [\_\_reserve_early](#D30020)
>
> [drop_overlaps_that_are_ok](#D30022)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30020">\_\_reserve_early</span>

![](/assets/PDB/HK/HK000659.png)

\_\_reserve_early() å‡½æ•°ç”¨äºå°†ä¸€æ®µç‰©ç†å†…å­˜åŠ å…¥åˆ° Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºåŸŸã€‚å‚æ•° start å’Œ end æŒ‡æ˜çš„é¢„ç•™åŒºçš„èŒƒå›´ï¼Œname å‚æ•°æŒ‡æ˜çš„é¢„ç•™åŒºçš„åå­—ï¼Œå‚æ•° overlap_ok æŒ‡æ˜çš„é¢„ç•™åŒºé‡å ä¸å¦.

å‡½æ•°åœ¨ 181 è¡Œè°ƒç”¨ find_overlapped_early() å‡½æ•°åœ¨ Early_res åˆ†é…å™¨çš„é¢„ç•™åŒºæŸ¥çœ‹å‚æ•°å¯¹åº”çš„åŒºåŸŸé‡å çš„åŒºåŸŸå¯¹åº”çš„ç´¢å¼•ï¼Œå¦‚æœç´¢å¼•å¤§äºç­‰äº max_early_res, é‚£ä¹ˆ Early_res åˆ†é…å™¨ä¸èƒ½åœ¨å®¹çº³æ›´å¤šçš„é¢„ç•™åŒºï¼Œäºæ˜¯è§¦å‘ panic(). å¦‚æœç´¢å¼•æ²¡æœ‰æŸ¥å‡ºæœ€å¤§é¢„ç•™åŒºä¸ªæ•°ï¼Œé‚£ä¹ˆå‡½æ•°è·å¾—é‡å åŒºåŸŸï¼Œå¦‚æœæ­¤æ—¶ r->end å€¼å­˜åœ¨ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¿™ä¸ªé¢„ç•™åŒºåœ¨ Early_Res åˆ†é…å™¨é¢„ç•™åŒºå†…å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆå‡½æ•°ä¸èƒ½å°†è¿™ä¸ªåŒºåŸŸåŠ å…¥åˆ°é¢„ç•™åŒºå†…ï¼Œç›´æ¥è§¦å‘ panic(). é€šè¿‡ä¸Šé¢çš„æ£€æµ‹ä¹‹åï¼Œå‡½æ•°å¯ä»¥å°†è¿™ä¸ªæ–°çš„é¢„ç•™åŒºåŠ å…¥åˆ° Early_Res é¢„ç•™åŒºå†…ï¼Œå¹¶å°†é¢„ç•™åŒºçš„ä¿¡æ¯å¡«å…¥åˆ°ç´¢å¼•å¯¹åº”çš„é¢„ç•™åŒºå†…ï¼Œå¹¶å°† overlap_ok çš„å€¼å†™å…¥åˆ°é¢„ç•™åŒºçš„ overlap_ok æˆå‘˜ä¸Šï¼Œå¦‚æœ name å‚æ•°å­˜åœ¨ï¼Œé‚£ä¹ˆå°† name æ‹·è´åˆ° name æˆå‘˜é‡Œï¼Œæœ€ç»ˆå¢åŠ  early_res_count çš„å€¼ï¼Œä»¥æ­¤å¢åŠ  Early_res åˆ†é…å™¨é¢„ç•™åŒºçš„ä¸ªæ•°.

> [find_overlapped_early](#D30001)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30019">free_early_partial</span>

![](/assets/PDB/HK/HK000658.png)

free_early_partial() å‡½æ•°ç”¨äºä» Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…ç§»é™¤éƒ¨åˆ†åŒºåŸŸã€‚å‚æ•° start å’Œ end æŒ‡æ˜éƒ¨åˆ†ç§»é™¤é¢„ç•™åŒºèŒƒå›´ã€‚

å‡½æ•°åœ¨ 342 è¡Œè¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœ start ç­‰äº endï¼Œé‚£ä¹ˆå‡½æ•°æ— æ³•è¿›è¡Œç§»é™¤ç›´æ¥è¿”å›ã€‚å‡½æ•°é¦–å…ˆåœ¨ 349 è¡Œè°ƒç”¨ find_overlapped_early() å‡½æ•°åœ¨ Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…æŸ¥æ‰¾ä¸å‚æ•°é‡åˆçš„åŒºåŸŸå¯¹åº”çš„ç´¢å¼•ï¼Œå¦‚æœ i å¤§äºç­‰äº max_early_res, é‚£ä¹ˆè¡¨ç¤º Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…æ²¡æœ‰é‡åˆçš„åŒºåŸŸï¼Œå› æ­¤ä¸èƒ½è¿›è¡Œç§»é™¤ï¼Œç›´æ¥è¿”å›; åä¹‹å‡½æ•°åœ¨ Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…æ‰¾åˆ°äº†ä¸€ä¸ªé¢„ç•™åŒºã€‚å‡½æ•°åœ¨ 355 è¡Œè¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœéœ€è¦ç§»é™¤çš„åŒºåŸŸåªæ˜¯æ‰¾åˆ°é¢„ç•™åŒºçš„éƒ¨åˆ†ï¼Œé‚£ä¹ˆå‡½æ•°ç›´æ¥è°ƒç”¨ drop_range_partial() å‡½æ•°è¿›è¡Œç§»é™¤ï¼Œå¹¶è¿”å›; åä¹‹å¦‚æœç§»é™¤çš„åŒºåŸŸæ˜¯ Early_Res åˆ†é…å™¨å†…å¤šä¸ªåŒºåŸŸï¼Œé‚£ä¹ˆå‡½æ•°è°ƒç”¨ drop_range_partial() å‡½æ•°ç§»é™¤å½“å‰åŒºåŸŸä¹‹åï¼Œå¹¶è°ƒè½¬åˆ° try_next å¤„ç»§ç»­ç§»é™¤ä¸‹ä¸€ä¸ªåŒºåŸŸ.

> [> find_overlapped_early](#D30001)
>
> [> drop_range](#D30015)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30018">drop_range_partial</span>

![](/assets/PDB/HK/HK000657.png)

drop_range_partial() å‡½æ•°ç”¨äºä» Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…é‡Šæ”¾éƒ¨åˆ†åŒºåŸŸ. å‚æ•° i æŒ‡æ˜é‡Šæ”¾çš„ç‰©ç†å†…å­˜åŒºåŸŸåœ¨ Eaarly_Res åˆ†é…å™¨é¢„ç•™åŒºæ•°ç»„ä¸Šçš„ç´¢å¼•ï¼Œå‚æ•° start å’Œ end æŒ‡æ˜ä»é¢„ç•™åŒºå†…ç§»é™¤çš„åŒºåŸŸèŒƒå›´ã€‚

å‡½æ•°é¦–å…ˆåœ¨ 71-72 è¡Œè·å¾—åŸå§‹é¢„ç•™åŒºçš„èµ·å§‹åœ°å€å’Œç»ˆæ­¢åœ°å€ï¼Œæ¥ç€åœ¨ 73-74 è¡Œä¸€ä¸ªæœ€å°çš„ç§»é™¤é›†åˆã€‚è·å¾—é›†åˆä¹‹åï¼Œå¦‚æœ common_start å¤§äº common_end, é‚£ä¹ˆè·å¾—é¢„ç•™åŒºå­˜åœ¨æº¢å‡ºï¼Œä¸ç¬¦åˆç§»é™¤æ¡ä»¶ï¼Œç›´æ¥è¿”å›; å‡½æ•°ç»§ç»­åœ¨ 80 è¡Œè¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœåŸå§‹é¢„ç•™åŒºçš„èµ·å§‹åœ°å€å°äºæ–°é›†åˆçš„èµ·å§‹åœ°å€ï¼Œé‚£ä¹ˆè¯´æ˜å‡½æ•°éœ€è¦å°†åŸå§‹é¢„ç•™åŒºå¤´éƒ¨è¿›è¡Œæ‹†åˆ†ï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 82 è¡Œè¿›è¡Œè°ƒæ•´ï¼Œå°†åŸå§‹é¢„ç•™åŒºçš„ç»“æŸåœ°å€è®¾ç½®ä¸º common_startã€‚å‡½æ•°å¦‚æœæ­¤æ—¶æ£€æµ‹åˆ°åŸå§‹é¢„ç•™åŒºçš„çš„ç»“æŸåœ°å€å¤§äºé›†åˆçš„ç»“æŸåœ°å€ï¼Œé‚£ä¹ˆå‡½æ•°éœ€è¦å°†åŸå§‹é¢„ç•™åŒºçš„å°¾éƒ¨æ–°å¢åŠ ä¸€ä¸ªé¢„ç•™åŒºã€‚é‚£ä¹ˆå‡½æ•°åœ¨ 84-96 è¡Œç”¨äºåœ¨ Early_Res åˆ†é…å™¨ä¸­æ–°å¢ä¸€ä¸ªé¢„ç•™åŒºï¼Œè¯¥é¢„ç•™åŒºçš„èµ·å§‹åœ°å€å°±æ˜¯é›†åˆçš„ç»“æŸåœ°å€; å¦‚æœå‡½æ•°ä¸€å¼€å§‹æ£€æµ‹åˆ°åŸå§‹é¢„ç•™åŒºçš„èµ·å§‹åœ°å€å¤§äºé›†åˆçš„èµ·å§‹åœ°å€ï¼Œé‚£ä¹ˆå‡½æ•°åªéœ€ç¼©å‡åŸå§‹é¢„ç•™åŒºçš„èŒƒå›´ï¼Œå¦‚æœæ­¤æ—¶å‡½æ•°æ£€æµ‹åˆ°åŸå§‹é¢„ç•™åŒºçš„ç»“æŸåœ°å€å¤§äºé›†åˆçš„ç»“æŸåœ°å€ï¼Œé‚£ä¹ˆ Early_Res åˆ†é…å™¨ä»…éœ€è°ƒæ•´åŸå§‹çš„é¢„ç•™åŒºçš„èµ·å§‹åœ°å€ä¸ºé›†åˆçš„ç»“æŸåœ°å€; åä¹‹åŸå§‹é¢„ç•™åŒºè¢«é›†åˆåŒ…å›´ï¼Œé‚£ä¹ˆå‡½æ•°ç›´æ¥è°ƒç”¨ drop_range() å‡½æ•°å°†è¯¥é¢„ç•™åŒºä» Early_Res åˆ†é…å™¨é¢„ç•™åŒºæ•°ç»„ä¸­ç§»é™¤.

> [drop_range](#D30015)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30017">free_bootmem</span>

![](/assets/PDB/HK/HK000656.png)

free_bootmem() å‡½æ•°ç”¨äºå°†ä¸€æ®µç‰©ç†å†…å­˜è®¾ç½®ä¸ºå¯ç”¨ã€‚å‚æ•° addr å’Œ size æŒ‡å‘ä¸€æ®µç‰©ç†å†…å­˜åŒºåŸŸã€‚å‡½æ•° free_bootmem() å‡½æ•°å¯ä»¥ç”± Bootmem åˆ†é…å™¨æä¾›ï¼Œä¹Ÿå¯ä»¥ç”± Early_Res åˆ†é…å™¨æä¾›ï¼Œè¿™é‡Œç ”ç©¶åè€…ã€‚

å‡½æ•°åœ¨ 462 è¡Œè°ƒç”¨ free_early() å‡½æ•°å®Œæˆå®é™…çš„é‡Šæ”¾åŠ¨ä½œï¼ŒEarly_Res åˆ†é…å™¨ä¼šå°†è¿™æ®µç‰©ç†å†…å­˜åŒºåŸŸä» Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒº early_res[] æ•°ç»„ä¸­ç§»é™¤ï¼Œä»¥æ­¤è®©è¿™æ®µç‰©ç†å†…å­˜åŒºåŸŸå˜å¾—å¯ç”¨ã€‚

> [free_early](#D30016)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30016">free_early</span>

![](/assets/PDB/HK/HK000655.png)

free_early() å‡½æ•°ç”¨äºä» Early_res åˆ†é…å™¨çš„é¢„ç•™å†…å­˜åŒºåŸŸä¸­ç§»é™¤ä¸€å—é¢„ç•™å†…å­˜åŒºåŸŸã€‚å‚æ•° start å’Œ end æŒ‡æ˜äº†ç§»é™¤é¢„ç•™åŒºåŸŸçš„èŒƒå›´ã€‚

å‡½æ•°åœ¨ 326 è¡Œè°ƒç”¨ find_overlapped_early() å‡½æ•°åœ¨ Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºä¸­æ‰¾åˆ°å‚æ•°å¯¹åº”çš„é¢„ç•™åŒºåœ¨ early_res[] æ•°ç»„ä¸­çš„ç´¢å¼•ã€‚å‡½æ•°åœ¨ 327 è¡Œè·å¾—ç´¢å¼•å¯¹åº”çš„é¢„ç•™åŒºã€‚å‡½æ•°åœ¨ 328 è¡Œè¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœ i å¤§äº max_early_res çš„å€¼æˆ–è€…æ£€æµ‹æŸ¥æ‰¾åˆ°çš„é¢„ç•™åŒºä¸å‚æ•°å¯¹åº”çš„é¢„ç•™åŒºä¸é‡åˆï¼Œé‚£ä¹ˆ Early_Res åˆ†é…å™¨å°†æ”¾å¼ƒç§»é™¤é¢„ç•™åŒºçš„æ“ä½œ; åä¹‹å¦‚æœæ£€æµ‹é€šè¿‡ï¼Œé‚£ä¹ˆå‡½æ•°è°ƒç”¨ drop_range() å‡½æ•°å°†å‚æ•°å¯¹åº”çš„é¢„ç•™åŒºä» Early_Res åˆ†é…å™¨çš„é¢„ç•™åŒºä¸­ç§»é™¤ï¼Œé‚£ä¹ˆç§»é™¤çš„åŒºåŸŸå°†å˜å¾—å¯ç”¨.

> [drop_range](#D30015)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30015">drop_range</span>

![](/assets/PDB/HK/HK000646.png)

drop_range() å‡½æ•°ç”¨äºåœ¨ Early_res åˆ†é…å™¨ä¸­ï¼Œå°†æŒ‡å®šçš„åŒºåŸŸä»é¢„ç•™åŒºä¸­ç§»é™¤. å‚æ•° i æŒ‡å‘é¢„ç•™åŒºçš„ç´¢å¼•ã€‚

å‡½æ•°åœ¨ 56 è¡Œè°ƒç”¨ for å¾ªç¯æŸ¥æ‰¾ early_res[] æ•°ç»„ä¸­é¢„ç•™åŒºæœ€å¤§ç´¢å¼•ï¼Œå¹¶å°†ç´¢å¼•å­˜å‚¨åœ¨ j å˜é‡é‡Œã€‚å‡½æ•°æ¥ç€åœ¨ 59 è¡Œè°ƒç”¨ memmove() å‡½æ•°å°† early_res[] æ•°ç»„ç¬¬ i+1 ä¸ªä¹‹åçš„æˆå‘˜å…¨éƒ¨å‘å‰è¦†ç›–ä¸€ä¸ªä½ç½®ï¼Œä»¥æ­¤å°† i ç´¢å¼•å¯¹åº”çš„é¢„ç•™åŒºç§»é™¤ï¼Œå‡½æ•°æœ€åæ›´æ–° early_res[] æ•°ç»„çš„é•¿åº¦å’Œæœ€åä¸€ä¸ªæˆå‘˜çš„ç»“æŸåœ°å€.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30014">\_\_alloc_bootmem_nopanic</span>

![](/assets/PDB/HK/HK000645.png)

\_\_alloc_bootmem_nopanic() å‡½æ•°ç”¨äºä» Early_res åˆ†é…å™¨ä¸­åˆ†é…æŒ‡å®šé•¿åº¦çš„ç‰©ç†å†…å­˜ï¼Œå¦‚æœåˆ†é…å¤±è´¥ä¸ä¼šè§¦å‘ panic. å‚æ•° size æŒ‡å‘åˆ†é…å†…å­˜çš„å¤§å°ï¼Œalign å‚æ•°è¡¨æ˜å¯¹é½æ–¹å¼ï¼Œgoal å‚æ•°æŒ‡æ˜æœŸç›¼ä»è¯¥åœ°å€å¼€å§‹è¿›è¡Œåˆ†é….

å‡½æ•°é¦–å…ˆå°† limit è®¾ç½®ä¸ºæœ€å¤§ç‰©ç†åœ°å€ï¼Œç„¶åè°ƒç”¨ \_\_\_alloc_bootmem_nopanic() å‡½æ•°å®Œæˆæ ¸å¿ƒçš„åˆ†é…ã€‚

> [\_\_\_alloc_bootmem_nopanic](#D30013)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30013">\_\_\_alloc_bootmem_nopanic</span>

![](/assets/PDB/HK/HK000639.png)

\_\_\_alloc_bootmem_nopanic() å‡½æ•°ç”¨äºä» Early_res åˆ†é…å™¨ä¸­åˆ†é…æŒ‡å®šé•¿åº¦çš„ç‰©ç†å†…å­˜, å¦‚æœåˆ†é…å¤±è´¥ä¸ä¼šè§¦å‘ panicã€‚size å‚æ•°æŒ‡æ˜æ‰€éœ€å†…å­˜çš„é•¿åº¦ï¼Œå‚æ•° align è¡¨ç¤ºåˆ†é…æ—¶å€™çš„å¯¹é½æ–¹å¼ï¼Œgoal æŒ‡æ˜æœŸç›¼ä»æŒ‡å®šä½ç½®å¼€å§‹åˆ†é…ï¼Œlimit å‚æ•°å€¼é™å®šæœ€å¤§åˆ†é…ç‰©ç†åœ°å€.

å‡½æ•°é¦–å…ˆåœ¨ 689 è¡Œè°ƒç”¨ slab_is_available() å‡½æ•°æ£€æµ‹ SLAB åˆ†é…å™¨æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœå¯ç”¨åˆ™ç›´æ¥ä½¿ç”¨ kzalloc() å‡½æ•°è¿›è¡Œå†…å­˜åˆ†é…; åä¹‹åˆ™ä» Early_res åˆ†é…å™¨ä¸­è¿›è¡Œåˆ†é…ï¼Œå‡½æ•°åœ¨ 694 è¡Œé€šè¿‡å‡½æ•° \_\_alloc_memory_core_early() å‡½æ•°ä» Early_res åˆ†é…å™¨ä¸­åˆ†é…æŒ‡å®šé•¿åº¦çš„ç‰©ç†å†…å­˜ï¼Œå¹¶è·å¾—å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œå¦‚æœè™šæ‹Ÿåœ°å€æœ‰æ•ˆç›´æ¥è¿”å›; åä¹‹æ— æ•ˆï¼Œåˆ™å°† goal è®¾ç½®ä¸º 0 å¹¶è°ƒè½¬åˆ° restart ä» 0 åœ°å€å¼€å§‹æŸ¥æ‰¾åˆ†é….

> [\_\_alloc_memory_core_early](#D30009)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30012">for_each_active_range_index_in_nid</span>

![](/assets/PDB/HK/HK000638.png)

for_each_active_range_index_in_nid() ç”¨äºåœ¨ Early_res åˆ†é…å™¨ä¸­éå†æŒ‡å®š NODE ä¸Šçš„æ‰€æœ‰å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸ. i å‚æ•°ç”¨äºå­˜å‚¨éå†ç´¢å¼•ï¼Œnid å‚æ•°ç”¨äºæŒ‡æ˜ NUMA NODE.

å‡½æ•°ä½¿ç”¨ for å¾ªç¯å®Œæˆéå†ï¼Œå…¶ä¸­ first_active_region_index_in_nid() å‡½æ•°ç”¨äºæŸ¥æ‰¾æŒ‡å®š NUMA NODE ä¸Šçš„ç¬¬ä¸€ä¸ªå¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸï¼Œè€Œ next_active_region_index_in_nid() å‡½æ•°åˆ™æŒ‡å‘ç´¢å¼•ä¹‹åçš„ç‰©ç†å†…å­˜åŒºåŸŸã€‚é€šè¿‡éå†å¯ä»¥éå†æŒ‡å®š NUMA NODE ä¸Šå¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸ.

> [first_active_region_index_in_nid](#D30010)
>
> [next_active_region_index_in_nid](#D30011)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30011">next_active_region_index_in_nid</span>

![](/assets/PDB/HK/HK000637.png)

next_active_region_index_in_nid() å‡½æ•°ç”¨äºæŸ¥æ‰¾ Eearly_res åˆ†é…å™¨çš„ä¸‹ä¸€ä¸ªå¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸã€‚å‚æ•° index æŒ‡å‘ Early_res åˆ†é…å™¨å½“å‰çš„å†…å­˜åŒºåŸŸç´¢å¼•ï¼Œnid å‚æ•°æŒ‡æ˜ NUMA NODE. 

å‡½æ•°ä½¿ç”¨ for å¾ªç¯ï¼Œä» index çš„ä¸‹ä¸€ä¸ªå€¼å¼€å§‹éå† Early_res åˆ†é…å™¨çš„æ‰€æœ‰å¯ç”¨ç‰©ç†å†…å­˜ï¼Œå¦‚æœ nid ç­‰äº MAX_NUMNODES æˆ–è€…ä¸‹ä¸€ä¸ªç‰©ç†å†…å­˜åŒºåŸŸçš„ nid ä¸å‚æ•°ä¸€è‡´ï¼Œé‚£ä¹ˆå‡½æ•°è¿”å›å¯¹åº”çš„ç´¢å¼•ã€‚

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30010">first_active_region_index_in_nid</span>

![](/assets/PDB/HK/HK000636.png)

first_active_region_index_in_nid() å‡½æ•°ç”¨äºè·å¾— Early_res åˆ†é…å™¨æŒ‡å®š NODE ä¸Šçš„ç¬¬ä¸€ä¸ªå¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸç´¢å¼•ã€‚å‚æ•° nid æŒ‡å‘ NUMA NODE. å‡½æ•°åœ¨ 3537 è¡Œä½¿ç”¨ for å¾ªç¯éå† Early_res åˆ†é…å™¨çš„æ‰€æœ‰ç‰©ç†å†…å­˜åŒºåŸŸï¼Œå¦‚æœ nid ç­‰äº MAX_NUMNODES æˆ–è€…éå†åˆ°çš„å†…å­˜åŒºåŸŸçš„ nid ä¸å‚æ•°ä¸€è‡´ï¼Œé‚£ä¹ˆå‡½æ•°ç›´æ¥é€€å‡ºå¾ªç¯ï¼Œè¿”å›ç´¢å¼•. å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å› -1.

> [early_node_map](#D202)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D3000X">\_\_alloc_memory_core_early</span>

![](/assets/PDB/HK/HK000635.png)

\_\_alloc_memory_core_early() ç”¨äºä» Early_res åˆ†é…å™¨ä¸­åˆ†é…æŒ‡å®šé•¿åº¦çš„ç‰©ç†å†…å­˜ã€‚å‚æ•° nid æŒ‡æ˜ NUMA NODEï¼Œå‚æ•° size æŒ‡æ˜åˆ†é…ç‰©ç†å†…å­˜çš„é•¿åº¦ï¼Œå‚æ•° align è¡¨ç¤ºå¯¹é½æ–¹å¼ï¼Œå‚æ•° goal æŒ‡æ˜æœŸç›¼ä»è¯¥åœ°å€å¼€å§‹åˆ†é…ï¼Œlimit å‚æ•°æŒ‡æ˜äº†æœ€å¤§å¯åˆ†é…ç‰©ç†åœ°å€.

å‡½æ•°é¦–å…ˆåœ¨ 3661 è¡Œè°ƒç”¨ get_max_mapped() å‡½æ•°ç¡®è®¤ limit å‚æ•°æ²¡æœ‰è¶…è¿‡æœ€å¤§æ˜ å°„ç‰©ç†åœ°å€ï¼Œå¦‚æœè¶…è¿‡åˆ™å°† limit è®¾ç½®ä¸ºå½“å‰ç³»ç»Ÿæœ€å¤§æ˜ å°„ç‰©ç†åœ°å€ã€‚æ¥ç€å‡½æ•°åœ¨ 3665 è¡Œè°ƒç”¨ for_each_active_range_index_in_nid() å‡½æ•°éå† Early_res åˆ†é…å™¨æ‰€æœ‰å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸï¼Œæ¯å½“éå†ä¸€ä¸ªå¯ç”¨ç‰©ç†åŒºåŸŸï¼Œå‡½æ•°å°±è°ƒç”¨ find_early_area() å‡½æ•°åœ¨è¯¥åŒºåŸŸå†…æŸ¥æ‰¾ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„å†…å­˜åŒºåŸŸï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™è¿›å…¥ä¸‹ Early_res åˆ†é…å™¨çš„ä¸‹ä¸€ä¸ªå†…å­˜åŒºåŸŸ; åä¹‹å¦‚æœæ‰¾åˆ°ï¼Œé‚£ä¹ˆå‡½æ•°è·å¾—æŸ¥æ‰¾åˆ°ç‰©ç†å†…å­˜åŒºåŸŸå¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œå¹¶å°†è¯¥åŒºåŸŸæ¸…é›¶ï¼Œæ¥ç€å‡½æ•°åœ¨ 3688 è¡Œè°ƒç”¨ reserve_early_without_check() å‡½æ•°å°†è¯¥åŒºåŸŸåŠ å…¥åˆ° Early_res åˆ†é…å™¨çš„é¢„ç•™åŒºå†…è¿›è¡Œç®¡ç†ï¼Œæœ€åè¿”å›æŸ¥æ‰¾åˆ°åŒºåŸŸçš„è™šæ‹Ÿåœ°å€.

> [find_early_area](#D30003)
>
> [get_max_mapped](#D30006)
>
> [reserve_early_without_check](#D30008)
>
> [for_each_active_range_index_in_nid](#D30012)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30008">reserve_early_without_check</span>

![](/assets/PDB/HK/HK000634.png)

reserve_early_without_check() å‡½æ•°ç”¨äºä¸æ£€æŸ¥å¾…é¢„ç•™åŒºåŸŸçš„æœ‰æ•ˆæ€§æˆ–ä¸åŸå…ˆåŒºåŸŸé‡å çš„æƒ…å†µä¸‹ï¼Œç›´æ¥å°†æŒ‡å®šåŒºåŸŸæ·»åŠ åˆ° early_res[] æ•°ç»„å†…ã€‚å‚æ•° start å’Œ end æŒ‡æ˜äº†ä¸€ä¸ªæ–°çš„é¢„ç•™åŒºï¼Œname æŒ‡æ˜é¢„ç•™åŒºçš„åå­—ã€‚å‡½æ•°åœ¨ 304 è¡Œè¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœæ­¤æ—¶ start å¤§äº endï¼Œé‚£ä¹ˆå‡½æ•°ç›´æ¥è¿”å›ï¼Œæ— æ•ˆå‚æ•°ã€‚å‡½æ•°æ¥ç€è°ƒç”¨ \_\_check_and_double_early_res() å‡½æ•°ï¼Œåœ¨å¿…è¦çš„æƒ…å†µä¸‹å°† Early_res åˆ†é…å™¨çš„é¢„ç•™æ•°ç»„ early_res çš„å®¹é‡æ‰©å¤§ä¸€å€ã€‚å‡½æ•°æ¥ç€åœ¨ 209 è¡Œåœ¨ early_res[] æ•°ç»„å†…è·å¾—ä¸€ä¸ªé¢„ç•™åŒºä½ç½®ï¼Œå¹¶å°†å‚æ•°æŒ‡å‘çš„å†…å­˜åŒºåŸŸæ·»åŠ åˆ°è¿™ä¸ªé¢„ç•™åŒºå†…ï¼Œå…¶ä¸­é¢„ç•™åŒºçš„ overlap_ok ç›´æ¥è®¾ç½®ä¸º 0ï¼Œä»¥æ­¤è¡¨ç¤ºæ²¡æœ‰é‡å ã€‚æœ€åå°† name å‚æ•°æ‹·è´åˆ°é¢„ç•™åŒºçš„åå­—ä¸Šï¼Œå¹¶æ›´æ–° early_res_count çš„å€¼.

> [\_\_check_and_double_early_res](#D30007)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30007">\_\_check_and_double_early_res</span>

![](/assets/PDB/HK/HK000632.png)

\_\_check_and_double_early_res() å‡½æ•°ç”¨äºæ£€æµ‹ Early_res å†…å­˜åˆ†é…å™¨çš„é¢„ç•™æ•°ç»„ early_res æ˜¯å¦è¿˜èƒ½å­˜å‚¨æ›´å¤šçš„é¢„ç•™åŒºåŸŸã€‚å‚æ•° ex_start å’Œ ex_end ç”¨äºæŒ‡æ˜ä¸€ä¸ªæ–°çš„é¢„ç•™åŒºåŸŸã€‚

å‡½æ•°åœ¨ 232 è¡Œæ£€æµ‹ max_early_res ä¸ early_res_count çš„å€¼æ˜¯å¦å¤§äº max_early_res/8 ä¸ 2 ä¹‹é—´æœ€å¤§å€¼ï¼Œä»¥æ­¤åˆ¤æ–­ early_res é¢„ç•™æ•°ç»„æ˜¯å¦è¿˜èƒ½å­˜å‚¨æ›´å¤šçš„é¢„ç•™åŒºåŸŸã€‚max_early_res æŒ‡æ˜äº† Early_res åˆ†é…å™¨ä¸­é¢„ç•™åŒºåŸŸçš„æœ€å¤§ä¸ªæ•°ï¼Œè€Œ early_res_count æŒ‡æ˜äº†å½“å‰é¢„ç•™åŒºåŸŸçš„æ•°é‡ã€‚å¦‚æœå‡½æ•°æ£€æµ‹åˆ° early_res æ•°ç»„å†…è¿˜å¯ä»¥å­˜å‚¨é¢„ç•™åŒºï¼Œé‚£ä¹ˆå‡½æ•°ç›´æ¥è¿”å›; åä¹‹å¦‚æœæ²¡æœ‰å¯ç”¨çš„é¢„ç•™åŒºï¼Œé‚£ä¹ˆå‡½æ•°æ¥ä¸‹æ¥è¦æ‹“å±•é¢„ç•™åŒºçš„æ•°é‡. å‡½æ•°åœ¨ 237 è¡Œè®¡ç®—æŒ‰ max_early_res ä¸¤å€æ‹“å±•é¢„ç•™æ•°ç»„æ¶ˆè€—çš„å†…å­˜é•¿åº¦ã€‚æ¥ç€å‡½æ•°æ£€æµ‹ early_res æ•°ç»„çš„èµ·å§‹åœ°å€æ˜¯å¦ä¸ early_res_x æ•°ç»„ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´é‚£ä¹ˆè¡¨ç¤º res_early æ•°ç»„è¿˜æ²¡æœ‰æ‹“å±•è¿‡ï¼Œé‚£ä¹ˆå°† start è®¾ç½®ä¸º 0; åä¹‹å°† start æŒ‡å‘äº† early_res[0].endã€‚å‡½æ•°åœ¨ 242 - 243 è¡Œå®šä¹‰äº†ä¸€ä¸ªæŸ¥æ‰¾åŒºåŸŸï¼Œå¹¶è°ƒç”¨ find_fw_memmap_area() å‡½æ•°åœ¨ E820 ç®¡ç†å™¨çš„æŒ‡å®šèŒƒå›´å†…æ‰¾åˆ°ä¸€å—å¯ç”¨çš„ç‰©ç†å†…å­˜ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œé‚£ä¹ˆå‡½æ•°å°† end æŒ‡å‘äº†ç³»ç»Ÿæœ€å¤§ç‰©ç†åœ°å€ï¼Œä»¥æ­¤æ‹“å®½æŸ¥æ‰¾èŒƒå›´ï¼Œå¦‚æœæ­¤æ—¶è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œé‚£ä¹ˆç³»ç»ŸçœŸæ²¡æœ‰å¯ç”¨ç‰©ç†å†…å­˜ï¼Œç›´æ¥ panic().

![](/assets/PDB/HK/HK000633.png)

åä¹‹æ‰¾åˆ°ä¸€å—å¯ç”¨ç‰©ç†å†…å­˜ä¹‹åï¼Œå°†è¿™å—ç‰©ç†å†…å­˜åŒºèµ·å§‹åœ°å€å¯¹åº”çš„è™šæ‹Ÿåœ°å€å­˜å‚¨åœ¨ new å˜é‡é‡Œï¼Œç„¶åè®¾ç½® new çš„ç¬¬ä¸€ä¸ªé¢„ç•™åŒºï¼Œç¬¬ä¸€å—é¢„ç•™åŒºå³è‡ªå·±æœ¬èº«ã€‚å‡½æ•°æ¥ä¸‹æ¥å°† old çš„é¢„ç•™æ•°ç»„æ‹·è´åˆ°æ–°çš„å†…å­˜åŒºåŸŸä¸Šã€‚åœ¨æ‹·è´çš„æ—¶å€™ï¼Œå‡½æ•°ä¼šæ£€æµ‹è¿™æ˜¯ç¬¬ä¸€æ¬¡ early_res æ•°ç»„æ‹“å±•è¿˜æ˜¯ç¬¬ N æ¬¡ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œé‚£ä¹ˆå‡½æ•°åœ¨æ‹·è´å®Œæ¯•ä¹‹åä¼šæ›´æ–° early_res_count çš„å€¼ï¼Œä»¥æ­¤å°†è‡ªå·±ä¹Ÿç®—å…¥æ–°çš„é¢„ç•™åŒºå†…ï¼Œå¦‚æœæ˜¯ç¬¬ N æ¬¡æ‹·è´ï¼Œå‡½æ•°æ‹·è´å®Œæ¯•ä¹‹åä¸æ›´æ–° early_res_count çš„å€¼ï¼Œå› æ­¤ res_early çš„ç¬¬ä¸€ä¸ªæˆå‘˜å°±æ˜¯ early_res æ•°ç»„æœ¬èº«ã€‚å‡½æ•°æœ€åå°†æ–°çš„é¢„ç•™åŒºåŸŸæ•°æ®æ‹·è´åˆ° earlu_res æ•°ç»„ä¸Šï¼Œå¹¶å°† max_early_res æ‰©å¤§æˆ 2 å€ã€‚

> [find_fw_memmap_area](#D30005)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30006">get_max_mapped</span>

![](/assets/PDB/HK/HK000631.png)

get_max_mapped() å‡½æ•°ç”¨äºè·å¾—ç³»ç»Ÿæœ€å¤§çš„æ˜ å°„ç‰©ç†åœ°å€ã€‚æœ€å¤§æ˜ å°„ç‰©ç†é¡µå¸§å­˜å‚¨åœ¨ max_pfn_mapped, å‡½æ•°è¿”å›å…¶å¯¹é½çš„ç‰©ç†åœ°å€ã€‚

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30005">find_fw_memmap_area</span>

![](/assets/PDB/HK/HK000630.png)

find_fw_memmap_area() å‡½æ•°ç”¨äºæŸ¥çœ‹å›ºä»¶å¯ä»¥æ˜ å°„çš„åŒºåŸŸã€‚å‚æ•° start å’Œ end æŒ‡æ˜çš„æŸ¥æ‰¾çš„èŒƒå›´ï¼Œsize æŒ‡æ˜äº†æŸ¥æ‰¾çš„é•¿åº¦ï¼Œalign æŒ‡æ˜äº†å¯¹é½çš„æ–¹å¼ã€‚å‡½æ•°é€šè¿‡è°ƒç”¨ find_e820_area() å‡½æ•°åœ¨ E820 å†…å­˜ç®¡ç†å™¨ä¸­æ‰¾åˆ°ä¸€å—å¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸã€‚

> [find_e820_area](#D30004)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30004">find_e820_area</span>

![](/assets/PDB/HK/HK000629.png)

find_e820_area() å‡½æ•°ç”¨äºåœ¨æŒ‡å®šèŒƒå›´å†…æ‰¾åˆ°ä¸€å—å¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸã€‚å‚æ•° start å’Œ end æŒ‡å‘æŸ¥æ‰¾çš„èŒƒå›´ï¼Œsize æŒ‡æ˜äº†åŒºåŸŸçš„é•¿åº¦ï¼Œalign æŒ‡æ˜äº†å¯¹é½æ–¹å¼ã€‚

å‡½æ•°åœ¨ 747 è¡Œä½¿ç”¨ for å¾ªç¯éå† E820 åˆ†é…å™¨çš„æ‰€æœ‰å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸï¼Œå¦‚æœä¸æ˜¯å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸåˆ™ç›´æ¥è·³è¿‡ï¼Œæ¯å½“éå†åˆ°ä¸€ä¸ªç‰©ç†å†…å­˜åŒºåŸŸçš„æ—¶å€™ï¼Œå‡½æ•°å°† ei_start å’Œ ei_last æŒ‡å‘äº†è¯¥ç‰©ç†å†…å­˜åŒºåŸŸï¼Œæ¥ç€å‡½æ•°åœ¨ 757 è¡Œè°ƒç”¨ find_early_area() å‡½æ•°åœ¨ ei_start åˆ° ei_last çš„èŒƒå›´å†…ï¼Œè®¾ç½®æŸ¥æ‰¾èŒƒå›´ä¸º start åˆ° endï¼Œé•¿åº¦ä¸º size çš„å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™ addr ä¸ä¸º -1ï¼Œå¹¶ç›´æ¥è¿”å›ã€‚è¿”å›è¿”å› -1.

> [find_early_area](#D30003)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30003">find_early_eara</span>

![](/assets/PDB/HK/HK000610.png)

find_early_eara() å‡½æ•°ç”¨äº Early_res åˆ†é…å™¨åœ¨æŒ‡å®šçš„èŒƒå›´å†…æ‰¾åˆ°ä¸€å—æŒ‡å®šé•¿åº¦æœªä½¿ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸã€‚å‚æ•° ei_start å’Œ ei_end æŒ‡æ˜äº†ä¸€å—ç‰©ç†åŒºåŸŸï¼Œå‚æ•° startã€end å’Œ size æŒ‡æ˜äº†æ‰€éœ€åŒºåŸŸçš„èŒƒå›´ï¼Œå‚æ•° align ç”¨äºå¯¹é½æ“ä½œã€‚

å‡½æ•°åœ¨ 550 è¡Œå°† addr æŒ‡å‘äº† ei_start æŒ‰ align å¯¹é½çš„åœ°å€ä¸Šï¼Œå¦‚æœæ­¤æ—¶ addr å°äº startï¼Œé‚£ä¹ˆè¡¨ç¤ºè¢«æŸ¥æ‰¾ç‰©ç†å†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€å°äºæœŸç›¼å€¼ï¼Œå› æ­¤å°† addr æŒ‡å‘ start å¯¹é½ä¹‹åçš„åœ°å€ã€‚å‡½æ•°åœ¨ 533 è¡Œè¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœæ­¤æ—¶ addr å¤§äº ei_last, é‚£ä¹ˆè¢«æŸ¥æ‰¾åŒºåŸŸæ²¡æœ‰ç¬¦åˆè¦æ±‚çš„åœ°æ–¹ã€‚å‡½æ•°åœ¨ 555 è¡Œä½¿ç”¨ while å¾ªç¯ï¼Œåœ¨å¾ªç¯ä¸­è°ƒç”¨ bad_addr() å‡½æ•°åœ¨ addr åˆ° ei_end ä¹‹é—´æŸ¥æ‰¾ä¸€å—é•¿åº¦ä¸º size å¹¶ä¸”æ²¡æœ‰é¢„ç•™çš„åŒºåŸŸï¼Œå¦‚æœæ‰¾åˆ°å¹¶å°†è¯¥åŒºåŸŸçš„èµ·å§‹åœ°å€å­˜å‚¨åœ¨ addr ä¸­; å¦‚æœå‡½æ•°éå†äº†è¯¥åŒºåŸŸä¹‹åæ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼Œé‚£ä¹ˆå¾ªç¯é¡µä¹Ÿç…§æ ·åœæ­¢ã€‚æ¥ä¸‹æ¥çœ‹å‡½æ•°éœ€è¦ç¡®è®¤æ˜¯å¦çœŸæ­£æ‰¾åˆ°å¯ç”¨çš„åŒºåŸŸï¼Œå‡½æ•°åœ¨ 558 è¡Œè¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œé‚£ä¹ˆ last ä¸€å®šå°äº ei_last, å¹¶ä¸” last ä¹Ÿè¦å°äº end å‚æ•°ï¼Œæœ€åè¿”å› addr çš„å€¼; åä¹‹æ²¡æœ‰æ‰¾åˆ°ç›´æ¥è¿”å› -1.

> [bad_addr](#D30002)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)


---------------------------------------------

#### <span id="D30002">bad_addr</span>

![](/assets/PDB/HK/HK000609.png)

bad_addr() å‡½æ•°çš„ä½œç”¨æ˜¯ç¡®è®¤ä¸€å—ç‰©ç†å†…å­˜æ˜¯å¦å·²ç»é¢„ç•™ã€‚å‚æ•° addrp ç”¨äºæŒ‡å‘ä¸€ä¸ªç‰©ç†åœ°å€ï¼Œsize è¡¨ç¤ºåŒºåŸŸçš„é•¿åº¦ï¼Œalign åˆ™è¡¨ç¤ºå¯¹é½æ–¹å¼ã€‚å‡½æ•°åœ¨ 496 è¡Œè°ƒç”¨ find_overlapped_early() å‡½æ•°åœ¨ Early_Res åˆ†é…å™¨ç»´æŠ¤çš„ early_res[] æ•°ç»„ä¸­æŸ¥æ‰¾ä¸ start å’Œ addr é‡å çš„åŒºåŸŸï¼Œå¹¶è·å¾—åŒºåŸŸåœ¨ early_res[] æ•°ç»„ä¸­çš„ç´¢å¼•ã€‚å‡½æ•°åœ¨ 498 è¡Œæ£€æµ‹ç´¢å¼•æ˜¯å¦å°äº max_early_res, å¹¶ä¸”ç´¢å¼•å¯¹åº”çš„åŒºåŸŸçš„ç»“æŸåœ°å€å­˜åœ¨ï¼Œè¿™æ ·å¯ä»¥è¯´æ˜ early_res[] æ•°ç»„ä¸­ç¡®å®å­˜åœ¨ä¸€ä¸ªé‡å çš„åŒºåŸŸï¼Œé‚£ä¹ˆå‡½æ•°å°†é‡å åŒºåŸŸçš„ç»“æŸåœ°å€å­˜å‚¨åœ¨ addrp å’Œ addr é‡Œé¢ï¼Œç„¶åå°† changed ä¿®æ”¹è¯¥ä¸º 1 ä¹‹åï¼Œæ¥ç€è·³è½¬åˆ° again ç»§ç»­æŸ¥æ‰¾å¯èƒ½é‡å çš„éƒ¨åˆ†ï¼Œæœ€åè¿”å› changed çš„å€¼ã€‚å› æ­¤å½“ changed ä¸º 0 æ—¶è¡¨ç¤ºå‚æ•°å¯¹åº”çš„åŒºåŸŸå’Œ Early_Res åˆ†é…å™¨ç»´æŠ¤çš„åŒºåŸŸæ²¡æœ‰é‡å çš„åŒºåŸŸã€‚

> [find_overlapped_early](#D30001)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30001">find_overlapped_early</span>

![](/assets/PDB/HK/HK000608.png)

find_overlapped_early() å‡½æ•°ç”¨äºåœ¨ Early_Res åˆ†é…å™¨ç»´æŠ¤çš„å†…å­˜åŒºå†…æ‰¾åˆ°ä¸å‚æ•°é‡å çš„åŒºåŸŸã€‚å‚æ•° start å’Œ end æŒ‡å‘äº†ä¸€ä¸ªéœ€è¦æŸ¥æ‰¾çš„åŒºåŸŸ. 

å‡½æ•°åœ¨ 38 è¡Œä½¿ç”¨ for å¾ªç¯éå†äº† Early_Res åˆ†é…å™¨ early_res[] æ•°ç»„çš„æ‰€æœ‰æˆå‘˜ï¼Œåœ¨æ²¡éå†åˆ°ä¸€ä¸ªæˆå‘˜æ—¶ï¼Œå‡½æ•°åœ¨ 40 è¡Œæ£€æµ‹è¯¥åŒºåŸŸæ˜¯å¦åŒ…å«äº†å‚æ•°æŒ‡å®šçš„åŒºåŸŸï¼Œå¦‚æœåŒ…å«é‚£ä¹ˆå‡½æ•°ç›´æ¥åœæ­¢å¾ªç¯ï¼Œå¹¶è¿”å›è¯¥åŒºåŸŸçš„ä½ç½®ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œé‚£ä¹ˆå‡½æ•°è¿”å› early_res[] æ•°ç»„æˆå‘˜çš„ä¸ªæ•°.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D204">max_early_res</span>

{% highlight bash %}
static int max_early_res __initdata = MAX_EARLY_RES_X;
{% endhighlight %}

max_early_res è¡¨ç¤º Early_Res åˆ†é…å™¨æ”¯æŒçš„æœ€å¤§ region æ•°é‡ã€‚

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D203">nr_nodemap_entries</span>

{% highlight bash %}
static int __meminitdata nr_nodemap_entries;
{% endhighlight %}

nr_nodemap_entries å˜é‡ç”¨äºæè¿° early_node_map[] æ•°ç»„æˆå‘˜çš„ä¸ªæ•°ï¼Œå³ä»£è¡¨å½“å‰ç³»ç»Ÿä¸­ç»´æŠ¤ç‰©ç†å†…å­˜åŒºåŸŸçš„ä¸ªæ•°.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D202">early_node_map</span>

{% highlight bash %}
static struct node_active_region __meminitdata early_node_map[MAX_ACTIVE_REGIONS];
{% endhighlight %}

node_active_region[] æ•°ç»„ç”¨äºç®¡ç†å†…æ ¸ boot-time é˜¶æ®µçš„ç‰©ç†é¡µé›†åˆ. å…¶å±äº struct node_active_region æ•°æ®ç»“æ„æ„æˆçš„æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æˆå‘˜è¡¨ç¤ºä¸€ä¸ªå¯ç”¨çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼Œå¹¶ç”± nr_nodemap_entries å˜é‡æŒ‡æ˜æ•°ç»„çš„é•¿åº¦.

> [struct node_active_region](#D201)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D201">struct node_active_region</span>

![](/assets/PDB/HK/HK000586.png)

struct node_active_region æ•°æ®ç»“æ„ç”¨äºæè¿°ä¸€æ®µç‰©ç†å†…å­˜åŒºåŸŸï¼Œå…¶ä¸­ start_pfn æŒ‡æ˜è¿™æ®µç‰©ç†å†…å­˜åŒºåŸŸçš„èµ·å§‹ç‰©ç†é¡µå¸§; end_pfn æˆå‘˜æŒ‡æ˜äº†è¿™æ®µç‰©ç†å†…å­˜åŒºåŸŸçš„ç»“æŸç‰©ç†é¡µå¸§; nid æˆå‘˜åˆ™æŒ‡æ˜äº†è¿™æ®µç‰©ç†å†…å­˜åŒºåŸŸæ‰€åœ¨çš„ NUMA NODEã€‚

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30000">add_active_range</span>

![](/assets/PDB/HK/HK000584.png)

add_active_range() å‡½æ•°ç”¨äºå°†æ³¨å†Œä¸€æ®µç‰©ç†é¡µå¸§åˆ° early_node_map[] æ•°ç»„. å‚æ•° nid æŒ‡å‘ NUMA NODEï¼Œstart_pfn å’Œ end_pfn å‚æ•°æŒ‡æ˜ç‰©ç†é¡µå¸§çš„ä¿¡æ¯.

![](/assets/PDB/HK/HK000585.png)

åœ¨ boot-time é˜¶æ®µï¼Œå†…æ ¸å°†æ‰€æœ‰çš„ç‰©ç†é¡µå¸§ä¿¡æ¯å…¨éƒ¨å­˜å‚¨åœ¨ early_node_map[] æ•°ç»„ä¸­ï¼Œè¯¥æ•°ç»„ç”± struct node_active_region æ•°æ®ç»“æ„ç»„æˆï¼Œç”¨äºæè¿°ä¸€æ®µç‰©ç†å†…å­˜åŒºåŸŸã€‚å†…æ ¸ä½¿ç”¨ nr_nodemap_entries å˜é‡ç”¨äºç»Ÿè®¡ early_node_map[] æ•°ç»„ä¸­å·²ç»å­˜åœ¨çš„æˆå‘˜æ•°é‡ï¼Œå³å·²ç»ç»´æŠ¤çš„ç‰©ç†å†…å­˜åŒºåŸŸçš„æ•°é‡. å‡½æ•°åœ¨ 4247 è¡Œä½¿ç”¨ for å¾ªç¯éå† early_node_map[]
æ•°ç»„ä¸­çš„æ‰€æœ‰ç‰©ç†å†…å­˜åŒºåŸŸï¼Œå‡½æ•°é¦–å…ˆåœ¨ 4248 è¡Œæ£€æµ‹å˜é‡çš„ç‰©ç†å†…å­˜åŒºåŸŸçš„ NODE æ˜¯å¦å’Œå‚æ•° nid ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œé‚£ä¹ˆç»§ç»­éå†ä¸‹ä¸€ä¸ªç‰©ç†å†…å­˜åŒºåŸŸã€‚å‡½æ•°æ¥ç€åœ¨ 4252 è¡Œæ£€æµ‹æ–°åŠ å…¥çš„ç‰©ç†å†…å­˜åŒºåŸŸæ˜¯å¦åŒ…å«åœ¨å·²ç»éå†çš„ç‰©ç†å†…å­˜åŒºåŸŸå†…ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆå‡½æ•°ç›´æ¥è¿”å›ä¸å†æ³¨å†Œè¯¥ç‰©ç†å†…å­˜åŒºåŸŸ; åä¹‹ç»§ç»­æ£€æµ‹, å‡½æ•°åœ¨ 4257 è¡Œæ£€æµ‹ï¼Œå¦‚æœæ–°æ’å…¥çš„ç‰©ç†å†…å­˜åŒºåŸŸçš„èµ·å§‹ç‰©ç†é¡µå¸§å°äºéå†åˆ°ç‰©ç†å†…å­˜åŒºåŸŸçš„ç»“æŸç‰©ç†é¡µå¸§ï¼Œä»¥åŠæ’å…¥çš„ç‰©ç†å†…å­˜çš„ç»“æŸç‰©ç†é¡µå¸§å¤§äºéå†åˆ°ç‰©ç†å†…å­˜çš„ç»“æŸç‰©ç†é¡µå¸§ï¼Œé‚£ä¹ˆæ–°æ’å…¥çš„ç‰©ç†å†…å­˜åŒºåŸŸçš„ååŠæ®µé‡å ï¼Œé‚£ä¹ˆå‡½æ•°ä¿®æ”¹éå†åˆ°ç‰©ç†å†…å­˜åŒºåŸŸçš„ç»“æŸç‰©ç†é¡µå¸§ã€‚åŒç† 4264 è¡Œåˆ™æ£€æµ‹åˆ°å‰ç«¯é‡å ï¼Œé‚£ä¹ˆä¿®æ”¹éå†åˆ°ç‰©ç†å†…å­˜åŒºåŸŸçš„èµ·å§‹ç‰©ç†é¡µå¸§ã€‚éå†å®Œæ¯•ä¹‹åï¼Œå¦‚æœ i çš„å€¼å¤§äº MAX_ACTIVE_REGIONS, é‚£ä¹ˆå‡½æ•°è¿›è¡ŒæŠ¥é”™å¹¶ç»ˆæ­¢æ·»åŠ ; åä¹‹å‡½æ•°å‘ early_node_map[] ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ç‰©ç†å†…å­˜åŒºåŸŸ, å¹¶æ›´æ–° nr_nodemap_entries çš„å€¼.

> [> struct node_active_region](#D201)
> 
> [> early_node_map](#D202)
>
> [> nr_nodemap_entries](#D203)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](/blog/BiscuitOS_Catalogue/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>

#### æèµ ä¸€ä¸‹å§ ğŸ™‚

![MMU](/assets/PDB/BiscuitOS/kernel/HAB000036.jpg)
