---
layout: post
title:  "E820 on Qemu/KVM"
date:   2020-08-30 11:39:30 +0800
categories: [HW]
excerpt: MMU.
tags:
  - MMU
---

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI100100.png)

#### ç›®å½•

> - [E820 QEMU/KVM åŸç†](#A)
>
> - [E820 QEMU/KVM ä½¿ç”¨](#B)
>
> - [E820 QEMU/KVM å®è·µ](#C)
>
> - [E820 QEMU/KVM æºç åˆ†æ](#D)
>
> - [é™„å½•/æèµ ](#Z0)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000T.jpg)

#### E820 QEMU/KVM åŸç†

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000457.png)

QEMU/KVM ç”¨äºæ¨¡æ‹Ÿä¸€å¥—å®Œæ•´æ¶æ„çš„è™šæ‹Ÿæœºç¯å¢ƒï¼Œå…¶ä¸­åŒ…æ‹¬äº† Intel i386/X86_64 æ¶æ„
çš„æ¨¡æ‹Ÿï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ QEMU/KVM çµæ´»é…ç½®è™šæ‹Ÿæœºçš„å†…å­˜ã€CPUã€å¤–è®¾ç­‰ä¿¡æ¯ï¼ŒQEMU/KVM
å°†ç”¨æˆ·é…ç½®çš„ä¿¡æ¯è½¬æ¢ä¸ºä¸€ä¸ªè™šæ‹Ÿçš„ç¯å¢ƒï¼Œè®©è™šæ‹Ÿæœºè¿è¡Œæ—¶å…·å¤‡ç›¸åº”çš„ "ç¡¬ä»¶èƒ½åŠ›". æœ¬æ–‡
é‡ç‚¹è®¨è®º QEMU/KVM ä¸­å†…å­˜ç›¸å…³çš„é…ç½®é—®é¢˜.

æ­£å¦‚ä¸Šå›¾ï¼ŒQEMU/KVM å°†ç”¨æˆ·çš„é…ç½®å†…å­˜é€šè¿‡ E820 Table å­˜å‚¨èµ·æ¥ï¼Œå¹¶å°†å…¶å†™å…¥åˆ° 
"hw_cfg" å›ºä»¶é‡Œï¼Œå¹¶å°†å¦å¤–ä¸€éƒ¨åˆ†å†…å­˜ä¿¡æ¯å†™å…¥åˆ° CMOS å†…å­˜é‡Œï¼ŒQEMU/KVM åœ¨åˆå§‹åŒ–
å®Œæ¯•ä¹‹åå°† "hw_cfg" å›ºä»¶å’Œ CMOS å†…å­˜ä¼ é€’ç»™ seaBIOSï¼ŒQEMU/KVM æ‰§è¡Œåˆ°ä¸€å®šé˜¶æ®µä¹‹
åæ¨¡æ‹Ÿç³»ç»Ÿä¸Šç”µåŠ¨ä½œï¼Œå¹¶å¼•å¯¼ seaBIOS çš„å¯åŠ¨ï¼Œç„¶åå°†æ‰§è¡Œæƒè½¬ç§»ç»™seaBIOS, seaBIOS 
æ ¹æ® CMOS å†…å­˜çš„ä¿¡æ¯æ„å»ºç³»ç»Ÿæ—©æœŸçš„å†…å­˜å¸ƒå±€æ¡†æ¶ï¼Œå¹¶æ ¹æ® hw_cfg å›ºä»¶çš„å†…å®¹å®Œå–„ç³»
ç»Ÿçš„å†…å­˜å¸ƒå±€ã€‚æœ€ç»ˆ seaBIOS ä¹Ÿæ„å»ºå®Œè‡ªèº«çš„ E820 è¡¨ï¼Œè¿™å¼ E820 è¡¨æœ€ç»ˆä¼šè¢«å†™å…¥åˆ° 
BIOS çš„å¤šä¸ªä¸­æ–­ä¸­ã€‚seaBIOS æ‰§è¡Œå®Œä¹‹åå¼•å¯¼å†…æ ¸çš„å¯åŠ¨ï¼Œå¹¶å°†æ‰§è¡Œæƒç§»äº¤ç»™å†…æ ¸ã€‚å†…
æ ¸åœ¨æ—©æœŸçš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ seaBIOS æä¾›çš„ IVT è¡¨ï¼Œä»ä¸­è·å¾—äº†å†…å­˜çš„åŸºæœ¬ä¿¡æ¯ï¼Œ
kernel æ ¹æ®è¿™äº›ä¿¡æ¯ä¹Ÿæ„å»ºäº†è‡ªèº«çš„ E820 è¡¨ï¼Œå¹¶ä»¥ E820 è¡¨ä¸ºåŸºç¡€æ„å»º
Bootmem/MEMBLOCK å†…å­˜åˆ†é…å™¨.

ä»ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼ŒE820 Table æˆä¸ºè´¯ç©¿æ•´ä¸ªè¿‡ç¨‹å†…å­˜å¸ƒå±€çš„æ ¸å¿ƒï¼Œå› æ­¤æœ¬æ–‡é‡ç‚¹ç ”ç©¶
QEMU/KVM ä¸­ E820 Table çš„è¡Œä¸º. å¼€å‘è€…å¯ä»¥å‚è€ƒæºç æµç¨‹è¿›è¡Œç ”ç©¶:

> - [E820 QEMU/KVM æºç ç ”ç©¶](#D)

å¼€å‘è€…ä¹Ÿå¯ä»¥åœ¨ BiscuitOS ä¸Šå®è·µ QEMU/KVM E820 Table è¡Œä¸ºçš„æ•´ä¸ªè¿‡ç¨‹:

> - [E820 QEMU/KVM å®è·µ](#C)

å¼€å‘è€…åœ¨ç ”ç©¶å®Œä¸Šé¢ä¸¤ä¸ªç« èŠ‚ä¹‹åï¼Œå¯ä»¥è‡ªä¸»ä¿®æ”¹ QEMU/KVM E820 Table è¡Œä¸ºçš„è¿‡ç¨‹ï¼Œ
å¼€å‘è€…å¯ä»¥å‚è€ƒ:

> - [E820 QEMU/KVM ä½¿ç”¨](#B)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------

<span id="B"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000H.jpg)

#### E820 QEMU/KVM ä½¿ç”¨

> - [QEMU/KVM ä¸­æ·»åŠ ä¸€ä¸ªå¯ç”¨ E820 åˆ†åŒº](#B0000)
>
> - [QEMU/KVM ä¸­æ·»åŠ ä¸€ä¸ªé¢„ç•™ E820 åˆ†åŒº](#B0001)
>
> - [QEMU/KVM ä¸­é…ç½®å†…å­˜](#B0002)
>
> - [QEMU/KVM ä¸­ä¿®æ”¹ CMOS ç›¸å…³çš„å†…å­˜é…ç½®](#B0003)
>
> - [QEMU/KVM ä¸­å‘ hw_cfg ä¸­æ·»åŠ å†…å®¹](#B0004)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0000">QEMU/KVM ä¸­æ·»åŠ ä¸€ä¸ªå¯ç”¨ E820 åˆ†åŒº</span>

QEMU/KVM ä¸­æä¾›äº† e820_add_entry() å‡½æ•°ç”¨äºå‘ e820_table ä¸­æ·»åŠ ä¸€ä¸ªå¯ç”¨çš„å†…å­˜
åŒºåŸŸï¼Œæ·»åŠ åçš„å†…å­˜åŒºåŸŸå°†ä¼ é€’ç»™ hw_cfg å›ºä»¶ï¼Œè¿›è€Œä¼ é€’ç»™ seaBIOS ä½¿ç”¨ï¼Œ
e820_add_entry() å‡½æ•°æ—¢å¯ä»¥æ·»åŠ å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸï¼Œä¹Ÿå¯ä»¥é¢„ç•™å†…å­˜åŒºåŸŸ, ä½†æ·»åŠ 
å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸæ—¶ï¼Œä¼ å…¥çš„å†…å­˜ç±»å‹ä¸º E820_RAM. å¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç è¿›è¡Œæ·»åŠ :

{% highlight bash %}
#include "hw/i386/pc.h"

int BiscuitOS_demo(PCMachineState *pcms, MemoryRegion *system_memory)
{
        u64 address = 0x40000000;
        u64 length = 0x100000;
	MemoryRegion *ram_BiscuitOS;
	MachineState *machine = MACHINE(pcms);

	/* Add memory into qemu */
	machine->ram_size += length;
	ram_BiscuitOS = g_malloc(sizeof(*ram_BiscuitOS));
	memory_region_init_alias(ram_BiscuitOS, NULL, "ram-BiscuitOS", ram,
			address, length);
	memory_region_add_subregion(system_memory, address, ram_BiscuitOS);

	/* Insert Memory region into E820 */
	e820_add_entry(address, length, E820_RAM);

        return 0;
}
{% endhighlight %}

ä¸Šé¢çš„ä»£ç ä¸€å®šè¦æ”¾åœ¨ "hw/i386/pc.c" æ–‡ä»¶çš„ "pc_memory_init()" å‡½æ•°çš„ç‰¹å®šä½ç½®
æ‰§è¡Œï¼Œå…·ä½“è·¯å¾„å’Œæ–‡ä»¶ä½ç½®å¦‚ä¸‹å›¾:

{% highlight bash %}
BiscuitOS/output/linux-5.0-i386/qemu-system/qemu-system/hw/i386/pc.c
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000444.png)

å¦‚ä¸Šå›¾ï¼Œå°†å‡½æ•° "BiscuitOS_demo()" æ’å…¥åˆ°å‡½æ•° pc_memory_init() çš„ç¬¬ 1346 è¡Œï¼Œ
å‡½æ•°æ‰§è¡Œåï¼Œä¼šå‘ç³»ç»Ÿæ·»åŠ ä¸€å—ç‰©ç†å†…å­˜ï¼Œå…¶åœ°å€èŒƒå›´æ˜¯ "0x40000000-0x40100000".
å¯ä»¥åœ¨ Linux æŸ¥çœ‹å®é™…æ•ˆæœ:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000445.png)

ä»å†…æ ¸çš„ dmesg ä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡º QEMU/KVM å·²ç»å°†æ–°å¢åŠ çš„ e820 å†…å­˜åŒºåŸŸä¼ é€’ç»™äº†
å†…æ ¸ï¼Œå†…æ ¸æ¥æ”¶åˆ°æ–°çš„å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸä¿¡æ¯ä¹‹åï¼Œå°† "0x40000000-0x40100000" ä½œ
ä¸ºç³»ç»Ÿå¯ç”¨ç‰©ç†å†…å­˜ã€‚é€šè¿‡ "/proc/iomem" ä¹Ÿå¯ä»¥çœ‹åˆ° Linux å°†è¯¥æ®µå†…å­˜åŒºåŸŸä½œä¸ºäº†
ç³»ç»Ÿå¯ç”¨ç‰©ç†å†…å­˜ã€‚

> - [e820_add_entry è¯¦è§£](#D202)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0001">QEMU/KVM ä¸­æ·»åŠ ä¸€ä¸ªé¢„ç•™ E820 åˆ†åŒº</span>

QEMU/KVM ä¸­æä¾›äº† e820_add_entry() å‡½æ•°ç”¨äºå‘ e820_table ä¸­æ·»åŠ ä¸€ä¸ªé¢„ç•™å†…å­˜
åŒºåŸŸï¼Œæ·»åŠ åçš„å†…å­˜åŒºåŸŸå°†ä¼ é€’ç»™ hw_cfg å›ºä»¶ï¼Œè¿›è€Œä¼ é€’ç»™ seaBIOS ä½¿ç”¨ï¼Œ
e820_add_entry() å‡½æ•°æ—¢å¯ä»¥æ·»åŠ å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸï¼Œä¹Ÿå¯ä»¥é¢„ç•™å†…å­˜åŒºåŸŸ, ç›¸æ¯”æ·»åŠ 
å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸï¼Œæ·»åŠ é¢„ç•™å†…å­˜åŒºåŸŸåˆ™ç®€å•çš„å¤šã€‚æ·»åŠ é¢„ç•™ç‰©ç†å†…å­˜åŒºåŸŸæ—¶ï¼Œä¼ å…¥çš„
å†…å­˜ç±»å‹ä¸º E820_RESERVED. å¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç è¿›è¡Œæ·»åŠ :

{% highlight bash %}
#include "hw/i386/pc.h"

int BiscuitOS_demo(void)
{
        u64 address = 0x50000000;
        u64 length = 0x100000;

        /* Insert Reserved Memory region into E820 */
        e820_add_entry(address, length, E820_RESERVED);

        return 0;
}
{% endhighlight %}

å‡½æ•°å¯ä»¥åœ¨å¾ˆå¤šä½ç½®è¿›è¡Œæ’å…¥ï¼Œä½†è¦ç¡®ä¿æ’å…¥çš„ä½ç½®åœ¨ "bochs_bios_init()" å‡½æ•°ä¹‹å‰ï¼Œ
å› ä¸ºé‚£æ—¶ QEMU/KVM å·²ç»åœ¨å°è£… hw_cfg å›ºä»¶äº†ï¼Œå› æ­¤å¼€å‘è€…åº”è¯¥æ³¨æ„æ’å…¥ä½ç½®ã€‚ä½†æ’å…¥
ä¹‹åï¼Œå¯ä»¥åœ¨ Linux æŸ¥çœ‹å®é™…çš„æ’å…¥æ•ˆæœ, å¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000446.png)

ä»å†…æ ¸çš„ dmesg ä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡º QEMU/KVM å·²ç»å°†æ–°å¢åŠ çš„ e820 å†…å­˜åŒºåŸŸä¼ é€’ç»™äº†
å†…æ ¸ï¼Œå†…æ ¸æ¥æ”¶åˆ°æ–°çš„é¢„ç•™å†…å­˜åŒºåŸŸä¿¡æ¯ä¹‹åï¼Œå°† "0x50000000-0x50100000" ä½œ
ä¸ºç³»ç»Ÿé¢„ç•™å†…å­˜ã€‚é€šè¿‡ "/proc/iomem" ä¹Ÿå¯ä»¥çœ‹åˆ° Linux å°†è¯¥æ®µå†…å­˜åŒºåŸŸä½œä¸ºäº†
ç³»ç»Ÿé¢„ç•™ç‰©ç†å†…å­˜ã€‚

> - [e820_add_entry è¯¦è§£](#D202)
>
> - [E820 QEMU/KVM å¯åŠ¨æµç¨‹](#D0)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0002">QEMU/KVM ä¸­é…ç½®å†…å­˜</span>

QEMU/KVM æä¾›äº†å¾ˆå¤šå†…å­˜é…ç½®çš„å‚çœ‹ï¼Œç»“åˆ BiscuitOS å¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰é…ç½®ã€‚åœ¨ 
BiscuitOS ä¸­ QEMU/KVM ç›¸å…³çš„é…ç½®ä½äº RunBiscuitOS.sh è„šæœ¬ä¸­ï¼Œå…·ä½“è·¯å¾„å¦‚ä¸‹:

{% highlight bash %}
BiscuitOS/output/linux-5.0-i386/RunBiscuitOS.sh
{% endhighlight %}

QEMU ç›¸å…³çš„é…ç½®ä½äº RunBiscuitOS.sh çš„ do_running() å‡½æ•°ä¸­ï¼Œå¼€å‘è€…å¯ä»¥å°†æ¥ä¸‹æ¥
è®¨è®ºçš„åŠ åˆ°æŒ‡å®šä½ç½®è¿›è¡Œå®è·µ.

###### m

{% highlight bash %}
        sudo ${QEMUT} ${ARGS} \
        -smp 2 \
        -cpu host \
        -enable-kvm \
        -m 1024M \
        -kernel ${LINUX_DIR}/${ARCH}/boot/bzImage \
        -initrd ${ROOT}/BiscuitOS.img \
        -nographic \
        -append "${CMDLINE}"
{% endhighlight %}

QEMU/KVM çš„ "-m" å‚æ•°ç”¨äºæŒ‡å®šç‰©ç†å†…å­˜çš„å¤§å°ï¼Œè¿™ä¸ªé…ç½®æ˜¯æœ€ç›´æ¥çš„é…ç½®æ–¹æ³•ã€‚å¼€å‘è€…
å¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰å†…å­˜é•¿åº¦ã€‚ä¸Šé¢çš„ä¾‹å­å°±æ˜¯é…ç½®äº†ä¸€å—é•¿åº¦ä¸º 1 Gig çš„ç‰©ç†å†…å­˜ã€‚
QEMU/KVM å¯åŠ¨ä¹‹åä¼šå°†è¯¥å€¼ä½œä¸ºç³»ç»Ÿçš„å¯ç”¨ç‰©ç†å†…å­˜ä¼ é€’ç»™ seaBIOS, è¿›è€Œä¼ é€’ç»™ 
kernel ä½¿ç”¨.

--------------------------------------

###### numa

{% highlight bash %}
        sudo ${QEMUT} ${ARGS} \
        -smp 4 \
        -cpu host \
        -enable-kvm \
        -m 1024M \
	-object memory-backend-ram,id=mem0,size=512M \
	-object memory-backend-ram,id=mem1,size=512M \
	-numa node,memdev=mem0,cpus=0-1,nodeid=0 \
	-numa node,memdev=mem1,cpus=2-3,nodeid=1 \
        -kernel ${LINUX_DIR}/${ARCH}/boot/bzImage \
        -initrd ${ROOT}/BiscuitOS.img \
        -nographic \
        -append "${CMDLINE}"
{% endhighlight %} 

QEMU/KVM çš„ "object/numa" é€‰é¡¹é…åˆä½¿ç”¨å¯ä»¥å®šä¹‰ç³»ç»Ÿçš„ NUMA å†…å­˜å¸ƒå±€ã€‚"-object"
ç”¨äºå®šä¹‰ memory deviceï¼Œå…¶å®šä¹‰ä¸€ä¸ªå†…å­˜è®¾å¤‡ï¼Œå¹¶å®šä¹‰å…¶é•¿åº¦å’Œ ID ä¿¡æ¯. "-numa"
ç”¨äºæŒ‡å®š NUMA NODE çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ NODE ä½¿ç”¨çš„ memory deviceï¼Œä»¥åŠ CPU é›†åˆå’Œ NODE
ID ä¿¡æ¯ã€‚é€šè¿‡ä¸Šé¢çš„é…ç½®ï¼Œç³»ç»Ÿä¸­å°±å¯ä»¥ä½¿ç”¨ä¸¤ä¸ª NUMA NODE çš„å†…å­˜.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000447.png)

ä» Linux è¿è¡Œæƒ…å†µå¯ä»¥çœ‹å‡º NUMA å†…å­˜çš„å¸ƒå±€. node0 çš„å†…å­˜å ç”¨äº† 512 MiB, å…¶èŒƒå›´
ä» 0x00000000 åˆ° 0x20000000, node1 çš„èŒƒå›´ä» 0x20000000 åˆ° 0x40000000. å›¾ä¸Šä¿¡æ¯
ä¸­ "0x3ffdefff" ä¹‹åçš„å†…å­˜ä¸ºé¢„ç•™å†…å­˜.

-----------------------------------------------

###### M

{% highlight bash %}
        sudo ${QEMUT} ${ARGS} \
        -smp 2 \
        -cpu host \
        -enable-kvm \
        -m 4G \
        -kernel ${LINUX_DIR}/${ARCH}/boot/bzImage \
        -initrd ${ROOT}/BiscuitOS.img \
        -nographic \
        -append "${CMDLINE}"
{% endhighlight %}

QEMU/KVM çš„ "M" é€‰é¡¹ç”¨äºé…ç½®ç³»ç»Ÿå†…å­˜æ¨¡å‹ï¼Œå…¶ä¸­ç”¨äºè®¾ç½®ä½ç«¯ç‰©ç†å†…å­˜å’Œé«˜ç«¯ç‰©ç†
å†…å­˜çš„åˆ’åˆ†ï¼Œå¦‚åŸºäºä¸Šé¢çš„é…ç½®ï¼Œåœ¨ 4 Gig ç‰©ç†å†…å­˜æ¨¡å¼ä¸­ï¼Œå¦‚æœ "-M" çš„é…ç½®å¦‚ä¸‹:

{% highlight bash %}
# QEMU configure
1) qemu -m 4G -M pc
2) qemu -m 4G -M pc-1.7 
3) qemu -m 4G -M pc,max-ram-below-4g=2G
4) qemu -m 3968M -M pc,max-ram-below-4g=4G
{% endhighlight %}

å¦‚æœ QEMU/KVM ä¸­ "-M" çš„é…ç½®æ˜¯ pcï¼Œé‚£ä¹ˆåœ¨ 4G çš„ç‰©ç†å†…å­˜ä¸­ï¼Œ3072 MiB è¢«åˆ’åˆ†ä¸º
ä½ç«¯å†…å­˜ï¼Œè€Œå‰©ä½™çš„ 1024 MiB åˆ™ä½œä¸ºé«˜ç«¯ç‰©ç†å†…å­˜. å¦‚åœ¨è¿™ç§é…ç½®ä¸‹ï¼ŒLinux å®é™…è¿è¡Œ
æƒ…å†µ:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000448.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œä½ç«¯å†…å­˜çš„æœ€å¤§å¯ç”¨ç‰©ç†å†…å­˜å¹¶é™å®šåœ¨ "0xBFFDEFFF"ï¼Œå³ "3072 MiB"ã€‚
è€Œè¶…è¿‡ 0x100000000 çš„é•¿åº¦åˆ™æ˜¯ 1 Gigã€‚

å¦‚æœ QEMU/KVM ä¸­ "-M" çš„é…ç½®æ˜¯ "pc,max-ram-below-4g=2g"ï¼Œé‚£ä¹ˆåœ¨ 4G çš„ç‰©ç†å†…å­˜
ä¸­ï¼Œ2048 MiB è¢«åˆ’åˆ†ä¸ºä½ç«¯å†…å­˜ï¼Œè€Œå‰©ä½™çš„ 2048 MiB åˆ™ä½œä¸ºé«˜ç«¯ç‰©ç†å†…å­˜. å¦‚åœ¨è¿™ç§
é…ç½®ä¸‹ï¼ŒLinux å®é™…è¿è¡Œæƒ…å†µ:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000455.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œä½ç«¯å†…å­˜çš„æœ€å¤§å¯ç”¨ç‰©ç†å†…å­˜é™åˆ¶åœ¨ 2G çš„ä½ç½®ï¼Œå†ç»è¿‡ seaBIOS ä»
ä½ç«¯åœ°å€æœ«ç«¯è¿›è¡Œé¢„ç•™ï¼Œæœ€ç»ˆä½ç«¯æœ€å¤§å¯ç”¨ç‰©ç†å†…å­˜ä¸º "0x7ffdffff"ï¼Œè€Œé«˜ç«¯ç‰©ç†å†…å­˜
çš„åœ°å€åˆ™ä» "0x100000000" åˆ° "0x17fffffff"ã€‚

å¦‚æœ QEMU/KVM ä¸­ "-M" çš„é…ç½®æ˜¯ "-m 3968M -M pc,max-ram-below-4g=4G"ï¼Œé‚£ä¹ˆåœ¨
4G çš„ç‰©ç†å†…å­˜ä¸­ï¼Œ3968 MiB å…¨éƒ¨è¢«åˆ’åˆ†ä¸ºä½ç«¯å†…å­˜. å¦‚åœ¨è¿™ç§é…ç½®ä¸‹ï¼ŒLinux å®é™…è¿
è¡Œæƒ…å†µ:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000456.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œä½ç«¯å†…å­˜çš„æœ€å¤§å¯ç”¨ç‰©ç†å†…å­˜é™åˆ¶åœ¨ 4G çš„ä½ç½®ï¼Œä½†ç”±äºå†…å­˜å¤§å°ä¸º
3968 MiBï¼Œå†ç»è¿‡ seaBIOS ä»ä½ç«¯åœ°å€æœ«ç«¯è¿›è¡Œé¢„ç•™ï¼Œæœ€ç»ˆä½ç«¯æœ€å¤§å¯ç”¨ç‰©ç†å†…å­˜ä¸º 
"0xf7fdffff"ã€‚

å¦‚æœ QEMU/KVM ä¸­ "-M" çš„é…ç½®æ˜¯ "pc-1.7"ï¼Œé‚£ä¹ˆåœ¨ 4G çš„ç‰©ç†å†…å­˜ä¸­ï¼Œ3584 MiB è¢«åˆ’
åˆ†ä¸ºä½ç«¯å†…å­˜ï¼Œè€Œå‰©ä½™çš„ 512 MiB åˆ™ä½œä¸ºé«˜ç«¯ç‰©ç†å†…å­˜.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0003">QEMU/KVM ä¸­ä¿®æ”¹ CMOS ç›¸å…³çš„å†…å­˜é…ç½®</span>

QEMU/KVM ä¸­æä¾›äº† rtc_set_memory() å‡½æ•°ç”¨äºè®¾ç½® CMOS ä¸­ç‰¹å®šçš„å†…å­˜. QEMU/KVM
è®¾ç½®å®Œ CMOS ä¹‹åï¼Œä¼šå°†å…¶ä¼ é€’ç»™ seaBIOS, seaBIOS ä¼šæ ¹æ® CMOS é‡Œé¢çš„å€¼æ¶æ„åŸºç¡€
çš„å†…å­˜å¸ƒå±€ï¼Œå› æ­¤åœ¨ä¿®æ”¹ CMOS å†…å­˜åŒºåŸŸçš„æ—¶å€™ï¼Œä¸€å®šè¦æ…é‡. å¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£
ç è¿›è¡Œæ·»åŠ :

{% highlight bash %}
#include "hw/timer/mc146818rtc.h"

int BiscuitOS_demo(ISAdevice *s)
{
	int val = 0xe0000;

	rtc_set_memory(s, 0x17, val);
	rtc_set_memory(s, 0x18, val >> 8);

        return 0;
}
{% endhighlight %}

å‡½æ•°å¯ä»¥åœ¨å¾ˆå¤šä½ç½®è¿›è¡Œæ’å…¥ï¼Œä½†è¦ç¡®ä¿æ’å…¥ä¼ å…¥ "ISAdevice *s" çš„æŒ‡é’ˆã€‚å»ºè®®å¯ä»¥
åœ¨ pc_init1() å‡½æ•°ä¸­è¿›è¡Œè°ƒç”¨. CMOS å†…å­˜åˆ†å¸ƒå›¾å¦‚ä¸‹:

> - [seaBIOS CMOS å†…å­˜åˆ†å¸ƒå›¾](https://biscuitos.github.io/blog/MMU-seaBIOS_E820/#B0001)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0004">QEMU/KVM ä¸­å‘ hw_cfg ä¸­æ·»åŠ å†…å®¹</span>

QEMU/KVM é€šè¿‡ hw_cfg å›ºä»¶å°†ç³»ç»Ÿé…ç½®ä¿¡æ¯ä¼ é€’ç»™ seaBIOS, ä¾‹å¦‚ "e820_reserve" è¡¨
å’Œ "etc/e820" æ–‡ä»¶ç­‰ã€‚QEMU/KVM æä¾›äº†å¤šä¸ªæ¥å£ç”¨äºå‘ hw_cfg å›ºä»¶ä¸­å†™å…¥ä¿¡æ¯ï¼Œ
å¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç :

{% highlight bash %}
#include "hw/nvram/fw_cfg.h"

int BiscuitOS_demo(void)
{
	...

	fw_cfg_add_bytes(fw_cfg, FW_CFG_E820_TABLE,
				&e820_reserve, sizeof(e820_reserve));
	fw_cfg_add_file(fw_cfg, "etc/e820", e820_table,
				sizeof(struct e820_entry) * e820_entries);

        return 0;
}
{% endhighlight %}

å»ºè®®åœ¨ bochs_bios_init() å‡½æ•°ä¸­è¿›è¡Œè°ƒç”¨.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

<span id="C"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000I.jpg)

#### E820 QEMU/KVM å®è·µ

> - [å®è·µå‡†å¤‡](#C0000)
>
> - [å®è·µéƒ¨ç½²](#C0001)
>
> - [å®è·µæ‰§è¡Œ](#C0002)
>
> - [è°ƒè¯•å»ºè®®](#C0004)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

--------------------------------------------

#### <span id="C0000">å®è·µå‡†å¤‡</span>

BiscuitOS æä¾›äº†åŸºäº Linux 5.0 i386 æ¶æ„å’Œ x86_64 æ¶æ„çš„ E820 QEMU/KVM å®è·µï¼Œ
ä¸¤ä¸ªæ¶æ„çš„å®è·µæ–¹æ³•ç±»ä¼¼ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®è‡ªå·±å®é™…æƒ…å†µè¿›è¡Œå®è·µã€‚æœ¬å®è·µæ˜¯åŸºäº
BiscuitOS Linux 5.0 i386 ç¯å¢ƒè¿›è¡Œæ­å»ºè®²è§£ï¼Œå› æ­¤å¼€å‘è€…é¦–å…ˆå‡†å¤‡å®è·µç¯å¢ƒï¼Œè¯·æŸ¥çœ‹
å¦‚ä¸‹æ–‡æ¡£è¿›è¡Œæ­å»º:

> - [BiscuitOS Linux 5.0 i386 ç¯å¢ƒéƒ¨ç½²](https://biscuitos.github.io/blog/Linux-5.0-i386-Usermanual/)
>
> - [BiscuitOS Linux 5.0 X86_64 ç¯å¢ƒéƒ¨ç½²](https://biscuitos.github.io/blog/Linux-5.0-x86_64-Usermanual/)

--------------------------------------------

#### <span id="C0001">å®è·µéƒ¨ç½²</span>

å‡†å¤‡å¥½åŸºç¡€å¼€å‘ç¯å¢ƒä¹‹åï¼Œå¼€å‘è€…æ¥ä¸‹æ¥è¿›è¡Œ QEMU/KVM ç¯å¢ƒæ­å»ºã€‚QEMU/KVM æºç é»˜è®¤
å­˜åœ¨äº BiscuitOS é¡¹ç›®ä¸­ï¼Œå…·ä½“è·¯å¾„å¦‚ä¸‹:

{% highlight bash %}
BiscuitOS/output/linux-5.0-i386/qemu-system/qemu-system/
{% endhighlight %}

QEMU/KVM çš„æºç é…ç½®å’Œç¼–è¯‘å¯ä»¥å‚è€ƒå¦‚ä¸‹å‘½ä»¤ï¼Œ(å¼€å‘è€…è¯·æ³¨æ„æºç é…ç½®åªéœ€æ‰§è¡Œä¸€æ¬¡
ä¹‹åï¼Œå¯ä»¥ç›´æ¥ç¼–è¯‘æºç )

{% highlight bash %}
cd BiscuitOS/output/linux-5.0-i386/qemu-system/qemu-system/
./configure --target-list=i386-softmmu,i386-linux-user --enable-kvm --enable-virtfs
make -j8
{% endhighlight %}

X86_64 æ¶æ„çš„é…ç½®å’Œç¼–è¯‘å¯ä»¥å‚è€ƒå¦‚ä¸‹å‘½ä»¤:

{% highlight bash %}
cd BiscuitOS/output/linux-5.0-x86_64/qemu-system/qemu-system
./configure --target-list=x86_64-softmmu,x86_64-linux-user --enable-kvm --enable-virtfs
make -j8
{% endhighlight %}

è‡³æ­¤ QEMU/KVM æºç çš„å¼€å‘ç¯å¢ƒå·²ç»æ­å»ºå®Œæˆï¼Œå¼€å‘è€…å¯ä»¥ç»§ç»­å‚è€ƒä¸‹é¢ç« èŠ‚è¿›è¡Œ 
QEMU/KVM çš„ä½¿ç”¨.

---------------------------------------

#### <span id="C0002">å®è·µæ‰§è¡Œ</span>

ç¯å¢ƒéƒ¨ç½²å®Œæ¯•ä¹‹åï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥è¿è¡Œ BiscuitOSï¼Œè¿™æ ·å³è¿è¡Œæœ€æ–°ç¼–è¯‘çš„ QEMU/KVM,
ç”±äº QEMU/KVM è¿è¡Œé€Ÿåº¦ç‰¹åˆ«å¿«ï¼Œå¼€å‘è€…å¦‚æœæƒ³å•ç‹¬è°ƒè¯• QEMU/KVM æˆ–è€…çœ‹åˆ° QEMU/KVM 
ä¿¡æ¯è¾“å‡ºï¼Œå¼€å‘è€…å¯ä»¥åœ¨ QEMU/KVM çš„æºç ä¸­æ·»åŠ ä¸€äº›å»¶æ—¶ã€‚å»ºè®®å¼€å‘è€…åœ¨ QEMU/KVM 
æºç ä¸­çš„ "hw/i386/pc_piix.c" æ–‡ä»¶çš„ pc_init1() å‡½æ•°ç»“å°¾æ·»åŠ å¦‚ä¸‹ä»£ç :

{% highlight bash %}
    printf("QEMU-KVM on BiscuitOS\n");
    sleep(5);
{% endhighlight %}

è®©æ•´ä¸ªå¯åŠ¨åœ¨ QEMU/KVM åœç•™ä¸€æ®µæ—¶é—´ï¼Œè¿™æ ·ä¾¿äºæŸ¥çœ‹ QEMU/KVM çš„è°ƒè¯•ä¿¡æ¯ã€‚ä¿®æ”¹å®Œ
ä¸Šé¢çš„é…ç½®ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¿è¡Œæ–°ç¼–è¯‘ QEMU/KVM çš„ BiscuitOS äº†ï¼Œå¼€å‘è€…ä½¿ç”¨å¦‚ä¸‹
å‘½ä»¤:

{% highlight bash %}
cd BiscuitOS/output/linux-5.0-i386/
./RunBiscuitOS.sh
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000443.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º BiscuitOS åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå·²ç»åœç•™åœ¨ QEMU/KVM  ä¸€æ®µæ—¶é—´ï¼Œå¹¶è¾“å‡º
äº†è¯¥é˜¶æ®µçš„è°ƒè¯•ä¿¡æ¯ï¼Œå› æ­¤ QEMU/KVM çš„å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆ.

--------------------------------------

###### <span id="C0004">æµ‹è¯•å»ºè®®</span>

QEMU/KVM çš„è°ƒè¯•æ–¹æ³•å¾ˆå¤šï¼Œå¯ä»¥ä½¿ç”¨ GDB ç­‰å·¥å…·ã€‚è¿™é‡Œä»‹ç»æœ€ä¾¿æ·çš„æ–¹æ³•ï¼Œå³ä½¿ç”¨ 
"printf" å‡½æ•°æ‰“å°ä¿¡æ¯ï¼Œå¼€å‘è€…å¯ä»¥åœ¨ QEMU/KVM çš„ä»»ä½•æ–‡ä»¶ä¸­ä½¿ç”¨ printf è¾“å‡ºè°ƒè¯•
ä¿¡æ¯ã€‚ä½†ç”±äº QEMU/KVM è¿è¡Œå¤ªå¿«ï¼Œæ­£å¸¸æƒ…å†µä¸‹çœ‹ä¸åˆ°è¾“å‡ºçš„ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦åœ¨ QEMU/KVM
ä¸­æ·»åŠ ä¸€äº›å»¶æ—¶ï¼Œä»¥ä¾¿æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯ã€‚å»ºè®®å¼€å‘è€…åœ¨ QEMU/KVM æºç ä¸­çš„ 
"hw/i386/pc_piix.c" æ–‡ä»¶çš„ pc_init1() å‡½æ•°ç»“å°¾æ·»åŠ å¦‚ä¸‹ä»£ç :

{% highlight bash %}
    printf("QEMU-KVM on BiscuitOS\n");
    sleep(5);
{% endhighlight %}

è®©æ•´ä¸ªå¯åŠ¨åœ¨ QEMU/KVM åœç•™ä¸€æ®µæ—¶é—´ï¼Œè¿™æ ·ä¾¿äºæŸ¥çœ‹ QEMU/KVM çš„è°ƒè¯•ä¿¡æ¯ã€‚ä¿®æ”¹å®Œ
ä¸Šé¢çš„é…ç½®ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¿è¡Œæ–°ç¼–è¯‘ QEMU/KVM çš„ BiscuitOS äº†ï¼Œå¼€å‘è€…ä½¿ç”¨å¦‚ä¸‹
å‘½ä»¤:

{% highlight bash %}
cd BiscuitOS/output/linux-5.0-i386/
./RunBiscuitOS.sh
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000443.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º BiscuitOS åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå·²ç»åœç•™åœ¨ QEMU/KVM  ä¸€æ®µæ—¶é—´ï¼Œå¹¶è¾“å‡º
äº†è¯¥é˜¶æ®µçš„è°ƒè¯•ä¿¡æ¯ï¼Œå› æ­¤ QEMU/KVM çš„å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆ.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

<span id="D"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000B.jpg)

#### E820 QEMU/KVM æºç åˆ†æ

> - [E820 QEMU/KVM å¯åŠ¨æµç¨‹](#D0)
>
> - [E820 QEMU/KVM æ•°æ®ç»“æ„](#D1)
>
>   - [struct e820_entry](#D100)
>
>   - [struct e820_table](#D102)
>
>   - [E820_RAM](#D101)
>
>   - [E820_RESERVED](#D101)
>
>   - [E820_ACPI](#D101)
>
>   - [E820_NVS](#D101)
>
>   - [E820_UNUSABLE](#D101)
>
>   - [e820_reserve](#D103)
>
>   - [e820_table](#D104)
>
>   - [e820_entries](#D105)
>
> - [E820 QEMU/KVM å‡½æ•°](#D2)
>
>   - [e820_add_entry](#D202)
>
>   - [e820_get_entry](#D201)
>
>   - [e820_get_num_entries](#D200)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

###### <span id="D0">E820 QEMU/KVM å¯åŠ¨æµç¨‹</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000441.png)

E820 QEMU/KVM å¯åŠ¨æµç¨‹æ˜¯ä» QEMU ä¸­è·å¾—ç›¸åº”çš„å†…å­˜å‚æ•°ï¼Œå°†å…¶è®¡ç®—ä¹‹åå­˜å…¥ E820 
Table é‡Œé¢ï¼Œå¹¶é€šè¿‡ hw_cfg å’Œ CMOS çš„æ–¹å¼ä¼ é€’ç»™ seaBIOS ä½¿ç”¨.

> - [kvm_arch_init](#D01)
>
> - [pc_init1](#D02)
>
> - [pc_memory_init](#D03)
>
> - [bochs_bios_init](#D04)
>
> - [pc_cmos_init](#D05)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

<span id="D01"></span>
![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000436.png)

QEMU/KVM å¯åŠ¨è¿‡ç¨‹ä¸­ï¼ŒKVM ä¸ºäº†å…¼å®¹è¾ƒæ—©ç‰ˆæœ¬çš„ CPU 16-bit ä»£ç ï¼ŒKVM ä½¿ç”¨ vm86 è¿›
è¡Œæ¨¡æ‹Ÿ. ä¸ºäº†åœ¨è¿™äº›æ—©æœŸç‰ˆæœ¬çš„ CPU ä¸Šæ”¯æŒ vm86 æ¨¡å¼ï¼Œé‚£ä¹ˆ KVM å¿…é¡»æä¾›ä¸€ä¸ª TSS
å’Œ "EPT identity map", è¿™äº›æ•°æ®çš„ä½¿ç”¨ä¼šå ç”¨ä¸€éƒ¨åˆ† Guest è™šæ‹Ÿæœºçš„ç‰©ç†å†…å­˜ï¼Œå› æ­¤
éœ€è¦ä¸º Guest å»ºç«‹ç›¸åº”çš„ E820 å…¥å£ï¼Œå¹¶è®¾ç½®è¿™ä¸ª E820 å†…å­˜åŒºåŸŸåœ¨ Guest å†…æ ¸ä¸­çš„
èµ·å§‹åœ°å€. è¿™æ®µå†…å­˜åŒºåŸŸä¼šå ç”¨ 4 PAGE_SIZE çš„ Guest ç‰©ç†å†…å­˜. åœ¨è€ç‰ˆæœ¬çš„ KVM ä¸­ï¼Œ
KVM å¯èƒ½ä¸æ”¯æŒ KVM_CAP_SET_IDENTITY_MAP_ADDRï¼Œå› æ­¤éœ€è¦å°† identity_base è®¾ç½®ä¸º
é»˜è®¤çš„ "0xfffbc000", æ­¤æ—¶æ”¯æŒæœ€å¤§çš„ 256 KiB; å¦‚æœ KVM æ”¯æŒ 
KVM_CAP_IDENTITY_MAP_ADDR, é‚£ä¹ˆ KVM ä¸º vm86 åˆ†é… 16 MiB çš„ç‰©ç†å†…å­˜ï¼Œå› æ­¤å°†
identity_base è®¾ç½®ä¸º 0xfeffc000, å¹¶å°† identity_base çš„å€¼ä¼ é€’ç»™ /dev/kvm è¿›è¡Œ
ç›¸åº”çš„å¯„å­˜å™¨è®¾ç½®.

ä¸ºäº†æ”¯æŒ vm86 æ¨¡å¼ï¼Œå‡½æ•°åœ¨ 1586 è¡Œå°† TSS è®¾ç½®ä¸º identity_base ä¹‹åä¸€ä¸ªé¡µçš„ä½ç½®.
è®¾ç½®ä¸º KVM ä¹‹åï¼Œå‡½æ•°è°ƒç”¨ e820_add_entry() å‡½æ•°å°†èµ·å§‹åœ°å€ä¸º "identity_size" é•¿
åº¦ä¸º 0x4000 çš„ 4 ä¸ª PAGE_SIZE ç©ºé—´è¿›è¡Œé¢„ç•™ï¼ŒQEMU/KVM ä¼šé€šè¿‡ fw_cfg å›ºä»¶ä¼ é€’ç»™
seaBIOS ä½¿ç”¨.

<span id="D02"></span>
![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000437.png)

å‡½æ•° pc_init1 é¦–å…ˆä» QEMU è·å¾— RAM çš„å¤§å°ï¼Œç„¶åæ ¹æ®å†…å­˜å¤§å°å°†å°äº 4G çš„ç‰©ç†å†…
å­˜åˆ’åˆ†ä¸ºä½ç«¯å†…å­˜å’Œé«˜ç«¯å†…å­˜ã€‚ä¼ ç»Ÿçš„åˆ’åˆ†ä¸º 3.5 Gig ä¸ºä½ç«¯å†…å­˜ï¼Œ512 MiB ä¸ºé«˜ç«¯å†…
å­˜ã€‚åœ¨æ–°ç‰ˆä¸­ï¼Œ3072 MiB ä¸ºä½ç«¯å†…å­˜ï¼Œ1024 MiB ä¸ºé«˜ç«¯å†…å­˜. å½“ QEMU é€‰é¡¹ä¸­ï¼Œå°†
max-ram-blow-4g è®¾ç½®ä¸º 2 Gig ä¹‹åï¼Œé‚£ä¹ˆä½ç«¯å†…å­˜ 2048 MiB, é«˜ç«¯å†…å­˜ä¹Ÿæ˜¯ 2048 MiB;
å¦‚æœ max-ram-blow-4g è®¾ç½®ä¸º 4 Gig ä¹‹åï¼Œé‚£ä¹ˆä½ç«¯å†…å­˜æ˜¯ 3968 MiBï¼Œé«˜ç«¯å†…å­˜ä¸º
128 MiBã€‚é€šè¿‡ä¸Šé¢çš„è®¡ç®—ï¼Œå‡½æ•°å°† pcms->max_ram_below_4g è®¾ç½®ä¸º 0xe0000000ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000438.png)

pc_init1() å‡½æ•°è®¡ç®—å®Œå†…å­˜ä¹‹åï¼Œå‡½æ•°åœ¨ 184-185 è¡Œè°ƒç”¨ pc_memory_init() å‡½æ•°è¿›è¡Œ
å†…å­˜çš„åˆ†é…å’ŒåŠ è½½ ROM/BIOSã€‚

<span id="D03"></span>
![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000439.png)

å‡½æ•° pc_memory_init å°† pc_init1() å‡½æ•°ä¸­è®¡ç®—å‡ºçš„ pcns->below_4g_mem_size ä¿¡æ¯
ä½œä¸ºå¯ç”¨ç‰©ç†å†…å­˜æ’å…¥åˆ° e820_table é‡Œï¼Œè¯¥å†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€ä¸º 0. å‡½æ•°æ¥ç€åœ¨ 
1361 è¡Œåˆ¤æ–­ï¼Œå¦‚æœå½“å‰ç‰©ç†å†…å­˜å¤§äº 4Gï¼Œé‚£ä¹ˆå‡½æ•°å°†èµ·å§‹åœ°å€ä¸º "0x100000000"ï¼Œé•¿åº¦
ä¸º pcms->above_4g_mem_size çš„å†…å­˜åŒºåŸŸæ’å…¥åˆ° e820_table ä½œä¸ºå¯ç”¨ç‰©ç†å†…å­˜ã€‚ç»è¿‡
ä¸Šé¢çš„æ“ä½œï¼ŒGuest çš„å¯ç”¨ç‰©ç†å†…å­˜è®¾ç½®å®Œæ¯•ï¼Œå¯ä»¥åœ¨ seaBIOS ä¸­æŸ¥çœ‹åˆ°ç›¸åº”çš„ä¿¡æ¯.

<span id="D04"></span>
![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000440.png)

bochs_bios_init() å‡½æ•°çš„ä¸»è¦ä»»åŠ¡å°† e820_table, åŠå…¨éƒ¨çš„ E820 å†…å­˜åŒºåŸŸåŠ å…¥åˆ°
fw_cfg å›ºä»¶é‡Œï¼ŒseaBIOS å°±å¯ä»¥é€šè¿‡è¯»å– "etc/e820" ç›®å½•è¯»å–ç›¸åº”çš„ä¿¡æ¯. å‡½æ•°åœ¨
781 è¡Œè°ƒç”¨ fw_cfg_add_bytes() å‡½æ•°å°† e820_reserve è¡¨åŠ å…¥åˆ° fw_cfg å›ºä»¶é‡Œï¼Œ
e820_reserve è¡¨é‡Œå­˜å‚¨ç€ E820 æ‰€æœ‰çš„é E820_RAM å†…å­˜åŒºåŸŸ. å‡½æ•°åœ¨ 783 è¡Œè°ƒç”¨
fw_cfg_add_file() å‡½æ•°å°† e820_table å†…æ‰€æœ‰å†…å­˜åŒºåŸŸéƒ½åŠ å…¥åˆ° fw_cfg å›ºä»¶.

<span id="D05"></span>
![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000442.png)

pc_cmos_init() å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯ä¸º seaBIOS æ„é€ å†…å­˜ç›¸å…³çš„ CMOS é…ç½®. å‡½æ•°åœ¨
452-454 è¡ŒæŒ‰ KiB ä¸ºå•ä½ç»Ÿè®¡ä½ 4G çš„å†…å­˜å€¼ï¼Œå¹¶å°† 0-1 MiB çš„å†…å­˜ä¿¡æ¯æŒ‰ 8bit çš„
æ ¼å¼å†™å…¥åˆ° CMOS çš„ 0x15-0x16 ä½ç½®. å‡½æ•°åœ¨ 456-460 è¡Œè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ€»å†…å­˜å¤§äº
1 MiBï¼Œé‚£ä¹ˆå‡½æ•°è®¡ç®—å‡ºæ€»å†…å­˜å‡å» 1 MiB çš„å¤§å°; åä¹‹å¦‚æœæ€»ç‰©ç†å†…å­˜å°äº 1 MiBï¼Œ
é‚£ä¹ˆå‡½æ•°å°† val è®¾ç½®ä¸º 0ï¼Œä»£è¡¨å†…å­˜é…ç½®ä¸å¤§äº 1 MiB. å‡½æ•°åœ¨ 461 è¡Œè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœ
æ­¤æ—¶ val çš„å€¼å¤§äº 65535 é‚£ä¹ˆå°†å…¶è®¾ç½®ä¸º 65535ï¼Œä»¥ä¾¿è·å¾— 1-64 MiB å†…å­˜å¤§å°ä¿¡æ¯ï¼Œ
å‡½æ•°åœ¨ 463-466 è¡Œå°† 1-64 MiB ç‰©ç†å†…å­˜ä¿¡æ¯å†™å…¥ CMOS çš„ 0x17/0x18/0x30/0x31 é‡Œ.
æœ€åå‡½æ•°è®¡ç®—è¶…è¿‡ 64 MiB ä½†å°äº 4 Gig çš„å†…å­˜å¤§å°ï¼Œé‡‡ç”¨ç±»ä¼¼çš„è®¡ç®—æ–¹æ³•ï¼Œä½†æ­¤æ—¶
ä»¥ 64 KiB ä¸ºå•ä½è¿›è¡Œç»Ÿè®¡ï¼Œè®¡ç®—çš„ç»“æœå†™å…¥åˆ° CMOS çš„ 0x34/0x35. å¦‚æœå†…å­˜çš„å¤§å°
è¶…è¿‡ 4 Gigï¼Œé‚£ä¹ˆå‡½æ•°æŒ‰ 64 KiB ä¸ºå•ä½ï¼Œå°†å†…å­˜ä¿¡æ¯å†™å…¥ CMOS çš„ 0x5b/0x5c/0x5d 
é‡Œé¢. è‡³æ­¤ CMOS å†…å­˜ç›¸å…³çš„é…ç½®å·²ç»è®¾ç½®å®Œæ¯•.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

###### <span id="D202">e820_add_entry</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000434.png)

e820_add_entry() å‡½æ•°ç”¨äºå‘ e820_table è¡¨æ·»åŠ ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œå¦‚æœå†…å­˜åŒºåŸŸçš„ç±»å‹æ˜¯
E820_RESERVED, é‚£ä¹ˆå‡½æ•°è¿˜ä¼šå‘ e820_reserve è¡¨ä¸­æ·»åŠ ä¸€ä¸ªå†…å­˜åŒºåŸŸ. å‚æ•° address
æŒ‡å‘æ–°å†…å­˜åŒºåŸŸçš„èµ·å§‹ç‰©ç†åœ°å€, å‚æ•° length æŒ‡å‘å†…å­˜åŒºåŸŸçš„é•¿åº¦ï¼Œå‚æ•° type æŒ‡æ˜
å†…å­˜åŒºåŸŸçš„ç±»å‹.

QEMU/KVM ä¸€å…±å®šä¹‰äº†ä¸¤å¼  E820 Table, å…¶ä¸­ä¸€å¼  e820_reserve ç”¨äºå­˜å‚¨é E820_RAM
çš„å†…å­˜åŒºåŸŸï¼Œè€Œå¦å¤–ä¸€å¼  e820_table åˆ™å­˜å‚¨æ‰€æœ‰çš„å†…å­˜åŒºåŸŸ. å‡½æ•°é¦–å…ˆåœ¨ 634 è¡Œè¯»å–
e820_reserve è¡¨ä¸­å†…å­˜åŒºåŸŸçš„æ•°é‡ï¼Œç„¶ååœ¨ 637 è¡Œåˆ¤æ–­å†…å­˜åŒºåŸŸæ˜¯å¦ä¸ºé E820_RAM åŒº
åŸŸï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆå‡½æ•°æ‰§è¡Œ 637-649 è¡Œä»£ç ï¼Œåœ¨è¿™æ®µä»£ç é€»è¾‘ä¸­ï¼Œå‡½æ•°é¦–å…ˆæ£€æµ‹å½“å‰
e820_reserve è¡¨æ˜¯å¦å·²ç»æ»¡äº†ï¼Œå³è¡¨ä¸­å†…å­˜åŒºåŸŸçš„æ•°é‡è¶…è¿‡ E820_NR_ENTRIESï¼Œå¦‚æœæ£€æµ‹
è¶…è¿‡ï¼Œé‚£ä¹ˆå‡½æ•°ç›´æ¥è¿”å› EBUSY; åä¹‹å‡½æ•°å°† entry æŒ‡å‘ e820_reserve è¡¨ä¸­æ–°çš„ä½ç½®ï¼Œ
ç„¶åå°†æ–°å†…å­˜åŒºåŸŸçš„æ•°æ®å­˜å‚¨åœ¨ entry é‡Œï¼Œæœ€åæ›´æ–° e820_reserve ä¸­å†…å­˜åŒºåŸŸçš„æ•°é‡.

å‡½æ•°åœ¨ 652 è¡Œè°ƒç”¨ g_renew() å‡½æ•°åŠ¨æ€æ‰©å¤§ e820_table è¡¨çš„é•¿åº¦ï¼Œä»¥ä¾¿å®¹çº³æ–°çš„å†…å­˜
åŒºåŸŸã€‚å‡½æ•°åœ¨ 653-655 è¡Œå°†æ–°å†…å­˜åŒºåŸŸçš„ä¿¡æ¯å­˜å‚¨åˆ° e820_table é‡Œï¼Œå¹¶æ›´æ–° e820_table
å†…å­˜åŒºåŸŸçš„æ•°é‡. æœ€ååœ¨ 658 è¡Œè¿”å› e820_table ä¸­å†…å­˜åŒºåŸŸçš„æ•°é‡.

> - [struct e820_entry è¯¦è§£](#D100)
>
> - [e820_table è¯¦è§£](#D104)
>
> - [e820_reserve è¯¦è§£](#D103)
>
> - [e820_entries è¯¦è§£](#D105)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

###### <span id="D201">e820_get_entry</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000433.png)

e820_get_entry() å‡½æ•°ç”¨äºæ ¹æ®ç´¢å¼•å€¼ä» e820_table è¡¨ä¸­è¯»å–æŒ‡å®šçš„å†…å­˜åŒºåŸŸï¼Œå¹¶å°†
å†…å­˜åŒºåŸŸçš„é•¿åº¦å’Œèµ·å§‹åœ°å€ä¿¡æ¯è¿›è¡Œè¿”å›. å‚æ•° idx ä¸ºæŒ‡å®šå†…å­˜åŒºåŸŸçš„ç´¢å¼•å€¼ï¼Œå‚æ•° type
ä¸ºå†…å­˜åŒºåŸŸçš„ç±»å‹ï¼Œå‚æ•° address å’Œ length ç”¨äºå­˜å‚¨è¿”å›çš„å†…å­˜åŒºåŸŸä¿¡æ¯.

å‡½æ•°åœ¨ 668 è¡Œé¦–å…ˆåˆ¤æ–­ idx æ˜¯å¦å°äº e820_table ç°æœ‰çš„å†…å­˜åŒºåŸŸæ•°é‡ï¼Œå¹¶ä¸”åˆ¤æ–­æŸ¥æ‰¾
åˆ°çš„å†…å­˜åŒºåŸŸç±»å‹æ˜¯å¦ä¸å‚æ•° type çš„ä¸€è‡´ï¼Œå¦‚æœä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼Œé‚£ä¹ˆè§†ä¸ºæŸ¥æ‰¾åˆ°æ‰€éœ€
çš„å†…å­˜åŒºåŸŸï¼Œé‚£ä¹ˆåœ¨ 669-670 è¡Œå°†å†…å­˜åŒºåŸŸçš„ä¿¡æ¯å­˜å‚¨åœ¨ address å’Œ length æŒ‡å®šçš„
å†…å­˜é‡Œï¼Œå¹¶è¿”å› true; å¦åˆ™è¿”å› falseã€‚

> - [e820_table è¯¦è§£](#D104)
>
> - [e820_entries è¯¦è§£](#D105)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

###### <span id="D200">e820_get_num_entries</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000432.png)

e820_get_num_entries() å‡½æ•°ç”¨äºå°†è·å¾— e820_table ä¸­å†…å­˜åŒºåŸŸçš„æ•°é‡.

> - [e820_entries è¯¦è§£](#D105)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

###### <span id="D105">e820_entries</span>

{% highlight bash %}
static unsigned e820_entries;
{% endhighlight %}

e820_entries ç”¨äºæè¿° e820_table ä¸­å†…å­˜åŒºåŸŸçš„æ•°é‡.

> - [e820_table è¯¦è§£](#D104)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

###### <span id="D104">e820_table</span>

{% highlight bash %}
/*
static struct e820_entry *e820_table;
{% endhighlight %}

e820_table æ˜¯ä¸€å¼  E820 Tableï¼Œç”¨äºå­˜å‚¨ QEMU/KVM å®šä¹‰çš„å†…å­˜åŒºåŸŸï¼ŒQEMU/KVM å°†è¿™äº›
å†…å­˜åŒºåŸŸå†™å…¥ "etc/e820" æ–‡ä»¶ä¸­ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ seaBIOSï¼ŒseaBIOS åœ¨ qemu_cfg_e820()
æ–‡ä»¶ä¸­å°†å…¶è§£æå‡ºæ¥ï¼Œå¹¶ä½œä¸º seaBIOS E820 å†…å­˜åŒºåŸŸä½¿ç”¨.

> - [seaBIOS qemu_cfg_e820() å‡½æ•°è¯»å– hw_cfg è¿‡ç¨‹](https://biscuitos.github.io/blog/MMU-seaBIOS_E820/#D1004)
>
> - [struct e820_table è¯¦è§£](#D102)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

###### <span id="D103">e820_reserve</span>

{% highlight bash %}
static struct e820_table e820_reserve;
{% endhighlight %}

e820_reserve æ˜¯ä¸€ä¸ªå¼  E820 Tableï¼Œç”¨äºå­˜å‚¨ QEMU/KVM å®šä¹‰çš„æ‰€æœ‰çš„é¢„ç•™å†…å­˜åŒºåŸŸï¼Œ
QEMU/KVM å°†è¿™äº›æ•°æ®å†™å…¥åˆ° hw_cfg å›ºä»¶é‡Œï¼Œå¹¶å°†è¿™äº›åŒºåŸŸä½œä¸º FW_CFG_E820_TABLE æ•°
æ®ä¼ å…¥åˆ° seaBIOS/BIOS ä¸­ï¼ŒseaBIOS åœ¨ qemu_cfg_e820() å‡½æ•°ä¸­ä½œä¸º hw_cfg å›ºä»¶è¯»
å–å‡ºæ¥. å¹¶ä½œä¸º seaBIOS E820 å†…å­˜åŒºåŸŸä½¿ç”¨.

> - [seaBIOS qemu_cfg_e820() å‡½æ•°è¯»å– hw_cfg è¿‡ç¨‹](https://biscuitos.github.io/blog/MMU-seaBIOS_E820/#D1004)
>
> - [struct e820_table è¯¦è§£](#D102)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

###### <span id="D102">struct e820_table</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000431.png)

QEMU/KVM å®šä¹‰äº† struct e820_table ç»“æ„ï¼Œä½¿ç”¨è¯¥ç»“æ„ç»´æŠ¤ä¸€å¼  E820 Table. æˆå‘˜
count æŒ‡æ˜è¡¨ä¸­å†…å­˜åŒºåŸŸçš„æ•°é‡, entry æˆå‘˜åˆ™ç”¨äºå­˜å‚¨ E820 å†…å­˜åŒºåŸŸ. 
E820_NR_ENTRIES ç”¨äºæŒ‡æ˜ä¸€å¼  E820 Table èƒ½å¤Ÿå®¹çº³æœ€å¤§å†…å­˜åŒºåŸŸçš„æ•°é‡ã€‚

> - [struct e820_entry è¯¦è§£](#D100)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------

###### <span id="D100">struct e820_entry</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000430.png)

QEMU/KVM ä¸­å®šä¹‰äº† struct e820_entry ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“ç”¨äºæè¿° E820 è¡¨ä¸­çš„ä¸€ä¸ª
å†…å­˜åŒºåŸŸ. address æˆå‘˜æŒ‡æ˜äº†å†…å­˜åŒºåŸŸçš„é•¿åº¦; size æˆå‘˜ç”¨äºæŒ‡æ˜å†…å­˜åŒºåŸŸçš„é•¿åº¦ï¼Œ
type ç”¨äºæŒ‡æ˜å†…å­˜åŒºåŸŸçš„ç±»å‹, ç›®å‰ QEMU/KVM æ”¯æŒçš„å†…å­˜ç±»å‹å¦‚ä¸‹:

<span id="D101"></span>
* E820_RAM
  æŒ‡æ˜å†…å­˜åŒºåŸŸä¸ºå¯ç”¨çš„ç‰©ç†å†…å­˜
* E820_RESERVED
  æŒ‡æ˜å†…å­˜åŒºåŸŸä¸ºé¢„ç•™å†…å­˜åŒºåŸŸ
* E820_ACPI
  æŒ‡æ˜å†…å­˜åŒºåŸŸä¸º ACPI Data ä½¿ç”¨
* E820_NVS
  æŒ‡æ˜å†…å­˜åŒºåŸŸä¸º NVDIMM ä½¿ç”¨
* E820_UNUSABLE
  æŒ‡æ˜å†…å­˜åŒºåŸŸä¸å¯ç”¨

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Blog](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>

#### æèµ ä¸€ä¸‹å§ ğŸ™‚

![MMU](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
