---
layout: post
title:  "E820 on seaBIOS"
date:   2020-05-07 09:39:30 +0800
categories: [HW]
excerpt: MMU.
tags:
  - MMU
---

![](/assets/PDB/BiscuitOS/kernel/IND00000L0.PNG)

![](/assets/PDB/RPI/RPI100100.png)

#### ç›®å½•

> - [E820 seaBIOS åŸç†](#A)
>
> - [E820 seaBIOS ä½¿ç”¨](#B)
>
> - [E820 seaBIOS å®è·µ](#C)
>
> - [E820 seaBIOS æºç åˆ†æ](#D)
>
> - [E820 seaBIOS è¿›é˜¶ç ”ç©¶](#E)
>
>   - [Detecting Memory from CMOS](#E1)
>
>   - [Detecting Memory from BDA](#E2)
>
> - [é™„å½•/æèµ ](#Z0)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000T.jpg)

#### E820 seaBIOS åŸç†

BIOS å…¨ç§° "Baisc Input Output System", å®ƒæ˜¯ä¸€ä¸ªå›ºåŒ–åˆ°è®¡ç®—æœºä¸»æ¿ä¸Šçš„ä¸€ä¸ª ROM
èŠ¯ç‰‡ç¨‹åºï¼ŒBIOS ä¿å­˜ç€è®¡ç®—æœºæœ€é‡è¦çš„åŸºæœ¬è¾“å…¥è¾“å‡ºçš„ç¨‹åºã€å¼€æœºåè‡ªæ£€ç¨‹åºå’Œç³»ç»Ÿ
è‡ªå¯åŠ¨ç¨‹åºï¼ŒBIOS ä» CMOS ä¸­è¯»å†™ç³»ç»Ÿè®¾ç½®çš„å…·ä½“ä¿¡æ¯. BIOS è¿˜å‘æ“ä½œç³»ç»Ÿæä¾›ä¸€äº›
ç³»ç»Ÿå‚æ•°ï¼Œç³»ç»Ÿç¡¬ä»¶çš„å˜åŒ–ç”± BIOS éšè—ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ BIOS åŠŸèƒ½è€Œä¸æ˜¯ç›´æ¥æ§åˆ¶
ç¡¬ä»¶ã€‚BIOS é€šè¿‡åœ¨æ“ä½œç³»ç»Ÿåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå‘æ“ä½œç³»ç»Ÿæä¾›ä¸­æ–­ä¾‹ç¨‹ï¼Œè¿™äº›ä¸­æ–­ä¾‹ç¨‹
æ˜¯ç³»ç»Ÿè½¯ä»¶ã€ç¡¬ä»¶ä¹‹é—´ä¸€ä¸ªå¯ç¼–ç¨‹æ¥å£ï¼Œç”¨äºç¨‹åºè½¯ä»¶åŠŸèƒ½ä¸å¾®æœºç¡¬ä»¶å®ç°è¡”æ¥ã€‚æ“ä½œ
ç³»ç»Ÿå¯¹è½¯ç›˜ã€ç¡¬ç›˜ã€å…‰é©±å’Œé”®ç›˜ç­‰å¤–è®¾çš„ç®¡ç†å³å»ºç«‹åœ¨ BIOS åŸºç¡€ä¸Šã€‚å…¶ä¸­æ“ä½œç³»ç»Ÿ
åˆå§‹åŒ–é˜¶æ®µï¼Œå¯ä»¥é€šè¿‡ä¸­æ–­ä¾‹ç¨‹ INT 0x15/0xE820 è·å¾—å†…å­˜åŒºåŸŸå¸ƒå±€ä¿¡æ¯.

seaBIOS æ˜¯ä¸€ä¸ªå¼€æº 16bit x86 BIOS é¡¹ç›®ï¼Œå®ƒå¯ä»¥è¿è¡Œåœ¨æ¨¡æ‹Ÿå™¨ä¸Šã€æˆ–è€…æ˜¯åœ¨ x86 
ç¡¬ä»¶å¹³å°ä¸Šå’Œ coreboot ä¸€èµ·ä½¿ç”¨. BIOS ç¨‹åºæ˜¯è®¡ç®—æœºä¸Šç”µåï¼ŒCPU ç¬¬ä¸€ä¸ªè¿è¡Œçš„ç¨‹
åºï¼Œå®Œå…¨è¿è¡Œåœ¨è£¸é‡‘å±ä¸Šï¼Œç”¨äºå®Œæˆå¯¹ç¡¬ä»¶çš„åˆå§‹åŒ–ï¼Œå¹¶ä¸”ä¸ºå¯åŠ¨æ“ä½œç³»ç»Ÿåšå‡†å¤‡.
BIOS ç¨‹åºä¸ç¡¬ä»¶å…·æœ‰å¾ˆé«˜çš„è€¦åˆåº¦ï¼ŒåŸºæœ¬ä¸Šä¸åŒçš„ç¡¬ä»¶æ¶æ„éƒ½ä¼šæœ‰ä¸åŒçš„ BIOSï¼Œæ‰€ä»¥
å‚å•†ä¼šå®šåˆ¶ BIOSã€‚seaBIOS è™½ç„¶è¿è¡Œåœ¨æ¨¡æ‹Ÿå™¨ä¸Šï¼Œä½†æ˜¯ä¹Ÿæœ‰è‡ªå·±é€‚é…çš„ä¸€å¥—ç¡¬ä»¶æ¶æ„ã€‚

seaBIOS ä¹Ÿåƒæ­£å¸¸ BIOS ä¸€æ ·ï¼Œåœ¨è™šæ‹Ÿæœºä¸Šç”µæ—¶å€™ï¼ŒBIOS ä¼šä» ROM åŠ è½½åˆ°åœ°å€ç©ºé—´
çš„ 0xFFFFFFF0 å¤„ï¼Œå¹¶ä¸”è¯¥å¤„æ˜¯ä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼Œè™šæ‹Ÿæœºçš„è™šæ‹Ÿ CPU ä¼šå»æ‰§è¡Œ seaBIOS
çš„ä»£ç ï¼Œå®Œæˆè™šæ‹Ÿç¡¬ä»¶çš„åˆå§‹åŒ–ã€ä¸­æ–­æœåŠ¡å‡½æ•°çš„è®¾ç½®ã€ACPI è¡¨ã€SMBIOS è¡¨ï¼Œä»¥åŠ
E820 è¡¨çš„åˆ›å»º.

###### seaBIOS ä¸ E820 å…³ç³»

![](/assets/PDB/HK/HK000428.png)

seaBIOS æ¨¡æ‹Ÿ BIOS çš„å·¥ä½œåŸç†, POST ä¸Šç”µè‡ªæ£€ä¹‹åï¼Œä» CMOS è·å¾—å†…å­˜ç›¸å…³ä¿¡æ¯ï¼Œ
ç„¶åå°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨å…¨å±€çš„ e820_list è¡¨ä¸­. seaBIOS åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®ä¸åŒ
å¤–è®¾å¯¹å†…å­˜çš„æ—¶å€™æƒ…å†µï¼Œå°†éƒ¨åˆ†å†…å­˜è¿›è¡Œé¢„ç•™ï¼Œæœ€å seaBIOS æ ¹æ® e820_list çš„
å†…å­˜åŒºåŸŸçš„ä¿¡æ¯æ„å»º IVT å’Œ BDA/EBDA ä¿¡æ¯ï¼Œä»¥ä¾¿å†…æ ¸å¯åŠ¨æ—¶ä½¿ç”¨ E820 ç›¸å…³çš„ä¿¡æ¯.
å…·ä½“æµç¨‹å¯ä»¥å‚è€ƒ:

> - [E820 seaBIOS æºç æµç¨‹åˆ†æ](#D1)

###### E820 seaBIOS ä¸ kernel

![](/assets/PDB/HK/HK000427.png)

seaBIOS åœ¨åˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡è¿‡ç¨‹ä¸­ï¼Œå°†å†…å­˜ä½¿ç”¨ç­‰ä¿¡æ¯å­˜å‚¨åˆ°äº† e820_list, seaBIOS 
åˆ©ç”¨è¿™äº›ä¿¡æ¯æ„å»º IVT å’Œ BDA/EBDA ä¿¡æ¯ï¼ŒseaBIOS å¼•å¯¼å†…æ ¸æˆåŠŸä¹‹åï¼Œå†…æ ¸é€šè¿‡è°ƒç”¨
ä¸­æ–­ä¾‹ç¨‹è·å¾— E820 å†…å­˜ä¿¡æ¯. å†…æ ¸è·å¾—è¿™äº›ä¿¡æ¯åªæœ‰ç€æ‰‹æ„å»ºè‡ªå·±çš„ E820 è¡¨ï¼Œå¹¶ä»¥
æ­¤è¡¨ä¸ºåŸºç¡€æ„å»º Bootmem/MEMBLOCK å†…å­˜åˆ†é…å™¨ï¼Œå¹¶å°†ä¸€éƒ¨åˆ† E820 è¡¨çš„å†…å®¹ä½œä¸ºå†…æ ¸
çš„å›ºä»¶ä¾›ç”¨æˆ·ç©ºé—´ä½¿ç”¨.

###### E820 seaBIOS ä¸ QEMU/KVM

![](/assets/PDB/HK/HK000457.png)

åœ¨è™šæ‹ŸåŒ–æˆ–è€… QEMU ä¸­æ”¯æŒè‡ªå®šä¹‰å†…å­˜ç›¸å…³çš„æ¿çº§ç¡¬ä»¶ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯é€šè¿‡ "hw_cfg" 
å›ºä»¶å’Œ CMOS å†…å­˜ä¼ é€’ç»™ seaBIOSï¼Œå…¶ä¸­ hw_cfg å›ºä»¶ä¸­åŒ…å«äº† QEMU/KVM æ„å»ºçš„
e820_reserve é¢„ç•™å†…å­˜åŒºè¡¨å’Œ "etc/e820" å†…å­˜åŒºåŸŸè¡¨ä¿¡æ¯ï¼ŒQEMU/KVM è¿˜ä¼šåŸºäºå†…å­˜
é…ç½®æ„å»º CMOS å†…å­˜ï¼ŒseaBIOS æ ¼å±€ COMS æ„å»ºåŸºç¡€çš„å†…å­˜å¸ƒå±€ï¼Œå¹¶ç»“åˆ "hw_cfg" æ„å»º
seaBIOS E820 Table.

æœ¬æ–‡å°±ä» seaBIOS å…¥å£ï¼Œç ”ç©¶ BIOS é˜¶æ®µ E820 è¡¨åˆ›å»ºçš„æ•´ä¸ªè¿‡ç¨‹.å¼€å‘è€…å¯ä»¥ä» E820 
seaBIOS æºç æµç¨‹è¿›è¡Œç ”ç©¶ï¼Œå‚è€ƒå¦‚ä¸‹æ–‡æ¡£:

> - [E820 seaBIOS æºç åˆ†æ](#D)

å¼€å‘è€…ä¹Ÿå¯ä»¥åœ¨ BiscuitOS ä¸Šå®è·µ E820 seaBIOS è¡Œä¸ºçš„æ•´ä¸ªè¿‡ç¨‹:

> - [E820 seaBIOS å®è·µ](#C)

å¼€å‘è€…ç ”ç©¶å®Œä¸Šé¢ä¸¤ä¸ªç« èŠ‚ä¹‹åï¼Œå¯ä»¥è‡ªä¸»ä¿®æ”¹ E820 seaBIOS è¡Œä¸ºè¿‡ç¨‹ï¼Œå¼€å‘è€…å¯ä»¥
å‚è€ƒ:

> - [E820 seaBIOS ä½¿ç”¨](#B)

å¼€å‘è€…å¦‚æœç ”ç©¶å®Œä¸Šé¢ä¸‰ä¸ªå†…å®¹ä¹‹åï¼Œå¦‚æœå‘ç»§ç»­æ·±å…¥ç ”ç©¶ E820 seaBIOS, é‚£ä¹ˆå¼€å‘è€…
å¯ä»¥å‚è€ƒ:

> - [E820 seaBIOS è¿›é˜¶ç ”ç©¶](#E)


![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

---------------------------------

<span id="B"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000H.jpg)

#### E820 seaBIOS ä½¿ç”¨

> - [seaBIOS ä¸­æ·»åŠ ä¸€ä¸ª E820 åˆ†åŒº](#B0000)
>
> - [seaBIOS ä¸­ç§»é™¤ä¸€ä¸ª E820 åˆ†åŒº](#B0004)
>
> - [seaBIOS ä¸­æ‰“å° E820 Table](#B0006)
>
> - [CMOS Mapping Table](#B0001)
>
> - [BDA - BIOS Data Area](#B0002)
>
> - [EBDA - Extended BIOS Data Area](#B0005)
>
> - [Real Mode Address Space (\< 1 MiB)](#B0003)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0000">seaBIOS ä¸­æ·»åŠ ä¸€ä¸ª E820 åˆ†åŒº</span>

seaBIOS æä¾›äº† e820_add() å‡½æ•°ç”¨äºå‘ e820_list ä¸­æ·»åŠ ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œæ·»åŠ åçš„
å†…å­˜åŒºåŸŸå°†ä¼ é€’ç»™å†…æ ¸å¯åŠ¨ä½¿ç”¨ï¼Œe820_add() å‡½æ•°æ—¢å¯ä»¥æ·»åŠ å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸï¼Œä¹Ÿå¯
ä»¥é¢„ç•™å†…å­˜åŒºåŸŸ. å¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç è¿›è¡Œæ·»åŠ :

{% highlight bash %}
#include "e820map.h"

int BiscuitOS_demo(void)
{
	u64 address = 0x50000000;
	u64 length = 0x100000;
	u32 type = E820_RESERVED;

	/* Insert a memory region */
	e820_add(address, length, type);

	return 0;
}
{% endhighlight %}

é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼ŒseaBIOS ä¼šå°† 0x50000000-0x50100000 å†…å­˜åŒºåŸŸè¿›è¡Œé¢„ç•™ï¼Œç¼–è¯‘è¿è¡Œ
ä¹‹åï¼Œå¯ä»¥åœ¨ Linux æŸ¥çœ‹å®é™…æ•ˆæœ:

![](/assets/PDB/HK/HK000421.png)

ä»å†…æ ¸çš„ dmesg ä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡º seaBIOS å·²ç»å°†æ–°å¢åŠ çš„ e820 å†…å­˜åŒºåŸŸä¼ é€’ç»™äº†å†…æ ¸ï¼Œ
å†…æ ¸æ¥æ”¶åˆ° e820_list çš„ä¿¡æ¯ä¹‹åï¼Œå°† "0x50000000-0x50100000" ä½œä¸ºç³»ç»Ÿé¢„ç•™åŒºã€‚

> - [e820_add è¯¦è§£](#D34)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0004">seaBIOS ä¸­ç§»é™¤ä¸€ä¸ª E820 åˆ†åŒº</span>

seaBIOS æä¾›äº† e820_remove() å‡½æ•°ç”¨äºä» e820_list ä¸­ç§»é™¤ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œç§»é™¤ä¹‹å
çš„åŒºåŸŸå°†ä¸å† e820_list ä¸­å­˜åœ¨ã€‚seaBIOS å°† e820_list ä¼ é€’ç»™å†…æ ¸ä½¿ç”¨åï¼Œå†…æ ¸å°†
çœ‹ä¸åˆ°ç§»é™¤åŒºåŸŸçš„ä»»ä½•ä¿¡æ¯. å¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç è¿›è¡Œæ·»åŠ :

{% highlight bash %}
#include "e820map.h"

int BiscuitOS_demo(void)
{
        u64 address = 0x30000000;
        u64 length = 0x100000;

        /* Insert a memory region */
        e820_remove(address, length);

        return 0;
}
{% endhighlight %}

é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼ŒseaBIOS ä¼šå°† 0x30000000-0x30100000 å†…å­˜åŒºåŸŸä»ç³»ç»Ÿç§»é™¤ï¼Œç¼–è¯‘è¿è¡Œ
ä¹‹åï¼Œå¯ä»¥åœ¨ Linux æŸ¥çœ‹å®é™…æ•ˆæœ:

![](/assets/PDB/HK/HK000422.png)

ä»å†…æ ¸çš„ dmesg ä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡º seaBIOS å·²ç»å°†æ–°ç§»é™¤çš„ e820 å†…å­˜åŒºåŸŸä¼ é€’ç»™äº†å†…æ ¸ï¼Œ
å†…æ ¸æ¥æ”¶åˆ° e820_list çš„ä¿¡æ¯ä¹‹åï¼Œå†ä¹Ÿçœ‹ä¸åˆ° "0x30000000-0x30100000" ä»»ä½•ä¿¡æ¯ã€‚

> - [e820_remove è¯¦è§£](#D35)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0006">seaBIOS ä¸­æ‰“å° E820 Table</span>

seaBIOS å°†æ‰€æœ‰çš„å†…å­˜åŒºåŸŸå­˜å‚¨åœ¨ e820_list è¡¨ä¸­ï¼Œå¹¶ä½¿ç”¨ e820_count ç»Ÿè®¡ e820_list
è¡¨ä¸­å†…å­˜åŒºåŸŸçš„æ•°é‡ã€‚å› æ­¤å¯ä»¥é€šè¿‡éå†çš„åŠæ³•æ‰“å° E820 Tableã€‚å¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹
ä»£ç è¿›è¡Œæ·»åŠ :

{% highlight bash %}
#include "e820map.h"

int BiscuitOS_demo(void)
{
	int i;

        /* Traversal E820 table */
        for (i = 0; i < e820_count; i++) {
		struct e820entry *e = &e820_list[i];
		u64 e_end = e->start + e->size;

		printf("  %d: %016llx - %016llx = %d\n", i,
                                        e->start, e_end, e->type);
	}

        return 0;
}
{% endhighlight %}

e820_list è¡¨ä¸­å­˜å‚¨æ‰€æœ‰çš„å†…å­˜åŒºåŸŸï¼Œä½¿ç”¨ for å¾ªç¯å°†æ‰€æœ‰å†…å­˜åŒºåŸŸè¿›è¡Œæ‰“å°ï¼Œæ‰“å°
æ•ˆæœå¦‚ä¸‹:

![](/assets/PDB/HK/HK000423.png)

> - [e820_list è¯¦è§£](#D21)
>
> - [e820_count è¯¦è§£](#D22)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0001">CMOS Mapping Table</span>

![](/assets/PDB/HK/HK000405.png)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0002">BDA - BIOS Data Area</span>

![](/assets/PDB/HK/HK000407.png)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0005">EBDA - Extended BIOS Data Area</span>

![](/assets/PDB/HK/HK000424.png)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="B0003">Real Mode Address Space (\< 1 MiB)</span>

![](/assets/PDB/HK/HK000408.png)

{% highlight bash %}
0000:0 1 KiB    Interrupt Vector Table
0040:0 256bytes BIOS Data Area
0050:0          Free memory
07C0:0		Boot code is loaded here at startup (31k mark)
A000:0		EGA/VGA RAM for graphics display mode 0Dh & above
B000:0		MDA RAM, Hercules graphics display RAM
B800:0		CGA display RAM
C000:0		EGA/VGA BIOS ROM (thru C7FF)
C400:0		Video adapter ROM space
C600:0 256bytes PGA communication area
C800:0	 16K	Hard disk adapter BIOS ROM
C800:5		XT Hard disk ROM format, AH=Drive, AL=Interleave
D000:0	 32K	Cluster adapter BIOS ROM
D800:0		PCjr conventionalsoftware cartridge address
E000:0	 64K	Expansion ROM space (hardwired on AT+)
	 128K	PS/2 System ROM (thru F000)
F000:0		System monitor ROM
		PCjr: software cartridge override address
F400:0		System expansion ROMs
F600:0		IBM ROM BASIC (AT)
F800:0		PCjr software cartridge override address
FC00:0		BIOS ROM
FF00:0		System ROM
FFA6:E		ROM graphics character table
FFFF:0		ROM bootstrap code
FFFF:5 8 bytes	ROM date (not applicable for all clones)
FFFF:E	byte	ROM machine id	(see MACHINE ID)
{% endhighlight %}

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------------------

<span id="C"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000I.jpg)

#### E820 seaBIOS å®è·µ

> - [å®è·µå‡†å¤‡](#C0000)
>
> - [å®è·µéƒ¨ç½²](#C0001)
>
> - [å®è·µæ‰§è¡Œ](#C0002)
>
> - [è°ƒè¯•å»ºè®®](#C0004)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

--------------------------------------------

#### <span id="C0000">å®è·µå‡†å¤‡</span>

BiscuitOS æä¾›äº†åŸºäº Linux 5.0 i386 æ¶æ„å’Œ x86_64 æ¶æ„çš„ seaBIOS å®è·µï¼Œä¸¤ä¸ªæ¶æ„
çš„ seaBIOS å®è·µæ–¹æ³•ç±»ä¼¼ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®è‡ªå·±å®é™…æƒ…å†µè¿›è¡Œå®è·µã€‚æœ¬å®è·µæ˜¯åŸºäº 
BiscuitOS Linux 5.0 i386 ç¯å¢ƒè¿›è¡Œæ­å»ºè®²è§£ï¼Œå› æ­¤å¼€å‘è€…é¦–å…ˆå‡†å¤‡å®è·µç¯å¢ƒï¼Œè¯·æŸ¥çœ‹
å¦‚ä¸‹æ–‡æ¡£è¿›è¡Œæ­å»º:

> - [BiscuitOS Linux 5.0 i386 ç¯å¢ƒéƒ¨ç½²](https://biscuitos.github.io/blog/Linux-5.0-i386-Usermanual/)
>
> - [BiscuitOS Linux 5.0 X86_64 ç¯å¢ƒéƒ¨ç½²](https://biscuitos.github.io/blog/Linux-5.0-x86_64-Usermanual/)

--------------------------------------------

#### <span id="C0001">å®è·µéƒ¨ç½²</span>

å‡†å¤‡å¥½åŸºç¡€å¼€å‘ç¯å¢ƒä¹‹åï¼Œå¼€å‘è€…æ¥ä¸‹æ¥è¿›è¡Œ seaBIOS ç¯å¢ƒæ­å»ºã€‚seaBIOS æºç é»˜è®¤å­˜åœ¨
äº BiscuitOS é¡¹ç›®ä¸­ï¼Œå…·ä½“è·¯å¾„å¦‚ä¸‹:

{% highlight bash %}
BiscuitOS/output/linux-5.0-i386/qemu-system/qemu-system/roms/seabios
{% endhighlight %}

ä¸ºäº†è®©å¼€å‘è€…èƒ½å¤Ÿè½»æ¾é«˜æ•ˆçš„è¿›è¡Œ seaBIOS å®è·µï¼Œéœ€è¦å°†é»˜è®¤çš„ BiscuitOS BIOS å¯åŠ¨
é•œåƒåˆ‡æ¢æˆ seaBIOS æºç ç¼–è¯‘çš„é•œåƒï¼Œä»¥åŠè®© BiscuitOS è¿è¡Œæ—¶çš„ç»“æœä¸æœ¬æ–‡ä¾‹å­ä¸­
çš„æƒ…å†µä¸€è‡´ï¼Œå¼€å‘è€…éœ€è¦å¯¹ RunBiscuitOS.sh èŠ‚æœ¬è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹:

{% highlight bash %}
BiscuitOS/output/linux-5.0-i386/RunBiscuitOS.sh
{% endhighlight %}

![](/assets/PDB/HK/HK000414.png)

æ­£å¦‚ä¸Šå›¾çš„ RunBiscuitOS.sh è„šæœ¬ï¼ŒRAM_SIZE å˜é‡ç”¨äºé…ç½® BiscuitOS è¿è¡Œæ—¶çš„ RAM
çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯é€šå¸¸æ‰€è¯´çš„å†…å­˜å¤§å°ï¼Œè¿™é‡Œç»Ÿä¸€è®¾ç½®ä¸º 1024ï¼Œå³å†…å­˜å¤§å°ä¸º 1 Gig.

![](/assets/PDB/HK/HK000415.png)

åœ¨ RunBiscuitOS.sh è„šæœ¬çš„ do_running() å‡½æ•°ä¸­ï¼Œä¿®æ”¹ BiscuitOS çš„å¯åŠ¨å‚æ•°ï¼Œæ–°å¢
BIOS é•œåƒè·¯å¾„ï¼Œå¦‚ä¸‹:

{% highlight bash %}
-bios ${OUTPUT}/qemu-system/qemu-system/roms/seabios/out/bios.bin
{% endhighlight %}

ä¿®æ”¹å®Œä¸Šé¢çš„é…ç½®ä¹‹åï¼Œæ¥ä¸‹æ¥æ˜¯ seaBIOS æºç çš„ç¼–è¯‘ã€‚seaBIOS çš„ç¼–è¯‘å¾ˆä¾¿æ·ï¼Œå¼€å‘è€…
å¯ä»¥å‚ç…§å¦‚ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘:

{% highlight bash %}
cd BiscuitOS/output/linux-5.0-i386/qemu-system/qemu-3.1.0/roms/seabios
make
{% endhighlight %}

![](/assets/PDB/HK/HK000416.png)

è‡³æ­¤ seaBIOS çš„å¼€å‘ç¯å¢ƒå·²ç»æ­å»ºå®Œæˆï¼Œå¼€å‘è€…å¯ä»¥ç»§ç»­å‚ç…§ä¸‹é¢ç« èŠ‚è¿›è¡Œ seaBIOS
çš„ä½¿ç”¨.

--------------------------------------------

#### <span id="C0002">å®è·µæ‰§è¡Œ</span>

ç¯å¢ƒéƒ¨ç½²å®Œæ¯•ä¹‹åï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥è¿è¡Œ BiscuitOSï¼Œè¿™æ ·å³è¿è¡Œæœ€æ–°ç¼–è¯‘çš„ seaBIOS,
ç”±äº seaBIOS è¿è¡Œé€Ÿåº¦ç‰¹åˆ«å¿«ï¼Œå¼€å‘è€…å¦‚æœæƒ³å•ç‹¬è°ƒè¯• seaBIOS æˆ–è€…çœ‹åˆ° seaBIOS ä¿¡æ¯
è¾“å‡ºï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒåœ¨ Linux å¼€å§‹ boot é˜¶æ®µå°± hook ä½å†…æ ¸ï¼Œè¿™æ ·å°±å¯ä»¥ä¾¿æ·è°ƒè¯•
seaBIOSã€‚å»ºè®®å¼€å‘è€…åœ¨ä¸‹é¢çš„ main.c æ–‡ä»¶çš„ main() å‡½æ•°ä¸­æ·»åŠ  "while(1)" ä»£ç ï¼Œ
è®©å†…æ ¸ hook åœ¨è¯¥ä½ç½®ï¼Œè¿™æ ·ä¾¿äºæŸ¥çœ‹ seaBIOS è°ƒè¯•ä¿¡æ¯:

{% highlight bash %}
vi BiscuitOS/output/linux-5.0-i386/linux/linux/arch/x86/boot/main.c
{% endhighlight %}

![](/assets/PDB/HK/HK000418.png)

ä¿®æ”¹å®Œä¸Šé¢çš„é…ç½®ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¿è¡Œå¸¦ seaBIOS çš„ BiscuitOS äº†ï¼Œå¼€å‘è€…ä½¿ç”¨å¦‚ä¸‹
å‘½ä»¤:

{% highlight bash %}
cd /xspace/OpenSource/BiscuitOS/BiscuitOS/output/linux-5.0-i386/
./RunBiscuitOS.sh
{% endhighlight %}

![](/assets/PDB/HK/HK000417.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º seaBIOS å·²ç»æ˜¯ä¿®æ”¹è¿‡çš„ç‰ˆæœ¬ï¼Œå› æ­¤ seaBIOS çš„å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆ.

--------------------------------------

###### <span id="C0004">è°ƒè¯•å»ºè®®</span>

seaBIOS çš„è°ƒè¯•æ–¹æ³•å¾ˆå¤šï¼Œè¿™é‡Œä»‹ç»æœ€ä¾¿æ·çš„æ–¹æ³•ï¼Œå³ä½¿ç”¨ "printf" å‡½æ•°æ‰“å°ä¿¡æ¯ï¼Œ
å¼€å‘è€…å¯ä»¥åœ¨ seaBIOS åˆå§‹åŒ–å®Œä¸²å£å‡½æ•°ä¹‹åè°ƒç”¨ "printf" å‡½æ•°è¾“å‡ºç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚
åœ¨ maininit() å‡½æ•°ä¸­è¾“å‡ºä¿¡æ¯:

{% highlight bash %}
vi BiscuitOS/output/linux-5.0-i386/qemu-system/qemu-3.1.0/roms/seabios/src/post.c
{% endhighlight %}

![](/assets/PDB/HK/HK000419.png)

ç¼–è¯‘ seaBIOS å¹¶è¿è¡Œ BiscuitOS, å¦‚ä¸‹:

![](/assets/PDB/HK/HK000420.png)

ä»ä¸Šå›¾çœ‹åˆ° seaBIOS ä¸­æ–°å¢çš„æ‰“å°ä¿¡æ¯åœ¨è¿è¡Œæ­£å¸¸è¾“å‡º, å¼€å‘è€…å¯ä»¥æ ¹æ®è‡ªå·±æƒ…å†µé‡‡ç”¨
æ›´å¤šçš„è°ƒè¯•æ–¹æ³•.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="D"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000B.jpg)

#### E820 seaBIOS æºç åˆ†æ

> - [E820 seaBIOS å¯åŠ¨æµç¨‹](#D1)
>
> - [E820 seaBIOS æ•°æ®ç»“æ„](#D2)
>
>   - [struct e820entry](#D20)
>
>   - [struct e820_reservation](#D23)
>
>   - [e820_list](#D21)
>
>   - [e820_count](#D22)
>
>   - [E820_RAM](#D24)
>
>   - [E820_RESERVED](#D24)
>
>   - [E820_ACPI](#D24)
>
>   - [E820_NVS](#D24)
>
>   - [E820_UNUSABLE](#D24)
>
>   - [E820_HOLE](#D24)
>
> - [E820 seaBIOS å‡½æ•°](#D3)
>
>   - [dump_map](#D33)
>
>   - [e820_add](#D34)
>
>   - [e820_prepboot](#D36)
>
>   - [e820_type_name](#D32)
>
>   - [e820_remove](#D35)
>
>   - [insert_e820](#D31)
>
>   - [remove_e820](#D30)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

#### <span id="D1">E820 seaBIOS å¯åŠ¨æµç¨‹</span>

![](/assets/PDB/HK/HK000403.png)
![](/assets/PDB/HK/HK000458.png)

E820 seaBIOS çš„åˆå§‹åŒ–æµç¨‹åŸºæœ¬æ•´ç†ä¸ºä» CMOS ä¸­è¯»å–å†…å­˜å¸ƒå±€ä¿¡æ¯ï¼Œç„¶åæ ¹æ®ç³»ç»Ÿ
é…ç½®é¢„ç•™ä¸€å®šçš„å†…å­˜åŒºåŸŸï¼Œæ¥ç€è§£æä» QEMU/KVM ä¸­ä¼ é€’è¿‡æ¥çš„ "hw_cfg" å’Œ "etc/e820"
ä¿¡æ¯ï¼Œç­‰å¾… seaBIOS å¼•å¯¼å†…æ ¸ä¹‹åï¼Œå†…æ ¸é€šè¿‡è°ƒç”¨ä¸­æ–­ä¾‹ç¨‹æ¥è·å¾— E820 è¡¨é‡Œé¢çš„ä¿¡æ¯ã€‚

> - [qemu_preinit](#D1000)
>
> - [malloc_preinit](#D1001)
>
> - [qemu_cfg_e820](#D1004)
>
> - [malloc_prepboot](#D1002)
>
> - [calcRamSize](#D1003)
>
> - [dump_map](#D33)
>
> - [handle_15](#D1005)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)
<span id="D1000"></span>

seaBIOS åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå®Œæˆæ±‡ç¼–ä»£ç ä»£ç ä¹‹åï¼Œè·³è½¬åˆ° handle_post C è¯­è¨€å¤„ç»§ç»­
åˆå§‹åŒ–ï¼Œhandle_post() å‡½æ•°è¿›è¡Œä¸²å£æ‰“å°åˆå§‹åŒ–ï¼Œä»¥åŠ BIOS è®¾ç½®ä¸ºå¯å†™ä¹‹åï¼Œè°ƒç”¨
å‡½æ•° do_post(). åœ¨ do_post() å‡½æ•°å†…éƒ¨ï¼ŒseaBIOS é¦–å…ˆè°ƒç”¨ qemu_preinit() å‡½æ•°
æ¢æµ‹ ram çš„ä¿¡æ¯ï¼Œå¤„ç†å¦‚ä¸‹:

![](/assets/PDB/HK/HK000404.png)

seaBIOS ä» CMOS ä¸­è¯»å–å†…å­˜ç›¸å…³çš„ä¿¡æ¯ã€‚åœ¨ X86 æ¶æ„ä¸­ï¼Œå‚å•†å°†ç¡¬ä»¶ä¿¡æ¯å†™å…¥åˆ° CMOS
æ˜ å°„è¡¨é‡Œï¼ŒBIOS å¯ä»¥é€šè¿‡ IN/OUT æŒ‡ä»¤è¯»å–ç›¸åº”çš„ç¡¬ä»¶ä¿¡æ¯ï¼ŒCMOS æ˜ å°„çš„åœ°å€æ–¹ä½
ä» 0x00 - 0x50, å…·ä½“æ˜ å°„å¯ä»¥æŸ¥çœ‹:

> - [CMOS æ˜ å°„è¡¨](#B0001)

åœ¨ CMOS æ˜ å°„è¡¨ä¸­ï¼Œä¸å†…å­˜ç›¸å…³çš„ä¿¡æ¯æœ‰: 

###### 0x15/0x16

ç”¨äºæè¿° 0M-1M çš„ç‰©ç†å†…å­˜é•¿åº¦ï¼ŒæŒ‰ 1KB å­—èŠ‚ç»Ÿè®¡, å¦‚æœç³»ç»Ÿç‰©ç†å†…å­˜æ€»é•¿åº¦å¤§äº
640KBï¼Œé‚£ä¹ˆ 0x15/0x16 ç”¨äºæè¿° 640KB çš„ç‰©ç†å†…å­˜é•¿åº¦ä¿¡æ¯ã€‚å†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = (rtc_read(0x15) | (rtc_read(0x16) << 8)) * 1024
{% endhighlight %}

###### 0x17/0x18

ç”¨äºæè¿° 1MB-64MB çš„ç‰©ç†å†…å­˜é•¿åº¦ï¼ŒæŒ‰ 1KB å­—èŠ‚ç»Ÿè®¡. å†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = (rtc_read(0x17) | (rtc_read(0x18) << 8)) * 1024
{% endhighlight %}

###### 0x30/0x31

ç”¨äºæè¿° 1MB-64MB çš„ç‰©ç†å†…å­˜é•¿åº¦ï¼ŒæŒ‰ 1KB å­—èŠ‚ç»Ÿè®¡. å†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = (rtc_read(0x30) | (rtc_read(0x31) << 8)) * 1024
{% endhighlight %}

###### 0x34/0x35

ç”¨äºæè¿° 16MB-4GB çš„ç‰©ç†å†…å­˜é•¿åº¦, æŒ‰ 64KB å­—èŠ‚ç»Ÿè®¡. å†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = (rtc_read(0x34) | (rtc_read(0x35) << 8)) * 64 * 1024
{% endhighlight %}

###### 0x5b/0x5c/0x5d

ç”¨äºæè¿°è¶…è¿‡ 4GB çš„ç‰©ç†å†…å­˜é•¿åº¦ï¼ŒæŒ‰ 64KB å­—èŠ‚ç»Ÿè®¡ï¼Œå†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = (rtc_read(0x5b) | (rtc_read(0x5c) << 8) | (rtc_read(0x5d) << 16)) * 64 * 1024
{% endhighlight %}

å‡½æ•°åœ¨ 126-127 è¡Œé€šè¿‡ä» CMOS æ˜ å°„è¡¨ä¸­è¯»å– "CMOS_MEM_EXTMEM2_LOW" ä¸ 
"CMOS_MEM_EXTMEM2_HIGH" çš„å€¼, å³ CMOS 0x34/0x35 çš„å€¼ï¼Œå…¶å€¼å¯ä»¥ç»„åˆæˆä¸€ä¸ª 16 ä½
çš„å€¼ï¼Œå¹¶æŒ‰ 64KB ä¸ºå•ä½è¿›è¡Œç»Ÿè®¡ 16M åˆ° 4GB ç‰©ç†å†…å­˜çš„é•¿åº¦ã€‚å¦‚æœè¯»å–æˆåŠŸï¼Œé‚£ä¹ˆ
å‡½æ•°åœ¨ 128-129 è¡Œå°†ç³»ç»Ÿå†…å­˜çš„å‰ 16MB è¿›è¡Œç»Ÿè®¡ï¼Œä¸€èµ·è®¡ç®—å‡ºç³»ç»Ÿç‰©ç†å†…å­˜çš„æ€»
é•¿åº¦; åä¹‹æ— æ³•ä» CMOS 0x34/0x35 ä¸­è·å¾—ç‰©ç†å†…å­˜ï¼Œé‚£ä¹ˆå‡½æ•°åˆ¤æ–­ç³»ç»Ÿç‰©ç†å†…å­˜é•¿åº¦
ä¸è¶…è¿‡ 64MBï¼Œäºæ˜¯é€šè¿‡ä» CMOS æ˜ å°„è¡¨ä¸­è¯»å– "CMOS_MEM_EXTMEM_LOW" ä¸ 
"CMOS_MEM_EXTMEM_HIGH" çš„å€¼ï¼Œä»¥æ­¤è·å¾— 1MB-16MB çš„ç‰©ç†å†…å­˜é•¿åº¦ã€‚å‡½æ•°åœ¨ 131-133
è¡Œå°†å¯¹åº”çš„æ•°æ®è¯»å–ï¼Œç”±äº 0x34/0x35 çš„å€¼æŒ‰ 64KB å­—èŠ‚ç»Ÿè®¡ï¼Œå› æ­¤åœ¨ç»„åˆæˆæ•°æ®çš„
æ—¶å€™éœ€è¦è¿›è¡Œç›¸åº”çš„ç§»ä½ï¼Œå¹¶åŠ ä¸Š 1MB çš„ç‰©ç†å†…å­˜ï¼Œæœ€ç»ˆè®¡ç®—å‡º 0MB-16MB ä¹‹é—´ç‰©ç†
å†…å­˜çš„é•¿åº¦.

å‡½æ•°åœ¨ 134 è¡Œå°†è®¡ç®—å‡ºçš„ç‰©ç†å†…å­˜é•¿åº¦å­˜å‚¨åœ¨ RamSize é‡Œé¢ï¼Œç”¨äºè¡¨ç¤ºç³»ç»Ÿç‰©ç†å†…å­˜
é•¿åº¦ã€‚å‡½æ•°åœ¨ 135 è¡Œè°ƒç”¨ e820_add() å°†ç‰©ç†å†…å­˜åŠ å…¥åˆ° e820_list è¡¨é‡Œè¿›è¡Œç»´æŠ¤ã€‚
å› æ­¤å†…æ ¸å¯åŠ¨æ—¶ï¼Œe820 è¡¨ä¸­ç‰©ç†å†…å­˜çš„ä¿¡æ¯æ¥è‡ªè¿™é‡Œ. å‡½æ•°åœ¨ 138 è¡Œè°ƒç”¨ e820_add()
å‡½æ•°ï¼Œå°† 4GB åœ°å€ç©ºé—´æœ€åçš„ 256KB é¢„ç•™ç»™ BIOS ä½¿ç”¨.

<span id="D1001"></span>
![](/assets/PDB/HK/HK000406.png)

å‡½æ•°åœ¨ 419 è¡Œè°ƒç”¨ e820_remove() å‡½æ•°å°† "BUILD_LOWRAM_END" å¼€å§‹é•¿åº¦ä¸º
"BUILD_BIOS_ADDR-BUILD_LOWMEM_END" é•¿åº¦çš„ç‰©ç†å†…å­˜ä½œä¸ºé¢„ç•™å†…å­˜, å…¶èŒƒå›´åœ¨
"0xa0000-0x10000", åœ¨ BIOS å®æ—¶æ¨¡å¼ä¸‹ï¼Œåœ¨ç¬¬ä¸€ä¸ª 1MiB åœ°å€ç©ºé—´ä¸­ï¼Œ
"0xa0000-0x10000" èŒƒå›´çš„ 384 KiB åœ°å€ç©ºé—´ç§°ä¸º "Upper Memory", è¿™æ®µåœ°å€ç©ºé—´ç”¨äº
Video ç­‰ç¡¬ä»¶æ˜ å°„ä½¿ç”¨ï¼Œä½œä¸ºç³»ç»Ÿé¢„ç•™ï¼Œå› æ­¤ seaBIOS éœ€è¦å°†è¿™æ®µå†…å­˜é¢„ç•™ã€‚æ›´å¤š
å®æ—¶æ¨¡å¼åœ°å€ç©ºé—´ map æŸ¥çœ‹ä¸‹é¢é“¾æ¥:

![](/assets/PDB/HK/HK000408.png)

> - [Real Mode Address Space (\< 1 MiB)](#B0003)

åœ¨å®æ—¶æ¨¡å¼ä¸­ï¼ŒseaBIOS å°† "0xF0000-0xFFFFF" ç©ºé—´é¢„ç•™ç»™ BIOS ä½¿ç”¨ï¼Œå› æ­¤è¿™æ®µå†…å­˜
åŒºåŸŸä¹Ÿåº”è¯¥é¢„ç•™ï¼Œå‡½æ•°åœ¨ 422 è¡Œè°ƒç”¨ e820_add() å‡½æ•°å°†è¯¥åŒºåŸŸæ’å…¥åˆ° e820_list, å¹¶
ä½œä¸º E820_RESERVED è¿›è¡Œé¢„ç•™. å‡½æ•°ç»§ç»­åœ¨ 425-449 è¡Œéå† e820_list è¡¨ï¼Œå¹¶åœ¨æ‰€æœ‰
E820_RAM ä¸­æ‰¾åˆ°ä¸€å—ç”¨äºå­˜å‚¨ BUILD_MAX_HIGHTABLE çš„å†…å­˜ç©ºé—´ï¼Œå‡½æ•°åœ¨æ¯æ¬¡éå†åˆ°çš„
å†…å­˜ç©ºé—´å°¾éƒ¨æŸ¥æ‰¾ï¼Œç¡®è®¤æ˜¯å¦å¯ä»¥å­˜å‚¨ BUILD_MAX_HIGHTABLE ç©ºé—´ï¼Œå½“æ‰¾åˆ°ä¹‹åï¼Œå°†
highmem æŒ‡å‘è¡¨çš„èµ·å§‹ä½ç½®ï¼Œé•¿åº¦ä¸º BUILD_MAX_HIGHTABLE, å°†è¿™æ®µå†…å­˜åŒºåŸŸè®¾ç½®ä¸º
E820_RESERVED. 

<span id="D1004"></span>
![](/assets/PDB/HK/HK000411.png)

qemu_cfg_e820() å‡½æ•°ä» QEMU æä¾›çš„ "etc/e820" ä¸­è¯»å–å†…å­˜åŒºåŸŸï¼Œå¹¶æ’å…¥åˆ°
e820_list è¡¨ä¸­ï¼Œè¿™é‡Œä¸ QEMU çš„é…ç½®æœ‰å…³ã€‚

![](/assets/PDB/HK/HK000412.png)

å¦‚æœå‡½æ•°ä» QEMU_CFG_E820_TABLE ä¸­è·å¾—å†…å­˜åŒºåŸŸçš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå‡½æ•°å°†è¿™äº›å†…å­˜åŒºåŸŸ
æ’å…¥åˆ° e820_list è¡¨ä¸­ï¼Œå¦‚æœæ²¡æœ‰è¡¨ä¸­è¯»å–ï¼Œé‚£ä¹ˆå‡½æ•°åˆ¤æ–­æ˜¯å¦è¿è¡Œåœ¨ KVM é‡Œï¼Œå¦‚æœ
æ­¤æ—¶ seaBIOS è¿è¡Œåœ¨ KVM é‡Œé¢ï¼Œé‚£ä¹ˆå‡½æ•°å°† "0xfffbc000-0xfffC000" åŒºåŸŸè¿›è¡Œé¢„ç•™ã€‚
å‡½æ•°ç»§ç»­é€šè¿‡ COMS è¯»å–è¶…è¿‡ 4 Gig ç‰©ç†å†…å­˜çš„ä¿¡æ¯ï¼Œå¹¶å°† "0x100000000-high" çš„
å†…å­˜åŒºåŸŸä½œä¸ºå¯ç”¨ç‰©ç†æ’å…¥åˆ° e820_list è¡¨é‡Œ.

<span id="D1002"></span>
![](/assets/PDB/HK/HK000409.png)

åœ¨ malloc_prepboot() å‡½æ•°ä¸­ï¼Œ544-545 è¡Œï¼Œå‡½æ•°è°ƒç”¨ GET_BDA() å‡½æ•°ä» BDA ä¸­è¯»å–
"40:13-40:14" é‡Œé¢çš„å†…å®¹ï¼Œè¯¥å†…å®¹æŒ‡æ˜äº† "LOW Memory" å†…å­˜çš„å¤§å°ï¼Œåœ¨ seaBIOS 
å®æ—¶æ¨¡å¼ä¸­ï¼Œå°äº 1MiB çš„å†…å­˜ç©ºé—´è¢«åˆ†ä½œä¸¤æ®µï¼Œç¬¬ä¸€æ®µæ˜¯ 0x00000-0xa0000 
"ä½ç«¯å†…å­˜"ï¼Œé•¿åº¦ä¸º "640 KiB"; ä»¥åŠ "0xa0000-0x100000" çš„ "é«˜ç«¯å†…å­˜"ï¼Œé•¿åº¦ä¸º
384KiB. BDA ä¸­çš„ "40:13-40:14" åˆ™æŒ‡æ˜äº†å®é™…çš„ä½ç«¯å†…å­˜çš„é•¿åº¦ã€‚malloc_prepboot()
å‡½æ•°å°†ä½ç«¯å†…å­˜æœ€å 1 Kib çš„å†…å­˜é¢„ç•™ä¸‹æ¥. æ›´å¤š BDA ä¿¡æ¯è¯·æŸ¥çœ‹:

> - [BDA - BIOS Data Area](#B0002)

malloc_preboot() å‡½æ•°ç»§ç»­åœ¨ 555 è¡Œä¸­æŸ¥æ‰¾ä¹‹å‰åœ¨ malloc_preinit() å‡½æ•°ä¸­é¢„ç•™çš„
ä¸€éƒ¨åˆ†å†…å­˜ï¼Œè¿™éƒ¨åˆ†å†…å­˜å½“æ—¶è¢«ç”¨äº BUILD_MAX_HIGHTABLE, é•¿åº¦ä¸º 250 KiBã€‚
malloc_preboot() å‡½æ•°è°ƒç”¨ alloc_find_lowest() å‡½æ•°æŸ¥æ‰¾è¿™ 250 Kib ä¸­æ²¡æœ‰ä½¿ç”¨
çš„ç‰©ç†å†…å­˜ï¼Œå°†å…¶å½’è¿˜ç»™ç³»ç»Ÿå¯ç”¨ç‰©ç†å†…å­˜ï¼Œå‡½æ•°åœ¨ 558 è¡Œè°ƒç”¨ e820_add() å‡½æ•°å°†
å½’è¿˜çš„å†…å­˜æ’å…¥åˆ° e820_list è¡¨é‡Œé¢.

<span id="D1003"></span>
![](/assets/PDB/HK/HK000410.png)

calcRamSize() å‡½æ•°é‡æ–°ç»Ÿè®¡ 4 GB å†…æœ€å¤§çš„å¯ç”¨ç‰©ç†å†…å­˜ï¼Œä»¥ä¾¿ e820_list è¡¨çš„æœ€ç»ˆ
æ˜ å°„ã€‚å‡½æ•°ä» e820_list è¡¨æœ€åä¸€ä¸ªå†…å­˜åŒºåŸŸå¼€å§‹éå†ï¼Œç„¶åæ‰¾åˆ°ä¸€ä¸ªç»“æŸåœ°å€åœ¨ 4GB
ä»¥å†…çš„ E820_RAM æˆ–è€… E820_ACPI å†…å­˜åŒºåŸŸï¼Œå°†è¯¥åŒºåŸŸçš„ç»ˆæ­¢åœ°å€å­˜å‚¨åœ¨ rs ä¸­ï¼Œå¹¶
ç›´æ¥ç»“æŸå¾ªç¯. å¦‚æœæ­¤æ—¶ rs çš„å€¼å¤§äº 1 MiBï¼Œé‚£ä¹ˆå°† LegacyRamSize è®¾ç½®ä¸º rsï¼Œåä¹‹
è®¾ç½®ä¸º 1 MiB.

<span id="D1005"></span>
![](/assets/PDB/HK/HK000459.png)

seaBIOS è¿è¡Œåˆ°ä¸€å®šé˜¶æ®µä¹‹åï¼Œå¼•å¯¼å†…æ ¸å¯åŠ¨ï¼Œå†…æ ¸å¯åŠ¨åˆæœŸä¼šè°ƒç”¨ seaBIOS çš„ä¸­æ–­
ä¾‹ç¨‹ï¼Œå…¶ä¸­åŒ…å«äº† INT 0x15/E820å’Œ INT 0x15/E801 ä¸¤ä¸ªä¸­æ–­ä¾‹ç¨‹. å‡½æ•°é€šè¿‡è°ƒç”¨ 
hanle_15e8() å‡½æ•°å®ç°:

![](/assets/PDB/HK/HK000460.png)

å‡½æ•°æä¾›äº† 0x15/E820 å’Œ 0x15/E801 ä¸¤ç§ä¸­æ–­ä¾‹ç¨‹ï¼Œå…¶ä¸­ 0x15/E801 çš„ä¸­æ–­ä¾‹ç¨‹å¦‚ä¸‹:

![](/assets/PDB/HK/HK000461.png)

INT 0x15/E801 ä¸­æ–­ä¾‹ç¨‹ç”¨äºè·å¾—ç³»ç»Ÿ 1-16 MiB çš„ç‰©ç†å¸ƒå±€ï¼Œä»¥åŠå¤§äº 16 MiB çš„ç‰©ç†
å¸ƒå±€ã€‚å‡½æ•°é¦–å…ˆåœ¨ 269 è¡Œè·å¾—äº†å½“ä¸‹ç³»ç»Ÿç‰©ç†å†…å­˜çš„é•¿åº¦ï¼Œç„¶ååœ¨ 272 è¡Œè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœ
ç‰©ç†å†…å­˜çš„é•¿åº¦å¤§äº 16 MiBï¼Œé‚£ä¹ˆå‡½æ•°å°† 15 MiB çš„å€¼å†™å…¥åˆ° CX å¯„å­˜å™¨ï¼Œç„¶åå°†è¶…è¿‡
64 MiB è€Œå°äº 4 Gig çš„ç‰©ç†å†…å­˜ä¿¡æ¯å†™å…¥åˆ° DX å¯„å­˜å™¨é‡Œï¼Œç„¶åè¿”å›ç»™è°ƒç”¨è€…; åä¹‹
å¦‚æœç³»ç»Ÿç‰©ç†å†…å­˜å°äº 64 MiBï¼Œé‚£ä¹ˆå‡½æ•°æ‰§è¡Œ 278-279 è¡Œå†…å®¹ï¼Œå°† 1-16 MiB ç‰©ç†å†…å­˜
ä¿¡æ¯å†™å…¥ CX å¯„å­˜å™¨ï¼Œè€Œ DX å¯„å­˜å™¨åˆ™è®¾ç½®ä¸º 0. å‡½æ•°ç„¶åå°† AXã€BX å¯„å­˜å™¨ä¹Ÿè®¾ç½®ä¸ŠåŒ
æ ·çš„å€¼. ä¸Šé¢çš„ä»£ç é€»è¾‘å®Œæˆäº†å†…æ ¸é€šè¿‡ 0x15/E801 çš„ä¸­æ–­è°ƒç”¨.

![](/assets/PDB/HK/HK000462.png)

INT 0x15/E820 ä¸­æ–­çš„ä¾‹ç¨‹ç”¨äºä» E820 Table ä¸­è·å¾—ä¸€ä¸ªå†…å­˜åŒºåŸŸçš„ä¿¡æ¯. å‡½æ•°åœ¨æ‰§è¡Œ
ä»¥æ­¤è°ƒç”¨æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­å¯„å­˜å™¨çš„æƒ…å†µï¼Œå¦‚æœå‡ºç°å…¶ä¸­ä¸€ç§ï¼Œéƒ½è®¤ä¸ºæ˜¯æ— æ•ˆçš„ä¸­æ–­è°ƒç”¨ï¼Œé¦–å…ˆæ˜¯ EDX å¯„å­˜å™¨çš„å€¼æ˜¯å¦ä¸º "0x534D4150", å…¶æ¬¡æ˜¯ BX ä¸­çš„å€¼å¤§äº e820_count çš„å€¼ï¼Œ
æˆ–è€…æ˜¯ ECX æŒ‡å‘çš„ç©ºé—´ä¸å¤Ÿå­˜å‚¨ä¸€ä¸ªå†…å­˜åŒºåŸŸçš„ä¿¡æ¯ï¼Œé‚£ä¹ˆä¸­æ–­ä¾‹ç¨‹éƒ½è®¤ä¸ºæ˜¯æ— æ•ˆçš„ã€‚
åä¹‹å¦‚æœæœ‰æ•ˆï¼Œé‚£ä¹ˆå‡½æ•°ä¼šå°† e820_list çš„ç¬¬ BX å¯„å­˜å™¨ä¸ºç´¢å¼•çš„å†…å­˜åŒºåŸŸä¿¡æ¯æ‹·è´åˆ°
ES æŒ‡å‘çš„å†…å­˜ç©ºé—´ã€‚æ‹·è´å®Œæ¯•ä¹‹åï¼Œå‡½æ•°åœ¨ 302 è¡Œæ£€æµ‹ BX çš„å€¼æ˜¯å¦ä¸º e820_count çš„
æœ€å¤§å€¼ï¼Œå¦‚æœæ˜¯åˆ™å°† EBX è®¾ç½®ä¸º 0ï¼Œåä¹‹å°† EBX åŠ  1. å‡½æ•°æœ€åå°† EAX è®¾ç½®ä¸ºç‰¹å®šçš„
å­—ç¬¦ä¸²ï¼Œç”¨äºå†…æ ¸åšæ ¡éªŒï¼Œå¹¶å°†æ‹·è´çš„é•¿åº¦å­˜å‚¨åœ¨ ECX å¯„å­˜å™¨é‡Œ. è‡³æ­¤ä¸€æ¬¡å®Œæ•´çš„ 
0x15/E820 ä¸­æ–­ä¾‹ç¨‹æ”¯æŒå®Œæ¯•.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D36">e820_prepboot</span>

![](/assets/PDB/HK/HK000363.png)

e820_prepboot() å‡½æ•°ç”¨äºåœ¨åˆå§‹åŒ–é˜¶æ®µæ‰“å° e820_list è¡¨å†…å­˜åŒºåŸŸçš„æƒ…å†µ. å‡½æ•°ç›´æ¥
è°ƒç”¨ dump_map() å‡½æ•°å®Œæˆæ ¸å¿ƒæ“ä½œ.

> - [dump_map](#D33)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D35">e820_remove</span>

![](/assets/PDB/HK/HK000401.png)

e820_remove() å‡½æ•°ç”¨äºä» e820_list è¡¨ä¸­ç§»é™¤ä¸€ä¸ªå†…å­˜åŒºåŸŸ. å‚æ•° start å’Œ size
æŒ‡æ˜äº†å†…å­˜åŒºåŸŸçš„èŒƒå›´ã€‚å‡½æ•°é€šè¿‡è°ƒç”¨ e820_add() å‡½æ•°å®ç°ï¼Œåªæ˜¯å°†ç§»é™¤çš„å†…å­˜åŒºåŸŸ
ç±»å‹è®¾ç½®ä¸º E820_HOLE, è¿™ä¼šç„¶å‡½æ•°ç›´æ¥ç§»é™¤ e820_list è¡¨çš„å†…å­˜åŒºåŸŸ.

> - [e820_add](#D34)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D34">e820_add</span>

![](/assets/PDB/HK/HK000392.png)

e820_add() å‡½æ•°ç”¨äºå‘ e820_list ä¸­æ·»åŠ ä¸€ä¸ªå†…å­˜åŒºåŸŸ. å‚æ•° start å’Œ size æŒ‡æ˜
äº†å†…å­˜åŒºåŸŸçš„èŒƒå›´ï¼Œtype å‚æ•°æŒ‡æ˜äº†å†…å­˜åŒºåŸŸçš„ç±»å‹.

å‡½æ•°åœ¨ 94-114 è¡Œä½¿ç”¨ for å¾ªç¯éå† e820_list å†…çš„åˆ†åŒºï¼Œå‡½æ•°åœ¨ 97 è¡Œåˆ¤æ–­éå†
è¿‡ç¨‹ä¸­ï¼Œå¦‚æœéå†åˆ°çš„å†…å­˜åŒºåŸŸçš„ç»“æŸåœ°å€å°äºèµ·å§‹åœ°å€ï¼Œé‚£ä¹ˆç›´æ¥éå†ä¸‹ä¸€ä¸ªå†…å­˜
åŒºåŸŸï¼Œç›´åˆ°é‡åˆ°éå†åˆ°çš„å†…å­˜åŒºåŸŸçš„ç»ˆæ­¢åœ°å€å¤§äºæˆ–ç­‰äºå‚æ•° start å¯¹åº”çš„èµ·å§‹åœ°å€ï¼Œ
å½“å‡ºç°ä¸Šé¢æƒ…å†µæ˜¯ï¼Œæ–°æ’å…¥çš„åŒºåŸŸå¯èƒ½ä¸éå†åˆ°çš„åŒºåŸŸå­˜åœ¨ç›¸é‚»ã€ç›¸äº¤æˆ–åµŒå¥—çš„æƒ…å†µã€‚
å‡½æ•°åœ¨ 100 è¡Œåˆ¤æ–­å½“å‚æ•° start å¤§äºéå†åˆ°çš„å†…å­˜åŒºåŸŸèµ·å§‹åœ°å€æ—¶å€™ï¼Œé‚£ä¹ˆæ–°æ’å…¥çš„
å†…å­˜åŒºåŸŸå’Œéå†åˆ°çš„å†…å­˜åŒºåŸŸå¯ä»¥å­˜åœ¨å¦‚ä¸‹å…³ç³»:

![](/assets/PDB/HK/HK000393.png)

Case0 çš„æƒ…å†µæ–°æ’å…¥çš„å†…å­˜åŒºåŸŸä¸éå†åˆ°çš„å†…å­˜åŒºåŸŸå­˜å­˜åœ¨ç›¸äº¤çš„æƒ…å†µ; Case1 çš„æƒ…å†µ
æ–°æ’å…¥çš„å†…å­˜åŒºåŸŸä¸éå†åˆ°çš„å†…å­˜åŒºåŸŸå­˜åœ¨å°¾éƒ¨ç›¸é‚»çš„å…³ç³». Case2 çš„æƒ…å†µæ–°æ’å…¥çš„å†…
å­˜åŒºåŸŸä¸éå†åˆ°çš„å†…å­˜åŒºåŸŸå­˜åœ¨åŒ…å«å…³ç³»; é’ˆå¯¹ä¸Šé¢æƒ…å†µï¼Œå½“å†…å­˜åŒºåŸŸçš„ç±»å‹ç›¸åŒçš„æ—¶å€™ï¼Œ
å°†ä¸¤ä¸ªå†…å­˜åŒºåŸŸè¿›è¡Œç®€å•çš„åˆå¹¶å³å¯. å¦‚ä¸‹å›¾:

![](/assets/PDB/HK/HK000394.png)

æ­£å¦‚ä¸Šå›¾çš„æƒ…å†µï¼Œä¸¤ä¸ªåŒºåŸŸçš„ç±»å‹ç›¸åŒï¼Œå‡½æ•°åœ¨ 101-104 è¡Œæ‰§è¡Œç›¸åº”çš„é€»è¾‘ï¼Œå°†æ–°æ’å…¥
çš„å†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€æŒ‡å‘äº†éå†çš„å†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼Œå¹¶ä¸”å°†æ’å…¥å†…å­˜åŒºåŸŸçš„é•¿åº¦
å¢åŠ äº† "start - e->start" çš„é•¿åº¦. åä¹‹åœ¨é‡åˆ°ä¸Šé¢çš„æƒ…å†µæ—¶ï¼Œå¦‚æœæ–°æ’å…¥çš„å†…å­˜åŒº
åŸŸçš„ç±»å‹å’Œéå†åˆ°å†…å­˜åŒºåŸŸç±»å‹ä¸ç›¸åŒï¼Œé‚£ä¹ˆå°†åŒºåŸŸè¿›è¡Œæ‹†åˆ†ï¼Œå¦‚ä¸‹:

![](/assets/PDB/HK/HK000395.png)

æ­£å¦‚ä¸Šå›¾çš„æƒ…å†µï¼Œä¸¤ä¸ªåŒºåŸŸç±»å‹ä¸åŒæ—¶å‡½æ•°åœ¨ 106-110 è¡Œæ‰§è¡Œç›¸åº”çš„é€»è¾‘ï¼Œå‡½æ•°å°†é
å†åˆ°çš„å†…å­˜åŒºåŸŸè¿›è¡Œæ‹†åˆ†ï¼Œå°†åŸå§‹éå†åˆ°çš„å†…å­˜åŒºåŸŸçš„é•¿åº¦ç¼©å‡åˆ°æœªé‡åˆçš„å‰åŠéƒ¨åˆ†ï¼Œ
å¹¶å°† i åŠ ä»¥è·³è¿‡ä¸‹ä¸€æ¬¡éå†ï¼Œæ­¤æ—¶å¦‚æœæ–°æ’å…¥çš„å†…å­˜åŒºåŸŸçš„ç»“æŸåœ°å€å°äºéå†åˆ°çš„å†…
å­˜åŒºåŸŸçš„ç»“æŸåœ°å€ï¼Œé‚£ä¹ˆå±äºå›¾ä¸Š Case2 çš„æƒ…å†µï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°å°† 
"end-(e_end - end)" çš„åŒºåŸŸæ’å…¥åˆ° e820_list é‡Œé¢ï¼Œå…¶ä½™æƒ…å†µç»§ç»­éå†ã€‚

![](/assets/PDB/HK/HK000396.png)

å‡½æ•°åœ¨ 116-140 è¡Œå¤„ç†æ–°æ’å…¥çš„å†…å­˜åŒºåŸŸä¸å­˜åœ¨çš„å†…å­˜åŒºåŸŸå¤´éƒ¨ç›¸äº¤æƒ…å†µï¼Œå¦‚ä¸‹å›¾:

![](/assets/PDB/HK/HK000397.png)

å‡½æ•°åœ¨ 118-120 è¡Œå¤„ç†äº†æ²¡æœ‰ç›¸äº¤é‡å çš„æƒ…å†µï¼Œé€‰æ‹©ç›´æ¥è·³è¿‡ã€‚å‡½æ•° 122-125 è¡Œï¼Œ
å½“å‡½æ•°é‡åˆ°ä¸Šå›¾ Case1 å’Œ Case2 çš„æƒ…å†µï¼Œå³æ–°æ’å…¥çš„å†…å­˜åŒºåŸŸåŒ…å«äº†å·²ç»å­˜åœ¨çš„
å†…å­˜åŒºåŸŸï¼Œå¦‚ä¸‹å›¾:

![](/assets/PDB/HK/HK000398.png)

é‚£ä¹ˆå‡½æ•°æ­¤æ—¶è°ƒç”¨ remove_e820() ç§»é™¤å·²ç»å­˜åœ¨çš„å†…å­˜åŒºåŸŸ. å› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ–°
å†…å­˜åŒºåŸŸç±»å‹ä¼šç›´æ¥è¦†ç›–æ—§çš„å†…å­˜åŒºåŸŸ. å¯¹äº Case0 çš„æƒ…å†µï¼Œå‡½æ•°åœ¨ 128-129 è¡Œé¦–å…ˆ
è°ƒæ•´å·²ç»éå†åˆ°çš„å†…å­˜åŒºåŸŸèŒƒå›´ï¼Œå°†å…¶ç¼©å‡è‡³ä¸é‡å çš„èŒƒå›´ï¼Œå¦‚ä¸‹å›¾:

![](/assets/PDB/HK/HK000399.png)

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ–°æ’å…¥çš„å†…å­˜åŒºåŸŸç±»å‹å’Œä¿®æ”¹åçš„å†…å­˜ç±»å‹ç›¸åŒï¼Œé‚£ä¹ˆå‡½æ•°ä¼šåœ¨
132-133 è¡Œå°†ä¸¤ä¸ªåŒºåŸŸåˆå¹¶ï¼Œå¦‚ä¸‹:

![](/assets/PDB/HK/HK000400.png)

å‡½æ•°éå†å®Œæ¯•ä¹‹åï¼Œç»“æŸå¾ªç¯ã€‚å¦‚æœæ­¤æ—¶å‘ç°æ–°æ’å…¥çš„å†…å­˜åŒºåŸŸç±»å‹ä¸ä¸º E820_HOLE,
é‚£ä¹ˆå‡½æ•°æ‰§è¡Œ 138-139 è¡Œé€»è¾‘ï¼Œå°†æ–°ä¿®æ”¹åçš„å†…å­˜åŒºåŸŸç±»å‹æ’å…¥åˆ° e820_list è¡¨ä¸­.

> - [insert_e820](#D31)
>
> - [e820_list](#D21)
>
> - [remove_e820](#D30) 

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D33">dump_map</span>

![](/assets/PDB/HK/HK000390.png)

dump_map() å‡½æ•°ç”¨äºæ‰“å° e820_list å†…çš„æ‰€æœ‰å†…å­˜åŒºåŸŸ. å‡½æ•°å®ç°æ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨å¾ªç¯
çš„æ–¹å¼ï¼Œå°† e820_list çš„å†…å­˜åŒºåŸŸå…¨éƒ¨æ‰“å°å‡ºæ¥ï¼ŒåŒ…å«äº†å†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€ã€ç»“æŸ
åœ°å€ä»¥åŠç±»å‹ä¿¡æ¯ã€‚æ‰“å°æ•ˆæœå¦‚ä¸‹:

![](/assets/PDB/HK/HK000391.png)

> - [e820_count è¯¦è§£](#D22)
>
> - [e820_list è¯¦è§£](#D21)
>
> - [e820_type_name](#D32)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D32">e820_type_name</span>

![](/assets/PDB/HK/HK000389.png)

e820_type_name() å‡½æ•°ç”¨äºå°†å†…å­˜åŒºåŸŸç±»å‹è£…æ¢ä¸ºå­—ç¬¦ä¸²ã€‚å‚æ•° type æŒ‡æ˜å†…å­˜åŒºåŸŸçš„
ç±»å‹ï¼Œè¯¥å‡½æ•°ä¸»è¦ç”¨äºå†…å­˜åŒºåŸŸæ‰“å°æ—¶ä»¥å­—ç¬¦ä¸²è¾“å‡ºç±»å‹ä¿¡æ¯.

* E820_RAM
  æŒ‡æ˜å†…å­˜åŒºåŸŸå±äºå¯ç”¨çš„ç‰©ç†å†…å­˜, å¯¹åº” "RAM".
* E820_RESERVED
  æŒ‡æ˜å†…å­˜åŒºåŸŸé¢„ç•™ç»™éå†…æ ¸ä½¿ç”¨ï¼Œå³ç»™å¤–éƒ¨è®¾å¤‡ä½¿ç”¨, å¯¹åº” "RESERVED".
* E820_ACPI
  æŒ‡æ˜å†…å­˜åŒºåŸŸé¢„ç•™ç»™ ACPI Data ä½¿ç”¨. å¯¹åº” "ACPI".
* E820_NVS
  ç”¨äºæŒ‡æ˜å†…å­˜åŒºåŸŸé¢„ç•™ç»™ NVDIMM ä½¿ç”¨, å¯¹åº” "NVS".
* E820_UNUSABLE
  ç”¨äºæŒ‡æ˜å†…å­˜åŒºåŸŸä¸å¯ä½¿ç”¨. å¯¹åº” "UNKNOWN".

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D31">insert_e820</span>

![](/assets/PDB/HK/HK000388.png)

insert_e820() å‡½æ•°ç”¨äºå‘å…¨å±€ e820_list è¡¨ä¸­æ’å…¥ä¸€ä¸ªæ–°çš„å†…å­˜åŒºåŸŸ. å‚æ•° i ç”¨äº
æŒ‡æ˜æ’å…¥ e820_list è¡¨ä¸­çš„ä½ç½®ï¼Œå‚æ•° start å’Œ size æŒ‡æ˜äº†æ–°å†…å­˜åŒºåŸŸçš„èŒƒå›´ï¼Œå‚æ•°
type æŒ‡æ˜äº†æ–°æ’å…¥å†…å­˜åŒºåŸŸçš„ç±»å‹.

å‡½æ•°é¦–å…ˆæ£€æµ‹å½“å‰ e820_list æ˜¯å¦è¿˜èƒ½æ’å…¥æ–°çš„å†…å­˜åŒºåŸŸï¼Œe820_count ç»Ÿè®¡äº†å½“å‰
e820_list ä¸­å†…å­˜åŒºåŸŸçš„ä¸ªæ•°ï¼Œå¦‚æœè¯¥å€¼è¶…è¿‡äº† BUILD_MAX_E820 çš„å€¼ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†
æŠ¥é”™ï¼Œè¶…è¿‡äº†é™åˆ¶. å¦‚æœå¯ä»¥æ’å…¥ï¼Œé‚£ä¹ˆå‡½æ•°è°ƒç”¨ memmove() å‡½æ•°å°† e820_list è¡¨
i ä»¥åŠä¹‹åçš„å†…å­˜åŒºåŸŸå…¨éƒ¨å‘åç§»åŠ¨äº†ä¸€ä¸ªæˆå‘˜çš„ä½ç½®ï¼Œæ¥ç€å°† e820_count åŠ  1 æ›´æ–°
æœ€æ–°çš„ç»Ÿè®¡ï¼Œæ¥ç€å‡½æ•°è·å¾— i åœ¨ e820_list ä¸­çš„ä½ç½®ï¼Œå¹¶å°†æ–°çš„å†…å­˜åŒºåŸŸä¿¡æ¯å¡«å…¥åˆ°
æŒ‡å®šä½ç½®ï¼Œé‚£ä¹ˆä¸€ä¸ªæ–°çš„å†…å­˜åŒºåŸŸæ’å…¥å®Œæ¯•.

> - [e820_count è¯¦è§£](#D22)
>
> - [e820_list è¯¦è§£](#D21)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D30">remove_e820</span>

![](/assets/PDB/HK/HK000387.png)

å‡½æ•° remove_e820() ç”¨äºä» seaBIOS å…¨å±€ E820 è¡¨ e820_list ä¸­ç§»é™¤ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œ
å‚æ•° i æŒ‡æ˜å†…å­˜åŒºåŸŸåœ¨ e820_list ä¸­çš„ç´¢å¼•.

e820_count ç”¨äºæŒ‡æ˜å…¨å±€ e820_list ä¸­åŒ…å«å†…å­˜åŒºåŸŸçš„ä¸ªæ•°ï¼Œå‡½æ•°åœ¨ç§»é™¤ä¸€ä¸ªå†…å­˜åŒºåŸŸ
æ—¶é¦–å…ˆå°† e820_count çš„å€¼å‡ä¸€ï¼Œä»¥æ­¤æ›´æ–°å¯¹å†…å­˜åŒºåŸŸçš„ç»Ÿè®¡. æ¥ç€å‡½æ•°è°ƒç”¨ memmove
å‡½æ•°å°† e820_list è¡¨ç´¢å¼• i ä¹‹åçš„å†…å­˜åŒºåŸŸå…¨éƒ¨å‘å‰ç§»åŠ¨äº†ä¸€ä¸ªä½ç½®ï¼Œä»¥æ­¤æ›´æ–° 
e820_list è¡¨.

> - [e820_count è¯¦è§£](#D22)
>
> - [e820_list è¯¦è§£](#D21)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D22">e820_count</span>

{% highlight bash %}
#define VARFSEG __section(".data.varfseg." UNIQSEC) __VISIBLE

int e820_count VARFSEG;
{% endhighlight %}

seaBIOS å®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡ e820_count ç”¨äºç»Ÿè®¡ E820 å†…å­˜åŒºåŸŸçš„æ•°é‡. e820_count
ä¹Ÿè¢«æ”¾ç½®åˆ° ".data.varfseg." section é‡Œé¢.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D21">e820_list</span>

{% highlight bash %}
// Maximum number of map entries in the e820 map
#define BUILD_MAX_E820 32
#define VARFSEG __section(".data.varfseg." UNIQSEC) __VISIBLE

struct e820entry e820_list[BUILD_MAX_E820] VARFSEG;
{% endhighlight %}

e820_list ç”¨äºç»´æŠ¤å…¨å±€ E820 å†…å­˜åŒºåŸŸä¿¡æ¯ï¼Œå…¶å®šä¹‰ä¸º struct e820entry çš„æ•°ç»„ï¼Œ
é»˜è®¤æ”¯æŒ BUILD_MAX_E820 å³ 32 ä¸ªå†…å­˜åŒºåŸŸï¼Œåœ¨å®šä¹‰é˜¶æ®µï¼ŒseaBIOS å°† e820_list åŠ 
å…¥åˆ° ".data.varfseg." section é‡Œé¢.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D20">struct e820entry</span>

![](/assets/PDB/HK/HK000386.png)

seaBIOS å®šä¹‰äº†ä¸€ä¸ªå…¨å±€æ•°æ®ç»“æ„ struct e820entry ç”¨äºæè¿° E820 table é‡Œé¢çš„ä¸€ä¸ª
å†…å­˜åŒºåŸŸï¼Œstart æˆå‘˜æŒ‡æ˜äº†å†…å­˜åŒºåŸŸçš„èµ·å§‹ç‰©ç†åœ°å€ï¼Œsize æˆå‘˜ç”¨äºæŒ‡æ˜å†…å­˜åŒºåŸŸ
çš„é•¿åº¦ï¼Œtype æˆå‘˜åˆ™æŒ‡æ˜äº†å†…å­˜åŒºåŸŸçš„ç±»å‹ã€‚ç›®å‰ seaBIOS E820 æ”¯æŒçš„ç±»å‹å¦‚ä¸Š,

<span id="D24"></span>
* E820_RAM
  æŒ‡æ˜å†…å­˜åŒºåŸŸå±äºå¯ç”¨çš„ç‰©ç†å†…å­˜
* E820_RESERVED 
  æŒ‡æ˜å†…å­˜åŒºåŸŸé¢„ç•™ç»™éå†…æ ¸ä½¿ç”¨ï¼Œå³ç»™å¤–éƒ¨è®¾å¤‡ä½¿ç”¨
* E820_ACPI
  æŒ‡æ˜å†…å­˜åŒºåŸŸé¢„ç•™ç»™ ACPI Data ä½¿ç”¨
* E820_NVS
  ç”¨äºæŒ‡æ˜å†…å­˜åŒºåŸŸé¢„ç•™ç»™ NVDIMM ä½¿ç”¨
* E820_UNUSABLE 
  ç”¨äºæŒ‡æ˜å†…å­˜åŒºåŸŸä¸å¯ä½¿ç”¨.
* E820_HOLE
  ç”¨äºæŒ‡æ˜åŒºåŸŸä¸º RAM ä¸­çš„ä¸å¯ç”¨çš„åŒºåŸŸ

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="D23">e820_reservation</span>

![](/assets/PDB/HK/HK000413.png)

seaBIOS å®šä¹‰äº†ä¸€ä¸ªå…¨å±€æ•°æ®ç»“æ„ struct e820_reservation ç”¨äºæè¿° QEMU E820 table
é‡Œé¢çš„ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œaddress æˆå‘˜æŒ‡æ˜äº†å†…å­˜åŒºåŸŸçš„èµ·å§‹ç‰©ç†åœ°å€ï¼Œlength æˆå‘˜ç”¨äº
æŒ‡æ˜å†…å­˜åŒºåŸŸçš„é•¿åº¦ï¼Œtype æˆå‘˜åˆ™æŒ‡æ˜äº†å†…å­˜åŒºåŸŸçš„ç±»å‹ã€‚ç›®å‰ QEMU E820 æ”¯æŒçš„ç±»å‹
å¦‚ä¸Š,

* E820_RAM
  æŒ‡æ˜å†…å­˜åŒºåŸŸå±äºå¯ç”¨çš„ç‰©ç†å†…å­˜
* E820_RESERVED
  æŒ‡æ˜å†…å­˜åŒºåŸŸé¢„ç•™ç»™éå†…æ ¸ä½¿ç”¨ï¼Œå³ç»™å¤–éƒ¨è®¾å¤‡ä½¿ç”¨
* E820_ACPI
  æŒ‡æ˜å†…å­˜åŒºåŸŸé¢„ç•™ç»™ ACPI Data ä½¿ç”¨
* E820_NVS
  ç”¨äºæŒ‡æ˜å†…å­˜åŒºåŸŸé¢„ç•™ç»™ NVDIMM ä½¿ç”¨
* E820_UNUSABLE
  ç”¨äºæŒ‡æ˜å†…å­˜åŒºåŸŸä¸å¯ä½¿ç”¨.
* E820_HOLE
  ç”¨äºæŒ‡æ˜åŒºåŸŸä¸º RAM ä¸­çš„ä¸å¯ç”¨çš„åŒºåŸŸ

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="E"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000Q.jpg)

#### E820 seaBIOS è¿›é˜¶ç ”ç©¶

> - [Detecting Memory from CMOS](#E1)
>
> - [Detecting Memory from BDA](#E2)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="E1"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000M.jpg)

#### Detecting Memory from CMOS

CMOS å…¨ç§° "Complementary Metal Oxide Semiconductor"ï¼Œæœ¬æ–‡ CMOS æŒ‡çš„æ˜¯ç”µè„‘ä¸»æ¿
ä¸Šçš„ä¸€å—å¯è¯»å†™çš„ ROM èŠ¯ç‰‡ã€‚CMOS ä½œä¸ºå¯æ“¦å†™èŠ¯ç‰‡ä½¿ç”¨ï¼Œå­˜å‚¨ BIOS é…ç½®ä¿¡æ¯ã€‚åœ¨ PC
å‘å±•å†å²ä¸­æ—©æœŸ, BIOS å­˜å‚¨åœ¨ä¸»æ¿çš„ EPROM èŠ¯ç‰‡ä¸­ï¼Œæ‰€ä»¥æ˜¯æ— æ³•è¢«è½»æ˜“ä¿®æ”¹çš„ã€‚ä½†æ˜¯
ä¸Šä¸–çºª 90 å¹´ä»£åœ¨ PC ä¸Šç”µå¯åŠ¨è‡ªæ£€è¿‡ç¨‹åˆå¸Œæœ›æœ‰äº›é¡ºåºå¯ä»¥è°ƒæ•´æˆ–è€…æœ‰äº›é”™è¯¯å¸Œæœ›è¢«
å¿½ç•¥ï¼Œå› æ­¤å¢åŠ äº† BIOS çš„é…ç½®æˆ–è®¾ç½®åŠŸèƒ½ï¼Œä¸€å¼€å§‹è¿™ç§é…ç½®æ˜¯é€šè¿‡ DIP æ‹¨ç å¼€å…³å®ç°ï¼Œ
æ¥ç€æ˜¯é‡‡ç”¨éšæœºè½¯ç›˜å¸¦çš„é…ç½®ç¨‹åºå¯¹é’®æ‰£ç”µæ± ä¾›ç”µçš„ RAM èŠ¯ç‰‡è¿›è¡Œå‚æ•°é…ç½®ï¼Œè€Œ ROM èŠ¯
ç‰‡ä¸­çš„ BIOS ä»£ç ä¼šä» DIP å¼€å…³æˆ– RAM ä¸­è¯»å–ä¸åŒå‚æ•°è€Œé‡‡ç”¨ä¸åŒçš„å¯åŠ¨è‡ªæ£€æµç¨‹ã€‚
è¿™é‡Œçš„ RAM æ­£æ˜¯ CMOSã€‚

CMOS æ˜¯ä¸»æ¿ä¸Šä¸€å—å¯è¯»å†™çš„ ROM èŠ¯ç‰‡ï¼Œç”¨äºä¿å­˜å½“å‰ç³»ç»Ÿçš„ç¡¬ä»¶é…ç½®ä¿¡æ¯å’Œç”¨æˆ·è®¾å®š
çš„æŸäº›å‚æ•°ã€‚CMOS RAM ç”±ä¸»æ¿ä¸Šçš„é’®æ‰£ç”µæ± ä¾›ç”µï¼Œå³ä½¿ç³»ç»Ÿæ–­ç”µä¿¡æ¯ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚å¯¹
CMOS ä¸­å„é¡¹å‚æ•°çš„è®¾å®šå’Œæ›´æ–°å¯é€šè¿‡å¼€æœºæ—¶ç‰¹å®šçš„æŒ‰é”®å®ç° (ä¸€èˆ¬æ˜¯Delé”®)ã€‚è¿›å…¥ BIOS
è®¾ç½®ç¨‹åºå¯å¯¹ CMOS è¿›è¡Œè®¾ç½®ã€‚BIOS ç³»ç»Ÿè®¾ç½®ç¨‹åºï¼Œå‰é¢è°ˆåˆ°å¾®æœºéƒ¨ä»¶é…ç½®è®°å½•æ˜¯æ”¾åœ¨
ä¸€å—å¯è¯»å†™çš„ CMOS RAM èŠ¯ç‰‡ä¸­çš„ï¼Œä¸»è¦ä¿å­˜ç€ç³»ç»ŸåŸºæœ¬æƒ…å†µã€CPU ç‰¹æ€§ã€è½¯ç¡¬ç›˜é©±åŠ¨
å™¨ã€æ˜¾ç¤ºå™¨ã€é”®ç›˜ç­‰éƒ¨ä»¶çš„ä¿¡æ¯ã€‚åœ¨ BIOS ROM èŠ¯ç‰‡ä¸­è£…æœ‰ "ç³»ç»Ÿè®¾ç½®ç¨‹åº"ï¼Œä¸»è¦ç”¨æ¥
è®¾ç½® CMOS RAM ä¸­çš„å„é¡¹å‚æ•°ã€‚è¿™ä¸ªç¨‹åºåœ¨å¼€æœºæ—¶æŒ‰ä¸‹æŸä¸ªç‰¹å®šé”®å³å¯è¿›å…¥è®¾ç½®çŠ¶æ€ï¼Œå¹¶
æä¾›äº†è‰¯å¥½çš„ç•Œé¢ä¾›æ“ä½œäººå‘˜ä½¿ç”¨ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªè®¾ç½® CMOS å‚æ•°çš„è¿‡ç¨‹ï¼Œä¹ æƒ¯ä¸Šä¹Ÿç§°ä¸º
"BIOSè®¾ç½®"

POST ä¸Šç”µè‡ªæ£€ç¨‹åºï¼Œå¾®æœºæŒ‰é€šç”µæºåï¼Œç³»ç»Ÿé¦–å…ˆç”± POST(PowerOnSelfTestï¼Œä¸Šç”µè‡ªæ£€)
ç¨‹åºæ¥å¯¹å†…éƒ¨å„ä¸ªè®¾å¤‡è¿›è¡Œæ£€æŸ¥ã€‚é€šå¸¸å®Œæ•´çš„ POST è‡ªæ£€å°†åŒ…æ‹¬å¯¹ CPUã€640K åŸºæœ¬å†…å­˜ã€
1M ä»¥ä¸Šçš„æ‰©å±•å†…å­˜ã€ROMã€ä¸»æ¿ã€CMOS å­˜è´®å™¨ã€ä¸²å¹¶å£ã€æ˜¾ç¤ºå¡ã€è½¯ç¡¬ç›˜å­ç³»ç»ŸåŠé”®ç›˜
è¿›è¡Œæµ‹è¯•ï¼Œä¸€æ—¦åœ¨è‡ªæ£€ä¸­å‘ç°é—®é¢˜ï¼Œç³»ç»Ÿå°†ç»™å‡ºæç¤ºä¿¡æ¯æˆ–é¸£ç¬›è­¦å‘Šã€‚BIOS ç³»ç»Ÿå¯åŠ¨è‡ª
ä¸¾ç¨‹åºï¼Œç³»ç»Ÿåœ¨å®Œæˆ POST è‡ªæ£€åï¼ŒROM BIOS å°±é¦–å…ˆæŒ‰ç…§ç³»ç»Ÿ CMOS è®¾ç½®ä¸­ä¿å­˜çš„å¯åŠ¨
é¡ºåºæœå¯»è½¯ç¡¬ç›˜é©±åŠ¨å™¨åŠ CDâ€”ROMã€ç½‘ç»œæœåŠ¡å™¨ç­‰æœ‰æ•ˆåœ°å¯åŠ¨é©±åŠ¨å™¨ï¼Œè¯»å…¥æ“ä½œç³»ç»Ÿå¼•å¯¼
è®°å½•ï¼Œç„¶åå°†ç³»ç»Ÿæ§åˆ¶æƒäº¤ç»™å¼•å¯¼è®°å½•ï¼Œå¹¶ç”±å¼•å¯¼è®°å½•æ¥å®Œæˆç³»ç»Ÿçš„é¡ºåˆ©å¯åŠ¨.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### CMOS Map

![](/assets/PDB/HK/HK000405.png)

--------------------------------

#### Read/Write on COMS

BIOS å¯ä»¥è®¿é—® CMOS åœ°å€ç©ºé—´ï¼Œå› æ­¤å¯ä»¥åœ¨ seaBIOS ç¯å¢ƒä¸­å¯¹ CMOS è¿›è¡Œè®¿é—®ï¼Œç»“åˆ
CMOS å†…å­˜å¸ƒå±€å›¾ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç åœ¨ seaBIOS ä¸­è¿›è¡Œè®¿é—®:

{% highlight bash %}
#define PORT_CMOS_INDEX        0x0070
#define PORT_CMOS_DATA         0x0071

u8 rtc_read(u8 index)
{
    index |= NMI_DISABLE_BIT;
    outb(index, PORT_CMOS_INDEX);
    return inb(PORT_CMOS_DATA);
}
    
void rtc_write(u8 index, u8 val)
{
    index |= NMI_DISABLE_BIT;
    outb(index, PORT_CMOS_INDEX);
    outb(val, PORT_CMOS_DATA);
}
{% endhighlight %}

BIOS å¯ä»¥é€šè¿‡å¤–è®¾ IO åœ°å€ç©ºé—´è®¿é—® CMOS. CMOS ç”¨åˆ° Index port (0x70) å’Œ Data 
port (0x71) å¯¹äºçš„ 128 ä¸ªå¯„å­˜å™¨ï¼Œç›®å‰èŠ¯ç‰‡ç»„è¿˜æ‰©å±•äº† 0x72 å’Œ 0x73 IO ç©ºé—´ã€‚æ­¤æ—¶
BIOS å¯ä»¥ä½¿ç”¨ "outb/inb" æŒ‡ä»¤ä» CMOS é‡Œè¯»å–æˆ–å†™å…¥ä¸€ä¸ªå­—èŠ‚çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ rtc_read
å‡½æ•°ä» CMOS æŒ‡å®šæŒ‡å®šå¯„å­˜å™¨ä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚çš„ä¿¡æ¯ï¼Œrt_read() å‡½æ•°é€šè¿‡ä¼ å…¥å¯„å­˜å™¨
çš„ç´¢å¼•ï¼Œç„¶åå°†å¯„å­˜å™¨ç´¢å¼•é€šè¿‡ "outb" æŒ‡ä»¤å†™å…¥åˆ° Index portï¼Œå†™å…¥æˆåŠŸä¹‹åï¼Œå‡½æ•°
è°ƒç”¨ "inb" æŒ‡ä»¤ä» Data port è¯»å…¥ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®. å½“ BIOS éœ€è¦å‘ CMOS å†™å…¥æ•°æ®
çš„æ—¶å€™ï¼Œå¯ä»¥å‚è€ƒ rtc_write() å‡½æ•°ï¼Œä¼ å…¥å¯„å­˜å™¨çš„ç´¢å¼•å’Œè¦å†™å…¥çš„å€¼ï¼Œç„¶åé€šè¿‡ 
"outb" æŒ‡ä»¤å°†ç´¢å¼•å†™å…¥ Index port, å†™å…¥æˆåŠŸåç»§ç»­è°ƒç”¨ "outb" æŒ‡ä»¤å°†æ•°æ®å†™å…¥
åˆ° Data port, è¿™æ ·å°±å®Œæˆæ•°æ®çš„å†™å…¥.

-----------------------------------------

###### seaBIOS CMOS å®è·µ

åŸºäºæœ¬æ–‡çš„å®è·µç« èŠ‚ä»¥åŠæœ¬èŠ‚å®è·µå†…å®¹ï¼Œå¯ä»¥åœ¨ seaBIOS å¯¹ CMOS è¿›è¡Œå®è·µã€‚å¼€å‘è€…
é¦–å…ˆå‚è€ƒå®è·µç¯å¢ƒæ­å»º:

> - [seaBIOS å®è·µç¯å¢ƒéƒ¨ç½²](#C)

ç¯å¢ƒéƒ¨ç½²å®Œæ¯•ä¹‹åï¼Œåœ¨ seaBIOS æºç ç›®å½•ä¸‹å‚è€ƒä¸‹é¢ä»£ç è¿›è¡Œå®è·µ:

{% highlight bash %}
#include "rtc.h"

int BiscuitOS_CMOS(void)
{
	u32 memory_size;

	memory_size = (rtc_read(0x34) | (rtc_read(0x35) << 8)) * 64 * 1024;

	printf("Memory Size: %x\n", memory_size);

	return 0;
}
{% endhighlight %}

å°†ä¸Šé¢çš„å‡½æ•°æ”¾ç½®åˆ° maininit() å‡½æ•°çš„ prepareboot() å‡½æ•°ä¹‹åè°ƒç”¨è¯¥å‡½æ•°ï¼Œç„¶åç¼–
è¯‘ seaBIOS å¹¶è¿è¡Œ BiscuitOSï¼Œå¦‚ä¸‹å›¾:

![](/assets/PDB/HK/HK000425.png)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### Memory Information on CMOS

CMOS çš„å¯„å­˜å™¨ä¸­åŒ…å«äº†å¤šä¸ªä¸å†…å­˜ç›¸å…³çš„å¯„å­˜å™¨ï¼ŒseaBIOS/BIOS åœ¨ POST ä¸Šç”µè‡ªæ£€çš„
æ—¶å€™ï¼Œä¼šä» CMOS ä¸­è¯»å–ç›¸å…³çš„ä¿¡æ¯ï¼Œä»¥ä¾¿è·å¾—å†…å­˜ç›¸å…³çš„ä¿¡æ¯.

###### 0x15/0x16

ç”¨äºæè¿° 0M-1M çš„ç‰©ç†å†…å­˜é•¿åº¦ï¼ŒæŒ‰ 1KB å­—èŠ‚ç»Ÿè®¡, å¦‚æœç³»ç»Ÿç‰©ç†å†…å­˜æ€»é•¿åº¦å¤§äº
640KBï¼Œé‚£ä¹ˆ 0x15/0x16 ç”¨äºæè¿° 640KB çš„ç‰©ç†å†…å­˜é•¿åº¦ä¿¡æ¯ã€‚å†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = (rtc_read(0x15) | (rtc_read(0x16) << 8)) * 1024
{% endhighlight %}

###### 0x17/0x18

ç”¨äºæè¿° 1MB-64MB çš„ç‰©ç†å†…å­˜é•¿åº¦ï¼ŒæŒ‰ 1KB å­—èŠ‚ç»Ÿè®¡. å†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = (rtc_read(0x17) | (rtc_read(0x18) << 8)) * 1024
{% endhighlight %}

###### 0x30/0x31

ç”¨äºæè¿° 1MB-64MB çš„ç‰©ç†å†…å­˜é•¿åº¦ï¼ŒæŒ‰ 1KB å­—èŠ‚ç»Ÿè®¡. å†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = (rtc_read(0x30) | (rtc_read(0x31) << 8)) * 1024
{% endhighlight %}

###### 0x34/0x35

ç”¨äºæè¿° 16MB-4GB çš„ç‰©ç†å†…å­˜é•¿åº¦, æŒ‰ 64KB å­—èŠ‚ç»Ÿè®¡. å†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = (rtc_read(0x34) | (rtc_read(0x35) << 8)) * 64 * 1024
{% endhighlight %}

###### 0x5b/0x5c/0x5d

ç”¨äºæè¿°è¶…è¿‡ 4GB çš„ç‰©ç†å†…å­˜é•¿åº¦ï¼ŒæŒ‰ 64KB å­—èŠ‚ç»Ÿè®¡ï¼Œå†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = (rtc_read(0x5b) | (rtc_read(0x5c) << 8) | (rtc_read(0x5d) << 16)) * 64 * 1024
{% endhighlight %}

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="E2"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000M.jpg)

#### Detecting Memory from BDA

BDA å…¨ç§° "BIOS Data Area"ï¼ŒBDA æ˜¯åœ¨ RAM é‡Œçš„ä¸€å—æ•°æ®æ®µï¼Œä¸»è¦ç”¨äº BIOS ç®¡ç†å¤–è®¾
å’Œèµ„æºçš„ï¼Œèµ·å§‹åœ°å€æ˜¯ 0x00400Hã€‚

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

----------------------------------

#### BDA Map

![](/assets/PDB/HK/HK000407.png)

--------------------------------

#### Read/Write on BDA

BIOS å¯ä»¥è®¿é—® BDA åœ°å€ç©ºé—´ï¼Œå› æ­¤å¯ä»¥åœ¨ seaBIOS ç¯å¢ƒä¸­å¯¹ BDA è¿›è¡Œè®¿é—®ï¼Œç»“åˆ
BDA å†…å­˜å¸ƒå±€å›¾ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç åœ¨ seaBIOS ä¸­è¿›è¡Œè®¿é—®:

{% highlight bash %}
// Accessor functions
#define GET_BDA(var) \
    GET_FARVAR(SEG_BDA, ((struct bios_data_area_s *)0)->var)
#define SET_BDA(var, val) \
    SET_FARVAR(SEG_BDA, ((struct bios_data_area_s *)0)->var, (val))
{% endhighlight %}

BIOS/seaBIOS åœ¨å®æ—¶æ¨¡å¼ä¸‹å¯ä»¥ç›´æ¥è®¿é—® BDA æ•°æ®ï¼ŒseaBIOS æä¾›äº† GET_FARVAR() 
å‡½æ•°å’Œ SET_FRAVAR() å‡½æ•°è¿›è¡Œ BDA çš„è®¿é—®. seaBIOS åœ¨æºç ä¸­å®šä¹‰ struct 
bios_data_area_s æ•°æ®ç»“æ„ç”¨äºæè¿° BDA åŒºåŸŸï¼Œå¦‚ä¸‹:

{% highlight bash %}
struct bios_data_area_s {
    // 40:00
    u16 port_com[4];
    u16 port_lpt[3];
    u16 ebda_seg;
    // 40:10
    u16 equipment_list_flags;
    u8 pad1;
    u16 mem_size_kb;
    u8 pad2;
    u8 ps2_ctrl_flag;
    u16 kbd_flag0;
    u8 alt_keypad;
    u16 kbd_buf_head;
    u16 kbd_buf_tail;
    // 40:1e
    u8 kbd_buf[32];
    u8 floppy_recalibration_status;
    u8 floppy_motor_status;
    // 40:40
    u8 floppy_motor_counter;
    u8 floppy_last_status;
    u8 floppy_return_status[7];
    u8 video_mode;
    u16 video_cols;
    u16 video_pagesize;
    u16 video_pagestart;
    // 40:50
    u16 cursor_pos[8];
    // 40:60
    u16 cursor_type; 
    u8 video_page;
    u16 crtc_address;
    u8 video_msr;
    u8 video_pal;
    struct segoff_s jump;
    u8 other_6b;
    u32 timer_counter;
    // 40:70
    u8 timer_rollover;
    u8 break_flag;
    u16 soft_reset_flag;
    u8 disk_last_status;
    u8 hdcount;
    u8 disk_control_byte;
    u8 port_disk;
    u8 lpt_timeout[4];
    u8 com_timeout[4];
    // 40:80
    u16 kbd_buf_start_offset;
    u16 kbd_buf_end_offset;
    u8 video_rows;
    u16 char_height;
    u8 video_ctl;
    u8 video_switches;
    u8 modeset_ctl;
    u8 dcc_index;
    u8 floppy_last_data_rate;
    u8 disk_status_controller;
    u8 disk_error_controller;
    u8 disk_interrupt_flag;
    u8 floppy_harddisk_info;
    // 40:90
    u8 floppy_media_state[4];
    u8 floppy_track[2];
    u8 kbd_flag1;
    u8 kbd_led;
    struct segoff_s user_wait_complete_flag;
    u32 user_wait_timeout;
    // 40:A0
    u8 rtc_wait_flag;
    u8 other_a1[7];
    struct segoff_s video_savetable;
    u8 other_ac[4];
    // 40:B0
    u8 other_b0[5*16];
} PACKED;
{% endhighlight %}

-----------------------------------------

###### seaBIOS BDA å®è·µ

åŸºäºæœ¬æ–‡çš„å®è·µç« èŠ‚ä»¥åŠæœ¬èŠ‚å®è·µå†…å®¹ï¼Œå¯ä»¥åœ¨ seaBIOS å¯¹ BDA è¿›è¡Œå®è·µã€‚å¼€å‘è€…
é¦–å…ˆå‚è€ƒå®è·µç¯å¢ƒæ­å»º:

> - [seaBIOS å®è·µç¯å¢ƒéƒ¨ç½²](#C)

ç¯å¢ƒéƒ¨ç½²å®Œæ¯•ä¹‹åï¼Œåœ¨ seaBIOS æºç ç›®å½•ä¸‹å‚è€ƒä¸‹é¢ä»£ç è¿›è¡Œå®è·µ:

{% highlight bash %}
#include "biosvar.h"

int BiscuitOS_BDA(void)
{
        u32 lowmem;

	lowmem = GET_BDA(mem_size_kb) * 1024;

        printf("Low Memory: %x\n", lowmem);

        return 0;
}
{% endhighlight %}

å°†ä¸Šé¢çš„å‡½æ•°æ”¾ç½®åˆ° maininit() å‡½æ•°çš„ prepareboot() å‡½æ•°ä¹‹åè°ƒç”¨è¯¥å‡½æ•°ï¼Œç„¶åç¼–
è¯‘ seaBIOS å¹¶è¿è¡Œ BiscuitOSï¼Œå¦‚ä¸‹å›¾:

![](/assets/PDB/HK/HK000426.png)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### Memory Information on BDA

BDA æ•°æ®åŒºåŸŸå†…åŒ…å«äº†éƒ¨åˆ†ä¸å†…å­˜ç›¸å…³çš„åŒºåŸŸï¼ŒseaBIOS/BIOS åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä» BDA ä¸­
è¯»å–è¿™äº›ä¿¡æ¯ç”¨äºåˆå§‹åŒ–.

###### 0x4013

BDA æ•°æ®åŒºåŸŸä¸­ 0x4013 å­˜å‚¨äº†ç³»ç»Ÿç‰©ç†å†…å­˜ä» 0 MiB å¼€å§‹ï¼Œåˆ° EBDA æ•°æ®åŒºçš„åº•éƒ¨ï¼Œ
å³ 0x80000ï¼ŒBIOS å¯ä»¥é€šè¿‡ 0x4013 è·å¾—è¿™æ®µåŒºåŸŸå†…å­˜ç‰©ç†å†…å­˜çš„é•¿åº¦ï¼Œå…¶æŒ‰ KiB ä¸º
å•ä½è¿›è¡Œç»Ÿè®¡ã€‚å†…å­˜é•¿åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹:

{% highlight bash %}
Memory = GET_BDA(mem_size_kb) * 1024;
{% endhighlight %}

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>

#### æèµ ä¸€ä¸‹å§ ğŸ™‚

![MMU](/assets/PDB/BiscuitOS/kernel/HAB000036.jpg)
