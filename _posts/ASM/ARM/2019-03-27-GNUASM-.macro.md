---
layout:             post
title:              ".macro"
date:               2019-03-26 18:50:30 +0800
categories:         [MMU]
excerpt:            GNU ASM .macro.
tags:
  - MMU
---

> [GitHub ASM code: .macro](https://github.com/BiscuitOS/HardStack/tree/master/Language/Assembly/ARM-GNU-Assembly/Instruction/%5B.macro%5D)
>
> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

# ç›®å½•

> - [åŸç†](#åŸç†)
>
> - [å®è·µ](#å®è·µ)
>
> - [é™„å½•](#é™„å½•)

--------------------------------------------------------------
<span id="åŸç†"></span>

![MMU](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/IND00000A.jpg)

# åŸç†

.macro ä¼ªæŒ‡ä»¤å’Œ .endm ä¼ªæŒ‡ä»¤ç”¨äºå®šä¹‰ä¸€æ®µå®ï¼Œå¹¶ä¸”å®å¯ä»¥å¸¦å¤šä¸ªå‚æ•°ï¼Œä½¿ç”¨æ ¼å¼å¦‚ä¸‹ï¼š

{% highlight base %}
.macro comm
.macro plus p0, p1
.macro plus p0 p1
{% endhighlight %}

.marco å¯ä»¥å¸¦å¤šä¸ªå‚æ•°ï¼Œå¦‚ä¸Šé¢çš„å®šä¹‰ï¼Œå¦‚æœåœ¨å®å†…éƒ¨å¼•ç”¨å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š

{% highlight base %}
.macro plus p0 p1
  mov r1, \p0 @ \p0 è°ƒç”¨å‚æ•° p0
  mov r2, \p1 @ \p1 è°ƒç”¨å‚æ•° p1
.endm
{% endhighlight %}

-------------------------------------------------------------
<span id="å®è·µ"></span>

![MMU](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/IND00000P.jpg)

# å®è·µ

> - [å®è·µå‡†å¤‡](#å®è·µå‡†å¤‡)
>
> - [å®è·µç›®çš„](#å®è·µç›®çš„)
>
> - [å®è·µæºç ](#å®è·µæºç )
>
> - [æºç å®‰è£…](#æºç å®‰è£…)
>
> - [é…ç½®å†…æ ¸](#é…ç½®å†…æ ¸)
>
> - [è¿è¡Œæµ‹è¯•](#è¿è¡Œæµ‹è¯•)
>
> - [è¿è¡Œåˆ†æ](#è¿è¡Œåˆ†æ)

##### <span id="å®è·µå‡†å¤‡">å®è·µå‡†å¤‡</span>

æœ¬æ•™ç¨‹åŸºäº Linux 5.0 æºç è¿›è¡Œå®è·µï¼Œå¦‚æœè¿˜æœªæ­å»ºå¼€å‘ç¯å¢ƒï¼Œè¯·å‚è€ƒä¸‹é¢æ–‡æ¡£ï¼š

> [Linux 5.0 arm32 å¼€å‘ç¯å¢ƒæ­å»ºæ•™ç¨‹](https://biscuitos.github.io/blog/Linux-5.0-arm32-Usermanual/)

ç”±äºæœ¬æ•™ç¨‹çš„å®è·µéœ€è¦åœ¨ ARM çš„ Boot Stage 1 é˜¶æ®µè¿›è¡Œå®è·µï¼Œæ‰€ä»¥æœªæ­å»º Boot Stage 1
é˜¶æ®µè°ƒè¯•ç¯å¢ƒçš„è¯·å‚è€ƒæ–‡æ¡£ï¼š

> [ARM Boot Stage debugging usermanual](https://biscuitos.github.io/blog/BOOTASM-debuggingTools/#header)

##### <span id="å®è·µç›®çš„">å®è·µç›®çš„</span>

æœ¬ä¾‹å­ç”¨äºä»‹ç»å†…æ ¸ä¸­å¦‚ä½•ä½¿ç”¨è¯¥ä¼ªæŒ‡ä»¤ã€‚

##### <span id="å®è·µæºç ">å®è·µæºç </span>

{% highlight base %}
/*
 * GNU ARM assembly
 *
 * (C) 2019.03.26 BuddyZhang1 <buddy.zhang@aliyun.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */
#include <linux/linkage.h>
#include <asm/assembler.h>
#include <asm/v7m.h>

#include "efi-header.S"

/*
 * .macro macname
 *
 * .macro macname macargs . . .
 *
 *   Begin the definition of a macro called macname. If your macro
 *   definition requires arguments, specify their names after the
 *   macro name, separated by commas or spaces. You can supply a
 *   default value for any macro argument by following the name with
 *   â€˜=defltâ€™. For example, these are all valid .macro statements:
 *
 *     .macro comm           Begin the definition of a macro called comm,
 *                           which takes no arguments.
 *     .macro plus1 p, p1
 *     .macro plus1 p p1     Either statement begins the definition of a
 *                           macro called plus1, which takes two arguments;
 *                           within the macro definition, write â€˜\pâ€™ or
 *                           â€˜\p1â€™ to evaluate the arguments.
 *     .macro reserve_str p1=0 p2
 *                           Begin the definition of a macro called
 *                           reserve_str, with two arguments. The first
 *                           argument has a default value, but not the
 *                           second. After the definition is complete,
 *                           you can call the macro either as â€˜reserve_str
 *                           a,bâ€™ (with â€˜\p1â€™ evaluating to a and â€˜\p2â€™
 *                           evaluating to b), or as â€˜reserve_str ,bâ€™ (with
 *                           â€˜\p1â€™ evaluating as the default, in this case
 *                           â€˜0â€™, and â€˜\p2â€™ evaluating to b).
 *
 *   When you call a macro, you can specify the argument values either by
 *   position, or by keyword. For example, â€˜sum 9,17â€™ is equivalent to
 *   â€˜sum to=17, from=9â€™.
 */
@ No argument
.macro BS_nop
	mov r5, r5
	mov r5, r5
	mov r5, r5
.endm

@ A argument
.macro BS_f2 reg1
	mov \reg1, r5
	mov \reg1, r5
	mov \reg1, r5
.endm

@ Two arguments
.macro BS_f3 reg1 reg2
	mov \reg1, \reg2
	mov \reg1, \reg2
	mov \reg1, \reg2
	mov \reg1, \reg2
.endm

ENTRY(BS_func)
	BS_nop
	BS_f2 r5
	BS_f3 r2 r2
	mov r0, r0
	mov r1, r1
	mov r1, r1
	ret     lr
ENDPROC(BS_func)
{% endhighlight %}

##### <span id="æºç å®‰è£…">æºç å®‰è£…</span>

å°†æºç å‘½åä¸º bs_debug.S, å¹¶ä¿å­˜åˆ°å†…æ ¸æºç  BiscuitOS/output/linux-5.0-arm32/linux/linux/arch/arm/boot/compressed/
ç›®å½•ä¸‹ï¼Œç„¶åæ ¹æ®ä¸‹é¢çš„è¡¥ä¸æ–‡ä»¶ï¼Œä¿®æ”¹å¯¹åº”çš„ Makefile å’Œ Kconfigã€‚

{% highlight base %}
From 9e071cc349949c934a803dc34b0ab0f514ba71bb Mon Sep 17 00:00:00 2001
From: BuddyZhang1 <buddy.zhang@aliyun.com>
Date: Tue, 26 Mar 2019 08:33:19 +0800
Subject: [PATCH 1/1] Debug ARM asm install

---
 arch/arm/boot/compressed/Makefile | 4 ++++
 drivers/BiscuitOS/Kconfig         | 7 +++++++
 drivers/Makefile                  | 1 +
 3 files changed, 12 insertions(+)
 create mode 100644 drivers/BiscuitOS/Kconfig

diff --git a/arch/arm/boot/compressed/Makefile b/arch/arm/boot/compressed/Makefile
index 6114ae6..644b722 100644
--- a/arch/arm/boot/compressed/Makefile
+++ b/arch/arm/boot/compressed/Makefile
@@ -39,6 +39,10 @@ ifeq ($(CONFIG_ARCH_SA1100),y)
 OBJS		+= head-sa1100.o
 endif

+ifeq ($(CONFIG_BISCUITOS_ASM_BOOT),y)
+OBJS		+= bs_asm.o
+endif
+
 ifeq ($(CONFIG_CPU_XSCALE),y)
 OBJS		+= head-xscale.o
 endif
diff --git a/drivers/BiscuitOS/Kconfig b/drivers/BiscuitOS/Kconfig
new file mode 100644
index 0000000..99a7a40
--- /dev/null
+++ b/drivers/BiscuitOS/Kconfig
@@ -0,0 +1,7 @@
menuconfig BISCUITOS_DRV
	bool "BiscuitOS Driver"

+config BISCUITOS_ASM_BOOT
+	bool "asm boot"
+
endif # BISCUITOS_DRV
diff --git a/drivers/Makefile b/drivers/Makefile
index e1ce029..7c057e3 100644
--- a/drivers/Makefile
+++ b/drivers/Makefile
@@ -186,3 +186,4 @@ obj-$(CONFIG_MULTIPLEXER)	+= mux/
 obj-$(CONFIG_UNISYS_VISORBUS)	+= visorbus/
 obj-$(CONFIG_SIOX)		+= siox/
 obj-$(CONFIG_GNSS)		+= gnss/
+obj-$(CONFIG_BISCUITOS_DRV)     += BiscuitOS/
diff --git a/arch/arm/boot/compressed/head.S b/arch/arm/boot/compressed/head.S
index 6c7ccb4..64ec5c4 100644
--- a/arch/arm/boot/compressed/head.S
+++ b/arch/arm/boot/compressed/head.S
@@ -177,6 +177,8 @@ start:

                __EFI_HEADER
 1:
+ENTRY(BS_debug)
+               bl BS_func
  ARM_BE8(      setend  be              )       @ go BE8 if compiled for BE8
  AR_CLASS(     mrs     r9, cpsr        )
 #ifdef CONFIG_ARM_VIRT_EXT
@@ -185,6 +187,7 @@ start:
                mov     r7, r1                  @ save architecture ID
                mov     r8, r2                  @ save atags pointer
--
2.7.4
{% endhighlight %}

##### <span id="é…ç½®å†…æ ¸">é…ç½®å†…æ ¸</span>

æ ¹æ®æ–‡æ¡£ä»‹ç»çš„æ–¹æ³•é…ç½®å†…æ ¸ï¼Œé€‰é¡¹å¦‚ä¸‹ï¼š

{% highlight base %}
Device Driver--->
    [*]BiscuitOS Driver--->
        [*]asm boot
{% endhighlight %}

##### <span id="è¿è¡Œæµ‹è¯•">è¿è¡Œæµ‹è¯•</span>

å¼€å‘è€…å¯ä»¥æ ¹æ® <Linux 5.0 arm32 æ‰‹å†Œ> è¿›è¡Œç¼–è¯‘å’Œè¿è¡Œï¼Œä½¿ç”¨ GDB è°ƒè¯•ç»“æœå¦‚ä¸‹ï¼š

{% highlight base %}
buddy@BDOS:/xspace/OpenSource/BiscuitOS/BiscuitOS/output/linux-5.0-arm32/linux/linux/arch/arm/boot/compressed$ /xspace/OpenSource/BiscuitOS/BiscuitOS/output/lin
ux-5.0-arm32/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi-gdb /xspace/OpenSource/BiscuitOS/BiscuitOS/output/linux-5.0-arm32/linux/linux/arch/arm/boot/compressed/vmlinux
GNU gdb (Linaro_GDB-2019.02) 8.2.1.20190122-git
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "--host=x86_64-unknown-linux-gnu --target=arm-linux-gnueabi".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from /xspace/OpenSource/BiscuitOS/BiscuitOS/output/linux-5.0-arm32/linux/linux/arch/arm/boot/compressed/vmlinux...done.
(gdb) target remote :1234
Remote debugging using :1234
_text () at arch/arm/boot/compressed/head.S:161
161			.endr
(gdb) b BS_debug
Breakpoint 1 at 0x3c: file arch/arm/boot/compressed/head.S, line 181.
(gdb) c
Continuing.

Breakpoint 1, BS_debug () at arch/arm/boot/compressed/head.S:181
181			bl BS_func
(gdb) s
BS_func () at arch/arm/boot/compressed/bs_asm.S:72
72		BS_nop
(gdb) si
0x00003788	72		BS_nop
(gdb) ni
0x0000378c	72		BS_nop
(gdb) si
73		BS_f2 r5
(gdb) ni
0x00003794	73		BS_f2 r5
(gdb) ni
0x00003798	73		BS_f2 r5
(gdb) ni
74		BS_f3 r2 r2
(gdb) ni
0x000037a0	74		BS_f3 r2 r2
(gdb) ni
0x000037a4	74		BS_f3 r2 r2
(gdb) ni
0x000037a8	74		BS_f3 r2 r2
(gdb) ni
75		mov r0, r0
(gdb)
{% endhighlight %}

##### <span id="è¿è¡Œåˆ†æ">è¿è¡Œåˆ†æ</span>

.macro å¯ä»¥åœ¨ä½¿ç”¨ä¸­å®šä¹‰å¤šä¸ªå®ï¼Œä»¥æ­¤ä½¿é‡å¤ä»£ç å¾—åˆ°é€»è¾‘åŒ–ã€‚

-----------------------------------------------

# <span id="é™„å½•">é™„å½•</span>

> [The GNU Assembler](http://tigcc.ticalc.org/doc/gnuasm.html)
>
> [Debugging on ARM Boot Stage](https://biscuitos.github.io/blog/BOOTASM-debuggingTools/#header)
>
> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](https://biscuitos.github.io/blog/Kernel_Build/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>
> [æ­å»ºé«˜æ•ˆçš„ Linux å¼€å‘ç¯å¢ƒ](https://biscuitos.github.io/blog/Linux-debug-tools/)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/HAB000036.jpg)
