---
layout:             post
title:              ".align"
date:               2019-03-26 09:54:30 +0800
categories:         [MMU]
excerpt:            GNU ASM .align.
tags:
  - MMU
---

> [GitHub ASM code: .align](https://github.com/BiscuitOS/HardStack/tree/master/Language/Assembly/ARM-GNU-Assembly/Instruction/%5B.align%5D)
>
> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

# ç›®å½•

> - [åŸç†](#åŸç†)
>
> - [å®è·µ](#å®è·µ)
>
> - [é™„å½•](#é™„å½•)

--------------------------------------------------------------
<span id="åŸç†"></span>

![MMU](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000A.jpg)

# åŸç†

.align ä¼ªæŒ‡ä»¤ç”¨äºæ±‡ç¼–ä»£ç çš„ä¸­æ•°æ®å—æˆ–ä»£ç å—çš„å¼ºåˆ¶å¯¹é½ï¼Œå¦‚æœæŸäº›åœ°å€æœªå¯¹é½ï¼Œ
æ±‡ç¼–çš„æ—¶å€™ä¼šä½¿ç”¨ç‰¹å®šçš„æ•°æ®è¿›è¡Œå¡«å……ã€‚

--------------------------------------------------------------
<span id="å®è·µ"></span>

![MMU](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000P.jpg)

# å®è·µ

> - [å®è·µå‡†å¤‡](#å®è·µå‡†å¤‡)
>
> - [å®è·µç›®çš„](#å®è·µç›®çš„)
>
> - [å®è·µæºç ](#å®è·µæºç )
>
> - [æºç å®‰è£…](#æºç å®‰è£…)
>
> - [é…ç½®å†…æ ¸](#é…ç½®å†…æ ¸)
>
> - [è¿è¡Œæµ‹è¯•](#è¿è¡Œæµ‹è¯•)
>
> - [è¿è¡Œåˆ†æ](#è¿è¡Œåˆ†æ)

##### <span id="å®è·µå‡†å¤‡">å®è·µå‡†å¤‡</span>

æœ¬æ•™ç¨‹åŸºäº Linux 5.0 æºç è¿›è¡Œå®è·µï¼Œå¦‚æœè¿˜æœªæ­å»ºå¼€å‘ç¯å¢ƒï¼Œè¯·å‚è€ƒä¸‹é¢æ–‡æ¡£ï¼š

> [Linux 5.0 arm32 å¼€å‘ç¯å¢ƒæ­å»ºæ•™ç¨‹](https://biscuitos.github.io/blog/Linux-5.0-arm32-Usermanual/)

ç”±äºæœ¬æ•™ç¨‹çš„å®è·µéœ€è¦åœ¨ ARM çš„ Boot Stage 1 é˜¶æ®µè¿›è¡Œå®è·µï¼Œæ‰€ä»¥æœªæ­å»º Boot Stage 1
é˜¶æ®µè°ƒè¯•ç¯å¢ƒçš„è¯·å‚è€ƒæ–‡æ¡£ï¼š

> [ARM Boot Stage debugging usermanual](https://biscuitos.github.io/blog/BOOTASM-debuggingTools/#header)

##### <span id="å®è·µç›®çš„">å®è·µç›®çš„</span>

æœ¬ä¾‹å­ç”¨äºä»‹ç»å†…æ ¸ä¸­å¦‚ä½•ä½¿ç”¨è¯¥ä¼ªæŒ‡ä»¤ã€‚

##### <span id="å®è·µæºç ">å®è·µæºç </span>

{% highlight base %}
/*
 * GNU ARM assembly
 *
 * (C) 2019.03.26 BuddyZhang1 <buddy.zhang@aliyun.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */
#include <linux/linkage.h>
#include <asm/assembler.h>
#include <asm/v7m.h>

#include "efi-header.S"

/*
 * .align
 *
 * Syntax: .align alignment[, [fill][, max]]
 *
 * Pad the location counter (in the current subsection) to a particular
 * storage boundary. alignment (which must be absolute) is the alignment
 * required, as described below.
 *
 * fill (also absolute) gives the fill value to be stored in the padding
 * bytes. It (and the comma) may be omitted. If it is omitted, the padding
 * bytes are normally zero. However, on some systems, if the section is
 * marked as containing code and the fill value is omitted, the space is
 * filled with no-op instructions (I didn't checked whether this is the
 * case in TIGCC).
 *
 * max is also absolute, and is also optional. If it is present, it is the
 * maximum number of bytes that should be skipped by this alignment directive.
 * If doing the alignment would require skipping more bytes than the
 * specified maximum, then the alignment is not done at all. You can omit the
 * fill value (the second argument) entirely by simply using two commas after
 * the required alignment; this can be useful if you want the alignment to
 * be filled with no-op instructions when appropriate.
 *
 * The way the required alignment is specified varies from system to system.
 * For the a29k, hppa, m68k, m88k, w65, sparc, Xtensa, and Renesas / SuperH
 * SH, and i386 using ELF format, the first expression is the alignment
 * request in bytes. For example .align 8 advances the location counter until
 * it is a multiple of 8. If the location counter is already a multiple of 8,
 * no change is needed.
 *
 * For other systems, including the i386 using a.out format, and the arm and
 * strongarm, it is the number of low-order zero bits the location counter
 * must have after advancement. For example .align 3 advances the location
 * counter until it a multiple of 8. If the location counter is already a
 * multiple of 8, no change is needed.
 *
 * This inconsistency is due to the different behaviors of the various native
 * assemblers for these systems which as must emulate. as also provides
 * .balign and .p2align directives, which have a consistent behavior across
 * all architectures (but are specific to as).
 */

ENTRY(BS_func)
	.align  4
	mov r0, r0
	ret     lr
ENDPROC(BS_func)
{% endhighlight %}

##### <span id="æºç å®‰è£…">æºç å®‰è£…</span>

å°†æºç å‘½åä¸º bs_debug.S, å¹¶ä¿å­˜åˆ°å†…æ ¸æºç  BiscuitOS/output/linux-5.0-arm32/linux/linux/arch/arm/boot/compressed/
ç›®å½•ä¸‹ï¼Œç„¶åæ ¹æ®ä¸‹é¢çš„è¡¥ä¸æ–‡ä»¶ï¼Œä¿®æ”¹å¯¹åº”çš„ Makefile å’Œ Kconfigã€‚

{% highlight base %}
From 9e071cc349949c934a803dc34b0ab0f514ba71bb Mon Sep 17 00:00:00 2001
From: BuddyZhang1 <buddy.zhang@aliyun.com>
Date: Tue, 26 Mar 2019 08:33:19 +0800
Subject: [PATCH 1/1] Debug ARM asm install

---
 arch/arm/boot/compressed/Makefile | 4 ++++
 drivers/BiscuitOS/Kconfig         | 7 +++++++
 drivers/Makefile                  | 1 +
 3 files changed, 12 insertions(+)
 create mode 100644 drivers/BiscuitOS/Kconfig

diff --git a/arch/arm/boot/compressed/Makefile b/arch/arm/boot/compressed/Makefile
index 6114ae6..644b722 100644
--- a/arch/arm/boot/compressed/Makefile
+++ b/arch/arm/boot/compressed/Makefile
@@ -39,6 +39,10 @@ ifeq ($(CONFIG_ARCH_SA1100),y)
 OBJS		+= head-sa1100.o
 endif

+ifeq ($(CONFIG_BISCUITOS_ASM_BOOT),y)
+OBJS		+= bs_asm.o
+endif
+
 ifeq ($(CONFIG_CPU_XSCALE),y)
 OBJS		+= head-xscale.o
 endif
diff --git a/drivers/BiscuitOS/Kconfig b/drivers/BiscuitOS/Kconfig
new file mode 100644
index 0000000..99a7a40
--- /dev/null
+++ b/drivers/BiscuitOS/Kconfig
@@ -0,0 +1,7 @@
menuconfig BISCUITOS_DRV
	bool "BiscuitOS Driver"

+config BISCUITOS_ASM_BOOT
+	bool "asm boot"
+
endif # BISCUITOS_DRV
diff --git a/drivers/Makefile b/drivers/Makefile
index e1ce029..7c057e3 100644
--- a/drivers/Makefile
+++ b/drivers/Makefile
@@ -186,3 +186,4 @@ obj-$(CONFIG_MULTIPLEXER)	+= mux/
 obj-$(CONFIG_UNISYS_VISORBUS)	+= visorbus/
 obj-$(CONFIG_SIOX)		+= siox/
 obj-$(CONFIG_GNSS)		+= gnss/
+obj-$(CONFIG_BISCUITOS_DRV)     += BiscuitOS/
diff --git a/arch/arm/boot/compressed/head.S b/arch/arm/boot/compressed/head.S
index 6c7ccb4..64ec5c4 100644
--- a/arch/arm/boot/compressed/head.S
+++ b/arch/arm/boot/compressed/head.S
@@ -177,6 +177,8 @@ start:

                __EFI_HEADER
 1:
+ENTRY(BS_debug)
+               bl BS_func
  ARM_BE8(      setend  be              )       @ go BE8 if compiled for BE8
  AR_CLASS(     mrs     r9, cpsr        )
 #ifdef CONFIG_ARM_VIRT_EXT
@@ -185,6 +187,7 @@ start:
                mov     r7, r1                  @ save architecture ID
                mov     r8, r2                  @ save atags pointer
--
2.7.4
{% endhighlight %}

##### <span id="é…ç½®å†…æ ¸">é…ç½®å†…æ ¸</span>

æ ¹æ®æ–‡æ¡£ä»‹ç»çš„æ–¹æ³•é…ç½®å†…æ ¸ï¼Œé€‰é¡¹å¦‚ä¸‹ï¼š

{% highlight base %}
Device Driver--->
    [*]BiscuitOS Driver--->
        [*]asm boot
{% endhighlight %}

##### <span id="è¿è¡Œæµ‹è¯•">è¿è¡Œæµ‹è¯•</span>

å¼€å‘è€…å¯ä»¥æ ¹æ® <Linux 5.0 arm32 æ‰‹å†Œ> è¿›è¡Œç¼–è¯‘å’Œè¿è¡Œï¼Œè¿è¡Œæ—¶çš„ç»“æœå¦‚ä¸‹ï¼š

{% highlight base %}
buddy@BDOS:/xspace/OpenSource/BiscuitOS/BiscuitOS/output/linux-5.0-arm32/linux/linux/arch/arm/boot/compressed$ /xspace/OpenSource/BiscuitOS/BiscuitOS/output/lin
ux-5.0-arm32/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi-gdb /xspace/OpenSource/BiscuitOS/BiscuitOS/output/linux-5.0-arm32/linux/linux/arch/arm/boot/compressed/vmlinux
GNU gdb (Linaro_GDB-2019.02) 8.2.1.20190122-git
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "--host=x86_64-unknown-linux-gnu --target=arm-linux-gnueabi".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from /xspace/OpenSource/BiscuitOS/BiscuitOS/output/linux-5.0-arm32/linux/linux/arch/arm/boot/compressed/vmlinux...done.
(gdb) target remote :1234
Remote debugging using :1234
_text () at arch/arm/boot/compressed/head.S:161
161			.endr
(gdb) b BS_debug
Breakpoint 1 at 0x3c: file arch/arm/boot/compressed/head.S, line 181.
(gdb) s
_text () at arch/arm/boot/compressed/head.S:163
163			mov	r0, r0
(gdb) list
158			.type	start,#function
159			.rept	7
160			__nop
161			.endr
162	#ifndef CONFIG_THUMB2_KERNEL
163			mov	r0, r0
164	#else
165	 AR_CLASS(	sub	pc, pc, #3	)	@ A/R: switch to Thumb2 mode
166	  M_CLASS(	nop.w			)	@ M: already in Thumb2 mode
167			.thumb
(gdb)
{% endhighlight %}


##### <span id="è¿è¡Œåˆ†æ">è¿è¡Œåˆ†æ</span>

ä»ä¸Šå›¾çš„è¿è¡Œçœ‹å‡ºï¼Œä¸èƒ½é€šè¿‡æœ‰æ•ˆçš„æ–¹æ³•çœ‹å‡ºå¯¹é½çš„æ•ˆæœ

-----------------------------------------------

# <span id="é™„å½•">é™„å½•</span>

> [The GNU Assembler](http://tigcc.ticalc.org/doc/gnuasm.html)
>
> [The GNU Assembly: .align](http://tigcc.ticalc.org/doc/gnuasm.html#SEC70)
>
> [Debugging on ARM Boot Stage](https://biscuitos.github.io/blog/BOOTASM-debuggingTools/#header)
>
> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](https://biscuitos.github.io/blog/Kernel_Build/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>
> [æ­å»ºé«˜æ•ˆçš„ Linux å¼€å‘ç¯å¢ƒ](https://biscuitos.github.io/blog/Linux-debug-tools/)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
