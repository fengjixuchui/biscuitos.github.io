---
layout: post
title:  "Bitmap Source Code"
date:   2019-06-10 05:30:30 +0800
categories: [HW]
excerpt: BITMAP sc().
tags:
  - Tree
---

![DTS](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000B.jpg)

> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

-----------------------------------

# <span id="_find_next_bit">_find_next_bit</span>

{% highlight bash %}
/*
 * This is a common helper function for find_next_bit, find_next_zero_bit, and
 * find_next_and_bit. The differences are:
 *  - The "invert" argument, which is XORed with each fetched word before
 *    searching it for one bits.
 *  - The optional "addr2", which is anded with "addr1" if present.
 */
static inline unsigned long _find_next_bit(const unsigned long *addr1,
                const unsigned long *addr2, unsigned long nbits,
                unsigned long start, unsigned long invert)
{
        unsigned long tmp;

        if (unlikely(start >= nbits))
                return nbits;

        tmp = addr1[start / BITS_PER_LONG];
        if (addr2)
                tmp &= addr2[start / BITS_PER_LONG];
        tmp ^= invert;

        /* Handle 1st word */
        tmp &= BITMAP_FIRST_WORD_MASK(start);
        start = round_down(start, BITS_PER_LONG);

        while (!tmp) {
                start += BITS_PER_LONG;
                if (start >= nbits)
                        return nbits;

                tmp = addr1[start / BITS_PER_LONG];
                if (addr2)
                        tmp &= addr2[start / BITS_PER_LONG];
                tmp ^= invert;
        }

        return min(start + __ffs(tmp), nbits);
}
{% endhighlight %}

_find_next_bit() å‡½æ•°ç”¨äºæŸ¥æ‰¾ä¸‹ä¸€ä¸ªç½®ä½çš„ä½ç½®ã€‚å‚æ•° addr1 æŒ‡å‘ç¬¬ä¸€ä¸ª bitmapï¼›
å‚æ•° addr2 æŒ‡å‘ç¬¬äºŒä¸ª bitmapï¼›å‚æ•° nbts æŒ‡å‘éœ€è¦æŸ¥æ‰¾çš„èŒƒå›´ï¼›å‚æ•° start æŒ‡å®š
å¼€å§‹æŸ¥æ‰¾çš„ä½ç½®ï¼›å‚æ•° invert ç”¨äºç¿»è½¬ bitmapã€‚å‡½æ•°é¦–å…ˆåˆ¤æ–­ start æ˜¯å¦æ¯” nbits
å¤§ï¼Œå¦‚æœæ‰“ä»£è¡¨å·²ç»æŸ¥è¿‡æŸ¥æ‰¾çš„èŒƒå›´ï¼Œç›´æ¥è¿”å› nbitsï¼›åä¹‹å¯ä»¥æ­£å¸¸æŸ¥æ‰¾ã€‚å‡½æ•°ç»§ç»­
è®¡ç®— start ä½äº bitmap çš„ç¬¬å‡ ä¸ª long é‡Œï¼Œå¹¶å°†å¯¹äºçš„ long å­˜å‚¨åœ¨ tmp å˜é‡é‡Œï¼Œ
å¦‚æœæ­¤æ—¶ addr2 å­˜åœ¨ï¼Œé‚£ä¹ˆå°† start åœ¨ addr2 ä¸­å¯¹åº”çš„ long å˜é‡ä¸ tmp ç›¸ä¸ï¼Œ
ç»“æœå­˜å‚¨åœ¨ tmp ä¸­ã€‚æ­¤æ—¶å°† tmp ä¸ å‚æ•° invert åšå¼‚æˆ–è¿ç®—ï¼Œç›¸åŒçš„ bit ä¸º 0ï¼Œ
ä¸ç›¸åŒçš„ bit ä¸º 1ï¼Œä»¥æ­¤æ„é€ ä¸€ä¸ª 1 çš„ bitmapã€‚æ¥ä¸‹æ¥ï¼Œå‡½æ•°é¦–å…ˆé€šè¿‡
BITMAP_FIRST_WORD_MASK() å‡½æ•°è·å¾— start å¯¹åº”çš„æ©ç ï¼Œè¯¥æ©ç ä¸ tmp ç›¸ä¸ï¼Œä»¥
æ­¤è·å¾— start ä¹‹åçš„ bitã€‚æ¥ç€è°ƒç”¨ round_down() å‡½æ•°è®¡ç®— start çš„ä¸Šä¸€ä¸ª long
çš„ä½ç½®ã€‚å¦‚æœæ­¤æ—¶ tmp çš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆä»£è¡¨å¯¹åº”çš„ long åŒ…å«çš„ bit å…¨ä¸º 0ï¼Œé‚£ä¹ˆ
é€šè¿‡ while å¾ªç¯è·³è½¬åˆ°ä¸‹ä¸€ä¸ª longï¼Œå¹¶å¯¹ä¸‹ä¸€ä¸ª long å¯¹åº”çš„å€¼åšå¼‚æˆ–è¿ç®—ã€‚æœ€å
è°ƒç”¨ __ffs(tmp) å‡½æ•°è·å¾— tmp ä¸­ç¬¬ä¸€æ¬¡ç½®ä½çš„ä½ç½®ï¼Œç„¶åé€šè¿‡ min æ¯”è¾ƒ start
+ __ffs() ä¸ nbits çš„å¤§å°ï¼Œä»¥æ­¤è·å¾—ç¬¬ä¸€ä¸ªç½®ä½çš„ä½ç½®ã€‚

> - [BITMAP_FIRST_WORD_MASK](https://biscuitos.github.io/blog/BITMAP_BITMAP_FIRST_WORD_MASK/)

-----------------------------------------------

# <span id="é™„å½•">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](https://biscuitos.github.io/blog/Kernel_Build/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>
> [æ­å»ºé«˜æ•ˆçš„ Linux å¼€å‘ç¯å¢ƒ](https://biscuitos.github.io/blog/Linux-debug-tools/)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
