---
layout: post
title:  "å†…å­˜è™šæ‹ŸåŒ–: Memory Virtualization base on KVM"
date:   2020-10-24 06:00:00 +0800
categories: [HW]
excerpt: Memory Virtualization.
tags:
  - KVM
---

![](/assets/PDB/BiscuitOS/kernel/IND00000L0.PNG)

![](/assets/PDB/RPI/RPI100100.png)

#### ç›®å½•

> - [å†…å­˜è™šæ‹ŸåŒ–åŸºç¡€](#A)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000T.jpg)

#### å†…å­˜è™šæ‹ŸåŒ–åŸºç¡€


#### åŸºç¡€æ¦‚å¿µ

-------------------------------------

###### GVA 

![](/assets/PDB/HK/HK000611.png)

åœ¨è™šæ‹ŸåŒ–ä¸­ï¼Œè™šæ‹Ÿæœºç§°ä¸º Guest OS, å…¶è¿è¡Œåœ¨ç‰©ç†æœºçš„ VMX Non-Root æ¨¡å¼ä¸‹ã€‚åœ¨ Guest OS å†…éƒ¨ï¼Œå½“ Guest OS è¿›å…¥ä¿æŠ¤æ¨¡å¼ä¹‹åï¼ŒGuest OS å†…éƒ¨ç¨‹åºå’Œç³»ç»Ÿå¯ä»¥ç›´æ¥è®¿é—®çš„åœ°å€ç§°ä¸º GVAã€‚GVA å…¨ç§° "Guest Vritual Address"ï¼Œå³è™šæ‹Ÿæœºç¨‹åºè¿è¡Œçš„è™šæ‹Ÿåœ°å€ã€‚GVA çš„é€»è¾‘å«ä¹‰ä¸ç‰©ç†æœºçš„è™šæ‹Ÿåœ°å€æ¦‚å¿µä¸€æ ·ï¼Œéƒ½æ˜¯é€šè¿‡é¡µè¡¨çš„æ–¹å¼ä¸ç‰©ç†å†…å­˜æƒ³å…³è”ï¼Œåªæ˜¯åœ¨ Guest OS å†…éƒ¨ï¼ŒGVA é€šè¿‡é¡µè¡¨ä¸ GPA ç›¸å…³è”, è¿™é‡Œçš„ GPA å°±æ˜¯ Guest OS çš„ç‰©ç†åœ°å€ã€‚

-------------------------------------

###### GPA/GFN

![](/assets/PDB/HK/HK000612.png)

åœ¨è™šæ‹ŸåŒ–ä¸­ï¼Œè™šæ‹Ÿæœºç§°ä¸º Guest OSï¼Œå…¶è¿è¡Œåœ¨ç‰©ç†æœºçš„ VMX Non-Root æ¨¡å¼ä¸‹ã€‚åœ¨ VMX Non-Root æ¨¡å¼ä¸‹ï¼ŒGuest OS å¯ä»¥è®¿é—®çš„ç‰©ç†å†…å­˜å¯¹åº”çš„åœ°å€ç§°ä¸º GPA. GPA å…¨ç§° "Guest Physical Address", å› æ­¤ GPA å°±ç§°ä¸ºè™šæ‹Ÿæœºçš„ç‰©ç†åœ°å€. ä» Guest OS å†…éƒ¨æ¥çœ‹ï¼ŒGPA æ„æˆçš„åœ°å€ç©ºé—´å°±æ˜¯ Guest OS çš„ç‰©ç†å†…å­˜ï¼Œè€Œä» Host è§’åº¦æ¥çœ‹ï¼ŒGPA æ„æˆçš„åœ°å€ç©ºé—´åˆ™æ˜¯ Host ç«¯çš„è™šæ‹Ÿåœ°å€ç©ºé—´.

Guest OS å°†ç‰©ç†å†…å­˜æŒ‰ PAGE_SIZE å¤§å°å°†ç‰©ç†å†…å­˜åˆ’åˆ†æˆä¸€ä¸ªä¸ªç‹¬ç«‹çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼Œç„¶åä» 0 åœ°å€åˆ°é«˜åœ°å€çš„æ–¹å¼ï¼Œä¸ºæ¯ä¸ªç‰©ç†å†…å­˜åŒºå—è¿›è¡Œç¼–å·ï¼Œè¿™ä¸ªå·ç ç§°ä¸º Guest OS çš„ç‰©ç†é¡µå¸§å·ï¼Œç®€ç§° "GFN", GFN ä¸ GPA çš„å…³ç³»å¦‚ä¸‹:

> GFN = GPA \>\> PAGE_SIZE

-------------------------------------

###### HVA

![](/assets/PDB/HK/HK000613.png)

åœ¨è™šæ‹ŸåŒ–ä¸­ï¼ŒHost OS çš„è™šæ‹Ÿåœ°å€ç§°ä¸º HVA. è™šæ‹Ÿæœºå¯¹äº Host OS æ¥è¯´æ˜¯ä¸€ä¸ªä¸ªç‹¬ç«‹çš„ qemu-kvm è¿›ç¨‹ï¼ŒGuest OS å†…éƒ¨è¿è¡Œåœ¨ VMX Non-root æ¨¡å¼ï¼ŒGuest OS æ˜¯æ— æ³•æ„ŸçŸ¥åˆ° Host è™šæ‹Ÿåœ°å€çš„å­˜åœ¨ï¼Œåªèƒ½æ„ŸçŸ¥åˆ° Guest OS å†…éƒ¨çš„ç‰©ç†åœ°å€å­˜åœ¨; ç›¸å Host OS ä¹Ÿæ— æ³•æ„ŸçŸ¥åˆ° Guest OS çš„ç‰©ç†åœ°å€å­˜åœ¨ï¼Œå¯¹ Host OS æ¥è¯´éƒ½æ˜¯è™šæ‹Ÿåœ°å€ã€‚qemu-kvm åœ¨åˆ›å»º Guest OS çš„æ—¶å€™ï¼Œä» Host OS ä¸Šç”³è¯·ä¸€æ®µæ®µè™šæ‹Ÿåœ°å€ç©ºé—´ä½œä¸º Guest OS çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œè¿™é‡Œçš„ Host è™šæ‹Ÿå†…å­˜å¯èƒ½å……å½“ Guest OS çš„ç‰©ç†å†…å­˜ã€SMIOã€E820 é¢„ç•™åŒºç­‰ã€‚

---------------------------------------

###### HPA/HFN/PFN

![](/assets/PDB/HK/HK000614.png)

åœ¨è™šæ‹ŸåŒ–ä¸­ï¼ŒHPA ç§°ä¸ºç‰©ç†ä¸»æœºçš„ç‰©ç†åœ°å€ã€‚ä¸é€šå¸¸æ¦‚å¿µçš„ç‰©ç†åœ°å€ä¸€æ ·ï¼Œè¿™æ˜¯ç‰©ç†æœºæ­£çœŸçš„ç‰©ç†å†…å­˜æä¾›çš„åœ°å€ã€‚ç‰©ç†å†…å­˜æä¾›äº†ç‰©ç†åœ°å€ã€ç‰©ç†é¡µå¸§å·å’Œ struct page ç­‰ä¿¡æ¯ã€‚Host OS ç›´æ¥è®¿é—®è™šæ‹Ÿåœ°å€ï¼Œç¡¬ä»¶ MMU/TLB ç­‰è®¾å¤‡ä¼šè‡ªåŠ¨æŸ¥è¯¢é¡µè¡¨ï¼Œå°†ä¸€ä¸ª HVA è‡ªåŠ¨è½¬æ¢æˆ HPA; å¦‚æœé¡µè¡¨ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆ Host OS å¯ä»¥é€šè¿‡ç¼ºé¡µæœºåˆ¶ä¸º HVA ä¸æŸä¸ª HGA å»ºç«‹æ˜ å°„ã€‚

Host OS æŒ‰ PAGE_SIZE çš„å¤§å°å°†ç‰©ç†å†…å­˜åˆ’åˆ†ä¸ºå¤šä¸ªå†…å­˜åŒºåŸŸï¼Œå¹¶ä» 0 åœ°å€åˆ°é«˜åœ°å€çš„å¾ªåºä¸ºæ¯ä¸ªç‰©ç†å†…å­˜åŒºåŸŸè¿›è¡Œç¼–å·ï¼Œè¿™ä¸ªå·ç ç§°ä¸ºé¡µå¸§å·ï¼Œä¹Ÿç§°ä¸º PFN, æˆ–è€… HFN. ä¸‰è€…ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹:

> PFN = HPA \>\> PAGE_SIZE

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Blog 2.0](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>

#### æèµ ä¸€ä¸‹å§ ğŸ™‚

![MMU](/assets/PDB/BiscuitOS/kernel/HAB000036.jpg)
