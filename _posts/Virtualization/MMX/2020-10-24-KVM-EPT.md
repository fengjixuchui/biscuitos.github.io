---
layout: post
title:  "EPT: The Extended Page Table Mechanism"
date:   2020-10-24 06:00:00 +0800
categories: [HW]
excerpt: EPT.
tags:
  - KVM
---

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI100100.png)

#### ç›®å½•

> - [EPT åŸç†](#A)
>
> - [EPT ä½¿ç”¨](#B)
>
> - [EPT å®è·µ](#C)
>
> - [é™„å½•/æèµ ](#Z0)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000H.jpg)

#### EPT åŸç†

> - [EPT æ¦‚æ‹¬](#A1)
>
> - [EPT EPTP](#A3)
>
> - [EPT PML4/PML4Es](#A4)
>
> - [EPT PDP/PDPTE](#A5)
> 
> - [EPT å¯ç”¨](#A2)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A1"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000K.jpg)

#### EPT æ¦‚æ‹¬

EPT å…¨ç§° "The Extended page-table machanism", å®ƒåœ¨å†…å­˜è™šæ‹ŸåŒ–ä¸­å°† Guest OS ç‰©ç†åœ°å€è½¬æ¢æˆ Host OS ç‰©ç†åœ°å€ï¼Œä»¥ä¾¿ Guest OS è®¿é—®ç‰©ç†å†…å­˜. EPT æ˜¯ Intel æ¶æ„æ”¯æŒçš„ç¡¬ä»¶åŠŸèƒ½. åœ¨æ”¯æŒ EPT çš„ç³»ç»Ÿä¸­ï¼ŒGuest OS ç‰©ç†åœ°å€è½¬æ¢æˆ Host OS çš„ç‰©ç†åœ°å€é€šè¿‡ä¸€ç³»åˆ—çš„ EPT é¡µè¡¨ç»“æ„ã€‚EPT é¡µè¡¨ç»“æ„ç±»ä¼¼äº IA-32e æ¨¡å¼ä¸‹çº¿æ€§åœ°å€è½¬æ¢æ—¶çš„é¡µè¡¨ç»“æ„ã€‚å½“ç³»ç»Ÿæ”¯æŒ EPT åŠŸèƒ½ä¹‹å¤–ï¼ŒEPT é¡µè¡¨çš„è¡Œä¸ºè¿˜ä¸å¤šä¸ªæ§åˆ¶ä½æœ‰å…³ï¼ŒIntel æ‰‹å†Œä¸­è¿™ä¹ˆæè¿°:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000725.png)

CR0 å¯„å­˜å™¨çš„ PG æ§åˆ¶ä½ç”¨äºæ§åˆ¶ç³»ç»Ÿçš„åˆ†é¡µåŠŸèƒ½ã€‚åœ¨ Guest OS å†…éƒ¨ï¼Œå½“ CR0.PG ç½®ä½çš„æ—¶å€™ï¼ŒGuest OS çš„çº¿æ€§åœ°å€å°±æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè™šæ‹Ÿåœ°å€éœ€è¦ CR3 å¯„å­˜å™¨æŒ‡å‘çš„é¡µè¡¨è¿›è¡Œè½¬æ¢æ‰èƒ½è®¿é—® Guest OS çš„å†…å­˜ï¼Œå¹¶ä¸”å½“ EPT åŠŸèƒ½ä½¿èƒ½çš„æƒ…å†µä¸‹ï¼Œè¿™äº›é¡µè¡¨ç§°ä¸º "Guest paging structures"; åä¹‹å½“ CR0.PG æ¸…é›¶æ—¶ï¼ŒGuest OS çš„çº¿æ€§åœ°å€å°±æ˜¯ç‰©ç†åœ°å€ï¼Œæ­¤æ—¶çº¿æ€§åœ°å€ä¸éœ€è¦é¡µè¡¨çš„è½¬æ¢ï¼ŒGuest OS ç›´æ¥ä½¿ç”¨çº¿æ€§åœ°å€å°±èƒ½è®¿é—® Guest OS çš„å†…å­˜ã€‚å› æ­¤åœ¨ Guest OS å†…éƒ¨è™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€çš„é€»è¾‘å¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000726.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000727.png)

> [CR0 å¯„å­˜å™¨](#A02)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000729.png)

å½“ CR0.PG ç½®ä½ï¼ŒGuest OS çš„çº¿æ€§åœ°å€è½¬æ¢æˆç‰©ç†åœ°å€éœ€è¦å¤šæ¬¡çš„ EPT é¡µè¡¨è¿›è¡Œè½¬æ¢æ‰èƒ½è·å¾—å¯¹åº”çš„ Host OS çš„ç‰©ç†åœ°å€ã€‚å‡è®¾ CR4.PAE å’Œ CR4.PSE éƒ½æ¸…é›¶ï¼Œé‚£ä¹ˆåœ¨ EPT ä½¿èƒ½çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ª 32 ä½çš„ Guest OS çº¿æ€§åœ°å€çš„è½¬æ¢å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000730.png)

å½“ä¸€ä¸ª Guest OS çš„è™šæ‹Ÿåœ°å€è½¬(GVA) æ¢æˆ Guest OS ç‰©ç†åœ°å€(GPA)æ—¶ï¼ŒGuest OS é¦–å…ˆä» gCR3 å¯„å­˜å™¨ä¸­è·å¾—æŒ‡å‘ Guest OS é¡µè¡¨çš„é¡µç›®å½•åŸºåœ°å€ï¼Œè¯¥å€¼æ˜¯ä¸€ä¸ª Guest OS çš„ç‰©ç†åœ°å€(GPA), å­˜åœ¨ gCR3 å¯„å­˜å™¨é‡Œï¼Œå½“ Guest OS å¼•ç”¨ gCR3 å¯„å­˜å™¨é‡Œé¢çš„ç‰©ç†åœ°å€(GPA)æ—¶ï¼Œä¼šè§¦å‘ä»¥æ­¤ EPT é¡µè¡¨è½¬æ¢ï¼Œç³»ç»Ÿå°† Guest OS çš„ç‰©ç†åœ°å€åœ°å€(GPA)è½¬æ¢æˆ Host OS çš„ç‰©ç†åœ°å€(HPA)ï¼Œè¿™æ ·å¯ä»¥è¯»å–åˆ°å†…å­˜çœŸå®å­˜å‚¨é¡µç›®å½•é¡µè¡¨çš„å†…å®¹ï¼Œé¡µç›®å½•é¡µè¡¨çš„å†…å®¹é‡Œå…¨éƒ¨éƒ½æ˜¯ Guest OS çš„ç‰©ç†åœ°å€ (GPA), æ­¤æ—¶å°† Guest OS è™šæ‹Ÿåœ°å€(GVA)çš„ 31:22 ä½ä½œä¸ºç´¢å¼•ï¼Œåœ¨é¡µç›®å½•é¡µè¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªå…¥å£ï¼Œè¿™ä¸ªå…¥å£ç§°ä¸º PDE, PDE é‡Œé¢å­˜å‚¨çš„åŒæ ·æ˜¯ä¸€ä¸ª Guest OS çš„ç‰©ç†åœ°å€ (GPA), å¹¶æŒ‡å‘ PTE é¡µè¡¨çš„å…¥å£ã€‚å½“ Guest OS å¼•ç”¨è¿™ä¸ª PDE å…¥å£æ—¶ä¼šè§¦å‘ EPT å°†è¿™ä¸ª Guest OS çš„ç‰©ç†åœ°å€(GPA) è½¬æ¢æˆ Host OS çš„ç‰©ç†åœ°å€(HPA), æ­¤æ—¶ HOST OS ç‰©ç†åœ°å€å¯¹åº”çš„å†…å­˜ä¸­å­˜å‚¨ç€ PTE é¡µè¡¨çš„å†…å®¹ï¼Œæ­¤æ—¶ç³»ç»Ÿå°† Guest OS è™šæ‹Ÿåœ°å€(GVA) çš„ 21:12 ä½åŸŸä½œä¸ºç´¢å¼•æ‰¾åˆ°ä¸€ä¸ª PTE, è¿™ä¸ª PTE é‡Œé¢åŒæ ·å­˜å‚¨ç€ä¸€ä¸ª Guest OS çš„ç‰©ç†åœ°å€(GPA), è¯¥åœ°å€æŒ‡å‘ä¸€ä¸ª Guest OS çš„ç‰©ç†é¡µã€‚æ­¤æ—¶å¯¹è¿™ä¸ª PTE å¼•ç”¨å°†ä¼šè§¦å‘ EPT å°†è¿™ä¸ªGuest OS ç‰©ç†åœ°å€(GPA) è½¬æ¢æˆä¸€ä¸ª HOST OS çš„ç‰©ç†åœ°å€(HPA). Guest OS ç»§ç»­å°† Guest OS è™šæ‹Ÿåœ°å€çš„ 11:0 ä½åŸŸä½œä¸ºç´¢å¼•è·å¾—ä¸€ä¸ªæœ€åçš„ Guest OS ç‰©ç†åœ°å€(GPA), è‡³æ­¤ï¼Œä¸€ä¸ª Guest OS çš„è™šæ‹Ÿåœ°å€(GVA)å°±å®Œæˆäº†è½¬æ¢è·å¾—äº†ä¸€ä¸ª Guest OS çš„ç‰©ç†åœ°å€(GPA). å¦‚æœæ¥ä¸‹æ¥ Guest OS å¯¹è¿™ä¸ªç‰©ç†åœ°å€è¿›è¡Œå¼•ç”¨ï¼Œé‚£ä¹ˆä¼šè§¦å‘ EPT é¡µè¡¨å°†è¿™ä¸ª Guest OS ç‰©ç†åœ°å€(GPA) è½¬æ¢æˆ Host OS çš„ç‰©ç†åœ°å€(HPA), æœ€ç»ˆè®¿é—®çœŸå®çš„å†…å­˜.

> [CR4 å¯„å­˜å™¨](#A04)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000731.png)

å¦å¤–ï¼Œä¸€ä¸ªå¤„ç†å™¨åªæœ‰åœ¨åœ¨ Guest OS è®¿é—®ä¸€æ®µ Guet OS çš„ç‰©ç†å†…å­˜æ—¶å€™æ‰ä¼šè§¦å‘ EPT é¡µè¡¨å°†ä¸€ä¸ª Guest OS ç‰©ç†åœ°å€è½¬æ¢æˆä¸€ä¸ª HOST OS ç‰©ç†åœ°å€.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000732.png)

è™½ç„¶ Guest OS è®¿é—®å†…å­˜ä¼šè§¦å‘ EPT è½¬æ¢ï¼Œä½†åœ¨æœ‰çš„æƒ…å†µä¸‹ï¼ŒåŒæ ·çš„æŒ‡ä»¤æ“ä½œä¸ä¸€å®šè§¦å‘å†…å­˜çš„è®¿é—®ï¼Œä¾‹å¦‚å½“æ‰§è¡Œ "MOV to CR3" æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤ä¼šå°†ä¸€ä¸ª Guest OS çš„ç‰©ç†åœ°å€(GPA) åŠ è½½åˆ° CR3 å¯„å­˜å™¨ä¸­ï¼Œæ­¤æ—¶è®¿é—® CR3 å¯„å­˜å™¨çš„å€¼æ—¶æ˜¯å¦ä¼šè§¦å‘ EPT è½¬æ¢ï¼Œè¿™å¾—ä¾èµ–ä¸ PAE åˆ†é¡µçš„ä½¿ç”¨ï¼Œä»ä¹‹å‰çš„åˆ†æå¯ä»¥çŸ¥é“ CR4.PAE ç”¨äºä½¿èƒ½ç‰©ç†åœ°å€æ‹“å±•åŠŸèƒ½ï¼Œå¦‚æœ PAE å¯ç”¨ï¼Œé‚£ä¹ˆç‰©ç†åœ°å€çš„ä½æ•°å°†è¶…è¿‡ 32bitã€‚å› æ­¤å½“ PAE æ²¡æœ‰ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œ"MOV to CR3" ä¸ä¼šè§¦å‘ Guest OS è®¿é—®å†…å­˜ï¼Œå› æ­¤ä¸ä¼šè§¦å‘ EPT é¡µè¡¨çš„è½¬æ¢; åä¹‹å¦‚æœ PAE å¯ç”¨ï¼Œé‚£ CR3 å¯„å­˜å™¨ä¸­å­˜å‚¨çš„ PDPTEsï¼Œå³é¡µç›®å½•æŒ‡é’ˆé¡µè¡¨çš„å…¥å£ï¼Œå› æ­¤ä¼šæ¶‰åŠå†…å­˜çš„è®¿é—®ï¼Œå› æ­¤ "MOV to CR3" ä¼šè§¦å‘ EPT é¡µè¡¨çš„è½¬æ¢. "MOV to CR0" å’Œ "MOV to CR3" ä¼šè§¦å‘ CR3 åŠ è½½ä¸€ä¸ª PDPTEs çš„æ“ä½œï¼Œå¹¶è®¿é—®å†…å®¹ï¼Œé‚£ä¹ˆè¯¥æ“ä½œä¼šè§¦å‘ EPT é¡µè¡¨è½¬æ¢. å¦‚æœå°†ä¸€ä¸ª PDPTEs é‡Œé¢å­˜å‚¨è¿™ä¸ªä¸€ä¸ª Guest OS ç‰©ç†åœ°å€(GPA), å¹¶åŠ è½½åˆ° CR3 å¯„å­˜å™¨ï¼Œä½†æ²¡æœ‰è§¦å‘å†…å­˜çš„è®¿é—®ï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šè§¦å‘ EPT é¡µè¡¨çš„è½¬æ¢ã€‚

> [CR0 å¯„å­˜å™¨](#A02)
>
> [CR3 å¯„å­˜å™¨](#A03)
>
> [CR4 å¯„å­˜å™¨](#A04)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A3"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000R.jpg)

#### EPT EPTP

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000733.png)

åœ¨æ¯ä¸ª VCPU çš„ VMCS ä¸Šä¸‹æ–‡çš„ VM-execution æ§åˆ¶åŸŸä¸­å­˜åœ¨ä¸€ä¸ªåä¸º "The extended-page-table Point(EPTP)" çš„æ§åˆ¶åŸŸï¼Œè¯¥æ§åˆ¶åŸŸåŒ…å«äº†å³ EPT PML4 é¡µè¡¨çš„åŸºåœ°å€ï¼Œä¹ŸåŒ…å«äº†ä¸€äº› EPT çš„é…ç½®ä¿¡æ¯ï¼ŒEPTP çš„æ ¼å¼å¦‚è¡¨.

-------------------------

###### bit N-1:12

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000734.png)

åœ¨ EPTP ä¸­ï¼Œ"N-1:12" å­—æ®µç”¨äºæŒ‡å‘ä¸€å¼  4KiB çš„ EPT PM4L é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œè¿™é‡Œçš„ç‰©ç†åœ°å€æ˜¯ä¸€ä¸ª HOST OS ç‰©ç†åœ°å€(HPA), æ­£å¦‚ä¸Šå›¾æ‰€ç¤ºçš„ï¼ŒEPT åœ¨éå†é¡µè¡¨çš„æ—¶å€™ï¼Œé¦–å…ˆä» EPTP ä¸­è·å¾— EPT PM4L é¡µè¡¨çš„åŸºåœ°å€, ç„¶åå¼€å§‹éå† EPT é¡µè¡¨ã€‚è¿™é‡Œçš„ N ä»£è¡¨ Guest OS çš„ç‰©ç†åœ°å€å®½åº¦ï¼Œæ¯”å¦‚ Guest OS æ˜¯ 32 ä½ï¼Œé‚£ä¹ˆ N å°±æ˜¯ 32; åä¹‹ Guest OS æ˜¯ 64 ä½ï¼Œé‚£ä¹ˆ N å°±æ˜¯ 64. 

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000735.png)

N çš„å€¼å¯ä»¥é€šè¿‡å¾€ CPUID çš„ EAX å¯„å­˜å™¨å†™å…¥ 0x80000008H è·å¾—ï¼Œå½“å‘ CPUID å†™å…¥è¯¥å€¼ä¹‹åï¼ŒEAX çš„è¿”å›å€¼çš„ 7:0 ä½å°†è¡¨æ˜ Guest OS çš„ç‰©ç†åœ°å€å®½åº¦. 

-------------------------------

###### bit 6

EPTP çš„ bit 6 å¦‚æœç½®ä½ï¼Œé‚£ä¹ˆå°†ä½¿èƒ½ EPT çš„ "Accessed" å’Œ "Dirty" flags å±æ€§. ä½†æ˜¯ä¸æ˜¯æ‰€æœ‰çš„å¤„ç†å™¨éƒ½æ”¯æŒ EPT çš„ "accessed" å’Œ "dirty" flags, è½¯ä»¶å¯ä»¥é€šè¿‡è¯»å– IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨è·å¾—ç›¸å…³çš„ä¿¡æ¯å¹¶è®¾ç½®è¯¥ä½ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000736.png)

ä» IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit21 å¯ä»¥è·å¾—ç›¸å…³ä¿¡æ¯ï¼Œå½“æ”¹ä½ç½®ä½çš„æ—¶å€™ï¼ŒEPT æ”¯æŒ "accessed" å’Œ "dirty" flags å±æ€§. åŒç†ï¼ŒEPTP çš„ 2:0 å­—æ®µæŒ‡æ˜äº† EPT é¡µè¡¨çš„å†…å­˜ç±»å‹ï¼Œå½“è¯¥å­—æ®µçš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆ EPT é¡µè¡¨æ˜¯ "Uncacheable(UC)" çš„ï¼Œè€Œå½“è¯¥å­—æ®µçš„å€¼æ˜¯ 6, é‚£ä¹ˆ EPT é¡µè¡¨æ˜¯ "Write-back(WB)" çš„ï¼ŒåŒç†è½¯ä»¶åº”è¯¥é€šè¿‡è¯»å– IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨æ¥è®¾ç½®è¯¥å­—æ®µã€‚å¦‚ä¸Šå›¾ï¼ŒIA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit8 ä¸º 1ï¼Œé‚£ä¹ˆé€»è¾‘å¤„ç†å™¨å…è®¸å°† EPT é¡µè¡¨å†…å­˜ç±»å‹è®¾ç½®ä¸º "Uncacheable(UC)" ç±»å‹ï¼Œå³å°† EPTP çš„ bit 0:2 è®¾ç½®ä¸º 0; åŒç†å¦‚æœ IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit14 ä¸º 1ï¼Œé‚£ä¹ˆè½¯ä»¶å¯ä»¥å°† EPT é¡µè¡¨çš„å†…å­˜ç±»å‹è®¾ç½®ä¸º "Write-back(WB)", å³å°† EPTP çš„ bit 0:2 è®¾ç½®ä¸º 6.

--------------------------------

###### bit 5:3

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000737.png)

å¦‚æœ EPTP çš„ 5:3 å­—æ®µä¸º 1ï¼Œé‚£ä¹ˆè¡¨æ˜å½“å‰ EPT é¡µè¡¨çš„é•¿åº¦å°äº "EPT Page-walk" çš„é•¿åº¦ï¼Œ"EPT Page-walk" çš„é•¿åº¦æŒ‡çš„æ˜¯ EPT éå†é¡µè¡¨æœ€å¤šçº§æ•°ã€‚åœ¨æ”¯æŒ EPT 1Gig é¡µè¡¨æ˜ å°„è·å¾— EPT 2MiB é¡µè¡¨æ˜ å°„çš„æ—¶å€™ï¼ŒEPT éå†é¡µè¡¨çš„é•¿åº¦å°äº "EPT Page-walk" çš„é•¿åº¦ï¼Œå› æ­¤ EPTP çš„ 5:3 å­—æ®µä»ä¾§é¢æè¿°äº† EPT å­˜åœ¨é 4KiB é¡µè¡¨æ˜ å°„.

-------------------------------

###### bit 63:N - 11:7

EPTP çš„ 63:N å’Œ 11:7 å­—æ®µå‡ Reservedã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A4"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000I.jpg)

#### EPT PML4/PML4E

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000738.png)

EPT é¡µè¡¨æœºåˆ¶åªæ˜¯ç”¨ Guest OS ç‰©ç†åœ°å€(GPA) çš„ 47:0 å­—æ®µï¼ŒEPT åŒ…å«äº† 4 çº§é¡µè¡¨ï¼Œä¹Ÿå°±æ˜¯ Guest OS çš„ç‰©ç†åœ°å€(GPA) é€šè¿‡æœ€å¤š 4 çº§é¡µè¡¨å°±å¯ä»¥è·å¾—å¯¹åº”çš„ Host OS ç‰©ç†åœ°å€(HPA)ã€‚VCPU å°†è¿™ 48 bit çš„å­—æ®µåˆ†æˆå¤šä¸ªéƒ¨åˆ†è¿›è¡Œé¡µè¡¨çš„éå†ã€‚å…¶ä¸­ EPT é¡µè¡¨æœºåˆ¶çš„ç¬¬ä¸€çº§é¡µè¡¨ç§°ä¸º PML4 é¡µè¡¨ã€‚PML4 é¡µè¡¨æ˜¯ä¸€ä¸ª 4KiB å¯¹é½çš„ç‰©ç†é¡µï¼Œå…¶ä¸­æ¯ä¸ª VCPU çš„ VMCS "VM-execution control" åŸŸä¸­çš„ "The Extended-page-table pointer" (EPTP) 51:12 å­—æ®µåŒ…å«äº† PML4 é¡µè¡¨ç‰©ç†åœ°å€çš„. å› æ­¤ EPTP å°±æ‰§è¡Œäº† PML4 é¡µè¡¨.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000739.png)

æ­£å¦‚ä¸Šå›¾æ‰€è¿°ï¼ŒEPTP ä¸­åŒ…å«äº† PML4 é¡µè¡¨çš„ç‰©ç†åœ°å€ (HPA), VCPU å¯ä»¥é€šè¿‡ EPTP å¿«é€Ÿè·å¾— PML4 é¡µè¡¨çš„åŸºåœ°å€ï¼ŒPML4 é¡µè¡¨ä¸­åŒ…å«äº† 512 ä¸ª 64bit çš„å•å…ƒï¼Œè¿™äº›å•å…ƒç§°ä¸º PML4Es, æ¯ä¸ª PML4Es ä¸­åŒ…å«äº†ä¸‹ä¸€çº§é¡µè¡¨çš„ç‰©ç†åœ°å€ä»¥åŠä¸€äº› flags ç›¸å…³çš„ä¿¡æ¯ã€‚EPT åœ¨é¡µè¡¨éå†çš„æ—¶å€™ç»“åˆ EPTP å’Œ Guest OS çš„ç‰©ç†åœ°å€(GPA) è·å¾—ä¸€ä¸ª PML4Es, å…¶å¤„ç†é€»è¾‘æ˜¯: EPT MMU é¦–å…ˆä» EPTP ä¸­çš„ 51:12 å­—æ®µè·å¾— PML4 é¡µè¡¨çš„åŸºåœ°å€ï¼Œæ¥ç€ä» Guest OS ç‰©ç†åœ°å€(GPA) çš„ 47:39 å­—æ®µä½œä¸ºç´¢å¼•ï¼Œå¹¶å°† PML4 é¡µè¡¨ä½œä¸ºä¸€ä¸ª u64 æ•°ç»„è¿›è¡ŒæŸ¥æ‰¾ï¼Œå³å¯è·å¾—ä¸€ä¸ª PML4Es. ç”±äº EPT åªä½¿ç”¨äº† Guest OS ç‰©ç†åœ°å€(GPA) çš„ 47:39 å­—æ®µï¼Œå› æ­¤ä¸€ä¸ª PML4Es æŒ‡å‘äº†ä¸€ä¸ª 512Gig çš„èŒƒå›´ï¼Œé‚£ä¹ˆä¸€ä¸ª PML4 é¡µè¡¨è·å¾—ä¸€ä¸ª EPTP æŒ‡å‘çš„èŒƒå›´æ˜¯ "512 * 512 Gig", å³ 262144 Gig (256 TiB). å½“è·å¾—ä¸€ä¸ª PML4Es ä¹‹åï¼ŒEPT MMU å°†è§£æ PML4Es ä¸­çš„å†…å®¹ï¼Œä»¥æ­¤è·å¾—ä¸‹ä¸€çº§é¡µè¡¨çš„ä¿¡æ¯ã€‚PML4Es ä¸­çš„å¸ƒå±€å¦‚ä¸‹è¡¨:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000740.png)

æ¯ä¸ª PML4Es ä¸­çš„å¸ƒå±€å¦‚ä¸Šè¡¨ï¼Œå…¶åˆ†ä½œä¸¤ç«¯ï¼Œé«˜äº bit12 çš„åŒºåŸŸç”¨äºå¯»å€ä¸‹ä¸€çº§é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œä½ 12 bits åŒ…å«äº†å¤šä¸ªæ§åˆ¶ä¿¡æ¯ï¼Œç”¨äºæ§åˆ¶é¡µè¡¨çš„è®¿é—®æ§åˆ¶.

---------------------------------

###### bit 0/1

PML4Es çš„ bit0 å’Œ bit1 ç”¨äºæ§åˆ¶ PML4 å¯»å€çš„ 512Gig èŒƒå›´æ˜¯å¦å…·æœ‰è¯»æˆ–å†™æƒé™ï¼Œbit0 ä½ç”¨äºæ§åˆ¶è¯»æƒé™ï¼Œbit1 ä½ç”¨äºæ§åˆ¶å†™æƒé™. å¦‚æœå¯¹åº”çš„æ§åˆ¶ä½æ¸…é›¶ï¼Œé‚£ä¹ˆå¯¹åº”çš„ 512Gig èŒƒå›´å°†ä¸å…·æœ‰è¯»æˆ–å†™æƒé™. 

---------------------------------

###### bit8

PML4Es çš„ bit8 ç”¨äºæŒ‡æ˜å¯¹åº”çš„ 512Gig èŒƒå›´æ˜¯å¦å·²ç»è¢«è®¿é—®è¿‡ã€‚å¦‚æœè¯¥ä½ç½®ä½ï¼Œé‚£ä¹ˆå¯¹åº”çš„ 512 Gig èŒƒå›´å·²ç»è¢«è®¿é—®è¿‡ï¼Œå¦åˆ™ 512 Gig èŒƒå›´æ²¡æœ‰è®¿é—®è¿‡. ä½†å€¼å¾—æ³¨æ„çš„æ˜¯ PMLEs çš„ bit8 è¦èƒ½èµ·ä½œç”¨ï¼Œé‚£è¿˜ä¾èµ– EPTP çš„ bit6. EPTP çš„ bit 6 å¦‚æœç½®ä½ï¼Œé‚£ä¹ˆå°†ä½¿èƒ½ EPT çš„ â€œAccessedâ€ å’Œ â€œDirtyâ€ flags å±æ€§. ä½†æ˜¯ä¸æ˜¯æ‰€æœ‰çš„å¤„ç†å™¨éƒ½æ”¯æŒ EPT çš„ â€œaccessedâ€ å’Œ â€œdirtyâ€ flags, è½¯ä»¶å¯ä»¥é€šè¿‡è¯»å– IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨è·å¾—ç›¸å…³çš„ä¿¡æ¯å¹¶è®¾ç½®è¯¥ä½ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000736.png)

ä» IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit21 å¯ä»¥è·å¾—ç›¸å…³ä¿¡æ¯ï¼Œå½“æ”¹ä½ç½®ä½çš„æ—¶å€™ï¼ŒEPT æ”¯æŒ â€œaccessedâ€ å’Œ â€œdirtyâ€ flags å±æ€§. åŒç†ï¼ŒEPTP çš„ 2:0 å­—æ®µæŒ‡æ˜äº† EPT é¡µè¡¨çš„å†…å­˜ç±»å‹ï¼Œå½“è¯¥å­—æ®µçš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆ EPT é¡µè¡¨æ˜¯ â€œUncacheable(UC)â€ çš„ï¼Œè€Œå½“è¯¥å­—æ®µçš„å€¼æ˜¯ 6, é‚£ä¹ˆ EPT é¡µè¡¨æ˜¯ â€œWrite-back(WB)â€ çš„ï¼ŒåŒç†è½¯ä»¶åº”è¯¥é€šè¿‡è¯»å– IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨æ¥è®¾ç½®è¯¥å­—æ®µã€‚å¦‚ä¸Šå›¾ï¼ŒIA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit8 ä¸º 1ï¼Œé‚£ä¹ˆé€»è¾‘å¤„ç†å™¨å…è®¸å°† EPT é¡µè¡¨å†…å­˜ç±»å‹è®¾ç½®ä¸º â€œUncacheable(UC)â€ ç±»å‹ï¼Œå³å°† EPTP çš„ bit 0:2 è®¾ç½®ä¸º 0; åŒç†å¦‚æœ IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit14 ä¸º 1ï¼Œé‚£ä¹ˆè½¯ä»¶å¯ä»¥å°† EPT é¡µè¡¨çš„å†…å­˜ç±»å‹è®¾ç½®ä¸º â€œWrite-back(WB)â€, å³å°† EPTP çš„ bit 0:2 è®¾ç½®ä¸º 6.

-----------------------------------

###### bit (N-1):12

PML4Es çš„ "(N-1):12" å­—æ®µä¸­åŒ…å«äº† EPT Page-directory-pointer é¡µè¡¨æŒ‰ 4 KiB å¯¹é½çš„ç‰©ç†åœ°å€ã€‚è¿™é‡Œçš„ N ä»£è¡¨ Guest OS çš„ç‰©ç†åœ°å€å®½åº¦ï¼Œæ¯”å¦‚ Guest OS æ˜¯ 32 ä½ï¼Œé‚£ä¹ˆ N å°±æ˜¯ "32-12-1" å³ 19; åä¹‹ Guest OS æ˜¯ 64 ä½ï¼Œé‚£ä¹ˆ N å°±æ˜¯ "64-12-1" å³ 51.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000735.png)

N çš„å€¼å¯ä»¥é€šè¿‡å¾€ CPUID çš„ EAX å¯„å­˜å™¨å†™å…¥ 0x80000008H è·å¾—ï¼Œå½“å‘ CPUID å†™å…¥è¯¥å€¼ä¹‹åï¼ŒEAX çš„è¿”å›å€¼çš„ 7:0 ä½å°†è¡¨æ˜ Guest OS çš„ç‰©ç†åœ°å€å®½åº¦.

------------------------------------

###### Reserved

bit 7:3ã€51:N å¿…é¡»é¢„ç•™ä¸º 0ï¼Œè€Œ bit9ã€bit11 å’Œ 63:52 å¿½ç•¥.

------------------------------------

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A5"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000J.jpg)

#### EPT PDP/PDPTE

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000739.png)

EPT çš„ç¬¬äºŒçº§é¡µè¡¨ç§°ä¸º "EPT Page-Directory-Pointer Table", æ”¹é¡µè¡¨é€šè¿‡ PML4Es è·å¾—ï¼Œä»¥å…¶ä»–çº§ EPT é¡µè¡¨ä¸€æ ·ï¼ŒPDP é¡µè¡¨ç”±ä¸€ä¸ª 4 KiB å¯¹é½çš„ç‰©ç†é¡µæ„æˆï¼Œç‰©ç†é¡µè¢«åˆ†æˆ 512 ä¸ª 64bit çš„å•å…ƒï¼Œæ¯ä¸ªå•å…ƒç§°ä¸ºä¸€ä¸ª PDPTEs. PML4Es æŸ¥æ‰¾ PDT çš„é€»è¾‘å¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000741.png)

å½“ EPT MMU è·å¾— PML4Es ä¹‹åï¼ŒEPT MMU ä¼šä» PML4Es ä¸­è¯»å– 51:12 å­—æ®µï¼Œå¹¶å°†è¯¥å­—æ®µä½œä¸ºä¸€ä¸ªæŒ‰ 4 KiB å¯¹é½ç‰©ç†é¡µçš„ 51:12 å­—æ®µï¼Œé‚£ä¹ˆè¿™ä¸ªç‰©ç†é¡µå°±æ˜¯ä¸€ä¸ª PDP é¡µè¡¨ã€‚EPT MMU ç»§ç»­å°† Guest OS ç‰©ç†åœ°å€(GPA) çš„ 38:30 å­—æ®µä½œä¸ºç´¢å¼•ï¼Œè€Œ PDP é¡µè¡¨ä¸ºä¸ºä¸€ä¸ª u64 æ•°ç»„è¿›è¡ŒæŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾åˆ°çš„åœ°å€å°±æ˜¯ä¸€ä¸ª PDPTEs. PDPTEs ç”¨äºæŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨æˆ–è€…ä¸€å—è¿ç»­çš„ 1 Gig ç‰©ç†å†…å­˜ç©ºé—´ã€‚PDPTE ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯åœ°å€ç´¢å¼•ï¼Œå¦å¤–ä¸€éƒ¨åˆ†åˆ™æ˜¯æ§åˆ¶åŸŸã€‚ç”±äº PTEP æ˜¯é€šè¿‡ Guest OS ç‰©ç†åœ°å€(GPA) çš„ 38:30 å­—æ®µç´¢å¼•è·å¾—ï¼Œå› æ­¤ä¸€ä¸ª PDPTE å¯å¯»å€èŒƒå›´å°±æ˜¯ 1 Gigã€‚EPT æ”¯æŒ 1 Gig é¡µè¡¨æ˜ å°„ï¼Œä¹Ÿæ”¯æŒ 2 MiB æˆ–è€… 4 KiB çš„é¡µè¡¨æ˜ å°„ï¼Œå› æ­¤ PDPE é¡µè¡¨çš„æ§åˆ¶åŸŸå¯ä»¥æŒ‡æ˜é¡µè¡¨çš„æ˜ å°„èŒƒå›´ã€‚PTEP æ˜ å°„çš„èŒƒå›´ä¸åŒï¼Œå…¶å¸ƒå±€ä¹Ÿä¸ç›¸åŒï¼Œè¿™é‡Œåˆ†å¼€è¿›è¡Œè®²è§£.

> [> PDPTE mapping 1 Gib](#A501)
>
> [> PDPTE to Page Directory Table](#A502)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------

##### <span id="A501">PDPTE Mapping 1 Gig</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000742.png)

EPT 1 Gig é¡µè¡¨æ˜ å°„æŒ‡çš„æ˜¯ Guest OS ä¸­çš„ç‰©ç†åœ°å€å°† 1 Gig çš„ç‰©ç†é¡µæ˜ å°„åˆ° Host OS ä¸­ 1 Gig çš„ç‰©ç†é¡µä¸Šï¼Œè¦åšåˆ° 1 Gig çš„ç‰©ç†é¡µæ˜ å°„éœ€è¦ç¡®ä¿ Guest OS å¯¹åº”çš„ç‰©ç†å†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€æŒ‰ 1 Gig å¯¹é½ï¼Œå¹¶ä¸” Host OS ä¸­çš„ç‰©ç†é¡µæ˜¯æŒ‰ 1 Gig å°†å¯¹åº”çš„è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ä¸Šã€‚å¦‚ä¸Šå›¾æ‰€è¿°ï¼Œå½“é€šè¿‡ PML4Es å’Œ Guest OS ç‰©ç†åœ°å€çš„ 38:30 å­—æ®µè·å¾—ä¸€ä¸ª PDPTEs ä¹‹åï¼ŒEPT MMU å°†ä¸å†ç»§ç»­æŸ¥è¯¢é¡µè¡¨ï¼Œè€Œæ˜¯å°†ä¸‹å›¾è¿›è¡Œå¤„ç†:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000743.png)

EPT MMU é¦–å…ˆç¡®è®¤ PDPTE çš„ bit7 ç½®ä½ï¼Œåœ¨ç½®ä½çš„æƒ…å†µä¸‹ï¼ŒPDPTE æ˜ å°„ 1 Gig çš„ç‰©ç†å†…å­˜ï¼Œæ­¤æ—¶å°† PDPTEs çš„ bits 51:30 å’Œ Guest OS ç‰©ç†åœ°å€(GPA) çš„ bits 29:0 ç»„æˆä¸€ä¸ª Host OS çš„ç‰©ç†åœ°å€(HPA), è¯¥ç‰©ç†åœ°å€å°±æ˜¯æœ€ç»ˆçš„ç‰©ç†åœ°å€. ä½†ä¸æ˜¯æ‰€æœ‰çš„å¤„ç†å™¨éƒ½æ”¯æŒ 1 Gig EPT æ˜ å°„ï¼Œå› æ­¤åœ¨è¿›è¡Œ 1 Gig æ˜ å°„ä¹‹å‰éœ€è¦ä» IA32_VMX_EPT_VPID_CAP å¯„å­˜å™¨ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œå·²ç¡®è®¤ EPT é¡µè¡¨æ”¯æŒ 1 Gig é¡µè¡¨æ˜ å°„ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000736.png) 

æ­£å¦‚ä¸Šè¡¨æ‰€ç¤ºï¼Œå¦‚æœ IA32_VMX_EPT_VPID_CAP çš„ bit17 ç½®ä½ï¼Œé‚£ä¹ˆ EPT é¡µè¡¨æ”¯æŒ 1 Gib é¡µè¡¨æ˜ å°„; åä¹‹ EPT ä¸æ”¯æŒ 1 Gig é¡µè¡¨æ˜ å°„ã€‚å½“ PDPTEs æ˜ å°„ 1 Gig ç‰©ç†å†…å­˜æ˜¯ï¼ŒPDPTEs çš„å†…éƒ¨æ•°æ®å¸ƒå±€å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000744.png)

###### bit 7

PDPTE çš„ bit 7 å¿…é¡»ç½®ä½ï¼Œè¿™æ ·æ‰è¡¨æ˜ PDPTE æŒ‰ 1 Gig ç‰©ç†é¡µè¿›è¡Œæ˜ å°„.

---------------------------------------

###### bit 0/1

PDPTE çš„ bit 0/1 ç”¨äºæ§åˆ¶ 1 Gig èŒƒå›´çš„è¯»å†™æƒé™ã€‚å½“ bit 0 ç½®ä½çš„æ—¶å€™ï¼Œ1 Gig çš„èŒƒå›´å…·æœ‰è¯»æƒé™; åä¹‹ bit 0 æ¸…é›¶çš„æ—¶å€™ï¼Œ1 Gig çš„èŒƒå›´æ²¡æœ‰è¯»æƒé™. å½“ bit 1 ç½®ä½çš„æ—¶å€™ï¼Œ1 Gig çš„èŒƒå›´å…·æœ‰å†™æƒé™; åä¹‹ bit 1 æ¸…é›¶çš„æ—¶å€™ï¼Œ1 Gig çš„èŒƒå›´æ²¡æœ‰å†™æƒé™.

------------------------------------

###### bit 8/9 

PDPTE çš„ bit 8/9 ç”¨äºæŒ‡æ˜ 1 Gig èŒƒå›´çš„ "accessed" å’Œ "dirty" æ ‡å¿—ã€‚å½“ bit 8 ç½®ä½ï¼Œé‚£ä¹ˆè¡¨æ˜è½¯ä»¶å·²ç»è®¿é—®è¿‡è¿™æ®µ 1 Gig çš„ç‰©ç†å†…å­˜; åä¹‹ bit 8 æ¸…é›¶ï¼Œé‚£ä¹ˆè¡¨æ˜è½¯ä»¶æœªè®¿é—®è¿‡è¿™æ®µ 1 Gig çš„ç‰©ç†å†…å­˜ã€‚å½“ bit 9 ç½®ä½ï¼Œé‚£ä¹ˆè¡¨æ˜è½¯ä»¶å·²ç»å‘ 1 Gig çš„ç‰©ç†å†…å­˜ç©ºé—´å†™å…¥è¿‡æ•°æ®; åä¹‹å½“ bit 9 æ¸…é›¶ï¼Œé‚£ä¹ˆè¡¨æ˜è½¯ä»¶æœªå‘è¿™æ®µ 1 Gig ç‰©ç†å†…å­˜å†™å…¥è¿‡æ•°æ®ã€‚bit 8/9 çš„å¯ç”¨ä¸ EPTP çš„ bit 6 æœ‰å…³. EPTP çš„ bit 6 å¦‚æœç½®ä½ï¼Œé‚£ä¹ˆå°†ä½¿èƒ½ EPT çš„ â€œAccessedâ€ å’Œ â€œDirtyâ€ flags å±æ€§. ä½†æ˜¯ä¸æ˜¯æ‰€æœ‰çš„å¤„ç†å™¨éƒ½æ”¯æŒ EPT çš„ â€œaccessedâ€ å’Œ â€œdirtyâ€ flags, è½¯ä»¶å¯ä»¥é€šè¿‡è¯»å– IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨è·å¾—ç›¸å…³çš„ä¿¡æ¯å¹¶è®¾ç½®è¯¥ä½ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000736.png)

ä» IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit21 å¯ä»¥è·å¾—ç›¸å…³ä¿¡æ¯ï¼Œå½“æ”¹ä½ç½®ä½çš„æ—¶å€™ï¼Œ
EPT æ”¯æŒ â€œaccessedâ€ å’Œ â€œdirtyâ€ flags å±æ€§. åŒç†ï¼ŒEPTP çš„ 2:0 å­—æ®µæŒ‡æ˜äº† EPT é¡µè¡¨çš„å†…å­˜ç±»å‹ï¼Œå½“è¯¥å­—æ®µçš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆ EPT é¡µè¡¨æ˜¯ â€œUncacheable(UC)â€ çš„ï¼Œè€Œå½“è¯¥å­—æ®µçš„å€¼æ˜¯ 6, é‚£ä¹ˆ EPT é¡µè¡¨æ˜¯ â€œWrite-back(WB)â€ çš„ï¼ŒåŒç†è½¯ä»¶åº”è¯¥é€šè¿‡è¯»å– IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨æ¥è®¾ç½®è¯¥å­—æ®µã€‚å¦‚ä¸Šå›¾ï¼ŒIA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit8 ä¸º 1ï¼Œé‚£ä¹ˆé€»è¾‘å¤„ç†å™¨å…è®¸å°† EPT é¡µè¡¨å†…å­˜ç±»å‹è®¾ç½®ä¸º â€œUncacheable(UC)â€ ç±»å‹ï¼Œå³å°† EPTP çš„ bit 0:2 è®¾ç½®ä¸º 0; åŒç†å¦‚æœ IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit14 ä¸º 1ï¼Œé‚£ä¹ˆè½¯ä»¶å¯ä»¥å°† EPT é¡µè¡¨çš„å†…å­˜ç±»å‹è®¾ç½®ä¸º â€œWrite-back(WB)â€, å³å°† EPTP çš„ bit 0:2 è®¾ç½®ä¸º 6.

-----------------------------

###### bit (N-1):30

PDPTE çš„ (N-1):30 å­—æ®µç”¨äºæŒ‡å‘ä¸€ä¸ªæŒ‰ 1 Gig å¯¹é½çš„ç‰©ç†åœ°å€ï¼Œè¿™å—ç‰©ç†å†…å­˜å³æ˜¯ Guest OS ç‰©ç†åœ°å€æ‰€æ˜ å°„çš„çš„ç‰©ç†å†…å­˜ï¼Œæ¥ä¸‹æ¥ EPT MMU å°†è¿™ä¸ªç‰©ç†åœ°å€ä¸ Guest OS çš„ç‰©ç†åœ°å€ 29:0 å­—æ®µä¸€å…±ç»„æˆä¸€ä¸ªæ–°çš„ç‰©ç†åœ°å€ï¼Œè¿™ä¸ªç‰©ç†åœ°å€å³æ˜¯ Guest OS çš„ç‰©ç†åœ°å€æ˜ å°„çš„ Host OS çš„ç‰©ç†åœ°å€.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

#### <span id="A502">PDPTE to Page Directory Table</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000739.png)

å½“ EPT PDPTE æ²¡æœ‰æ˜ å°„ 1 Gig çš„ç‰©ç†å†…å­˜ï¼Œé‚£ä¹ˆ EPT MMU å°†ä» PDPTE ä¸­è·å¾—ä¸‹ä¸€çº§é¡µè¡¨ Page Directory Table çš„ç‰©ç†é¡µçš„èµ·å§‹åœ°å€. DPDTE è¦ä½¿ç”¨ä¸‹ä¸€çº§é¡µè¡¨ï¼Œé‚£ä¹ˆéœ€è¦æ»¡è¶³ä¸€ä¸‹å‡ ä¸ªæ¡ä»¶ï¼ŒGuest OS ç‰©ç†åœ°å€å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸æŒ‰ 1 Gig ç‰©ç†åœ°å€å¯¹é½ï¼Œå¹¶ä¸” Host OS ç«¯çš„ç‰©ç†åœ°å€ä¹Ÿä¸æ˜¯æŒ‰ 1 Gig ç‰©ç†åœ°å€å¯¹é½ï¼Œåœ¨æ»¡è¶³ä»¥ä¸Šä»»ä¸€æ¡ä»¶ä¹‹åï¼Œé‚£ä¹ˆ PDPTE å°†æŒ‡å‘ EPT Page Directory Table. åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒPDPTE é¡µè¡¨çš„éå†é€»è¾‘æ˜¯: EPT MMU ä» PML4Es ä¸­è·å– 51:12 å­—æ®µä½œä¸º PDP é¡µè¡¨çš„ 51:12 å­—æ®µå€¼ï¼Œç„¶åå°† Guest OS ç‰©ç†åœ°å€(GPA) çš„ 38:30 å­—æ®µä½œä¸ºç´¢å¼•ï¼Œå¹¶å°† PDP é¡µè¡¨ä½œä¸ºä¸€ä¸ª u64 æ•°ç»„è¿›è¡ŒæŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾åˆ°çš„ç»“æœå³æ˜¯ä¸€ä¸ª PDPTEã€‚æ­¤æ—¶ PDPTEs çš„å¸ƒå±€å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000745.png) 

###### bit 7

PDPTE çš„ bit 7 å¿…é¡»æ¸…é›¶ï¼Œè¿™æ ·æ‰è¡¨æ˜ PDPTE ä¸æ˜¯æŒ‰ 1 Gig ç‰©ç†é¡µè¿›è¡Œæ˜ å°„.

---------------------------------------

###### bit 0/1

PDPTE çš„ bit 0/1 ç”¨äºæ§åˆ¶ 1 Gig èŒƒå›´çš„è¯»å†™æƒé™ã€‚å½“ bit 0 ç½®ä½çš„æ—¶å€™ï¼Œ1 Gig çš„èŒƒ>å›´å…·æœ‰è¯»æƒé™; åä¹‹ bit 0 æ¸…é›¶çš„æ—¶å€™ï¼Œ1 Gig çš„èŒƒå›´æ²¡æœ‰è¯»æƒé™. å½“ bit 1 ç½®ä½çš„æ—¶å€™
ï¼Œ1 Gig çš„èŒƒå›´å…·æœ‰å†™æƒé™; åä¹‹ bit 1 æ¸…é›¶çš„æ—¶å€™ï¼Œ1 Gig çš„èŒƒå›´æ²¡æœ‰å†™æƒé™.

---------------------------------------

###### bit 8

PDPTE çš„ bit 8 ç”¨äºæŒ‡æ˜ 1 Gig èŒƒå›´çš„ "accessed" æ ‡å¿—ã€‚å½“ bit 8 ç½®ä½ï¼Œé‚£ä¹ˆè¡¨æ˜è½¯ä»¶å·²ç»è®¿é—®è¿‡è¿™æ®µ 1 Gig çš„ç‰©ç†å†…å­˜; åä¹‹ bit 8 æ¸…é›¶ï¼Œé‚£ä¹ˆè¡¨æ˜è½¯ä»¶æœªè®¿é—®è¿‡è¿™æ®µ 1 Gig çš„ç‰©ç†å†…å­˜ã€‚bit 8 çš„å¯ç”¨ä¸ EPTP çš„ bit 6 æœ‰å…³. EPTP çš„ bit 6 å¦‚æœç½®ä½ï¼Œé‚£ä¹ˆå°†ä½¿èƒ½ EPT çš„ â€œAccessedâ€ å’Œ â€œDirtyâ€ flags å±æ€§. ä½†æ˜¯ä¸æ˜¯æ‰€æœ‰çš„å¤„ç†å™¨éƒ½æ”¯æŒ EPT çš„ â€œaccessedâ€ å’Œ â€œdirtyâ€ flags, è½¯ä»¶å¯ä»¥é€šè¿‡è¯»å– IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨è·å¾—ç›¸å…³çš„ä¿¡æ¯>å¹¶è®¾ç½®è¯¥ä½ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000736.png)

ä» IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit21 å¯ä»¥è·å¾—ç›¸å…³ä¿¡æ¯ï¼Œå½“æ”¹ä½ç½®ä½çš„æ—¶å€™ï¼Œ
EPT æ”¯æŒ â€œaccessedâ€ å’Œ â€œdirtyâ€ flags å±æ€§. åŒç†ï¼ŒEPTP çš„ 2:0 å­—æ®µæŒ‡æ˜äº† EPT é¡µè¡¨
çš„å†…å­˜ç±»å‹ï¼Œå½“è¯¥å­—æ®µçš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆ EPT é¡µè¡¨æ˜¯ â€œUncacheable(UC)â€ çš„ï¼Œè€Œå½“è¯¥å­—æ®µçš„
å€¼æ˜¯ 6, é‚£ä¹ˆ EPT é¡µè¡¨æ˜¯ â€œWrite-back(WB)â€ çš„ï¼ŒåŒç†è½¯ä»¶åº”è¯¥é€šè¿‡è¯»å– IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨æ¥è®¾ç½®è¯¥å­—æ®µã€‚å¦‚ä¸Šå›¾ï¼ŒIA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit8 ä¸º 1ï¼Œé‚£ä¹ˆé€»è¾‘å¤„ç†å™¨å…è®¸å°† EPT é¡µè¡¨å†…å­˜ç±»å‹è®¾ç½®ä¸º â€œUncacheable(UC)â€ ç±»å‹ï¼Œå³å°† EPTP çš„ bit 0:2 è®¾ç½®ä¸º 0; åŒç†å¦‚æœ IA32_VMX_EPT_VPID_CAP MSR å¯„å­˜å™¨çš„ bit14 ä¸º 1>ï¼Œé‚£ä¹ˆè½¯ä»¶å¯ä»¥å°† EPT é¡µè¡¨çš„å†…å­˜ç±»å‹è®¾ç½®ä¸º â€œWrite-back(WB)â€, å³å°† EPTP çš„ bit 0:2 è®¾ç½®ä¸º 6.

--------------------------------------

###### bit (N-1):12

PDPTE çš„ (N-1):12 å­—æ®µç”¨äºæŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨ EPT Page Directory Table é¡µè¡¨æŒ‰ 4 Kib å¯¹é½çš„ç‰©ç†åœ°å€. è¿™é‡Œçš„ N ä»£è¡¨ Guest OS çš„ç‰©ç†åœ°å€å®½åº¦ï¼Œæ¯”å¦‚ Guest OS æ˜¯ 32 ä½ï¼Œé‚£ä¹ˆ N å°±æ˜¯ â€œ32-12-1â€ å³ 19; åä¹‹ Guest OS æ˜¯ 64 ä½ï¼Œé‚£ä¹ˆ N å°±æ˜¯ â€œ64-12-1â€ å³ 51.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000735.png)

N çš„å€¼å¯ä»¥é€šè¿‡å¾€ CPUID çš„ EAX å¯„å­˜å™¨å†™å…¥ 0x80000008H è·å¾—ï¼Œå½“å‘ CPUID å†™å…¥è¯¥å€¼ä¹‹åï¼ŒEAX çš„è¿”å›å€¼çš„ 7:0 ä½å°†è¡¨æ˜ Guest OS çš„ç‰©ç†åœ°å€å®½åº¦

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="A2"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000K.jpg)

#### EPT åŠŸèƒ½å¼€å¯

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000653.png)

Guest OS çš„ç‰©ç†åœ°å€(GPA) åˆ° Host ç‰©ç†åœ°å€(HPA) çš„è½¬æ¢é€šè¿‡ä¸€ç³»åˆ—çš„ EPT é¡µè¡¨ã€‚EPT é¡µè¡¨ç»“æ„æœ‰ç‚¹ç±»ä¼¼ä¸ IA-32e æ¨¡å¼ä¸‹çš„çº¿æ€§åœ°å€é¡µè¡¨è½¬æ¢ã€‚ç³»ç»Ÿè¦ä½¿ç”¨ EPT é¡µè¡¨é¦–å…ˆè¦ç¡®è®¤å½“å‰ç³»ç»Ÿæ”¯æŒ EPT åŠŸèƒ½ã€‚EPT åŠŸèƒ½çš„å¯ç”¨ä¸ VMCS çš„ "The Processor-Based VM-Execution Controls" å’Œ "The Secondary Processor-Based VM-Execution Controls" æ§åˆ¶åŸŸæœ‰å…³ã€‚å½“ "The Processor-Based VM-Execution Controls" æ§åˆ¶åŸŸçš„ 31 bit ç½®ä½ï¼Œé‚£ä¹ˆå½“å‰ç³»ç»Ÿæ”¯æŒ "The Secondary Processor-Based VM-Execution Controls" æ§åˆ¶åŸŸã€‚åœ¨ "The Secondary Processor-Based VM-Execution Controls" æ§åˆ¶åŸŸçš„ bit1 ä¸­åŒ…å«äº† "Enable EPT"ï¼Œå½“è¯¥ä½ç½®ä½ï¼Œé‚£ä¹ˆç³»ç»Ÿæ”¯æŒ EPT, å¦åˆ™ä¸æ”¯æŒ EPT. å…·ä½“è¯·å‚è€ƒ:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000708.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000710.png)

é€šè¿‡ä»¥ä¸Šä¸¤ä¸ªæ§åˆ¶åŸŸå°±å¯ä»¥çŸ¥é“ EPT åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œä½†å¯¹äºä¸¤ä¸ªæ§åˆ¶åŸŸå†…çš„æ‰€æœ‰ bit ç½®ä½å’Œæ¸…é›¶çš„æƒ…å†µï¼Œåˆ™éœ€è¦é€šè¿‡ç›¸åº”çš„ MSR å¯„å­˜å™¨è·å¾—. è¿™é‡Œè¿˜æ¶‰åŠäº† VMCS çš„æ¦‚å¿µï¼Œå¯¹äºæ¯ä¸ªé€»è¾‘å¤„ç†å™¨è€Œè¨€ï¼ŒVMX éƒ½ä¼šä½¿ç”¨ "Virtual-machine control data struct(VMCSs)" å»æ§åˆ¶ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨çš„ VM-Entry å’Œ VM-Exitï¼Œä»¥åŠé€»è¾‘å¤„ç†å™¨åœ¨ non-root æ¨¡å¼ä¸‹çš„ä¸€äº›æ“ä½œ, å¯ä»¥ç®€å•çš„ç†è§£ä¸º VMCS ä¸ºé€»è¾‘å¤„ç†å™¨çš„ä¸Šä¸‹æ–‡ã€‚VMCS å­˜å‚¨åœ¨å†…å­˜çš„ä¸€å—åŒºåŸŸä¸Šï¼Œè¿™å—åŒºåŸŸç§°ä¸º "VMCS region", è½¯ä»¶å¯ä»¥é€šè¿‡ä½¿ç”¨ä¸€ä¸ª 64 ä½çš„ VMCS æŒ‡é’ˆå¼•ç”¨ VMCSã€‚å›åˆ° EPT è¯é¢˜ï¼ŒEPT çš„å¼€å¯ä¸ "The Processor-Based VM-Execution Controls" æ§åˆ¶åŸŸå’Œ "The Secondary Processor-Based VM-Execution Controls" æ§åˆ¶åŸŸæœ‰å…³ï¼Œè¿™ä¸¤ä¸ªæ§åˆ¶åŸŸæ­£å¥½æ˜¯ VMCS ä¸­çš„ä¸€éƒ¨åˆ†, å…¶ä¸­ "The Processor-Based VM-Execution Control" æ§åˆ¶åŸŸçš„å†…å®¹ä¸ä»¥ä¸‹æ§åˆ¶åŸŸæœ‰å…³:

* IA32_VMX_BASIC(index 480H) å¯„å­˜å™¨
* IA32_VMX_PROCBASED_CTLS MSR(index 482H) å¯„å­˜å™¨
* IA32_VMX_TRUE_PROCBASED_CTLS MSR(index 48EH) å¯„å­˜å™¨

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000713.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000716.png)

ä¸Šé¢é€»è¾‘å¯ä»¥ç®€å•ç†è§£ä¸ºå½“ IA32_VMX_BASIC çš„ bit55 å†³å®šäº†ç³»ç»Ÿæ˜¯ä½¿ç”¨ IA32_VMX_PROCBASED_CTLS MSR å¯„å­˜å™¨è¿˜æ˜¯ IA32_VMX_TRUE_PROCBASED_CTLS MSR å¯„å­˜å™¨ä½œä¸º "The Primary Processor-Based VM-Execution Controls" åŸŸçš„å†…å®¹æ¥æºã€‚å½“é€‰å®šä¸€ä¸ªå¯„å­˜å™¨ä½œä¸ºåŸŸå€¼æ¥æºä¹‹å, å¯„å­˜å™¨çš„ 31:0 æŒ‡æ˜å…è®¸è®¾ç½®ä¸º 0-setting çš„ä½ï¼Œåœ¨è®¾ç½®ä¸º 0-setting çš„ä½å¦‚æœå½“è™šæ‹Ÿæœº VM-Entry æ—¶å‘ç°ä¸º 1ï¼Œé‚£ä¹ˆ VM-Entry åˆ™å¤±è´¥; åŒç† 63:32 æŒ‡æ˜å…è®¸è®¾ç½®ä¸º 1-setting çš„ä½ï¼Œåœ¨è®¾ç½®ä¸º 1-setting çš„ä½å¦‚æœå½“è™šæ‹Ÿæœº VM-Entry æ—¶å‘ç°ä¸º 0ï¼Œé‚£ä¹ˆ VM-Entry åˆ™å¤±è´¥. åŒç†å¯¹äº "The Secondary Processor-Based VM-Execution Controls" æ§åˆ¶åŸŸï¼Œå…¶å®šä¹‰å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000714.png)

é€šè¿‡ä¸Šé¢çš„ä»‹ç»å¯ä»¥çŸ¥é“ï¼Œ"The Secondary Processor-Based VM-Execution Controls" æ§åˆ¶åŸŸçš„å†…å®¹æ¥è‡ª IA32_VMX_PROCBASED_CTLS2 MSR(index 48BH). å¯„å­˜å™¨çš„ 31:0 æŒ‡æ˜å…è®¸è®¾ç½®ä¸º 0-setting çš„ä½ï¼Œåœ¨è®¾ç½®ä¸º 0-setting çš„ä½å¦‚æœå½“è™šæ‹Ÿæœº VM-Entry æ—¶å‘ç°ä¸º 1ï¼Œé‚£ä¹ˆ VM-Entry åˆ™å¤±è´¥; åŒç† 63:32 æŒ‡æ˜å…è®¸è®¾ç½®ä¸º 1-setting çš„ä½ï¼Œåœ¨è®¾ç½®ä¸º 1-setting çš„ä½å¦‚æœå½“è™šæ‹Ÿæœº VM-Entry æ—¶å‘ç°ä¸º 0ï¼Œé‚£ä¹ˆ VM-Entry åˆ™å¤±è´¥. åˆ†æå®Œ Intel æ–‡æ¡£å¯¹ EPT å¯ç”¨çš„ä»‹ç»ï¼Œä¸‹é¢æ¥çœ‹çœ‹å†…æ ¸ä¸­å¯¹ EPT å¯ç”¨çš„å¤„ç†é€»è¾‘ï¼Œå…¶é€»è¾‘å¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000711.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œå½“ KVM è¿›è¡Œ Intel Architecture ç›¸å…³çš„ hardware_setup() å‡½æ•°æ—¶ï¼ŒKVM é¦–å…ˆåœ¨å‡½æ•° setup_vmcs_config() ä¸­å¯¹ "The Primary Processor-Based VM-Execution Controls" å’Œ "The Secondary Processor-Based VM-Execution" æ§åˆ¶åŸŸåšäº†æ£€æµ‹ï¼Œæ£€æµ‹é€»è¾‘å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000717.png)

å‡½æ•°é€šè¿‡è°ƒç”¨ adjust_vmx_controls() å‡½æ•°å¯¹ MSR_IA32_VMX_PROCBASED_CTLS å¯„å­˜å™¨è¿›è¡Œèƒ½åŠ›æ£€æµ‹ï¼Œä¹Ÿå°±æ˜¯ç¡®è®¤ MSR_IA32_VMX_PROCBASED_CTLS å¯„å­˜å™¨æŸäº›åŠŸèƒ½å¿…é¡»å¼€å¯ï¼Œä»¥åŠæŸäº›åŠŸèƒ½å¯ä»¥å¼€å¯ï¼Œå…¶ä¸­ä¸ EPT ç›¸å…³çš„åŠŸèƒ½æ˜¯ CPU_BASED_ACTIVATE_SECONDARY_CONTROLSï¼Œä½†åœ¨ä¸Šé¢çš„å‡½æ•°å¤„ç†é€»è¾‘ä¸­ï¼Œè¯¥åŠŸèƒ½åªæ˜¯ä½œä¸ºå¯é€‰åŠŸèƒ½è¿›è¡Œæ£€æµ‹(ç”±äºä»£ç å…¼å®¹å½±å­é¡µè¡¨ï¼Œå› æ­¤è¿™é‡Œå¯¹ CPU_BASED_ACTIVATE_SECONDARY_CONTROLS çš„åŠŸèƒ½ä¸èƒ½å¼ºåˆ¶æ‰“å¼€ï¼Œåªèƒ½ç¡®è®¤å¼€å¯)ã€‚åœ¨æ£€æµ‹å®Œæ¯•ä¹‹åï¼Œå‡½æ•°ä¼šå°† MSR_IA32_VMX_PROCBASED_CTLS å¯„å­˜å™¨æ”¯æŒçš„åŠŸèƒ½å­˜å‚¨åœ¨ "\_cpu_based_exec_control" å˜é‡é‡Œã€‚å¦‚æœ CPU_BASED_ACTIVATE_SECONDARY_CONTROL å¯¹åº”çš„ä½ç½®ä½ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æ˜¯å¯¹ "MSR_IA32_VMX_PROCBASED_CTLS2" å¯„å­˜å™¨çš„åŠŸèƒ½è¿›è¡Œæ£€æµ‹ï¼Œæ£€æµ‹é€»è¾‘å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000718.png)

åœ¨ä¸Šé¢çš„æ£€æµ‹é€»è¾‘ä¸­ï¼Œå¼€å‘è€…é‡ç‚¹å…³æ³¨ SECONDARY_EXEC_ENABLE_EPT åŠŸèƒ½æ˜¯å¦å¯ç”¨ï¼Œå‡½æ•°å°†æ£€æµ‹çš„ç»“æœå­˜å‚¨åœ¨ "\_cpu_based_2nd_exec_control" å˜é‡é‡Œï¼Œè¿™é‡Œä¹Ÿç¬¦åˆæ–‡æ¡£ä¸­å¯¹ EPT åŠŸèƒ½çš„æ£€æµ‹ã€‚ä»¥ä¸Šç»“æœæœ€ç»ˆå­˜å‚¨åˆ°äº† vmcs_config ç»“æ„é‡Œï¼ŒKVM å°±å¯ä»¥é€šè¿‡ç›´æ¥è¯»å–é‡Œé¢çš„ä¿¡æ¯æ¥ç¡®è®¤ EPT æ˜¯å¦å¼€å¯ï¼Œå¦‚ä¸‹å›¾çš„å‡½æ•°:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000712.png)

å†…æ ¸åœ¨æºç ä¸­ç›´æ¥é€šè¿‡è°ƒç”¨ cpu_has_vmx_ept() å‡½æ•°æ£€æµ‹å½“å‰ç³»ç»Ÿæ˜¯å¦æ”¯æŒ EPT é¡µè¡¨åŠŸèƒ½.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="A02">CR0</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000706.png)

CR0 å¯„å­˜å™¨åŒ…å«äº†ç³»ç»Ÿæ§åˆ¶æ ‡å¿—å’Œå¤„ç†å™¨çŠ¶æ€æ ‡å¿—ã€‚è¿™äº›æ§åˆ¶ä½æ§åˆ¶ç³»ç»Ÿæ¨¡å¼ã€‚

> [> CR0.PG](#A0200)
>
> [> CR0.PE](#A0201)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------

##### <span id="A0200">CR0.PG</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000706.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000722.png)

CR0.PG ä½ç”¨äºè®¾ç½®å¤„ç†å™¨æ”¯æŒåˆ†é¡µçš„åŠŸèƒ½ã€‚å¦‚æœè¯¥ä½æ¸…é›¶ï¼Œé‚£ä¹ˆç³»ç»Ÿä¸æ”¯æŒåˆ†é¡µï¼Œå½“ä¸æ”¯æŒåˆ†é¡µï¼Œæ‰€æœ‰çš„çº¿æ€§åœ°å€éƒ½æ˜¯ç‰©ç†åœ°å€ã€‚åˆ†é¡µåŠŸèƒ½ä¸ä¿æŠ¤æ¨¡å¼éœ€è¦ä¸€åŒå­˜åœ¨ï¼Œä¿æŠ¤æ¨¡å¼é€šè¿‡ CR0.PE ä½è¿›è¡Œä½¿èƒ½ï¼Œå¦‚æœ CR0.PE æ²¡æœ‰ç½®ä½ï¼Œå³ä¿æŠ¤æ¨¡å¼æ²¡æœ‰æ‰“å¼€ï¼Œå¦‚æœæ­¤æ—¶å°† CR0.PG ç½®ä½ï¼Œé‚£ä¹ˆä¼šå¼•èµ· "#GP" å¼‚å¸¸ã€‚CR0.PG çš„æ”¹å˜ä¸ä¼šå½±å“ CR0.PE çš„æ”¹å˜ã€‚

> [Intel SDM(Software Developer's Manual) Download](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------------------

##### <span id="A0201">CR0.PE</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000706.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000723.png)

CR0.PE ä½ç”¨äºæ§åˆ¶ç³»ç»Ÿä¿æŠ¤æ¨¡å¼çš„ä½¿èƒ½ã€‚å½“ CR0.PE ç½®ä½ï¼Œå¹¶ä¸” CR0.PG ç½®ä½ï¼Œé‚£ä¹ˆç³»ç»Ÿè¿›è¡Œä¿æŠ¤æ¨¡å¼ï¼Œä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œçº¿æ€§åœ°å€ç§°ä¸ºè™šæ‹Ÿåœ°å€ï¼Œè™šæ‹Ÿåœ°å€éœ€è¦é€šè¿‡éå†é¡µè¡¨æ‰èƒ½æŸ¥æ‰¾åˆ°æŒ‡å®šçš„ç‰©ç†åœ°å€ï¼Œè¿›è€Œè®¿é—®å†…å­˜; å½“ CR0.PE æ¸…é›¶ï¼Œä¸” CR0.PG æ¸…é›¶ï¼Œé‚£ä¹ˆç³»ç»Ÿè¿›å…¥å®æ—¶æ¨¡å¼ï¼Œåœ¨å®æ—¶æ¨¡å¼ä¸‹ï¼Œåœ°å€æ€»çº¿å®½åº¦æ˜¯ 16bitsï¼Œçº¿æ€§åœ°å€å°±æ˜¯ç‰©ç†åœ°å€ï¼Œå¯ä»¥ç›´æ¥è®¿é—®å†…å­˜ã€‚

> [Intel SDM(Software Developer's Manual) Download](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------

#### <span id="A03">CR3 (PDBR)</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000707.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000724.png)

CR3 å¯„å­˜å™¨ç§°ä¸ºé¡µç›®å½•åŸºå€å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨ä»ç¬¬ 12 bit ä¹‹åçš„ç©ºé—´å­˜å‚¨äº†æŒ‡å‘é¡µç›®å½•æ‰€åœ¨ç‰©ç†åœ°å€ï¼Œç”±äºé¡µç›®å½•æ‰€åœ¨çš„ç‰©ç†åœ°å€å¿…é¡»æŒ‰ 4-KiB å¯¹é½ï¼Œå› æ­¤é¡µç›®å½•æ‰€åœ¨çš„ç‰©ç†åœ°å€çš„ä½ 12 ä½ä¸º 0ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼ŒCR3 å¯„å­˜å™¨çš„ä½ 12 bit å¯ä»¥ç”¨æ¥å­˜å‚¨å…¶ä½™ä¿¡æ¯ã€‚PCD å’Œ PWT ä½ç”¨äºæ§åˆ¶æ˜¯å¦å°†åˆ†é¡µæ•°æ®ç»“æ„å­˜å‚¨åœ¨å¤„ç†å™¨å†…å­˜çš„ç¼“å­˜ä¸­ï¼Œä½†è¿™ä¸¤ä¸ªä½ä¸èƒ½æ§åˆ¶ TLB ç¼“å­˜é¡µç›®å½•ç›¸å…³ä¿¡æ¯.

> [Intel SDM(Software Developer's Manual) Download](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------

#### <span id="A04">CR4 (PDBR)</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000719.png)

CR4 å¯„å­˜å™¨ä¸­åŒ…å«äº†ä¸€ç»„ä½¿èƒ½å¤šä¸ªä½“ç³»æ‹“å±•ä»¥åŠæŒ‡æ˜æ“ä½œç³»ç»Ÿæˆ–å¯æ‰§è¡Œç¨‹åºæ”¯æŒç‰¹æ®Šèƒ½åŠ›ã€‚

> [> CR4.PAE](#A0400)
>
> [> CR4.PSE](#A0401)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------

##### <span id="A0400">CR4.PAE</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000719.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000720.png)

CR4.PAE æ§åˆ¶ä½ç”¨äºæ§åˆ¶ç³»ç»Ÿæ˜¯å¦æ‰“å¼€ç‰©ç†åœ°å€æ‹“å±•åŠŸèƒ½ã€‚å½“è¯¥ä½ç½®ä½ï¼Œé‚£ä¹ˆç³»ç»Ÿæ”¯æŒåˆ†é¡µå¯¹åº”çš„ç‰©ç†åœ°å€è¶…è¿‡ 32bit; åä¹‹è¯¥ä½æ¸…é›¶ï¼Œé‚£ä¹ˆç³»ç»Ÿæ”¯æŒçš„åˆ†é¡µå¯¹åº”çš„ç‰©ç†åœ°å€ä¸¥æ ¼æŒ‰ç…§ 32bitã€‚å½“ç³»ç»Ÿè¿›å…¥ IA-32e æ¨¡å¼ä¹‹å‰ï¼ŒCR4.PAE æ§åˆ¶ä½å¿…é¡»ä½¿èƒ½.

> [Intel SDM(Software Developer's Manual) Download](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------

##### <span id="A0401">CR4.PSE</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000719.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000721.png)

CR4.PSE æ§åˆ¶ä½ç”¨äºæ§åˆ¶ç³»ç»Ÿåœ¨åˆ†é¡µçš„æ—¶å€™æ˜¯å¦æ”¯æŒ 4-MiB é¡µã€‚å½“è¯¥ä½ç½®ä½ï¼Œé‚£ä¹ˆ 32-bit çš„åˆ†é¡µæ”¯æŒ 4-MiB é¡µ; åä¹‹è¯¥ä½æ¸…é›¶ï¼Œé‚£ä¹ˆ 32-bit çš„åˆ†é¡µä¸¥æ ¼æŒ‰ç…§ 4-KiB é¡µ.

> [Intel SDM(Software Developer's Manual) Download](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------



----------------------------------------------




#### BiscuitOS Demo

åŠŸèƒ½ä»‹ç»

#### BiscuitOS é…ç½®

åœ¨ BiscuitOS ä¸­ä½¿ç”¨é…ç½®å¦‚ä¸‹:

{% highlight bash %}
[*] Package  --->
    [*] Assembly  --->
        [*] X86/i386/X64 Assembly  --->
            [*] MOV  --->
{% endhighlight %}

å…·ä½“å®è·µåŠæ³•è¯·å‚è€ƒ:

> - [EPTå®è·µè¯¦è§£](#C)

#### é€šç”¨ä¾‹ç¨‹

{% highlight bash %}

{% endhighlight %}



![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>
> [Linux Kernel Driver Data Base](https://cateee.net/lkddb/web-lkddb/)

#### æèµ ä¸€ä¸‹å§ ğŸ™‚

![MMU](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
