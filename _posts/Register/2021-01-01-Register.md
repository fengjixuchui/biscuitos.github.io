---
layout: post
title:  "Register"
date:   2021-01-01 12:00:00 +0800
categories: [HW]
excerpt: Register.
tags:
  - Register
---

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

#### 目录

> - [X86 Control Register](#R03)
>
>   - [CR0](#R00)
>
>   - [CR3](#R02)
>
>   - [CR4](#R01)
>
> - [X86 EFLAGS Register](#M)
>
> - [X86 MSR](#T016)
>
>   - [IA32_EFER MSR](#T000)
>
>   - [IA32_MTRRCAP MSR](#T001)
>
>   - [IA32_MTRR_DEF_TYPE MSR](#T002)
>
>   - [IA32_MTRR_PHYSBASEn MSR](#T014)
>
>   - [IA32_MTRR_PHYSMASKn MSR](#T015)
>
>   - [IA32_MTRR_FIX64K_00000 MSR](#T003)
>
>   - [IA32_MTRR_FIX16K_80000 MSR](#T004)
>
>   - [IA32_MTRR_FIX16K_A0000 MSR](#T005)
>
>   - [IA32_MTRR_FIX4K_C0000 MSR](#T006)
>
>   - [IA32_MTRR_FIX4K_C8000 MSR](#T007)
>
>   - [IA32_MTRR_FIX4K_D0000 MSR](#T008)
>
>   - [IA32_MTRR_FIX4K_D8000 MSR](#T009)
>
>   - [IA32_MTRR_FIX4K_E0000 MSR](#T010)
>
>   - [IA32_MTRR_FIX4K_E8000 MSR](#T011)
>
>   - [IA32_MTRR_FIX4K_F0000 MSR](#T012)
>
>   - [IA32_MTRR_FIX4K_F8000 MSR](#T013)
>
> - [CPUID](#C)
>
>   - [CPUID.01H](#C01M)
>
>   - [CPUID.80000008H](#C02M)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T015">IA32_MTRR_PHYSMASKn MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000173.png)

Variable-Range MTRR 使用 IA32_MTRR_PHYSBASEn/IA32_MTRR_PHYSMASKn MSR 寄存器对，来描述一段物理内存区域的 memory type, 其中 IA32_MTRR_PHYSBASEn 寄存器负责描述物理内存区域的基地址和 memory type 信息, IA32_MTRR_PHYSMASKn 寄存器则提供掩码，以此确认物理内存区域的范围，其还提供了 V 标志位用于描述该寄存器对描述的物理区域是否有效. MTRR 机制支持多个这样的寄存器对，其可以通过 IA32_MTRRCAP MSR 寄存器的 VCNT 字段获得寄存器对的数量, 寄存器的布局如上图所示。当该寄存器对描述的物理内存区域与 Fixed-Range MTRR 寄存器描述的物理内存范围重叠，那么 MTRR 机制优先采用 Fixed-Range MTRR 寄存器描述的 memory type. X86 架构支持 IA32_MTRR_PHYSBASEn/IA32_MTRR_PHYSMASKn 寄存器对的数量目前为 8 个.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000175.png)

----------------------------------------

###### PhysMask

PhysMask 字段与 IA32_MTRR_PHYSBASEn MSR 寄存器相互配合计算出物理内存范围，其计算方法如下:

{% highlight bash %}
# e.g. Physial Address Range 1MiB: 0x100000 - 0x1FFFFF

PhysBase = 0x100000 >> PAGE_SHIFT = 0x100
PhsyMask = (PhysBase ^ (~(1Mib - 1) >> PAGE_SHIFT)) & 0xFFFFFFFF = 0xFFFFFE
{% endhighlight %}

在上面的例子中，需要设置一段物理内存的 memory type，其起始物理地址是 0x100000, 长度为 1MiB，因此结束地址为 0x1FFFFF. 首先计算 IA32_MTRR_PHYSBASEn 中的 PhysBase 字段，其值为物理内存区域的起始物理页帧，也就是起始地址向右移动 PAGE_SHIFT 的结果，因此 0x100000 对应的 PhysBase 就是 0x100. 对于 IA32_MTRR_PHYSMASKn 中的 PhysMask 字段，其计算方法是将物理区域的长度减去 1，并取反码，接着将取反码的值向右移动 PAGE_SHIFT 位，最后与 PhysBase 字段值进行亦或操作，并将值限定在 (MAXPHYADDR - 12) 范围内，因此计算的 PhysMask 字段值为 0xFFFFE. 

------------------------------------

###### V

V 标志位则表示 IA32_MTRR_PHYSBASEn/IA32_MTRR_PHYSMASKn 描述的物理内存区域的 memory type 是否有效，当该标志位置位，那么 Variable-Range MTRR 可以使用该寄存器对描述; 反之则无效.

> [IA32_MTRR_PHYSMASKn MSR Register BiscuitOS 实践](#T015A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T015A4">BiscuitOS 实践</span>

Intel IA32_MTRR_PHYSMASKn MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_PHYSMASKn  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_PHYSMASKn-default
{% endhighlight %}

> [MSR IA32_MTRR_PHYSMASKn Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_PHYSMASKn)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000176.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T014">IA32_MTRR_PHYSBASEn MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000173.png)

Variable-Range MTRR 使用 IA32_MTRR_PHYSBASEn/IA32_MTRR_PHYSMASKn MSR 寄存器对，来描述一段物理内存区域的 memory type, 其中 IA32_MTRR_PHYSBASEn 寄存器负责描述物理内存区域的基地址和 memory type 信息. MTRR 机制支持多个这样的寄存器对，其可以通过 IA32_MTRRCAP MSR 寄存器的 VCNT 字段获得寄存器对的数量。目前 X86 架构中支持多达 8 个 IA32_MTRR_PHYSBASEn/IA32_MTRR_PHYSMASKn 寄存器对，寄存器的布局如上图所示。当该寄存器对描述的物理内存区域与 Fixed-Range MTRR 寄存器描述的物理内存范围重叠，那么 MTRR 机制优先采用 Fixed-Range MTRR 寄存器描述的 memory type.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000175.png)

----------------------------

###### PhysBase

PhysBase 字段用于指定物理内存区域的起始物理页帧，其长度范围为 [12: MAXPHYADDR]，该字段的值与对应的 IA32_MTRR_PHYSMASKn MSR 寄存器的 PhysMask 字段结合可以确定影响物理内存的范围，其计算如下:

{% highlight bash %}
# e.g. Physial Address Range 1MiB: 0x100000 - 0x1FFFFF

PhysBase = 0x100000 >> PAGE_SHIFT = 0x100
PhsyMask = (PhysBase ^ (~(1Mib - 1) >> PAGE_SHIFT)) & 0xFFFFFFFF = 0xFFFFFE
{% endhighlight %}

在上面的例子中，需要设置一段物理内存的 memory type，其起始物理地址是 0x100000, 长度为 1MiB，因此结束地址为 0x1FFFFF. 首先计算 IA32_MTRR_PHYSBASEn 中的 PhysBase 字段，其值为物理内存区域的起始物理页帧，也就是起始地址向右移动 PAGE_SHIFT 的结果，因此 0x100000 对应的 PhysBase 就是 0x100. 对于 IA32_MTRR_PHYSMASKn 中的 PhysMask 字段，其计算方法是将物理区域的长度减去 1，并取反码，接着将取反码的值向右移动 PAGE_SHIFT 位，最后与 PhysBase 字段值进行亦或操作，并将值限定在 (MAXPHYADDR - 12) 范围内，因此计算的 PhysMask 字段值为 0xFFFFE. 

------------------------------

###### Type

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_PHYSBASEn MSR 寄存器的 Type 字段用于设置指定物理内存区域的 meory type, 其值代表的函数如上图.

> [IA32_MTRR_PHYSBASEn MSR Register BiscuitOS 实践](#T014A4)
> 
> [Intel Software Development Vol3 11.11.2.3](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T014A4">BiscuitOS 实践</span>

Intel IA32_MTRR_PHYSBASEn MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_PHYSBASEn  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_PHYSBASEn-default
{% endhighlight %}

> [MSR IA32_MTRR_PHYSBASEn Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_PHYSBASEn)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000174.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T013">IA32_MTRR_FIX4K_F8000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000172.png)

IA32_MTRR_FIX4K_F8000 MSR 寄存器用于描述物理地址从 0xF8000H 到 0x10000H 之间 32 KiB 物理内存区域的 memory type. IA32_MTRR_FIX4K_F8000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX4K_F8000 MSR 寄存器将物理内存 32 KiB 同样划分为 8 个区域，每个区域的长度正好是 4K，因此该寄存器的每个区域正好对应一个 4 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX4K_F8000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值
对应的 memory type 如上图.

> [IA32_MTRR_FIX4K_F8000 MSR Register BiscuitOS 实践](#T013A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T013A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX4K_F8000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX4K_F8000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX4K_F8000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX4K_F8000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX4K_F8000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000171.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T012">IA32_MTRR_FIX4K_F0000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000169.png)

IA32_MTRR_FIX4K_F0000 MSR 寄存器用于描述物理地址从 0xF0000H 到 0xF8000H 之间 32 KiB 物理内存区域的 memory type. IA32_MTRR_FIX4K_F0000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX4K_F0000 MSR 寄存器将物理内存 32 KiB 同样划分为 8 个区域，每个区域的长度正好是 4K，因此该寄存器的每个区域正好对应一个 4 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX4K_F0000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值
对应的 memory type 如上图.

> [IA32_MTRR_FIX4K_F0000 MSR Register BiscuitOS 实践](#T012A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T012A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX4K_F0000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX4K_F0000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX4K_F0000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX4K_F0000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX4K_F0000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000170.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T011">IA32_MTRR_FIX4K_E8000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000167.png)

IA32_MTRR_FIX4K_E8000 MSR 寄存器用于描述物理地址从 0xE8000H 到 0xF0000H 之间 32 KiB 物理内存区域的 memory type. IA32_MTRR_FIX4K_E8000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX4K_E8000 MSR 寄存器将物理内存 32 KiB 同样划分为 8 个区域，每个区域的长度正好是 4K，因此该寄存器的每个区域正好对应一个 4 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX4K_E8000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值
对应的 memory type 如上图.

> [IA32_MTRR_FIX4K_E8000 MSR Register BiscuitOS 实践](#T011A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T011A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX4K_E8000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX4K_E8000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX4K_E8000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX4K_E8000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX4K_E8000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000168.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T010">IA32_MTRR_FIX4K_E0000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000165.png)

IA32_MTRR_FIX4K_E0000 MSR 寄存器用于描述物理地址从 0xE0000H 到 0xE8000H 之间 32 KiB 物理内存区域的 memory type. IA32_MTRR_FIX4K_E0000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX4K_E0000 MSR 寄存器将物理内存 32 KiB 同样划分为 8 个区域，每个区域的长度正好是 4K，因此该寄存器的每个区域正好对应一个 4 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX4K_E0000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值
对应的 memory type 如上图.

> [IA32_MTRR_FIX4K_E0000 MSR Register BiscuitOS 实践](#T010A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T010A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX4K_E0000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX4K_E0000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX4K_E0000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX4K_E0000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX4K_E0000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000166.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T009">IA32_MTRR_FIX4K_D8000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000163.png)

IA32_MTRR_FIX4K_D8000 MSR 寄存器用于描述物理地址从 0xD8000H 到 0xE0000H 之间 32 KiB 物理内存区域的 memory type. IA32_MTRR_FIX4K_D8000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX4K_D8000 MSR 寄存器将物理内存 32 KiB 同样>划分为 8 个区域，每个区域的长度正好是 4K，因此该寄存器的每个区域正好对应一个 4 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX4K_D8000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值
对应的 memory type 如上图.

> [IA32_MTRR_FIX4K_D8000 MSR Register BiscuitOS 实践](#T009A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T009A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX4K_D8000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX4K_D8000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX4K_D8000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX4K_D8000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX4K_D8000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000164.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T008">IA32_MTRR_FIX4K_D0000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000161.png)

IA32_MTRR_FIX4K_D0000 MSR 寄存器用于描述物理地址从 0xD0000H 到 0xD8000H 之间 32 KiB 物理内存区域的 memory type. IA32_MTRR_FIX4K_D0000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX4K_D0000 MSR 寄存器将物理内存 32 KiB 同样>划分为 8 个区域，每个区域的长度正好是 4K，因此该寄存器的每个区域正好对应一个 4 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX4K_D0000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值
对应的 memory type 如上图.

> [IA32_MTRR_FIX4K_D0000 MSR Register BiscuitOS 实践](#T008A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T008A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX4K_D0000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX4K_D0000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX4K_D0000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX4K_D0000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX4K_D0000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000162.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T007">IA32_MTRR_FIX4K_C8000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000159.png)

IA32_MTRR_FIX4K_C8000 MSR 寄存器用于描述物理地址从 0xC8000H 到 0xD0000H 之间 32 KiB 物理内存区域的 memory type. IA32_MTRR_FIX4K_C8000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX4K_C8000 MSR 寄存器将物理内存 32 KiB 同样划分为 8 个区域，每个区域的长度正好是 4K，因此该寄存器的每个区域正好对应一个 4 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX4K_C8000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值
对应的 memory type 如上图.

> [IA32_MTRR_FIX4K_C8000 MSR Register BiscuitOS 实践](#T007A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T007A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX4K_C8000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX4K_C8000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX4K_C8000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX4K_C8000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX4K_C8000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000160.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T006">IA32_MTRR_FIX4K_C0000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000157.png)

IA32_MTRR_FIX4K_C0000 MSR 寄存器用于描述物理地址从 0xC0000H 到 0xC8000H 之间 32 KiB 物理内存区域的 memory type. IA32_MTRR_FIX4K_C0000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX4K_C0000 MSR 寄存器将物理内存 32 KiB 同样划分为 8 个区域，每个区域的长度正好是 4K，因此该寄存器的每个区域正好对应一个 4 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX4K_C0000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值对应的 memory type 如上图.

> [IA32_MTRR_FIX4K_C0000 MSR Register BiscuitOS 实践](#T006A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T006A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX4K_C0000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX4K_C0000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX4K_C0000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX4K_C0000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX4K_C0000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000158.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T005">IA32_MTRR_FIX16K_A0000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000155.png)

IA32_MTRR_FIX16K_A0000 MSR 寄存器用于描述物理地址从 0xA0000H 到 0xC0000H 之间 128 KiB 物理内存区域的 memory type. IA32_MTRR_FIX16K_A0000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX16K_A0000 MSR 寄存器将物理内存 128 KiB 同样划分为 8 个区域，每个区域的长度正好是 16K，因此该寄存器的每个区域正好对应一个 16 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX16K_A0000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值对应的 memory type 如上图.

> [IA32_MTRR_FIX16K_A0000 MSR Register BiscuitOS 实践](#T005A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T005A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX16K_A0000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX16K_A0000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX16K_A0000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX16K_A0000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX16K_A0000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000156.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T004">IA32_MTRR_FIX16K_80000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000153.png)

IA32_MTRR_FIX16K_80000 MSR 寄存器用于描述物理地址从 0x80000H 到 0xA0000H 之间 128 KiB 物理内存区域的 memory type. IA32_MTRR_FIX16K_80000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX16K_80000 MSR 寄存器将物理内存 128 KiB 同样划分为 8 个区域，每个区域的长度正好是 16K，因此该寄存器的每个区域正好对应一个 16 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX16K_80000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值对应的 memory type 如上图.

> [IA32_MTRR_FIX16K_80000 MSR Register BiscuitOS 实践](#T004A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

---------------------------------------------------------

###### <span id="T004A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX16K_80000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX16K_80000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX16K_80000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX16K_80000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX16K_80000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000154.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T003">IA32_MTRR_FIX64K_00000 MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000151.png)

IA32_MTRR_FIX64K_00000 MSR 寄存器用于描述物理地址从 0x00000H 到 0x7FFFFH 之间 512 KiB 物理内存区域的 memory type. IA32_MTRR_FIX64K_00000 MSR 寄存器位宽 64 位，其被划分为 8 个区域，每个区域占用 8 bit. IA32_MTRR_FIX64K_00000 MSR 寄存器将物理内存前 512 KiB 同样划分为 8 个区域，每个区域的长度正好是 64K，因此该寄存器的每个区域正好对应一个 64 KiB 区域，如上图所示。

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

IA32_MTRR_FIX64K_00000 MSR 寄存器的每个域可以设置对应物理内存区域的 memory type，其值对应的 memory type 如上图.

> [IA32_MTRR_FIX64K_00000 MSR Register BiscuitOS 实践](#T003A4)
> 
> [Intel Software Development Vol3 11.11.2.2](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

----------------------------------

###### <span id="T003A4">BiscuitOS 实践</span>

Intel IA32_MTRR_FIX64K_00000 MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_FIX64K_00000  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_FIX64K_00000-default
{% endhighlight %}

> [MSR IA32_MTRR_FIX64K_00000 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_FIX64K_00000)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000152.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T002">IA32_MTRR_DEF_TYPE MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000148.png)

IA32_MTRR_DEF_TYPE MSR 寄存器从 P6 家族处理器开始被命名为 "MTRRdefType MSR", 该寄存器的作用范围是被 MTRRs 相关寄存器设置 memory type 的物理内存区域，该寄存器会为这些区域设置默认的 memory type。其字段描述如下:

> - [Type filed](#T002A0)
>
> - [FE](#T002A1)
>
> - [E](#T002A2)
>
> - [Other Bit](#T002A3)
>
> - [IA32_MTRR_DEF_TYPE MSR Register BiscuitOS 实践](#T002A4)
> 
> - [Intel Software Development Vol3 11.11.2.1](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

-----------------------------------------

###### <span id="T002A0">Type field</span>

Type 域用于为没有设置 memory type 的物理内存区域，设置默认的 memory type。该区域默认支持的 memory type 为 0, 1, 4, 5 和 6. 如果设置为其他值会引起通用保护异常 (#GP), memory type 对应的值如下表:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

Intel 推荐使用 UC (Uncached) 作为所有物理内存缺省时的 memory type。MTRR 机制为不存在内存的位置分配 UC，既可以通过该寄存器设置为默认的 memory type，也可以显示的通过 Fixed-Range Register 和 Variable-Range Register 进行设置.

------------------------------------------------

###### <span id="T002A1">FE (Fixed MTRRs enabled)</span>

FE 标志用于指明 MTRR 机制是否支持 Fixed-Range Register. 当该标志置位，那么系统支持 Fixed-Range Register, Fixed-Range Register 用于为固定的物理内存区域设置 memory type; 反之当该标志清零，那么 MTRR 机制不支持 Fixed-Range Register. MTRR 机制也包含了 Variable-Range Register, 其可灵活设置某段内存区域的 memory type。MTRR 机制支持的 Fixed-Range Register 列表如下:

当 Fixed-Range Register 设置的某块固定物理内存区域与 Variable-Range Register 设置的>某块物理内存区域存在重叠，那么对于重叠部分物理内存的 memory type，MTRR 机制优先采用 Fixed-Range Register 设置的 memory type. 当标志清零，那么 MTRR 机制一直使用 Variable-Range Register 的值作为指定物理区域的 memory type。

----------------------------------------------

###### <span id="T002A2">E (MTRRs Enable)</span>

E 标志用于指明系统是否使能了 MTRR 机制。之前讨论过，架构在 CPUID.01H EDX 的 12 bit 用于指明是否支持 MTRR 机制，而 E 标志位则指明系统是否使用 MTRR 机制。当该标志为清零，那么系统没有使能 MTRR 机制，那么所有的物理内存的 memory type 则为 UC; 反之改标志位置位，那么 MTRR 机制使能，可以使用 Fixed-Range Register 和 Variable-Range Register 设置指定物理内存区域的 memory type.

-----------------------------------------------

###### <span id="T002A3">Other bit</span>

IA32_MTRR_DEF_TYPE MSR 寄存器的其他 bit 均为 Reserved, 如果对这些 bit 写入非 0 值，那么会触发通用保护异常 (#GP).

---------------------------------------------

###### <span id="T002A4">BiscuitOS 实践</span>

Intel IA32_MTRR_DEF_TYPE MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRR_DEF_TYPE  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRR_DEF_TYPE-default
{% endhighlight %}

> [MSR IA32_MTRR_DEF_TYPE Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRR_DEF_TYPE)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000150.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T001">IA32_MTRRCAP MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000146.png)

IA32_MTRRCAP MSR 寄存器从 P6 家族处理器开始被命名为 "MTRRcap MSR", 该寄存器为只读寄存器，需要通过 RDMSR 指令进行读取，寄存器内部提供了多个域用于描述 MTRR 机制的能力信息，其字段描述如下:

> - [VCNT](#T001A0)
>
> - [FIX](#T001A1)
>
> - [WC](#T001A2)
>
> - [SMRR](#T001A3)
>
> - [IA32_MTRRCAP MSR Register BiscuitOS 实践](#T001A4)
> 
> - [Intel Software Development Vol3 11.11.1](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

-------------------------

###### <span id="T001A0">VCNT (Variable range registers count)</span>

VCNT 字段用于描述当前 MTRR 机制支持的 Variable-Range Register 的数量, 该字段的长度为 8its, 因此系统支持的最大 Variable-Range Register 的数量不会超过 256 个，Linux 支持的最大 Variable-Range Register 数量通过宏 MTRR_MAX_VAR_RANGES 进行维护.

-------------------------

###### <span id="T001A1">FIX (Fixed range register supports)</span>

FIX 字段用于描述 MTRR 机制是否支持 Fixed-Range Register. 当该标志位置位，那么 MTRR 机制提供的 Fixed-Range Register 包含了 IA32_MTRR_FIX64K_00000 到 IA32_MTRR_FIX4K_0F8000 12 个寄存器; 反之当该标志位清零，MTRR 机制中不存在 Fixed-Range Register.

-------------------------

###### <span id="T001A2">WC (Write Combining)</span>

WC 字段用于描述系统是否支持 Write-combining memory type。Write-combining 写合并缓存类型也是一种 memory type。当该标志位清零，那么系统以及 MTRR 机制不支持 WC; 反之该标志位置位，那么系统支持 WC，MTRR 机制相关的寄存器可以将对应的物理内存区域的 memory type 设置为 WC.

-------------------------

###### <span id="T001A3">SMRR (System-Management Range Register)</span>

SMRR 字段用于描述系统是否支持 System-Management range register, 如果该标志位置位，那么系统支持 SMRR; 反之该标志位清零，那么系统不支持 SMRR.

---------------------------------------------

###### <span id="T001A4">BiscuitOS 实践</span>

Intel IA32_MTRRCAP MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_MTRRCAP  --->

BiscuitOS/output/linux-XXXX/package/MSR-IA32_MTRRCAP-default
{% endhighlight %}

> [MSR IA32_MTRRCAP Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_MTRRCAP)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000147.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="R02">X86 CR3 Control Register</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000985.png)

> [CR3 With 32Bit Paging](#R02M00)
>
> [CR3 Register BiscuitOS 实践](#R02MX)
> 
> [Intel Software Development Vol2.3.2 CPUID](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

--------------------------------------

###### <span id="R02M00">CR3 With 32Bit Paging</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000986.png)

---------------------------------------------

###### <span id="R02MX">BiscuitOS 实践</span>

Intel CR3 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] CR3 Register  --->
                  [*] X86 CR3 Register (Common)  --->
{% endhighlight %}

> [CR3 Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/CR3/CR3-Default)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000987.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)


-------------------------------------------

#### <span id="C">X86 CPUID Register</span>

> [CPUID.01H](#C01M)
>
> [CPUID Register BiscuitOS 实践](#CMM)
> 
> [Intel Software Development Vol2.3.2 CPUID](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

------------------------------------

###### <span id="C02M">CPUID.80000008H</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000983.png)

> [CPUID.01H Register BiscuitOS 实践](#C02M03)

---------------------------------------------

###### <span id="C02M03">BiscuitOS 实践</span>

Intel CPUID.80000008H 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] CPUID  --->
                  [*] X86 CPUID Register  --->
                      [*] CPUID.80000008H Register  --->
                          [*] X86 CPUID.80000008H Register  --->
{% endhighlight %}

> [CPUID.80000008H Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/CPUID/CPUID.80000008H/Default)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000984.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------

###### <span id="C01M">CPUID.01H</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000974.png)

> [EAX](#C01M00)
>
> [ECX](#C01M01)
>
> [EDX](#C01M02)
>
> [CPUID.01H Register BiscuitOS 实践](#C01M03)

----------------------------------

###### <span id="C01M00">EAX</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000981.png)

----------------------------------

###### <span id="C01M01">ECX</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000975.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000976.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000977.png)

---------------------------------

###### <span id="C01M02">EDX</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000978.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000979.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000980.png)

---------------------------------------------

###### <span id="C01M03">BiscuitOS 实践</span>

Intel CPUID.01H 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] CPUID  --->
                  [*] X86 CPUID Register  --->
                      [*] CPUID.01H Register  --->
                          [*] X86 CPUID.01H Register  --->
{% endhighlight %}

> [CPUID.01H Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/CPUID/CPUID.01H/Default)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000982.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

###### <span id="CMM">BiscuitOS 实践</span>

Intel CPUID 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] CPUID  --->
                  [*] X86 CPUID Register  --->
{% endhighlight %}

> [CPUID Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/CPUID/CPUID-Default)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000973.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="M">X86 EFLAGS Register</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000969.png)

X86 EFLAGS Register 包含了一组状态、控制和系统标志。

> [EFLAGS.AC](#M00)
>
> [EFLAGS Register BiscuitOS 实践](#M0A)
> 
> [Intel Software Development Vol3 2.2.1](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

------------------------------------

###### <span id="M00">EFLAGS.AC</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000970.png)

EFLAGS.AC 标志位用于指明 "对齐检测" 或 "访问控制". 当 CR0.AM 标志位置位，那么 AC 标志位用于表示 "对齐检测".

如果 CR4.SMAP 标志位置位，那么内核空间可以访问用户空间的数据.

> [CR4.SMAP](#R015)

---------------------------------------------

###### <span id="M0A">BiscuitOS 实践</span>

Intel EFLAGS 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] EFLAGS Register  --->
                  [*] X86 EFLAGS Register  --->
{% endhighlight %}

> [EFLAGS Register Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/EFLAGS/default)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000971.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="T000">IA32_EFER MSR</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000966.png)

X86 IA32_EFER MSR 寄存器全称 "Extended Feature enable Register", 该寄存器提供了多个域与 IA-32e 模式的使能和操作相关，其中也包含了一个与 page-access 权限修改相关的域。

> [IA32_EFER.LME](#T0000)
>
> [IA32_EFER.NXE](#T0001)
>
> [IA32_EFER MSR Register BiscuitOS 实践](#T000A)
> 
> [Intel Software Development Vol3 2.2.1](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

------------------------------------

###### <span id="T0000">IA32_EFER.LME</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000967.png)

IA32_EFER.LME 标志用于指明 IA-32e 模式是否激活. 当该标志置位，那么 IA-32 模式已经激活; 反之 IA-32e 模式没有激活.

------------------------------------

###### <span id="T0001">IA32_EFER.NXE</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000967.png)

IA32_EFER.NXE 标志用于指明使能物理页的访问限制，如果该 bit 置位，那么系统会阻止 PAE 物理页在 XD 标志置位的情况下的指令预取.

-------------------------------------

###### <span id="T000A">BiscuitOS 实践</span>

Intel IA32_EFER MSR 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] MSR Register  --->
                  [*] MSR IA32_EFER  --->
{% endhighlight %}

> [MSR IA32_EFER Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/MSR-IA32_EFER)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000968.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="R01">CR4</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000958.png)

X86 CR4 寄存器包含了一组标志，该标志用于使能体系 "拓展的" 且用于指明操作系统或执行程序所支持的处理器特殊能力。

> [CR4.PSE](#R010)
>
> [CR4.PAE](#R011)
>
> [CR4.PGE](#R012)
>
> [CR4.PCIDE](#R013)
>
> [CR4.SMEP](#R014)
>
> [CR4.SMAP](#R015)
>
> [CR4.PKE](#R016)
>
> [CR4 Register BiscuitOS 实践](#R01A)
> 
> [Intel Software Development Vol3 2.5](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

------------------------------------

###### <span id="R010">CR4.PSE</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000959.png)

CR4.PSE 标志用于指明 32-bit 系统分页是否支持 4MB 物理页的映射。如果该标志位置位，那么在 32-bit 系统里，PTE 可以指向一块 4MB 的物理页; 反之该标志位清零，那么在 32-bit 系统中 PTE 只能映射 4KB 的物理页.

------------------------------------

###### <span id="R011">CR4.PAE</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000960.png)

CR4.PAE 标志用于指明系统是否支持物理地址拓展。当该标志位置位，那么分页的时候使用超过 32 bit 的物理地址; 反之，当该标志位清零的时候，物理地址只能是 32 bit。当系统进入 IA-32e 模式之前，CR4.PAE 表示为必须使能。

------------------------------------

###### <span id="R012">CR4.PGE</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000961.png)

CR4.PGE 标志用于指明是否支持全局页特性。如果该标志位使能，那么系统支持全局页属性; 反之不支持全局页属性。全局页属性允许所有的用户频繁使用或共享 PTE/PDE 中 "Global" 标志位置位的页。全局页特点包括当 Task 切换或者更新 CR3 的值不会引起全局页从 TLB 中刷出. 当系统需要使能 CR4.PGE 标志，那么 CR0.PG 必须使能。

------------------------------------

###### <span id="R013">CR4.PCIDE</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000962.png)

CR4.PCIDE 标志用于指明是否支持处理器上下文标识. 当该标志位置位，那么系统支持 PCIDs 功能; 反之系统不支持 PCIDs 功能.

------------------------------------

###### <span id="R014">CR4.SMEP</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000963.png)

CR4.SMEP 标志用于指明系统是否支持阻止 "超级用户执行" 的能力。如果该标志位置位，那么系统可能阻止超级用户执行的动作.

------------------------------------

###### <span id="R015">CR4.SMAP</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000964.png)

CR4.SMAP 标志用于指明系统是否支持阻止 "超级用户访问" 的能力. 如果该标志位置位，那么系统可能阻止超级用户访问的动作.

------------------------------------

###### <span id="R015">CR4.PKE</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000965.png)

CR4.PKE 标志用于指明系统是否支持在 4-level 分页时附带一个 "Protection key". PKRU 寄存器指明用户的线性地址的 "Protection key" 是否可读写.

-------------------------------------

###### <span id="R01A">BiscuitOS 实践</span>

Intel X86 CR4 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] CR4 Control Register  --->
{% endhighlight %}

> [CR0 Control Register Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/CR0)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000950.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

#### <span id="R00">CR0</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000954.png)

X86 CR0 寄存器包含了用于控制处理器的操作模式和状态的系统控制标志。其长度为 32 bit，每个标志位的作用将左右操作系统的行为和状态.

> [CR0.PG](#R000)
>
> [CR0.PE](#R001)
>
> [CR0.WP](#R002)
>
> [CR0 Register BiscuitOS 实践](#R00A)
> 
> [Intel Software Development Vol3 2.5](https://gitee.com/BiscuitOS_team/Documentation/blob/master/Datasheet/Intel/Intel-IA32_DevelopmentManual.pdf)

------------------------------------

###### <span id="R000">CR0.PG</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000955.png)

CR0.PG 标志位用于使能系统的分页机制. 如果 CR0.PG 置位，那么系统支持分页，此时线性地址不是虚拟地址; 反之 CR0.PG 清零，那么系统不支持分页，此时线性地址就是物理地址. CR0.PG 标志位的变化不受 CR0.PE 标志位的影响，但当 CR0.PE 标志位清零的时候，将 CR0.PG 标志位置位将引起一个 #GP 错误, 也就是系统没有进入保护模式的时候，系统开启分页将引起一个 "general-protection exception (#GP)".

------------------------------------

###### <span id="R001">CR0.PE</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000956.png)

CR0.PE 标志位用于使能系统的保护模式. 如果 CR0.PE 置位，那么系统进入保护模式; 如果 CR0.PE 清零，那么系统进入实时模式。CR0.PE 的使能不能直接启用系统的分页功能，需要再将 CR0.PG 置位，并且 CR0.PE 的使能只提供了 Segment 级别的保护.

------------------------------------

###### <span id="R002">CR0.WP</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000957.png)

CR0.WP 用于使能写保护机制。当 CR0.WP 置位，那么系统会阻止超级权限的程序去写只读的物理页; 反之当 CR0.WP 清零，那么系统允许超级权限的程序对只读物理页进行写操作。

-------------------------------------

###### <span id="R00A">BiscuitOS 实践</span>

Intel X86 CR0 寄存器在 BiscuitOS 中的实践如下:

{% highlight bash %}
cd BiscuitOS
make menuconfig

  [*] Package  --->
      [*] Register  --->
          [*] X86/i386/X64 Register  --->
              [*] CR0 Control Register  --->
{% endhighlight %}

> [CR0 Control Register Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Architecture/Intel/Register/CR0)

具体实践过程可以参考:

> [BiscuitOS 独立程序实践教程](https://biscuitos.github.io/blog/Human-Knowledge-Common/#C)

程序在 BiscuitOS 运行效果如下:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000950.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

