---
layout: post
title:  "BiscuitOS Linux 0.12 i386 Usermanual"
date:   2020-10-02 14:45:30 +0800
categories: [Build]
excerpt: Linux 0.12 i386 Usermanual.
tags:
  - Linux
---

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI100100.png)

#### ç›®å½•

> - [BiscuitOS åŸºç¡€ç¯å¢ƒéƒ¨ç½²](#A)
>
> - [BiscuitOS å†…æ ¸éƒ¨ç½²](#C)
>
> - [BiscuitOS åŸºç¡€ä½¿ç”¨](#D)
>
> - [BiscuitOS è°ƒè¯•éƒ¨ç½²](#G)
>
> - [é™„å½•/æèµ ](#Z)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------

<span id="A"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

#### BiscuitOS åŸºç¡€ç¯å¢ƒéƒ¨ç½²

> - [BiscuitOS é¡¹ç›®ç®€ä»‹](#A2)
>
> - [BiscuitOS ç¡¬ä»¶å‡†å¤‡](#A0)
>
> - [BiscuitOS è½¯ä»¶å‡†å¤‡](#A1)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

<span id="A2"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000S.jpg)

#### BiscuitOS é¡¹ç›®ç®€ä»‹

BiscuitOS é¡¹ç›®æ˜¯ä¸€ä¸ªç”¨äºåˆ¶ä½œ Linux 0.xã€1.xã€2.xã€3.xã€4.xã€0.12
é€šç”¨ç²¾ç®€æ“ä½œç³»ç»Ÿï¼Œå…¶ç›®æ ‡æ˜¯ä¸ºå¼€å‘è€…æä¾›ä¸€å¥—çº¯è½¯ä»¶çš„ Qemu å®è·µå¹³å°
æˆ–è€…ç¡¬ä»¶ RaspberryPi å®è·µå¹³å°ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿä¾¿æ·ã€ç®€å•ã€å¿«é€Ÿçš„
åœ¨å„ä¸ªç‰ˆæœ¬ä¸Šå®è·µ Linuxã€‚æ›´å¤š BiscuitOS ä¿¡æ¯è¯·èŒƒå›´ä¸‹åˆ—ç½‘ç«™:

> - [BiscuitOS ä¸»é¡µ](https://biscuitos.github.io/)
>
> - [BiscuitOS åšå®¢](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI100100.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

<span id="A0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000M.jpg)

#### BiscuitOS ç¡¬ä»¶å‡†å¤‡

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI000046.JPG)

ç”±äºé¡¹ç›®æ„å»ºåŸºäº Ubuntuï¼Œå› æ­¤éœ€è¦å‡†å¤‡ä¸€å°è¿è¡Œ
Ubuntu 14.04/16.04/18.04 çš„ä¸»æœºï¼Œä¸»æœºéœ€è¦ä¿æŒç½‘ç»œçš„è¿é€šã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

<span id="A1"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000K.jpg)

#### BiscuitOS è½¯ä»¶å‡†å¤‡

å¼€å‘è€…å‡†å¥½ç¡¬ä»¶è®¾å¤‡ä¹‹åï¼Œé¦–å…ˆåœ¨ Ubuntu ä¸Šå®‰è£…ç›¸åº”çš„å¼€å‘å·¥å…·ï¼Œè¯·å‚è€ƒä¸‹é¢æ–‡æ¡£ï¼Œ
å…¶ä»– Linux å‘è¡Œç‰ˆä¸ä¹‹ç±»ä¼¼:

> [BiscuitOS åŸºç¡€å¼€å‘å·¥å…·å®‰è£…æŒ‡å—](https://biscuitos.github.io/blog/Develop_tools)
>
> [Linux 0.x/1.x ç³»ç»Ÿæ„å»ºç¯å¢ƒæ­å»º](https://biscuitos.github.io/blog/PlatformBuild/)

åŸºç¡€ç¯å¢ƒæ­å»ºå®Œæ¯•ä¹‹åï¼Œå¼€å‘è€…ä» GitHub ä¸Šè·å– BiscuitOS é¡¹ç›®æºç ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

{% highlight bash %}
git clone https://github.com/BiscuitOS/BiscuitOS.git --depth=1
cd BiscuitOS
{% endhighlight %}

BiscuitOS æºç ä¸‹è½½å®Œæ¯•åï¼Œä½¿ç”¨ BiscuitOS è‡ªåŠ¨éƒ¨ç½²åŠŸèƒ½ï¼Œéƒ¨ç½²ä¸€ä¸ª Linux 0.12 
i386 çš„å¼€å‘éƒ¨ç½²ï¼Œä½¿ç”¨è‡ªåŠ¨éƒ¨ç½²åŠŸèƒ½ä¹‹åï¼ŒBiscuitOS é¡¹ç›®ä¼šè‡ªåŠ¨ä¸‹è½½å¹¶éƒ¨ç½² Linux 
0.12 i386 æ‰€éœ€çš„æºç å’Œç¼–è¯‘å·¥å…·ç­‰ï¼Œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·ä¿æŒç½‘ç»œçš„é€šç•…. å¼€å‘è€…
å‚è€ƒä¸‹é¢å‘½ä»¤è¿›è¡Œéƒ¨ç½²:

{% highlight bash %}
cd BiscuitOS
make linux-0.12_defconfig
make
cd BiscuitOS/output/linux-0.12
{% endhighlight %}

æˆåŠŸæ‰§è¡Œä¹‹åï¼ŒBiscuitOS è¾“å‡º Linux 0.12 i386 é¡¹ç›®ç›®å½•ï¼Œä»¥åŠå¯¹åº”å†…æ ¸çš„ç›®å½•ï¼Œå¹¶ä¸”
è‡ªåŠ¨ç”Ÿæˆ BiscuitOS Linux 0.12 i386 ç”¨æˆ·æ‰‹å†Œ (README)ï¼Œå¼€å‘è€…åº”è¯¥é‡ç‚¹å‚è€ƒè¯¥ 
README.md.

{% highlight bash %}
 ____  _                _ _    ___  ____  
| __ )(_)___  ___ _   _(_) |_ / _ \/ ___|
|  _ \| / __|/ __| | | | | __| | | \___ \ 
| |_) | \__ \ (__| |_| | | |_| |_| |___) |
|____/|_|___/\___|\__,_|_|\__|\___/|____/ 

***********************************************
Output:
 BiscuitOS/output/linux-0.12-

linux:
 BiscuitOS/output/linux-0.12/linux/linux 

README:
 BiscuitOS/output/linux-0.12/README.md 

***********************************************
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------

<span id="C"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000P.jpg)

#### BiscuitOS å†…æ ¸éƒ¨ç½²

BiscuitOS é¡¹ç›®çš„ç›®æ ‡å°±æ˜¯ä¸ºå¼€å‘è€…æä¾›ä¸€å¥—ä¾¿æ·å®è·µå†…æ ¸çš„å¹³å°ï¼Œå¹¶ä¸” BiscuitOS æ”¯
æŒå®Œæ•´çš„å†…æ ¸å¼€å‘ï¼Œå¼€å‘è€…è¯·å‚è€ƒä¸‹åˆ—æ­¥éª¤è¿›è¡Œå¼€å‘:

> - [Linux å†…æ ¸é…ç½®](#C1)
>
> - [Linux å†…æ ¸ç¼–è¯‘](#C2)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------

<span id="C1"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000Q.jpg)

#### Linux å†…æ ¸é…ç½®

å¯¹äºå†…æ ¸é…ç½®ï¼Œæ ¹æ® README.md çš„æç¤ºï¼Œé…ç½®å†…æ ¸å¯ä»¥å‚è€ƒå¦‚ä¸‹å‘½ä»¤:

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make clean
make menuconfig
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000487.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------

<span id="C2"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000Y.jpg)

#### Linux å†…æ ¸ç¼–è¯‘

å†…æ ¸é…ç½®å®Œæ¯•ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç¼–è¯‘å†…æ ¸ï¼Œæ ¹æ® README.md é‡Œæä¾›çš„å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼Œ
å…·ä½“å‘½ä»¤å¦‚ä¸‹:

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make clean
make
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------

<span id="D"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000F.jpg)

#### BiscuitOS åŸºç¡€ä½¿ç”¨

åœ¨å‡†å¤‡å®Œå„ä¸ªæ¨¡å—ä¹‹åï¼Œå¼€å‘è€…å®Œæˆæœ¬èŠ‚çš„å†…å®¹ä¹‹åï¼Œå°±å¯ä»¥è¿è¡Œä¸€ä¸ªå®Œæ•´çš„ 
BiscuitOS ç³»ç»Ÿ. BiscuitOS çš„è¿è¡Œå¾ˆç®€å•, ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make start
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/BUDX000027.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------

<span id="G"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000T.jpg)

#### BiscuitOS è°ƒè¯•éƒ¨ç½²

BiscuitOS çš„ Linux å†…æ ¸ä¹Ÿæ”¯æŒå¤šç§è°ƒè¯•ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ–¹å¼å°±æ˜¯ GDB è°ƒè¯•ï¼Œå¼€å‘è€…
å¯ä»¥ä½¿ç”¨ GDB å¯¹å†…æ ¸è¿›è¡Œå•æ­¥è°ƒè¯•ã€‚Linux 0.12 å†…æ ¸ç”±äºå¯åŠ¨çš„åˆ†ä¸ºä¸åŒé˜¶æ®µï¼Œæ‰€ä»¥æ¯ä¸ª
é˜¶æ®µæœ‰ä¸åŒçš„è°ƒè¯•æ–¹æ³•ï¼Œå…·ä½“åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š

> - [bootsect.s 0x7c00 è°ƒè¯•æ–¹æ³•](#debug0)
>
> - [bootsect.s 0x90000 è°ƒè¯•æ–¹æ³•](#debug1)
>
> - [setup.s è°ƒè¯•æ–¹æ³•](#debug2)
>
> - [head.s è°ƒè¯•æ–¹æ³•](#debug3)
>
> - [main å‡½æ•°ä¹‹åè°ƒè¯•æ–¹æ³•](#debug4)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------

#### <span id="debug0">bootsect.s 0x7c00 è°ƒè¯•æ–¹æ³•</span>

i386 ä¸Šç”µè¿è¡Œå®Œ BIOS ä¹‹åï¼Œè·³è½¬åˆ° 0x7c00 å¤„æ‰§è¡Œç¬¬ä¸€è¡Œå†…æ ¸ä»£ç ï¼Œå› æ­¤å†…æ ¸è°ƒè¯•çš„åŸç‚¹
å°±æ˜¯ä» 0x7c00 å¤„å¼€å§‹ã€‚ç”±äºè¿™ä¸ªé˜¶æ®µçš„ä»£ç ä¸»è¦åœ¨ arch/x86/boot/bootsect.s é‡Œé¢ï¼Œ
è¿™ä¸ªé˜¶æ®µçš„è°ƒè¯•èŒƒå›´ä» 0x7c00 ä¸€ç›´åˆ° 0x90000ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨ GDB è¿›è¡Œè°ƒè¯•ï¼Œè°ƒè¯•æ­¥éª¤å¦‚ä¸‹ï¼š

ä½¿ç”¨ä¸¤ä¸ªç»ˆç«¯ï¼Œç¬¬ä¸€ä¸ªç»ˆç«¯ä½¿ç”¨ QEMU çš„è°ƒè¯•å·¥å…·ï¼Œå°†å†…æ ¸æŒ‚èµ·ç­‰å¾…è°ƒè¯•ï¼Œä½¿ç”¨å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make debug
{% endhighlight %}

ç¬¬äºŒä¸ªç»ˆç«¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux/arch/x86/boot/
gdb .debug_bootsect

(gdb) target remote :1234
(gdb) b *0x7c00
(gdb) c
(gdb) list
(gdb) ni
{% endhighlight %}

###### æ‰“æ–­ç‚¹

è¿™ä¸ªé˜¶æ®µçš„ä»£ç ä¸»è¦ä½äº arch/x86/boot/bootsect.s é‡Œé¢ï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹æ­¥éª¤è¿›è¡Œæ‰“æ–­ç‚¹ï¼Œéœ€è¦ä½¿ç”¨ objdump å·¥å…·ï¼Œå¦‚ä¸‹, é¦–å…ˆåœ¨ arch/x86/boot/bootsect.s æºç å†…éœ€è¦æ·»åŠ æ–­ç‚¹çš„åœ°æ–¹å¢åŠ ä»£ç ï¼Œä¾‹å¦‚:

{% highlight bash %}
_start:
+       mov %ax, %ax
+       mov %bx, %bx
        mov $BOOTSEG, %ax
        mov %ax, %ds
        mov $INITSEG, %ax
        mov %ax, %es
        mov $256, %cx
        sub %si, %si
{% endhighlight %}

å¦‚ä¸Šï¼Œéœ€è¦åœ¨ "mov $BOOTSEG, %ax" å¤„æ‰“æ–­ç‚¹ï¼Œé‚£ä¹ˆå°±åœ¨è¿™è¡Œä»£ç ä¹‹å‰æ·»åŠ ä¸¤è¡Œä»£ç 
"mov %ax, %ax" å’Œ "mov %bx, %bx", ç„¶åç¼–è¯‘å†…æ ¸ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make
{% endhighlight %}

æ¥ç€ä½¿ç”¨ objdump å·¥å…·æŸ¥çœ‹åæ±‡ç¼–ä¹‹åçš„åœ°å€ï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
objdump -sSdhx arch/x86/boot/.debug_bootsect > tmp.debs
{% endhighlight %}

åœ¨ tmp.debs é‡Œé¢æ‰¾åˆ°åˆšåˆšæ·»åŠ çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
00000005 <_start>:

_start:
        mov %ax, %ax
   5:   89 c0                   mov    %eax,%eax
        mov %bx, %bx
   7:   89 db                   mov    %ebx,%ebx
        mov $BOOTSEG, %ax
   9:   b8 c0 07 8e d8          mov    $0xd88e07c0,%eax
{% endhighlight %}

é€šè¿‡åæ±‡ç¼–çš„ç»“æœçœ‹åˆ°æ–­ç‚¹çš„åç§»æ˜¯ 5 æˆ–è€… 7 éƒ½å¯ä»¥ï¼Œå› æ­¤æœ€ç»ˆæ–­ç‚¹çš„åœ°å€æ˜¯ï¼š

> 0x7c00 + 5 = 0x7c05

åœ¨ä½¿ç”¨ä¹‹å‰çš„åŠæ³•ï¼Œä½¿ç”¨ä¸¤ä¸ªç»ˆç«¯ï¼Œç¬¬ä¸€ä¸ªç»ˆç«¯è¾“å…¥ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make debug
{% endhighlight %}

ç¬¬äºŒä¸ªç»ˆç«¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux/arch/x86/boot/
gdb .debug_bootsect

Type "apropos word" to search for commands related to "word"...
Reading symbols from .debug_bootsect...done.

(gdb) target remote :1234
Remote debugging using :1234
0x0000fff0 in ?? ()
(gdb) b *0x7c05
Breakpoint 1 at 0x7c05
(gdb) c
Continuing.

Program received signal SIGTRAP, Trace/breakpoint trap.
_start () at bootsect.s:78
78		mov %ax, %ax
(gdb) d
Delete all breakpoints? (y or n) y
(gdb) ni
79		mov %bx, %bx
(gdb) ni
80		mov $BOOTSEG, %ax
(gdb) ni
81		mov %ax, %ds
(gdb)
{% endhighlight %}

ä¸Šé¢çš„å®è·µä¸­æ³¨æ„å•æ­¥è°ƒè¯•åº”è¯¥ä½¿ç”¨ "ni", åœ¨è¿›å…¥æ–­ç‚¹ä¹‹åï¼Œåº”è¯¥ä½¿ç”¨ 'd' åˆ é™¤æ–­ç‚¹ï¼Œ
è¿™æ ·æ‰èƒ½è¿›è¡Œå•æ­¥è°ƒè¯•ã€‚å¦‚æœéœ€è¦è¿›å…¥å­ç¨‹åºï¼Œä½¿ç”¨ "si" å‘½ä»¤ã€‚è¿™ä¸ªé˜¶æ®µçš„ä»£ç è°ƒè¯•åˆ°
å†…æ ¸è·³è½¬åˆ° 0x90000 ä¸ºæ­¢ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------------

#### <span id="debug1">bootsect.s 0x90000 è°ƒè¯•æ–¹æ³•</span>

Linux 0.12 åœ¨å¯åŠ¨é˜¶æ®µä¼šå°†è‡ªå·±ä» 0x7c00 æ‹·è´åˆ° 0x90000 å¤„ç»§ç»­è¿è¡Œï¼Œè¿™ä¸ªé˜¶æ®µçš„ä»£ç 
ä¸»è¦ä½äº arch/x86/boot/bootsect.sã€‚è¿™ä¸ªé˜¶æ®µçš„ä»£ç è°ƒè¯•éœ€è¦é€šè¿‡æ‰“æ–­ç‚¹çš„æ–¹å¼è¿›è¡Œè°ƒè¯•ï¼Œ
å¯ä»¥å‚è€ƒä¸‹é¢çš„æ­¥éª¤è¿›è¡Œè°ƒè¯•:

é¦–å…ˆåœ¨ arch/x86/boot/bootsect.s é‡Œæ·»åŠ ä»£ç ï¼Œä¾‹å¦‚

{% highlight bash %}
ok_load_setup:

# Get disk dirve parameters, specifically nr of sectors/track

+        mov %ax, %ax
+        mov %bx, %bx
        mov $DEVICE_NR, %dl
        mov $0x0800, %ax
        int $0x13
        mov $0x00, %ch
{% endhighlight %}

å¦‚ä¸Šï¼Œåœ¨ "mov $DEVICE_NR, %dl" å¤„æ·»åŠ æ–­ç‚¹ï¼Œåœ¨è¯¥è¡Œä»£ç ä¹‹å‰æ·»åŠ ä¸¤è¡Œè°ƒè¯•ç”¨çš„ä»£ç 
"mov %ax, %ax" å’Œ "mov %bx, %bx"ã€‚ç„¶åç¼–è¯‘å†…æ ¸ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make
{% endhighlight %}

æ¥ç€ä½¿ç”¨ objdump å·¥å…·æŸ¥çœ‹åæ±‡ç¼–ä¹‹åçš„åœ°å€ï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
objdump -sSdhx arch/x86/boot/.debug_bootsect > tmp.debs
{% endhighlight %}

åœ¨ tmp.debs ä¸­æ‰¾åˆ°æ·»åŠ çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
ok_load_setup:

# Get disk dirve parameters, specifically nr of sectors/track

        mov %ax, %ax
  4a:   89 c0                   mov    %eax,%eax
        mov %bx, %bx
  4c:   89 db                   mov    %ebx,%ebx
        mov $DEVICE_NR, %dl
  4e:   b2 00                   mov    $0x0,%dl
        mov $0x0800, %ax
  50:   b8 00 08 cd 13          mov    $0x13cd0800,%eax
{% endhighlight %}

ä»åæ±‡ç¼–çš„ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæ·»åŠ è°ƒè¯•ä»£ç çš„åç§»æ˜¯ 0x4a, é‚£ä¹ˆæ–­ç‚¹çš„åœ°å€æ˜¯ï¼š

> 0x90000 + 0x4a = 0x9004a

åœ¨ä½¿ç”¨ä¹‹å‰çš„åŠæ³•ï¼Œä½¿ç”¨ä¸¤ä¸ªç»ˆç«¯ï¼Œç¬¬ä¸€ä¸ªç»ˆç«¯è¾“å…¥ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make debug
{% endhighlight %}

ç¬¬äºŒä¸ªç»ˆç«¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux/arch/x86/boot/
gdb .debug_bootsect

Type "apropos word" to search for commands related to "word"...
Reading symbols from .debug_bootsect...done.

(gdb) target remote :1234
Remote debugging using :1234
0x0000fff0 in ?? ()
(gdb) b *0x9004a
Breakpoint 1 at 0x9004a
(gdb) c
Continuing.

Program received signal SIGTRAP, Trace/breakpoint trap.
ok_load_setup () at bootsect.s:121
121		mov %ax, %ax
(gdb) d
Delete all breakpoints? (y or n) y
(gdb) ni
122		mov %bx, %bx
(gdb) ni
123		mov $DEVICE_NR, %dl
(gdb) ni
124		mov $0x0800, %ax
(gdb)
{% endhighlight %}

é€šè¿‡ä¸Šé¢çš„æ–¹æ³•ï¼Œè¿™ä¸ªé˜¶æ®µå…¶ä»–ä»£ç å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è°ƒè¯•ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------------

#### <span id="debug2">setup.s è°ƒè¯•æ–¹æ³•</span>

Linux 0.12 å†…æ ¸æ‰§è¡Œå®Œ bootsect.s æ±‡ç¼–ä»£ç ä¹‹åï¼Œæ¥ä¸‹æ¥æ‰§è¡Œçš„ä»£ç ä½äº
arch/x86/boot/setup.s æ–‡ä»¶ï¼Œæ ¹æ®åŸç†å¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ªé˜¶æ®µå†…æ ¸ä» 0x90200 å¤„å¼€å§‹
æ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µä»£ç è°ƒè¯•ä¹Ÿä½¿ç”¨æ–­ç‚¹è°ƒè¯•ï¼ŒæŒ‰å¦‚ä¸‹æ­¥éª¤è¿›è¡Œï¼š

é¦–å…ˆåœ¨ arch/x86/boot/setup.s é‡Œæ·»åŠ ä»£ç ï¼Œä¾‹å¦‚

{% highlight bash %}
        ljmp $SETUPSEG, $_start
_start:

# ok, the read went well so we get current cursor position and save it for
# posterity.

        mov     %ax, %ax
        mov     %bx, %bx
        mov     $INITSEG, %ax   # this is done in bootsect already, but...
        mov     %ax, %ds
        mov     $0x03, %ah      # read cursor pos
        xor     %bh, %bh
        int     $0x10           # save it in known place, con_init fetches
{% endhighlight %}

å¦‚ä¸Šï¼Œåœ¨ "mov     $INITSEG, %ax" å¤„æ·»åŠ æ–­ç‚¹ï¼Œåœ¨è¯¥è¡Œä»£ç ä¹‹å‰æ·»åŠ ä¸¤è¡Œè°ƒè¯•ç”¨çš„ä»£ç 
"mov %ax, %ax" å’Œ "mov %bx, %bx"ã€‚ç„¶åç¼–è¯‘å†…æ ¸ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make
{% endhighlight %}

æ¥ç€ä½¿ç”¨ objdump å·¥å…·æŸ¥çœ‹åæ±‡ç¼–ä¹‹åçš„åœ°å€ï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
objdump -sSdhx arch/x86/boot/.debug_setup > tmp.debs
{% endhighlight %}

åœ¨ tmp.debs ä¸­æ‰¾åˆ°æ·»åŠ çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
00000005 <_start>:
_start:

# ok, the read went well so we get current cursor position and save it for
# posterity.

        mov     %ax, %ax
   5:   89 c0                   mov    %eax,%eax
        mov     %bx, %bx
   7:   89 db                   mov    %ebx,%ebx
        mov     $INITSEG, %ax   # this is done in bootsect already, but...
   9:   b8 00 90 8e d8          mov    $0xd88e9000,%eax
        mov     %ax, %ds
{% endhighlight %}

ä»åæ±‡ç¼–çš„ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæ·»åŠ è°ƒè¯•ä»£ç çš„åç§»æ˜¯ 0x5, é‚£ä¹ˆæ–­ç‚¹çš„åœ°å€æ˜¯ï¼š

> 0x90200 + 0x5 = 0x90205

åœ¨ä½¿ç”¨ä¹‹å‰çš„åŠæ³•ï¼Œä½¿ç”¨ä¸¤ä¸ªç»ˆç«¯ï¼Œç¬¬ä¸€ä¸ªç»ˆç«¯è¾“å…¥ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make debug
{% endhighlight %}

ç¬¬äºŒä¸ªç»ˆç«¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux/arch/x86/boot/
gdb .debug_setup

Type "apropos word" to search for commands related to "word"...
Reading symbols from .debug_setup...done.

(gdb) target remote :1234
Remote debugging using :1234
0x0000fff0 in ?? ()
(gdb) b *0x90205
Breakpoint 1 at 0x90205
(gdb) c
Continuing.

Program received signal SIGTRAP, Trace/breakpoint trap.
_start () at setup.s:47
47		mov	%ax, %ax
(gdb) d
Delete all breakpoints? (y or n) y
(gdb) ni
48		mov	%bx, %bx
(gdb) ni
49		mov	$INITSEG, %ax	# this is done in bootsect already, but...
(gdb) ni
50		mov	%ax, %ds
(gdb)
{% endhighlight %}

é€šè¿‡ä¸Šé¢çš„æ–¹æ³•ï¼Œè¿™ä¸ªé˜¶æ®µå…¶ä»–ä»£ç å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è°ƒè¯•ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------------

#### <span id="debug3">head.s è°ƒè¯•æ–¹æ³•</span>

Linux 0.12 åœ¨è¿›è¡ŒåŸºæœ¬åˆå§‹åŒ–ä¹‹åï¼Œå°±è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œå¼€å¯åˆ†é¡µåŠŸèƒ½ï¼Œè¿™ä¸ªé˜¶æ®µçš„ä¹ŸåŒ…å«äº†
ä¸€éƒ¨åˆ†æ±‡ç¼–ä»£ç ï¼Œä½äº arch/x86/boot/head.s æ–‡ä»¶é‡Œé¢ã€‚ç”± Linux 0.12 çš„åŸç†å¯ä»¥
çŸ¥é“ï¼Œè¿™ä¸ªé˜¶æ®µå†…æ ¸å°†è‡ªå·±ç§»åŠ¨åˆ° 0x00000000 å¤„å¹¶ä»è¿™é‡Œå¼€å§‹æ‰§è¡Œã€‚è¿™ä¸ªé˜¶æ®µçš„è°ƒè¯•åˆ°è¿›
å…¥ main() å‡½æ•°ä¸ºæ­¢ã€‚æ‰€ä»¥è¿™ä¸ªé˜¶æ®µä»£ç è°ƒè¯•ä¹Ÿä½¿ç”¨æ–­ç‚¹è°ƒè¯•ï¼ŒæŒ‰å¦‚ä¸‹æ­¥éª¤è¿›è¡Œï¼š

é¦–å…ˆåœ¨ arch/x86/boot/head.s é‡Œæ·»åŠ ä»£ç ï¼Œä¾‹å¦‚

{% highlight bash %}
startup_32:
+        mov %ax, %ax
+        mov %bx, %bx
        movl $0x10, %eax  # 0x10, Global data segment.
        mov %ax, %ds
        mov %ax, %es

{% endhighlight %}

å¦‚ä¸Šï¼Œåœ¨ "movl $0x10, %eax" å¤„æ·»åŠ æ–­ç‚¹ï¼Œåœ¨è¯¥è¡Œä»£ç ä¹‹å‰æ·»åŠ ä¸¤è¡Œè°ƒè¯•ç”¨çš„ä»£ç 
"mov %ax, %ax" å’Œ "mov %bx, %bx"ã€‚ç„¶åç¼–è¯‘å†…æ ¸ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make
{% endhighlight %}

æ¥ç€ä½¿ç”¨ objdump å·¥å…·æŸ¥çœ‹åæ±‡ç¼–ä¹‹åçš„åœ°å€ï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
objdump -sSdhx vmlinux > tmp.debs
{% endhighlight %}

åœ¨ tmp.debs ä¸­æ‰¾åˆ°æ·»åŠ çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
pg_dir:
        .globl startup_32

startup_32:
        mov %ax, %ax
       0:       66 89 c0                mov    %ax,%ax
        mov %bx, %bx
       3:       66 89 db                mov    %bx,%bx
        movl $0x10, %eax  # 0x10, Global data segment.
       6:       b8 10 00 00 00          mov    $0x10,%eax
        mov %ax, %ds
       b:       8e d8                   mov    %eax,%ds
{% endhighlight %}

ä»åæ±‡ç¼–çš„ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæ·»åŠ è°ƒè¯•ä»£ç çš„åç§»æ˜¯ 0x3, é‚£ä¹ˆæ–­ç‚¹çš„åœ°å€æ˜¯ï¼š

> 0x00000000 + 0x3 = 0x3

åœ¨ä½¿ç”¨ä¹‹å‰çš„åŠæ³•ï¼Œä½¿ç”¨ä¸¤ä¸ªç»ˆç«¯ï¼Œç¬¬ä¸€ä¸ªç»ˆç«¯è¾“å…¥ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make debug
{% endhighlight %}

ç¬¬äºŒä¸ªç»ˆç«¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux/
gdb vmlinux

Type "apropos word" to search for commands related to "word"...
Reading symbols from vmlinux...done.

(gdb) target remote :1234
Remote debugging using :1234
0x0000fff0 in do_divide_error (esp=0, error_code=0) at kernel/traps.c:97
97		die("divide error", esp, error_code);
(gdb) b *0x3
Breakpoint 1 at 0x3: file arch/x86/boot/head.s, line 27.
(gdb) c
Continuing.

Breakpoint 1, startup_32 () at arch/x86/boot/head.s:27
27		mov %bx, %bx
(gdb) d
Delete all breakpoints? (y or n) y
(gdb) ni
28		movl $0x10, %eax  # 0x10, Global data segment.
(gdb) ni
29		mov %ax, %ds
(gdb)
{% endhighlight %}

é€šè¿‡ä¸Šé¢çš„æ–¹æ³•ï¼Œè¿™ä¸ªé˜¶æ®µå…¶ä»–ä»£ç å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è°ƒè¯•ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

------------------------------------------------

#### <span id="debug4">main å‡½æ•°ä¹‹åè°ƒè¯•æ–¹æ³•</span>

é¦–å…ˆä½¿ç”¨ QEMU çš„è°ƒè¯•å·¥å…·ï¼Œå°†å†…æ ¸æŒ‚èµ·ç­‰å¾…è°ƒè¯•ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
make debug
{% endhighlight %}

![LINUXP](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/BUDX000024.png)

æ¥ç€åœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯ä¸­è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œä½œä¸º gdb server

{% highlight bash %}
cd BiscuitOS/output/linux-0.12/linux/linux
gdb vmlinux
{% endhighlight %}

è¾“å…¥ä»¥ä¸Šå‘½ä»¤ä¹‹åï¼Œåœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸­ï¼Œä¼šè¿›å…¥ gdb æ¨¡å¼ï¼Œæ­¤æ—¶ä»¥æ­¤è¾“å…¥ä¸€ä¸‹å‘½åè¿›è¡Œ
gdb æŒ‚è½½ï¼š

{% highlight bash %}
(gdb) target remote :1234
{% endhighlight %}

ç„¶åå¼€å‘è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œå†…æ ¸è°ƒè¯•ï¼Œæ¯”å¦‚åœ¨ main å‡ºæ·»åŠ ä¸€ä¸ªæ–­ç‚¹è°ƒè¯•ï¼Œå¦‚ä¸‹ï¼š

{% highlight bash %}
(gdb) b main
(gdb) c
(gdb) list
(gdb) info reg
{% endhighlight %}

![LINUXP](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/BUDX000025.png)

![LINUXP](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/BUDX000026.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="Z">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Catalogue](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)

#### æèµ ä¸€ä¸‹å§ ğŸ™‚

![MMU](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
