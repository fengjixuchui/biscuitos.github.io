---
layout: post
title:  "CMA: å¤šå— CMA åŒºåŸŸé—®é¢˜ç ”ç©¶"
date:   2019-12-20 09:23:30 +0800
categories: [HW]
excerpt: CMA hole.
tags:
  - [CMA]
---

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

## ç›®å½•

> - [CMA å¤šå—åŒºåŸŸåŸç†](#A0)
>
> - [å®è·µéƒ¨ç½²](#B0)
>
>   - [å®è·µåŸºç¡€éƒ¨ç½²](#B01)
>
>   - [å®è·µç”¨ä¾‹éƒ¨ç½²](#B02)
>
>   - [å®è·µç¼–è¯‘éƒ¨ç½²](#B03)
>
>   - [å®è·µè¿è¡Œéƒ¨ç½²](#B04)
>
>   - [å®è·µæºç åˆ†æ](#B05)
>
> - [é™„å½•](#Z0)

----------------------------------

<span id="A0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000P.jpg)

#### CMA å¤šå—åŒºåŸŸåŸç†

CMA åˆ†é…å™¨ä½¿ç”¨ cma_areas[] æ•°ç»„ç»´æŠ¤æ‰€æœ‰å¯ç”¨çš„ CMA åŒºåŸŸã€‚CMA åˆ†é…å™¨å¯ä»¥
æŒ‡å®šé©±åŠ¨ä½¿ç”¨ç‰¹å®šçš„ CMA åŒºåŸŸã€‚å› æ­¤æœ¬æ–‡é‡ç‚¹è®¨è®ºå¦‚ä½•åœ¨å†…æ ¸ä¸­æ”¯æŒ CMA å¤š
åŒºåŸŸä»¥åŠé©±åŠ¨å¦‚ä½•ä½¿ç”¨ç‰¹å®šçš„ CMA åŒºåŸŸã€‚

###### CMA å¤šåŒºåŸŸæ”¯æŒåŸç†

å†…æ ¸å¯ä»¥é‡‡ç”¨å¤šç§æ–¹æ¡ˆé…ç½®ä¸€å—æ–°çš„ CMA åŒºåŸŸï¼Œè¿™åŒ…æ‹¬äº†ä¸‹é¢ä¸‰ç§æ–¹æ³•:

> - [CMA é…ç½®å®è·µä¹‹ DTS](https://biscuitos.github.io/blog/CMA-layout/#C02)
>
> - [CMA é…ç½®å®è·µä¹‹ CMDLINE](https://biscuitos.github.io/blog/CMA-layout/#C03)
>
> - [CMA é…ç½®å®è·µä¹‹ Kbuild](https://biscuitos.github.io/blog/CMA-layout/#C04)

æ¯ç§æ–¹æ¡ˆå„æœ‰åˆ©å¼Šï¼Œå…¶ä¸­ DTS çš„æ–¹æ¡ˆå¯ä»¥æ”¯æŒå¤šå— CMA åŒºåŸŸçš„å»ºç«‹ï¼Œå› æ­¤å¯ä»¥
é‡‡ç”¨ DTS çš„æ–¹æ¡ˆæ¥æ”¯æŒå¤šå— CMA åŒºåŸŸã€‚

###### é©±åŠ¨ä½¿ç”¨ CMA åŸç†

åœ¨å†…æ ¸ä¸­ï¼Œæ¯ä¸ªé©±åŠ¨éƒ½æ˜¯é€šè¿‡è®¾å¤‡è¿›è¡Œæè¿°ï¼Œæ¯ä¸ªè®¾å¤‡ä½¿ç”¨ struct device 
æ•°æ®ç»“æ„è¿›è¡Œæè¿°ï¼Œå…¶ä¸­åŒ…å«äº† cma_area æˆå‘˜ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥æˆå‘˜ç”¨äº
æŒ‡å‘ä¸€ä¸ª CMA åŒºåŸŸã€‚åˆ†é…è¿ç»­ç‰©ç†å†…å­˜çš„æ—¶å€™ï¼ŒCMA åˆ†é…å™¨å°±ä¼šæ ¹æ®è®¾å¤‡
çš„ cma_area æˆå‘˜æä¾›çš„ä¿¡æ¯æ‰¾åˆ°æŒ‡å®šçš„ CMA åŒºåŸŸï¼Œç„¶åä»ä¸­åˆ†é…å’Œé‡Šæ”¾
è¿ç»­ç‰©ç†å†…å­˜èµ„æºã€‚å› æ­¤è¦è®©é©±åŠ¨ä½¿ç”¨æŒ‡å®šçš„ CMA åŒºåŸŸï¼Œåªè¦è®¾ç½®è®¾å¤‡
struct device çš„ cma_area æˆå‘˜å³å¯

----------------------------------

<span id="B0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L.jpg)

## å®è·µéƒ¨ç½²

> - [å®è·µåŸºç¡€éƒ¨ç½²](#B01)
>
> - [å®è·µç”¨ä¾‹éƒ¨ç½²](#B02)
>
> - [å®è·µç¼–è¯‘éƒ¨ç½²](#B03)
>
> - [å®è·µè¿è¡Œéƒ¨ç½²](#B04)
>
> - [å®è·µæºç åˆ†æ](#B05)

---------------------------------

#### <span id="B01">å®è·µåŸºç¡€éƒ¨ç½²</span>

æœ¬æ–‡æ”¯æŒåœ¨ BiscuitOS ä¸Šå®è·µ CMA ç¢ç‰‡é—®é¢˜ï¼Œå¦‚æœè¿˜æ²¡æœ‰æ­å»º BiscuitOS 
å¼€å‘ç¯å¢ƒï¼Œå¯ä»¥ä¸‹åˆ—æ–‡ç« :

> - [BiscuitOS å¿«é€Ÿéƒ¨ç½²(åŸºäº linux 5.0)](https://biscuitos.github.io/blog/Linux-5.0-arm32-Usermanual/)

----------------------------

#### <span id="B02">å®è·µç”¨ä¾‹éƒ¨ç½²</span>

å¦‚æœå·²ç»æ­å»ºå¥½ BiscuitOS å¼€å‘ç¯å¢ƒï¼Œæœ¬æ–‡å®è·µéƒ¨ç½²å¦‚ä¸‹:

{% highlight c %}
cd BiscuitOS
make linux-5.0-arm32_defconfig
make menuconfig 
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000003.png)

é€‰æ‹© "Package" å¹¶è¿›å…¥äºŒçº§èœå•.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000041.png)

é€‰æ‹© "CMA: Contiguous Memory Allocator --->" å¹¶è¿›å…¥äºŒçº§èœå•.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000194.png)

é€‰æ‹© "CMA on special Area Application  --->" å’Œ 
"CMA on special Area Device Driver Module  --->" å¹¶ä¿å­˜é€€å‡ºã€‚æ¥ç€
ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

{% highlight c %}
make
cd BiscuitOS/output/linux-5.0-arm32/package/
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000007.png)

------------------------------------

#### <span id="B03">å®è·µç¼–è¯‘éƒ¨ç½²</span>

è¿™é‡Œå‡†å¤‡äº†å¯¹åº”çš„é©±åŠ¨ç¨‹åºå’Œåº”ç”¨ç¨‹åºï¼Œå¼€å‘è€…å‚è€ƒä¸‹é¢æ­¥éª¤è¿›è¡Œç¼–è¯‘å®‰è£…:

> - [é©±åŠ¨ç¨‹åº](#B0001)
>
> - [åº”ç”¨ç¨‹åº](#B0002)

-------------------------------------

###### <span id="B0001">é©±åŠ¨ç¨‹åº</span>

é©±åŠ¨ç¨‹åºç”¨äºä¸ºç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºæä¾› CMA ç”³è¯·çš„æ¥å£ï¼Œå…¶ä½¿ç”¨å¦‚ä¸‹:

{% highlight c %}
cd BiscuitOS/output/linux-5.0-arm32/package/CMA_area_module-0.0.1
make prepare
make download
{% endhighlight %}

æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤ä¹‹åï¼ŒBiscuitOS ä¼šä¸‹è½½æŒ‡å®šçš„æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000195.png)

è·å¾—ä¸Šé¢çš„æ–‡ä»¶ä¹‹åï¼Œå¼€å‘è€…é¦–å…ˆæ ¹æ® "00001-CMA-special-areas.patch" è¡¥ä¸
ä¸­çš„å†…å®¹ï¼Œå¯¹å†…æ ¸è¿›è¡Œæ‰‹åŠ¨è¡¥ä¸æˆ–è‡ªåŠ¨è¡¥ä¸ï¼Œå…¶ä¿®æ”¹å†…å®¹å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000044.png)

ä»è¡¥ä¸çš„å†…å®¹å¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆå°† "dma_alloc_from_contiguous" å’Œ
"dma_release_from_contiguous" ä¸¤ä¸ªå‡½æ•°ä½¿ç”¨ "EXPORT_SYMBOL()" å®
è¿›è¡Œå¯¼å‡ºï¼Œä»¥ä¾¿ä¾›å¤–éƒ¨æ¨¡å—ä½¿ç”¨ã€‚æ¥ç€åœ¨ "mm/cma.c" æ–‡ä»¶ä¸­æ·»åŠ äº†
ä¸€ä¸ªå‡½æ•° "find_cma_by_name()" å…¶ä½œç”¨æ˜¯é€šè¿‡åå­—ç›´åˆ°æŒ‡å®šçš„ cma
åŒºå—å¯¹åº”çš„ç»“æ„ä½“. æ¥ç€æ˜¯ "default.dts" æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ç”¨æˆ·æè¿°
è¯¥é©±åŠ¨çš„ DTS èŠ‚ç‚¹ä»¥åŠ CMA åŒºå—çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000196.png)

å¼€å‘è€…å‚è€ƒä¸Šé¢çš„å†…å®¹æ·»åŠ åˆ°å†…æ ¸çš„ DTS æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚æœ¬ä¾‹å­ä¸­
ä½¿ç”¨çš„ DTS ä½äº:

{% highlight c %}
vi BiscuitOS/output/linux-5.0-arm32/linux/linux-5.0/arch/arm/boot/dts/vexpress-v2p-ca9.dts
{% endhighlight %}

å¼€å‘è€…å‚è€ƒä¸Šé¢çš„ DTS ä¹‹åï¼Œåœ¨é¡¹ç›®çš„ DTS æ–‡ä»¶ä¸­æ‰¾åˆ° reserved-memory èŠ‚ç‚¹ï¼Œ
ç„¶åå‘è¯¥èŠ‚ç‚¹ä¸­åˆ†åˆ«æ·»åŠ  "linux,cma" å’Œ "BiscuitOS_cma" ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå…¶èŠ‚ç‚¹
å±æ€§ä¸å›¾ä¸­çš„é…ç½®ä¸€è‡´ã€‚æœ€åæ‰“å®Œè¡¥ä¸å’Œæ·»åŠ å®Œ patch ä¹‹åï¼Œå¼€å‘è€…éœ€è¦é‡æ–°
ç¼–è¯‘å†…æ ¸ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹å‘½ä»¤:

{% highlight c %}
cd BiscuitOS/output/linux-5.0-arm32/linux/linux-5.0/
make ARCH=arm CROSS_COMPILE=BiscuitOS/output/linux-5.0-arm32/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- -j4
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000046.png)

æ¥ç€ç¼–è¯‘é©±åŠ¨å’Œå®‰è£…æ¨¡å—åˆ° BiscuitOSï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

{% highlight c %}
cd BiscuitOS/output/linux-5.0-arm32/package/CMA_area_module-0.0.1
make clean
make
make install
make pack
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000197.png)

æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤ä¹‹åï¼Œé©±åŠ¨å·²ç»æˆåŠŸå®‰è£…åˆ° BiscuitOSï¼Œæ¥ç€åªè¦åœ¨
BiscuitOS ç³»ç»Ÿè¿è¡Œçš„æ—¶å€™å®‰è£…å°±è¡Œã€‚æ¥ä¸‹æ¥æ˜¯å®‰è£…é©±åŠ¨å¯¹åº”çš„åº”ç”¨ç¨‹åºã€‚

-----------------------------------

###### <span id="B0002">åº”ç”¨ç¨‹åº</span>

åº”ç”¨ç¨‹åºä¸é©±åŠ¨ç¨‹åºé…åˆï¼Œç›®çš„æ˜¯ä» CMA ä¸­è·å¾—è¿ç»­ç‰©ç†å†…å­˜ã€‚ä»åº”ç”¨ç¨‹åº
è§’åº¦çœ‹ï¼Œåº”ç”¨ç¨‹åºå¹¶ä¸å…³ç³»ç‰©ç†åœ°å€æ¥è‡ªå“ªå— CMA åŒºåŸŸï¼Œåªå…³ç³»ä» CMA ä¸­
åˆ†é…åˆ°è¿ç»­ç‰©ç†å†…å­˜å³å¯ã€‚å¼€å‘è€…é¦–å…ˆæŒ‰ç…§ä¸‹åˆ—æ­¥éª¤éƒ¨ç½²åº”ç”¨ç¨‹åº:

{% highlight c %}
cd BiscuitOS/output/linux-5.0-arm32/package/CMA_area_app-0.0.1
make download
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000198.png)

åœ¨è·å¾—æºç ä¹‹åï¼Œå¼€å‘è€…ç»§ç»­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å°†åº”ç”¨ç¨‹åºæºç è¿›è¡Œç¼–è¯‘ã€å®‰è£…
å’Œæ‰“åŒ…åˆ° BiscuitOS ç³»ç»Ÿé‡Œ:

{% highlight c %}
make clean
make
make install
make pack
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000199.png)

---------------------------------

#### <span id="B04">å®è·µè¿è¡Œéƒ¨ç½²</span>

åœ¨å‡†å¤‡å¥½é©±åŠ¨å’Œåº”ç”¨ç¨‹åºä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯åœ¨ BiscuitOS ä¸Šé¢ä½¿ç”¨å³å¯ã€‚
å¼€å‘è€…ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨ BiscuitOS:

{% highlight c %}
cd BiscuitOS/output/linux-5.0-arm32/
./RunBiscuitOS.sh
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000200.png)

æ¥ç€å®‰è£…é©±åŠ¨:

{% highlight c %}
cd lib/modules/5.0.0/extra/
insmod cma.ko
lsmod
ls -l /dev/CMA_demo
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000201.png)

å®‰è£…å®Œæ¯•é©±åŠ¨ä¹‹åï¼Œå¯ä»¥åœ¨ "/dev" ç›®å½•ä¸‹æŸ¥çœ‹å½“å‰è·å¾— CMA_demo èŠ‚ç‚¹ã€‚
è¿è¡Œåº”ç”¨ç¨‹åº:

{% highlight c %}
CMA_area_app-0.0.1
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000202.png)

ç”±ä¸Šå›¾å¯ä»¥çœ‹åˆ°åº”ç”¨ç¨‹åºä» CMA ä¸­åˆ†é…çš„å†…å­˜èµ·å§‹åœ°å€æ˜¯ 0x69300000ï¼Œè¯¥åœ°å€
ä½äº BiscuitOS_cma åŒºåŸŸå†…ã€‚å› æ­¤å®è·µæˆåŠŸã€‚

---------------------------------

#### <span id="B05">å®è·µæºç åˆ†æ</span>

æºç åˆ†ä½œé©±åŠ¨éƒ¨åˆ†å’Œåº”ç”¨ç¨‹åºéƒ¨åˆ†ï¼Œé©±åŠ¨æºç ä½äº:

{% highlight c %}
BiscuitOS/output/linux-5.0-arm32/package/CMA_area_module-0.0.1/CMA_area_module-0.0.1/cma.c
{% endhighlight %}

é©±åŠ¨ä¸­æŒ‡å®š CMA åŒºåŸŸçš„æ ¸å¿ƒä»£ç å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000203.png)


åº”ç”¨ç¨‹åºæºç ä½äº:

{% highlight c %}
/xspace/OpenSource/BiscuitOS/BiscuitOS/output/linux-5.0-arm32/package/CMA_area_app-0.0.1/CMA_area_app-0.0.1/cma.c
{% endhighlight %}

é©±åŠ¨ç¨‹åºçš„ä¸»è¦é€šè¿‡åº”ç”¨ç¨‹åº ioctl å‘é€å‘½ä»¤ "CMA_MEM_ALLOCATE" å’Œ
"CMA_MEM_RELEASE" å‘Šè¯‰é©±åŠ¨ç¨‹åºè¿›è¡Œ CMA åˆ†é…å’Œé‡Šæ”¾ï¼Œé©±åŠ¨ç¨‹åºè¿›è€Œè°ƒç”¨
"dma_alloc_from_contiguous()" å‡½æ•°å’Œ "dma_release_from_contiguous()" å‡½æ•°
è¿›è¡Œè¿›è¡Œ CMA çš„åˆ†é…å’Œé‡Šæ”¾åŠ¨ä½œã€‚

-----------------------------------------------

# <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>
> [CMA](https://biscuitos.github.io/blog/CMA)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
