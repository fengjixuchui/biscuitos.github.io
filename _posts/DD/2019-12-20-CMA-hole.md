---
layout: post
title:  "CMA ç¢ç‰‡é—®é¢˜ç ”ç©¶"
date:   2019-12-20 09:23:30 +0800
categories: [HW]
excerpt: CMA hole.
tags:
  - [CMA]
---

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

## ç›®å½•

> - [CMA ç¢ç‰‡åŸç†](#A0)
>
>   - [CMA ç¢ç‰‡é—®é¢˜æè¿°](#A0001)
>
>   - [CMA ç¢ç‰‡é—®é¢˜åŸå› ](#A0002)
>
>   - [CMA ç¢ç‰‡è§£å†³åŠæ³•](#A0003)
>
> - [å®è·µéƒ¨ç½²](#B0)
>
>   - [å®è·µåŸºç¡€éƒ¨ç½²](#B01)
>
>   - [å®è·µç”¨ä¾‹éƒ¨ç½²](#B02)
>
>   - [å®è·µç¼–è¯‘éƒ¨ç½²](#B03)
>
>   - [å®è·µè¿è¡Œéƒ¨ç½²](#B04)
>
>   - [å®è·µæºç åˆ†æ](#B05)
>
> - [ç ”ç©¶åˆ†æ](#C0)
>
> - [å®è·µç»“è®º](#D0)
>
> - [é™„å½•](#Z0)

----------------------------------

<span id="A0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000P.jpg)

#### CMA ç¢ç‰‡åŸç†

> - [CMA ç¢ç‰‡é—®é¢˜æè¿°](#A0001)
>
> - [CMA ç¢ç‰‡é—®é¢˜åŸå› ](#A0002)
>
> - [CMA ç¢ç‰‡è§£å†³åŠæ³•](#A0003)

-----------------------------------

#### <span id="A0001">CMA ç¢ç‰‡é—®é¢˜æè¿°</span>

CMA æ˜¯ linux åŸºäº Buddy å†…å­˜åˆ†é…å™¨å®ç°çš„ä¸€ç§ç”¨äºåˆ†é…è¿ç»­ç‰©ç†å†…å­˜çš„åˆ†é…å™¨ï¼Œ
å…¶å‡ºç°æ˜¯ä¸ºäº†æ»¡è¶³æ—¥ç›Šå¢é•¿çš„è§†é¢‘è½¬ç ã€AI è§†é¢‘å¤„ç†ç­‰ä¸šåŠ¡å¯¹è¿ç»­ç‰©ç†å†…å­˜çš„è¿«åˆ‡
éœ€æ±‚ï¼ŒCMA çš„å‡ºç°æå¤§çš„æ»¡è¶³äº†è¿™ç±»ä¸šåŠ¡çš„éœ€æ±‚ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥çš„è¯¸å¤šé—®é¢˜ï¼Œä¾‹å¦‚
æœ¬æ–‡ç ”ç©¶çš„ç¢ç‰‡é—®é¢˜ã€‚

CMA å†…å­˜çš„åˆ†é…å™¨é€šè¿‡ bitmap è¿›è¡Œç®¡ç†ï¼Œä¸€ä¸ª bit ä»£è¡¨ä¸€ä¸ª 4K å¤§å°çš„è¿ç»­ç‰©ç†
å†…å­˜ï¼ŒCMA å°†åˆ†é…çš„ 4K ç‰©ç†å†…å­˜å—åœ¨å¯¹åº”çš„ bit ä¸Šç½®ä½ï¼Œè€Œåœ¨ä¸ºåˆ†é…çš„ 4K ç‰©ç†
å†…å­˜å—å¯¹åº”çš„ bit ä¸Šæ¸…é›¶ã€‚å› æ­¤ CMA åˆ†é…ç‰©ç†å†…å­˜æ—¶é€šè¿‡å† bitmap æ‰¾åˆ°ç¬¦åˆ
è¦æ±‚çš„ç©ºé—²åŒºåŸŸï¼Œå½“é‡Šæ”¾å†…å­˜çš„æ—¶å€™å°±å°†å¯¹äºçš„ bit æ¸…é›¶å³å¯ï¼Œç®€å•é«˜æ•ˆã€‚

åŸºäºä¸Šé¢çš„åˆ†é…ç­–ç•¥ï¼Œä¸éš¾å‘ç°ï¼Œæ¯æ¬¡ç”³è¯·ç‰©ç†å†…å­˜çš„æ—¶å€™ï¼ŒCMA æ€»æ˜¯ä» bitmap
çš„å…¶å®åœ°å€å¼€å§‹æŸ¥æ‰¾ç¬¬ä¸€å—å¯ç”¨çš„ç‰©ç†å†…å­˜åŒºå—ã€‚è¿™æ ·çš„é€»è¾‘ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œ
ä½†éšç€æ—¶é—´çš„å¢é•¿ï¼ŒCMA ç»è¿‡æ— æ•°æ¬¡çš„åˆ†é…å’Œé‡Šæ”¾æ“ä½œä¹‹åï¼ŒCMA å†…å­˜åŒºå—è¢«
åˆ†æˆäº†é›¶æ•£çš„å¤šå—åŒºåŸŸï¼Œæœ€å¤§å¯ç”¨è¿ç»­ç‰©ç†å†…å­˜ä¹Ÿå˜çš„å¾ˆå°ã€‚ä¾‹å¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000039.png)

CMA åœ¨æœªä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œæœ€é•¿å¯ç”¨ç‰©ç†å†…å­˜å³ CMA åŒºå—çš„é•¿åº¦ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000040.png)

CMA ç»è¿‡æ— æ•°æ¬¡åˆ†é…å’Œé‡Šæ”¾æ“ä½œä¹‹åï¼ŒCMA å†…å­˜åŒºå—å·²ç»å˜å¾—é›¶é›¶ç¢ç¢ï¼Œ
æœ€é•¿å¯ç”¨ç‰©ç†å†…å­˜å·²ç»å˜å¾—å¾ˆçŸ­å¾ˆçŸ­ã€‚

åœ¨é•¿æ—¶é—´è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå½“ç³»ç»Ÿéœ€è¦åˆ†é…çš„è¿ç»­ç‰©ç†
å†…å­˜å—ä¸ç®—å¤ªé•¿ï¼Œä½†å·²ç»è¶…è¿‡å½“å‰ CMA å¯åˆ†é…æœ€é•¿ç‰©ç†å†…å­˜åŒºå—ï¼Œé‚£ä¹ˆè¿™å°†
å¯¼è‡´ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜: CMA åˆ†é…å¤±è´¥ã€‚è¿™é‡Œå°†è¿™ä¸ªé—®é¢˜æˆä¸º CMA ç¢ç‰‡é—®é¢˜ã€‚
å¼€å‘è€…å¯ä»¥å‚è€ƒé“¾æ¥ä¸­çš„å†…å­˜å®è·µå¹¶æµ®ç°å›¾ç‰‡ä¸­æ¶‰åŠçš„é—®é¢˜:

> - [CMA ç¢ç‰‡é—®é¢˜å®è·µä¸å¤ç°](#B0)

-----------------------------------

#### <span id="A0002">CMA ç¢ç‰‡é—®é¢˜åŸå› </span>

CMA æ˜¯åŸºäº buddy çš„è¿ç»­ç‰©ç†å†…å­˜åˆ†é…å™¨ï¼Œä»è¿™ä¸ªå®šä¹‰å°±å¯ä»¥çŸ¥é“ï¼ŒCMA åˆ†é…
çš„ç‰©ç†å†…å­˜æ˜¯ä¸èƒ½å°†ç©ºé—²çš„ç‰©ç†å—è¿›è¡Œè¿ç§»åˆå¹¶ï¼ŒåŸºäºè¿™ä¸ªåŸç†ï¼Œå¦‚æœé‡ä¸Šä¸‹é¢
è¿™ç§æƒ…å†µï¼Œç¢ç‰‡å¾ˆå®¹æ˜“é•¿ç”Ÿ:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000060.png)

å¦‚ä¸Šå›¾ï¼Œ"1)" ä¸­ CMA åŸæœ‰ 1M çš„å¯ç”¨è¿ç»­ç‰©ç†åŒºå—; "2)" ç³»ç»Ÿé¦–å…ˆç”³è¯·äº†ä¸€å—
ç›¸å¯¹è¾ƒå¤§çš„å†…å­˜åŒºå— Aï¼Œæ¥ç€æœ‰ç”³è¯·ä¸€å—å°çš„å†…å­˜åŒºå—ï¼Œæ ¹æ® CMA çš„åˆ†é…ç­–ç•¥ï¼Œ
å®ƒä¼šä» bitmap çš„èµ·å§‹å¤„å¼€å§‹æ‰¾ç¬¦åˆè¦æ±‚å¤§å°çš„ç‰©ç†å†…å­˜åŒºå—ï¼Œæ­£å·§åŒºå— A ä¹‹å
å°±æ˜¯ç¬¦åˆè¦æ±‚çš„ç‰©ç†å†…å­˜åŒºå—ï¼Œäºæ˜¯åˆ†é…ç»™ B; "3)" çš„æ—¶å€™ï¼ŒA ä½¿ç”¨å®Œæ¯•ä¹‹åï¼Œ
å°±å°† A å½’è¿˜ CMAï¼Œä½†æ­¤æ—¶ B è¿˜åœ¨ä½¿ç”¨ï¼Œå› æ­¤ CMA åŸå…ˆå¯åˆ†é… 1M çš„èƒ½åŠ›å°±å¤±å»äº†ï¼Œ
ç»“æœç°åœ¨æœ€é•¿ç”³è¯·åªèƒ½æ˜¯ B ä¸¤è¾¹ä»»æ„ä¸€å—ï¼Œè¿™æ · CMA ç¢ç‰‡å°±äº§ç”Ÿäº†ã€‚

-----------------------------------

#### <span id="A0003">CMA ç¢ç‰‡è§£å†³åŠæ³•</span>

ç”±äº CMA çš„ç‰©ç†å†…å­˜è¿ç»­æ€§ï¼Œç¢ç‰‡é—®é¢˜ç›®å‰è¿˜ä¸èƒ½å¾—åˆ°æ ¹æ²»ï¼Œä½†å¯é‡‡ç”¨ä¸€ä¸‹åŠæ³•
æ¥ç¼“è§£ CMA ç¢ç‰‡é—®é¢˜ï¼Œå…·ä½“æ€è·¯å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000061.png)

å°† CMA åˆ†ä½œå¤šä¸ªåŒºåŸŸï¼Œä¾‹å¦‚ä¸Šå›¾å°† CMA åˆ†ä½œäº† 3 ä¸ªåŒºåŸŸï¼Œç¬¬ä¸€ä¸ªåŒºåŸŸç”¨äºåˆ†é…
å°å—çš„è¿ç»­ç‰©ç†å†…å­˜ï¼Œç¬¬äºŒä¸ªåŒºå—ç”¨äºåˆ†é…ä¸­ç­‰åŒºå—çš„è¿ç»­ç‰©ç†å†…å­˜ï¼Œç¬¬ä¸‰å—ç”¨
äºåˆ†é…å¤§å—çš„è¿ç»­ç‰©ç†å†…å­˜ï¼Œè¿™æ ·åšçš„å¥½å‡ºå¦‚ä¸‹å›¾æ‰€ç¤º:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000062.png)

å¦‚ä¸Šå›¾ï¼Œå°† CMA åˆ†ä½œå¤šä¸ªå—ï¼Œå…¶ä¸­å°±æœ‰ "X Area"ã€"XX Area" å’Œ "XXX Area",
"1)" çš„æ—¶å€™ï¼Œ"X Area" å·²ç»åˆ†é…äº†ä¸‰å—ï¼Œ"XX Area" åˆ†é…äº†ä¸¤å—ï¼Œ"XXX Area"
åˆ†é…äº†äº”å—; "2)" çš„æ—¶å€™ï¼Œ"X Area" é‡Šæ”¾äº†ä¸€å—ï¼Œ"XX Area" é‡Šæ”¾äº†ä¸€å—ï¼Œ
"XXX Area" é‡Šæ”¾äº†ä¸¤å—ã€‚"3)" çš„æ—¶å€™ï¼Œéœ€è¦åˆ†äº«ä¸€å—å¤§å°ä¸º "X" çš„ç‰©ç†å—ï¼Œ
é‚£ä¹ˆ CMA å°±å» "X Area" åŒºåŸŸä¸­æ‰¾åˆ°ä¸€å—å¯ç”¨çš„ä½ç½®è¿›è¡Œåˆ†é…. æ¥ç€éœ€è¦
åˆ†é…ä¸€å—å¤§å°ä¸º "XX" çš„ç‰©ç†å†…å­˜åŒºå—ï¼Œæ­¤æ—¶ CMA å¹¶æœªå» "X Area" æˆ–è€…
"XX Area" ä¹‹å‰çš„åŒºåŸŸä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œè€Œæ˜¯ç›´æ¥å» "XX Area" ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œ
æŸ¥æ‰¾åˆ°å¯ç”¨ä½ç½®ä¹‹åå°±è¿›è¡Œåˆ†é…ã€‚åŒç† "XXX" ä¹Ÿå» "XXX Area" ä¸­è¿›è¡Œ
æŸ¥æ‰¾åˆ†é…ã€‚ç»è¿‡é•¿æ—¶é—´çš„è¿è¡Œ CMA ä¼šå˜å¾—çš„æ•´æ•´é½é½ï¼Œä¿æŒç€æœ€é•¿åˆ†é…
è¿ç»­ç‰©ç†å†…å­˜é•¿åº¦ã€‚

åŸºäºä¸Šé¢çš„åˆ†æå¾—å‡ºçš„ç»“æœï¼Œä¸ºäº†ç¼“è§£ CMA åˆ†é…å™¨ç¢ç‰‡é—®é¢˜ï¼Œæˆ‘å†³å®š
å¯¹ CMA å†…å­˜åˆ†é…å™¨è¿›è¡Œæ”¹é€ ï¼Œè¯·å‚è€ƒå¦‚ä¸‹ç« èŠ‚:

> - [CMA ç¢ç‰‡é—®é¢˜æ”¹é€ ç ”ç©¶](#C0)

----------------------------------

<span id="B0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L.jpg)

## å®è·µéƒ¨ç½²

> - [å®è·µåŸºç¡€éƒ¨ç½²](#B01)
>
> - [å®è·µç”¨ä¾‹éƒ¨ç½²](#B02)
>
> - [å®è·µç¼–è¯‘éƒ¨ç½²](#B03)
>
> - [å®è·µè¿è¡Œéƒ¨ç½²](#B04)
>
> - [å®è·µæºç åˆ†æ](#B05)

---------------------------------

#### <span id="B01">å®è·µåŸºç¡€éƒ¨ç½²</span>

æœ¬æ–‡æ”¯æŒåœ¨ BiscuitOS ä¸Šå®è·µ CMA ç¢ç‰‡é—®é¢˜ï¼Œå¦‚æœè¿˜æ²¡æœ‰æ­å»º BiscuitOS 
å¼€å‘ç¯å¢ƒï¼Œå¯ä»¥ä¸‹åˆ—æ–‡ç« :

> - [BiscuitOS å¿«é€Ÿéƒ¨ç½²(åŸºäº linux 5.0)](https://biscuitos.github.io/blog/Linux-5.0-arm32-Usermanual/)

----------------------------

#### <span id="B02">å®è·µç”¨ä¾‹éƒ¨ç½²</span>

å¦‚æœå·²ç»æ­å»ºå¥½ BiscuitOS å¼€å‘ç¯å¢ƒï¼Œæœ¬æ–‡å®è·µéƒ¨ç½²å¦‚ä¸‹:

{% highlight c %}
cd BiscuitOS
make linux-5.0-arm32_defconfig
make menuconfig 
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000003.png)

é€‰æ‹© "Package" å¹¶è¿›å…¥äºŒçº§èœå•.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000041.png)

é€‰æ‹© "CMA: Contiguous Memory Allocator --->" å¹¶è¿›å…¥äºŒçº§èœå•.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000042.png)

é€‰æ‹© "CMA Debris issue Application" å’Œ "CMA: Debris issue Device 
Driver Module" å¹¶ä¿å­˜é€€å‡ºã€‚æ¥ç€ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

{% highlight c %}
make
cd BiscuitOS/output/linux-5.0-arm32/package/
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000007.png)

------------------------------------

#### <span id="B03">å®è·µç¼–è¯‘éƒ¨ç½²</span>

ä¸ºäº†å¤ç° CMA ç¢ç‰‡é—®é¢˜ï¼Œè¿™é‡Œå‡†å¤‡äº†å¯¹åº”çš„é©±åŠ¨ç¨‹åºå’Œåº”ç”¨ç¨‹åºï¼Œ
å¼€å‘è€…å‚è€ƒä¸‹é¢æ­¥éª¤è¿›è¡Œç¼–è¯‘å®‰è£…:

> - [é©±åŠ¨ç¨‹åº](#B0001)
>
> - [åº”ç”¨ç¨‹åº](#B0002)

-------------------------------------

###### <span id="B0001">é©±åŠ¨ç¨‹åº</span>

é©±åŠ¨ç¨‹åºç”¨äºä¸ºç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºæä¾› CMA ç”³è¯·çš„å€Ÿå£ï¼Œå…¶ä½¿ç”¨å¦‚ä¸‹:

{% highlight c %}
cd BiscuitOS/output/linux-5.0-arm32/package/CMA_debris_module-0.0.1
make prepare
make download
{% endhighlight %}

æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤ä¹‹åï¼ŒBiscuitOS ä¼šä¸‹è½½æŒ‡å®šçš„æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000047.png)

è·å¾—ä¸Šé¢çš„æ–‡ä»¶ä¹‹åï¼Œå¼€å‘è€…é¦–å…ˆæ ¹æ® "00001-CMA-special-areas.patch" è¡¥ä¸
ä¸­çš„å†…å®¹ï¼Œå¯¹å†…æ ¸è¿›è¡Œæ‰‹åŠ¨è¡¥ä¸æˆ–è‡ªåŠ¨è¡¥ä¸ï¼Œå…¶ä¿®æ”¹å†…å®¹å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000044.png)

ä»è¡¥ä¸çš„å†…å®¹å¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆå°† "dma_alloc_from_contiguous" å’Œ
"dma_release_from_contiguous" ä¸¤ä¸ªå‡½æ•°ä½¿ç”¨ "EXPORT_SYMBOL()" å®
è¿›è¡Œå¯¼å‡ºï¼Œä»¥ä¾¿ä¾›å¤–éƒ¨æ¨¡å—ä½¿ç”¨ã€‚æ¥ç€åœ¨ "mm/cma.c" æ–‡ä»¶ä¸­æ·»åŠ äº†
ä¸€ä¸ªå‡½æ•° "find_cma_by_name()" å…¶ä½œç”¨æ˜¯é€šè¿‡åå­—ç›´åˆ°æŒ‡å®šçš„ cma
åŒºå—å¯¹åº”çš„ç»“æ„ä½“. æ¥ç€æ˜¯ "default.dts" æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ç”¨æˆ·æè¿°
è¯¥é©±åŠ¨çš„ DTS èŠ‚ç‚¹ä»¥åŠ CMA åŒºå—çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000045.png)

å¼€å‘è€…å‚è€ƒä¸Šé¢çš„å†…å®¹æ·»åŠ åˆ°å†…æ ¸çš„ DTS æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚æœ¬ä¾‹å­ä¸­
ä½¿ç”¨çš„ DTS ä½äº:

{% highlight c %}
vi BiscuitOS/output/linux-5.0-arm32/linux/linux-5.0/arch/arm/boot/dts/vexpress-v2p-ca9.dts
{% endhighlight %}

å¼€å‘è€…å‚è€ƒä¸Šé¢çš„ DTS ä¹‹åï¼Œåœ¨é¡¹ç›®çš„ DTS æ–‡ä»¶ä¸­æ‰¾åˆ° reserved-memory èŠ‚ç‚¹ï¼Œ
ç„¶åå‘è¯¥èŠ‚ç‚¹ä¸­åˆ†åˆ«æ·»åŠ  "linux,cma" å’Œ "BiscuitOS_cma" ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå…¶èŠ‚ç‚¹
å±æ€§ä¸å›¾ä¸­çš„é…ç½®ä¸€è‡´ã€‚æ¥ç€åœ¨ reserved-memory èŠ‚ç‚¹ä¹‹å¤–å¢åŠ  "BiscuitOS_CMA"
èŠ‚ç‚¹ï¼Œå…¶å±æ€§å’Œå›¾ä¸­ä¸€è‡´ã€‚æœ€åæ‰“å®Œè¡¥ä¸å’Œæ·»åŠ å®Œ patch ä¹‹åï¼Œå¼€å‘è€…éœ€è¦é‡æ–°
ç¼–è¯‘å†…æ ¸ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹å‘½ä»¤:

{% highlight c %}
cd BiscuitOS/output/linux-5.0-arm32/linux/linux-5.0/
make ARCH=arm CROSS_COMPILE=BiscuitOS/output/linux-5.0-arm32/arm-linux-gnueabi/arm-linux-gnueabi/bin/arm-linux-gnueabi- -j4
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000046.png)

æ¥ç€ç¼–è¯‘é©±åŠ¨å’Œå®‰è£…æ¨¡å—åˆ° BiscuitOSï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

{% highlight c %}
cd BiscuitOS/output/linux-5.0-arm32/package/CMA_debris_module-0.0.1
make clean
make
make install
make pack
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000043.png)

æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤ä¹‹åï¼Œé©±åŠ¨å·²ç»æˆåŠŸå®‰è£…åˆ° BiscuitOSï¼Œæ¥ç€åªè¦åœ¨
BiscuitOS ç³»ç»Ÿè¿è¡Œçš„æ—¶å€™å®‰è£…å°±è¡Œã€‚æ¥ä¸‹æ¥æ˜¯å®‰è£…é©±åŠ¨å¯¹åº”çš„åº”ç”¨ç¨‹åºã€‚

-----------------------------------

###### <span id="B0002">åº”ç”¨ç¨‹åº</span>

åº”ç”¨ç¨‹åºä¸é©±åŠ¨ç¨‹åºé…åˆï¼Œç›®çš„æ˜¯åœ¨ BiscuitOS ç³»ç»Ÿä¸Šæ¨¡æ‹Ÿä¸€ä¸ªéšæœºåˆ†é…
å’Œé‡Šæ”¾ CMAï¼Œæ¯æ¬¡æ“ä½œ CMA å¤§å°ä¹Ÿæ˜¯éšæœºçš„ï¼Œä»¥ä¾¿è¿›è¡Œå‹åŠ›æµ‹è¯•å¹¶å¤ç°ç¢ç‰‡
å¯¼è‡´ CMA åˆ†é…å¤±è´¥çš„æƒ…å†µã€‚å¼€å‘è€…é¦–å…ˆæŒ‰ç…§ä¸‹åˆ—æ­¥éª¤éƒ¨ç½²åº”ç”¨ç¨‹åº:

{% highlight c %}
cd BiscuitOS/output/linux-5.0-arm32/package/CMA_debris_app-0.0.1
make download
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000048.png)

åœ¨è·å¾—æºç ä¹‹åï¼Œå¼€å‘è€…ç»§ç»­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å°†åº”ç”¨ç¨‹åºæºç è¿›è¡Œç¼–è¯‘ã€å®‰è£…
å’Œæ‰“åŒ…åˆ° BiscuitOS ç³»ç»Ÿé‡Œ:

{% highlight c %}
make clean
make
make install
make pack
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000049.png)

---------------------------------

#### <span id="B04">å®è·µè¿è¡Œéƒ¨ç½²</span>

åœ¨å‡†å¤‡å¥½é©±åŠ¨å’Œåº”ç”¨ç¨‹åºä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯åœ¨ BiscuitOS ä¸Šé¢å¤ç° CMA ç¢ç‰‡
é—®é¢˜ã€‚å¼€å‘è€…ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨ BiscuitOS:

{% highlight c %}
cd BiscuitOS/output/linux-5.0-arm32/
./RunBiscuitOS.sh
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000050.png)

æ¥ç€å®‰è£…é©±åŠ¨:

{% highlight c %}
cd lib/modules/5.0.0/extra/
insmod cma.ko
lsmod
ls -l /dev/BiscuitOS_CMA
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000051.png)

å®‰è£…å®Œæ¯•é©±åŠ¨ä¹‹åï¼Œå¯ä»¥åœ¨ "/sys/bus/platform/devices/BiscuitOS_CMA" ç›®å½•ä¸‹
æŸ¥çœ‹å½“å‰ CMA bitmap ä½¿ç”¨æƒ…å†µï¼Œå¦‚ä¸‹å›¾:

{% highlight c %}
cd /sys/bus/platform/devices/BiscuitOS_CMA
cat bitmap
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000052.png)

ç”±ä¸Šå›¾å¯çŸ¥ï¼Œå½“æœªè¿›è¡Œ CMA åˆå§‹åŒ–æ—¶ï¼ŒCMA area çš„ bitmap å…¨éƒ½å¯ç”¨ï¼Œ
ä¸Šå›¾ä¸ºä¸€å— 8M çš„ CMAï¼Œæ‰€ä»¥æœ€é•¿å¯ç”¨è¿ç»­ç‰©ç†å†…å­˜ä¸º 8M. æµ‹è¯•è¿˜å¯ä»¥
é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹ä¸ CMA ç›¸å…³çš„ä¿¡æ¯:

{% highlight c %}
cat /proc/meminfo
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000053.png)

ç”±ä¸Šå›¾å¯çŸ¥ï¼Œ"CmaTotal" è¯´æ˜ç³»ç»Ÿ CMA å¤§å°ä¸º 16384KBï¼Œå³ 16M, "CmaFree"
è¯´æ˜å½“å‰å¯ç”¨ CMA çš„æ€»æ•°ä¸º 14592KB, ä½†ä¸ä»£è¡¨è¿ç»­çš„ç‰©ç†å†…å­˜ä¸º 14592KB. 

æ¥ä¸‹æ¥å°±æ˜¯è¿è¡Œæµ‹è¯•ç¨‹åºï¼Œæµ‹è¯•ç¨‹åºä¼šä¸åœçš„åˆ†é…æˆ–é‡Šæ”¾éšæœºå¤§å°çš„ CMA
ç‰©ç†å—ï¼Œç›´åˆ°å¤±è´¥ä¸ºæ­¢ï¼Œå¹¶æ‰“å°åˆ†é…çš„æ¬¡æ•°å’Œé‡Šæ”¾çš„æ¬¡æ•°ã€‚å…·ä½“å‘½ä»¤å¦‚ä¸‹:

{% highlight c %}
CMA_debris_app-0.0.1 &
{% endhighlight %}

å¯ä»¥ä½¿ç”¨å‹åå°çš„æ–¹å¼ï¼Œå¼€å‘è€…å¯ä»¥åŠ¨æ€æŸ¥çœ‹ /proc/meminfo ä¸‹é¢ CMA
çš„ä½¿ç”¨æƒ…å†µã€‚å¦‚ä¸‹å‘½ä»¤:

{% highlight c %}
cat /proc/meminfo | grep Cma
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000054.png)

ä»ä¸Šå›¾çœ‹å‡ºäº†æµ‹è¯•ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼ŒæŠ“å–çš„ "/proc/meminfo" çš„ç¬é—´æ•°æ®ï¼Œ
CMA ä½¿ç”¨ä»åœ¨ "8836KB -- 7564KB" ä¹‹é—´å˜æ¢ï¼Œä½† CMA çš„æ€»æ•°è¿˜æœªè€—å°½ã€‚
æœ€åæµ‹è¯•ç¨‹åºå¤±è´¥ï¼Œæ€»å…±æ‰§è¡Œäº† 16687 æ¬¡åˆ†é…å’Œ 16550 æ¬¡é‡Šæ”¾ï¼Œæ­¤æ—¶ä½¿ç”¨
å‘½ä»¤æ‰“å°å‡º CMA çš„ bitmap ä½¿ç”¨æƒ…å†µ:

{% highlight c %}
cd /sys/bus/platform/devices/BiscuitOS_CMA
cat bitmap
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000055.png)

ä»ä¸Šå›¾å·²ç»å¾ˆç›´ç™½çš„çœ‹å‡º CMA å·²ç»è¢«ç¢ç‰‡åŒ–äº†ï¼Œæœ€é•¿è¿ç»­ç‰©ç†å†…å­˜ä¸º 44bitsï¼Œ
å³ 176KB çš„è¿ç»­ç‰©ç†å†…å­˜ã€‚æ­¤æ—¶å¦‚æœåœ¨è¿è¡Œæµ‹è¯•ç¨‹åºï¼Œç¨‹åºè¿˜å¯ä»¥è¿è¡Œï¼Œ
è¿è¡Œä¹‹åçš„ bitmap å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000056.png)

å¦‚ä¸Šå›¾ï¼Œå†æ¬¡è¿è¡Œæµ‹è¯•ç¨‹åºï¼Œç¨‹åºä¸€å…±è¿›è¡Œäº† 10 æ¬¡åˆ†é…æ“ä½œï¼ŒCMA å¯ç”¨çš„ç‰©ç†
å†…å­˜åˆè¢«è€—å°½ä¸å°‘ï¼Œå¦‚æœå¼€å‘è€…ä¸åœè¿è¡Œæµ‹è¯•ç¨‹åºï¼ŒçŸ¥é“åˆ†é…ä¸º 0 æ¬¡ï¼Œæ­¤æ—¶
bitmap åŸºæœ¬è¢«è€—å°½ï¼Œå¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000057.png)

é€šè¿‡ä»¥ä¸Šå®è·µï¼Œå·²ç»å®Œæ•´å±•ç¤ºäº† CMA ç¢ç‰‡åŒ–å¸¦æ¥çš„é—®é¢˜ã€‚

---------------------------------

#### <span id="B05">å®è·µæºç åˆ†æ</span>

æºç åˆ†ä½œé©±åŠ¨éƒ¨åˆ†å’Œåº”ç”¨ç¨‹åºéƒ¨åˆ†ï¼Œé©±åŠ¨æºç ä½äº:

{% highlight c %}
BiscuitOS/output/linux-5.0-arm32/package/CMA_debris_module-0.0.1/CMA_debris_module-0.0.1/cma.c
{% endhighlight %}

åº”ç”¨ç¨‹åºæºç ä½äº:

{% highlight c %}
/xspace/OpenSource/BiscuitOS/BiscuitOS/output/linux-5.0-arm32/package/CMA_debris_app-0.0.1/CMA_debris_app-0.0.1/cma.c
{% endhighlight %}

é©±åŠ¨ç¨‹åºçš„ä¸»è¦é€šè¿‡åº”ç”¨ç¨‹åº ioctl å‘é€å‘½ä»¤ "CMA_MEM_ALLOCATE" å’Œ
"CMA_MEM_RELEASE" å‘Šè¯‰é©±åŠ¨ç¨‹åºè¿›è¡Œ CMA åˆ†é…å’Œé‡Šæ”¾ï¼Œé©±åŠ¨ç¨‹åºè¿›è€Œè°ƒç”¨
"dma_alloc_from_contiguous()" å‡½æ•°å’Œ "dma_release_from_contiguous()" å‡½æ•°
è¿›è¡Œè¿›è¡Œ CMA çš„åˆ†é…å’Œé‡Šæ”¾åŠ¨ä½œã€‚

åœ¨æµ‹è¯•ç¨‹åºä¸­å®šä¹‰äº†ä¸€ä¸ª CMA åˆ†é…é•¿åº¦æ•°ç»„ï¼Œå¹¶è°ƒç”¨éšæœºå‡½æ•°ç”Ÿæˆéšæœºç´¢å¼•
å»è®¿é—®è¿™ä¸ªæ•°æ®ï¼Œç¨‹åºå°±ä½¿ç”¨è¿™ä¸ªæ•°å€¼ä½œä¸ºåˆ†é…å’Œé‡Šæ”¾çš„ä¾æ®ï¼Œæœ€åä¸æ–­
é‡å¤ç”³è¯·å’Œé‡Šæ”¾ï¼Œç›´åˆ° CMA å¤±è´¥ä¸ºæ­¢.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000058.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000059.png)


{% highlight c %}

{% endhighlight %}

----------------------------------

<span id="C0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000E.jpg)

## ç ”ç©¶åˆ†æ

åŸºäºä¸Šè¿°çš„å®è·µå’ŒåŸç†ï¼Œæœ¬èŠ‚é‡ç‚¹ä»‹ç»ä¸åŒçš„æ–‡ä»¶è·¯å¾„é•¿åº¦å¯¼è‡´ä¸åŒçš„
å†…æ ¸ç­–ç•¥ï¼Œå®è·µå¯ä»¥åˆ†æˆå¦‚ä¸‹å‡ ç±»:

> - [è·¯å¾„åé•¿åº¦å°äº EMBEDDED_NAME_MAX](#C01)
>
> - [è·¯å¾„åé•¿åº¦ç­‰äº EMBEDDED_NAME_MAX](#C02)
>
> - [è·¯å¾„åé•¿åº¦å¤§äº EMBEDDED_NAME_MAX å°äº PATH_MAX](#C03)
>
> - [è·¯å¾„åé•¿åº¦ç­‰äº PATH_MAX](#C04)
>
> - [è·¯å¾„åé•¿åº¦å¤§äº PATH_MAX](#C05)


--------------------------------------

#### <span id="C01">è·¯å¾„åé•¿åº¦å°äº EMBEDDED_NAME_MAX</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000009.png)

åœ¨åº”ç”¨ç¨‹åºä¸­ä¿®æ”¹æ–‡ä»¶è·¯å¾„é•¿åº¦ä¸º 32ï¼Œå¦‚ä¸Šå›¾ã€‚ç¼–è¯‘å®‰è£…ä¹‹åï¼Œåœ¨å†…æ ¸æºç 
"getname_flags()" æ·»åŠ ç›¸åº”çš„è°ƒè¯•ä¿¡æ¯ï¼Œä»¥æ­¤è·Ÿè¸ªå†…æ ¸å¤„ç†é€»è¾‘, ä¿®æ”¹å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000011.png)

{% highlight c %}
open_pathlen-0.0.1
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000010.png)

ä»è¿è¡Œçš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ–‡ä»¶è·¯å¾„åé•¿åº¦å°äº EMBEDDED_NAME_MAX å¹¶ä¸éœ€è¦
ä½¿ç”¨åˆ†ç¦»çš„ struct filename. å…¶è·¯å¾„åç®¡ç†å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000001.png)

--------------------------------------

#### <span id="C02">è·¯å¾„åé•¿åº¦ç­‰äº EMBEDDED_NAME_MAX</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000012.png)

åœ¨åº”ç”¨ç¨‹åºä¸­ä¿®æ”¹æ–‡ä»¶è·¯å¾„é•¿åº¦ä¸º EMBEDDED_NAME_MAXï¼Œå¦‚ä¸Šå›¾ã€‚ç¼–è¯‘å®‰è£…
ä¹‹åï¼Œåœ¨å†…æ ¸æºç  "getname_flags()" æ·»åŠ ç›¸åº”çš„è°ƒè¯•ä¿¡æ¯ï¼Œä»¥æ­¤è·Ÿè¸ªå†…æ ¸
å¤„ç†é€»è¾‘, ä¿®æ”¹å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000014.png)

{% highlight c %}
open_pathlen-0.0.1
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000013.png)

ä»è¿è¡Œçš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ–‡ä»¶è·¯å¾„åé•¿åº¦ç­‰äº EMBEDDED_NAME_MAX éœ€è¦
ä½¿ç”¨åˆ†ç¦»çš„ struct filename. å…¶è·¯å¾„åç®¡ç†å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000002.png)

--------------------------------------

#### <span id="C03">è·¯å¾„åé•¿åº¦å¤§äº EMBEDDED_NAME_MAX å°äº PATH_MAX</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000015.png)

åœ¨åº”ç”¨ç¨‹åºä¸­ä¿®æ”¹æ–‡ä»¶è·¯å¾„é•¿åº¦ä¸º "EMBEDDED_NAME_MAX + 2"ï¼Œå¦‚ä¸Šå›¾ã€‚ç¼–è¯‘å®‰è£…
ä¹‹åï¼Œåœ¨å†…æ ¸æºç  "getname_flags()" æ·»åŠ ç›¸åº”çš„è°ƒè¯•ä¿¡æ¯ï¼Œä»¥æ­¤è·Ÿè¸ªå†…æ ¸
å¤„ç†é€»è¾‘, ä¿®æ”¹å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000014.png)

{% highlight c %}
open_pathlen-0.0.1
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000016.png)

ä»è¿è¡Œçš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ–‡ä»¶è·¯å¾„åé•¿åº¦å¤§äº EMBEDDED_NAME_MAXï¼Œä½†å°äº
PATH_MAX, éœ€è¦ä½¿ç”¨åˆ†ç¦»çš„ struct filename, å¹¶ä¸”ä¸¤æ¬¡ä»ç”¨æˆ·ç©ºé—´è¯»å–çš„
é•¿åº¦ä¸åŒã€‚å…¶è·¯å¾„åç®¡ç†å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000002.png)

--------------------------------------

#### <span id="C04">è·¯å¾„åé•¿åº¦ç­‰äº PATH_MAX</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000017.png)

åœ¨åº”ç”¨ç¨‹åºä¸­ä¿®æ”¹æ–‡ä»¶è·¯å¾„é•¿åº¦ä¸º PATH_MAXï¼Œå¦‚ä¸Šå›¾ã€‚ç¼–è¯‘å®‰è£…ä¹‹åï¼Œ
åœ¨å†…æ ¸æºç  "getname_flags()" æ·»åŠ ç›¸åº”çš„è°ƒè¯•ä¿¡æ¯ï¼Œä»¥æ­¤è·Ÿè¸ªå†…æ ¸
å¤„ç†é€»è¾‘, ä¿®æ”¹å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000014.png)

{% highlight c %}
open_pathlen-0.0.1
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000018.png)

ä»è¿è¡Œçš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ–‡ä»¶è·¯å¾„åé•¿åº¦ç­‰äº PATH_MAX éœ€è¦
ä½¿ç”¨åˆ†ç¦»çš„ struct filename, ä½†å°±ç®—ä½¿ç”¨åˆ†ç¦»çš„ struct filename,
å†…æ ¸è¿˜æ˜¯ä¸èƒ½ç®¡ç†è¿™ä¹ˆè·¯å¾„åé•¿åº¦ä¸º PATH_MAX çš„æƒ…å†µï¼Œç›´æ¥è¿”å›
"ENAMETOOLONG".

--------------------------------------

#### <span id="C05">è·¯å¾„åé•¿åº¦å¤§äº PATH_MAX</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000019.png)

åœ¨åº”ç”¨ç¨‹åºä¸­ä¿®æ”¹æ–‡ä»¶è·¯å¾„é•¿åº¦ä¸º PATH_MAXï¼Œå¦‚ä¸Šå›¾ã€‚ç¼–è¯‘å®‰è£…ä¹‹åï¼Œ
åœ¨å†…æ ¸æºç  "getname_flags()" æ·»åŠ ç›¸åº”çš„è°ƒè¯•ä¿¡æ¯ï¼Œä»¥æ­¤è·Ÿè¸ªå†…æ ¸
å¤„ç†é€»è¾‘, ä¿®æ”¹å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000014.png)

{% highlight c %}
open_pathlen-0.0.1
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000020.png)

ä»è¿è¡Œçš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ–‡ä»¶è·¯å¾„åé•¿åº¦ç­‰äº PATH_MAX éœ€è¦         
ä½¿ç”¨åˆ†ç¦»çš„ struct filename, ä½†å°±ç®—ä½¿ç”¨åˆ†ç¦»çš„ struct filename, 
å†…æ ¸åªèƒ½ä»ç”¨æˆ·ç©ºé—´è¯»å–é•¿åº¦ä¸º PATH_MAX é•¿åº¦çš„å†…å®¹ï¼Œå¹¶ä¸”
å†…æ ¸è¿˜æ˜¯ä¸èƒ½ç®¡ç†è¿™ä¹ˆè·¯å¾„åé•¿åº¦ä¸º PATH_MAX çš„æƒ…å†µï¼Œç›´æ¥è¿”å›
"ENAMETOOLONG".

----------------------------------

<span id="D0"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000F.jpg)

## å®è·µç»“è®º

ä»ä¸Šé¢çš„å®è·µæœ€ç»ˆå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®º:

> - æ–‡ä»¶è·¯å¾„åé•¿åº¦ä¸èƒ½è¶…è¿‡ PATH_MAX
>
> - æœ€ä¼˜æ–‡ä»¶è·¯å¾„åé•¿åº¦ä¸èƒ½è¶…è¿‡ EMBEDDED_NAME_MAX

-----------------------------------------------

# <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
