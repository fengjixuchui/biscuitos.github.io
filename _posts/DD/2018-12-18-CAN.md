---
layout: post
title:  "CAN"
date:   2018-12-19 18:40:30 +0800
categories: [HW]
excerpt: CAN.
tags:
  - Bus
---

> [GitHub: CAN](https://github.com/BiscuitOS/HardStack/tree/master/bus/CAN)
>
> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

# ç›®å½•

> 1. [CAN åŸç†](#CAN åŸç†)
>
> 2. [Kernel å†…æ ¸æºç ä¸­ä½¿ç”¨ CAN](#Kernel å†…æ ¸æºç ä¸­ä½¿ç”¨ CAN)
>
> 3. [ç”¨æˆ·ç©ºé—´æºç ä½¿ç”¨ CAN](#ç”¨æˆ·ç©ºé—´æºç ä½¿ç”¨ CAN)
>
> 4. [ç”¨æˆ·ç©ºé—´å·¥å…·ä½¿ç”¨ CAN](#ç”¨æˆ·ç©ºé—´å·¥å…·ä½¿ç”¨ CAN)
>
> 5. [CAN æµ‹è¯•](#CAN æµ‹è¯•)
>
> 6. [é™„å½•](#é™„å½•)

-------------------------------------------

# <span id="CAN åŸç†">CAN åŸç†</span>

> 1. [CAN æ€»çº¿åè®®](#CAN æ€»çº¿åè®®)
>
> 2. [CAN æ•°æ®æ ¼å¼](#CAN æ•°æ®æ ¼å¼)

### <span id="CAN æ€»çº¿åè®®">CANæ€»çº¿åè®®</span>

CAN æ˜¯ Controller Area Networkï¼ˆæ§åˆ¶å™¨å±€åŸŸç½‘ï¼‰çš„ç¼©å†™ã€‚CAN é€šä¿¡åè®®åœ¨ 1986 å¹´ç”±
å¾·å›½ç”µæ°”å•†åšä¸–å…¬å¸æ‰€å¼€å‘ï¼Œä¸»è¦é¢å‘æ±½è½¦çš„é€šä¿¡ç³»ç»Ÿã€‚ç°å·²æ˜¯ ISO å›½é™…æ ‡å‡†åŒ–çš„ä¸²è¡Œ
é€šä¿¡åè®®ã€‚æ ¹æ®ä¸åŒçš„è·ç¦»ã€ä¸åŒçš„ç½‘ç»œï¼Œå¯é…ç½®ä¸åŒçš„é€Ÿåº¦ï¼Œæœ€é«˜é€Ÿåº¦ä¸º1MBit/sã€‚CAN
è¢«ç»†åˆ†ä¸ºä¸‰ä¸ªå±‚æ¬¡ï¼š

> 1. CANå¯¹è±¡å±‚ï¼ˆthe object layerï¼‰
>
> 2. CANä¼ è¾“å±‚ï¼ˆthe transfer layerï¼‰
>
> 3. CANç‰©ç†å±‚ï¼ˆthe phyical layerï¼‰


å¯¹è±¡å±‚å’Œä¼ è¾“å±‚åŒ…æ‹¬æ‰€æœ‰ç”± ISO/OSI æ¨¡å‹å®šä¹‰çš„æ•°æ®é“¾è·¯å±‚çš„æœåŠ¡å’ŒåŠŸèƒ½ã€‚å¯¹è±¡å±‚çš„ä½œ
ç”¨èŒƒå›´åŒ…æ‹¬ï¼š

> 1. æŸ¥æ‰¾è¢«å‘é€çš„æŠ¥æ–‡ã€‚
>
> 2. ç¡®å®šç”±å®é™…è¦ä½¿ç”¨çš„ä¼ è¾“å±‚æ¥æ”¶å“ªä¸€ä¸ªæŠ¥æ–‡ã€‚
>
> 3. ä¸ºåº”ç”¨å±‚ç›¸å…³ç¡¬ä»¶æä¾›æ¥å£ã€‚


ä¼ è¾“å±‚çš„ä½œç”¨ä¸»è¦ï¼š

> 1. ä¼ é€è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶å¸§ç»“æ„ã€æ‰§è¡Œä»²è£ã€é”™è¯¯æ£€æµ‹ã€å‡ºé”™æ ‡å®šã€æ•…éšœç•Œå®šã€‚
>
> 2. æ€»çº¿ä¸Šä»€ä¹ˆæ—¶å€™å¼€å§‹å‘é€æ–°æŠ¥æ–‡åŠä»€ä¹ˆæ—¶å€™å¼€å§‹æ¥æ”¶æŠ¥æ–‡ï¼Œå‡åœ¨ä¼ è¾“å±‚é‡Œç¡®å®šã€‚
>
> 3. ä½å®šæ—¶çš„ä¸€äº›æ™®é€šåŠŸèƒ½ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¼ è¾“å±‚çš„ä¸€éƒ¨åˆ†ã€‚
>
> 4. ä¼ è¾“å±‚çš„ä¿®æ”¹æ˜¯å—åˆ°é™åˆ¶çš„ã€‚


ç‰©ç†å±‚çš„ä½œç”¨ï¼š

åœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´æ ¹æ®æ‰€æœ‰çš„ç”µæ°”å±æ€§è¿›è¡Œä½ä¿¡æ¯çš„å®é™…ä¼ è¾“ã€‚å½“ç„¶ï¼ŒåŒä¸€ç½‘ç»œå†…ï¼Œç‰©ç†å±‚
å¯¹äºæ‰€æœ‰çš„èŠ‚ç‚¹å¿…é¡»æ˜¯ç›¸åŒçš„ã€‚å°½ç®¡å¦‚æ­¤ï¼Œåœ¨é€‰æ‹©ç‰©ç†å±‚æ–¹é¢è¿˜æ˜¯å¾ˆè‡ªç”±çš„ã€‚

CANå…·æœ‰ä»¥ä¸‹çš„å±æ€§ï¼š

> 1. æŠ¥æ–‡ï¼ˆMessagesï¼‰ï¼šç®€å•æ¥è¯´å°±æ˜¯å…·æœ‰å›ºå®šæ ¼å¼çš„æ•°æ®åŒ…ã€‚
>
> 2. ä¿¡æ¯è·¯ç”±ï¼ˆInformation Routingï¼‰ï¼šå³ï¼ŒæŠ¥æ–‡å¯»æ‰¾ç»“ç‚¹çš„æ–¹å¼ã€‚
>
> 3. ä½é€Ÿç‡ï¼ˆBit rateï¼‰ï¼šæ•°æ®ä½çš„ä¼ è¾“é€Ÿåº¦ã€‚
>
> 4. ä¼˜å…ˆæƒï¼ˆPrioritiesï¼‰ï¼šå³æŠ¥æ–‡å‘é€çš„ä¼˜å…ˆæƒã€‚
>    
> 5. è¿œç¨‹æ•°æ®è¯·æ±‚ï¼ˆRemote Data Requestï¼‰ï¼šé€šè¿‡å‘é€è¿œç¨‹å¸§ï¼Œéœ€è¦æ•°æ®çš„èŠ‚ç‚¹å¯ä»¥è¯·
>    æ±‚å¦ä¸€èŠ‚ç‚¹å‘é€ç›¸åº”çš„æ•°æ®å¸§ã€‚
>
> 6. å¤šä¸»æœºï¼ˆMultimasterï¼‰ï¼šæ€»çº¿ç©ºé—²æ—¶ï¼Œä»»ä½•ç»“ç‚¹éƒ½å¯ä»¥å¼€å§‹ä¼ é€æŠ¥æ–‡ã€‚
>
> 7. ä»²è£ï¼ˆArbitrationï¼‰ï¼šå½“2ä¸ªåŠä»¥ä¸Šçš„å•å…ƒåŒæ—¶å¼€å§‹ä¼ é€æŠ¥æ–‡ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰æ€»çº¿è®¿
>    é—®å†²çªã€‚ä»²è£æ˜¯ç¡®å®šå“ªä¸ªå•å…ƒçš„å…·æœ‰å‘é€ä¼˜å…ˆæƒã€‚
>
> 8. å®‰å…¨æ€§ï¼ˆSafetyï¼‰ï¼šCANçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹å‡é‡‡å–äº†å¼ºæœ‰åŠ›çš„æªæ–½ä»¥è¿›è¡Œé”™è¯¯æ£€æµ‹ã€é”™è¯¯
>    æ ‡å®šåŠé”™è¯¯è‡ªæ£€ã€‚
> 9. é”™è¯¯æ£€æµ‹ï¼ˆError Detectionï¼‰ï¼šåŒ…æ‹¬ç›‘è§†ã€å¾ªç¯å†—ä½™æ£€æŸ¥ã€ä½å¡«å……ã€æŠ¥æ–‡æ ¼å¼æ£€æŸ¥ã€‚
>
> 10. é”™è¯¯æ£€æµ‹çš„æ‰§è¡Œï¼ˆPerformance of Error Detectionï¼‰
>
> 11. é”™è¯¯æ ‡å®šå’Œæ¢å¤æ—¶é—´ï¼ˆError Sinalling and Recovery Timeï¼‰ï¼šä»»ä½•æ£€æµ‹åˆ°é”™è¯¯
>     çš„ç»“ç‚¹ä¼šæ ‡å¿—å‡ºå·²æŸåçš„æŠ¥æ–‡ã€‚æ­¤æŠ¥æ–‡ä¼šå¤±æ•ˆå¹¶å°†è‡ªåŠ¨åœ°å¼€å§‹é‡æ–°ä¼ é€ã€‚å¦‚æœä¸å†
>     å‡ºç°æ–°çš„é”™è¯¯ï¼Œä»æ£€æµ‹åˆ°é”™è¯¯åˆ°ä¸‹ä¸€æŠ¥æ–‡çš„ä¼ é€å¼€å§‹ä¸ºæ­¢ï¼Œæ¢å¤æ—¶é—´æœ€å¤šä¸º29ä¸ªä½
>     çš„æ—¶é—´ã€‚
>
> 12. æ•…éšœç•Œå®šï¼ˆFault Confinementï¼‰ï¼šCANç»“ç‚¹èƒ½å¤ŸæŠŠæ°¸ä¹…æ•…éšœå’ŒçŸ­æš‚æ‰°åŠ¨åŒºåˆ†å¼€æ¥ã€‚
>     æ°¸ä¹…æ•…éšœçš„ç»“ç‚¹ä¼šè¢«å…³é—­ã€‚
> 13. è¿æ¥ï¼ˆConnectionsï¼‰ï¼šCANä¸²è¡Œé€šè®¯é“¾è·¯æ˜¯å¯ä»¥è¿æ¥è®¸å¤šç»“ç‚¹çš„æ€»çº¿ã€‚ç†è®ºä¸Šï¼Œå¯
>     è¿æ¥æ— æ•°å¤šçš„ç»“ç‚¹ã€‚ä½†ç”±äºå®é™…ä¸Šå—å»¶è¿Ÿæ—¶é—´æˆ–è€…æ€»çº¿çº¿è·¯ä¸Šç”µæ°”è´Ÿè½½çš„å½±å“ï¼Œè¿
>     æ¥ç»“ç‚¹çš„æ•°é‡æ˜¯æœ‰é™çš„ã€‚
>
> 14. å•é€šé“ï¼ˆSingle Channelï¼‰ï¼šæ€»çº¿æ˜¯ç”±å•ä¸€è¿›è¡ŒåŒå‘ä½ä¿¡å·ä¼ é€çš„é€šé“ç»„æˆã€‚
>
> 15. æ€»çº¿å€¼ï¼ˆBus valueï¼‰ï¼šæ€»çº¿å¯ä»¥å…·æœ‰ä¸¤ç§äº’è¡¥çš„é€»è¾‘å€¼ä¹‹ä¸€ï¼šâ€œæ˜¾æ€§â€ï¼ˆå¯è¡¨ç¤ºä¸º
>     é€»è¾‘0ï¼‰æˆ–â€œéšæ€§â€ï¼ˆå¯è¡¨ç¤ºä¸ºé€»è¾‘1ï¼‰ã€‚
> 16. åº”ç­”ï¼ˆAcknowledgmentï¼‰ï¼šæ‰€æœ‰çš„æ¥æ”¶å™¨æ£€æŸ¥æŠ¥æ–‡çš„è¿è´¯æ€§ã€‚å¯¹äºè¿è´¯çš„æŠ¥æ–‡ï¼Œæ¥
>     æ”¶å™¨åº”ç­”ï¼›å¯¹äºä¸è¿è´¯çš„æŠ¥æ–‡ï¼Œæ¥æ”¶å™¨ä½œå‡ºæ ‡å¿—ã€‚
>
> 17. ç¡çœ æ¨¡å¼ï¼å”¤é†’ï¼ˆSleep Mode / Wake-upï¼‰ï¼šä¸ºäº†å‡å°‘ç³»ç»Ÿç”µæºçš„åŠŸç‡æ¶ˆè€—ï¼Œå¯ä»¥
>     å°†CANå™¨ä»¶è®¾ä¸ºç¡çœ æ¨¡å¼ä»¥ä¾¿åœæ­¢å†…éƒ¨æ´»åŠ¨åŠæ–­å¼€ä¸æ€»çº¿é©±åŠ¨å™¨çš„è¿æ¥ã€‚CANå™¨ä»¶å¯
>     ç”±æ€»çº¿æ¿€æ´»ï¼Œæˆ–ç³»ç»Ÿå†…éƒ¨çŠ¶æ€è€Œè¢«å”¤é†’ã€‚

### CANæ€»çº¿çš„æŠ¥æ–‡æ ¼å¼

CANä¼ è¾“çš„æŠ¥æ–‡ï¼Œå¯åˆ†ä¸ºäº”ç§ç±»å‹ï¼š

> 1. æ•°æ®å¸§ï¼šç”¨äºå‘é€ç»“ç‚¹å‘æ¥æ”¶ç»“ç‚¹ä¼ é€æ•°æ®çš„å¸§ã€‚
>
> 2. è¿œç¨‹å¸§ï¼šæ€»çº¿ç»“ç‚¹å‘å‡ºè¿œç¨‹å¸§ï¼Œè¯·æ±‚å‘é€å…·æœ‰åŒä¸€è¯†åˆ«ç¬¦çš„æ•°æ®å¸§ã€‚
>
> 3. é”™è¯¯å¸§ï¼šä»»ä½•ç»“ç‚¹æ£€æµ‹åˆ°ä¸€æ€»çº¿é”™è¯¯å°±å‘å‡ºé”™è¯¯å¸§ã€‚
>
> 4. è¿‡è½½å¸§ï¼šè¿‡è½½å¸§ç”¨ä»¥åœ¨å…ˆè¡Œçš„å’Œåç»­çš„æ•°æ®å¸§ï¼ˆæˆ–è¿œç¨‹å¸§ï¼‰ä¹‹é—´æä¾›ä¸€é™„åŠ çš„å»¶æ—¶ã€‚
>
> 5. å¸§é—´éš”ï¼šç”¨äºå°†æ•°æ®å¸§åŠè¿œç¨‹å¸§ä¸å‰é¢çš„å¸§åˆ†ç¦»å¼€æ¥çš„å¸§ã€‚


æ•°æ®å¸§ç”± 7 ä¸ªä¸åŒçš„ä½åœºç»„æˆï¼š

![CAN](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000105.png)

é”™è¯¯å¸§ç”¨äºåœ¨æ¥æ”¶å’Œå‘é€æ¶ˆæ¯æ—¶æ£€æµ‹å‡ºé”™è¯¯ï¼Œé€šçŸ¥é”™è¯¯çš„å¸§ã€‚é”™è¯¯å¸§ç”±é”™è¯¯æ ‡å¿—å’Œé”™è¯¯ç•Œ
å®šç¬¦æ„æˆã€‚é”™è¯¯æ ‡å¿—åŒ…æ‹¬ä¸»åŠ¨é”™è¯¯æ ‡å¿—å’Œè¢«åŠ¨é”™è¯¯æ ‡å¿—ä¸¤ç§ã€‚

> 1. ä¸»åŠ¨é”™è¯¯æ ‡å¿—ï¼š6ä¸ªä½çš„æ˜¾æ€§ä½ï¼Œå¤„äºä¸»åŠ¨é”™è¯¯çŠ¶æ€çš„å•å…ƒæ£€æµ‹å‡ºé”™è¯¯æ—¶è¾“å‡ºçš„é”™
>    è¯¯æ ‡å¿—ã€‚
>
> 2. è¢«åŠ¨é”™è¯¯æ ‡å¿—ï¼š6ä¸ªä½çš„éšæ€§ä½ï¼Œå¤„äºè¢«åŠ¨é”™è¯¯çŠ¶æ€çš„å•å…ƒæ£€æµ‹å‡ºé”™è¯¯æ—¶è¾“å‡ºçš„é”™
>    è¯¯æ ‡å¿—ã€‚


é”™è¯¯ç•Œå®šç¬¦ç”±8ä¸ªä½çš„éšæ€§ä½æ„æˆã€‚é”™è¯¯å¸§æ ¼å¼å¦‚ä¸‹è¡¨ç¤ºï¼š

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000104.png)

è¿‡è½½å¸§æ˜¯ç”¨äºæ¥æ”¶å•å…ƒé€šçŸ¥å…¶å°šæœªå®Œæˆæ¥æ”¶å‡†å¤‡çš„å¸§ã€‚è¿‡è½½å¸§ç”±è¿‡è½½æ ‡å¿—å’Œè¿‡è½½ç•Œå®šç¬¦æ„
æˆã€‚è¿‡è½½å¸§æ ¼å¼å¦‚ä¸‹è¡¨ç¤ºï¼š

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000103.png)

å¸§é—´éš”æ˜¯ç”¨äºåˆ†éš”æ•°æ®å¸§å’Œè¿œç¨‹å¸§çš„å¸§ã€‚æ•°æ®å¸§å’Œè¿œç¨‹å¸§å¯é€šè¿‡æ’å…¥å¸§é—´éš”å°†æœ¬å¸§ä¸å‰é¢
çš„ä»»ä½•å¸§ï¼ˆæ•°æ®å¸§ã€è¿œç¨‹å¸§ã€é”™è¯¯å¸§ã€è¿‡è½½å¸§ï¼‰åˆ†å¼€ã€‚è¿‡è½½å¸§å’Œé”™è¯¯å¸§å‰ä¸èƒ½æ’å…¥å¸§é—´éš”ã€‚
å¸§é—´éš”å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000102.png)

#### CANæ€»çº¿çš„ä»²è£æ–¹å¼

åœ¨æ€»çº¿ç©ºé—²æ€ï¼Œæœ€å…ˆå¼€å§‹å‘é€æ¶ˆæ¯çš„å•å…ƒè·å¾—å‘é€æƒã€‚å¤šä¸ªå•å…ƒåŒæ—¶å¼€å§‹å‘é€æ—¶ï¼Œå„å‘é€
å•å…ƒä»ä»²è£æ®µçš„ç¬¬ä¸€ä½å¼€å§‹è¿›è¡Œä»²è£ã€‚è¿ç»­è¾“å‡ºæ˜¾æ€§ç”µå¹³æœ€å¤šçš„å•å…ƒå¯ç»§ç»­å‘é€ã€‚å³é€ä½
åœ°å¯¹æ¯”å„ä¸ªç»“ç‚¹å‘å‡ºçš„æŠ¥æ–‡IDã€‚ç”±äºçº¿ä¸çš„å…³ç³»ï¼Œæ˜¾ç¤ºä½â€œ0â€å¯ä»¥è¦†ç›–éšæ€§ä½â€œ1â€ï¼Œå› æ­¤ID
æœ€å°çš„èŠ‚ç‚¹èµ¢å¾—ä»²è£ï¼Œæ€»çº¿ä¸Šè¡¨ç°ä¸ºè¯¥ç»“ç‚¹çš„æŠ¥æ–‡ï¼Œå…¶ä»–ç»“ç‚¹å¤±å»ä»²è£ï¼Œé€€å‡ºå‘é€ï¼Œè½¬ä¸º
æ¥æ”¶çŠ¶æ€ã€‚æ ‡å‡†æ ¼å¼IDä¸å…·æœ‰ç›¸åŒIDçš„è¿œç¨‹å¸§æˆ–è€…æ‰©å±•æ ¼å¼çš„æ•°æ®å¸§åœ¨æ€»çº¿ä¸Šç«äº‰æ—¶ï¼Œæ ‡
å‡†æ ¼å¼çš„RTRä½ä¸ºæ˜¾æ€§ä½çš„å…·æœ‰ä¼˜å…ˆæƒï¼Œå¯ç»§ç»­å‘é€ã€‚

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000101.png)

#### ä½å¡«å……ï¼ˆBitStuffingï¼‰

ä½å¡«å……æ˜¯ä¸ºäº†é˜²æ­¢çªå‘é”™è¯¯è€Œè®¾å®šçš„åŠŸèƒ½ã€‚ä½å¡«å……çš„è§„åˆ™å¦‚ä¸‹ï¼š

> 1. 5ä½è¿ç»­ç›¸åŒç”µå¹³ä¹‹åï¼Œå¿…é¡»å¡«å……ä¸€ä½åå‘ä½ï¼Œå³ä¸å…è®¸æœ‰6ä¸ªè¿ç»­ç›¸åŒä½
>
> 2. SOFä¹‹å‰ä¸ºæ€»çº¿ç©ºé—²çŠ¶æ€ï¼Œä¸éœ€è¦åŒæ­¥ï¼Œå› æ­¤ä¸éœ€è¦ä½å¡«å……
>
> 3. CRCä¹‹åä¸ºå›ºå®šæ ¼å¼ï¼Œä¸å…è®¸å¡«å……
>
> 4. ç”±CANæ§åˆ¶å™¨è‡ªåŠ¨å®ç°

#### CANçš„é”™è¯¯å¤„ç†

CANæ§åˆ¶å™¨æ£€æµ‹é”™è¯¯å…±æœ‰ä»¥ä¸‹5ç§ï¼š

> 1. ä½å¡«å……é”™è¯¯
>    åœ¨ä½¿ç”¨ä½å¡«å……çš„å¸§åœºå†…ï¼Œç»“ç‚¹å¦‚æœæ£€æµ‹åˆ°6ä¸ªè¿ç»­ç›¸åŒçš„ä½å€¼ï¼Œåˆ™äº§ç”Ÿä½å¡«å……é”™è¯¯ï¼Œ
>    åœ¨ä¸‹ä¸€ä½å¼€å§‹æ—¶ï¼Œè¯¥ç»“ç‚¹å°†å‘é€ä¸€ä¸ªé”™è¯¯å¸§ã€‚
>
> 2. ä½é”™è¯¯
>    åœ¨å‘é€æœŸé—´ï¼Œç»“ç‚¹æ£€æµ‹åˆ°æ€»çº¿çš„ä½å€¼ä¸è‡ªèº«å‘é€çš„ä½å€¼ä¸ä¸€è‡´æ—¶ï¼Œåˆ™äº§ç”Ÿä½é”™è¯¯ï¼Œ
>    åœ¨ä¸‹ä¸€ä½å¼€å§‹æ—¶ï¼Œè¯¥ç»“ç‚¹å°†å‘é€ä¸€ä¸ªé”™è¯¯å¸§ã€‚
>
> 3. CRCé”™è¯¯
>    æ¥æ”¶ç»“ç‚¹è®¡ç®—çš„CRCç ä¸æ•°æ®å¸§æœ¬èº«è‡ªå¸¦çš„CRCç ä¸ä¸€è‡´ï¼Œæ¥æ”¶ç»“ç‚¹å°†ä¸¢å¼ƒè¯¥å¸§ï¼Œå¹¶
>    åœ¨ACKç•Œå®šç¬¦ä¹‹åå‘é€ä¸€ä¸ªé”™è¯¯å¸§ã€‚
>
> 4. åº”ç­”é”™è¯¯
>    å‘é€ç»“ç‚¹åœ¨ACK Slotä½ä¼šå‘é€éšæ€§ä½ï¼ŒåŒæ—¶ç›‘å¬æ€»çº¿æ˜¯å¦ä¸ºæ˜¾æ€§ä½ï¼Œå¦‚æœæ˜¯æ˜¾æ€§
>    ä½ï¼Œåˆ™è¡¨æ˜è‡³å°‘ä¸€ä¸ªèŠ‚ç‚¹æ­£ç¡®æ”¶åˆ°è¯¥å¸§ï¼›å¦‚æœæ˜¯éšæ€§ä½ï¼Œå°†äº§ç”ŸACKé”™è¯¯ï¼Œå‘é€ç»“ç‚¹
>    å‘é€ä¸€ä¸ªé”™è¯¯å¸§ã€‚
>
> 5. æ ¼å¼é”™è¯¯
>    å‘é€ç»“èŠ‚åœ¨ï¼ˆCRCç•Œå®šç¬¦ã€ACKç•Œå®šç¬¦ã€å¸§ç»“æŸEOFï¼‰å›ºå®šæ ¼å¼çš„ä½ç½®æ£€æµ‹åˆ°æ˜¾æ€§ä½
>    æ—¶ï¼Œå°†å‘ç”Ÿæ ¼å¼é”™è¯¯ï¼Œå¹¶å‘é€ä¸€ä¸ªé”™è¯¯å¸§ã€‚

#### CANæ€»çº¿åŒæ­¥

CAN æ€»çº¿çš„é€šä¿¡æ–¹å¼ä¸º NRZ æ–¹å¼ã€‚å„ä¸ªä½çš„å¼€å…³æˆ–è€…ç»“å°¾éƒ½æ²¡æœ‰é™„åŠ åŒæ­¥ä¿¡å·ã€‚å‘é€ç»“
ç‚¹ä»¥ä¸ä½æ—¶åºåŒæ­¥çš„æ–¹å¼å¼€å§‹å‘é€æ•°æ®ã€‚å¦å¤–ï¼Œæ¥æ”¶ç»“ç‚¹æ ¹æ®æ€»çº¿ä¸Šç”µå¹³çš„å˜åŒ–è¿›è¡ŒåŒæ­¥
å¹¶è¿›è¡Œæ¥æ”¶å·¥ä½œã€‚ä½†æ˜¯ï¼Œå‘é€ç»“ç‚¹å’Œæ¥æ”¶ç»“ç‚¹å­˜åœ¨çš„æ—¶é’Ÿé¢‘ç‡è¯¯å·®åŠä¼ è¾“è·¯å¾„ä¸Šçš„ï¼ˆç”µç¼†ã€
é©±åŠ¨å™¨ç­‰ï¼‰ç›¸ä½å»¶è¿Ÿä¼šå¼•è¿›åŒæ­¥åå·®ã€‚å› æ­¤æ¥æ”¶ç»“ç‚¹éœ€è¦é€šè¿‡åŒæ­¥çš„æ–¹å¼è°ƒæ•´æ—¶åºè¿›è¡Œæ¥
æ”¶ã€‚åŒæ­¥çš„ä½œç”¨æ˜¯å°½é‡ä½¿æœ¬åœ°ä½æ—¶åºä¸æ€»ç»“ä¿¡å·çš„ä½æ—¶åºä¸€è‡´ï¼ˆæœ¬åœ°åŒæ­¥æ®µä¸æ€»ç»“ä¿¡å·è¾¹
æ²¿åŒæ­¥ï¼‰ã€‚åªæœ‰æ¥æ”¶ç»“ç‚¹éœ€è¦åŒæ­¥ï¼›åŒæ­¥åªä¼šå‘ç”Ÿåœ¨éšæ€§åˆ°æ˜¾æ€§ç”µå¹³çš„è·³æ²¿ã€‚åŒæ­¥çš„æ–¹å¼
ä¸ºç¡¬ä»¶åŒæ­¥å’Œå†åŒæ­¥ã€‚

#### CAN é‡‡æ ·å‘¨æœŸ

æ ‡å‡†æ•°æ®å¸§

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000080.png)

SOF: can å¸§ä»¥ä¸€ä¸ª StartOf-Frame(SOF) ä½å¼€å§‹ï¼Œè¯¥ä½æ˜¯ä¸€ä¸ªæ˜¾æ€§çš„çŠ¶æ€å’Œå…è®¸ç¡¬ä»¶åŒ
æ­¥æ‰€ä»¥çš„èŠ‚ç‚¹ã€‚

> 1. Arbitration Field: å¼€å§‹ä½ä¹‹åæ˜¯ 12 ä½çš„ä»²è£åŸŸ(arbitration field)ï¼Œå…¶ç”± 
>    11 ä½çš„ ID è¯†åˆ«å’Œè¿œç¨‹ä¼ è¾“å¸§è¯·æ±‚ä½ RTR (Remote Transmission Request)ã€‚RTR 
>    ä½ç”¨äºåŒºåˆ†å¸§æ˜¯è¿œç¨‹å¸§ä¸å¦ã€‚
>
> 2. Control Field: æ¥ä¸‹æ¥çš„ä»²è£åŸŸæ˜¯æ§åˆ¶åŸŸï¼ŒåŒ…å« 6 ä¸ªä½ï¼Œå…¶ä¸­çš„ç¬¬ä¸€ä½æ˜¯æ‹“å±•è¯†
>    åˆ«ä½ (Identifier Extension IDE), è¯¥ä½æ˜¾æ€§æŒ‡æ˜æ˜¯å¦æ˜¯æ ‡å‡†å¸§è¿˜æ˜¯æ‹“å±•å¸§ã€‚
>
> 3. Control Field: RB0 ä½é¢„ç•™ç»™ CAN åè®®ï¼Œä¿æŒä¸º 0
>
> 4. Control Field: æ§åˆ¶ä½ä¸­å‰©ä½™çš„ 4 ä½æ˜¯ DLC åŸŸï¼Œè¯¥åŸŸç”¨äºæŒ‡å®š CAN æ•°æ®çš„é•¿åº¦ï¼Œ
>    æ”¯æŒ 0-8 ä½
>
> 5. Data Field: æ¥ä¸‹æ¥çš„æ˜¯æ•°æ®åŸŸ
>
> 6. CRC: æ¥ä¸‹æ¥çš„ 16 ä½æ˜¯å†—é•¿æ£€æµ‹ï¼Œå…¶ä¸­åŒ…æ‹¬ 15 ä½çš„ CRC åºåˆ—ï¼Œç¬¬ 16 ä½ä¸º CRC 
>    åˆ†éš”ç¬¦
>
> 7. ACK field: æœ€åä¸€ä¸ªåŸŸåŒ…å«äº† 2 ä½çš„åº”ç­”åŸŸã€‚åœ¨ ACK Slot bit æœŸé—´ï¼Œä¼ è¾“èŠ‚ç‚¹
>   å‘é€ä¸€ä¸ªæ¥æ”¶ä½ã€‚ä»»ä½•æ¥æ”¶åˆ°ä¸€ä¸ª error-frame Frame æ¥åº”ç­”æ˜¯å¦æ­£ç¡®çš„æ”¶åˆ°æ•°æ®

<span id="CAN æ•°æ®æ ¼å¼"></span>

æ‹“å±•æ•°æ®å¸§

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000081.png)

è¿œç¨‹å¸§

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000082.png)

é”™è¯¯å¸§

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000083.png)

Overload å¸§

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000084.png)

## BIT TIMING è°ƒè¯•

CAN BUS è¿›è¡Œé‡‡æ ·æ—¶ï¼Œæ¯é‡‡ä¸€æ¬¡æ‰€èŠ±çš„æ—¶é—´å¦‚ä¸‹ï¼š
 
![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000085.png)

å› æ­¤ï¼Œé‡‡æ ·å‘¨æœŸ = SyncSeg + PropSeg + PhaseSeg1 + PhaseSeg2 = åŒæ­¥æ®µ + ä¼ æ’­æ—¶é—´
æ®µ + ç›¸ä½ç¼“å­˜æ®µ1 + ç›¸ä½ç¼“å­˜æ®µ2ã€‚
æ ¹æ® MCP2515 çš„ä»‹ç»ï¼Œåä¹‰ä¸Šçš„ BIT rate (NBR) çš„è®¡ç®—å…¬å¼ä¸º

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000086.png)

ä»ä¸Šé¢çš„ tbit è®¡ç®—å‘¨æœŸæˆ‘ä»¬çŸ¥é“ï¼š

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000087.png)

CAN æ€»çº¿çš„æ³¢ç‰¹ç‡ç”±ä¸é‡å çš„æ®µç»„æˆï¼Œå¦‚ä¸Šé¢åˆ†æã€‚æ¯ä¸ªè¿™æ ·çš„æ®µç”±å®Œæ•´çš„å•å…ƒç»„æˆï¼Œæ¯
ä¸ªå•å…ƒç§°ä¸º  Time Quantaï¼ˆTQï¼‰ã€‚å¯¹äºè¿™äº›æ®µï¼Œæˆ‘ä»¬ä¸€ä¸€åˆ†æ

> 1. åŒæ­¥æ®µ SyncSeg:
>
>    åŒæ­¥æ®µæ˜¯ NBT ä¸­çš„ç¬¬ä¸€ä¸ªæ®µï¼Œå…¶ç”¨äºåŒæ­¥æ€»çº¿ä¸Šçš„èŠ‚ç‚¹ã€‚å…¶æœŸæœ› bit çš„è§¦å‘å‘ç”Ÿ
>    åœ¨ SyncSeg å†…, SyncSeg å›ºå®šåœ¨ä¸€ä¸ª TQ å†…
>
> 2. å¹¿æ’­æ®µ PropSeg:
>
>    å¹¿æ’­æ®µçš„å­˜åœ¨æ˜¯ä¸ºäº†æŠµæ¶ˆä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„ç‰©ç†å»¶æ—¶ã€‚å¹¿æ’­å»¶æ—¶å®šä¹‰ä¸ºå¹¿æ’­æ®µçš„ä¸¤å€ã€‚>
>    ä¸€èˆ¬å…¶å€¼ä¸º 1-8 TQ
> 
> 3. è±¡é™ç¼“å­˜æ®µ1,2
>
>    ä¸¤ä¸ªè±¡é™ç¼“å­˜ PS1 å’Œ PS2 ç”¨äºæŠµæ¶ˆé‡‡æ ·æ—¶è§¦å‘é”™è¯¯ï¼ŒPS1 å¯æ”¹å˜ä¸º 1-8TQï¼ŒPS2 
>    å¯ä»¥æ”¹å˜ä¸º 2-8TQ
>
> 4. é‡‡æ ·ç‚¹ Sample Point
>
>    é‡‡æ ·ç‚¹å°±æ˜¯é€»è¾‘ç”µå¹³çš„è¯»å–å’Œç¿»è¯‘ï¼Œé‡‡æ ·ç‚¹ä½äº PS1 çš„æœ«å°¾
>
> 5. IPT
>    
>    The Information Processing Timeã€‚å°±æ˜¯è¯»å–åˆ°ä¸€ä¸ªé€»è¾‘ç”µå¹³çš„æ—¶é—´ï¼ŒIPT å¼€å§‹äº
>    é‡‡æ ·ç‚¹ï¼Œå›ºå®šé•¿åº¦ä¸º 2TQ
>
> 6. SJW
>
>    The Synchronization Jump Width.
>
> 7. TQ
>    
>    Time Quatum, æ¯ä¸ªæ®µéƒ½æ˜¯ç”±ä¸€ä¸ªä¸ªå®Œæ•´çš„ TQ ç»„æˆï¼Œå…¶é•¿åº¦åŸºäº tOSCï¼ˆ
>    oscillator  periodï¼‰.åŸºç¡€ TQ ä¸º 2 å€å¤–éƒ¨æ™¶æŒ¯å‘¨æœŸã€‚TQ é•¿åº¦ç­‰äºä¸€ä¸ª TQ æ—¶é’Ÿ
>    å‘¨æœŸ(tBRPCL), å…¶ä¸ä¸€ä¸ªå‚æ•° BRP æœ‰å…³ï¼Œå…¶è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š


æ—¶é’Ÿå‘¨æœŸå›¾å¦‚ä¸‹ï¼š

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000088.png)

-------------------------------------------------------

# <span id="Kernel å†…æ ¸æºç ä¸­ä½¿ç”¨ CAN">Kernel ä¸­æºç ä½¿ç”¨ CAN</span>

> æºç  githubï¼šhttps://github.com/BiscuitOS/HardStack/tree/master/bus/CAN/kernel

ä¸ºäº†èƒ½åœ¨ linux å†…æ ¸ä¸­é€šè¿‡æºç è®¿é—® CANï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤

> 1. é…ç½®å†…æ ¸ï¼Œæ‰“å¼€ CAN æ”¯æŒ
>
> 2. æ·»åŠ å¹¶ç¼–è¯‘æºç 

#### é…ç½®å†…æ ¸ï¼Œæ‰“å¼€ CAN æ”¯æŒ

ä¸ºäº†åœ¨ Linux ä¸­ä½¿ç”¨ CANï¼Œå¼€å‘è€…åº”è¯¥åœ¨ç¼–è¯‘å†…æ ¸çš„æ—¶å€™ï¼Œæ‰“å¼€ CAN å­ç³»ç»Ÿï¼Œå…·ä½“æ­¥éª¤
å¯ä»¥å‚è€ƒå¦‚ä¸‹ï¼š

åœ¨æºç æ ‘ä¸‹ï¼Œä½¿ç”¨å‘½ä»¤è¿›è¡Œå†…æ ¸ç¼–è¯‘

{% highlight ruby %}
make menuconfig ARCH=arm64
{% endhighlight %}

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000065.png)

é€‰æ‹© Networking support --> é€‰é¡¹

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000066.png)

é€‰æ‹© CAN bus subsystem support --->

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000067.png)

é€‰æ‹©ä¸€ä¸‹é€‰é¡¹ï¼Œå¹¶è¿›å…¥ CAN Device Drivers --->

{% highlight ruby %}
<*> Raw CAN protocol (raw access with CAN-ID filtering)
<*> Broadcast Manager CAN Protocol (with content filtering)
<*> CAN Gateway/Route (with netlink configuration)
{% endhighlight %}

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000068.png)

æœ€åé€‰æ‹© **CAN bit-timing calculation**. ä¿å­˜é€€å‡ºä¹‹åï¼ŒæŸ¥çœ‹ .config ä¸­æ˜¯å¦åŒ…å«
å¦‚ä¸‹å®ï¼š

{% highlight ruby %}
CONFIG_CAN=y
CONFIG_CAN_RAW=y
CONFIG_CAN_BCM=y
CONFIG_CAN_GW=y
CONFIG_CAN_DEV=y
CONFIG_CAN_CALC_BITTIMING=y
{% endhighlight %}

#### æ·»åŠ å¹¶ç¼–è¯‘æºç 

æ€»å…±æœ‰ä¸¤ä¸ªé©±åŠ¨: can.c å’Œ can_adv.cã€‚ ä¸¤ä¸ªé©±åŠ¨éƒ½æ˜¯åœ¨å†…æ ¸ä¸­æºç å¦‚ä½•ä½¿ç”¨ CAN çš„ï¼Œ
å…¶ä¸­ can.c åªæ¶‰åŠç®€å•çš„ CAN è®¾å¤‡æ³¨å†Œï¼Œè€Œ can_adv.c åˆ™åŒ…å«äº† CAN è®¾å¤‡çš„æ•°æ®æ”¶å‘
æ–¹æ³•ç­‰ã€‚å¼€å‘è€…å¯ä»¥æ ¹æ®éœ€æ±‚è‡ªè¡Œå‚è€ƒã€‚

can.c

{% highlight ruby %}
/*
* Can demo driver
*
* (C) 2018.12.18  BuddyZhang1 <buddy.zhang@aliyun.com>
*
* This program is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License version 2 as
* published by the Free Software Foundation.
*/
#include <linux/init.h>
#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/netdevice.h>
#include <linux/can/core.h>
#include <linux/can/dev.h>

#define TX_ECHO_SKB_MAX  1

static struct net_device *can_net;

/* 'ifconfig canx up' will invoke this function firstly. */
static int demo_open(struct net_device *net)
{
    /* Open can device and do some specify operation. */
    return 0;
}

/* 'ifconfig canx down' will invoke this function firstly. */
static int demo_stop(struct net_device *net)
{
    /* Close can device and do some release operation. */
    return 0;
}

static netdev_tx_t demo_hard_start_xmit(struct sk_buff *skb,
                                              struct net_device *dev)
{
    /* To do Can transfer data */
    return NETDEV_TX_OK;
}

static const struct net_device_ops demo_netdev_ops = {
    .ndo_open   = demo_open,
    .ndo_stop   = demo_stop,
    .ndo_start_xmit = demo_hard_start_xmit,
};

static int __init demo_can_device_init(void)
{
    int ret;

    /* Allocate can/net device */
    can_net = alloc_candev(sizeof(*can_net), TX_ECHO_SKB_MAX);
    if (!can_net) {
        ret = -ENOMEM;
        goto error_alloc;
     }

    can_net->netdev_ops = &demo_netdev_ops; /* necessary */

    /* register can device */
    ret = register_candev(can_net);
    if (ret) {
        ret = -EINVAL;
        goto error_register_dev;
    }
    
    return 0;

error_register_dev:
    free_candev(can_net);
error_alloc:
    return ret;
}

static void __exit demo_can_device_exit(void)
{
    /* Unregister can device */
    unregister_candev(can_dev);

    /* release can device */
    free_candev(can_net);
}

module_init(demo_can_device_init);
module_exit(demo_can_device_exit);
MODULE_LICENSE("GPL v2");
{% endhighlight %}

can_adv.c

{% highlight ruby %}
/*
* Perfect Can driver
*
* (C) 2018.12.18 BuddyZhang1 <buddy.zhang@aliyun.com>
*
* This program is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License version 2 as
* published by the Free Software Foundation.
*/
#include <linux/init.h>
#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/netdevice.h>
#include <linux/can/core.h>
#include <linux/can/dev.h>

#define CAN_FRAME_MAX_DATA_LEN     8
#define DEMO_TRANSFER_BUF_LEN      (6 + CAN_FRAME_MAX_DATA_LEN)
#define TX_ECHO_SKB_MAX            1
#define DEVICE_NAME                "demo_can"

/* Can bus frequency */
#define CAN_BUS_FREQUENCY    (1*1024*1024)

static struct net_device *can_net;

/* can device private data */
struct demo_can_private_data
{
    struct can_priv can;    /* can device private data, must be first member */
    struct net_device *net; /* net device */

    /* work queue */
    struct workqueue_struct *wq;
    struct work_struct tx_work;
    struct work_struct restart_work;

    /* trans */
    struct sk_buff *tx_skb;
    int tx_len;

    /* flags */
    int force_quit;
    int after_suspend;
    int restart_tx;
};

/* Can hardware-depends bit-timing */
static struct can_bittiming_const demo_bittiming_const = {
    .name        = DEVICE_NAME,
    .tseg1_min   = 3,
    .tseg1_max   = 16,
    .tseg2_min   = 2,
    .tseg2_max   = 8,
    .sjw_max     = 4,
    .brp_min     = 1,
    .brp_max     = 64,
    .brp_inc     = 1,
};

/* parse can frame and trans */
static void demo_hw_tx(struct demo_can_private_data *priv,
       struct can_frame *frame, int tx_buf_idx)
{
    u32 sid, eid, exide, rtr;

    /* parse can frame */
    exide = (frame->can_id & CAN_EFF_FLAG) ? 1 : 0; /* Extended ID Enable */
    if (exide)
        sid = (frame->can_id & CAN_EFF_MASK) >> 18;
    else
        sid = frame->can_id & CAN_EFF_MASK; /* Standard ID */
    eid = frame->can_id & CAN_EFF_MASK;     /* Extended ID */
    rtr = (frame->can_id & CAN_RTR_FLAG) ? 1 : 0; /* Remote transmission */

    /* prase can frame done. */
}

/* tx work queue handler */
static void demo_tx_work_handler(struct work_struct *ws)
{
    struct demo_can_private_data *priv = container_of(ws,
                 struct demo_can_private_data, tx_work);
    struct net_device *net = priv->net;
    struct can_frame *frame;

    if (priv->tx_skb) {
        if (priv->can.state == CAN_STATE_BUS_OFF) {
        } else {
            frame = (struct can_frame *)priv->tx_skb->data;

            if (frame->can_dlc > CAN_FRAME_MAX_DATA_LEN)
                frame->can_dlc = CAN_FRAME_MAX_DATA_LEN;
            /* process can frame */
            demo_hw_tx(priv, frame, 0);
            priv->tx_len = 1 + frame->can_dlc;
            can_put_echo_skb(priv->tx_skb, net, 0);
            priv->tx_skb = NULL;
        }
    }
}

/* restart work queue */
static void demo_restart_work_handler(struct work_struct *ws)
{
    struct demo_can_private_data *priv =
           container_of(ws, struct demo_can_private_data, restart_work);
    struct net_device *net = priv->net;

    if (priv->after_suspend) {
        priv->after_suspend = 0;
        priv->force_quit    = 0;
    }

    if (priv->restart_tx) {
        priv->restart_tx = 0;
        netif_wake_queue(net);
    }
}

/* 'ifconfig canx up' will invoke this function firstly. */
static int demo_open(struct net_device *net)
{
    /* Open can device and do some specify operation. */
    struct demo_can_private_data *priv = netdev_priv(net);
    int ret;

    /* open can device*/
    ret = open_candev(net);
    if (ret)
        return ret;

    /* clear flags */
    priv->force_quit = 0;
    priv->tx_skb = NULL;
    priv->tx_len = 0;
    
    /* request work queue to process can frame */
    priv->wq = create_freezable_workqueue("demo_can_wq");
    INIT_WORK(&priv->tx_work, demo_tx_work_handler);
    INIT_WORK(&priv->restart_work, demo_restart_work_handler);

    /* hardware initialization */

    /* refresh can state */
    priv->can.state = CAN_STATE_ERROR_ACTIVE;
    /* wakeup net queue */
    netif_wake_queue(net);

    return ret;
}

/* 'ifconfig canx down' will invoke this function firstly. */
static int demo_stop(struct net_device *net)
{
    /* Close can device and do some release operation. */
    return 0;
}

/* To do can transfer data */
static netdev_tx_t demo_hard_start_xmit(struct sk_buff *skb,
                   struct net_device *net)
{
    struct demo_can_private_data *priv = netdev_priv(net);

    if (priv->tx_skb || priv->tx_len)
        return NETDEV_TX_BUSY;

    if (can_dropped_invalid_skb(net, skb))
        return NETDEV_TX_OK;

    netif_stop_queue(net);
    priv->tx_skb = skb;
    queue_work(priv->wq, &priv->tx_work);
    return NETDEV_TX_OK;
}

static const struct net_device_ops demo_netdev_ops = {
    .ndo_open   = demo_open,
    .ndo_stop   = demo_stop,
    .ndo_start_xmit = demo_hard_start_xmit,
};

/*
* Set can mode.
*  Can device support CAN_MODE_START, CAN_MODE_STOP and CAN_MODE_SLEEP.
* @net: net device
* @mode: can mode that be setup.
*/
static int demo_do_set_mode(struct net_device *net, enum can_mode mode)
{
    switch (mode) {
    case CAN_MODE_START:
        break;
    case CAN_MODE_STOP:
        break;
    case CAN_MODE_SLEEP:
        break;
    default:
        return -EOPNOTSUPP;
    }
    return 0;
}

static __init int demo_can_device_init(void)
{
    struct net_device *net;
    struct demo_can_private_data *priv;
    int ret;

    /* Allocate can/net device */
    net = alloc_candev(sizeof(struct demo_can_private_data), TX_ECHO_SKB_MAX);
    if (!net) {
        ret = -ENOMEM;
        goto error_alloc;
    }

    net->netdev_ops = &demo_netdev_ops; /* necessary */
    net->flags |= IFF_ECHO;

    /* get private data for can device */
    priv = netdev_priv(net);
    can_net = net;
    /* Setup can bit-timing parameters */

    /* Setup can hardware-dependent bit-timing */
    priv->can.bittiming_const = &demo_bittiming_const;
    /* Setup interface for can mode */
    priv->can.do_set_mode = demo_do_set_mode;
    /* Setup can bus frequence. */
    priv->can.clock.freq = CAN_BUS_FREQUENCY;
    /* Setup can device control mode */
    priv->can.ctrlmode_supported = CAN_CTRLMODE_3_SAMPLES |
          CAN_CTRLMODE_LOOPBACK |  CAN_CTRLMODE_LISTENONLY;
    /* callback */
    priv->net = net;

    /* register can device */
    ret = register_candev(net);
    if (ret) {
        ret = -EINVAL;
        goto error_register_dev;
    }
    
    return 0;

error_register_dev:
    free_candev(net);
error_alloc:
    return ret;
}

static void __exit demo_can_device_exit(void)
{
    /* Unregister can device */
    unregister_candev(can_net);

    /* release can device */
    free_candev(can_net);
}

module_init(demo_can_device_init);
module_exit(demo_can_device_exit);
MODULE_LICENSE("GPL");
{% endhighlight %}

Makefile

{% highlight ruby %}
obj-m += can.o

KERNELDIR ?= /lib/modules/$(shell uname -r)/build

PWD       := $(shell pwd)

ROOT := $(dir $(M))
DEMOINCLUDE := -I$(ROOT)../include -I$(ROOT)/include

GCCVERSION = $(shell gcc -dumpversion | sed -e 's/\.\([0-9][0-9]\)/\1/g' -e 's/\.\([0-9]\)/0\1/g' -e 's/^[0-9]\{3,4\}$$/&00/')

GCC49 := $(shell expr $(GCCVERSION) \>= 40900)

all:
        $(MAKE) -C $(KERNELDIR) M=$(PWD) modules

install: all
        $(MAKE) -C $(KERNELDIR) M=$(PWD) modules_install
        depmod -a

clean:
        rm -rf *.o *.o.d *~ core .depend .*.cmd *.ko *.ko.unsigned *.mod.c .tmp_versions *.symvers \
        .cache.mk *.save *.bak Modules.* modules.order Module.markers *.bin

CFLAGS_can.o := -Wall $(DEMOINCLUDE)

ifeq ($(GCC49),1)
        CFLAGS_can.o += -Wno-error=date-time
endif

CFLAGS_can.o := $(DEMOINCLUDE)
{% endhighlight %}

#### CAN é©±åŠ¨ä½¿ç”¨

å¼€å‘è€…å¯ä»¥å°†ä¸Šè¿°é©±åŠ¨æ·»åŠ åˆ°å†…æ ¸æºç æ ‘ä¸­è¿›è¡Œç¼–è¯‘ï¼Œæˆ–è€…ä½¿ç”¨ä¸Šè¿°çš„ Makefile è¿›è¡Œå¤–
éƒ¨ç¼–è¯‘ã€‚å½“ç¼–è¯‘æˆæ¨¡å—ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åŠ å¦‚åˆ°è¿è¡Œçš„å†…æ ¸ä¸­ï¼š

{% highlight ruby %}
sudo insmod can.ko
{% endhighlight %}

å½“æ·»åŠ å®Œæ¨¡å—æˆ– CAN é©±åŠ¨å·²ç»è¢«ç¼–è¯‘åˆ°å†…æ ¸ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ net-tools å·¥å…·æŸ¥çœ‹ CAN 
è®¾å¤‡æ˜¯å¦æ·»åŠ æˆåŠŸï¼Œå¦‚ä¸‹ï¼š

{% highlight ruby %}
root@BiscuitOS:~# ifconfig -a
{% endhighlight %}

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000089.png)

-----------------------------------------------------

# <span id="ç”¨æˆ·ç©ºé—´å·¥å…·ä½¿ç”¨ CAN">ç”¨æˆ·ç©ºé—´è®¿é—® CAN</span>

ç”¨æˆ·ç©ºé—´è¦è®¿é—® CAN è®¾å¤‡ï¼Œå¿…é¡»ç»è¿‡ä¸¤ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

> 1. é…ç½® CAN è®¾å¤‡
>
> 2. é€šè¿‡å·¥å…·æˆ–æºç è®¿é—® CAN è®¾å¤‡


### é…ç½® CAN è®¾å¤‡

åœ¨ä½¿ç”¨ CAN è®¾å¤‡ä¹‹å‰ï¼Œéœ€è¦å¯¹ CAN è®¾å¤‡è¿›è¡Œé…ç½®ï¼Œä¸»è¦é…ç½® CAN çš„æ³¢ç‰¹ç‡å’Œ bus-off 
æ¢å¤æ—¶é—´ç­‰å‚æ•°ã€‚å¼€å‘è€…å¯ä»¥ä½¿ç”¨ ip å‘½ä»¤æˆ– can-tools è¿›è¡Œé…ç½®ã€‚ip å·¥å…·éœ€è¦å¢å¼ºç‰ˆ
çš„ ip-route2 æ”¯æŒï¼Œå¦‚æœå†…æ ¸ä¸­ä¸åŒ…å«äº†è¿™ä¸ªå·¥å…·ï¼Œå¯ä»¥åœ¨ busybox ä¸­æ‰“å¼€è¿™ä¸ªå·¥å…·ã€‚
å¼€å‘è€…å¯ä»¥ä½¿ç”¨ can-tools å·¥å…·é›†è¿›è¡Œ CAN é…ç½®ï¼Œä»¥ä¸Šä¸¤ä¸ªå·¥å…·çš„ç§»æ¤å’Œä½¿ç”¨åœ¨ä¸‹æ–‡ä¸­
å°†è¯¦ç»†ä»‹ç»ã€‚

##### ip-route2 çš„é…ç½®

å¼€å‘è€…å¦‚ä½•æºç æ ‘ä¸­åŒ…å«äº† Busyox çš„æºç ï¼Œå¯ä»¥å‚ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡Œ ip-route2 å·¥å…·çš„
é…ç½®ã€‚é¦–å…ˆï¼Œåœ¨ Busybox æºç ä¸­ï¼Œä½¿ç”¨å‘½ä»¤æ‰“å¼€å›¾å½¢åŒ–é…ç½®çª—å£ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

{% highlight ruby %}
cd Busybox
make menuconfig
{% endhighlight %}

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000090.png)

è¿›å…¥ Network ---> 

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000091.png)

è¿›å…¥ Routing and Redirection --->

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000092.png)

å‹¾é€‰ ip-bridge å·¥å…·

##### can-tools å·¥å…·é…ç½®

å¦‚æœå¼€å‘è€…çš„ç¼–è¯‘æºç æ ‘ä¸­ä¸åŒ…å« Busybox æºç ï¼Œå¯ä»¥ä½¿ç”¨ can-toolsã€‚can-tools çš„
ç§»æ¤éœ€è¦ä¸¤ä¸ªæºç åŒ…ï¼Œgithub ä½ç½®å¦‚ä¸‹ï¼š

> https://github.com/BiscuitOS/HardStack/tree/master/bus/CAN/user/tools

å¼€å‘è€…å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤ä¸‹è½½æºç ä¹Ÿå¯ä»¥è‡ªè¡Œä¸‹è½½ï¼š

{% highlight ruby %}
cd /tmp/
mkdir CAN
cd CAN
git init
git remote add -f  origin https://github.com/BiscuitOS/HardStack.git
git config core.sparsecheckout true
echo "CAN" >> .git/info/sparse-checkout
git pull origin master
cd bus/CAN/user/tools/
{% endhighlight %}

é€šè¿‡ä¸Šé¢çš„å‘½ä»¤å°†è·å¾—ä¸¤ä¸ªæºç å‹ç¼©åŒ…ï¼š **canutils.tar.gz** å’Œ 
**libsocketcan.tar.gz**

ç”±äº canutils ä¾èµ–äº libsocketcan åº“ï¼Œæ‰€ä»¥é¦–å…ˆç¼–è¯‘ libsocketcanï¼Œè¯·å¼€å‘è€…å‚è€ƒ
å¦‚ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼Œ

{% highlight ruby %}
tar -xvjf libsocketcan.tar.gz
cd libsocketcan/
./configure --host=arm-openwrt-linux --prefix=/tmp/CAN/libsocketcan/output
make
make install
{% endhighlight %}

æ¥ä¸‹æ¥ç¼–è¯‘ canutils å·¥å…·é›†åˆï¼Œè¯·å‚è€ƒå¦‚ä¸‹å‘½ä»¤

{% highlight ruby %}
tar -xvjf canutils.tar.gz
cd canutils/
./configure --host=arm-openwrt-linux --prefix=/tmp/CAN/output libsocketcan_LDFLAGS=-L/tmp/CAN/libsocketcan/output/lib libsocketcan_LIBS=-lsocketcan libsocketcan_CFLAGS=-I/tmp/CAN/libsocketcan/output/include LDFLAGS=-L/tmp/CAN/libsocketcan/output/lib CPPFLAGS=-I/tmp/CAN/libsocketcan/output/include
make
make install
{% endhighlight %}

ç¼–è¯‘å®Œä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾ï¼š

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000093.png)

canutils æä¾›äº†äº”ä¸ªå·¥å…·ï¼šcandump, canecho, cansend, canconfig, å’Œ cansequenceã€‚
å°†è¿™äº›å·¥å…·æ‹·è´åˆ°ç›®æ ‡ç‰ˆçš„ /usr/bin/ ç›®å½•ä¸‹ã€‚è‡³æ­¤ï¼ŒCAN å·¥å…·å‡†å¤‡å®Œæˆã€‚

## CAN å·¥å…·ä½¿ç”¨

å·¥å…·å‡†å¤‡ä¹‹åï¼Œæ¥ä¸‹æ¥å¼€å§‹é…ç½® CAN è®¾å¤‡ã€‚ç›®å‰å¼€å‘è€…å¯ä»¥ä½¿ç”¨ ip å‘½ä»¤å’Œ cantuils 
å·¥å…·é›†ã€‚ä¸‹é¢å†…å®¹å°†æŒ‰å·¥å…·è¿›è¡Œè®²è§£ã€‚

### ip å·¥å…·é…ç½® CAN è®¾å¤‡

åœ¨ Linux ç³»ç»Ÿä¸­ï¼ŒCAN æ€»çº¿æ¥å£è®¾å¤‡ä½œä¸ºç½‘ç»œè®¾å¤‡è¢«ç³»ç»Ÿè¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚åœ¨æ§åˆ¶å°ä¸‹ï¼Œ
CAN æ€»çº¿çš„é…ç½®å’Œä»¥å¤ªç½‘çš„é…ç½®ä½¿ç”¨ç›¸åŒçš„å‘½ä»¤ã€‚åœ¨æ§åˆ¶å°ä¸Šè¾“å…¥å‘½ä»¤ï¼š

{% highlight ruby %}
ifconfig -a
{% endhighlight %}

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000094.png)

ä½¿ç”¨å‘½ä»¤ä¹‹åï¼Œå¯ä»¥çœ‹åˆ° can0 è®¾å¤‡ç›¸å…³ä¿¡æ¯ï¼Œä½†æ­¤æ—¶çš„çŠ¶æ€æ˜¯ DOWNï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ä¹‹å‰
éœ€è¦å°† can0 è®¾ç½®ä¸º UPã€‚ä¸ºäº†ä½¿ CAN è®¾å¤‡è®¾ç½®ä¸º UP çŠ¶æ€ï¼Œéœ€è¦è®¾ç½® CAN è®¾å¤‡çš„æ³¢ç‰¹
ç‡ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹å‘½ä»¤ï¼Œå°† can0 çš„æ³¢ç‰¹å…°è®¾ç½®ä¸º 125Kï¼š

{% highlight ruby %}
ip link set can0 up type can bitrate 1000000
{% endhighlight %}

å½“è®¾ç½®å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥è¯¢ can0 è®¾å¤‡çš„è®¾ç½®ï¼š

{% highlight ruby %}
ip -details link show can0
{% endhighlight %}

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000070.png)

é€šè¿‡ä¸Šé¢çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åˆ° can0 å·²ç» UPï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥æ“ä½œ can0 äº†ã€‚ä¹Ÿå¯
ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤å–æ¶ˆ can0 è®¾å¤‡ä½¿èƒ½

{% highlight ruby %}
ifconfig can0 down
{% endhighlight %}

åœ¨è®¾å¤‡å·¥ä½œä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æŸ¥è¯¢å·¥ä½œçŠ¶æ€

{% highlight ruby %}
ip -details -statistics link show can0
{% endhighlight %}

### canutils å·¥å…·é…ç½® CAN è®¾å¤‡

canutils å·¥å…·é›†æä¾›äº†äº”ä¸ªæœ‰ç”¨çš„å·¥å…·ï¼Œåˆ†åˆ«æ˜¯ canconfig, candump, canecho, 
candump å’Œ cansequenceã€‚æ¯ä¸ªå·¥å…·çš„è¯´æ˜å¦‚ä¸‹ï¼š

# canconfig

canconfig ç”¨äºé…ç½® CAN è®¾å¤‡çš„å‚æ•°ï¼Œå…¶ä¸­åŒ…æ‹¬ bitrate çš„è®¾ç½®ï¼Œä¹Ÿå¯ä»¥è®¾ç½® BR å’Œ 
SP çš„å€¼ï¼Œå…¶ä¸­æˆ‘ä»¬æ¯”è¾ƒå…³å¿ƒçš„å°±æ˜¯ CAN é¢‘ç‡è®¾ç½®å’Œæ§åˆ¶æ¨¡å¼ã€‚å¦‚æœæ³¢å½¢çš„ TQ æœ‰é—®é¢˜çš„
è¯ï¼Œå¯ä»¥è®¾ç½® tq çš„å€¼ç­‰ã€‚

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000095.png)

å¼€å‘è€…åœ¨ä½¿ç”¨ can è®¾å¤‡ä¹‹å‰ï¼Œè¦å…ˆè®¾ç½® can æ€»çº¿çš„é¢‘ç‡ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œé‚£ä¹ˆåœ¨ up can 
è®¾å¤‡çš„æ—¶å€™å°±ä¼šæŠ¥é”™ï¼ŒåŸå› æ˜¯ can è®¾å¤‡åœ¨ open çš„æ—¶å€™ï¼Œä¼šæ£€æµ‹æ˜¯å¦å·²ç»è®¾ç½®äº† 
bittimingï¼Œ å¦‚æœæ²¡æœ‰è®¾ç½®å°±æŠ¥é”™ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆé…ç½® can è®¾å¤‡çš„ bittimingï¼Œä½¿ç”¨å¦‚ä¸‹
å‘½ä»¤

{% highlight ruby %}
canconfig canX bitrate 125000
{% endhighlight %}

##### candump

ä½¿ç”¨ candump æ¥æ”¶ can åŒ…

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000096.png)

##### canecho

ä½¿ç”¨ canecho æŸ¥çœ‹ canX çŠ¶æ€

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000097.png)

##### cansend

ä½¿ç”¨ cansend å‘é€ can åŒ…

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000098.png)

### canutils å·¥å…·ä½¿ç”¨

canconfig é…ç½® CAN è®¾å¤‡

{% highlight ruby %}
canconfig can0 restart-ms 1000 bitrate 10000000 ctrmode triple-sampling on
canconfig can1 restart-ms 1000 bitrate 10000000 ctrmode triple-sampling on
{% endhighlight %}

canconfig å¯åŠ¨å‘½ä»¤

{% highlight ruby %}
canconfig can0 start
canconfig can1 start
{% endhighlight %}

cansend å‘é€å‘½ä»¤

{% highlight ruby %}
cansend can0 7ff@898787
cansend can1 7ff#234567
{% endhighlight %}

candump ç›‘æ§æ¥å—å‘½ä»¤

{% highlight ruby %}
candump can0
candump can1
{% endhighlight %}

canconfig åœæ­¢å‘½ä»¤

{% highlight ruby %}
canconfig can0 stop
canconfig can1 stop
{% endhighlight %}

## <span id="ç”¨æˆ·ç©ºé—´æºç ä½¿ç”¨ CAN">æºç è®¿é—® CAN è®¾å¤‡</span>

å½“é…ç½®å¥½ä¸€ä¸ª CAN è®¾å¤‡ä¹‹åï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç è¿›è¡Œ CAN è®¾å¤‡çš„æ•°æ®é¦–å‘ï¼Œæºç 
åˆ†ä¸ºä¸¤ä¸ªï¼Œä¸€ä¸ªç”¨äºæè¿°å¦‚ä½•é€šè¿‡ CAN è®¾å¤‡å‘é€æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºæè¿°å¦‚ä½•é€šè¿‡ CAN è®¾å¤‡æ¥å—æ•°æ®ã€‚

can_tx.c: ç”¨äºæè¿°å¦‚ä½•é€šè¿‡ CAN è®¾å¤‡å‘é€æ•°æ®

{% highlight ruby %}
/*
* CAN send message
*
* (C) 2018.12.18 BuddyZhang1 <buddy.zhang@aliyun.com>
*
* This program is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License version 2 as
* published by the Free Software Foundation.
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <net/if.h>
#include <sys/ioctl.h>
#include <sys/socket.h>
#include <linux/can.h>
#include <linux/can/raw.h>

int main(void)
{
    int s, nbytes;
    struct sockaddr_can addr;
    struct ifreq ifr;
    struct can_frame frame[2] = {{0}};
    
    /* Create can socket */
    s = socket(PF_CAN, SOCK_RAW, CAN_RAW);
    strcpy(ifr.ifr_name, "can0");
    /* set can device */
    ioctl(s, SIOCGIFINDEX, &ifr);
    addr.can_family = AF_CAN;
    addr.can_ifindex = ifr.ifr_ifindex;
    /* bind to can0 */
    bind(s, (struct sockaddr *)&addr, sizeof(addr));
    /* forbidden filter rule, only send message. */
    setsockopt(s, SOL_CAN_RAW, CAN_RAW_FILTER, NULL, 0);
    /* Create two message */
    frame[0].can_id  = 0x011;
    frame[0].can_dlc = 1;
    frame[0].data[0] = 0x23;
    frame[1].can_id  = 0x01;
    frame[1].can_dlc = 1;
    frame[1].data[0] = 'N';

    /* send meesage nop */
    while (1) {
        /* Send first message */
        nbytes = write(s, &frame[0], sizeof(frame[0]));
        if (nbytes != sizeof(frame[0])) {
            printf("Send Error frame[0] bytes %d\n", nbytes);
            break;
        } else
            printf("Write1 %d\n", nbytes);
        sleep(1);
        /* Send second message */
        nbytes = write(s, &frame[1], sizeof(frame[1]));
        if (nbytes != sizeof(frame[1])) {
            printf("Send Error frame[1] %d\n", nbytes);
            break;
        } else
            printf("Write2 %d\n", nbytes);
        sleep(1);
    }
    close(s);
    return 0;
}
{% endhighlight %}

can_rx.c: é€šè¿‡ CAN è®¾å¤‡æ¥å—æ•°æ®

{% highlight ruby %}
/*
* CAN receive message
*
* (C) 2018.12.18 BuddyZhang1 <buddy.zhang@aliyun.com>
*
* This program is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License version 2 as
* published by the Free Software Foundation.
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <net/if.h>
#include <sys/ioctl.h>
#include <sys/socket.h>
#include <linux/can.h>
#include <linux/can/raw.h>

int main(void)
{
    int s, nbytes;
    struct sockaddr_can addr;
    struct ifreq ifr;
    struct can_frame frame;
    struct can_filter rfilter[1];

    /* Create socket */
    s = socket(PF_CAN, SOCK_RAW, CAN_RAW);
    strcpy(ifr.ifr_name, "can0");
    ioctl(s, SIOCGIFINDEX, &ifr);
    addr.can_family = AF_CAN;
    addr.can_ifindex = ifr.ifr_ifindex;
    /* bind socket to can0 */
    bind(s, (struct sockaddr *)&addr, sizeof(addr));
    /* define rule to filter can frame */
    rfilter[0].can_id = 0x11;
    rfilter[0].can_mask = CAN_SFF_MASK;
    /* setup filter rule */
    setsockopt(s, SOL_CAN_RAW, CAN_RAW_FILTER, &rfilter, sizeof(rfilter));
    /* monitoring can0 */
    printf("|    ID    |     DLC     |  DATA[0]\n");
    while (1) {
        /* Receive message */
        nbytes = read(s, &frame, sizeof(frame));
        /* dump message */
        if (nbytes > 0)
            printf("%#x %#x %#x\n", frame.can_id,
                   frame.can_dlc, frame.data[0]);
    }
    close(s);
    return 0;
}
{% endhighlight %}

ä¸Šé¢çš„ç¨‹åºä¸»è¦æ˜¯å¯¹ä¸€ä¸ªå·²ç»å¤„äº UP çŠ¶æ€çš„ can æ¥å£è¿›è¡Œæ•°æ®çš„å†™ï¼Œå…¶ä»£ç é€»è¾‘å¦‚
ä¸‹ï¼š

#### åˆå§‹åŒ–

é¦–å…ˆåœ¨ç”¨æˆ·ç©ºé—´å¯¹ socketcan è¿›è¡Œåˆå§‹åŒ–åŠ¨ä½œï¼Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œä½¿ç”¨ 
struct sockaddr_can æ¥è¡¨ç¤º canï¼Œå…¶å®šä¹‰åœ¨ /usr/include/linux/can.h æ–‡ä»¶ä¸­ï¼Œ
å¦‚ä¸‹ï¼š 

{% highlight ruby %}
/**
 * struct sockaddr_can - the sockaddr structure for CAN sockets
 * @can_family:  address family number AF_CAN.
 * @can_ifindex: CAN network interface index.
 * @can_addr:    protocol specific address information
 */
struct sockaddr_can {
        __kernel_sa_family_t can_family;
        int         can_ifindex;
        union {
                /* transport protocol class address information (e.g. ISOTP) */
                struct { canid_t rx_id, tx_id; } tp;
                /* reserved for future CAN protocols address information */
        } can_addr;
};
{% endhighlight %}

æ¥ç€ä½¿ç”¨ struct ifreq ç»“æ„ä½“ç”¨æ¥é…ç½® ip åœ°å€ï¼Œæ¿€æ´»æ¥å£å’Œé…ç½® MTU ç­‰æ¥å£ä¿¡æ¯ã€‚
å…¶ä¸­åŒ…å«ä¸€ä¸ªæ¥å£çš„åå­—å’Œå…·ä½“å†…å®¹ï¼ˆæ˜¯ä¸ªå…±ç”¨ä½“ï¼Œæœ‰å¯èƒ½æ˜¯ IP åœ°å€ï¼Œå¹¿æ’­åœ°å€ï¼Œå­ç½‘
æ©ç ï¼ŒMAC å·ï¼ŒMTU æˆ–å…¶ä»–å†…å®¹ï¼‰ã€‚å› æ­¤ï¼ŒCAN åº”ç”¨ç¨‹åºçš„åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š

{% highlight ruby %}
int s, nbytes;
struct sockaddr_can addr;
struct ifreq ifr;
struct can_frame frame[2] = {{0}};

/* Create can socket */
s = socket(PF_CAN, SOCK_RAW, CAN_RAW);
strcpy(ifr.ifr_name, "can0");

/* set can device */
ioctl(s, SIOCGIFINDEX, &ifr);
addr.can_family = AF_CAN;
addr.can_ifindex = ifr.ifr_ifindex;
bind(s, (struct sockaddr *)&addr, sizeof(addr));
{% endhighlight %}

è°ƒç”¨ socket() å‡½æ•°åˆ›å»º socketï¼ŒCAN ä¼ å…¥ PF_CAN, socket æ˜¯åŸå§‹ socket å’ŒåŸå§‹ 
CANã€‚ç½‘ç»œæ¥å£çš„åå­—è®¾ç½®ä¸º can0. è°ƒç”¨ ioctl å‡½æ•°ä¼ å…¥ SIOCGIFINDEXï¼Œ æŒ‡å®š 
can0 ã€‚å¹¶è®¾ç½® sockaddr_can çš„ can_family ä¸º AF_CAN ï¼Œæœ€åè°ƒç”¨ bind() å‡½æ•°ï¼Œå°† 
can0 ä¸ socket è®¾å¤‡æŒ‚é’©ã€‚æ”¯æŒç”¨æˆ·ç©ºé—´ can0 åˆå§‹åŒ–å®Œæˆã€‚

#### æ•°æ®å‘é€

åœ¨æ•°æ®æ”¶å‘å†…å®¹æ–¹é¢ï¼ŒCAN æ€»çº¿ä¸æ ‡å‡†å¥—æ¥å­—é€šä¿¡ç¨å¾®ä¸åŒï¼Œæ¯ä¸€æ¬¡é€šä¿¡éƒ½é‡‡ç”¨ 
can_frame ç»“æ„ä½“å°†æ•°æ®å°è£…æˆå¸§ã€‚struct can_frame çš„å®šä¹‰å¦‚ä¸‹ï¼š

{% highlight ruby %}
/**
 * struct can_frame - basic CAN frame structure
 * @can_id:  CAN ID of the frame and CAN_*_FLAG flags, see canid_t definition
 * @can_dlc: frame payload length in byte (0 .. 8) aka data length code
 *           N.B. the DLC field from ISO 11898-1 Chapter 8.4.2.3 has a 1:1
 *           mapping of the 'data length code' to the real payload length
 * @data:    CAN frame payload (up to 8 byte)
 */
struct can_frame {
        canid_t can_id;  /* 32 bit CAN_ID + EFF/RTR/ERR flags */
        __u8    can_dlc; /* frame payload length in byte (0 .. CAN_MAX_DLEN) */
        __u8    data[CAN_MAX_DLEN] __attribute__((aligned(8)));
};
{% endhighlight %}

can_id ä¸ºå¸§çš„æ ‡è¯†ç¬¦ï¼Œå¦‚æœå‘å‡ºå»çš„æ˜¯æ ‡å‡†å¸§ï¼Œå°±ä½¿ç”¨ can_id çš„ä½ 11 ä½ã€‚å¦‚æœæ˜¯æ‹“
å±•å¸§ï¼Œå°±ä½¿ç”¨ 0~28 ä½ã€‚can_id çš„ç¬¬ 29 ï¼Œ30, 31 ä½æ˜¯å¸§çš„æ ‡å¿—ä½ï¼Œç”¨æ¥å®šä¹‰å¸§çš„ç±»
å‹ã€‚å®šä¹‰å¦‚ä¸‹ï¼š

{% highlight ruby %}
#define CAN_EFF_FLAG 0x80000000U    //æ‹“å±•çš„æ ‡è¯†
#define CAN_RTR_FLAG 0x40000000U    //è¿œç¨‹å¸§çš„æ ‡è¯†
#define CAN_ERR_FLAG 0x20000000U    //é”™è¯¯å¸§çš„æ ‡è¯†ï¼Œç”¨äºé”™è¯¯æ£€æŸ¥
{% endhighlight %}

æ•°æ®å‘é€ä½¿ç”¨ write å‡½æ•°æ¥å®ç°ï¼Œå¦‚æœå‘é€çš„æ•°æ®å¸§ï¼ˆæ ‡è¯†ç¬¦ä¸º 0x123ï¼‰ åŒ…å«å•ä¸ªå­—
èŠ‚ (0xAB) çš„æ•°æ®ï¼Œå¯é‡‡ç”¨å¦‚ä¸‹æ–¹æ³•è¿›è¡Œå‘é€ï¼š

{% highlight ruby %}
struct can_frame frame;
int nbytes;
frame.can_id = 0x123; // å¦‚æœä¸ºæ‹“å±•å¸§ï¼Œé‚£ä¹ˆ frame.can_id = CAN_EFF_FLAG | 0x123
frame.can_dlc = 1; // æ•°æ®é•¿åº¦ä¸º 1
frame.data[0] = 0xAB; // æ•°æ®å†…å®¹ä¸º 0xAB
nbytes = write(s, &frame, sizeof(frame)); // å‘é€æ•°æ®
if (nbytes != sizeof(frame))
    printf("ERROR.\n");
{% endhighlight %}

Can åœ¨ç”¨æˆ·ç©ºé—´ä½¿ç”¨ struct can_frame æ¥è¡¨ç¤ºä¸€ä¸ª CAN å¸§ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

{% highlight ruby %}
/**
 * struct can_frame - basic CAN frame structure
 * @can_id:  CAN ID of the frame and CAN_*_FLAG flags, see canid_t definition
 * @can_dlc: frame payload length in byte (0 .. 8) aka data length code
 *           N.B. the DLC field from ISO 11898-1 Chapter 8.4.2.3 has a 1:1
 *           mapping of the 'data length code' to the real payload length
 * @data:    CAN frame payload (up to 8 byte)
 */
struct can_frame {
        canid_t can_id;  /* 32 bit CAN_ID + EFF/RTR/ERR flags */
        __u8    can_dlc; /* frame payload length in byte (0 .. CAN_MAX_DLEN) */
        __u8    data[CAN_MAX_DLEN] __attribute__((aligned(8)));
};
{% endhighlight %}

canid_t çš„å®šä¹‰å¦‚ä¸‹ï¼š

{% highlight ruby %}
/*
 * Controller Area Network Identifier structure
 *
 * bit 0-28 : CAN identifier (11/29 bit)
 * bit 29 : error message frame flag (0 = data frame, 1 = error message)
 * bit 30 : remote transmission request flag (1 = rtr frame)
 * bit 31 : frame format flag (0 = standard 11 bit, 1 = extended 29 bit)
 */
typedef __u32 canid_t;

0-28 ä½ä¸ºæ ‡è¯†ç¬¦ï¼Œå¦‚æœæ˜¯æ‰©å±•å¸§ï¼Œåˆ™é«˜ 11 ä½ä¸ºæ ‡å‡† ID
29 ä½æ ‡è¯†æ˜¯æ•°æ®å¸§è¿˜æ˜¯é”™è¯¯æ¶ˆæ¯
30 ä½è¯´æ˜æ˜¯å¦æ˜¯è¿œç¨‹å¸§
31 ä½è¯´æ˜æ˜¯æ ‡å‡†å¸§è¿˜æ˜¯æ‰©å±•å¸§
{% endhighlight %}

ä»¥ä¸‹æ˜¯ can_frame ä½¿ç”¨çš„æ ‡è¯†å’Œæ©ç 

{% highlight ruby %}
/* special address description flags for the CAN_ID */
#define CAN_EFF_FLAG 0x80000000U /* EFF/SFF is set in the MSB */
#define CAN_RTR_FLAG 0x40000000U /* remote transmission request */
#define CAN_ERR_FLAG 0x20000000U /* error message frame */
/* valid bits in CAN ID for frame formats */
#define CAN_SFF_MASK 0x000007FFU /* standard frame format (SFF) */
#define CAN_EFF_MASK 0x1FFFFFFFU /* extended frame format (EFF) */
#define CAN_ERR_MASK 0x1FFFFFFFU /* omit EFF, RTR, ERR flags */
{% endhighlight %}

---------------------------------------------

# <span id="CAN æµ‹è¯•">CAN ä¿¡å·æµ‹è¯•</span>

CAN ä½¿ç”¨å·®åˆ†ä¿¡å·ï¼Œé€šè¿‡ H å’Œ L ä¸¤ä¸ªä¿¡å·çº¿è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚å½“å·¥ç¨‹å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æŠ“
å– CAN ä¿¡å·è¿›è¡Œåˆ†æã€‚æŠ“å–ä¿¡å·çš„æ–¹å¼å¾ˆå¤šï¼Œè¿™é‡Œä»‹ç»é€šè¿‡ CAN é€»è¾‘åˆ†æä»ªè¿›è¡Œä¿¡å·æŠ“
å–ã€‚

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000099.png)

é…å¥—çš„ Windows åˆ†æå·¥å…·ï¼Œä½¿ç”¨è¿™ä¸ªå·¥å…·å¯ä»¥ç®€å•çš„å¯¹ CAN ä¿¡å·è¿›è¡Œåˆ†æã€‚

![Menuconfig1](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/DEV000100.png)

-----------------------------------------------------

# <span id="é™„å½•">é™„å½•</span>

> [CAN Information](https://developer.ridgerun.com/wiki/index.php/How_to_configure_and_use_CAN_bus#bit-timing_not_yet_defined)
>
> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](https://biscuitos.github.io/blog/Kernel_Build/)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
