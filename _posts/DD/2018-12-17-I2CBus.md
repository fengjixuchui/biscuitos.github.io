---
layout: post
title:  "I2C Bus"
date:   2018-12-17 17:21:30 +0800
categories: [HW]
excerpt: I2C Bus.
tags:
  - Bus
---

> [GitHub: I2C](https://github.com/BiscuitOS/HardStack/tree/master/bus/i2c)
>
> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

# ç›®å½•

> 1. [I2C åŸç†](#I2C åŸç†)
>
> 2. [Uboot ä¸­é€šè¿‡å·¥å…·è®¿é—® I2C](#Uboot ä¸­é€šè¿‡å·¥å…·è®¿é—® I2C)
>
> 3. [Uboot ä¸­é€šè¿‡æºç è®¿é—® I2C](#Uboot æºç ä¸­ä½¿ç”¨ I2C)
>
> 4. [Kernel ä¸­é€šè¿‡æºç è®¿é—® I2C](#Kernel ä¸­é€šè¿‡æºç è®¿é—® I2C)
>
> 5. [ç”¨æˆ·ç©ºé—´é€šè¿‡å·¥å…·è®¿é—® I2C](#ç”¨æˆ·ç©ºé—´é€šè¿‡å·¥å…·è®¿é—® I2C)
>
> 6. [ç”¨æˆ·ç©ºé—´é€šè¿‡æºç è®¿é—® I2C](#ç”¨æˆ·ç©ºé—´é€šè¿‡æºç è®¿é—® I2C)
>
> 7. [é™„å½•](#é™„å½•)

----------------------------------------------

# <span id="I2C åŸç†">I2C åè®®</span>

![Menuconfig1](/assets/PDB/BiscuitOS/kernel/DEV000050.png)

2æ¡åŒå‘ä¸²è¡Œçº¿ï¼Œä¸€æ¡æ•°æ®çº¿SDAï¼Œä¸€æ¡æ—¶é’Ÿçº¿SCL

#### æ€»çº¿ç©ºé—²çŠ¶æ€

I2C æ€»çº¿æ€»çº¿çš„ SDA å’Œ SCL ä¸¤æ¡ä¿¡å·çº¿åŒæ—¶å¤„äºé«˜ç”µå¹³æ—¶ï¼Œè§„å®šä¸ºæ€»çº¿çš„ç©ºé—²çŠ¶æ€ã€‚æ­¤
æ—¶å„ä¸ªå™¨ä»¶çš„è¾“å‡ºçº§åœºæ•ˆåº”ç®¡å‡å¤„åœ¨æˆªæ­¢çŠ¶æ€ï¼Œå³é‡Šæ”¾æ€»çº¿ï¼Œç”±ä¸¤æ¡ä¿¡å·çº¿å„è‡ªçš„ä¸Šæ‹‰ç”µ
é˜»æŠŠç”µå¹³æ‹‰é«˜ã€‚

#### å¯åŠ¨ä¿¡å·

![Menuconfig1](/assets/PDB/BiscuitOS/kernel/DEV000051.png)

åœ¨æ—¶é’Ÿçº¿ SCL ä¿æŒé«˜ç”µå¹³æœŸé—´ï¼Œæ•°æ®çº¿ SDA ä¸Šçš„ç”µå¹³è¢«æ‹‰ä½ï¼ˆå³è´Ÿè·³å˜ï¼‰ï¼Œå®šä¹‰ä¸º 
I2C æ€»çº¿æ€»çº¿çš„å¯åŠ¨ä¿¡å·ï¼Œå®ƒæ ‡å¿—ç€ä¸€æ¬¡æ•°æ®ä¼ è¾“çš„å¼€å§‹ã€‚å¯åŠ¨ä¿¡å·æ˜¯ä¸€ç§ç”µå¹³è·³å˜æ—¶åº
ä¿¡å·ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç”µå¹³ä¿¡å·ã€‚å¯åŠ¨ä¿¡å·æ˜¯ç”±ä¸»æ§å™¨ä¸»åŠ¨å»ºç«‹çš„ï¼Œåœ¨å»ºç«‹è¯¥ä¿¡å·ä¹‹å‰I2Cæ€»
çº¿å¿…é¡»å¤„äºç©ºé—²çŠ¶æ€ã€‚

#### é‡å¯åŠ¨ä¿¡å·

åœ¨ä¸»æ§å™¨æ§åˆ¶æ€»çº¿æœŸé—´å®Œæˆäº†ä¸€æ¬¡æ•°æ®é€šä¿¡ï¼ˆå‘é€æˆ–æ¥æ”¶ï¼‰ä¹‹åï¼Œå¦‚æœæƒ³ç»§ç»­å ç”¨æ€»çº¿å†
è¿›è¡Œä¸€æ¬¡æ•°æ®é€šä¿¡ï¼ˆå‘é€æˆ–æ¥æ”¶ï¼‰ï¼Œè€Œåˆä¸é‡Šæ”¾æ€»çº¿ï¼Œå°±éœ€è¦åˆ©ç”¨é‡å¯åŠ¨Srä¿¡å·æ—¶åºã€‚é‡
å¯åŠ¨ä¿¡å·Sræ—¢ä½œä¸ºå‰ä¸€æ¬¡æ•°æ®ä¼ è¾“çš„ç»“æŸï¼Œåˆä½œä¸ºåä¸€æ¬¡æ•°æ®ä¼ è¾“çš„å¼€å§‹ã€‚åˆ©ç”¨é‡å¯åŠ¨ä¿¡
å·çš„ä¼˜ç‚¹æ˜¯ï¼Œåœ¨å‰åä¸¤æ¬¡é€šä¿¡ä¹‹é—´ä¸»æ§å™¨ä¸éœ€è¦é‡Šæ”¾æ€»çº¿ï¼Œè¿™æ ·å°±ä¸ä¼šä¸¢å¤±æ€»çº¿çš„æ§åˆ¶
æƒï¼Œå³ä¸è®©å…¶ä»–ä¸»å™¨ä»¶èŠ‚ç‚¹æŠ¢å æ€»çº¿ã€‚

#### åœæ­¢ä¿¡å·

åœ¨æ—¶é’Ÿçº¿ SCL ä¿æŒé«˜ç”µå¹³æœŸé—´ï¼Œæ•°æ®çº¿ SDA è¢«é‡Šæ”¾ï¼Œä½¿å¾— SDA è¿”å›é«˜ç”µå¹³ï¼ˆå³æ­£è·³
å˜ï¼‰ï¼Œç§°ä¸º I2C æ€»çº¿çš„åœæ­¢ä¿¡å·ï¼Œå®ƒæ ‡å¿—ç€ä¸€æ¬¡æ•°æ®ä¼ è¾“çš„ç»ˆæ­¢ã€‚åœæ­¢ä¿¡å·ä¹Ÿæ˜¯ä¸€ç§ç”µ
å¹³è·³å˜æ—¶åºä¿¡å·ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç”µå¹³ä¿¡å·ï¼Œåœæ­¢ä¿¡å·ä¹Ÿæ˜¯ç”±ä¸»æ§å™¨ä¸»åŠ¨å»ºç«‹çš„ï¼Œå»ºç«‹è¯¥ä¿¡
å·ä¹‹åï¼ŒI2C æ€»çº¿å°†è¿”å›ç©ºé—²çŠ¶æ€ã€‚ä¸æ˜¯åœ¨æ•°æ®æœ‰æ•ˆæ€§ä¸­è§„å®šåœ¨ SDA åªèƒ½åœ¨ SCL çš„ä½ç”µ
å¹³çš„æ—¶å€™å˜åŒ–ï¼Œä¸ºä½• STARï¼ŒSTOP ä¸ä¸€æ ·ï¼Ÿé¦–å…ˆ STAR å’Œ STOP ä¸æ˜¯æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥ä¸éµ
å®ˆæ•°æ®æœ‰æ•ˆæ€§ä¸­çš„è§„å®šï¼Œå…¶å®ƒæ•°æ®éƒ½éµå®ˆï¼Œè€Œ STAR å’Œ STOPâ€œä¸éµå®ˆâ€å¯¼è‡´ STAR å’Œ STOP
æ›´å®¹æ˜“è¢«è¯†åˆ«ã€‚è¿™æ ·ä¸æ˜¯ä¸éµå®ˆè€Œæ˜¯æ›´æœ‰ä¼˜åŠ¿ã€‚

èµ·å§‹å’Œåœæ­¢æ¡ä»¶ä¸€èˆ¬ç”±ä¸»æœºäº§ç”Ÿï¼Œæ€»çº¿åœ¨èµ·å§‹æ¡ä»¶åè¢«è®¤ä¸ºå¤„äºå¿™çš„çŠ¶æ€ï¼Œåœ¨åœæ­¢æ¡ä»¶çš„
æŸæ®µæ—¶é—´åæ€»çº¿è¢«è®¤ä¸ºå†æ¬¡å¤„äºç©ºé—²çŠ¶æ€ã€‚å¦‚æœäº§ç”Ÿé‡å¤èµ·å§‹ (Sr) æ¡ä»¶è€Œä¸äº§ç”Ÿåœæ­¢æ¡
ä»¶ï¼Œæ€»çº¿ä¼šä¸€ç›´å¤„äºå¿™çš„çŠ¶æ€ã€‚æ­¤æ—¶çš„èµ·å§‹æ¡ä»¶ (S) å’Œé‡å¤èµ·å§‹ (Sr) æ¡ä»¶åœ¨åŠŸèƒ½ä¸Šæ˜¯
ä¸€æ ·çš„ã€‚å¦‚æœè¿æ¥åˆ°æ€»çº¿çš„å™¨ä»¶åˆå¹¶äº†å¿…è¦çš„æ¥å£ç¡¬ä»¶ï¼Œé‚£ä¹ˆç”¨å®ƒä»¬æ£€æµ‹èµ·å§‹å’Œåœæ­¢æ¡ä»¶
ååˆ†ç®€ä¾¿ã€‚ä½†æ˜¯æ²¡æœ‰è¿™ç§æ¥å£çš„å¾®æ§åˆ¶å™¨åœ¨æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸè‡³å°‘è¦é‡‡æ ·SDA çº¿ä¸¤æ¬¡æ¥åˆ¤åˆ«æœ‰
æ²¡æœ‰å‘ç”Ÿç”µå¹³åˆ‡æ¢ã€‚

#### æ•°æ®ä½ä¼ é€

![Menuconfig1](/assets/PDB/BiscuitOS/kernel/DEV000052.png)

åœ¨ I2C æ€»çº¿ä¸Šä¼ é€çš„æ¯ä¸€ä½æ•°æ®éƒ½æœ‰ä¸€ä¸ªæ—¶é’Ÿè„‰å†²ç›¸å¯¹åº”ï¼ˆæˆ–åŒæ­¥æ§åˆ¶ï¼‰ï¼Œå³åœ¨ SCL ä¸²
è¡Œæ—¶é’Ÿçš„é…åˆä¸‹ï¼Œåœ¨ SDA ä¸Šé€ä½åœ°ä¸²è¡Œä¼ é€æ¯ä¸€ä½æ•°æ®ã€‚è¿›è¡Œæ•°æ®ä¼ é€æ—¶ï¼Œåœ¨ SCL å‘ˆç°
é«˜ç”µå¹³æœŸé—´ï¼ŒSDA ä¸Šçš„ç”µå¹³å¿…é¡»ä¿æŒç¨³å®šï¼Œä½ç”µå¹³ä¸ºæ•°æ® 0ï¼Œé«˜ç”µå¹³ä¸ºæ•°æ® 1ã€‚åªæœ‰åœ¨ 
SCL ä¸ºä½ç”µå¹³æœŸé—´ï¼Œæ‰å…è®¸ SDA ä¸Šçš„ç”µå¹³æ”¹å˜çŠ¶æ€ã€‚é€»è¾‘ 0 çš„ç”µå¹³ä¸ºä½ç”µå‹ï¼Œè€Œé€»è¾‘ 
1 çš„ç”µå¹³å–å†³äºå™¨ä»¶æœ¬èº«çš„æ­£ç”µæºç”µå‹ VDDï¼ˆå½“ä½¿ç”¨ç‹¬ç«‹ç”µæºæ—¶ï¼‰ã€‚æ•°æ®ä½çš„ä¼ è¾“æ˜¯è¾¹æ²¿
è§¦å‘ã€‚

#### åº”ç­”ä¿¡å·

I2C æ€»çº¿ä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ä»¥ 8 ä½å­—èŠ‚ä¼ é€çš„ï¼Œå‘é€å™¨æ¯å‘é€ä¸€ä¸ªå­—èŠ‚ï¼Œå°±åœ¨æ—¶é’Ÿè„‰å†² 
9 æœŸé—´é‡Šæ”¾æ•°æ®çº¿ï¼Œç”±æ¥æ”¶å™¨åé¦ˆä¸€ä¸ªåº”ç­”ä¿¡å·ã€‚ åº”ç­”ä¿¡å·ä¸ºä½ç”µå¹³æ—¶ï¼Œè§„å®šä¸ºæœ‰æ•ˆåº”
ç­”ä½ï¼ˆACKç®€ç§°åº”ç­”ä½ï¼‰ï¼Œè¡¨ç¤ºæ¥æ”¶å™¨å·²ç»æˆåŠŸåœ°æ¥æ”¶äº†è¯¥å­—èŠ‚ï¼›åº”ç­”ä¿¡å·ä¸ºé«˜ç”µå¹³æ—¶ï¼Œ
è§„å®šä¸ºéåº”ç­”ä½ï¼ˆNACKï¼‰ï¼Œä¸€èˆ¬è¡¨ç¤ºæ¥æ”¶å™¨æ¥æ”¶è¯¥å­—èŠ‚æ²¡æœ‰æˆåŠŸã€‚ å¯¹äºåé¦ˆæœ‰æ•ˆåº”ç­”ä½ 
ACK çš„è¦æ±‚æ˜¯ï¼Œæ¥æ”¶å™¨åœ¨ç¬¬ 9 ä¸ªæ—¶é’Ÿè„‰å†²ä¹‹å‰çš„ä½ç”µå¹³æœŸé—´å°†SDA çº¿æ‹‰ä½ï¼Œå¹¶ä¸”ç¡®ä¿åœ¨
è¯¥æ—¶é’Ÿçš„é«˜ç”µå¹³æœŸé—´ä¸ºç¨³å®šçš„ä½ç”µå¹³ã€‚ å¦‚æœæ¥æ”¶å™¨æ˜¯ä¸»æ§å™¨ï¼Œåˆ™åœ¨å®ƒæ”¶åˆ°æœ€åä¸€ä¸ªå­—èŠ‚
åï¼Œå‘é€ä¸€ä¸ª NACK ä¿¡å·ï¼Œä»¥é€šçŸ¥è¢«æ§å‘é€å™¨ç»“æŸæ•°æ®å‘é€ï¼Œå¹¶é‡Šæ”¾ SDA çº¿ï¼Œä»¥ä¾¿ä¸»æ§
æ¥æ”¶å™¨å‘é€ä¸€ä¸ªåœæ­¢ä¿¡å· Pã€‚

#### æ’å…¥ç­‰å¾…æ—¶é—´ 

![Menuconfig1](/assets/PDB/BiscuitOS/kernel/DEV000053.png)
 
å¦‚æœè¢«æ§å™¨éœ€è¦å»¶è¿Ÿä¸‹ä¸€ä¸ªæ•°æ®å­—èŠ‚å¼€å§‹ä¼ é€çš„æ—¶é—´ï¼Œåˆ™å¯ä»¥é€šè¿‡æŠŠæ—¶é’Ÿçº¿ SCL ç”µå¹³æ‹‰
ä½å¹¶ä¸”ä¿æŒï¼Œä½¿ä¸»æ§å™¨è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚ä¸€æ—¦è¢«æ§å™¨é‡Šæ”¾æ—¶é’Ÿçº¿ï¼Œæ•°æ®ä¼ è¾“å°±å¾—ä»¥ç»§ç»­ä¸‹å»ï¼Œ
è¿™æ ·å°±ä½¿å¾—è¢«æ§å™¨å¾—åˆ°è¶³å¤Ÿæ—¶é—´è½¬ç§»å·²ç»æ”¶åˆ°çš„æ•°æ®å­—èŠ‚ï¼Œæˆ–è€…å‡†å¤‡å¥½å³å°†å‘é€çš„æ•°æ®å­—
èŠ‚ã€‚å¸¦æœ‰ CPU çš„è¢«æ§å™¨åœ¨å¯¹æ”¶åˆ°çš„åœ°å€å­—èŠ‚åšå‡ºåº”ç­”ä¹‹åï¼Œéœ€è¦ä¸€å®šçš„æ—¶é—´å»æ‰§è¡Œä¸­æ–­
æœåŠ¡å­ç¨‹åºï¼Œæ¥åˆ†ææˆ–æ¯”è¾ƒåœ°å€ç ï¼Œå…¶é—´å°±æŠŠ SCL çº¿é’³ä½åœ¨ä½ç”µå¹³ä¸Šï¼Œç›´åˆ°å¤„ç†å¦¥å½“å
æ‰é‡Šæ”¾ SCL çº¿ï¼Œè¿›è€Œä½¿ä¸»æ§å™¨ç»§ç»­åç»­æ•°æ®å­—èŠ‚çš„å‘é€ã€‚

#### æ€»çº¿å°é”çŠ¶æ€  

åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¦‚æœéœ€è¦ç¦æ­¢æ‰€æœ‰å‘ç”Ÿåœ¨I2Cæ€»çº¿ä¸Šçš„é€šä¿¡æ´»åŠ¨ï¼Œå°é”æˆ–å…³é—­æ€»çº¿æ˜¯ä¸€ç§
å¯è¡Œé€”å¾„ï¼Œåªè¦æŒ‚æ¥äºè¯¥æ€»çº¿ä¸Šçš„ä»»æ„ä¸€ä¸ªå™¨ä»¶å°†æ—¶é’Ÿçº¿SCLé”å®šåœ¨ä½ç”µå¹³ä¸Šå³å¯ã€‚

#### æ€»çº¿ç«äº‰çš„ä»²è£

æ€»çº¿ä¸Šå¯èƒ½æŒ‚æ¥æœ‰å¤šä¸ªå™¨ä»¶ï¼Œæœ‰æ—¶ä¼šå‘ç”Ÿä¸¤ä¸ªæˆ–å¤šä¸ªä¸»å™¨ä»¶åŒæ—¶æƒ³å ç”¨æ€»çº¿çš„æƒ…å†µï¼Œè¿™ç§
æƒ…å†µå«åšæ€»çº¿ç«äº‰ã€‚I2Cæ€»çº¿å…·æœ‰å¤šä¸»æ§èƒ½åŠ›ï¼Œå¯ä»¥å¯¹å‘ç”Ÿåœ¨SDAçº¿ä¸Šçš„æ€»çº¿ç«äº‰è¿›è¡Œä»²è£ï¼Œ
å…¶ä»²è£åŸåˆ™æ˜¯è¿™æ ·çš„ï¼šå½“å¤šä¸ªä¸»å™¨ä»¶åŒæ—¶æƒ³å ç”¨æ€»çº¿æ—¶ï¼Œå¦‚æœæŸä¸ªä¸»å™¨ä»¶å‘é€é«˜ç”µå¹³ï¼Œè€Œ
å¦ä¸€ä¸ªä¸»å™¨ä»¶å‘é€ä½ç”µå¹³ï¼Œåˆ™å‘é€ç”µå¹³ä¸æ­¤æ—¶SDAæ€»çº¿ç”µå¹³ä¸ç¬¦çš„é‚£ä¸ªå™¨ä»¶å°†è‡ªåŠ¨å…³é—­å…¶
è¾“å‡ºçº§ã€‚æ€»çº¿ç«äº‰çš„ä»²è£æ˜¯åœ¨ä¸¤ä¸ªå±‚æ¬¡ä¸Šè¿›è¡Œçš„ã€‚é¦–å…ˆæ˜¯åœ°å€ä½çš„æ¯”è¾ƒï¼Œå¦‚æœä¸»å™¨ä»¶å¯»å€
åŒä¸€ä¸ªä»å™¨ä»¶ï¼Œåˆ™è¿›å…¥æ•°æ®ä½çš„æ¯”è¾ƒï¼Œä»è€Œç¡®ä¿äº†ç«äº‰ä»²è£çš„å¯é æ€§ã€‚ç”±äºæ˜¯åˆ©ç”¨I2Cæ€»
çº¿ä¸Šçš„ä¿¡æ¯è¿›è¡Œä»²è£ï¼Œå› æ­¤ä¸ä¼šé€ æˆä¿¡æ¯çš„ä¸¢å¤±ã€‚ä¸ºä½•è¯†åˆ«åˆ°â€œ0â€å°†ä¸¢å¤±ä»²è£å‘¢ï¼Ÿå› ä¸ºå¯¹äº
ODé—¨ï¼Œåªèƒ½é©±åŠ¨åˆ°ä½ç”µå¹³ï¼Œé‡Šæ”¾æ€»çº¿åªèƒ½é€šè¿‡ä¸é©±åŠ¨æ€»çº¿é‡Šæ”¾ï¼Œåœæ­¢é©±åŠ¨å³äº§ç”Ÿâ€œ1â€ï¼Œä½†
æ˜¯å‘ç°æ€»çº¿è¿˜æ˜¯â€œ0â€ï¼Œè¿™è¯´æ˜è¿˜æœ‰ä¸»æœºåœ¨è·Ÿè‡ªå·±ç«äº‰æ€»çº¿ä½¿ç”¨æƒï¼Œè‡ªå·±çº¿é©±åŠ¨åˆ°â€œ1â€ï¼Œç¡®æ£€
æµ‹åˆ°â€œ0â€ï¼Œé‚£ä»£è¡¨è‡ªå·±å·²ç»å¤±å»äº†ä»²è£ã€‚

ä¸»æœºåªèƒ½åœ¨æ€»çº¿ç©ºé—²çš„æ—¶ä¾¯å¯åŠ¨ä¼ é€ã€‚ä¸¤ä¸ªæˆ–å¤šä¸ªä¸»æœºå¯èƒ½åœ¨èµ·å§‹æ¡ä»¶çš„æœ€å°æŒç»­æ—¶é—´
tHD;STA å†…äº§ç”Ÿä¸€ä¸ªèµ·å§‹æ¡ä»¶ï¼Œç»“æœåœ¨æ€»çº¿ä¸Šäº§ç”Ÿä¸€ä¸ªè§„å®šçš„èµ·å§‹æ¡ä»¶ã€‚å½“SCL çº¿æ˜¯é«˜ç”µ
å¹³æ—¶ï¼Œä»²è£åœ¨SDA çº¿å‘ç”Ÿï¼›è¿™æ ·ï¼Œåœ¨å…¶ä»–ä¸»æœºå‘é€ä½ç”µå¹³æ—¶ï¼Œå‘é€é«˜ç”µå¹³çš„ä¸»æœºå°†æ–­å¼€å®ƒ
çš„æ•°æ®è¾“å‡ºçº§ï¼Œå› ä¸ºæ€»çº¿ä¸Šçš„ç”µå¹³ä¸å®ƒè‡ªå·±çš„ç”µå¹³ä¸ç›¸åŒã€‚ç„¶åï¼Œè¿›ä¸€æ­¥è·å¾—å…¶çš„åˆ¤å®šæ¡
ä»¶ï¼š

> 1. ä»²è£å¯ä»¥æŒç»­å¤šä½ã€‚é¦–å…ˆæ˜¯æ¯”è¾ƒåœ°å€ä½ã€‚å¦‚æœæ¯ä¸ªä¸»æœºéƒ½è¯•å›¾å¯»å€åŒä¸€çš„å™¨ä»¶ï¼Œä»²
>    è£ä¼šç»§ç»­æ¯”è¾ƒæ•°æ®ä½(å‡è®¾ä¸»æœºæ˜¯å‘é€å™¨)ï¼Œæˆ–è€…æ¯”è¾ƒå“åº”ä½(å‡è®¾ä¸»æœºæ˜¯æ¥æ”¶å™¨)ã€‚
>
> 2. I2C æ€»çº¿çš„åœ°å€å’Œæ•°æ®ä¿¡æ¯ç”±èµ¢å¾—ä»²è£çš„ä¸»æœºå†³å®šï¼Œåœ¨ä»²è£è¿‡ç¨‹ä¸­ä¸ä¼šä¸¢å¤±ä¿¡æ¯ã€‚
>    ä¸¢å¤±ä»²è£çš„ä¸»æœºå¯ä»¥äº§ç”Ÿæ—¶é’Ÿè„‰å†²ç›´åˆ°ä¸¢å¤±ä»²è£çš„è¯¥å­—èŠ‚æœ«å°¾ã€‚
>
> 3. åœ¨ä¸²è¡Œä¼ è¾“è¿‡ç¨‹ä¸­æ—¶ï¼Œä¸€æ—¦æœ‰é‡å¤çš„èµ·å§‹æ¡ä»¶æˆ–åœæ­¢æ¡ä»¶å‘é€åˆ°I2C æ€»çº¿çš„æ—¶ä¾¯ï¼Œ
>    ä»²è£è¿‡ç¨‹ä»åœ¨è¿›è¡Œã€‚å¦‚æœå¯èƒ½äº§ç”Ÿè¿™æ ·çš„æƒ…å†µï¼Œæœ‰å…³çš„ä¸»æœºå¿…é¡»åœ¨å¸§æ ¼å¼ç›¸åŒä½ç½®
>    å‘é€è¿™ä¸ªé‡å¤èµ·å§‹æ¡ä»¶æˆ–åœæ­¢æ¡ä»¶ã€‚
>
> 4. æ­¤å¤–ï¼Œå¦‚æœä¸»æœºä¹Ÿç»“åˆäº†ä»æœºåŠŸèƒ½ï¼Œè€Œä¸”åœ¨å¯»å€é˜¶æ®µä¸¢å¤±ä»²è£ï¼Œå®ƒå¾ˆå¯èƒ½å°±æ˜¯èµ¢å¾—
>    ä»²è£çš„ä¸»æœºåœ¨å¯»å€çš„å™¨ä»¶ã€‚é‚£ä¹ˆï¼Œä¸¢å¤±ä»²è£çš„ä¸»æœºå¿…é¡»ç«‹å³åˆ‡æ¢åˆ°å®ƒçš„ä»æœºæ¨¡å¼ã€‚
>
> 5. I2C æ€»çº¿çš„æ§åˆ¶åªç”±åœ°å€æˆ–ä¸»æœºç ä»¥åŠç«äº‰ä¸»æœºå‘é€çš„æ•°æ®å†³å®šï¼Œæ²¡æœ‰ä¸­å¤®ä¸»æœºï¼Œ
>    æ€»çº¿ä¹Ÿæ²¡æœ‰ä»»ä½•å®šåˆ¶çš„ä¼˜å…ˆæƒã€‚


#### æ—¶é’Ÿä¿¡å·çš„åŒæ­¥

åœ¨ I2C æ€»çº¿ä¸Šä¼ é€ä¿¡æ¯æ—¶çš„æ—¶é’ŸåŒæ­¥ä¿¡å·æ˜¯ç”±æŒ‚æ¥åœ¨SCLçº¿ä¸Šçš„æ‰€æœ‰å™¨ä»¶çš„é€»è¾‘â€œä¸â€å®Œæˆ
çš„ã€‚SCL çº¿ä¸Šç”±é«˜ç”µå¹³åˆ°ä½ç”µå¹³çš„è·³å˜å°†å½±å“åˆ°è¿™äº›å™¨ä»¶ï¼Œä¸€æ—¦æŸä¸ªå™¨ä»¶çš„æ—¶é’Ÿä¿¡å·ä¸‹è·³
ä¸ºä½ç”µå¹³ï¼Œå°†ä½¿SCLçº¿ä¸€ç›´ä¿æŒä½ç”µå¹³ï¼Œä½¿SCLçº¿ä¸Šçš„æ‰€æœ‰å™¨ä»¶å¼€å§‹ä½ç”µå¹³æœŸã€‚æ­¤æ—¶ï¼Œä½ç”µ
å¹³å‘¨æœŸçŸ­çš„å™¨ä»¶çš„æ—¶é’Ÿç”±ä½è‡³é«˜çš„è·³å˜å¹¶ä¸èƒ½å½±å“SCLçº¿çš„çŠ¶æ€ï¼Œäºæ˜¯è¿™äº›å™¨ä»¶å°†è¿›å…¥é«˜
ç”µå¹³ç­‰å¾…çš„çŠ¶æ€ã€‚å½“æ‰€æœ‰å™¨ä»¶çš„æ—¶é’Ÿä¿¡å·éƒ½ä¸Šè·³ä¸ºé«˜ç”µå¹³æ—¶ï¼Œä½ç”µå¹³æœŸç»“æŸï¼ŒSCLçº¿è¢«é‡Š
æ”¾è¿”å›é«˜ç”µå¹³ï¼Œå³æ‰€æœ‰çš„å™¨ä»¶éƒ½åŒæ—¶å¼€å§‹å®ƒä»¬çš„é«˜ç”µå¹³æœŸã€‚å…¶åï¼Œç¬¬ä¸€ä¸ªç»“æŸé«˜ç”µå¹³æœŸçš„
å™¨ä»¶åˆå°†SCLçº¿æ‹‰æˆä½ç”µå¹³ã€‚è¿™æ ·å°±åœ¨SCLçº¿ä¸Šäº§ç”Ÿä¸€ä¸ªåŒæ­¥æ—¶é’Ÿã€‚å¯è§ï¼Œæ—¶é’Ÿä½ç”µå¹³æ—¶é—´
ç”±æ—¶é’Ÿä½ç”µå¹³æœŸæœ€é•¿çš„å™¨ä»¶ç¡®å®šï¼Œè€Œæ—¶é’Ÿé«˜ç”µå¹³æ—¶é—´ç”±æ—¶é’Ÿé«˜ç”µå¹³æœŸæœ€çŸ­çš„å™¨ä»¶ç¡®å®šã€‚

---------------------------------------------------

# <span id="Uboot ä¸­é€šè¿‡å·¥å…·è®¿é—® I2C">Uboot ä¸­ä½¿ç”¨ I2C</span>

Uboot ä¸­ä½¿ç”¨ I2C åŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼šI2C å·¥å…·ä½¿ç”¨ä»¥åŠæºç ä¸­ä½¿ç”¨ I2Cã€‚

[ç›¸å…³ github ä¸»é¡µ](https://github.com/BiscuitOS/HardStack/tree/master/bus/i2c/uboot)

## I2C å·¥å…·ä½¿ç”¨

uboot ä¸­æä¾›äº†ä¸€å¥— i2c å·¥å…·ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼ä½¿ç”¨è¿™å¥—å·¥å…·å»æ“ä½œ I2C æ€»çº¿ã€‚ä¸º
äº†ä½¿ç”¨è¿™å¥—å·¥å…·ï¼Œå¼€å‘è€…åœ¨ uboot å¯åŠ¨ä¹‹åï¼ŒæŒ‰ä½å›è½¦è¿›å…¥ uboot çš„å‘½ä»¤è¡Œæ¨¡å¼ã€‚è¿›å…¥
å‘½ä»¤è¡Œæ¨¡å¼ä¹‹åï¼Œå¼€å‘è€…å¯ä»¥è¾“å…¥å¦‚ä¸‹å‘½ä»¤ä½¿ç”¨å·¥å…·ï¼š

#### æŸ¥çœ‹ i2c å·¥å…·å¸®åŠ©ï¼š

{% highlight ruby %}
ZynqMP> help i2c
i2c - I2C sub-system

Usage:
i2c bus [muxtype:muxaddr:muxchannel] - show I2C bus info
crc32 chip address[.0, .1, .2] count - compute CRC32 checksum
i2c dev [dev] - show or set current I2C bus
i2c loop chip address[.0, .1, .2] [# of objects] - looping read of device
i2c md chip address[.0, .1, .2] [# of objects] - read from I2C device
i2c mm chip address[.0, .1, .2] - write to I2C device (auto-incrementing)
i2c mw chip address[.0, .1, .2] value [count] - write to I2C device (fill)
i2c nm chip address[.0, .1, .2] - write to I2C device (constant address)
i2c probe [address] - test for and show device(s) on the I2C bus
i2c read chip address[.0, .1, .2] length memaddress - read to memory
i2c write memaddress chip address[.0, .1, .2] length [-s] - write memory
          to I2C; the -s option selects bulk write in a single transaction
i2c reset - re-init the I2C Controller
i2c speed [speed] - show or set I2C bus speed
{% endhighlight %}

#### I2C æ€»çº¿æ“ä½œ

å‘½ä»¤æ ¼å¼ï¼š

{% highlight ruby %}
i2c dev [dev]
{% endhighlight %}

æŸ¥çœ‹å½“ I2C æ€»çº¿

{% highlight ruby %}
ZynqMP> i2c dev
Current bus is 0
ZynqMP>
{% endhighlight %}

è®¾ç½®å½“å‰ I2C æ€»çº¿

{% highlight ruby %}
ZynqMP> i2c dev 0
Current bus is 0
ZynqMP>
{% endhighlight %}

#### I2C æ¢æµ‹æ“ä½œ

å‘½ä»¤æ¨¡å¼

{% highlight ruby %}
i2c probe [address]
{% endhighlight %}

æ¢æµ‹å½“å‰æ€»çº¿ä¸Šçš„æ‰€æœ‰å¯ç”¨ I2C è®¾å¤‡

{% highlight ruby %}
ZynqMP> i2c probe
Valid chip addresses: 50 51
ZynqMP>
{% endhighlight %}

æ¢æµ‹æŒ‡å®š I2C ä»è®¾å¤‡æ˜¯å¦å¯ç”¨

{% highlight ruby %}
ZynqMP> i2c probe 0x50
Valid chip addresses: 50
ZynqMP>
{% endhighlight %}

#### I2C è¯»æ“ä½œ

å‘½ä»¤æ¨¡å¼

{% highlight ruby %}
i2c md chip address[.0, .1, .2] [# of objects]
{% endhighlight %}

ä¾‹å¦‚ï¼Œä» I2C æ€»çº¿ 0 ä¸Šï¼Œslave åœ°å€ä¸º 0x50ï¼Œåç§»åœ°å€ä¸º 0x2 çš„åœ°æ–¹è¯»å–ä¸€ä¸ªå­—èŠ‚
çš„æ•°æ®

{% highlight ruby %}
ZynqMP> i2c md 0x50 0x2 1                                                       
0001: 30    0                                                                   
ZynqMP>
{% endhighlight %}

I2C å†™æ“ä½œ

å‘½ä»¤æ¨¡å¼ï¼š

{% highlight ruby %}
i2c mw chip address[.0, .1, .2] value [count]
{% endhighlight %}

ä¾‹å¦‚ï¼Œå‘ I2C æ€»çº¿ 0 ä¸Šï¼Œslave åœ°å€ä¸º 0x50ï¼Œåç§»åœ°å€ä¸º 0x1 çš„åœ°æ–¹ï¼Œå†™å…¥ 0x12.

{% highlight ruby %}
ZynqMP> i2c md 0x50 0x1                                                         
0001: 00    .                                                                   
ZynqMP> i2c mw 0x50 0x1 0x12                                                    
ZynqMP> i2c md 0x50 0x1                                                         
0001: 12    .
{% endhighlight %}

## <span id="Uboot æºç ä¸­ä½¿ç”¨ I2C">Uboot æºç ä¸­ä½¿ç”¨ I2C</span>

Uboot é˜¶æ®µæºç ä¸­è¦ä½¿ç”¨ I2Cï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š

{% highlight ruby %}
/*
* I2C read/write on Uboot
*
* (C) 2018.11.12 BiscuitOS <buddy.zhang@aliyun.com>
*
* This program is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License version 2 as
* published by the Free Software Foundation.
*/
#include <i2c.h>
#include <errno.h>

/* I2C write */
static int i2c_demo_write(uint i2c_addr, ulong offset, uchar value)
{
    i2c_write(i2c_addr, offset, 1, &value, 1);

    return 0;
}

/* I2C read */
static int i2c_demo_read(uint i2c_addr, ulong offset, uchar &value)
{
    i2c_read(i2c_addr, offset, 1, &value, 1);

    return 0;
}
{% endhighlight %}

----------------------------------------------

# <span id="Kernel ä¸­é€šè¿‡æºç è®¿é—® I2C">Kernel é‡Œä½¿ç”¨ I2C</span>

[Kernel I2C on github](https://github.com/BiscuitOS/HardStack/tree/master/bus/i2c/kernel)

Kernel å¾€å¾€éœ€è¦é€šè¿‡ I2C åè®®ä»è®¾å¤‡ä¸Šè¯»å–æˆ–å†™å…¥ç›¸åº”çš„ä¿¡æ¯ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½
ä»¤å¿«é€Ÿå®è·µä»£ç ï¼š

{% highlight ruby %}
cd /tmp/
mkdir I2C
cd I2C
git init
git remote add -f  origin https://github.com/BiscuitOS/HardStack.git
git config core.sparsecheckout true
echo "i2c" >> .git/info/sparse-checkout
git pull origin master
cd bus/i2c/kernel
make
sudo insmod i2c.ko
dmesge | tail -n 10
sudo rmmod i2c.ko
{% endhighlight %}

![Menuconfig1](/assets/PDB/BiscuitOS/kernel/DEV000054.png)

é€šè¿‡ä¸Šé¢çš„å‘½ä»¤ï¼Œå¼€å‘è€…å¯ä»¥è·å¾—ä¸€ä»½ I2C é©±åŠ¨æºç ï¼Œå¹¶åŠ¨æ€ç¼–è¯‘åŠ å…¥è¿è¡Œçš„ Linux å†…
æ ¸ä¸­ã€‚å…¶ä¸­é©±åŠ¨æºç å’Œ Makefile è„šæœ¬å¦‚ä¸‹ï¼š

{% highlight ruby %}
/*
* I2C read/write on Kernel
*
* (C) 2018.11.17 BiscuitOS <buddy.zhang@aliyun.com>
*
* This program is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License version 2 as
* published by the Free Software Foundation.
*/
#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/module.h>
#include <linux/i2c.h>
#include <linux/of.h>

#define DEV_NAME         "i2cdemo"
#define SLAVE_I2C_ADDR   0x50

/*
* Slave information on DTS
*   I2C Bus:    I2C 0
*   Slave addr: 0x50
*
* &i2c0 {
*      status = "okay";
*              i2cdemo@50 {
*                      compatible = "i2cdemo,eeprom";
*                      reg = <0x50>;           
*              };
* };
*/

/*
* Write data into Slave device on I2C Bus.
*
* client: Slave client.
* reg: offset on slave device.
* data: need to write.
* count: number for write.
*/
static int i2c_demo_write(struct i2c_client *client, unsigned char reg,
                                 unsigned char *data, unsigned long count)
{
    int ret;

    struct i2c_msg msgs[] = {
        {
            .addr  = client->addr,
            .flags = client->flags & I2C_M_TEN,
            .len   = 1,
            .buf   = &reg, /* Offset address on slave device */
        },
        {
            .addr  = client->addr,
            .flags = client->flags,
            .len   = count,
            .buf   = data, /* value need to write */
        }
    };

    ret = i2c_transfer(client->adapter, msgs, 2);
    if (2 != ret) {
        printk(KERN_ERR "%s fail\n", __func__);
        return -1;
    }

    return 0;
}

/*
* Read data from slave device on I2C Bus.
*
* client: Slave client
* reg: offset on slave device.
* data: store ready data.
* count: number for read.
*/
static int i2c_demo_read(struct i2c_client *client, unsigned char reg,
                           unsigned char *data, unsigned long count)
{
    int ret;

    struct i2c_msg msgs[] = {
        {
            .addr  = client->addr,
            .flags = client->flags & I2C_M_TEN,
            .len   = 1,
            .buf   = &reg, /* Offset address on slave device */
        },
        {
            .addr  = client->addr,
            .flags = client->flags | I2C_M_RD,
            .len   = count,
            .buf   = data, /* value need to write */
        }
    };

    ret = i2c_transfer(client->adapter, msgs, 2);
    if (2 != ret) {
        printk(KERN_ERR "%s fail\n", __func__);
        return -1;
    }

    return 0;
}

/* probe entence */
static int i2c_demo_probe(struct i2c_client *client,
                            const struct i2c_device_id *id)
{
    unsigned char addr = 0x20;
    unsigned char buf;

    /* Read data from I2C Bus */
    i2c_demo_read(client, addr, &buf, 1);
    printk(KERN_INFO "Origin-Data: %#x\n", (unsigned int)buf);

    buf = 0x68;
    /* Write data into I2C Bus */
    i2c_demo_write(client, addr, &buf, 1);

    /* Read data from I2C Bus */
    i2c_demo_read(client, addr, &buf, 1);
    printk(KERN_INFO "Modify-Data: %#x\n", (unsigned int)buf);
    
    return 0;
}

/* remove entence */
static int i2c_demo_remove(struct i2c_client *client)
{
    return 0;
}

static struct of_device_id i2c_demo_match_table[] = {
    { .compatible = "i2cdemo,eeprom", },
    { },
};

static const struct i2c_device_id i2c_demo_id[] = {
    { DEV_NAME, SLAVE_I2C_ADDR},
    {},
};

static struct i2c_driver i2c_demo_driver = {
    .driver = {
        .name  = DEV_NAME,
        .owner = THIS_MODULE,
        .of_match_table = i2c_demo_match_table,
    },
    .probe    = i2c_demo_probe,
    .remove   = i2c_demo_remove,
    .id_table = i2c_demo_id,
};

module_i2c_driver(i2c_demo_driver);

/* Module information */
MODULE_DESCRIPTION("i2c demo");
MODULE_LICENSE("GPL v2");
{% endhighlight %}

Makefile

{% highlight ruby %}
obj-m += i2c.o

KERNELDIR ?= /lib/modules/$(shell uname -r)/build

PWD       := $(shell pwd)

ROOT := $(dir $(M))
DEMOINCLUDE := -I$(ROOT)../include -I$(ROOT)/include

GCCVERSION = $(shell gcc -dumpversion | sed -e 's/\.\([0-9][0-9]\)/\1/g' -e 's/\.\([0-9]\)/0\1/g' -e 's/^[0-9]\{3,4\}$$/&00/')

GCC49 := $(shell expr $(GCCVERSION) \>= 40900)

all:
        $(MAKE) -C $(KERNELDIR) M=$(PWD) modules

install: all
        $(MAKE) -C $(KERNELDIR) M=$(PWD) modules_install
        depmod -a

clean:
        rm -rf *.o *.o.d *~ core .depend .*.cmd *.ko *.ko.unsigned *.mod.c .tmp_versions *.symvers \
        .cache.mk *.save *.bak Modules.* modules.order Module.markers *.bin

CFLAGS_i2c.o := -Wall $(DEMOINCLUDE)

ifeq ($(GCC49),1)
        CFLAGS_i2c.o += -Wno-error=date-time
endif

CFLAGS_i2c.o := $(DEMOINCLUDE)
{% endhighlight %}

## æ ¸å¿ƒæ•°æ®åˆ†æ

ARM ä½“ç³»åœ¨ç¼–å†™ I2C slave é©±åŠ¨æ—¶ï¼Œéœ€è¦åœ¨ DTS ä¸­åŠ å…¥ slave è®¾å¤‡ç›¸å…³ä¿¡æ¯ï¼Œå¼€å‘è€…
æ ¹æ® slave æ‰€åœ¨çš„ I2C æ€»çº¿æ·»åŠ ç›¸åº”çš„ DTS ä¿¡æ¯ã€‚ä¾‹æ ¹æ®ä¸Šé¢å®ä¾‹ä»£ç ï¼Œåœ¨ I2C æ€»çº¿ 
0 ä¸Šå­˜åœ¨ä¸€ä¸ª slave è®¾å¤‡ï¼Œåå­—å« i2cdemoï¼Œå…¶ i2c åœ°å€æ˜¯ 0x50ï¼Œæ‰€ä»¥å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹
æ³•ç¼–å†™ slave çš„ DTS æè¿°ï¼š

{% highlight ruby %}
&i2c0 {
    status = "okay";
        i2cdemo@50 {
            compatible = "i2cdemo,eeprom";
            reg = <0x50>;           
        };
};
{% endhighlight %}

ä¸ºäº†è®© I2C æ€»çº¿åœ¨æ€»çº¿åˆå§‹åŒ–éå†æœŸé—´èƒ½å¤Ÿæ‰¾åˆ° Slave è®¾å¤‡ï¼Œå¼€å‘è€…å¿…é¡»æä¾›å‡†ç¡®çš„é©±
åŠ¨æ•°æ®ã€‚æ•°æ®æè¿°å¦‚ä¸‹ï¼š

#### i2c_device_id ç»“æ„

{% highlight ruby %}
static const struct i2c_device_id i2c_demo_id[] = {
    { DEV_NAME, SLAVE_I2C_ADDR},
    {},
};
{% endhighlight %}

è¯¥ç»“æ„ç”¨äº I2C æ€»çº¿åœ¨ match driver æ—¶ä½¿ç”¨ã€‚

#### of_device_id ç»“æ„

{% highlight ruby %}
static struct of_device_id i2c_demo_match_table[] = {
    { .compatible = "i2cdemo,eeprom", },
    { },
};
{% endhighlight %}

è¿™ä¸ªç»“æ„ç”¨äº I2C æ€»çº¿ match DTS ä¸­çš„ I2C è®¾å¤‡ï¼Œå…¶ä¸­ compatible å±æ€§å¿…é¡»å’Œ DTS 
å®šä¹‰çš„ä¸€è‡´ï¼Œä¸ç„¶æ‰¾ä¸åˆ° Slave è®¾å¤‡ã€‚

#### i2c è¯»æ“ä½œ

i2c è¯»æ“ä½œä¾èµ–äº i2c_msg ç»“æ„å’Œ i2c_transfer()ã€‚æ¯æ¬¡è¯»æ“ä½œä¹‹å‰ï¼Œåº”æä¾›ä¸¤ä¸ª 
i2c_msg ç»“æ„ï¼Œç¬¬ä¸€ä¸ªç»“æ„ç”¨äºå‘é€ i2c ä»è®¾å¤‡éœ€è¦è¯»çš„åç§»åœ°å€ï¼Œç¬¬äºŒä¸ª i2c_msg 
ç»“æ„ä¸»è¦ç”¨äºä» slave è®¾å¤‡ä¸­è¯»æ•°æ®çš„æ•°é‡ä»¥åŠå­˜å‚¨è¯»å…¥æ•°æ®çš„ç¼“å­˜ã€‚

{% highlight ruby %}
static int i2c_demo_read(struct i2c_client *client, unsigned char reg,
                           unsigned char *data, unsigned long count)
{
    int ret;

    struct i2c_msg msgs[] = {
        {
            .addr  = client->addr,
            .flags = client->flags & I2C_M_TEN,
            .len   = 1,
            .buf   = &reg, /* Offset address on slave device */
        },
        {
            .addr  = client->addr,
            .flags = client->flags | I2C_M_RD,
            .len   = count,
            .buf   = data, /* value need to write */
        }
    };

    ret = i2c_transfer(client->adapter, msgs, 2);
    if (2 != ret) {
        printk(KERN_ERR "%s fail\n", __func__);
        return -1;
    }

    return 0;
}
{% endhighlight %}

#### i2c å†™æ“ä½œ

i2c å†™æ“ä½œä¹Ÿä¾èµ–äº i2c_msg ç»“æ„å’Œ i2c_transfer()ã€‚æ¯æ¬¡è¯»æ“ä½œä¹‹å‰ï¼Œåº”æä¾›ä¸¤ä¸ª 
i2c_msg ç»“æ„ï¼Œç¬¬ä¸€ä¸ªç»“æ„ç”¨äºå‘é€ i2c ä»è®¾å¤‡éœ€è¦å†™çš„åç§»åœ°å€ï¼Œç¬¬äºŒä¸ª i2c_msg 
ç»“æ„ä¸»è¦ç”¨äºä» slave è®¾å¤‡ä¸­å†™æ•°æ®çš„æ•°é‡ä»¥åŠå†™å…¥çš„æ•°æ®ã€‚

{% highlight ruby %}
static int i2c_demo_write(struct i2c_client *client, unsigned char reg,
                                 unsigned char *data, unsigned long count)
{
    int ret;

    struct i2c_msg msgs[] = {
        {
            .addr  = client->addr,
            .flags = client->flags & I2C_M_TEN,
            .len   = 1,
            .buf   = &reg, /* Offset address on slave device */
        },
        {
            .addr  = client->addr,
            .flags = client->flags,
            .len   = count,
            .buf   = data, /* value need to write */
        }
    };

    ret = i2c_transfer(client->adapter, msgs, 2);
    if (2 != ret) {
        printk(KERN_ERR "%s fail\n", __func__);
        return -1;
    }

    return 0;
}
{% endhighlight %}

-------------------------------------------------

# <span id="ç”¨æˆ·ç©ºé—´é€šè¿‡å·¥å…·è®¿é—® I2C">ç”¨æˆ·ç©ºé—´ä½¿ç”¨ I2C</span>

ç”¨æˆ·ç©ºé—´æœ‰ä¸¤ç§æ–¹æ³•ä½¿ç”¨ I2Cï¼Œä¸€ç§æ˜¯ä½¿ç”¨ i2c-tools å·¥å…·é›†ï¼Œå¦å¤–ä¸€ç§æ˜¯åœ¨æºç ä¸­è®¿
é—® I2Cã€‚å¼€å‘è€…å¯ä»¥æ ¹æ®éœ€è¦è‡ªè¡Œé€‰æ‹©ã€‚

## å‘½ä»¤è¡Œæ–¹å¼è®¿é—® I2C

Linux ç”¨æˆ·ç©ºé—´å¯ä»¥ä½¿ç”¨ i2c-tools å·¥å…·å¯ä»¥ç”¨æˆ·æ€è®¿é—® I2Cï¼Œå…¶åŒ…å«äº† i2cdump, 
i2cdetect, i2cget, i2cset 4 ä¸ªå·¥å…·ã€‚å¦‚æœç³»ç»Ÿä¸­æ²¡æœ‰è¿™äº›å·¥å…·ï¼Œè¯·ä½¿ç”¨å¦‚ä¸‹å·¥å…·è¿›è¡Œ
å®‰è£…ï¼š

{% highlight ruby %}
sudo apt install i2c-tools
{% endhighlight %}

#### i2cdetect

i2cdetect å·¥å…·ç”¨äºæ¢æµ‹ I2C æ€»çº¿ä¸Šæ‰€æœ‰çš„ I2C ä»è®¾å¤‡ï¼Œä»è®¾å¤‡åœ°å€ä» 0x3 åˆ° 0x77. 
è¿™ä¸ªå·¥å…·ä½¿ç”¨æ ¼å¼å¦‚ä¸‹ï¼š

{% highlight ruby %}
Usage: i2cdetect [-F I2CBUS] [-l] [-y] [-a] [-q|-r] I2CBUS [FIRST LAST]
{% endhighlight %}

ä¾‹å¦‚ï¼Œä½¿ç”¨ i2cdetect æ¢æµ‹ I2C 0 ä¸Šæ‰€æœ‰çš„ slave è®¾å¤‡

{% highlight ruby %}
# i2cdetect -y 0                                                                
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f                             
00:                                                                             
10:                                                                             
20:                                                                             
30: -- -- -- -- -- -- -- --                                                     
40:                                                                             
50: 50 51 -- -- -- -- -- -- -- -- -- -- -- -- -- --                             
60:                                                                             
70:
{% endhighlight %}

#### i2cdump

i2cdump å·¥å…·ç”±äº dump æŒ‡å®š I2C æ€»çº¿ä¸Š slave è®¾å¤‡çš„æ‰€æœ‰å†…å®¹ï¼Œå·¥å…·ä½¿ç”¨æ ¼å¼å¦‚ä¸‹ï¼š

{% highlight ruby %}
Usage: i2cdump [-f] [-r FIRST-LAST] [-y] BUS ADDR [MODE]
{% endhighlight %}

ä¾‹å¦‚ï¼Œä½¿ç”¨ i2cdump å·¥å…· dump å‡º I2C æ€»çº¿ 0 ä¸Šï¼Œslave åœ°å€ä¸º 0x50 çš„æ‰€æœ‰å†…å®¹ï¼Œ
å¦‚ä¸‹ï¼š

{% highlight ruby %}
# i2cdump -f -y 0 0x50
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f    0123456789abcdef
00: 35 02 32 52 00 02 00 02 ff ff ff ff ff ff ff ff    5?2R.?.?........
10: aa aa aa aa aa aa ff ff ff ff ff ff ff ff ff ff    ??????..........
20: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
30: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
40: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
50: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
60: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
70: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
80: 93 00 73 14 13 05 00 20 00 00 00 00 ff ff ff ff    ?.s???. ........
90: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
a0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
b0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
c0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
d0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
e0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
f0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
#
{% endhighlight %}

#### i2cget

i2cget å·¥å…·ç”¨äºåœ¨æŒ‡å®š I2C æ€»çº¿ä¸Šï¼Œè¯»å–æŒ‡å®š slave è®¾å¤‡åç§»åœ°å€ä¸Šçš„å†…å®¹ã€‚ 
i2cget ç›¸å½“äº i2c read æ“ä½œï¼Œå…¶ä½¿ç”¨æ¨¡å¼å¦‚ä¸‹ï¼š

{% highlight ruby %}
Usage: i2cget [-f] [-y] BUS CHIP-ADDRESS [DATA-ADDRESS [MODE]]
{% endhighlight %}

ä¾‹å¦‚ï¼Œä» I2C æ€»çº¿ 0 ä¸Šï¼Œè¯»å– slave è®¾å¤‡åœ°å€ä¸º 0x50ï¼Œåç§»åœ°å€ä¸º 0x80 ä¸Šçš„æ•°æ®ï¼Œ
å¦‚ä¸‹ï¼š

{% highlight ruby %}
# i2cget -f -y 0 0x50 0x80
0x93
{% endhighlight %}

#### i2cset

i2cset å·¥å…·ç”¨äºåœ¨ I2C æ€»çº¿ä¸Šï¼Œå¾€ slave è®¾å¤‡åç§»åœ°å€ä¸Šå†™æ•°æ®ï¼Œå…¶å‘½ä»¤ä½¿ç”¨æ ¼å¼å¦‚
ä¸‹ï¼š

{% highlight ruby %}
Usage: i2cset [-f] [-y] [-m MASK] BUS CHIP-ADDR DATA-ADDR [VALUE] ... [MODE]
{% endhighlight %}

ä¾‹å¦‚ï¼Œåœ¨ I2C æ€»çº¿ 0 ä¸Šï¼Œå¾€ slave åœ°å€ä¸º 0x50 çš„è®¾å¤‡ä¸Šï¼Œåç§»åœ°å€ä¸º 0x40 çš„åœ°å€
ä¸Šå†™å…¥ 0x68ï¼Œå¦‚ä¸‹ï¼š

{% highlight ruby %}
# i2cget -f -y 0 0x50 0x40
0xff
# i2cset -f -y 0 0x50 0x40 0x68
# i2cget -f -y 0 0x50 0x40
0x68
{% endhighlight %}

## <span id="ç”¨æˆ·ç©ºé—´é€šè¿‡æºç è®¿é—® I2C">ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºä¸­è®¿é—® I2C</span>

åº”ç”¨ç¨‹åºæœ‰æ—¶ä¹Ÿè¦è®¿é—® I2C æ€»çº¿ä¸Šçš„è®¾å¤‡ï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç è¿›è¡Œè®¿é—®ï¼š

{% highlight ruby %}
/*
* I2C demo on userspace
*
* (C) 2018.12.14 <buddy.zhang@aliyun.com>
*
* This program is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License version 2 as
* published by the Free Software Foundation.
*/
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>

#include <linux/i2c.h>
#include <linux/i2c-dev.h>

#define I2C_SLAVE_ADDR      0x50
#define I2C_BUS             "/dev/i2c-0"
#define I2C_M_WR            0x0

/*
* I2C read
* @fd: file handler
* @addr: i2c slave 7-bit address
* @offset: read position.
* @buf: buffer for reading data.
* @len: length for reading.
*
* @return: the number of i2c_msg has read.
*          succeed is 2.
*/
int I2CBus_packetRead(int fd, unsigned char addr, unsigned char offset,
                             unsigned char *buf, unsigned char len)
{
    unsigned char tmpaddr[2];
    struct i2c_msg msgs[2];
    struct i2c_rdwr_ioctl_data msgset;
    int rc;

    tmpaddr[0]     = offset;
    msgs[0].addr   = addr & 0xfe;
    msgs[0].flags  = I2C_M_WR;
    msgs[0].len    = 1;
    msgs[0].buf    = tmpaddr;

    msgs[1].addr   = addr & 0xfe;
    msgs[1].flags  = I2C_M_RD;  ;
    msgs[1].len    = len;
    msgs[1].buf    = buf;

    msgset.msgs    = msgs;
    msgset.nmsgs   = 2;

    rc = ioctl(fd, I2C_RDWR, &msgset);
    return rc;
}

/*
* I2C write
* @fd: file handler.
* @addr: i2c slave 7-bit address
* @offset: write position
* @buf: buffer for writuing data.
* @len: the length for writing
*
* @return: the number of i2c_msg has write.
*          succeed is 1.
*/
int I2CBus_packetWrite(int fd, unsigned char addr, unsigned char offset,
                              unsigned char *buf, unsigned char len)
{
    unsigned char tmpaddr[2];
    struct i2c_msg msgs[2];
    struct i2c_rdwr_ioctl_data msgset;
    int rc;

    tmpaddr[0]     = offset;
    tmpaddr[1]     = buf[0];
    msgs[0].addr   = addr & 0xfe;
    msgs[0].flags  = I2C_M_WR;
    msgs[0].len    = 2;
    msgs[0].buf    = tmpaddr;

    msgset.msgs    = msgs;
    msgset.nmsgs   = 1;

    rc = ioctl(fd, I2C_RDWR, &msgset);
    return rc;
}

int main()
{
    unsigned char value;
    int fd;

    fd = open(I2C_BUS, O_RDWR);
    if (fd < 0) {
        printf("Unable to open I2C Bus.\n");
        return -1;
    }

    /* Read Data from I2C */
    I2CBus_packetRead(fd, I2C_SLAVE_ADDR, 0x20, &value, 1);

    /* Write Dato into I2C */
    I2CBus_packetWrite(fd, I2C_SLAVE_ADDR, 0x20, &value, 1);

    return 0;
}
{% endhighlight %}

-----------------------------------------

# <span id="é™„å½•">é™„å½•</span>

> [I2Cæ€»çº¿ä¿¡å·æ—¶åºæ€»ç»“](https://blog.csdn.net/chuckfql/article/details/19834137)
>
> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](https://biscuitos.github.io/blog/Kernel_Build/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](/assets/PDB/BiscuitOS/kernel/HAB000036.jpg)
