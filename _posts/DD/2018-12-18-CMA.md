---
layout: post
title:  "CMA"
date:   2018-12-18 14:33:30 +0800
categories: [HW]
excerpt: CMA.
tags:
  - Bus
---

> [GitHub: CMA](https://github.com/BiscuitOS/HardStack/tree/master/bus/CMA)
>
> Email: BuddyZhang1 <buddy.zhang@aliyun.com>

# ç›®å½•

> 1. [CMA åŸç†](#CMA åŸç†)
>
> 2. [Kernel ä¸­ä½¿ç”¨ CMA å†…å­˜](#Kernel ä¸­ä½¿ç”¨ CMA å†…å­˜)
>
> 3. [ç”¨æˆ·ç©ºé—´ä½¿ç”¨ CMA å†…å­˜](#ç”¨æˆ·ç©ºé—´ä½¿ç”¨ CMA å†…å­˜)
>
> 4. [è¶…å¤§ CMA å†…å­˜è®¾ç½®æ–¹æ³•](#è¶…å¤§ CMA å†…å­˜è®¾ç½®æ–¹æ³•)
>
> 5. [é™„å½•](#é™„å½•)

----------------------------------------------------------

# <span id="CMA åŸç†">CMA åŸç†</span>

CMAï¼ˆContiguous Memory Allocatorï¼‰æ˜¯è¿ç»­å†…å­˜åˆ†é…æŠ€æœ¯ï¼Œæ˜¯ Linux Kernel å†…å­˜ç®¡ç†
ç³»ç»Ÿçš„æ‰©å±•ï¼Œç›®çš„åœ¨äºè§£å†³è§†é¢‘æ’­æ”¾ï¼ˆç‰¹åˆ«å¯¹äº 4K è§†é¢‘ï¼‰éœ€è¦é¢„ç•™å¤§é‡è¿ç»­å†…å­˜å¯¼è‡´è¿
è¡Œå†…å­˜ç´§å¼ çš„é—®é¢˜ã€‚è¿ç»­å†…å­˜åˆ†é…å™¨(CMA - Contiguous Memory Allocator) æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œ
å…è®¸å»ºç«‹ä¸€ä¸ªå¹³å°æ— å…³çš„é…ç½®ï¼Œç”¨äºè¿ç»­å†…å­˜çš„ç®¡ç†ã€‚ç„¶åï¼Œè®¾å¤‡æ‰€éœ€å†…å­˜éƒ½æ ¹æ®è¯¥é…ç½®
è¿›è¡Œåˆ†é…ã€‚è¿™ä¸ªæ¡†æ¶çš„ä¸»è¦ä½œç”¨ä¸æ˜¯åˆ†é…å†…å­˜ï¼Œè€Œæ˜¯è§£æå’Œç®¡ç†å†…å­˜é…ç½®ï¼Œä»¥åŠä½œä¸ºåœ¨è®¾
å¤‡é©±åŠ¨ç¨‹åºå’Œå¯æ’æ‹”çš„åˆ†é…å™¨ä¹‹é—´çš„ä¸­é—´ç»„ä»¶ã€‚å› æ­¤ï¼Œå®ƒæ˜¯ä¸ä»»ä½•å†…å­˜åˆ†é…æ–¹æ³•å’Œåˆ†é…ç­–
ç•¥æ²¡æœ‰ä¾èµ–å…³ç³»çš„ã€‚

ä»è®¾å¤‡é©±åŠ¨è§’åº¦çœ‹ï¼Œä»»ä½•äº‹æƒ…éƒ½ä¸åº”è¯¥è¢«å½±å“ã€‚å› ä¸º CMA æ˜¯è¢«é›†æˆåˆ° DMA å­ç³»ç»Ÿï¼Œæ‰€ä»¥
ä»¥å‰è°ƒç”¨ DMA APIï¼ˆä¾‹å¦‚dma_alloc_coherent()ï¼‰çš„åœ°æ–¹åº”è¯¥ç…§å¸¸å·¥ä½œã€‚äº‹å®ä¸Šï¼Œè®¾å¤‡é©±
åŠ¨æ°¸è¿œä¸éœ€è¦ç›´æ¥è°ƒç”¨ CMA APIï¼Œå› ä¸ºå®ƒæ˜¯åœ¨é¡µå’Œé¡µå¸§ç¼–å·ï¼ˆPFNsï¼‰ä¸Šæ“ä½œè€Œæ— å…³æ€»çº¿åœ°
å€å’Œå†…æ ¸æ˜ å°„ï¼Œå¹¶ä¸”ä¹Ÿä¸æä¾›ç»´æŠ¤ç¼“å­˜ä¸€è‡´æ€§çš„æœºåˆ¶ã€‚è·å–æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸¤ä»½æœ‰
ç”¨çš„æ–‡æ¡£ã€‚è¿™ä¸¤ç¯‡æ–‡æ¡£æè¿°äº†DMA æä¾›çš„æ–¹æ³•æ¥å£åŠä½¿ç”¨ç”¨ä¾‹ã€‚

> Documentation/DMA-API.txt
>
> Documentation/DMA-API-HOWTO.txt


## CMA éœ€æ±‚

åœ¨åµŒå…¥å¼è®¾å¤‡ä¸­ï¼Œå¾ˆå¤šè®¾å¤‡éƒ½æ²¡æœ‰æ”¯æŒ scatter-getter å’Œ IO mapï¼Œéƒ½éœ€è¦è¿ç»­å†…å­˜å—
çš„æ“ä½œã€‚å¦‚è®¾å¤‡ï¼šæ‘„åƒæœºï¼Œç¡¬ä»¶è§†é¢‘è§£ç å™¨ï¼Œç¼–ç å™¨ç­‰ã€‚è¿™äº›è®¾å¤‡å¾€å¾€éœ€è¦è¾ƒå¤§çš„å†…å­˜ç¼“
å†²åŒºï¼ˆå¦‚ï¼šä¸€ä¸ª200ä¸‡åƒç´ çš„é«˜æ¸…å¸§æ‘„åƒæœºï¼Œéœ€è¦è¶…è¿‡ 6M çš„å†…å­˜ï¼‰ï¼Œè¯¥ kmalloc å†…å­˜åˆ†
é…æœºåˆ¶å¯¹äºè¿™ä¹ˆå¤§çš„å†…å­˜æ˜¯æ²¡æœ‰æ•ˆæœçš„ã€‚ä¸€äº›åµŒå…¥å¼è®¾å¤‡å¯¹ç¼“å†²åŒºæœ‰ä¸€äº›é¢å¤–çš„è¦æ±‚ï¼Œæ¯”
å¦‚ï¼šåœ¨å«æœ‰å¤šä¸ªå†…å­˜ bank çš„è®¾å¤‡ä¸­ï¼Œè¦æ±‚åªèƒ½åœ¨ç‰¹å®šçš„bank ä¸­ä¸­åˆ†é…å†…å­˜ï¼›è€Œè¿˜æœ‰ä¸€
äº›è¦å®šå†…å­˜è¾¹ç•Œå¯¹é½çš„ç¼“å­˜åŒºã€‚è¿‘æ¥ï¼ŒåµŒå…¥å¼è®¾å¤‡æœ‰äº†è¾ƒå¤§çš„å‘å±•(ç‰¹åˆ«æ˜¯ V4L é¢†åŸŸ)ï¼Œ
å¹¶ä¸”è¿™äº›é©±åŠ¨éƒ½æœ‰è‡ªå·±çš„å†…å­˜åˆ†é…ä»£ç ã€‚å®ƒä»¬ä¼—å¤šçš„å¤§å¤šæ•°éƒ½æ˜¯é‡‡ç”¨ bootmem åˆ†é…æ–¹æ³•ã€‚
CMA æ¡†æ¶ä¼å›¾é‡‡ç”¨ç»Ÿä¸€çš„è¿ç»­å†…å­˜åˆ†é…æœºåˆ¶ï¼Œå¹¶ä¸ºè¿™äº›è®¾å¤‡é©±åŠ¨æä¾›ç®€å•çš„APIï¼Œè€Œä¸”æ˜¯
å¯ä»¥å®šåˆ¶åŒ–å’Œæ¨¡å—åŒ–çš„ã€‚

## CMA è®¾è®¡

CMA ä¸»è¦è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªå¯å®šåˆ¶çš„æ¨¡å—åŒ–æ¡†æ¶ï¼Œå¹¶ä¸”æ˜¯å¯ä»¥é…ç½®çš„ï¼Œä»¥é€‚åº”ä¸ªåˆ«ç³»ç»Ÿ
çš„éœ€è¦ã€‚é…ç½®æŒ‡å®šçš„å†…å­˜åŒºåŸŸï¼Œç„¶åå°†è¿™äº›å†…å­˜åˆ†é…ç»™åˆ¶å®šçš„è®¾å¤‡ã€‚è¿™äº›å†…å­˜åŒºåŸŸå¯ä»¥å…±
äº«ç»™å¤šä¸ªè®¾å¤‡é©±åŠ¨ï¼Œä¹Ÿå¯ä»¥ä¸“é—¨åˆ†é…ä¸€ä¸ªã€‚è¿™æ˜¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°çš„ï¼š

> 1. CMA çš„æ ¸å¿ƒä¸æ˜¯å¤„ç†å†…å­˜åˆ†é…å’Œç©ºé—²ç©ºé—´ç®¡ç†ã€‚ä¸“ç”¨åˆ†é…å™¨æ˜¯ç”¨æ¥å¤„ç†å†…å­˜åˆ†é…å’Œ
>    ç©ºé—²å†…å­˜ç®¡ç†çš„ã€‚å› æ­¤ï¼Œå¦‚æœç°æœ‰çš„è§£å†³æ–¹æ¡ˆä¸ç¬¦åˆç»™å®šçš„ç³»ç»Ÿï¼Œé‚£ä¹ˆå¯ä»¥å¼€å‘ä¸€
>    ç§æ–°çš„ç®—æ³•ï¼Œè¿™ç§ç®—é¥­å¯ä»¥å¾ˆå®¹æ˜“åœ°æ’å…¥åˆ° CMA æ¡†æ¶ä¸­ã€‚æ‰€æå‡ºçš„è§£å†³æ–¹æ¡ˆä¸­åŒ…æ‹¬
>    ä¸€ä¸ªæœ€é€‚ç®—æ³•(best-fit)çš„ä¸€ä¸ªå®ç°ã€‚
>
> 2. CMA å…è®¸è¿è¡Œæ—¶é…ç½®å³å°†åˆ†é…çš„å†…å­˜åŒºåŸŸã€‚å†…å­˜åŒºåŸŸéƒ½æ˜¯ç»ç”±å‘½ä»¤è¡Œç»™å‡ºçš„ï¼Œæ‰€ä»¥
>    å¯ä»¥å¾ˆå®¹æ˜“åœ°æ”¹å˜å®ƒï¼Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸ã€‚æ¯ä¸ªåœ°åŒºéƒ½æœ‰è‡ªå·±çš„å¤§å°ï¼Œå¯¹é½æ ‡
>    å‡†ï¼Œèµ·å§‹åœ°å€ï¼ˆç‰©ç†åœ°å€ï¼‰å’Œå¯¹åº”è¯¥å†…å­˜åŒºåŸŸçš„å†…å­˜åˆ†é…ç®—æ³•ã€‚è¿™æ„å‘³ç€åŒä¸€æ—¶åˆ»
>    å¯ä»¥æœ‰å¤šä¸­æœºåˆ¶åœ¨è¿è¡Œï¼Œå¦‚æœåœ¨ä¸€ä¸ªå¹³å°ä¸ŠåŒæ—¶è¿è¡Œå¤šä¸ªä¸åŒçš„è®¾å¤‡ï¼Œè¿™äº›è®¾å¤‡å…·
>    æœ‰ä¸åŒçš„å­˜å‚¨å™¨ä½¿ç”¨ç‰¹æ€§ï¼Œé‚£ä¹ˆå±€å¯ä»¥åŒ¹é…æœ€å¥½çš„ç®—æ³•ã€‚
>
> 3. å½“è®¾å¤‡è¯·æ±‚å†…å­˜æ—¶ï¼Œè®¾å¤‡å¿…é¡»â€œè‡ªæˆ‘ä»‹ç»â€ï¼Œå³é™„å¸¦è‡ªå·±çš„ä¿¡æ¯ä»¥å‘ŠçŸ¥ CMAã€‚è¿™æ · CMA
>    å¯ä»¥çŸ¥é“è°åˆ†é…å†…å­˜ã€‚è¿™å…è®¸ç³»ç»Ÿæ¶æ„å¸ˆæ¥æŒ‡å®šå“ªä¸ªç§»åŠ¨è®¾å¤‡åº”è¯¥ä½¿ç”¨å“ªäº›å­˜å‚¨åŒºã€‚
>    è®¾å¤‡ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªâ€œç±»â€å†…å­˜åŒºåŸŸï¼Œè¿™ä½¿å¾—ç³»ç»Ÿæ›´å®¹æ˜“é…ç½®ï¼Œè¿›è€Œä¸€ä¸ªå•ä¸€çš„è®¾å¤‡
>    å¯èƒ½ä½¿ç”¨æ¥è‡ªä¸åŒå†…å­˜åŒºåŸŸçš„å†…å­˜ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªè§†é¢‘è§£ç å™¨é©±åŠ¨ç¨‹åºå¯èƒ½è¦åˆ†é…ä¸€
>    äº›å…±äº«çš„ç¼“å†²åŒºï¼Œé‚£ä¹ˆä»ç¬¬ä¸€ä¸ª bank ä¸­åˆ†é…ä¸€äº›ï¼Œå†ä»ç¬¬äºŒä¸ª bank ä¸­åˆ†é…ä¸€äº›ï¼Œ
>    å¯ä»¥è·å¾—å°½å¯èƒ½é«˜çš„å†…å­˜ååé‡
>
> 4. é€šè¿‡è¿™å¥—æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åšåˆ°ä¸é¢„ç•™å†…å­˜ï¼Œè¿™äº›å†…å­˜å¹³æ—¶æ˜¯å¯ç”¨çš„ï¼Œåªæœ‰å½“éœ€è¦çš„
>    æ—¶å€™æ‰è¢«åˆ†é…ç»™ Cameraï¼ŒHDMI ç­‰è®¾å¤‡ã€‚

## CMA å…³é”®ç‚¹

#### å¦‚ä½•ä¿è¯å†…å­˜è¢«å¤ç”¨

CMA é€šè¿‡åœ¨å¯åŠ¨é˜¶æ®µé¢„å…ˆä¿ç•™å†…å­˜ã€‚è¿™äº›å†…å­˜å«åš CMA åŒºåŸŸæˆ– CMA ä¸Šä¸‹æ–‡ï¼Œç¨åè¿”å›ç»™
ä¼™ä¼´ç³»ç»Ÿä»è€Œå¯ä»¥è¢«ç”¨ä½œæ­£å¸¸ç”³è¯·ã€‚å¦‚æœè¦ä¿ç•™å†…å­˜ï¼Œåˆ™éœ€è¦æ°å¥½åœ¨åº•å±‚â€œmemblockâ€åˆ†é…
å™¨åˆå§‹åŒ–ä¹‹åï¼ŒåŠå¤§é‡å†…å­˜è¢«å ç”¨ä¹‹å‰è°ƒç”¨ï¼Œå¹¶åœ¨ä¼™ä¼´ç³»ç»Ÿå»ºç«‹ä¹‹å‰è°ƒç”¨ï¼š

{% highlight ruby %}
void dma_contiguous_reserve(phys_addr_t limit)
{% endhighlight %}

#### è¦ç†è§£ CMA å¦‚ä½•å·¥ä½œï¼Œéœ€è¦äº†è§£ä¸€äº›è¿ç§»ç±»å‹å’Œé¡µå—çš„çŸ¥è¯†ã€‚

å½“ä»ä¼™ä¼´ç³»ç»Ÿç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œéœ€è¦æä¾›ä¸€ä¸ª gfp_mask å‚æ•°ã€‚ä¸ç®¡å…¶ä»–äº‹æƒ…ï¼Œè¿™ä¸ªå‚æ•°
æŒ‡å®šäº†è¦ç”³è¯·å†…å­˜çš„è¿ç§»ç±»å‹ã€‚ä¸€ä¸ªå‰ä¸€ç±»å‹æ˜¯ MIGRATE_MOVABLEã€‚å®ƒèƒŒåçš„æ„æ€æ˜¯åœ¨å¯
ç§»åŠ¨é¡µé¢ä¸Šçš„æ•°æ®å¯ä»¥è¢«è¿ç§»ï¼ˆæˆ–è€…ç§»åŠ¨ï¼Œå› æ­¤è€Œå‘½åï¼‰ï¼Œè¿™å¯¹äºç£ç›˜ç¼“å­˜æˆ–è€…è¿›ç¨‹é¡µé¢
æ¥è¯´å¾ˆæœ‰æ•ˆã€‚ä¸ºäº†ä½¿ç›¸åŒè¿ç§»ç±»å‹çš„é¡µé¢åœ¨ä¸€èµ·ï¼Œä¼™ä¼´ç³»ç»ŸæŠŠé¡µé¢ç»„æˆâ€œé¡µé¢å—â€ï¼Œæ¯ç»„éƒ½
æœ‰ä¸€ä¸ªæŒ‡å®šçš„è¿ç§»ç±»å‹ã€‚åˆ†é…å™¨æ ¹æ®è¯·æ±‚çš„ç±»å‹åœ¨ä¸åŒçš„é¡µé¢å—ä¸Šåˆ†é…é¡µã€‚å¦‚æœå°è¯•å¤±
è´¥ï¼Œåˆ†é…å™¨ä¼šåœ¨å…¶å®ƒé¡µé¢å—ä¸Šåˆ†é…å¹¶ç”šè‡³ä¿®æ”¹é¡µé¢å—çš„è¿ç§»ç±»å‹ã€‚è¿™æ„å‘³ç€ä¸€ä¸ªä¸å¯ç§»åŠ¨
çš„é¡µå¯èƒ½åˆ†é…è‡ªä¸€ä¸ª MIGRATE_MOVABLE é¡µé¢å—ï¼Œå¹¶å¯¼è‡´è¯¥é¡µé¢å—çš„è¿ç§»ç±»å‹æ”¹å˜ã€‚è¿™ä¸
æ˜¯ CMA æƒ³è¦çš„ï¼Œæ‰€ä»¥å®ƒå¼•å…¥äº†ä¸€ä¸ª MIGRATE_CMA ç±»å‹ï¼Œè¯¥ç±»å‹åˆä¸€ä¸ªé‡è¦çš„å±æ€§ï¼šåªæœ‰
å¯ç§»åŠ¨é¡µå¯ä»¥ä» MIGRATE_CMA é¡µé¢å—ç§åˆ†é…ã€‚é‚£ä¹ˆï¼Œåœ¨å¯åŠ¨æœŸé—´ï¼Œå½“ 
dma_congiguous_reserve() å’Œ dma_declare_contiguous() æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼ŒCMA åœ¨
memblock ä¸­é¢„ç•™ä¸€éƒ¨åˆ† RAMï¼Œå¹¶åœ¨éšåå°†å…¶è¿”è¿˜ç»™ä¼™ä¼´ç³»ç»Ÿï¼Œä»…å°†å…¶é¡µé¢å—çš„è¿ç§»ç±»å‹
ç½®ä¸º MIGRATE_CMAã€‚æœ€ç»ˆçš„ç»“æœæ˜¯æ‰€æœ‰é¢„ç•™çš„é¡µéƒ½åœ¨ä¼™ä¼´ç³»ç»Ÿé‡Œï¼Œæ‰€ä»¥å®ƒä»¬éƒ½å¯ä»¥ç”¨äºå¯
ç§»åŠ¨é¡µçš„åˆ†é…ã€‚

åœ¨CMAåˆ†é…çš„æ—¶å€™ï¼Œdma_alloc_from_contiguous() é€‰æ‹©ä¸€ä¸ªé¡µèŒƒå›´å¹¶è°ƒç”¨ï¼š

{% highlight ruby %}
int alloc_contig_range(unsigned long start, unsigned long end,unsigned migratetype);
{% endhighlight %}

start å’Œ end å‚æ•°æŒ‡å®šäº†ç›®æ ‡å†…å­˜çš„é¡µæ¡†ä¸ªæ•°ï¼ˆæˆ–PFNèŒƒå›´ï¼‰ã€‚æœ€åä¸€ä¸ªå‚æ•° 
migratetype æŒ‡å®šäº†æ½œåœ¨çš„è¿ç§»ç±»å‹ï¼›åœ¨ CMA çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‚æ•°å°±æ˜¯ MIGRATE_CMAã€‚
è¿™ä¸ªå‡½æ•°æ‰€åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å°†åŒ…å« (start, end) èŒƒå›´å†…çš„é¡µé¢å—æ ‡è®°ä¸º
MIGRATE_ISOLATEã€‚ä¼™ä¼´ç³»ç»Ÿä¸ä¼šå»è§¦åŠ¨è¿™ç§ç±»å‹çš„é¡µé¢å—ã€‚æ”¹å˜è¿ç§»ç±»å‹ä¸ä¼šé­”æ³•èˆ¬åœ°
é‡Šæ”¾é¡µé¢ï¼Œå› æ­¤æ¥ä¸‹æ¥éœ€è¦è°ƒç”¨__alloc_conting_migrate_range()ã€‚å®ƒæ‰«æPFNèŒƒå›´å¹¶å¯»
æ‰¾å¯ä»¥è¿ç§»çš„é¡µé¢ã€‚è¿ç§»æ˜¯å°†é¡µé¢å¤åˆ¶åˆ°ç³»ç»Ÿå…¶å®ƒå†…å­˜éƒ¨åˆ†å¹¶æ›´æ–°ç›¸å…³å¼•ç”¨çš„è¿‡ç¨‹ã€‚å‰ä¸€
éƒ¨ä»½å¾ˆç›´æ¥ï¼Œåé¢çš„éƒ¨åˆ†éœ€è¦å†…å­˜ç®¡ç†å­ç³»ç»Ÿæ¥å®Œæˆã€‚å½“æ•°æ®è¿ç§»å®Œæˆï¼Œæ—§çš„é¡µé¢è¢«é‡Šæ”¾
å¹¶å›å½’ä¼™ä¼´ç³»ç»Ÿã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¹‹å‰é‚£äº›éœ€è¦åŒ…å«çš„é¡µé¢å—ä¸€å®šè¦æ ‡è®°ä¸º 
MIGRATE_ISOLATE çš„åŸå› ã€‚å¦‚æœæŒ‡å®šäº†å…¶å®ƒçš„è¿ç§»ç±»å‹ï¼Œä¼™ä¼´ç³»ç»Ÿä¼šæ¯«ä¸çŠ¹è±«åœ°å°†å®ƒä»¬ç”¨
äºå…¶å®ƒç±»å‹çš„ç”³è¯·ã€‚

ç°åœ¨æ‰€æœ‰ alloc_contig_range å…³å¿ƒçš„é¡µéƒ½ï¼ˆå¸Œæœ›å¦‚æ­¤ï¼‰æ˜¯ç©ºé—²çš„äº†ã€‚è¯¥æ–¹æ³•å°†ä»ä¼™ä¼´ç³»
ç»Ÿä¸­å–å‡ºå®ƒä»¬ï¼Œå¹¶å°†è¿™äº›é¡µé¢å—çš„ç±»å‹æ”¹ä¸ºMIGRATE_CMAã€‚ç„¶åå°†è¿™äº›é¡µè¿”å›ç»™è°ƒç”¨è€…ã€‚
é‡Šæ”¾å†…å­˜å°±æ›´ç®€å•äº†ã€‚dma_release_from_contiguous() å°†å…¶å·¥ä½œè½¬äº¤ç»™ï¼š

{% highlight ruby %}
void free_contig_range(unsigned long pfn, unsigned nr_pages);
{% endhighlight %}

è¿™ä¸ªå‡½æ•°è¿­ä»£æ‰€æœ‰çš„é¡µé¢å¹¶å°†å…¶è¿”è¿˜ç»™ä¼™ä¼´ç³»ç»Ÿã€‚

------------------------------------------------

# <span id="Kernel ä¸­ä½¿ç”¨ CMA å†…å­˜">Kernel ä¸­ä½¿ç”¨ CMA</span>

åœ¨é©±åŠ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ ¹æ®ç‰¹å®šçš„éœ€æ±‚å°† CMA å†…å­˜åˆ†é…ç»™ç”¨æˆ·ç©ºé—´çš„ç¨‹åºä½¿ç”¨ï¼Œæ‰€æœ‰
æœ¬èŠ‚ä¸»è¦è®²è§£å¦‚ä½•ç¼–å†™ä¸€ä¸ª CMA é©±åŠ¨ç»™ç”¨æˆ·ç©ºé—´ä½¿ç”¨ã€‚ä¸ºäº†åœ¨ Kernel é‡Œç¼–å†™ CMA é©±
åŠ¨ï¼Œéœ€è¦æä¾›ä¸€ä¸‹å‡ ç§å†…å®¹ï¼š

> 1. [CMA é©±åŠ¨](#CMA é©±åŠ¨)
> 
> 2. [CMA åœ¨ DTS ä¸­æè¿°](#CMA åœ¨ DTS ä¸­æè¿°)
>
> 3. [å†…æ ¸å®](#å†…æ ¸å®)
>
> 4. [CMA é…ç½®å‚æ•°](#CMA é…ç½®å‚æ•°)

å®Œæ•´ Github æºç åŠæ‰‹å†Œï¼š

{% highlight ruby %}
https://github.com/BiscuitOS/HardStack/blob/master/bus/cma
{% endhighlight %}

## <span id="CMA é©±åŠ¨">CMA é©±åŠ¨</span>

CMA é©±åŠ¨å¯ä»¥å‚è€ƒå¦‚ä¸‹ï¼š

{% highlight ruby %}
/*
* CMA driver
*
* (C) 2018.11.29 BiscuitOS <buddy.zhang@aliyun.com>
*
* This program is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License version 2 as
* published by the Free Software Foundation.
*/
#include <linux/miscdevice.h>
#include <linux/platform_device.h>
#include <linux/fs.h>
#include <linux/file.h>
#include <linux/mm.h>
#include <linux/list.h>
#include <linux/mutex.h>
#include <linux/debugfs.h>
#include <linux/mempolicy.h>
#include <linux/sched.h>
#include <linux/module.h>
#include <asm/io.h>
#include <asm/uaccess.h>
#include <asm/cacheflush.h>
#include <linux/dma-mapping.h>
#include <linux/export.h>
#include <linux/gfp.h>
#include <linux/acpi.h>
#include <linux/bootmem.h>
#include <linux/cache.h>
#include <linux/export.h>
#include <linux/slab.h>
#include <linux/genalloc.h>
#include <linux/dma-mapping.h>
#include <linux/dma-contiguous.h>
#include <linux/cma.h>
#include <asm/io.h>

#define CMA_MEM_VERSION         3
#define DEVICE_NAME             "CMA"
#define CMEM_IOCTL_MAGIC        'm'
#define CMEM_ALLOCATE           _IOW(CMEM_IOCTL_MAGIC, 1, unsigned int)
#define CMEM_RELEASE            _IOW(CMEM_IOCTL_MAGIC, 2, unsigned int)

struct cmamem_info {
    unsigned int version;
    unsigned int len;
    unsigned int offset;
    unsigned long mem_base;
    unsigned long phy_base;
};

struct cmamem_dev {
    struct miscdevice dev;
    struct mutex cmamem_lock;
    struct list_head info_list;
};

struct current_status {
    int status;
    dma_addr_t phy_base;
};

enum cma_status {
    UNKNOW_STATUS = 0,
    HAVE_ALLOCED = 1,
};

static struct current_status cmamem_status;
static struct cmamem_dev cmamem_dev;
static struct cmamem_info cma_info;

static long cmamem_ioctl(struct file *file, unsigned int cmd, unsigned long arg)
{
    unsigned long nr_pages;
    struct page *page;
    unsigned int pool_size_order;

    switch (cmd) {
    case CMEM_ALLOCATE:
        mutex_lock(&cmamem_dev.cmamem_lock);
        if(cmamem_status.status != HAVE_ALLOCED) {              
            if (copy_from_user(&cma_info, (void __user *)arg,
                                         sizeof(struct cmamem_info))) {
                printk(KERN_ERR "CMEM_ALLOCATE: copy_from_user error\n");
                goto CMA_FAIL;
            }
            if(cma_info.version != CMA_MEM_VERSION) {
                printk(KERN_ERR "CMEM_ALLOCATE: kernel module version "
                              "check fail, version % d\n", cma_info.version);
                goto CMA_FAIL;
            }

            nr_pages = cma_info.len >> PAGE_SHIFT;
            pool_size_order = get_order(cma_info.len);
            page = dma_alloc_from_contiguous(NULL, nr_pages,
                                       pool_size_order, GFP_KERNEL);            

            if(!page) {
                printk(KERN_ERR "CMEM_ALLOCATE: dma_alloc_from_contiguous "
                                "fail, len 0x%x\n", cma_info.len);
                goto CMA_FAIL;
            }

            cma_info.mem_base = (dma_addr_t)page_to_virt(page);
            cma_info.phy_base = (dma_addr_t)page_to_phys(page);
            cmamem_status.phy_base = cma_info.phy_base;
            cmamem_status.status = HAVE_ALLOCED;
        }               
        if (copy_to_user((void __user *)arg, &cma_info,
                                     sizeof(struct cmamem_info))) {
            printk(KERN_ERR "CMEM_ALLOCATE: copy_to_user error\n");
            goto CMA_FAIL;
        }
        mutex_unlock(&cmamem_dev.cmamem_lock);
        return 0;
    case CMEM_RELEASE:
        mutex_lock(&cmamem_dev.cmamem_lock);
        if(cmamem_status.status != HAVE_ALLOCED) {
            printk(KERN_ERR "CMEM_RELEASE: %s, not allocted memory\n",
                                    __func__);
            goto CMA_FAIL;
        }
        if (copy_from_user(&cma_info, (void __user *)arg,
                                    sizeof(struct cmamem_info))) {
            printk(KERN_ERR "CMEM_RELEASE: copy_from_user error\n");
            goto CMA_FAIL;
        }               
        if(cma_info.version != CMA_MEM_VERSION) {
            printk(KERN_ERR "CMEM_RELEASE: kernel module version check fail, "
                       "version % d\n", cma_info.version);
            goto CMA_FAIL;
        }               
        if(cma_info.phy_base != cmamem_status.phy_base) {
            printk(KERN_ERR "CMEM_RELEASE: unknown CMA 0x%lx\n",
                     cma_info.phy_base);
            goto CMA_FAIL;
        }
                
        page = phys_to_page(cmamem_status.phy_base);
        nr_pages = cma_info.len >> PAGE_SHIFT;
        dma_release_from_contiguous(NULL, page, nr_pages);
        memset(&cma_info, 0, sizeof(cma_info));
        memset(&cmamem_status, 0, sizeof(cmamem_status));
        mutex_unlock(&cmamem_dev.cmamem_lock);
        return 0;
    default:
        printk(KERN_INFO "cma mem not support command\n");
        return -EFAULT;
    }
CMA_FAIL:
    mutex_unlock(&cmamem_dev.cmamem_lock);
    return -EFAULT;
}

static int cmamem_mmap(struct file *filp, struct vm_area_struct *vma) {
    unsigned long start = vma->vm_start;
    unsigned long size = vma->vm_end - vma->vm_start;
    unsigned long offset = vma->vm_pgoff << PAGE_SHIFT;
    unsigned long page, pos;

    if (cmamem_status.status != HAVE_ALLOCED) {
        printk(KERN_ERR "cmamem_mmap: %s, you should allocted memory "
                             "firstly\n", __func__);
        return -EINVAL;
    }

    pos = (unsigned long) cmamem_status.phy_base + offset;
    page = pos >> PAGE_SHIFT;
    if (remap_pfn_range(vma, start, page, size, PAGE_SHARED))
        return -EAGAIN;

    vma->vm_flags &= ~VM_IO;
    vma->vm_flags |= (VM_DONTEXPAND | VM_DONTDUMP);

    return 0;
}

static struct file_operations dev_fops = {
    .owner = THIS_MODULE,
    .unlocked_ioctl = cmamem_ioctl,
    .mmap = cmamem_mmap,
};

static int __init cmamem_init(void)
{
    mutex_init(&cmamem_dev.cmamem_lock);
    INIT_LIST_HEAD(&cmamem_dev.info_list);
    cmamem_dev.dev.name = DEVICE_NAME;
    cmamem_dev.dev.minor = MISC_DYNAMIC_MINOR;
    cmamem_dev.dev.fops = &dev_fops;

    cmamem_status.status = UNKNOW_STATUS;
    cmamem_status.phy_base = 0;

    return misc_register(&cmamem_dev.dev);
}

static void __exit cmamem_exit(void)
{
    unsigned long nr_pages;
    struct page *page;
        
    printk(KERN_ERR "%s\n", __func__);
    mutex_lock(&cmamem_dev.cmamem_lock);
    if(cmamem_status.status == HAVE_ALLOCED) {
        page = phys_to_page(cma_info.mem_base);         
        nr_pages = cma_info.len >> PAGE_SHIFT;
        dma_release_from_contiguous(NULL, page, nr_pages);
        memset(&cmamem_status, 0, sizeof(cmamem_status));
    }
    mutex_unlock(&cmamem_dev.cmamem_lock);
    misc_deregister(&cmamem_dev.dev);
}

module_init (cmamem_init);
module_exit (cmamem_exit);
MODULE_LICENSE("GPL");
{% endhighlight %}

Makefile

{% highlight ruby %}
obj-m += cma.o

KERNELDIR ?= /lib/modules/$(shell uname -r)/build

PWD       := $(shell pwd)

ROOT := $(dir $(M))
DEMOINCLUDE := -I$(ROOT)../include -I$(ROOT)/include

GCCVERSION = $(shell gcc -dumpversion | sed -e 's/\.\([0-9][0-9]\)/\1/g' -e 's/\.\([0-9]\)/0\1/g' -e 's/^[0-9]\{3,4\}$$/&00/')

GCC49 := $(shell expr $(GCCVERSION) \>= 40900)

all:
        $(MAKE) -C $(KERNELDIR) M=$(PWD) modules

install: all
        $(MAKE) -C $(KERNELDIR) M=$(PWD) modules_install
        depmod -a

clean:
        rm -rf *.o *.o.d *~ core .depend .*.cmd *.ko *.ko.unsigned *.mod.c .tmp_versions *.symvers \
        .cache.mk *.save *.bak Modules.* modules.order Module.markers *.bin

CFLAGS_cma.o := -Wall $(DEMOINCLUDE)

ifeq ($(GCC49),1)
        CFLAGS_cma.o += -Wno-error=date-time
endif

CFLAGS_cma.o := $(DEMOINCLUDE)
{% endhighlight %}

å¼€å‘è€…å¯ä»¥å°† CMA é©±åŠ¨æºæ–‡ä»¶åŠ å…¥åˆ°è‡ªå·±çš„é¡¹ç›®æºç ä¸­è¿›ç¨‹ç¼–è¯‘ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šè¿°çš„ 
Makefile è¿›è¡Œå¤–éƒ¨æ¨¡å—ç¼–è¯‘ã€‚

## <span id="CMA åœ¨ DTS ä¸­æè¿°">CMA åœ¨ DTS ä¸­æè¿°</span>

CMA åœ¨ DTS ä¸­çš„æè¿°æ˜¯å¯é€‰çš„ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥ä¸å¡«å†™ã€‚DTS ä¸­çš„ CMA æè¿°ç›¸å½“äºç»™ 
kernel ä¼ é€’ CMA çš„é…ç½®ä¿¡æ¯ï¼Œå†™æ³•å¦‚ä¸‹ï¼š

{% highlight ruby %}
reserved-memory {
    #address-cells = <0x1>;
    #size-cells = <0x1>;
    ranges;

    linux,cma {
        compatible = "shared-dma-pool";
        reusable;
        size = <0xc0000000>;
        alignment = <0x2000>;
        linux,cma-default;
    };
};
{% endhighlight %}

æ›´å¤š CMA åœ¨ DTS ä¸­æè¿°ï¼Œè¯·å‚è€ƒ 

> Documentation/devicetree/bindings/reserved-memory/reserved-memory.txt

## <span id="å†…æ ¸å®">å†…æ ¸å®</span>

ä¸ºäº†è¦åœ¨ Kernel ä¸­ä½¿ç”¨ CMAï¼Œéœ€è¦æ‰“å¼€å¦‚ä¸‹å®ï¼Œå¹¶æœªå…¨éƒ¨ç»™å…¨ï¼Œå¼€å‘è€…æ ¹æ®å®é™…å¼€å‘ç¯
å¢ƒè€Œå®šã€‚å¦‚ä¸‹ï¼š

{% highlight ruby %}
CONFIG_CMA=y
# CONFIG_CMA_DEBUG is not set
#
# Default contiguous memory area size:
#
CONFIG_CMA_SIZE_MBYTES=8
CONFIG_CMA_SIZE_SEL_MBYTES=y
# CONFIG_CMA_SIZE_SEL_PERCENTAGE is not set
# CONFIG_CMA_SIZE_SEL_MIN is not set
# CONFIG_CMA_SIZE_SEL_MAX is not set
CONFIG_CMA_ALIGNMENT=8
CONFIG_CMA_AREAS=15
# CONFIG_CMA_RESERVE_DEFAULT_AREA is not set
{% endhighlight %}

## <span id="CMA é…ç½®å‚æ•°">CMA é…ç½®å‚æ•°</span>

CMA åœ¨å†…æ ¸ä¸­ä½¿ç”¨çš„æœ€åä¸€æ­¥å°±æ˜¯é…ç½® CMA å¤§å°ï¼Œé…ç½®çš„æ–¹æ³•æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯ï¼š

> 1. [DTS ä¸­æŒ‡å®š CMA å¤§å°](#DTS æ–¹æ³•)
>
> 2. [cmdline ä¼ é€’ CMA å¤§å°](#cmdline æ–¹å¼)
>
> 3. [å†…æ ¸é…ç½®è®¾ç½® CMA å¤§å°](#å†…æ ¸é…ç½®æ–¹æ³•)


å…·ä½“å®ç°æ–¹æ³•å¦‚ä¸‹ï¼š

#### <span id="DTS æ–¹æ³•">DTS æ–¹æ³•</span>

DTS æ–¹å¼å¦‚ä¸‹ï¼š

{% highlight ruby %}
reserved-memory {
    #address-cells = <0x1>;
    #size-cells = <0x1>;
    ranges;

    linux,cma {
        compatible = "shared-dma-pool";
        reusable;
        size = <0xc0000000>;
        alignment = <0x2000>;
        linux,cma-default;
    };
};
{% endhighlight %}

å…¶ä¸­ size æŒ‡å®šäº† CMA çš„å¤§å°ï¼Œalignment æŒ‡å®šäº† CMA å¯¹å…¶æ–¹å¼ã€‚

#### <span id="cmdline æ–¹å¼">cmdline æ–¹å¼</span>

cmdline å¯ä»¥é€šè¿‡ uboot ä¼ é€’ä¹Ÿå¯ä»¥é€šè¿‡ DTS ä¼ é€’ï¼Œå…¶å¯¹ CMA çš„é…ç½®éƒ½ç›¸åŒï¼Œéƒ½æ˜¯æ·»
åŠ å¦‚ä¸‹é…ç½®ï¼š

{% highlight ruby %}
cmdline="... cma=125M"
{% endhighlight %}

å¦‚ä½•ä½¿ç”¨ DTS æ–¹å¼ä¼ é€’ cmdlineï¼Œå¯ä»¥æŒ‰å¦‚ä¸‹é…ç½®

{% highlight ruby %}
chosen {
    bootargs = "earlycon cma=256M";
};
{% endhighlight %}

#### <span id="å†…æ ¸é…ç½®æ–¹æ³•">å†…æ ¸é…ç½®æ–¹æ³•</span>

åœ¨å†…æ ¸é…ç½®ä¸­ï¼Œæ‰“å¼€  CONFIG_CMA_SIZE_MBYTES å®ï¼Œé…ç½®å¦‚ä¸‹ï¼š

{% highlight ruby %}
CONFIG_CMA_SIZE_MBYTES=125M
{% endhighlight %}

------------------------------------------

# <span id="ç”¨æˆ·ç©ºé—´ä½¿ç”¨ CMA å†…å­˜">ç”¨æˆ·ç©ºé—´ä½¿ç”¨ CMA</span>

æ ¹æ®éœ€æ±‚ï¼Œåº”ç”¨ç¨‹åºéœ€è¦è®¿é—® CMA å†…å­˜ï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š

{% highlight ruby %}
/*
* CMA application
*
* (C) 2018.11.29 BiscuitOS <buddy.zhang@aliyun.com>
*
* This program is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License version 2 as
* published by the Free Software Foundation.
*/
#include <stdio.h>
#include <stdarg.h>
#include <string.h>
#include <errno.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <time.h>
#include <sys/mman.h>
#include <unistd.h>
#include <sys/ioctl.h>

#define CMA_MEM_VERSION         3
#define CMEM_IOCTL_MAGIC        'm'
#define CMEM_ALLOCATE           _IOW(CMEM_IOCTL_MAGIC, 1, unsigned int)
#define CMEM_RELEASE            _IOW(CMEM_IOCTL_MAGIC, 2, unsigned int)
struct cmamem_info {
    unsigned int version;
    unsigned int len;
    unsigned int offset;
    unsigned int mem_base;
    unsigned int phy_base;
};
int main()
{
    int cmem_fd;
    void *cmem_base;
    unsigned int size;
    struct cmamem_info region;

    cmem_fd = open("/dev/cma_mem", O_RDWR, 0);
    if (cmem_fd < 0) {
        perror("Can't open /dev/CMA\n");
        return -1;
    }       
    memset(&region, 0x00, sizeof(struct cmamem_info));
    region.version = CMA_MEM_VERSION;
    region.len = 1 << 20;

    if (ioctl(cmem_fd, CMEM_ALLOCATE, &region) < 0) {    
        perror("PMEM_GET_TOTAL_SIZE failed\n");
        return -1;
    }
    size = region.len;
    cmem_base = mmap(0, size, PROT_READ | PROT_WRITE,
                                  MAP_SHARED, cmem_fd, region.phy_base);
    printf("CMA[%d] Phyaddress: %#08x Virtual base: %#08x "
           "Region.len: %#08x Offset: %#08x\n", i,
               (unsigned int)region.phy_base,
               (unsigned int)cmem_base,
               (unsigned int)region.len,
               (unsigned int)region.offset);
    if (cmem_base == MAP_FAILED) {
        cmem_base = 0;
        ioctl(cmem_fd, CMEM_RELEASE, &region)
        close(cmem_fd);
        cmem_fd = -1;
        perror("mmap pmem error!\n");
    }

    close(cmem_fd);
    return 0;
}
{% endhighlight %}

CMA åœ¨ç”¨æˆ·ç©ºé—´çš„è®¿é—®ä¾èµ–äº /dev/cma_mem èŠ‚ç‚¹ï¼Œå¦‚æœå¼€å‘è€…å‘ç°æ²¡æœ‰è¿™ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥
åœ¨å†…æ ¸ä¸­åŠ å…¥ä¸Šä¸€èŠ‚ä¸­æåˆ°çš„é©±åŠ¨ï¼Œç„¶å /dev/CMA èŠ‚ç‚¹å°±å¯ä»¥ä½¿ç”¨ CMA å†…å­˜äº†ã€‚

------------------------------------------------------

# <span id="è¶…å¤§ CMA å†…å­˜è®¾ç½®æ–¹æ³•">è¶…å¤§ CMA å†…å­˜åˆ†é…</span>

åœ¨æœ‰äº›åº”ç”¨åœºæ™¯ï¼Œéœ€è¦åˆ†é…è¶…çº§å¤§çš„ CMA å†…å­˜ï¼Œæ¯”å¦‚ 1Gï¼Œ2G æˆ–è€… 3Gã€‚å¯¹äºè¿™æ ·çš„é—®
é¢˜ï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒæœ¬æ–‡è¿›è¡Œè¶…çº§å¤§çš„ CMA å†…å­˜åˆ†é…ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä½“ç³»çš„å†…å­˜åˆ†é…è¿›è¡Œåˆ†æï¼Œæœ¬ä¾‹å­ä¸­ä½¿ç”¨ ARM64 å’Œ 4G ç‰©ç†å†…å­˜ã€‚åœ¨
è¿è¡Œçš„ Linux ä¸­ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å†…å­˜å¸ƒå±€ï¼Œå¦‚ä¸‹å›¾ï¼š

![Menuconfig1](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/DEV000055.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒARM64  RAM çš„ç‰©ç†å†…å­˜è¢«åˆ†ä½œäº†ä¸¤æ®µï¼ŒèŒƒå›´å¦‚ä¸‹ï¼š

{% highlight ruby %}
0x00000000 -- 0x7fefffff : System RAM
0x800000000 -- 0x87fffffff : System RAM
{% endhighlight %}

ç¬¬ä¸€æ®µ System RAM ä¸­åŒ…å«äº†å†…æ ¸çš„ä»£ç å’Œå†…æ ¸æ•°æ®ï¼Œç¬¬äºŒæ®µ System RAM ä¾›ç³»ç»Ÿè¿è¡Œæ—¶
ä½¿ç”¨ã€‚æ ¹æ® CMA åˆ†é…ç­–ç•¥å¯çŸ¥ï¼ŒCMA ä¼šä»ç¬¬ä¸€å—å¯ç”¨ç‰©ç†å†…å­˜çš„é¡¶ç«¯å¼€å§‹å‘ä¸‹åˆ†é…è¿ç»­
çš„ç‰©ç†å†…å­˜ç»™ CMAã€‚å› æ­¤è¯¥ç‰©ç†å†…å­˜å¸ƒå±€çš„æƒ…å†µä¸‹ï¼Œæœ€å¤§ CMA ä¸è¶…è¿‡ 1800Mã€‚ä½¿ç”¨å‘½ä»¤
æŸ¥çœ‹å½“å‰ CMA çš„æƒ…å†µï¼ˆæœ¬ä¾‹ä¸­é»˜è®¤è®¾ç½® CMA å¤§å°ä¸º 1700Mï¼‰ï¼Œå¦‚ä¸‹ï¼š

![Menuconfig1](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/DEV000056.png)

é€šè¿‡ä¸Šé¢è¿è¡Œçš„æ•°æ®å¯çŸ¥ï¼ŒCMA çš„ä½“ç§¯æ˜¯ 1740800 KB, ä¹Ÿå°±æ˜¯ 1700Mã€‚å¦‚æœåœ¨è¿™ä¸ªç‰©ç†
å†…å­˜å¸ƒå±€ä¸‹å†å¢å¤§ CMA çš„ä½“ç§¯ï¼Œå°†ä¼šå¼•èµ·å†…æ ¸ panicã€‚

## è§£å†³æ–¹æ¡ˆ

é€šè¿‡ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œå¦‚æœè¦å¢å¤§ CMA çš„ä½“ç§¯ï¼Œå…³é”®æ˜¯è¦è®©ç¬¬ä¸€å—å¯ç”¨ç‰©ç†å†…å­˜çš„ä½“ç§¯
å°½é‡å¤§ï¼Œæ‰€ä»¥è§£å†³æ–¹æ¡ˆå›´ç»•å¦‚ä½•å¢å¤§ç¬¬ä¸€å—ç‰©ç†å†…å­˜ä½“ç§¯æ¥è§£å†³ã€‚ç¬¬ä¸€å—å¯ç”¨è¿ç»­ç‰©ç†å†…
å­˜å¤§å°é…ç½®åœ¨ DTS ä¸­è¿›è¡Œé…ç½®ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹æè¿°è¿›è¡Œé…ç½®ï¼š

{% highlight ruby %}
memory {
    device-type = "memory";
    reg = <0x0 0x0 0x0 0x7ff00000 0x8 0x0 0x0 0x80000000>;
};
{% endhighlight %}

ä¸Šé¢çš„ DTS æè¿°ç”¨äºé…ç½®ç‰©ç†å†…å­˜çš„å¸ƒå±€ï¼Œå…¶ä¸­ reg æè¿°åŒ…å«ä¸¤ä¸ª cellsï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ª
æ•°å€¼è¡¨ç¤ºä¸€ä¸ª cellsï¼Œå¹¶ä¸” reg çš„ç¬¬ä¸€ä¸ª cells è¡¨ç¤ºç‰©ç†å†…å­˜çš„åŸºåœ°å€ï¼Œç¬¬äºŒä¸ª 
cells è¡¨ç¤ºç‰©ç†å†…å­˜çš„å¤§å°ã€‚å¦‚ä¸Šè¿°ï¼Œ reg æ€»å…±æè¿°äº†ä¸¤å—ç‰©ç†å†…å­˜ï¼Œç¬¬ä¸€å—ç‰©ç†å†…å­˜
çš„åŸºåœ°å€ç”±ç¬¬ä¸€ä¸ª cells è¡¨ç¤ºï¼Œå…¶å€¼ä¸º  <0x0 0x0>, è¡¨ç¤ºç¬¬ä¸€å—ç‰©ç†å†…å­˜çš„èµ·å§‹åœ°å€
æ˜¯ 0x0000 0000 0000 0000ï¼› ç¬¬ä¸€å—ç‰©ç†å†…å­˜çš„å¤§å°ç”±ç¬¬äºŒä¸ª cells è¡¨ç¤ºï¼Œå…¶å€¼
ä¸º <0x0 0x7ff00000>, è¡¨ç¤ºç¬¬ä¸€å—ç‰©ç†å†…å­˜çš„å¤§å°æ˜¯ 0x0000 0000 7ff0 0000; ç¬¬äºŒå—
ç‰©ç†å†…å­˜çš„åŸºåœ°å€ç”±ç¬¬ä¸‰ä¸ª cells è¡¨ç¤ºï¼Œå…¶å€¼ä¸º <0x8 0x0>, è¡¨ç¤ºç¬¬äºŒå—ç‰©ç†å†…å­˜çš„èµ·
å§‹åœ°å€æ˜¯ 0x0000 0008 0000 0000; ç¬¬äºŒå—ç‰©ç†å†…å­˜çš„å¤§å°ç”±ç¬¬å››ä¸ª cells è¡¨ç¤ºï¼Œå…¶å€¼
ä¸º <0x0 0x80000000>, è¡¨ç¤ºç¬¬äºŒå—ç‰©ç†å†…å­˜çš„å¤§å°æ˜¯ 0x0000 0000 8000 0000.

é€šè¿‡ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œå¼€å‘è€…åªè¦å°† reg çš„å€¼è®¾ç½®æˆä¸€ä¸ªåˆé€‚çš„å€¼å³å¯ï¼Œé€šè¿‡ 
cat /proc/iomem å‘½ä»¤å¯çŸ¥ï¼Œ0xfd3d0000 ç‰©ç†åœ°å€å¼€å§‹çš„åœ°æ–¹åˆ†ç»™äº†ç‰¹å®šçš„ IO ä½¿ç”¨ï¼Œ
æ‰€ä»¥ä¹Ÿå°±æ„å‘³ç€ç¬¬ä¸€å—è¿ç»­ç‰©ç†å†…å­˜çš„åœ°å€æœ€å¤§åˆ° 0xFD3D0000ã€‚é€šè¿‡åˆ†æï¼Œå¼€å‘è€…å¯ä»¥
ç¬¬ä¸€å—ç‰©ç†å†…å­˜çš„åœ°å€æ¥è¿‘äº 0xFD3D0000, ä½†ä¸è¦æ¥åœ¨ä¸€èµ·ã€‚è®¾ç½®å¦‚ä¸‹ï¼š

> ç¬¬ä¸€å—ç‰©ç†å†…å­˜èµ·å§‹åœ°å€ä¸º 0x00000000ï¼Œ å¤§å°ä¸º 0xF0000000
>
> ç¬¬äºŒå—ç‰©ç†å†…å­˜èµ·å§‹åœ°å€ä¸º 0x800000000, å¤§å°ä¸º 0x10000000


æ‰€ä»¥ DTS å¦‚ä¸‹ï¼š

{% highlight ruby %}
memory {
    device-type = "memory";
    reg = <0x0 0x0 0x0 0xf0000000 0x8 0x0 0x0 0x10000000>;
};
{% endhighlight %}

æ¥ç€å°† CMA é…ç½®ä¸º 3000Mï¼Œå¼€å‘è€…å¯ä»¥å‚è€ƒ **CMA é…ç½®å‚æ•°** ä¸€èŠ‚

{% highlight ruby %}
chosen {
    bootargs = "earlycon cma=3000M";
};
{% endhighlight %}

æœ€åé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œç³»ç»Ÿå¯åŠ¨åï¼ŒCMA åˆå§‹åŒ–ä¿¡æ¯å¦‚ä¸‹ï¼š

![Menuconfig1](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/DEV000060.png)

è¿è¡Œ cat /proc/iomem å’Œ cat /proc/meminfo å‘½ä»¤æŸ¥çœ‹ CMA å†…å®¹ï¼Œå¦‚ä¸‹ï¼š

![Menuconfig1](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/DEV000057.png)

é€šè¿‡ä¸Šé¢çš„æ•°æ®å¯çŸ¥ï¼Œç¬¬ä¸€å—ç‰©ç†å†…å­˜çš„èµ·å§‹åœ°å€ä¸º 0x00000000, å¤§å°ä¸º 0xF0000000ã€‚
ç¬¬äºŒå—ç‰©ç†å†…å­˜çš„èµ·å§‹åœ°å€ä¸º 0x800000000, å¤§å°ä¸º 0x1000000ã€‚

![Menuconfig1](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/DEV000058.png)

é€šè¿‡è¿è¡Œå†…å­˜çš„æŸ¥çœ‹ï¼ŒCMA å†…å­˜æ€»å…± 3072000 KB, å³ 3000Mã€‚

ç”±æ­¤å¯ä»¥çœ‹å‡ºä¿®æ”¹åº”è¯¥æ­£ç¡®ï¼Œæ¥ä¸‹æ¥å¼€å‘è€…å¯ä»¥ä½¿ç”¨æµ‹è¯•è½¯ä»¶ï¼Œå®é™…æµ‹è¯• CMA å†…å­˜æ˜¯å¦
çœŸå®å¯ç”¨ã€‚æµ‹è¯•è½¯ä»¶çš„é€»è¾‘æ˜¯å¾ªç¯ä» CMA ä¸­ç”³è¯· 1M å¤§å°çš„ CMA å†…å­˜ï¼Œçœ‹èƒ½å¦çœŸå®ç”³è¯·
åˆ° 3000M CMA å†…å­˜ã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

{% highlight ruby %}
/*
* Request all CMA and doesn't release.
*
* (C) 2018.11.29 BiscuitOS <buddy.zhang@aliyun.com>
*
* This program is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License version 2 as
* published by the Free Software Foundation.
*/
#include <stdio.h>
#include <stdarg.h>
#include <string.h>
#include <errno.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <time.h>
#include <sys/mman.h>
#include <unistd.h>
#include <sys/ioctl.h>

#define CMA_MEM_VERSION         3
#define CMEM_IOCTL_MAGIC        'm'
#define CMEM_ALLOCATE           _IOW(CMEM_IOCTL_MAGIC, 1, unsigned int)
#define CMEM_RELEASE            _IOW(CMEM_IOCTL_MAGIC, 2, unsigned int)
struct cmamem_info {
    unsigned int version;
    unsigned int len;
    unsigned int offset;
    unsigned int mem_base;
    unsigned int phy_base;
};
int main()
{
    int cmem_fd;
    void *cmem_base;
    unsigned int size;
    struct cmamem_info region;
    int i;

    cmem_fd = open("/dev/cma_mem", O_RDWR, 0);
    if (cmem_fd < 0) {
        perror("Can't open /dev/CMA\n");
        return -1;
    }       
    for (i = 0; i > -1; i++) {
        memset(&region, 0x00, sizeof(struct cmamem_info));
        region.version = CMA_MEM_VERSION;
        region.len = 1 << 20;

        if (ioctl(cmem_fd, CMEM_ALLOCATE, &region) < 0) {        
            perror("PMEM_GET_TOTAL_SIZE failed\n");
            return -1;
        }
        size = region.len;
        cmem_base = mmap(0, size, PROT_READ | PROT_WRITE,
                                      MAP_SHARED, cmem_fd, region.phy_base);
        printf("CMA[%d] Phyaddress: %#08x Virtual base: %#08x "
               "Region.len: %#08x Offset: %#08x\n", i,
                   (unsigned int)region.phy_base,
                   (unsigned int)cmem_base,
                   (unsigned int)region.len,
                   (unsigned int)region.offset);
        if (cmem_base == MAP_FAILED) {
            cmem_base = 0;
            close(cmem_fd);
            cmem_fd = -1;
            perror("mmap pmem error!\n");
        }

    }
                
    close(cmem_fd);
    return 0;
}
{% endhighlight %}

æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

![Menuconfig1](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/DEV000059.png)

é€šè¿‡ä¸Šé¢æµ‹è¯•ï¼Œå®é™…çœŸå®èƒ½åˆ†é…åˆ° 3000 M CMA å†…å­˜ï¼Œæ‰€ä»¥è¿™æ ·ä¿®æ”¹æ˜¯å¯è¡Œçš„ã€‚

---------------------------------------------------

# <span id="é™„å½•">é™„å½•</span>

> [CMA è¯¦ç»†åˆ†æ](https://blog.csdn.net/pillarbuaa/article/details/79206053)
>
> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](https://biscuitos.github.io/blog/Kernel_Build/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](https://raw.githubusercontent.com/EmulateSpace/PictureSet/master/BiscuitOS/kernel/HAB000036.jpg)
