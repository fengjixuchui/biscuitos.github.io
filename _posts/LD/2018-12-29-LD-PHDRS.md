---
layout: post
title:  "PHDRS"
date:   2018-12-29 16:52:30 +0800
categories: [MMU]
excerpt: LD scripts key PHDRS.
tags:
  - Linker
---

# PHDRS

{% highlight ruby %}
PHDRS {
    NAME TYPE [FILEHDR][PHDRS][AT(ADDRESS)]
    [FLAGS(FLAGS)]
}
{% endhighlight %}

PHDRS å‘½ä»¤ä»…ä»…åœ¨ç”Ÿæˆ ELF ç›®æ ‡æ–‡ä»¶æ—¶æœ‰æ•ˆã€‚ELF ç›®æ ‡æ–‡ä»¶æ ¼å¼ç”¨ program headers ç¨‹
åºå¤´ (ç¨‹åºå¤´å†…åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª segment ç¨‹åºæ®µæè¿°) æ¥æè¿°ç¨‹åºå¦‚ä½•è¢«è½½å…¥å†…å­˜ã€‚å¯
ä»¥ä½¿ç”¨ objdump -p å‘½ä»¤æŸ¥çœ‹ã€‚

å½“æ“ä½œç³»ç»Ÿæ‰§è¡Œ ELF ç›®æ ‡æ–‡ä»¶æ ¼å¼çš„ç¨‹åºæ—¶ï¼Œç³»ç»ŸåŠ è½½å™¨é€šè¿‡è¯»å–ç¨‹åºå¤´ä¿¡æ¯ä»¥é€šçŸ¥å¦‚
ä½•å°†ç¨‹åºåŠ è½½åˆ°å†…å­˜ã€‚åœ¨é“¾æ¥è„šæœ¬å†…ä¸æŒ‡å®š PHDRS å‘½ä»¤æ—¶ï¼Œé“¾æ¥å™¨èƒ½å¤Ÿå¾ˆå¥½çš„åˆ›å»ºç¨‹åº
å¤´ï¼Œä½†æ˜¯æœ‰æ—¶éœ€è¦æ›´ç²¾ç¡®çš„æè¿°ç¨‹åºå¤´ï¼Œé‚£ä¹ˆ PHDRS å‘½ä»¤å°±å¯ä»¥æ´¾ä¸Šç”¨åœºã€‚æ³¨æ„ï¼Œä¸€ä½†
åœ¨é“¾æ¥è„šæœ¬å†…ä½¿ç”¨äº† PHDRS å‘½ä»¤ï¼Œé‚£ä¹ˆé“¾æ¥å™¨ä»…ä»…ä¼šåˆ›å»º PHDRS å‘½ä»¤æŒ‡å®šçš„ä¿¡æ¯ï¼Œæ‰€ä»¥
ä½¿ç”¨æ—¶é¡»è°¨æ…ã€‚

#### FILEHDR, PHDRS, AT, FLAGS ä¸ºå…³é”®å­—

#### NAME

ç¨‹åºæ®µåï¼Œæ­¤åå­—å¯ä»¥ä¸ç¬¦å·åï¼Œsection åï¼Œæ–‡ä»¶åé‡å¤ï¼Œå› æ­¤å®ƒåœ¨ä¸€ä¸ªç‹¬ç«‹çš„åå­—ç©º
é—´å†…ã€‚æ­¤åå­—åªèƒ½åœ¨ SECTIONS å‘½ä»¤å†…ä½¿ç”¨ã€‚ä¸€ä¸ªç¨‹åºæ®µå¯ä»¥ç”±å¤šä¸ªå¯åŠ è½½çš„ section 
ç»„æˆã€‚é€šè¿‡è¾“å‡º section æè¿°æ®µçš„å±æ€§ PHDRS å¯ä»¥å°†è¾“å‡º section åŠ å…¥ä¸€ä¸ªç¨‹åºæ®µè¿™
é‡ŒæŒ‡çš„æ˜¯ PHDRS ä¸­çš„ PHDRSï¼Œ PHDRS ä¸ºæ®µåã€‚åœ¨ä¸€ä¸ªè¾“å‡º section æè¿°å†…å¯ä»¥å¤šæ¬¡ä½¿
ç”¨ PHDRS å‘½ä»¤ï¼Œä¹Ÿæ—¢å¯ä»¥å°†ä¸€ä¸ª section åŠ å…¥åˆ°å¤šä¸ªç¨‹åºæ®µã€‚å¦‚æœåœ¨ä¸€ä¸ªè¾“å‡º 
section æè¿°å†…æŒ‡å®šäº† PHDRS å±æ€§ï¼Œé‚£ä¹ˆå…¶åçš„è¾“å‡º section æè¿°å°†é»˜è®¤ä½¿ç”¨è¯¥å±æ€§ï¼Œ
é™¤éå®ƒä¹Ÿå®šä¹‰äº† PHDRS å±æ€§ã€‚å½“ç„¶å½“å¤šä¸ªè¾“å‡º section å±äºåŒä¸€ç¨‹åºæ®µæ—¶å¯ä»¥ç®€åŒ–ä¹¦å†™ã€‚

#### TYPE

åœ¨ TYPE å±æ€§åå­˜åœ¨ FILEHDR å…³é”®å­—ï¼Œè¡¨ç¤ºè¯¥æ®µåŒ…å« ELF å¤´ä¿¡æ¯ã€‚TYPE å¯ä»¥ä½¿ä¸€ä¸‹å…«
ç§å½¢å¼ï¼š
    
> 1. PT_NULL  0
> 
>    è¡¨ç¤ºæœªè¢«ä½¿ç”¨çš„ç¨‹åºæ®µã€‚
>
> 2. PT_LOAD 1
>
>    è¡¨ç¤ºè¯¥ç¨‹åºæ®µåœ¨ç¨‹åºè¿è¡Œæ—¶åº”è¯¥è¢«åŠ è½½
>
> 3. PT_DYNAMIC 2
>
>    è¡¨ç¤ºè¯¥ç¨‹åºæ®µåŒ…å«åŠ¨æ€é“¾æ¥ä¿¡æ¯
>
> 4. PT_INTERP 3
>
>    è¡¨ç¤ºè¯¥ç¨‹åºæ®µå†…åŒ…å«ç¨‹åºåŠ è½½å™¨çš„åå­—ï¼Œåœ¨ linux ä¸‹å¸¸è§çš„ç¨‹åºåŠ è½½å™¨æ˜¯ 
>    ld-linux.so.2
>
> 5. PT_NOTE 4
>
>    è¡¨ç¤ºè¯¥ç¨‹åºæ®µå†…åŒ…å«äº†ç¨‹åºçš„è¯´æ˜ä¿¡æ¯
>
> 6. PT_SHLIB 5
>
>    ä¸€ä¸ªä¿ç•™çš„ç¨‹åºå¤´ç±»å‹ï¼Œæ²¡æœ‰åœ¨ ELF ABI æ–‡æ¡£å†…å®šä¹‰ã€‚
>
> 7. PT_PHDR 6
>
>    è¡¨ç¤ºè¯¥ç¨‹åºæ®µåŒ…å«ç¨‹åºå¤´ä¿¡æ¯

#### EXPRESSION è¡¨è¾¾å¼å€¼

ä»¥ä¸Šæ¯ä¸ªç±»å‹å¯¹åº”ä¸€ä¸ªæ•°å­—ï¼Œè¯¥è¡¨è¾¾å¼å®šä¹‰ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„ç¨‹åºå¤´ã€‚

#### AT(ADDRESS)

AT(ADDRESS) å±æ€§å®šä¹‰è¯¥ç¨‹åºæ®µçš„åŠ è½½ä½ç½® (LMA). è¯¥å±æ€§å°†è¦†ç›–è¯¥ç¨‹åºæ®µå†…çš„ 
section çš„ AT() å±æ€§ã€‚

#### FLAGS 

é»˜è®¤æƒ…å†µä¸‹ï¼Œé“¾æ¥å™¨ä¼šæ ¹æ®è¯¥ç¨‹åºæ®µåŒ…å«çš„ section çš„å±æ€§è®¾ç½® FLAGS æ ‡å¿—ï¼Œè¯¥æ ‡å¿—
ç”¨äºè®¾ç½®ç¨‹åºæ®µæè¿°çš„ p_flags åŸŸã€‚

ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

{% highlight ruby %}
PHDRS
{
    headers PT_PHDR PHDRS;
    interp PT_INTERP;
    text PT_LOAD FILEHDR PHDRS;
    data PT_LOAD;
    dynamic PT_DYNAMIC;
}

SECTIONS
{
    . = 0x8048000 + SIZEOF_HEADERS;
    .interp : { *(.interp) } : text : interp
    .text { *(.text) } :text
   .rodata : { *(.rodata) } /* Defaults to .text */

    ....

    . = . + 0x1000;  /* mov to a new page in memory */
    .data : { *(.data) } :data
    .dynamic : { *(.dynamic) } :data : dynamic

    ....
}
{% endhighlight %}

PHDRS ä¸ SECTIONS ä¹‹é—´çš„å±‚çº§å…³ç³»ï¼š

{% highlight ruby %}
PHDRS
{
    NAME TYPE [FILEHDR][PHDRS][AT(ADDRESS)][FLAGS(FLAGS)]
}

SECTIONS
{
    SECTION [ADDRESS][(TYPE)]:[AT(LMA)] {
        OUTPUT-SECTION-COMMAND
        OUTPUT-SECTION-COMMAND
    } [>REGION][AT>LMA_REGION][:PHDR HDR ...][=FILEEXP]
}
{% endhighlight %}

**e.g.** ä¸‰ä¸ªæºæ–‡ä»¶ DemoA.cï¼ŒDemoB.c å’Œ DemoC.cï¼Œå…¶ä¸­ DemoA.c å¼•ç”¨ DemoA.c å’Œ
DemoB.c é‡Œé¢çš„å‡½æ•°ï¼Œä½¿ç”¨ GCC ç”Ÿæˆç‹¬ç«‹çš„ç›®æ ‡æ–‡ä»¶ DemoA.oï¼ŒDemoB.o å’Œ DemoC.oã€‚
ld ä½¿ç”¨é“¾æ¥è„šæœ¬ Demo.lds, å¹¶ä¸”åœ¨ Demo.lds é‡Œé¢é€šè¿‡ PHDRS å…³é”®å­—ï¼Œä»¥æ­¤æ¥åˆ›å»ºè¾“
å‡ºæ–‡ä»¶çš„ ELF HEADERSï¼š

DemoA.c

{% highlight ruby %}
extern void print();
extern void exit();

void nomain()
{
    print();
    exit();
}
{% endhighlight %}

DemoB.c

{% highlight ruby %}
char *str = "Hello World\n";

void print()
{
    __asm__ ("movl $13, %%edx\n\t"
             "movl %0, %%ecx\n\t"
             "movl $0, %%ebx\n\t"
             "movl $4, %%eax\n\r"
             "int $0x80\n\t"
             :: "r" (str) : "edx", "ecx", "ebx");
}
{% endhighlight %}

DemoC.c

{% highlight ruby %}
void exit()
{
    __asm__ ("movl $42, %ebx\n\t"
             "movl $1, %eax\n\t"
             "int $0x80\n\t");
}
{% endhighlight %}

Demo.lds 

{% highlight ruby %}
ENTRY(nomain)

INPUT(DemoA.o)
INPUT(DemoB.o)
INPUT(DemoC.o)

PHDRS
{
    headers PT_PHDR PHDRS;
    interp PT_INTERP;
    text PT_LOAD FILEHDR PHDRS;
    data PT_LOAD;
    dynamic PT_DYNAMIC;
}

SECTIONS
{
    . = 0x08048000 + SIZEOF_HEADERS;

    DemoIntR : { *(.interp) } :text :interp
    DemoText : { *(.text) } :text
    DemoRD : { *(.rodata) }

    . = . + 0x1000;

    DemoData : { *(.data) } :data
    DemoDyna : { *(.dynamic) } :data :dynamic

    /DISCARD/ : { *(.comment) }
}
{% endhighlight %}

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘å’Œé“¾æ¥ï¼š

{% highlight ruby %}
gcc DemoA.c -c
gcc DemoB.c -c
gcc DemoC.c -c -fno-builtin
ld -static -T Demo.lds -o a.out
objdump -xSsdh a.out
{% endhighlight %}

![LD](/assets/PDB/BiscuitOS/kernel/MMU000521.png)

é€šè¿‡ä¸Šé¢çš„è¿è¡Œæ•°æ®å¯çŸ¥ï¼Œè¾“å‡º ELF æ–‡ä»¶çš„ Program Header åŒºåŸŸå·²ç»æ·»åŠ äº†æŒ‡å®šçš„ 
HEADER ä¿¡æ¯ã€‚

-----------------------------------------------

# <span id="é™„å½•">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](/blog/Kernel_Build/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](/assets/PDB/BiscuitOS/kernel/HAB000036.jpg)
