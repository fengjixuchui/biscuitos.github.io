---
layout: post
title:  "KEEP"
date:   2018-12-29 15:57:30 +0800
categories: [MMU]
excerpt: LD scripts key KEEP.
tags:
  - Linker
---

# KEEP

{% highlight ruby %}
KEEP(expr ...)
{% endhighlight %}

e.g. ä¸‰ä¸ªæºæ–‡ä»¶ DemoA.cï¼ŒDemoB.c å’Œ DemoC.cï¼Œå…¶ä¸­ DemoA.c å¼•ç”¨ DemoA.c å’Œ 
DemoB.c é‡Œé¢çš„å‡½æ•°ï¼Œä½¿ç”¨ GCC ç”Ÿæˆç‹¬ç«‹çš„ç›®æ ‡æ–‡ä»¶ DemoA.oï¼ŒDemoB.o å’Œ DemoC.oã€‚
ld ä½¿ç”¨é“¾æ¥è„šæœ¬ Demo.lds, å¹¶ä¸”åœ¨ Demo.lds é‡Œé¢é€šè¿‡ KEEP å…³é”®å­—ä¿å­˜ .comment 
sectionï¼Œld å‘½ä»¤è¡Œä¸­æ·»åŠ  --gc-sections é€‰é¡¹ï¼š

DemoA.c

{% highlight ruby %}
extern void print();
extern void exit();

void nomain()
{
    print();
    exit();
}
{% endhighlight %}

DemoB.c

{% highlight ruby %}
char *str = "Hello World\n";

void print()
{
    __asm__ ("movl $13, %%edx\n\t"
             "movl %0, %%ecx\n\t"
             "movl $0, %%ebx\n\t"
             "movl $4, %%eax\n\r"
             "int $0x80\n\t"
             :: "r" (str) : "edx", "ecx", "ebx");
}
{% endhighlight %}

DemoC.c

{% highlight ruby %}
void exit()
{
    __asm__ ("movl $42, %ebx\n\t"
             "movl $1, %eax\n\t"
             "int $0x80\n\t");
}
{% endhighlight %}

Demo.lds ä¸ä½¿ç”¨ KEEP å…³é”®å­—

{% highlight ruby %}
ENTRY(nomain)

SECTIONS
{
    . = 0x08048000 + SIZEOF_HEADERS;

    DemoText ï¼š { *(.text) *(.data) *(.rodata) }

    /DISCARD/ : { *(.comment) }
}
{% endhighlight %}

DemoC.lds ä¸­ä½¿ç”¨ KEEP å…³é”®å­—

{% highlight ruby %}
ENTRY(nomain)

SECTIONS
{
    . = 0x08048000 + SIZEOF_HEADERS;

    DemoText ï¼š { *(.text) *(.data) *(.rodata) }

    DemoComment ï¼š { KEEP(*(.eh_frame)) }

    /DISCARD/ : { *(.comment) }

}
{% endhighlight %}

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘å’Œé“¾æ¥ï¼š

{% highlight ruby %}
gcc DemoA.c -c
gcc DemoB.c -c
gcc DemoC.c -c -fno-builtin
ld -static -T Demo.lds DemoA.o DemoB.o DemoC.c -o a.out --gc-sections -M
{% endhighlight %}

![LD](/assets/PDB/BiscuitOS/kernel/MMU000510.png)

å¦‚ä¸Šå›¾æ•°æ®ï¼Œé€šè¿‡ä½¿ç”¨ Demo.lds è„šæœ¬è¿›è¡Œé“¾æ¥ï¼Œå¹¶ä¸” ld ä½¿ç”¨äº† --gc-sections å‘½ä»¤
ä¹‹åï¼Œç”Ÿæˆçš„ a.out å¯æ‰§è¡Œæ–‡ä»¶ä¸­å¹¶æœªåŒ…å« .eh_frame sectionã€‚ç„¶åï¼Œåœ¨é“¾æ¥è„šæœ¬ 
DemoC.lds ä¸­ä½¿ç”¨ KEEP å…³é”®å­—å°† .eh_frame ä½œä¸ºä¿ç•™ sectionï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![LD](/assets/PDB/BiscuitOS/kernel/MMU000511.png)

é€šè¿‡ä¸Šé¢çš„æ•°æ®å¯çŸ¥ï¼Œè¾“å‡ºæ–‡ä»¶ a.out çš„ Demoelf section åŒ…å«äº†æ‰€æœ‰ .eh_frame 
sectionsã€‚

é€šè¿‡å®è·µéªŒè¯ä¹‹åï¼Œ KEEP å…³é”®å¯ä»¥ä¿ç•™ section åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ã€‚

-----------------------------------------------

# <span id="é™„å½•">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](/blog/Kernel_Build/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](/assets/PDB/BiscuitOS/kernel/HAB000036.jpg)
