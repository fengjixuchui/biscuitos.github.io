---
layout: post
title:  "MEMORY"
date:   2018-12-29 16:38:30 +0800
categories: [MMU]
excerpt: LD scripts key MEMORY.
tags:
  - Linker
---

# MEMORY

{% highlight ruby %}
MEMORY {
    NAME1 [(ATTR)] : ORIGIN = ORIGIN1, LENGTH = LEN2
    NAME2 [(ATTR)] : ORIGIN = ORIGIN2, LENGTH = LEN2
    ...
}
{% endhighlight %}

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œé“¾æ¥å™¨å¯ä»¥ä¸º section åˆ†é…ä»»æ„ä½ç½®çš„å­˜å‚¨åŒºåŸŸï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ MEMORY 
å‘½ä»¤å®šä¹‰å­˜å‚¨åŒºåŸŸï¼Œå¹¶é€šè¿‡è¾“å‡º section æè¿°çš„ [AT > REGION] å±æ€§æ˜¾ç¤ºåœ°è¯¥è¾“å‡º 
section é™å®šäºæŸå—å­˜å‚¨åŒºåŸŸï¼Œå½“å­˜å‚¨åŒºåŸŸå¤§å°ä¸èƒ½æ»¡è¶³è¦æ±‚æ—¶ï¼Œé“¾æ¥å™¨ä¼šæŠ¥é”™ã€‚

#### NAME

å­˜å‚¨åŒºåŸŸçš„åå­—ï¼Œè¿™ä¸ªåå­—å¯ä»¥ä¸ç¬¦å·åï¼Œæ–‡ä»¶åï¼Œsection åé‡å¤ï¼Œå› ä¸ºå®ƒå¤„äºä¸€ä¸ªç‹¬
ç«‹çš„åå­—ç©ºé—´å†…ã€‚

#### ATTR

å®šä¹‰è¯¥å­˜å‚¨åŒºåŸŸçš„å±æ€§ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“æŸä¸ªè¾“å‡º section æ²¡æœ‰åœ¨ SECTIONS å‘½ä»¤å†…
è¢«å¼•ç”¨æ˜¯ï¼Œé“¾æ¥å™¨ä¼šæŠŠè¯¥è¾“å‡º setion ç›´æ¥æ‹·è´æˆè¾“å‡º sectionï¼Œç„¶åå°†è¯¥è¾“å‡º 
section æ”¾å…¥å†…å­˜åŒºåŸŸå†…ã€‚å¦‚æœå†…å­˜è®¾ç½®äº† ATTR å±æ€§ï¼Œé‚£ä¹ˆè¯¥åŒºåŸŸåªæ¥æ”¶æ»¡è¶³è¯¥å±æ€§çš„ 
sectionã€‚ATTR å±æ€§å†…å¯ä»¥å‡ºç°ä¸ƒä¸ªå­—ç¬¦ï¼š

> 1. R åªè¯» section
>
> 2. W è¯»/å†™ section
>
> 3. X å¯æ‰§è¡Œ section
>
> 4. A å¯åˆ†é…çš„ section
>
> 5. I åˆå§‹åŒ–çš„ section
>
> 6. L åˆå§‹åŒ–çš„ section
>
> 7. ï¼ä¸èƒ½æ»¡è¶³è¯¥å­—ç¬¦ä¹‹åçš„ä»»ä½•ä¸€ä¸ªå±æ€§çš„ section

#### ORIGIN

å…³é”®å­—ï¼ŒåŒºåŸŸçš„å¼€å§‹åœ°å€ï¼Œå¯ä»¥ç®€å†™æˆ org æˆ– o

#### LENGTH

å…³é”®å­—ï¼ŒåŒºåŸŸçš„å¤§å°ï¼Œå¯ç®€å†™æˆ len æˆ–è€… l

ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

{% highlight ruby %}
MEMORY
{
    rom (rx) : ORIGIN = 0, LENGTH = 256K
    ram(!rx) : org = 0x40000000, l = 4M
}
{% endhighlight %}

MEMORY ä¸ SECTIONS çš„å±‚çº§å…³ç³»ï¼š

{% highlight ruby %}
MEMORY { ... }
SECTIONS { ... }
{% endhighlight %}

æ­¤ä¾‹å­ä¸­ï¼ŒæŠŠ SECTIONS å‘½ä»¤å†…æœªå¼•ç”¨çš„ä¸”å…·æœ‰è¯»å±æ€§æˆ–è€…å†™å±æ€§çš„è¾“å…¥ section æ”¾å…¥
rom åŒºåŸŸå†…ï¼ŒæŠŠå…¶ä»–æœªå¼•ç”¨çš„è¾“å…¥ section æ”¾å…¥ ram. å¦‚æœæŸäº›è¾“å‡º section è¦è¢«æ”¾å…¥
æŸå†…å­˜åŒºåŸŸå†…ï¼Œè€Œè¯¥è¾“å‡º section åˆæ²¡æœ‰æŒ‡æ˜ ADDRESS å±æ€§ï¼Œé‚£ä¹ˆé“¾æ¥å™¨å°†è¯¥è¾“å‡º 
section æ”¾åœ¨åŒºåŸŸå†…ä¸‹ä¸€ä¸ªèƒ½ä½¿ç”¨ä½ç½®ã€‚

**e.g.** ä¸‰ä¸ªæºæ–‡ä»¶ DemoA.cï¼ŒDemoB.c å’Œ DemoC.cï¼Œå…¶ä¸­ DemoA.c å¼•ç”¨ DemoA.c å’Œ 
DemoB.c é‡Œé¢çš„å‡½æ•°ï¼Œä½¿ç”¨ GCC ç”Ÿæˆç‹¬ç«‹çš„ç›®æ ‡æ–‡ä»¶ DemoA.oï¼ŒDemoB.o å’Œ DemoC.oã€‚
ld ä½¿ç”¨é“¾æ¥è„šæœ¬ Demo.lds, å¹¶ä¸”åœ¨ Demo.lds é‡Œé¢é€šè¿‡ MEMORY å…³é”®å­—ï¼Œä»¥æ­¤æ¥åˆ›å»ºä¸€
äº›å†…å­˜åŒºåŸŸï¼š

DemoA.c

{% highlight ruby %}
extern void print();
extern void exit();

void nomain()
{
    print();
    exit();
}
{% endhighlight %}

DemoB.c

{% highlight ruby %}
char *str = "Hello World\n";

void print()
{
    __asm__ ("movl $13, %%edx\n\t"
             "movl %0, %%ecx\n\t"
             "movl $0, %%ebx\n\t"
             "movl $4, %%eax\n\r"
             "int $0x80\n\t"
             :: "r" (str) : "edx", "ecx", "ebx");
}
{% endhighlight %}

DemoC.c

{% highlight ruby %}
void exit()
{
    __asm__ ("movl $42, %ebx\n\t"
             "movl $1, %eax\n\t"
             "int $0x80\n\t");
}
{% endhighlight %}

Demo.lds 

{% highlight ruby %}
ENTRY(nomain)

INPUT(DemoA.o)
INPUT(DemoB.o)
INPUT(DemoC.o)

MEMORY
{
    rom (r)   : ORIGIN = 0x08060000, LENGTH = 0x100
    ram (rw)  : ORIGIN = 0x08050000, LENGTH = 0x4000
}

SECTIONS
{
    . = 0x08048000 + SIZEOF_HEADERS;

    DemoText ï¼š { *(.text) *(.data) }

    DemoRD : { *(.rodata) }

    /DISCARD/ : { *(.comment) }
}
{% endhighlight %}

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘å’Œé“¾æ¥ï¼š

{% highlight ruby %}
gcc DemoA.c -c
gcc DemoB.c -c
gcc DemoC.c -c -fno-builtin
ld -static -T Demo.lds -o a.out
objdump -xSsdh a.out
{% endhighlight %}

![LD](/assets/PDB/BiscuitOS/kernel/MMU000519.png)

é€šè¿‡ä¸Šé¢çš„è¿è¡Œæ•°æ®å¯çŸ¥ï¼Œåœ¨é“¾æ¥è„šæœ¬é‡Œåˆ›å»ºäº†ä¸¤ä¸ªå†…å­˜åŒºåŸŸï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå†…å­˜åŒºåŸŸä¸ºåª
è¯»åŒºåŸŸï¼Œèµ·å§‹åœ°å€ä¸º 0x08060000ï¼Œ å¤§å°ä¸º 0x100ï¼Œæ ¹æ®è¿™ä¸ªåŒºåŸŸçš„å±æ€§ï¼Œå¯çŸ¥è¾“å‡º 
DemoRD section å°±æ˜¯åªè¯»åŒºåŸŸå†…çš„ï¼Œæ‰€ä»¥è¾“å‡º DemoRD section çš„èµ·å§‹åœ°å€ä¸º 
0x08060000ã€‚ç¬¬äºŒä¸ªå†…å­˜åŒºåŸŸä¸ºå¯è¯»å¯å†™åŒºåŸŸï¼Œèµ·å§‹åœ°å€ä¸º 0x08050000ï¼Œ å¤§å°ä¸º 
0x4000ï¼Œæ ¹æ®è¿™ä¸ªåŒºåŸŸçš„å±æ€§ï¼Œå¯çŸ¥è¾“å‡º DemoText section å°±æ˜¯å¯è¯»å¯å†™çš„ï¼Œæ‰€ä»¥è¾“å‡º
DemoText section çš„èµ·å§‹åœ°å€ä¸º 0x08050000ã€‚

ä¸Šé¢çš„å½¢å¼éƒ½æ˜¯æ˜ å°„çš„å°†è¾“å‡º section æ”¾åˆ°ç¬¦åˆå±æ€§çš„å†…å­˜åŒºåŸŸå†…ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥æ˜¾ç¤º
çš„å°†è¾“å‡º section æ”¾åˆ°æŒ‡å®šçš„å†…å­˜åŒºåŸŸå†…ï¼Œå¦‚ä¸‹é“¾æ¥è„šæœ¬

{% highlight ruby %}
ENTRY(nomain)

INPUT(DemoA.o)
INPUT(DemoB.o)
INPUT(DemoC.o)

MEMORY
{
    rom (r)   : ORIGIN = 0x08060000, LENGTH = 0x100
    ram (rw)  : ORIGIN = 0x08050000, LENGTH = 0x4000
    com (rw)  : ORIGIN = 0x08070000, LENGTH = 0x8000
}

SECTIONS
{
    . = 0x08048000 + SIZEOF_HEADERS;

    DemoText ï¼š { *(.text) } > ram

    DemoData : { *(.data) } > com

    DemoRD : { *(.rodata) } > rom

    /DISCARD/ : { *(.comment) }
}
{% endhighlight %}

è¿è¡Œä¸‹é¢å‘½ä»¤ï¼š

{% highlight ruby %}
gcc DemoA.c -c
gcc DemoB.c -c
gcc DemoC.c -c -fno-builtin
ld -static -T Demo.lds -o a.out
objdump -xSsdh a.out
{% endhighlight %}

![LD](/assets/PDB/BiscuitOS/kernel/MMU000520.png)

é€šè¿‡ä¸Šé¢çš„è¿è¡Œæ•°æ®å¯çŸ¥ï¼ŒDemoText è¢«æ”¾åˆ°äº†å†…å­˜åŒºåŸŸ ram é‡Œé¢ï¼Œå…¶èµ·å§‹åœ°å€ä¹Ÿå˜æˆäº†
0x08050000ï¼›DemoData è¢«æ”¾åˆ°äº†å†…å­˜åŒºåŸŸ com é‡Œé¢ï¼Œå…¶èµ·å§‹åœ°å€å˜æˆäº† 0x08070000ï¼›
DemoRD è¢«æ”¾åˆ°äº†å†…å­˜åŒºåŸŸ rom é‡Œé¢ï¼Œå…¶èµ·å§‹åœ°å€ä¹Ÿå˜æˆäº† 0x080600000ã€‚

-----------------------------------------------

# <span id="é™„å½•">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Driver](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [BiscuitOS Kernel Build](https://biscuitos.github.io/blog/Kernel_Build/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)

## èµèµä¸€ä¸‹å§ ğŸ™‚

![MMU](/assets/PDB/BiscuitOS/kernel/HAB000036.jpg)
