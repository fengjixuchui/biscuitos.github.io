---
layout: post
title:  "MTRR: Memory Type Range Register"
date:   2021-03-15 06:00:00 +0800
categories: [HW]
excerpt: MTRRs.
tags:
  - MMU
---

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000L0.PNG)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/RPI/RPI100100.png)

#### ç›®å½•

> - [MTRRs æºç åˆ†æ](#D)
>
> - [é™„å½•/æèµ ](#Z0)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

----------------------------------

<span id="D"></span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND00000H.jpg)

#### MTRRs æºç åˆ†æ

> - [MTRRs é‡è¦æ•°æ®ç»“æ„](#D105)
>
>   - [mtrr_type](#D101)
>
>   - [struct fixed_range_block](#D103)
>
>   - [struct mtrr_ops](#D104)
>
>   - [struct mtrr_state_type](#D102)
>
>   - [struct mtrr_var_range](#D100)
>
> - [MTRRs æ•°æ®ç»“æ„](#D206)
>
>   - [fixed_range_blocks](#D203)
>
>   - [generic_mtrr_ops](#D205)
>
>   - [mtrr_state](#D201)
>
>   - [mtrr_strings](#D202)
>
>   - [mtrr_usage_table](#D200)
>
>   - [smp_changes_mask](#D204)
>
> - [MTRRs API](#D30030)
>
>   - [check_type_overlap](#D30027)
>
>   - [fill_mtrr_var_range](#D30025)
>
>   - [generic_have_wrcomb](#D30024)
>
>   - [generic_get_free_region](#D30023)
>
>   - [generic_get_mtrr](#D30017)
>
>   - [generic_set_all](#D30022)
>
>   - [generic_set_mtrr](#D30016)
>
>   - [get_fixed_ranges](#D30008)
>
>   - [get_mtrr_size](#D30028)
>
>   - [get_mtrr_state](#D30011)
>
>   - [get_mtrr_var_range](#D30005)
>
>   - [init_table](#D30002)
>
>   - [mtrr_atrrib_to_str](#D30010)
>
>   - [mtrr_bp_pat_init](#D30015)
>
>   - [mtrr_enabled](#D30003)
>
>   - [mtrr_type_lookup_fixed](#D30026)
>
>   - [mtrr_type_lookup_variable](#D30029)
>
>   - [mtrr_wrmsr](#D30013)
>
>   - [MTRRphysBase_MSR](#D30006)
>
>   - [MTRRphysMask_MSR](#D30007)
>
>   - [post_set](#D30014)
>
>   - [prepare_set](#D30012)
>
>   - [print_mtrr_state](#D30009)
>
>   - [set_fixed_range](#D30020)
>
>   - [set_fixed_ranges](#D30019)
>
>   - [set_mtrr_state](#D30021)
>
>   - [set_mtrr_var_ranges](#D30018)
>
>   - [set_num_var_ranges](#D30001)
>
>   - [SIZE_OR_MASK_BITS](#D30000)
>
>   - [use_intel](#D30004)


---------------------------------------------

#### <span id="D3000X">X</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000.png)

{% highlight bash %}
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30029">mtrr_type_lookup_variable</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000211.png)

mtrr_type_lookup_variable() å‡½æ•°ç”¨äºæŸ¥æ‰¾æŸæ®µç‰©ç†å†…å­˜çš„

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30028">get_mtrr_size</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000210.png)

get_mtrr_size() å‡½æ•°ç”¨äºè·å¾— IA32_MTRR_PHYSMASKn å¯„å­˜å™¨å¯¹åº”çš„ç‰©ç†å†…å­˜åŒºåŸŸé•¿åº¦ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000173.png)

åœ¨ MTRR ä¸­ï¼ŒVariable-Range MTRR æè¿°çš„ç‰©ç†å†…å­˜åŒºåŸŸé•¿åº¦çš„ä¿¡æ¯å­˜å‚¨åœ¨ IA32_MTRR_PHYSMASKn å¯„å­˜å™¨é‡Œï¼Œå‡½æ•°åœ¨ 71-74 è¡Œé€šè¿‡è¿ç®—è·å¾— size çš„ä¿¡æ¯ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30027">check_type_overlap</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000209.png)

check_type_overlap() å‡½æ•°ç”¨äºæ£€æµ‹ memory type æ˜¯å¦è¦†ç›–ã€‚å‚æ•° prev æŒ‡å‘å‰ä¸€ä¸ª memory typeï¼Œå‚æ•° curr æŒ‡å‘åä¸€ä¸ª memory typeã€‚å‡½æ•°åœ¨ 84 è¡Œé¦–å…ˆæ£€æµ‹åˆ° prev æˆ–è€… curr ä¸­åªè¦ä¸€ä¸ªæ˜¯ MTRR_TYPE_UNCACHABLE, é‚£ä¹ˆå°† prev å’Œ curr éƒ½è®¾ç½®ä¸º MTRR_TYPE_UNCACHABLE, å¹¶è¿”å› 1; åä¹‹å¦‚æœ prev ä¸º MTRR_TYPE_WRBACK ä¸” curr ä¸º MTRR_TYPE_WRTHOUGH, æˆ–è€… prev ä¸º MTRR_TYPE_WRTHROUGH ä¸” curr ä¸º MTRR_TYPE_WRBACK, é‚£ä¹ˆä¸¤è€…ä¹‹é—´éœ€è¦è¿›è¡Œè¦†ç›–ï¼ŒMTRR_TYPE_WRTHROUGH ä¼˜å…ˆçº§ä½ï¼Œé‚£ä¹ˆå°† prev å’Œ curr éƒ½è®¾ç½®ä¸º MTRR_TYPE_WRTHROUGH; åä¹‹å¦‚æœ prev å’Œ curr æ­¤æ—¶ä¸ç›¸åŒï¼Œé‚£ä¹ˆéƒ½è®¾ç½®ä¸º MTRR_TYPE_UNCACHABLEï¼Œå¹¶è¿”å› 1.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30026">mtrr_type_lookup_fixed</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000208.png)

mtrr_type_lookup_fixed() å‡½æ•°ç”¨äºæŸ¥æŸç«¯ç‰©ç†å†…å­˜å¯¹åº” Fixed-Range MTRR çš„ memory type.å‚æ•° start å’Œ end æŒ‡æ˜äº†ç‰©ç†å†…å­˜èŒƒå›´ã€‚åœ¨ Intel ä¸­ï¼ŒFixed-Range MTRR æ¶‰åŠçš„èŒƒå›´ä¸º 0 åˆ° 0x100000 çš„èŒƒå›´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªèŒƒå›´ï¼Œé‚£ä¹ˆ Fixed-Range MTRR æ— æ³•ç®¡è¾–åˆ°ã€‚å‡½æ•°é¦–å…ˆåœ¨ 123 è¡Œåˆ¤æ–­ç‰©ç†å†…å­˜èµ·å§‹åœ°å€æ˜¯å¦è¶…è¿‡ 1MiB, å¦‚æœè¶…è¿‡ï¼Œé‚£ä¹ˆå‡½æ•°ç›´æ¥è¿”å› MTRR_TYPE_INVALID, ä»¥æ­¤è¡¨ç¤ºå¯¹åº”çš„ Fixed-Range MTRR å¯„å­˜å™¨ä¸å­˜åœ¨; åä¹‹å¦‚æœç‰©ç†å†…å­˜èµ·å§‹åœ°å€åœ¨ä½äº 1MiB çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 127 è¡Œæ£€æµ‹ç‰©ç†å†…å­˜æ˜¯å¦åœ¨ 0x00000 åˆ° 0x80000 ä¹‹é—´ï¼Œå¦‚æœåœ¨ï¼Œé‚£ä¹ˆè¯¥åŒºé—´å­˜åœ¨å…«ä¸ª 64K Fixed-Range MTRR å¯„å­˜å™¨ï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 128-129 è¡ŒæŒ‰ 64K ç²’åº¦è·å¾—å¯¹åº”çš„ç´¢å¼•ï¼Œå¹¶å°†ç´¢å¼•åœ¨ mtrr_state.fixed_ranges[] æ•°ç»„çš„æˆå‘˜è¿›è¡Œè¿”å›; å¦‚æœç‰©ç†å†…å­˜è½åœ¨ 0x80000 åˆ° 0xBFFFF ä¹‹é—´ï¼Œé‚£ä¹ˆè¯¥åŒºé—´å­˜åœ¨ 16 ä¸ª 16KiB çš„åŒºåŸŸï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 133-134 è¡ŒæŒ‰ 16KiB ä¸ºç²’åº¦è·å¾—å¯¹åº”çš„ç´¢å¼•ï¼Œå¹¶å°†ç´¢å¼•åœ¨ mtrr_state.fixed_ranges[] æ•°ç»„çš„æˆå‘˜è¿›è¡Œè¿”å›; åä¹‹å¦‚æœç‰©ç†å†…å­˜è½åœ¨ 0xC0000 - 0xFFFFF ä¹‹é—´ï¼Œé‚£ä¹ˆè¯¥åŒºé—´å­˜åœ¨ 64 ä¸ª 4KiB çš„åŒºåŸŸï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 139-140 è¡Œä»¥ 4KiB ä¸ºç²’åº¦è®¡ç®—å‡ºå¯¹åº”çš„ç´¢å¼•ï¼Œå¹¶å°†ç´¢å¼•åœ¨ mtrr_state.fixed_ranges[] æ•°ç»„çš„æˆå‘˜è¿›è¡Œè¿”å›. è¿”å›å€¼å³æ˜¯ memory type.

> [mtrr_state](#D201)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30025">fill_mtrr_var_range</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000207.png)

fill_mtrr_var_range() å‡½æ•°å¡«å…… mtrr_state ç»´æŠ¤çš„ var_ranges[] æ•°ç»„ä¸­æŒ‡å®šæˆå‘˜ã€‚å‚æ•° index ç”¨äºæŒ‡æ˜ var_ranges[] æ•°ç»„ä¸­çš„ç´¢å¼•, å‚æ•° base_loã€base_hiã€mask_loã€ä»¥åŠ mask_hi æˆå‘˜ç”¨äºå¡«å…… var_ranges[] ä¸­çš„æŒ‡å®šæˆå‘˜. å‡½æ•°é¦–å…ˆåœ¨ 327 è¡Œä» mtrr_state ä¸­è¯»å– var_ranges[] æ•°ç»„ï¼Œç„¶åå°†å‚æ•°å¡«å……åˆ°è¯¥æ•°ç»„é‡Œ.

> [mtrr_state](#D201)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D205">generic_mtrr_ops</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000206.png)

generic_mtrr_ops ä¸ºä¸€ä¸ª struct mtrr_ops æ•°æ®ç»“æ„ï¼Œå…¶ä¸º Intel æä¾›çš„ä¸€å¥— MTRR æ“ä½œæ¥å£ã€‚è¯¥æ¥å£å¯ä»¥åœ¨ Intel æ¶æ„ä¸‹è¯»å†™ã€è®¾ç½®ã€æˆ–è€…è¯»å–æŸäº›èƒ½åŠ›çš„æ¥å£ï¼Œå…·ä½“å‚è€ƒ:

> [struct mtrr_ops](#D104)
>
> [generic_have_wrcomb](#D30024)
>
> [generic_get_free_region](#D30023)
>
> [generic_get_mtrr](#D30017)
>
> [generic_set_all](#D30022)
>
> [generic_set_mtrr](#D30016)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D104">struct mtrr_ops</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000205.png)

struct mtrr_ops æ•°æ®ç»“æ„ç”¨æˆ·ç»´æŠ¤ä¸€å¥—æ“ä½œ MTRR æœºåˆ¶çš„æ¥å£å‡½æ•°ã€‚

* vendor æˆå‘˜ç”¨äºæè¿° VENDOR ä¿¡æ¯
* use_intel_if æˆå‘˜æŒ‡æ˜æ˜¯å¦ä¸º Intel æ¶æ„
* set æ¥å£ç”¨äºè®¾ç½® MTRR å¯„å­˜å™¨
* set_all ç”¨äºè®¾ç½®æ‰€æœ‰çš„ MTRR å¯„å­˜å™¨å’Œ PAT
* get æ¥å£ç”¨äºè·å¾— MTRR å¯„å­˜å™¨
* get_free_region æ¥å£ç”¨äºè·å¾—ä¸€ä¸ªå¯ç”¨ Variable-Range MTRR å¯„å­˜å™¨
* have_wrcomb æ¥å£ç”¨äºè·å¾— WB æ”¯æŒä¿¡æ¯

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30024">generic_have_wrcomb</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000204.png)

generic_have_wrcomb() å‡½æ•°ç”¨è¯»å– MTRR æ”¯æŒ Combine Write çš„èƒ½åŠ›ã€‚MTRR åœ¨ IA32_MTRRCAP å¯„å­˜å™¨ä¸­ä½¿ç”¨ WC æ ‡å¿—ä½ç”¨äºæŒ‡ç¤ºç³»ç»Ÿæ˜¯å¦æ”¯æŒ Write-Combining èƒ½åŠ›ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000146.png)

å‡½æ•°è°ƒç”¨ rdmsr() ä» MSR_MTRRcap å¯„å­˜å™¨ä¸­è¯»å–å…¶å€¼ï¼Œå¹¶å°† WB æ ‡å¿—ä½è¿›è¡Œè¿”å›.

> [IA32_MTRRCAP MSR Register](https://biscuitos.github.io/blog/Register/#T001)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30023">generic_get_free_region</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000203.png)

generic_get_free_region() å‡½æ•°ç”¨äºä» mtrr_state çš„ var_ranges[] æ•°ç»„ä¸­è·å¾—ä¸€ä¸ªç©ºé—²çš„æˆå‘˜ã€‚å‚æ•° base å’Œ size å¹¶æœªä½¿ç”¨ï¼Œå‚æ•° replace_reg ç”¨äºæŒ‡æ˜æœŸæœ›è·å¾— Variable-Range MTRR å¯„å­˜å™¨ç´¢å¼•ã€‚å†…æ ¸å°†å½“å‰ç³»ç»Ÿç»´æŠ¤çš„å¯ç”¨ Variable-Range MTRR å¯„å­˜å™¨æ•°é‡ç»´æŠ¤åœ¨ num_var_ranges å˜é‡é‡Œï¼Œå‡½æ•°é¦–å…ˆåœ¨ 566 è¡Œæ£€æµ‹ replace_reg å¯¹åº”çš„å¯„å­˜å™¨å¦‚æœåœ¨ 0 åˆ° num_var_ranges èŒƒå›´ä¹‹å†…ï¼Œé‚£ä¹ˆå‡½æ•°ç›´æ¥è¿”å› replace_reg çš„å€¼ï¼Œä»¥æ­¤è¡¨ç¤ºè¯¥å¯„å­˜å™¨å¯ç”¨ã€‚åä¹‹å¦‚æœ replace_reg çš„å€¼å°äº 0ï¼Œé‚£ä¹ˆå‡½æ•°å°±ä¼šéå† mtrr_state çš„ var_ranges[] æ•°ç»„ï¼Œç„¶åæ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„æˆå‘˜è¿›è¡Œè¿”å›.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D204">smp_changes_mask</span>

{% highlight bash %}
static unsigned long smp_changes_mask;
{% endhighlight %}

smp_changes_mask å˜é‡ç”¨äºåŒæ­¥ SMP æ¨¡å¼ä¸‹ MTRR å¯„å­˜å™¨ä¿®æ”¹äº‹ä»¶ã€‚å½“æŸä¸ª CPU ä¿®æ”¹äº† MTRR å¯„å­˜å™¨ï¼Œé‚£ä¹ˆéœ€è¦é€šè¿‡è¯¥å˜é‡é€šçŸ¥å…¶ä»– CPU MTRR å¯„å­˜å™¨æ›´æ–°äº‹ä»¶ï¼Œä»¥æ­¤è®©æ¯ä¸ª CPU åŒæ­¥å¥½è½¯ä»¶ç»´æŠ¤çš„ MTRR ä¿¡æ¯. ç›®å‰å†…æ ¸æ”¯æŒçš„é€šçŸ¥äº‹ä»¶å¦‚ä¸‹:

* MTRR_CHANGE_MASK_FIXED Fixed-Range MTRR å¯„å­˜å™¨è¢«ä¿®æ”¹
* MTRR_CHANGE_MASK_VARIABLE Variable-Range MTRR å¯„å­˜å™¨è¢«ä¿®æ”¹
* MTRR_CHANGE_MASK_DEFTYPE MTRR é»˜è®¤ memory type è¢«ä¿®æ”¹

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30022">generic_set_all</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000202.png)

generic_set_all() å‡½æ•°ç”¨äºè®¾ç½®ç³»ç»Ÿæ‰€æœ‰çš„ MTRR å¯„å­˜å™¨å’Œ PAT ä¿¡æ¯ã€‚å‡½æ•°é¦–å…ˆåœ¨ 788 è¡Œå’Œ 789 è¡Œè°ƒç”¨ local_irq_save() å‡½æ•°å’Œ prepare_set() å‡½æ•°ä¸ºè®¾ç½®åšå¥½å‡†å¤‡ï¼Œè¯¥è®¾ç½®ä¼šå…³é—­ä¸­æ–­ï¼Œç„¶å FLUSH CACHE å’Œ TLBï¼Œç„¶åç¦ç”¨ MTRR å’Œ CACHEã€‚æ¥ç€å‡½æ•°åœ¨ 792 è¡Œè°ƒç”¨ set_mtrr_state() å‡½æ•°è®¾ç½®ç¡¬ä»¶ MTRR å¯„å­˜å™¨ï¼Œæ¥ç€è°ƒç”¨ pat_init() æ›´æ–° PAT ä¿¡æ¯ã€‚è®¾ç½®å®Œæ¯•åï¼Œå‡½æ•°åœ¨ 797 åˆ° 798 è¡Œè°ƒç”¨ post_set() å‡½æ•°å’Œ local_irq_restore() å‡½æ•°å›å¤ä¸­æ–­ï¼Œå¯ç”¨ CACHE å’Œ MTRR æœºåˆ¶. å‡½æ•°æ¥ç€åœ¨ 801 è¡ŒæŸ¥çœ‹ç³»ç»Ÿæ›´æ–°äº†å“ªäº› MTRR å¯„å­˜å™¨ï¼Œå¦‚æœç³»ç»Ÿæ£€æµ‹åˆ°å¯¹åº”çš„ MTRR å¯„å­˜å™¨è¢«æ›´æ–°ï¼Œé‚£ä¹ˆå‡½æ•°å›è§ smp_changes_mask ä¸­å¯¹åº”çš„ bit ç½®ä½ï¼Œå› æ­¤é€šçŸ¥å…¶ä»– CPU æ›´æ–°è‡ªå·±è½¯ä»¶ç»´æŠ¤çš„ MTRR ä¿¡æ¯.

> [post_set](#D30014)
>
> [prepare_set](#D30012)
>
> [smp_changes_mask](#D204)
>
> [set_mtrr_state](#D30021)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30021">set_mtrr_state</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000200.png)

set_mtrr_stat() å‡½æ•°ç”¨äºå°† mtrr_state ä¸­ç»´æŠ¤çš„ MTRR ä¿¡æ¯æ›´æ–°åˆ°å¯¹åº”çš„ MTRR å¯„å­˜å™¨ä¸Šã€‚å†…æ ¸ä½¿ç”¨ mtrr_state ç»´æŠ¤è½¯ä»¶ä¸Šçš„ MTRR ä¿¡æ¯ï¼Œå…¶ä¸º struct mtrr_state_type æ•°æ®ç»“æœï¼Œå…¶ç»“æ„å¦‚ä¸‹å›¾ï¼Œå…¶ä¸­ var_ranges[] æ•°ç»„æŒ‡å‘è½¯ä»¶ç»´æŠ¤çš„å¤šä¸ª Variable-Range MTRR å¯„å­˜å™¨çš„å€¼ï¼Œå†…æ ¸è¿˜ä½¿ç”¨ fixed_range_blocks[] æ•°ç»„ä¸ºäº†ç³»ç»Ÿå¯ç”¨çš„ Fixed-Range MTRR å¯„å­˜å™¨ä¿¡æ¯ï¼Œå…¶ç»“åˆ struct mtrr_state_type çš„ fixed_ranges[] æ•°ç»„ä»è½¯ä»¶ä¸Šç»´æŠ¤äº†ç³»ç»Ÿçš„ Fixed-Range MTRR ä¿¡æ¯ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000201.png)

å‡½æ•°é¦–å…ˆåœ¨ 695 è¡Œä½¿ç”¨ for å¾ªç¯ï¼Œéå†ç³»ç»Ÿæ‰€æœ‰çš„ Variable-Range MTRR å¯„å­˜å™¨ï¼Œåœ¨æ¯æ¬¡éå†è¿‡ç¨‹ä¸­ï¼Œå‡½æ•°åœ¨ 696 è¡Œè°ƒç”¨ set_mtrr_ranges() å‡½æ•°å°† mtrr_state çš„ var_ranges[] æ•°ç»„çš„å€¼æ›´æ–°åˆ° Variable-Range MTRR å¯„å­˜å™¨é‡Œï¼Œåªæœ‰è½¯ä»¶ç»´æŠ¤çš„ Variable-Range MTRR å€¼ä¸ç¡¬ä»¶ Variable-Range MTRR å¯„å­˜å™¨ä¸åŒï¼Œé‚£ä¹ˆæ„å‘³ç€ç³»ç»Ÿå·²ç»æ›´æ–°äº†æŸä¸ª Variable-Range MTRR å¯„å­˜å™¨çš„å€¼ï¼Œé‚£ä¹ˆå‡½æ•°å°† change_mask æ·»åŠ ä¸Š MTRR_CHANGE_MASK_VARIABLE æ ‡å¿—ã€‚åŒç†ï¼Œå‡½æ•°åœ¨ 700 è¡Œé¦–å…ˆæ£€æµ‹ç³»ç»Ÿæ˜¯å¦æ”¯æŒ Fixed-Range MTRR å¯„å­˜å™¨ï¼Œå¦‚æœæ”¯æŒï¼Œé‚£ä¹ˆå‡½æ•°è°ƒç”¨ set_fixed_ranges() å‡½æ•°å°† mtrr_state ç»´æŠ¤çš„ fixed_ranges[] æ•°ç»„çš„å†…å®¹åŒæ­¥åˆ°å¯¹åº”çš„ Fxied-Range MTRR å¯„å­˜å™¨é‡Œï¼Œæ­¤æ—¶åªæœ‰æŸä¸ª Fxied-Range MTRR å¯„å­˜å™¨çš„å€¼è¢«æ›´æ–°ï¼Œé‚£ä¹ˆå‡½æ•°å°±ä¼šå°† change_mask æ·»åŠ ä¸Š MTRR_CHNAGE_MASK_FIXED æ ‡å¿—ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000148.png)

å‡½æ•°æ¥ä¸‹æ¥åœ¨ 707 è¡Œé¦–å…ˆæ£€æµ‹ mtrr_state ç»´æŠ¤çš„é»˜è®¤ memory type æ˜¯å¦å’Œ IA32_MTRR_DEF_TYPE MSR å¯„å­˜å™¨çš„ Type å­—æ®µç›¸åŒï¼Œå¹¶ä¸”è¿˜æ£€æµ‹ mtrr_state çš„ MTRR ä½¿èƒ½ä¿¡æ¯æ˜¯å¦ä¸ IA32_MTRR_DEF_TYPE MSR ä¸­çš„ E æ ‡å¿—ä½ä¸€è‡´ï¼Œè¯¥å¯„å­˜å™¨çš„å¸ƒå±€å¦‚ä¸Šå›¾ã€‚å¦‚æœå…¶ä¸­çš„ä¸€ä¸ªæ¡ä»¶å‘ç°ä¸ç›¸åŒæ—¶ï¼Œå‡½æ•°ä¼šå°† mtrr_state ä¸­çš„ç›¸å…³ä¿¡æ¯åŒæ­¥åˆ° deftype_lo ä¸­ï¼Œå¹¶å‘ change_mask ä¸­æ·»åŠ   MTRR_CHANGE_MASK_DEFTYPE æ ‡å¿—ã€‚å‡½æ•°æ›´æ–°å®Œæ¯•ä¹‹åè¿”å› change_mask çš„å€¼.

> [IA32_MTRR_DEF_TYPE MSR](https://biscuitos.github.io/blog/Register/#T002)
>
> [set_mtrr_var_ranges](#D30018)
>
> [set_fixed_ranges](#D30019)
>
> [mtrr_state](#D201)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30020">set_fixed_range</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000199.png)

set_fixed_range() å‡½æ•°ç”¨äºè®¾ç½®ä¸€ä¸ª Fixed-Range MTRR å¯„å­˜å™¨ã€‚å‚æ•° msr æŒ‡å‘ Fixed-Range MTRR å¯„å­˜å™¨çš„å€¼ï¼Œchanged å‚æ•°ç”¨äºå­˜å‚¨è¯¥ MSR çš„å€¼æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼Œå‚æ•° msrwords åˆ™å­˜å‚¨ç€æ–°çš„ Fixed-Range MSR å¯„å­˜å™¨å€¼ã€‚å‡½æ•°é¦–å…ˆåœ¨ 542 è¡Œè°ƒç”¨ rdmsr() å‡½æ•°è¯»å– Fixed-Range MTRR å¯„å­˜å™¨çš„å€¼ï¼Œç„¶ååœ¨ 544 è¡Œåˆ¤æ–­å½“å‰ Fixed-Range MTRR å¯„å­˜å™¨çš„å€¼æ˜¯å¦ä¸æ–°çš„å€¼å­˜åœ¨å·®å¼‚ï¼Œå¦‚æœå­˜åœ¨å·®å¼‚ï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 545 è¡Œè°ƒç”¨ mtrr_wrmsr() å‡½æ•°å°†æ–°å€¼å†™å…¥åˆ° Fixed-Range MTRR å¯„å­˜å™¨ä¸­ï¼Œå¹¶å°† changed è®¾ç½®ä¸º true; åä¹‹ä¸åšä»»ä½•æ“ä½œ.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D103">struct fixed_range_block</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000196.png)

struct fixed_range_block æ•°æ®ç»“æ„ç”¨äºæè¿° Fixed-Range MTRR é›†åˆã€‚åœ¨ MTRR æœºåˆ¶ä¸­å­˜åœ¨å¤šä¸ª Fixed-Range MTRR å¯„å­˜å™¨ï¼Œè¿™äº›å¯„å­˜å™¨ä½œç”¨åœ¨å›ºå®šç‰©ç†å†…å­˜ä¸Šï¼Œstruct fixed_range_block æ•°æ®ç»“æ„å°±å°†å½±å“é•¿åº¦ç›¸åŒçš„å¯„å­˜å™¨é›†åˆåœ¨ä¸€èµ·è¿›è¡Œæè¿°ã€‚ç›®å‰ Fixed-Range MTRR å¯„å­˜å™¨å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000197.png)

ä»ä¸Šå›¾å¯ä»¥çŸ¥é“ï¼ŒFixed-Range MTRR å¯„å­˜å™¨è™½ç„¶ä½œç”¨çš„ç‰©ç†å†…å­˜ä¸åŒï¼Œä½†æœ‰äº›å¯„å­˜å™¨ä½œç”¨çš„ç‰©ç†å†…å­˜é•¿åº¦ç›¸åŒä¸”è¿ç»­ï¼Œé‚£ä¹ˆå†…æ ¸ä½¿ç”¨ struct fixed_range_block æ•°æ®ç»“æ„å°†é•¿åº¦ç›¸åŒä¸”è¿ç»­çš„ Fixed-Range MTRR è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚

æˆå‘˜ base_msr ç”¨äºæè¿°é›†åˆä¸­ç¬¬ä¸€ä¸ª Fixed-Range MTRR å¯„å­˜å™¨ï¼Œæˆå‘˜ ranges åˆ™è¡¨ç¤ºå…·æœ‰ç›¸åŒé•¿åº¦çš„ Fixed-Range MTRR å¯„å­˜å™¨çš„æ•°é‡ã€‚è¯¦ç»†å¯ä»¥å‚è€ƒ:

> [fixed_range_blocks](#D203)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D203">fixed_range_blocks</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000198.png)

fixed_range_blocks[] æ•°ç»„ç”¨äºæè¿° Fixed-Range MTRR å¯„å­˜å™¨é›†åˆï¼Œå†…æ ¸ä½¿ç”¨ struct fixed_range_block æ•°æ®ç»“æ„ç»´æŠ¤é•¿åº¦ç›¸åŒçš„ Fixed-Range MTRR å¯„å­˜å™¨ã€‚fixed_range_block[] æ•°ç»„çš„ç¬¬ä¸€ä¸ªæˆå‘˜ç”¨äºç»´æŠ¤é•¿åº¦ä¸º 64K çš„ Fixed-Range MTRR å¯„å­˜å™¨é›†åˆï¼Œå…¶èµ·å§‹ MSR ä¸º MSR_MTRRfix64K_00000, å…¶æ•°é‡ä¸º 1; ç¬¬äºŒä¸ªæˆå‘˜ç”¨äºç»´æŠ¤é•¿åº¦ä¸º 16K çš„ Fixed-Range MTRR å¯„å­˜å™¨é›†åˆï¼Œå…¶èµ·å§‹ MSR ä¸º MSR_MTRRfix16K_80000, å…¶æ•°é‡ä¸º 2; ç¬¬ä¸‰ä¸ªæˆå‘˜ç”¨äºç»´æŠ¤é•¿åº¦ä¸º 4K çš„ Fixed-Range MTRR å¯„å­˜å™¨ï¼Œå…¶æ•°é‡ä¸º 8.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000197.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30019">set_fixed_ranges</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000195.png)

set_fixed_ranges() å‡½æ•°ç”¨äºè®¾ç½®ç³»ç»Ÿæ‰€æœ‰çš„ Fixed-Range MTRR å¯„å­˜å™¨ã€‚å‚æ•° frs æŒ‡å‘äº†æ–°çš„ Fixed-Range MTRR å¯„å­˜å™¨å€¼ã€‚å†…æ ¸å°†æ–°çš„ Fixed-Range MTRR å¯„å­˜å™¨å€¼ç»´æŠ¤åœ¨ mtrr_state.fixed_ranges[] æ•°ç»„é‡Œï¼Œå¹¶ä½¿ç”¨ fixed_range_blocks[] æ•°ç»„ç»´æŠ¤æ‰€æœ‰ Fixed-Range MTRR å¯„å­˜å™¨ä½ç½®å’Œæ•°é‡ä¿¡æ¯ã€‚å‡½æ•°é¦–å…ˆåœ¨ 644 è¡Œä½¿ç”¨ while() å¾ªç¯ä» fixed_range_blocks[] æ•°ç»„ä¸­å°†ä¸åŒé•¿åº¦çš„ Fixed-Range MTRR å¯„å­˜å™¨é›†åˆè¯»å‡ºï¼Œç„¶åä½¿ç”¨ for å°†é›†åˆé‡Œçš„ Fixed-Rnage MTRR å¯„å­˜å™¨ä¿¡æ¯æ‹¿å‡ºæ¥ï¼Œç„¶åä¼ é€’ç»™ set_fixed_range() å‡½æ•°ï¼ŒåŒæ—¶ä¼ å…¥çš„å‡½æ•° save æŒ‡å‘çš„ Fxied-Range MTRR å¯„å­˜å™¨çš„å€¼ï¼Œä»¥æ­¤æ›´æ–°è¯¥ Fixed-Range MTRR å¯„å­˜å™¨çš„å€¼ã€‚

> [fixed_range_blocks](#D203)
>
> [set_fixed_range](#D30020)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30018">set_mtrr_var_ranges</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000194.png)

set_mtrr_var_ranges() å‡½æ•°ç”¨äºè®¾ç½®ä¸€ä¸ª Variable-Range MTRR å¯„å­˜å™¨ï¼Œè¯¥å¯„å­˜å™¨åŒ…å«äº†ä¸€å †å¯„å­˜å™¨ IA32_MTRR_PHYSBASEn å’Œ IA32_MTRR_PHYSMASKn å¯„å­˜å™¨. å‚æ•° index æŒ‡æ˜äº† Variable-Range MTRR å¯„å­˜å™¨çš„åºå·ï¼Œvr å‚æ•°åˆ™å­˜å‚¨äº†ä¸€ä¸ª Variable-Range MTRR å¯„å­˜å™¨çš„å€¼ã€‚å‡½æ•°é¦–å…ˆåœ¨ 662 è¡Œè°ƒç”¨ rdmsr() å‡½æ•°å’Œ MTRRphysBase_MSR() å¯„å­˜å™¨è¯»å–å¯¹åº”çš„ IA32_MTRR_PHYSBASEn å¯„å­˜å™¨ï¼Œå¦‚æœè¯¥å¯„å­˜å™¨æŒ‡å‘çš„ç‰©ç†åŒºåŸŸçš„åŸºåœ°å€ä¸ vr ä¸­æŒ‡å‘ç‰©ç†å†…å­˜åŸºåœ°å€ä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆå‡½æ•°ä¼šåœ¨ 667 è‡³ 668 è¡Œæ›´æ–°å¯¹åº”çš„ IA32_MTRR_PHYSBASEn å¯„å­˜å™¨ï¼Œå¹¶å°† changed è®¾ç½®ä¸º trueï¼Œä»¥æ­¤è¡¨ç¤ºè¯¥å¯„å­˜å™¨æ›´æ”¹è¿‡ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000173.png)

å‡½æ•°æ¥ç€åœ¨ 671 è¡Œè¯»å–äº†å¯¹åº”çš„ IA32_MTRR_PHYSMASKn å¯„å­˜å™¨ï¼Œå¦‚æœè¯¥å¯„å­˜å™¨å¯¹åº”çš„ Mask ä¸ vr å¯¹åº”çš„ Mask ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå‡½æ•°å°†æ–°çš„å€¼å†™å…¥åˆ° IA32_MTRR_PHYSMASKn å¯„å­˜å™¨é‡Œï¼Œå¹¶å°† changed è®¾ç½®ä¸º trueã€‚å‡½æ•°æœ€åè¿”å› changed çš„å€¼. 

> [MTRRphysBase_MSR](#D30006)
>
> [MTRRphysMask_MSR](#D30007)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30017">generic_get_mtrr</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000193.png)

generic_get_mtrr() å‡½æ•°ç”¨äºè·å¾—ä¸€ä¸ª Variable-Range MTRR å¯„å­˜å™¨å¯¹åº”çš„ç‰©ç†å†…å­˜åŒºåŸŸå’Œ memory type. å‚æ•° reg æŒ‡å‘ Variable-Range MTRR å¯„å­˜å™¨åºå·ï¼Œå‚æ•° base ç”¨äºå­˜å‚¨ç‰©ç†å†…å­˜åŒºåŸŸçš„èµ·å§‹ç‰©ç†åœ°å€ï¼Œå‚æ•° size ç”¨äºå­˜å‚¨ç‰©ç†å†…å­˜åŒºåŸŸçš„é•¿åº¦ï¼Œtype å‚æ•°åˆ™ç”¨äºå­˜å‚¨ç‰©ç†å†…å­˜åŒºåŸŸçš„ memory type. å‡½æ•°é¦–å…ˆåœ¨ 591 è¡Œè°ƒç”¨ rdmsr() å‡½æ•°å’Œ MTRRphysMask_MSR() å¯„å­˜å™¨è·å¾—å¯¹åº”çš„ Variable-Range MTRR å¯¹åº”çš„ IA32_MTRR_PHYSMASKn å¯„å­˜å™¨ï¼Œå¹¶å­˜å‚¨åœ¨ mask_lo å’Œ mask_hi å˜é‡é‡Œã€‚å¦‚æœå‡½æ•°æ£€æµ‹åˆ° mask_lo çš„ V æ ‡å¿—ä½ä¸º 0ï¼Œé‚£ä¹ˆè¯¥ Variable-Range MTRR å¯„å­˜å™¨æ²¡æœ‰åœ¨ä½¿ç”¨ï¼Œå› æ­¤å°†å‚æ•°è®¾ç½®ä¸º 0 åè·³è½¬åˆ° out_put_cpu å¤„è¿”å›; åä¹‹å‡½æ•°ç»§ç»­åœ¨ 601 è¡Œè¯»å–å¯¹åº”çš„ IA32_MTRR_PHYSBASEn å¯„å­˜å™¨ï¼Œå¹¶å°†å¯„å­˜å™¨å€¼å­˜å‚¨åœ¨ base_lo å’Œ base_hi ä¸­ï¼Œå‡½æ•°æ¥ç€ä» 604 è‡³ 605 è¡Œè®¡ç®—å‡º Variable-Range MTRR å¯¹åº”çš„ Mask å€¼ï¼Œå¹¶åœ¨ 608 è‡³ 617 è¡Œå¯¹ mask çš„å€¼è¿›è¡Œæ£€æµ‹ï¼Œæ£€æµ‹ BIOS é˜¶æ®µè®¾ç½®çš„æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœä¸æ­£ç¡®å¹¶çŸ«æ­£ã€‚å‡½æ•°æœ€ååœ¨ 624 è¡Œè·å¾—ç‰©ç†å†…å­˜çš„åŸºåœ°å€å€¼ï¼Œä»¥åŠ memory type å€¼ã€‚

> [IA32_MTRR_PHYSBASEn MSR](https://biscuitos.github.io/blog/Register/#T014)
>
> [IA32_MTRR_PHYSMASK MSR](https://biscuitos.github.io/blog/Register/#T015)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30016">generic_set_mtrr</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000192.png)

generic_set_mtrr() å‡½æ•°ç”¨äºè®¾ç½® Variable-Range MTRR å¯„å­˜å™¨ã€‚å‚æ•° reg æŒ‡å‘æŒ‡å®šçš„ Variable-Range MTRR å¯„å­˜å™¨çš„åºå·ï¼Œå‚æ•° base æŒ‡æ˜å—å½±å“çš„ç‰©ç†å†…å­˜åŒºåŸŸçš„åŸºåœ°å€, å‚æ•°æŒ‡æ˜å—å½±å“ç‰©ç†å†…å­˜åŒºåŸŸçš„é•¿åº¦ï¼Œå‚æ•° type åˆ™æŒ‡æ˜çš„ç‰©ç†å†…å­˜åŒºåŸŸçš„ memory type. å†…æ ¸ä½¿ç”¨ mtrr_state å˜é‡ç»´æŠ¤ MTRR æœºåˆ¶ç›¸å…³çš„ä¿¡æ¯ï¼Œå…¶æˆå‘˜ var_ranges[] æ•°ç»„ç»´æŠ¤äº† MTRR æœºåˆ¶æ‰€æœ‰ Variable-Range MTRR å¯„å­˜å™¨ï¼Œå› æ­¤å‡½æ•°åœ¨ 825 è¡Œç»“åˆ reg å‚æ•°ä» mtrr_state å˜é‡ä¸­è·å¾—å¯¹åº”çš„ Variable-Range MTRR å¯„å­˜å™¨ã€‚æ¥ç€å‡½æ•°åœ¨ 827 è‡³ 828 è¡Œè°ƒç”¨ local_irq_save() å’Œ prepare_set() å‡½æ•°ç¦æ­¢ä¸­æ–­ï¼Œå¹¶ FLUSH æ‰€æœ‰çš„ CACHE å’Œ TLB, ä»¥åŠç¦æ­¢ CACHE å’Œ MTRR æœºåˆ¶, ä»¥æ­¤ä¸ºè®¾ç½® Variable-Range MTRR åˆ›å»ºæ‰€éœ€çš„ç¯å¢ƒã€‚å¦‚æœ size å‚æ•°ä¸º 0ï¼Œé‚£ä¹ˆå‡½æ•°å°†å…³é—­å¯¹åº”çš„ Variable-Range MTRR å¯„å­˜å™¨ï¼Œå‡½æ•°åœ¨ 835 è¡Œè°ƒç”¨ mtrr_wrmsr() å‡½æ•°å’Œ MTRRphysMask() å‡½æ•°å°† reg å¯¹åº”çš„ IA32_MTRR_PHYSMASKn å¯„å­˜å™¨çš„å€¼è®¾ç½®ä¸º 0ï¼Œæ­¤æ—¶è¯¥å¯„å­˜å™¨çš„ V æ ‡å¿—ä½ä¸º 0ï¼Œæ€¥ç€å‡½æ•°åœ¨ 836 è¡Œè°ƒç”¨ memset å‡½æ•°å°† reg åœ¨ mtrr_state var_ranges[] æ•°ç»„ä¸­å¯¹åº”çš„æˆå‘˜å†…å®¹æ¸…é›¶ï¼Œä»¥æ­¤å…³é—­è¯¥ Variable-Range MTRR å¯„å­˜å™¨ã€‚åä¹‹ï¼Œå¦‚æœ size å‚æ•°ä¸ä¸º 0ï¼Œé‚£ä¹ˆå‡½æ•°éœ€è¦ä½¿èƒ½ä¸€ä¸ª Variable-Range MTRR å¯„å­˜å™¨å’Œè®¾ç½®å¯¹åº”çš„ç‰©ç†å†…å­˜åŒºåŸŸçš„ memory type. å‡½æ•°é€šè¿‡ 838 è‡³ 841 è¡ŒåŸºäº size å’Œ base å‚æ•°è®¡ç®—å‡ºäº†å¯¹åº”çš„ IA32_MTRR_PHYSBASEn/IA32_MTRR_PHYSMASKn å¯„å­˜å™¨çš„å€¼ï¼Œå¹¶åœ¨ 843 è‡³ 844 è¡Œå°†å…¶å†™å…¥åˆ°å¯¹åº”çš„å¯„å­˜å™¨å†…ã€‚å‡½æ•°æœ€ååœ¨ 847 è‡³ 848 è¡Œè°ƒç”¨ post_set() å‡½æ•°å’Œ local_irq_restore() å‡½æ•° FLUSH æ‰€æœ‰çš„ CACHE å’Œ TLBï¼Œå¹¶ä½¿èƒ½ CACHE å’Œ MTRR æœºåˆ¶ï¼Œæœ€åæ‰“å¼€ä¸­æ–­.

> [post_set](#D30014)
>
> [prepare_set](#D30012)
>
> [mtrr_wrmsr](#D30013)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30015">mtrr_bp_pat_init</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000191.png)

mtrr_bp_pat_init() å‡½æ•°ç”¨äºè®¾ç½® PAT æœºåˆ¶å’Œ PAT è¡¨ã€‚å‡½æ•°é¦–å…ˆåœ¨ 452 è¡Œè°ƒç”¨ local_irq_save() å‡½æ•°å±è”½ä¸­æ–­ï¼Œæ¥ç€è°ƒç”¨ prepare_set() å‡½æ•° flush æ‰€æœ‰çš„ CACHE å’Œ TLBï¼Œå¹¶å°†å…³é—­ MTRR å¹¶è®¾ç½®é»˜è®¤çš„ memory type ä¸º Uncacheã€‚æ¥ç€å‡½æ•°åœ¨ 455 è¡Œè°ƒç”¨ pat_init() å‡½æ•°è®¾ç½® PAT å¹¶åˆ›å»º PAT è¡¨ï¼ŒPAT è¡¨åˆ›å»ºå®Œæ¯•ä¹‹åï¼Œå‡½æ•°åœ¨ 457 è¡Œè°ƒç”¨ post_set() å‡½æ•°æ¢å¤ä¸º prepare_set() ä¹‹å‰çš„ç¯å¢ƒï¼Œå³ä½¿èƒ½ MTRR å¹¶å°†é»˜è®¤çš„ memory type è®¾ç½®ä¸º MTRR è®¾ç½®çš„ã€‚å‡½æ•°æœ€ååœ¨ 458 è¡Œè°ƒç”¨ local_irq_restore() å‡½æ•°æ¢å¤ä¸­æ–­ã€‚

> [post_set](#D30014)
>
> [prepare_set](#D30012)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30014">post_set</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000190.png)

post_set() å‡½æ•°ç”¨äºç³»ç»Ÿè®¾ç½® PAT ä¹‹åçš„æ“ä½œã€‚å‡½æ•°é¦–å…ˆåœ¨ 768 åˆ° 769 è¡Œè°ƒç”¨ \_\_flush_tlb() å‡½æ•°åˆ·æ–°æ‰€æœ‰çš„ TLBã€‚ç„¶ååœ¨ 772 è°ƒç”¨ mtrr_wrmsr() å‡½æ•°å°†åŸå§‹çš„ MTRR é»˜è®¤ç±»å‹å†™å…¥åˆ° MSR_MTRRdefType MSR å¯„å­˜å™¨ä¸­ï¼Œå¹¶å†æ¬¡ä½¿èƒ½ MTRR æœºåˆ¶ã€‚æ¥ç€å‡½æ•°åœ¨ 755 è¡Œè°ƒç”¨ write_cr0() å‡½æ•°å°† CR0.CD æ ‡å¿—ä½æ¸…é›¶ï¼Œä»¥æ­¤ä½¿èƒ½æ‰€æœ‰çš„ CACHEã€‚å‡½æ•°å¦‚æœæ£€æµ‹åˆ°ç³»ç»Ÿæ”¯æŒ Global Page, é‚£ä¹ˆå‡½æ•°å°† CR4.PGE æ ‡å¿—ä½å†æ¬¡ç½®ä½ã€‚è¯¥å‡½æ•°ä¸ prepare_set() å‡½æ•°ç›¸äº’å‘¼åº”ï¼Œä»¥æ­¤ä¸º PAT æœºåˆ¶åˆ›å»ºè®¾ç½®ç¯å¢ƒã€‚

> [mtrr_wrmsr](#D30013)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30013">mtrr_wrmsr</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000189.png)

mtrr_wrmsr() å‡½æ•°ç”¨äºå°†ä¸€ä¸ªåˆæ³•çš„å€¼å†™å…¥åˆ° MTRR å¯„å­˜å™¨ä¸­ã€‚å‚æ•° msr æŒ‡å‘ä¸€ä¸ª MSR å¯„å­˜å™¨ï¼Œå‚æ•° a å°†å†™å…¥ MSR å¯„å­˜å™¨çš„ä½ 32 ä½ï¼Œè€Œ å‚æ•° b å°†å†™å…¥ MSR å¯„å­˜å™¨çš„é«˜ 32 ä½ã€‚å‡½æ•°é€šè¿‡ wrmsr_safe() å‡½æ•°å®‰å…¨åˆæ³•çš„æ›´æ–° MSR å¯„å­˜å™¨çš„å€¼ï¼Œå¹¶æä¾›äº†å†™å…¥å¤±è´¥åçš„æŠ¥é”™ä¿¡æ¯.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30012">prepare_set</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000187.png)

prepare_set() å‡½æ•°ç”¨äºç³»ç»Ÿè®¾ç½® PAT ä¹‹å‰çš„å‡†å¤‡æ“ä½œã€‚å‡½æ•°é¦–å…ˆåœ¨ 740 è¡Œè°ƒç”¨ raw_spin_lock() å‡½æ•°ä¸Šé”ï¼Œæ¥ç€åœ¨ 743 è¡Œè°ƒç”¨ read_cr0() å‡½æ•°è¯»å– CR0 å¯„å­˜å™¨çš„å€¼ï¼Œå¹¶å°†å¯¹åº”çš„ CR0.CD ç½®ä½ä¸”ä¿æŒ CR0.NW æ¸…é›¶ï¼Œå¹¶åœ¨ 744 è¡Œå°†æ–°çš„ CR0 å¯„å­˜å™¨å€¼é€šè¿‡ write_cr0() å‡½æ•°å†™å…¥åˆ° CR0 å¯„å­˜å™¨ï¼Œé‚£ä¹ˆæ­¤æ—¶ç³»ç»Ÿè¿›å…¥äº† no-fill çš„ cache æ¨¡å¼ï¼Œè¯¥æ¨¡å¼å¯ä»¥åˆ·å‡ºæ‰€æœ‰çš„ cacheï¼Œå…·ä½“ç»†èŠ‚å¦‚ä¸‹è¡¨:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000188.png)

ä»ä¸Šè¡¨å¯ä»¥çœ‹å‡ºï¼Œno-fill cache æ¨¡å¼ä¼šè®©æ‰€æœ‰å­˜åœ¨ cache çš„å†…å®¹æ›´æ–°åˆ°ç‰©ç†å†…å­˜ï¼Œå¹¶åœ¨æ¥ä¸‹æ¥å¤„ç†å™¨å°†ä¸ä½¿ç”¨ cache è€Œç›´æ¥ä½¿ç”¨ç‰©ç†å†…å­˜ã€‚å‡½æ•°åœ¨ 745 è¡Œè°ƒç”¨ wbinvd() å‡½æ•°ç”¨äºå°† CACHE ä¸­çš„æ•°æ®å…¨éƒ¨åŒæ­¥åˆ°ç‰©ç†å†…å­˜ä¸­ã€‚å‡½æ•°æ¥ç€åœ¨ 748 è¡Œæ£€æµ‹ç³»ç»Ÿæ˜¯å¦æ”¯æŒå…¨å±€é¡µå±æ€§ï¼Œå¦‚æœæ”¯æŒï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 749 åˆ° 750 è¡Œå°† CR4 å¯„å­˜å™¨ä¸­çš„ CR4.PGE æ ‡å¿—ä½æ¸…é›¶ï¼Œä»¥æ­¤å°†å…¨å±€é¡µä¸­å†…å®¹ä» TLB ä¸­åˆ·æ–°ã€‚æ­¤æ—¶å‡½æ•°åœ¨ 754 åˆ° 755 è¡Œé€šè¿‡æ›´æ–° CR3 çš„å€¼ï¼Œä»¥æ­¤åˆ·æ–°æ‰€æœ‰çš„ TLB (åŒ…æ‹¬å‰é¢æä¾›çš„å…¨å±€é¡µå¯¹åº”çš„ TLB)ã€‚å‡½æ•°æ¥ç€åœ¨ 758 è¡Œè°ƒç”¨ rdmsr() å‡½æ•°å°† MSR_MTRRdefType MSR å¯„å­˜å™¨çš„å€¼å­˜å‚¨åœ¨ deftype_lo å’Œ deftype_hi ä¸¤ä¸ªå˜é‡é‡Œï¼Œç„¶ååœ¨ 761 è¡Œè°ƒç”¨ mtrr_wrmsr() å‡½æ•°å°† MTRR é»˜è®¤çš„ memory type ä¿®æ”¹ä¸º "Uncache", å¹¶å…³é—­ MTRR æœºåˆ¶ï¼Œæœ€åè°ƒç”¨ wbinvd() å‡½æ•°å°† CACHE çš„å†…å®¹å†æ¬¡åŒæ­¥åˆ°ç‰©ç†å†…å­˜ä¸Š.

ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨å°±æ˜¯å°† CACHE æ¨¡å¼è®¾ç½®ä¸º no-fillï¼Œå³ä¸å†å¡«å…… cacheï¼Œç»“åˆç½®ä½ CR0.CD å’Œ WBINVD æŒ‡ä»¤ï¼Œé‚£ä¹ˆ CACHE ä¸­çš„å†…å®¹å…¨éƒ¨åŒæ­¥åˆ°ç‰©ç†å†…å­˜ï¼Œå¹¶åœ¨æ¥ä¸‹æ¥ä¸å†ä½¿ç”¨ CACHEï¼ŒCPU åªèƒ½å’Œç‰©ç†å†…å­˜äº¤äº’ã€‚å‡½æ•°è¿˜æ¸…é™¤äº† CR4.PGE æ ‡å¿—å’Œåˆ·æ–°äº† TLBï¼Œä»¥ä¾¿è®© TLB æ˜¯æœ€æ–°çš„æ˜ å°„å…³ç³»ã€‚åœ¨è®¾ç½®å¥½ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶ä¹‹åï¼Œå‡½æ•°å°† MTRR çš„é»˜è®¤ memory type ä¿®æ”¹ä¸º "Uncache",å¹¶åˆ·æ–°æ‰€æœ‰çš„ CACHEï¼Œå¹¶å…³é—­ MTRR æœºåˆ¶ã€‚è¯¥å‡½æ•°ä¸ post_set() å‡½æ•°ç›¸å‘¼åº”ï¼Œä»¥æ­¤ä¸º PAT æœºåˆ¶åˆ›å»ºç¯å¢ƒ.

> [CR4 Register](https://biscuitos.github.io/blog/Register/#R01)
>
> [CR0 Register](https://biscuitos.github.io/blog/Register/#R00)
>
> [mtrr_wrmsr](#D30013)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30011">get_mtrr_state</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000183.png)

get_mtrr_state() å‡½æ•°ç”¨äºè·å¾—å½“å‰ç³»ç»Ÿ MTRR æœºåˆ¶ä¿¡æ¯ï¼Œå¹¶å­˜å‚¨åœ¨ mtrr_state å˜é‡é‡Œã€‚å‡½æ•°é¦–å…ˆåœ¨ 468 è¡Œè·å¾— mtrr_state çš„ var_range æˆå‘˜ï¼Œè¯¥æˆå‘˜ç”¨äºæè¿° MTRR æœºåˆ¶çš„ Variable-Range MSRã€‚å‡½æ•°æ¥ç€åœ¨ 470 è¡Œè°ƒç”¨ rdmsr() å‡½æ•°è¯»å– MSR_MTRRcap MSR å¯„å­˜å™¨çš„å€¼ï¼Œå¹¶ä»ä½ 32 ä½çš„ bit8 è·å¾—å½“å‰ç³»ç»Ÿæ˜¯å¦æ”¯æŒ fixed-Range MTRR çš„ä¿¡æ¯ï¼Œå¹¶å°†è¯¥ä¿¡æ¯å­˜å‚¨åœ¨ mtrr_state.have_fixed é‡Œã€‚å‡½æ•°ç»§ç»­åœ¨ 473-474 è¡Œå¾ªç¯è°ƒç”¨ get_mtrr_var_range() å‡½æ•°å°† MTRR æ”¯æŒçš„ Variable-Range MTRR ä¿¡æ¯å­˜å‚¨åˆ° vrs å˜é‡é‡Œï¼Œä¹Ÿå°±æ˜¯å­˜å‚¨åˆ°äº† mtrr_state.var_ranges é‡Œ. åŒç†ï¼Œå‡½æ•°åœ¨ 475-476 è¡Œæ£€æµ‹åˆ°å½“å‰ç³»ç»Ÿæ”¯æŒ Fixed-Range MTRR, é‚£ä¹ˆå‡½æ•°è°ƒç”¨ get_fixed_ranges() å‡½æ•°å°†æ‰€æœ‰çš„ Fixed-Range MTRR ä¿¡æ¯å­˜å‚¨åˆ° mtrr_state.fixed_ranges æˆå‘˜é‡Œã€‚

å‡½æ•°ç»§ç»­åœ¨ 478 è¡Œè°ƒç”¨ rdmsr() å‡½æ•°è·å¾— MSR_MTRRdefType å¯„å­˜å™¨çš„å€¼ï¼Œå¹¶ä»è¯¥å¯„å­˜å™¨çš„ä½ 32 ä½ä¸­è·å¾— MTRR æ”¯æŒçš„é»˜è®¤ memory typeï¼Œå¹¶å­˜å‚¨åœ¨ mtrr_state.def_type é‡Œï¼Œæ¥ç€è·å¾—ç³»ç»Ÿæ˜¯å¦æ”¯æŒ MTRR çš„ä¿¡æ¯ï¼Œå¹¶å­˜å‚¨åœ¨ mtrr_state.enabled æˆå‘˜é‡Œã€‚æœ€åå‡½æ•°åœ¨ 493 è¡Œè°ƒç”¨ print_mtrr_state() å‡½æ•°æ‰“å°äº† MTRR æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶å°† mtrr_state_set è®¾ç½®ä¸º 1ï¼Œä»¥æ­¤è¡¨ç¤º mtrr_state å˜é‡å¯ä»¥ä»£è¡¨å½“å‰ç³»ç»Ÿçš„ MTRR æœºåˆ¶ã€‚å‡½æ•°åœ¨è¿”å›æ—¶å†æ¬¡æ£€æµ‹äº† MTRR åŠŸèƒ½æ˜¯å¦å¯ç”¨ï¼Œå…¶åœ¨ mtrr_state.enable ä¸­è¿›è¡Œæè¿°.

> [mtrr_state](#D201)
>
> [get_fixed_ranges](#D30008)
>
> [get_mtrr_var_range](#D30005)
>
> [print_mtrr_state](#D30009)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D202">mtrr_strings</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000181.png)

mtrr_strings[] æ•°ç»„ä¸º MTRR æœºåˆ¶æ”¯æŒçš„ memory type å­—ç¬¦ä¸²æ•°ç»„ã€‚æ¯ä¸ªå¯ç”¨çš„ memory type éƒ½å¯¹åº”ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30010">mtrr_attrib_to_str</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000180.png)

mtrr_attrib_to_str() å‡½æ•°ç”¨äºè·å¾— MTRR memory type å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œå‚æ•° x å¯¹åº”çš„ memory type. å‡½æ•°é¦–å…ˆç¡®è®¤ memory type çš„å€¼ä¸è¶…è¿‡ 6ï¼Œå¦‚æœå€¼åˆæ³•ï¼Œåˆ™ä» mtrr_strings[] æ•°ç»„ä¸­è·å¾—å¯¹åº”çš„ memory type å­—ç¬¦ä¸²; åä¹‹è¿”å› "?".

> [mtrr_strings](#D202)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30009">print_mtrr_state</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000179.png)

print_mtrr_state() å‡½æ•°ç”¨äºæ‰“å°å½“å‰ç³»ç»Ÿ MTRR ä¿¡æ¯. å‡½æ•°åœ¨ 407 è¡Œæ‰“å°äº† MTRR é»˜è®¤çš„ memory type, å…¶å­˜å‚¨åœ¨ mtrr_state.def_type é‡Œã€‚å‡½æ•°æ¥ç€åœ¨ 409 è¡Œåˆ¤æ–­ MTRR æ˜¯å¦æ”¯æŒ Fixed-Range MTRR, å¦‚æœæ”¯æŒï¼Œé‚£ä¹ˆå‡½æ•°åœ¨ 410-424 è¡Œå°† MTRR æ‰€æœ‰çš„ Fixed-Range MTRR ä¿¡æ¯æ‰“å°å‡ºæ¥ã€‚452 è¡Œåˆ™åˆ¤æ–­ MTRR æ˜¯å¦æ”¯æŒ Variable-Range MTRR ä¿¡æ¯ï¼Œå¦‚æœæ”¯æŒå‡½æ•°ä» 429-442 è¡Œæ‰“å°æ‰€æœ‰ Variable-Range MTRR ä¿¡æ¯ã€‚å…¶æ‰“å°æ•ˆæœå¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000182.png)

> [mtrr_attrib_to_str](#D30010)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30008">get_fixed_ranges</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000178.png)

get_fixed_ranges() å‡½æ•°ç”¨äºè¯»å– Fixed-Range MTRR ç»´æŠ¤çš„ä¿¡æ¯ã€‚å‚æ•° frs æŒ‡å‘ä¸€å—å­˜å‚¨ Fixed-Range MTRR ä¿¡æ¯çš„å†…å­˜ï¼Œå…¶ä½¿ç”¨ mtrr_type è¿›è¡Œå®šä¹‰ã€‚å‡½æ•°é¦–å…ˆåœ¨ 377 è¡Œä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆæŒ‰ 32bit çš„ä½å®½æŒ‡å‘ frs, æ¥ç€å‡½æ•°åœ¨ 342 è¡Œè°ƒç”¨ rdmsr() å‡½æ•°å°† MSR_MTRRfix64K_00000 å¯„å­˜å™¨çš„å€¼å­˜å‚¨åœ¨ frs çš„ç¬¬ä¸€ä¸ª 32 bit åœ°å€å’Œç¬¬äºŒä¸ª 32 bit åœ°å€ä¸Šï¼Œæ¥ç€é‡‡ç”¨åŒæ ·çš„æ–¹æ³•å°†å‰©ä¸‹çš„ Fixed-Range MTRR å¯„å­˜å™¨çš„ä¿¡æ¯å†™å…¥åˆ° frs é‡Œé¢ã€‚

> [Fixed-Range MTRR Register](https://biscuitos.github.io/blog/Register/)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30007">MTRRphysMask_MSR</span>

{% highlight bash %}
#define MTRRphysMask_MSR(reg) (0x200 + 2 * (reg) + 1)
{% endhighlight %}

MTRRphysMask_MSR() å®ç”¨äºè·å¾— MTRR æœºåˆ¶çš„ç¬¬ n ä¸ª IA32_MTRR_PHYSMASKn å¯„å­˜å™¨ã€‚å‚æ•° reg è¡¨ç¤º IA32_MTRR_PHYSMASKn å¯„å­˜å™¨çš„ç´¢å¼•ã€‚åœ¨ X86 æ¶æ„ä¸­ï¼Œç¬¬ä¸€ä¸ª IA32_MTRR_PHYSMASKn å¯„å­˜å™¨çš„åœ°å€ä¸º 0x201, ç”±äº IA32_MTRR_PHYSBASEn ä¸ IA32_MTRR_PHYSMASKn æˆå¯¹å­˜åœ¨ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ª IA32_MTRR_PHYSMASKn åˆ™åœ°å€ä¸Šç›¸å·® 2ã€‚X86 æ”¯æŒçš„ IA32_MTRR_PHYSMASKn å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30006">MTRRphysBase_MSR</span>

{% highlight bash %}
#define MTRRphysBase_MSR(reg) (0x200 + 2 * (reg))
{% endhighlight %}

MTRRphysBase_MSR() å®ç”¨äºè·å¾— MTRR æœºåˆ¶çš„ç¬¬ n ä¸ª IA32_MTRR_PHYSBASEn å¯„å­˜å™¨ã€‚å‚æ•° reg è¡¨ç¤º IA32_MTRR_PHYSBASEn å¯„å­˜å™¨çš„ç´¢å¼•ã€‚åœ¨ X86 æ¶æ„ä¸­ï¼Œç¬¬ä¸€ä¸ª IA32_MTRR_PHYSBASEn å¯„å­˜å™¨çš„åœ°å€ä¸º 0x200, ç”±äº IA32_MTRR_PHYSBASEn ä¸ IA32_MTRR_PHYSMASKn æˆå¯¹å­˜åœ¨ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ª IA32_MTRR_PHYSBASEn åˆ™åœ°å€ä¸Šç›¸å·® 2ã€‚X86 æ”¯æŒçš„ IA32_MTRR_PHYSBASEn å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000175.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30005">get_mtrr_var_range</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000177.png)

get_mtrr_var_range() å‡½æ•°ç”¨äºä¸€ä¸ª Variable-Range MTRR å¯¹åº”çš„ IA32_MTRR_PHYSBASEn/IA32_MTRR_PHYSMASKn å¯„å­˜å™¨å¯¹ä¿¡æ¯ã€‚å‚æ•° index ç”¨äºæŒ‡æ˜å¯„å­˜å™¨å¯¹çš„åºå·ï¼Œvr å‚æ•°åˆ™ç”¨äºå­˜å‚¨ä¸€ä¸ª Variable-range MTRR ä¿¡æ¯. å‡½æ•°é€šè¿‡è°ƒç”¨ MTRRphysBase_MSR() å‡½æ•°è·å¾— index å¯¹åº”çš„ IA32_MTRR_PHYSBASEn å¯„å­˜å™¨åœ°å€ï¼ŒåŒç† MTRRphysMask_MSR() å‡½æ•°è·å¾— index å¯¹åº”çš„ IA32_MTRR_PHYSMASKn å¯„å­˜å™¨åœ°å€ï¼Œæ¥ç€åœ¨é€šè¿‡è°ƒç”¨ rdmsr() å‡½æ•°è¯»å–å¯¹åº”çš„ MSR å¯„å­˜å™¨çš„å€¼ï¼Œå¹¶å­˜å‚¨åœ¨ struct mtrr_var_range æ•°æ®ç»“æ„é‡Œ.

> [MTRRphysBase_MSR](#D30006)
>
> [MTRRphysMask_MSR](#D30007)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D201">mtrr_state</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000145.png)

mtrr_state å…¨å±€å˜é‡ç”¨äºç»´æŠ¤å½“å‰ç³»ç»Ÿæ”¯æŒ MTRR æœºåˆ¶çš„çŠ¶æ€ä¿¡æ¯ã€‚ä»è¯¥å˜é‡å¯ä»¥è·å¾— fixed-Range Register å’Œ Variable-Fixed Register çš„ä¿¡æ¯ï¼Œä»¥åŠ MTRR æœºåˆ¶æ˜¯å¦å¯ç”¨ï¼Œæ˜¯å¦åŒ…å« Fixed-Range çš„ä¿¡æ¯ï¼Œæœ€åè¿˜åŒ…å«äº† MTRR æœºåˆ¶ä½¿ç”¨çš„é»˜è®¤ memory typeã€‚

> [struct mtrr_state_type](#D102)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D102">mtrr_state_type</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000144.png)

struct mtrr_state_type æ•°æ®ç»“æ„ç”¨äºæè¿°ç³»ç»Ÿ MTRR æœºåˆ¶çš„æ•´ä½“ç»“æ„ã€‚åœ¨ MTRR ä¸­ä¸€å…±å­˜åœ¨ä¸¤ç±»å¯„å­˜å™¨ï¼Œä¸€ç±»æ˜¯ Fixed-Range Register, å¦å¤–ä¸€ç±»åˆ™æ˜¯ Variable-Range Register, å†…æ ¸ä½¿ç”¨ struct mtrr_state_type æ•°æ®æ¥ç»´æŠ¤ MTRR æ¶‰åŠçš„å¯„å­˜å™¨çŠ¶æ€. 

###### var_ranges

var_ranges[] æ•°ç»„åŒ…å«äº† MTRR_MAX_VAR_RANGES ä¸ªæˆå‘˜ï¼Œæ¯ä¸ªæˆå‘˜é€šè¿‡ struct mtrr_var_range æ•°æ®ç»“æ„è¿›è¡Œæè¿°ï¼Œsruct mtrr_var_range æ•°æ®ç»“æ„æè¿°äº†ä¸€ä¸ª Variable-Range Register å¯¹ï¼Œè¯¥å¯„å­˜å™¨å¯¹åŒ…å«äº†ä¸¤ä¸ªå¯„å­˜å™¨ IA32_MTRR_PHYSBASEn å’Œ IA32_MTRR_PHYSMASKnï¼Œ æ•°ç»„åŒ…å«äº† MTRR_MAX_VAR_RANGES ä¸ªæˆå‘˜ï¼Œå› æ­¤å¯ä»¥çŸ¥é“å½“å‰ç³»ç»Ÿæ”¯æŒçš„æœ€å¤§ Variable-Range Register çš„æ•°é‡ä¸º MTRR_MAX_RANGES ä¸ª.

###### fixed_ranges

fixed_ranges[] æ•°ç»„åˆ™åŒ…å«äº† MTRR_NUM_FIXED_RANGES ä¸ªæˆå‘˜ï¼Œå› æ­¤å¯ä»¥çŸ¥é“å½“å‰ç³»ç»Ÿæ”¯æŒçš„æœ€å¤§ Fixed-Range Register çš„æ•°é‡ä¸º MTRR_NUM_FIXED_RANGES ä¸ªï¼Œfixed_ranges[] æ•°ç»„åªç»´æŠ¤äº† Fixed-Range çš„ memory type ä¿¡æ¯ã€‚

###### enable/have_fied

æˆå‘˜ **enable** ç”¨äºæŒ‡æ˜å½“å‰ç³»ç»Ÿæ˜¯å¦æ”¯æŒ MTRR æœºåˆ¶; æˆå‘˜ **have_fixed** ç”¨äºæŒ‡æ˜ MTRR æœºåˆ¶æ˜¯å¦æ”¯æŒ Fixed-Range å¯„å­˜å™¨

###### def_type

def_type æˆå‘˜ç”¨äºæŒ‡æ˜é»˜è®¤çš„ memory type ä¿¡æ¯. ç›®å‰ MTRR æ”¯æŒçš„ memory type å¦‚ä¸‹:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

> [struct mtrr_var_range](#D100)
>
> [mtrr_type](#D101)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D101">mtrr_type</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000142.png)

mtrr_type ç”¨äºæè¿° MTRR å¯„å­˜å™¨æ‰€æè¿°çš„ memory typeã€‚åœ¨ Inte æ¶æ„ä¸­ï¼ŒMTRR å¯„å­˜å™¨ä¸€ç›´å°† memory type ç»´æŠ¤åœ¨å¯„å­˜å™¨çš„æœ€ä½ 8 bit å­—æ®µï¼Œå› æ­¤å†…æ ¸å®šä¹‰äº†ä½å®½ 8 bit çš„ç±»å‹ç”¨äºæè¿° memory type. ç›®å‰ MTRR æœºåˆ¶æ”¯æŒçš„ memory type å¦‚ä¸‹. ä¾‹å¦‚åœ¨ IA32_MTRR_PHYSBASEn å¯„å­˜å™¨ä¸­ï¼Œä½ 8 bit ç”¨æ¥æè¿°æŸæ®µå†…å­˜åŒºåŸŸçš„ memory type.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000143.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000149.png)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D100">struct mtrr_var_range</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000140.png)

struct mtrr_var_range æ•°æ®ç»“æ„ç”¨äºè¡¨ç¤ºä¸€ä¸ª Variable-Range Register å¯¹çš„å€¼ã€‚ä¸€ä¸ª Variable-Range Register å¯¹åŒ…å«ä¸¤ä¸ª 64 ä½çš„ MSR å¯„å­˜å™¨ï¼Œåˆ†åˆ«ä¸º IA32_MTRR_PHYSBASEn å¯„å­˜å™¨å’Œ IA32_PHYSMASKn å¯„å­˜å™¨ï¼Œå¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000141.png)

base_lo æˆå‘˜ç”¨äºè¡¨ç¤º IA32_MTRR_PHYSBASEn çš„ä½ 32 ä½å€¼ï¼Œè€Œ base_hi æˆå‘˜åˆ™è¡¨ç¤º IA32_MTRR_PHYSBASEn çš„é«˜ 32 ä½å€¼. mask_lo æˆå‘˜è¡¨ç¤º IA32_MTRR_PHYSMASKn çš„ä½ 32 ä½å€¼ï¼Œè€Œ mask_hi æˆå‘˜è¡¨ç¤º IA32_MTRR_PHYSMASKn çš„é«˜ 32 ä½å€¼.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30004">use_intel</span>

{% highlight bash %}
#define use_intel()     (mtrr_if && mtrr_if->use_intel_if == 1)
{% endhighlight %}

use_intel() å‡½æ•°ç”¨äºåˆ¤æ–­å½“å‰ç³»ç»Ÿä½¿ç”¨çš„ MTRR æœºåˆ¶æ¥è‡ª Intel æ¶æ„. ç³»ç»Ÿç»´æŠ¤äº†ä¸€ä¸ª MTRR æ“ä½œå‡½æ•°é›†åˆï¼Œå…¶ä¸­ use_intel_if å‚æ•°ä¸º 1 æ—¶è¡¨ç¤ºå½“å‰ MTRR æœºåˆ¶æ¥è‡ª Intel.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30003">mtrr_enabled</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000139.png)

mtrr_enabled() å‡½æ•°ç”¨äºæŒ‡æ˜å½“å‰ç³»ç»Ÿæ˜¯å¦æ”¯æŒ MTRR æœºåˆ¶. å†…æ ¸ä½¿ç”¨éå† \_\_mtrr_enabled æ ‡ç¤ºç³»ç»Ÿæ˜¯å¦æ”¯æŒ MTRR æœºåˆ¶ï¼Œå½“è¯¥å˜é‡ä¸º trueï¼Œé‚£ä¹ˆç³»ç»Ÿæ”¯æŒ MTRR æœºåˆ¶ï¼Œåä¹‹ä¸æ”¯æŒ.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D200">mtrr_usage_table</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000138.png)

{% highlight bash %}
#define MTRR_MAX_VAR_RANGES 256

unsigned int mtrr_usage_table[MTRR_MAX_VAR_RANGES];
{% endhighlight %}

mtrr_usage_table[] æ•°ç»„ç”¨äºè®°å½•ç³»ç»Ÿä½¿ç”¨ Fixed-Range MTRRs çš„æƒ…å†µï¼Œå†…æ ¸æ”¯æŒæœ€å¤š MTRR_MAX_VAR_RANGES ä¸ª Fixed-Range çš„ MTRRs. ç”±äº Fixed-Range MTRRs æè¿°ç‰¹å®šçš„åœ°å€èŒƒå›´ï¼Œmtr_usage_table[] æ•°ç»„æŒ‰åœ°å€çš„å¤§å°æŒ‰é¡ºåºå¯¹åº”åˆ° Fixed-Range MTRRs ä¸Šã€‚å½“ç³»ç»Ÿä½¿ç”¨åˆ°æŒ‡å®šçš„ Fixed-Range MTRRs, é‚£ä¹ˆå°±å°†å¯¹åº”çš„ mtrr_usage_table[] æ•°ç»„æˆå‘˜è®¾ç½®ä¸º 1ï¼Œåä¹‹ 0 è¡¨ç¤ºä¸ä½¿ç”¨.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30002">init_table</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000136.png)

init_table() å‡½æ•°ç”¨äºè®¾ç½® mtrr_usage_table[] æ•°ç»„å¯¹åº”çš„ Fixed-Range MTRRs æˆå‘˜ã€‚å‡½æ•°é¦–å…ˆåœ¨ 142 è¡Œé€šè¿‡ num_var_ranges å˜é‡è·å¾—å½“å‰ç³»ç»Ÿæ”¯æŒçš„ Fixed-Range MTRRs çš„æ•°é‡ï¼Œç„¶åå°†å¯¹åº”çš„ mtrr_usage_table[] æ•°ç»„æˆå‘˜è®¾ç½®ä¸º 1ï¼Œä»¥æ­¤è¡¨ç¤ºç³»ç»Ÿå¯ä½¿ç”¨çš„ Fixed-Range MTRRs çš„æ•°é‡ã€‚

> [mtrr_usage_table](#D200)

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

---------------------------------------------

#### <span id="D30001">set_num_var_ranges</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000134.png)

set_num_var_ranges() å‡½æ•°ç”¨äºè·å¾—ç³»ç»Ÿæ”¯æŒçš„å›ºå®š MTRR å¯„å­˜å™¨æ•°é‡ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ num_var_ranges å˜é‡é‡Œã€‚åœ¨ Intel æ¶æ„ä¸­ï¼Œç³»ç»ŸåŒ…å«çš„å›ºå®š MTRR å¯„å­˜å™¨æ•°é‡å­˜å‚¨åœ¨ IA32_MTRRCAP Register é‡Œï¼Œå¦‚ä¸‹å›¾:

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/HK000135.png)

åœ¨ IA32_MTRRCAP MSR å¯„å­˜å™¨ä¸­ [0:7] å­—æ®µå­˜å‚¨äº†ç³»ç»Ÿæ‰€æ”¯æŒçš„å›ºå®š MTRR å¯„å­˜å™¨çš„æ•°é‡ï¼Œå› æ­¤åœ¨å‡½æ•° set_num_var_ranges() ä¸­ï¼Œå‡½æ•°è°ƒç”¨ rdmsr() å‡½æ•°è¯»å–äº† MSR_MTRRcap å¯„å­˜å™¨çš„å€¼ï¼Œå¹¶å°†è¯¥å¯„å­˜å™¨çš„ä½ 32 ä½å­˜å‚¨åœ¨ config å˜é‡é‡Œï¼Œæœ€åå‡½æ•°åœ¨ 135 è¡Œè·å¾— [0:7] å­—æ®µçš„å€¼ï¼Œå¹¶å­˜å‚¨åœ¨å˜é‡ num_var_ranges é‡Œ.

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)


---------------------------------------------

#### <span id="D30000">SIZE_OR_MASK_BITS</span>

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/HK/TH000133.png)

{% highlight bash %}
#define SIZE_OR_MASK_BITS(n)  (~((1ULL << ((n) - PAGE_SHIFT)) - 1))
{% endhighlight %}

SIZE_OR_MASK_BITS å®ç”¨äºè·å¾—ä¸€ä¸ª 64 ä½çš„æ©ç ï¼Œå…¶ä½ [0:n-12] ä½å…¨ä¸º [63:n-13] å…¨ä¸º 1ã€‚è¯¥å®ç”¨äºè·å¾—æŒ‡å®šé•¿åº¦çš„ç‰©ç†åœ°å€å¯¹åº”çš„ IA32_MTRR_PHYSMASKn å’Œ IA32_MTRR_PHYSBASEn çš„æ©ç ï¼Œè¯¥æ©ç ç”¨äºå¾—åˆ° "Address_With_Range AND PhysMask = PhysBase AND PhysMask" ç¬¦åˆæ¡ä»¶çš„æ©ç ä¹‹ä¸€.

{% highlight bash %}
# Physical Address Mask
# Address_With_Range AND PhysMask = PhysBase AND PhysMask
SIZE_OR_MASK(36): 0xffffffffff000000
SIZE_OR_MASK(32): 0xfffffffffff00000
SIZE_OR_MASK(40): 0xfffffffff0000000
{% endhighlight %}

![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)


----------------------------------



![](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/IND000100.png)

-----------------------------------------------

#### <span id="Z0">é™„å½•</span>

> [BiscuitOS Home](https://biscuitos.github.io/)
>
> [BiscuitOS Blog 2.0](https://biscuitos.github.io/blog/BiscuitOS_Catalogue/)
>
> [Linux Kernel](https://www.kernel.org/)
>
> [Bootlin: Elixir Cross Referencer](https://elixir.bootlin.com/linux/latest/source)
>

#### æèµ ä¸€ä¸‹å§ ğŸ™‚

![MMU](https://gitee.com/BiscuitOS_team/PictureSet/raw/Gitee/BiscuitOS/kernel/HAB000036.jpg)
