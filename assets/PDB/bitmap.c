

     struct filename

                              +--------+
                              |  name  |----o
                              +--------+    |
                              |        |    |
                              +--------+    |
                              |        |    |
                              +--------+    |
                              |  iname |----o
                              +--------+    |
                              |        |    |
                              |        |    |
                              |        |<---o
                              |        |
                              |        |
                              |        |
                              |        |
                              |        |
                              +--------+




     struct filename

        original                     New                 original

       +--------+                 +--------+            +--------+
       |  name  |----o            |  name  |----------->|        |
       +--------+    |            +--------+            |        |
       |        |    |            |        |            |        |
       +--------+    |            +--------+            |        |
       |        |    |            |        |            |        |
       +--------+    |            +--------+            |        |
       |  iname |----o   ----->   |  iname |            |        |
       +--------+    |            +--------+            |        |
       |        |    |            |        |            |        |
       |        |    |            |        |            |        |
       |        |<---o            |        |            |        |
       |        |                 |        |            |        |
       |        |                 |        |            |        |
       |        |                 |        |            |        |
       |        |                 |        |            |        |
       |        |                 |        |            |        |
       +--------+                 +--------+            +--------+












 


 full_fds_bits

 +--+--+--+--+---+-+-+-+-+
 |31|30|29|28|...|3|2|1|0|
 +--+--+--+--+---+-+-+-+-+
                    | | |       open_fds
                    | | |       +--+--+--+--+--+--+--+-----+--+--+--+--+--+--+
                    | | o------>|31|30|29|28|27|26|25|.....|05|04|03|02|01|00|
                    | |         +--+--+--+--+--+--+--+-----+--+--+--+--+--+--+
                    | o-------->|63|62|61|60|59|58|57|.....|37|36|35|34|33|32|
                    |           +--+--+--+--+--+--+--+-----+--+--+--+--+--+--+
                    o---------->|95|94|93|92|91|90|89|.....|69|68|67|66|65|64|
                                +--+--+--+--+--+--+--+-----+--+--+--+--+--+--+






    |<- file type ->| <---------------- permission ---------------> |
    +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
    |   |   |   |   | U | G | T | R | W | X | R | W | X | R | W | X |
    +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
                                |<- User  ->|<- Group ->|<- Other ->|









         1M Cma region:

         +----------------------------------------------------------------------------+
    1)   |                                                                            |
         +----------------------------------------------------------------------------+
         | <-------------------------------- Free ----------------------------------> |


         +-------------------------+---+----------------------------------------------+
    2)   |          A              | B |                                              |
         +-------------------------+---+----------------------------------------------+
         | <---------- Used ---------> |


         +-------------------------+---+----------------------------------------------+
    3)   |                         | B |                                              |
         +-------------------------+---+----------------------------------------------+
         | <------- Free --------> |   | <------------------ Free ------------------> |




                               CMA

                               +-------------------------------------------------------------------------------+
                               |                                                                               |
                               |                                                                               |
                               |                                                                               |
                               +-------------------------------------------------------------------------------+
                             

                               +-----------+-----------------------+-------------------------------------------+
                               |           |                       |                                           |
                               |   Small   |       Middle          |                  Large                    |
                               |           |                       |                                           |
                               +-----------+-----------------------+-------------------------------------------+
                             




                               +---+---+---+-------+----+----+----------+-----+-----+-----+-----+-----+-------+
                           1)  | X | X | X |       | XX | XX |          | XXX | XXX | XXX | XXX | XXX |       |
                               +---+---+---+-------+----+----+----------+-----+-----+-----+-----+-----+-------+
                               | <- X area -> |    | <- XX area -> |    | <------------ XXX area -----------> |


                               +---+---+---+------------+----+----------+-----+-----------+-----+-----+-------+
                           2)  | X |   | X |            | XX |          | XXX |           | XXX | XXX |       |
                               +---+---+---+------------+----+----------+-----+-----------+-----+-----+-------+
                               | <- X area -> |    | <- XX area -> |    | <------------ XXX area -----------> |


                               +---+---+---+------------+----+----------+-----+-----+-----+-----+-----+-------+
                           3)  | X | X | X |            | XX |          | XXX | XXX |     | XXX | XXX |       |
                               +---+---+---+------------+----+----------+-----+-----+-----+-----+-----+-------+
                               | <- X area -> |    | <- XX area -> |    | <------------ XXX area -----------> |














start_kernel
 |
 o--> setup_arch
       |
       o--> unflatten_device_tree
       |
       o--> arm_memblock_init
             |
             o--> early_init_fdt_scan_reserved_mem
                   |
                   o--> __fdt_scan_reserved_mem
                   |
                   o--> fdt_init_reserved_mem
                         |
                         o--> __reserved_mem_alloc_size
                         |
                         o--> __reserved_mem_init_node
                               .
                               .--> rmem_cma_setup
                                     |
                                     o--> cma_init_reserved_mem
                                     |
                                     o--> dma_contiguous_set_default


start_kernel
 |
 o--> setup_arch
       |
       o--> parse_early_param
       |     |
       |     o--> early_cma
       |
       o--> arm_memblock_init
             |
             o--> dma_contiguous_reserve
                   |
                   o--> dma_contiguous_reserve_area
                         |
                         o--> cma_declare_contiguous
                         |     |
                         |     o--> memblock_alloc_range
                         |     |
                         |     o--> cma_init_reserved_mem
                         |
                         o--> dma_contiguous_early_fixup



make menuconfig

start_kernel
 |
 o--> setup_arch
       |
       o--> arm_memblock_init
             |
             o--> dma_contiguous_reserve
                   |
                   o--> dma_contiguous_reserve_area
                         |
                         o--> cma_declare_contiguous
                         |     |
                         |     o--> memblock_alloc_range
                         |     |
                         |     o--> cma_init_reserved_mem
                         |
                         o--> dma_contiguous_early_fixup






start_kernel
 |
 o--> setup_arch
       |
       o--> paging_init
             |
             o--> dma_contiguous_remap




core_initcall
 |
 o--> cma_init_reserved_areas
       |
       o--> cma_activate_area
             |
             o--> kzalloc
             |
             o--> init_cma_reserved_pageblock
                   |
                   o--> __ClearPageReserved
                   |
                   o--> set_page_count
                   |
                   o--> set_pageblock_migratetype
                   |
                   o--> set_page_refcounted
                   |
                   o--> __free_pages
                   |
                   o--> adjust_managed_page_count




       +----------+-------------+------------------------+-------------+-----------------+
       | Kernel   |             |                        |             |                 |
       |  .data   | Free Memory |          CMA           | Free Memory | Reserved Memory |
       |  .code   |             |                        |             |                 |
       +----------+-------------+------------------------+-------------+-----------------+



       o------------------------------------------------------------------------------------------------------------o
       |                                                                                                            |
       |                                                                                                            V
       |                                                                                                    | <- end_offset ->|
       |        | <----------------------------------------------- map_size ------------------------------------------------> |
       |        +----+--------------------------------------------------------------------------------------+-----------------+
       |        |    |                                                                                      |                 |
       |        |    |                                                                                      |                 |
       |        |    |                                                                                      |                 |
       |        +----+--------------------------------------------------------------------------------------+-----------------+
       |        |<-> A
       |          A  |
       |          |  | Aligned_addr
       |  o-------o  o-----------------------------o
       |  |                                        |
       |  |     pcpu_chunk                         |
       |  |     +--------------------+             |                 struct pcpu_block_md
       |  |     |                    |             |                 +-------------------+
       |  |     +--------------------+             |                 |    contig_hint    |
       |  o-----|    start_offset    |             |                 +-------------------+
       |        +--------------------+             |                 |     right_free    |
       o--------|     end_offset     |             |                 +-------------------+
                +--------------------+             |                 |     left_free     |
                |      base_addr     |-------------o                 +-------------------+
                +--------------------+                               |     first_free    |----o
                |                    |                               +-------------------+    |
                +--------------------+                               | contig_hint_start |    |
                |    md_blocks[0]    |------------------------------>+-------------------+    |
                +--------------------+                                                        |
                |    ............    |                                                        |
                +--------------------+                                                        |
                |    md_blocks[n]    |                                                        |
                +--------------------+                                                        |
                |                    |                                                        |
                +--------------------+                                                        |
                |    contig_bits     |---> (map_size / PCPU_MIN_ALLOC_SIZE)                   |
                +--------------------+                                                        |
                |     free_bytes     |---> (map_size / PCPU_MIN_ALLOC_SIZE)                   |
                +--------------------+                                                        |
                |     first_bit      |--------------------------------o                       |
                +--------------------+                                |         <-- left_free | righ_free -->
                |                    |                                V contig_hint_start     V
                +--------------------+                              +----------------------------------------------------------+
                |     alloc_map      |----------------------------> |                        alloc BITMAP                      |
                +--------------------+                              +----------------------------------------------------------+
                |     bound_map      |----------------------------> |                        bound BITMAP                      |
                +--------------------+                              +----------------------------------------------------------+
                |                    |
                +--------------------+
                |                    |
                +--------------------+                              +---------------------------------------+
                |    populated[0]    |----------------------------> |         Populate Page BITMAP          |
                +--------------------+                              +---------------------------------------+
                |    populated[1]    |
                +--------------------+
                |    ............    |
                +--------------------+
                |    populated[n]    |
                +--------------------+





           
                pcpu_alloc_info
                +-----------+
                |           |
                |           |
                |           |
                |           |
                |           |
                |           |
                |           |
                |           |
                |           |
                +-----------+                pcpu_group_info
                | groups[0] |--------------->+-------------+
                +-----------+                |   nr_units  |
                | groups[1] |                +-------------+
                +-----------+                | base_offset |
                | ......... |                +-------------+
                +-----------+                |  cpu_map[0] |----------->+---------------+
                | groups[n] |                +-------------+            |               |
                +-----------+                |  cpu_map[1] |            |               |
                                             +-------------+            |               |
                                             | ........... |            |               |
                                             +-------------+            |               |
                                             |  cpu_map[n] |            |               |
                                             +-------------+            |               |
                                                                        |               |
                                                                        |               |
                                                                        |               |
                                                                        |               |
                                                                        +---------------+











     pcpu_chunk
     +--------------------+
     |                    |
     +--------------------+
     |                    |
     +--------------------+
     |                    |
     +--------------------+
     |                    |
     +--------------------+
     |                    |
     +--------------------+
     |                    |
     +--------------------+
     |    populated[0]    |
     +--------------------+
     |    populated[1]    |
     +--------------------+
     |    ............    |
     +--------------------+
     |    populated[n]    |
     +--------------------+



     pcpu_slot_list
     +--------------+
     | pcpu_slot[0] |
     +--------------+
     | pcpu_slot[1] |
     +--------------+
     | pcpu_slot[2] |
     +--------------+
     | pcpu_slot[3] |
     +--------------+
     | pcpu_slot[4] |
     +--------------+
     | pcpu_slot[5] |
     +--------------+
     | pcpu_slot[6] |
     +--------------+
     | pcpu_slot[7] |
     +--------------+
     | pcpu_slot[8] |
     +--------------+
     | pcpu_slot[9] |
     +--------------+
     | pcpu_slot[a] |
     +--------------+
     | pcpu_slot[b] |
     +--------------+
     | pcpu_slot[c] |
     +--------------+
     | pcpu_slot[d] |
     +--------------+
     | pcpu_slot[e] |
     +--------------+
     | pcpu_slot[f] |
     +--------------+



    
         Linux Memory Allocator 
         Life Cycle


                                                                                                       +-----------------------
         +----------+                                                                            o---->| DMA
         |          |                                                                            |     +-----------------------
         |          |--------------------------------------------------------------------------->|
         |          |                                                                            |     +-----------------------
         |          |                                                                            o---->| CMA
         |          |                                                                                  +-----------------------
         |          |                                                                       VMALLOC    +-----------------------
         |          |      +----------------------------------------------------------------(+)------->| PERCPU-vm
         | MEMBLOCK |----->| PERCPU                                                                    +-----------------------
         |          |      +----------------------------------------------------------------(+)------->| PERCPU-km 
         |          |                                                                        |         +-----------------------
         |          |               +------------------------------------------------------------------------------------------
         |          |-------------->| Buddy Memory 
         |          |               +------------------------------------------------------------------------------------------
         |          |                    |           
         |          |                    |                                  +--------------------------------------------------
         |          |                    |         +----------------------->| Kmem_cache
         |          |                    o-------->| SLAB/SLUB/SLOB         +--------------------------------------------------
         +----------+                    |         +----------------------->| Kmalloc
                                         |                                  +--------------------------------------------------
                                         |                                         |      +------------------------------------
                                         o----------------------------------------(+)---->| VMALLOC
                                         |                                                +------------------------------------
                                         |
                                         |              +----------------------------------------------------------------------
                                         o------------->| FIXMAP 
                                         |              +----------------------------------------------------------------------
                                         |                    |
                                         |                    |       +--------------------------------------------------------
                                         o-------------------(+)----->| KMAP
                                                                      +--------------------------------------------------------


  
    Linux Virtual Address


    ERROR AREA   Userspace                                                              Kernel Space
     |<--->| <---------------> |                  | <-------------------------------------------------------------------------------------------> |
     +----------------------------------+---------+----+-------+--+--------------+-----------------+-----+------------------+--+------------+--+--+
     |                         |        |         |    |       |  |              |                 |     |                  |  |            |  |  |
     |                         |        |  PKMAP  |    |       |  | Kernel Image |                 |     |   VMALLOC AREA   |  |   FIXMAP   |  |  |
     |                         |        |         |    |       |  |              |                 |     |                  |  |            |  |  |
     +-------------------------+--------+---------+----+-------+--+--------------+-----------------+-----+------------------+--+------------+--+--+
                               A        A         A    A <---> |  A              A <- lowmemory -> | <-> |                  A  A            A  A
                               |        |         |    |   A      |              |                 A  A  A                  |  |            |  |
                               |        |         |    |   |      |              |                 |  |  |                  |  |            |  o-- FIXADDR_END(0xfff00000UL)
                               |        |         |    |   |      |              |                 |  |  |                  |  |            o----- FIXADDR_TOP
     TASK_SIZE ----------------o        |         |    |   |      |              |                 |  |  |                  |  o------------------ FIXADDR_START(0xffc00000UL)
     PKMAP_BASE ------------------------o         |    |   |      |              |                 |  |  |                  |
                              PAGE_OFFSET --------o    |   |      |              |                 |  |  |                  o--- VMALLOC_END(0xff800000UL)
                              swapper_pg_dir ----------o   |      |              |                 |  |  o---------------------- VMALLOC_START
                              Kernel page table directory -o      |              |                 |  o------------------------- VMALLOC_OFFSET(8M)
                              KERNEL_START/_stext ----------------o              |                 o---------------------------- high_memory
                              KERNEL_END/_end -----------------------------------o










	MEMBLOCK
	
	
	                                         struct memblock_region
	                       struct            +------+------+--------+------+
	                       memblock_type     |      |      |        |      |
	                       +----------+      | Reg0 | Reg1 | ...    | Regn |
	                       |          |      |      |      |        |      |
	                       | regions -|----->+------+------+--------+------+
	                       | cnt      |      [memblock_memory_init_regions]
	                       |          |
	 struct           o--->+----------+
	 memblock         |
	 +-----------+    |
	 |           |    |
	 | memory   -|----o
	 | reserved -|----o
	 |           |    |                      struct memblock_region
	 +-----------+    |    struct            +------+------+--------+------+
	                  |    memblock_type     |      |      |        |      |
	                  o--->+----------+      | Reg0 | Reg1 | ...    | Regn |
	                       |          |      |      |      |        |      |
	                       | regions -|----->+------+------+--------+------+
	                       | cnt      |      [memblock_reserved_init_regions]
	                       |          |
	                       +----------+






       PERCPU


               +------+  +------+           +------+  +------+
               |      |  |      |           |      |  |      |
               | CPU0 |  | CPU1 | ......... | CPUn |  | CPUm |
               |      |  |      |           |      |  |      |
               +------+  +------+           +------+  +------+
                  |          |                 |         |    
                  |          |                 |         |
        o---------o   o------o             o---o         |
        |             |                    |             |
        V             V                    V             V
       +-+-----------+-+-----------+------+-+-----------+-+-----------+
       | |           | |           |      | |           | |           |
       | |           | |           | .... | |           | |           |
       | |           | |           |      | |           | |           |
       +-+-----------+-+-----------+------+-+-----------+-+-----------+
       | <- Area0 -> | <- Area1 -> |      | <- AreaN -> | <- AreaM -> |







       Buddy

       Freelist
       +---+    +---+    +---+             +----+    +----+
       | 0 |<-->| 1 |<-->| 2 |<-->.....<-->| 10 |<-->| 11 |
       +---+    +---+    +---+             +----+    +----+
         A        A                                    A
         |        |                                    |
         V        V                                    V
       +---+    +---+                                +---+
       | P |    | P |                                | P |
       +---+    +---+                                +---+
                  A                                    A
                  |                                    |
                  V                                    V
                +---+                                +---+
                | P |                                | P |
                +---+                                +---+
                 
                  


       Buddy and PCP

       +------+
       |      | PCP/Hot   +---+    +---+    +---+          +---+
       | ZONE |---------->| P |<-->| P |<-->| P |<-->..<-->| P |
       |      |           +---+    +---+    +---+          +---+
       +------+


       Freelist
       +---+    +---+    +---+             +----+    +----+
       | 0 |<-->| 1 |<-->| 2 |<-->.....<-->| 10 |<-->| 11 |
       +---+    +---+    +---+             +----+    +----+
         A                                              A
         | PCP/CLOD                                     |
         V                                              V
       +---+                                          +---+
       | P |                                          | P |
       +---+                                          +---+
                                                        A
                                                        |
                                                        V
                                                      +---+
                                                      | P |
                                                      +---+






         Slub


         +------------+            +----------------+
         |            | cpu_slab   |                |
         | kmem_cache |----------->| kmem_cache_cpu | freelist
         |            |            |                |-----o
         +------------+            +----------------+     |
                                                          |
                                                          |
         o------------------------------------------------o
         |
         V <-------------------------- slab page -----------------------------> |
         +-----+-----+-----+-----+-----+-----+-----+----------+-----+-----+-----+
         |     |     |     |     |     |     |     |          |     |     |     |  
         |     |     |     |     |     |     |     | ........ |     |     |     |  
         |     |     |     |     |     |     |     |          |     |     |     |  
         +-----+-----+-----+-----+-----+-----+-----+----------+-----+-----+-----+
              |  A  |  A  |  A |  A  |  A  |  A  |  A       |  A   |  A   |  A |  
              |  |  |  |  |  | |  |  |  |  |  |  |  |       |  |   |  |   |  | |
              o--o  o--o  o--o o--o  o--o  o--o  o--o       o--o   o--o   o--o o----> NULL






         Kmalloc

    
         kmalloc_caches[]
         +-------------+               +-----------+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
         |  kmalloc-8  |-------------->| Slab page |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
         +-------------+               +-----------+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
         | kmalloc-16  |
         +-------------+               +-----------+-----+-----+-----+-----+-----+-----+-----+-----+--+
         | kmalloc-32  |-------------->| Slab page |     |     |     |     |     |     |     |     |  |
         +-------------+               +-----------+-----+-----+-----+-----+-----+-----+-----+-----+--+
         | kmalloc-64  |
         +-------------+
         | kmalloc-128 |
         +-------------+
         | kmalloc-256 |
         +-------------+
         | kmalloc-512 |
         +-------------+
         | kmalloc-1k  |
         +-------------+              +-----------+-----------------+-----------------+--+--+--+--+--+
         | kmalloc-2k  |------------->| Slab page |                 |                 |  |  |  |  |  |
         +-------------+              +-----------+-----------------+-----------------+--+--+--+--+--+
         | kmalloc-4k  |
         +-------------+
         |   ........  |
         +-------------+
         | kmalloc-16M |
         +-------------+
         | kmalloc-32M |
         +-------------+
         | kmalloc-64M |
         +-------------+



         VMALLOC


         +-----------+---------+------+----+------+----+------+-----+----+
         |           |         |      |    |      |    |      |     |    |
         | Userspace | Normall | HOLE | A0 | HOLE | A1 | Hole | ... |    |
         |           |         |      |    |      |    |      |     |    |
         +-----------+---------+------+----+------+----+------+-----+----+
                                      A    | <--> |<-->|            A
                                      |       A     A               |
                      VMALLOC_START---o       |     |               |
                                              |     |               |
                      GUARD_AREA--------------o     |               |
                                                    |               |
                      VMALLOC_AREA------------------o               |
                                                                    |
                      VMALLOC_END-----------------------------------o
       







                           sysfs_root               sysfs_root_kn
                           +-------------+          +-------------+
                           |             |          |             |
                           |             |          |             |
                           |             | kn       |             | rb
                           | kernfs_root |--------->| kernfs_node |---->
                           |             |          |             |
                           |             |          |             |
                           |             |          |             |
                           +-------------+          +-------------+
                                        A
                                        |
                                        | dir.root
                                        o--------------------o
                                                             |
                                                             |
                     +-----------+        +-------------+    |
                     |           | sd     |             |----o
                     |  name: fs |------->|             |
                     |  kobject  |        | kernfs_node |
                     |           |        |             |
                     +-----------+        |             | 
                                          +-------------+






            Filesystem


                            file_system_type        file_system_type        file_system_type
                            +-----------+           +-----------+           +-----------+
                            |           |           |           |           |           |
                            |           | next      |           | next      |           |
            file_systems--->|   XX_fs   |---------->|  rootfs   |---------->|   sysfs   |----> NULL 
                            |           |           |           |           |           |
                            |           |           |           |           |           |
                            +-----------+           +-----------+           +-----------+






             super_block
             +-------------+                   +-------+     +-------+             +-------+
             |             |         i_sb_list |       |     |       |             |       |
             |    s_inodes |<----------------->| inode |<--->| inode |<--->...<--->| inode |
             |             |                   |       |     |       |             |       |
             |             |                   +-------+     +-------+             +-------+
             |             |
             |             |                   +--------+                        +-------+
             |             |                   |        | d_u.d_alias   i_dentry |       |
             |      s_root |------------------>| dentry |----------------------->| inode |
             |             |                   |        |                        |       |
             |             |                   +--------+                        +-------+
             |             |
             |             |                   +-------+
             |             |      mnt_instance |       |
             |    s_mounts |<----------------->| mount |
             |             |                   |       |
             |             |                   +-------+
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             +-------------+



             
             inode
             +-------------+
             |             |
             |             |
             |             |                       +--------+     +--------+             +--------+
             |             | hlist     d_u.d_alias |        |     |        |             |        |
             |   i_dentry  |---------------------->| dentry |<--->| dentry |<--->...<--->| dentry |
             |             |                       |        |     |        |             |        |
             |             |                       +--------+     +--------+             +--------+
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             +-------------+




             dentry_hashtable
             +------------------------------------+------+------------------------------------+
             |                                    | head |                                    |
             +------------------------------------+------+------------------------------------+
                                                      A
                                                      |
             struct dentry                            |
             +-------------+                          |
             |             |                          |                 in_lookup_hashtable
             |      d_hash |--------------------------o                 +-------+------+---------------+
             |             |                                            |       | head |               |
             |             |                                            +-------+------+---------------+
             |             |                                                        A
             |             | d_u.d_in_lookup_hash (Parallel)                        |
             |             |--------------------------------------------------------o
             |             |
             |             |
             |             |                            +--------+
             |             |                     Parent |        |
             |     d_child |<-------------------------->| Dentry |
             |             |                            |        |
             |             |                            +--------+
             |             |
             |             |                            +--------+         +--------+
             |             | (subdir dentry)   d_child  |        |         |        |
             |   d_subdirs |<-------------------------->| dentry |<------->| dentry |
             |             |                            |        |         |        |
             |             |                            +--------+         +--------+
             |             |
             |             |                            +-------+
             |             |                   i_dentry |       |
             | d_u.d_alias |--------------------------->| inode |
             |             |                            |       |
             |             |                            +-------+
             |             |
             |             |        +-------------+
             |             |        |             |
             |        d_sb |------->| super_block |            +------------------+
             |             |        |             |            |                  |
             |             |        |      s_type |----------->| file_system_type |
             |             |        +-------------+            |             name |
             |             |                                   +------------------+
             |             |     
             |             |        Parent
             |             |        +--------+
             |             |        |        |
             |    d_parent |------->| dentry |
             |             |        |        |
             |             |        +--------+
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             +-------------+




__d_rehash



                                                   -------------------------------------------------------------- ---
                                                                          Application                              A
                                                   --------------------------------------------------------------  |
                                                                     A                    |                        |
                                                                     |                    |                        |
                                                                     |                    V                        |
                                                   --------------------------------------------------------------  |
                                                                           LibC/GLibc                              |
                                                   --------------------------------------------------------------  | Userspace
                                                                     A                    |                        |
                                                                     |                    |                        |
                                                                     |                    V                        |
                                                   --------------------------------------------------------------  |
                                                                            syscall()                              |
                                                   --------------------------------------------------------------  |
                                                                     A                    |                        V
                                                                     |                    |                       ---
                                                                     |                    V                        A
                                                   --------------+----------------------+------------------------  |
                                                                 |                      |                          |
                                                           VFS   | Process Manipulation | Device Manipulation      |            
                                                                 |                      |                          | Kernel-Space
                                                   --------------+----------------------+------------------------  |
                                                        A    |                              A      |               |
                                                        |    |                              |      |               |
                                                        |    V                              |      V               |
                                                     -------------                     -----------------           |
                                                       Real FS                            Hard-Device              V
                                                     -------------                     -----------------          ---








                   open 
                     |                                  Userspace
                   ------------------------------------ syscall
                   SYSCALL_DEFINE3(open, ...)           Kernel
                     |
                     o--> do_sys_open
                            |
                            o--> getname
                                   |
                                   o--> getname_flags
              




              struct filename
                                      
                                              ------  +--------+
                                               A  A   |  name  |
                                               |  |   +--------+
                                               |  |   |  uptr  |
              offsetof(struct filename, iname) |  |   +--------+
                                               |  |   | refcnt |
                                               |  |   +--------+
                                               V  |   |  aname |
                                              --- |   +--------+ <-- iname[]
                                                  |   |        |
                                                  |   |        |
                                         PATH_MAX |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  V   |        |
                                                 ---  +--------+





              struct filename
                                      
                                              ------  +--------+
                                               A  A   |  name  |---o
                                               |  |   +--------+   |
                                               |  |   |  uptr  |   |
              offsetof(struct filename, iname) |  |   +--------+   |
                                               |  |   | refcnt |   |
                                               |  |   +--------+   |
                                               V  |   |  aname |   |
                                              --- |   +--------+ <-o iname[] <-- kname
                                                  |   |        |
                                                  |   |        |
                                         PATH_MAX |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  V   |        |
                                                 ---  +--------+





              struct filename
                                      
                                              ------  +--------+
                                               A  A   |  name  |
                                               |  |   +--------+
                                               |  |   |  uptr  |
              offsetof(struct filename, iname) |  |   +--------+
                                               |  |   | refcnt |
                                               |  |   +--------+
                                               V  |   |  aname |
                                              --- |   +--------+ <----- iname[0]
                                                  |   |        |  A
                                                  |   +--------+  | <-- iname[1]
                                                  |   |        |  |
                                         PATH_MAX |   |        |  |
                                                  |   |        |  | EMBEDDED_NAME_MAX
                                                  |   |        |  |
                                                  |   |        |  |
                                                  |   |        |  |
                                                  |   |        |  |
                                                  V   |        |  V
                                                 ---  +--------+ ---



                        
                               
              struct filename

                                                 --- +--------+
                                                  A  |  name  |--------------> kname -----> +--------+ ---
                                                  |  +--------+                             |        |  A
                                                  |  |  uptr  |                             |        |  |
                                                  |  +--------+                             |        |  |
              offsetof(struct filename, iname[1]) |  | refcnt |                             |        |  |
                                                  |  +--------+                             |        |  |
                                                  |  |  aname |                             |        |  |
                                                  |  +--------+ <-- iname[0]                |        |  |
                                                  V  |        |                             |        |  | 
                                                 --- +--------+ <-- iname[1]                |        |  | PATH_MAX
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  V
                                                                                            +--------+ ---









                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> build_open_flags


                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> getname


                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> get_unused_fd_flags
                                                           |
                                                           o--> __alloc_fd



                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> get_unused_fd_flags



                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> getname
                                                           |
                                                           o--> getname_flags



                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> get_unused_fd_flags
                                                           |
                                                           o--> __alloc_fd
                                                                  |
                                                                  o--> expand_files
                                                                         |
                                                                         o--> expand_fdtable
                                                                                |
                                                                                o--> alloc_fdtable




                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> get_unused_fd_flags
                                                           |
                                                           o--> __alloc_fd
                                                                  |
                                                                  o--> expand_files






                                    | <- 2 * max_fds + ((max_fds / BITS_PER_LONG) + (BITS_PER_LONG -1)) / BITS_PER_LONG -> |
                                    +------------------------------------+-----------------------------------+-------------+
                                    |                                    |                                   |             |
                                    |                                    |                                   |             |
                                    |                                    |                                   |             |
                                    +------------------------------------+-----------------------------------+-------------+
                                    A <-- (max_fds / BITS_PER_BYTE ) --> A <-- (max_fds / BITS_PER_BYTE) --> A <---------> |
                                    |                                    |                                   |
                                    |                                    |                                   |
                                    o--- open_fds        close_on_exec---o               full_fds_bits-------o














                        +-------------------+-------------------------+--------------------+
                        | rwlock reader     |                         | rwlock reader      |
                    +---+-------------------+----+--------------------+---------------+----+
                    | rwlock reader              |                    | rwlock reader |
                    +--------------------+-------+--------------------+---------------+---+
                    | rwlock reader      |                            | rwlock reader     |
                    +-----+--------------+-------+--------------------+-------------------+
                          | spin                 | rwlock writer      |
                          +----------------------+--------------------+


                    ------------------------------------------------------------------------------>
                                                                                            Time







     BiscuitOS MMU Physical Space Layout:

     | <--- 3MB ---> | <-- 1M --> | <-------------------- 64MB ------------------> | <----------- 32MB ------------> |
     +---------------+------------+------------------------------------------------+---------------------------------+
     |               |            |                                                |                                 |
     |    ZONE_DMA   | ZONE_DMA32 |                   ZONE_NORMAL                  |           ZONE_HIGHMEM          |
     |               |            |                                                |                                 |
     +---------------+------------+------------------------------------------------+---------------------------------+
     A               A            A                                                A                                 A
     |               |            |                                                |                                 |
     |               |            o-- 0x70400000                                   |                                 |
     |               o-- 0x70300000                                                |                                 |
     o-- PHYS_OFFSET/0X70000000                                                    o-- 0x74400000      0x76400000 ---o
   



     BiscuitOS MMU Physical Space Layout:

     | <---------- 4MB ---------> | <-------------------- 64MB ------------------> | <----------- 32MB ------------> |
     +----------------------------+------------------------------------------------+---------------------------------+
     |                            |                                                |                                 |
     |          ZONE_DMA          |                   ZONE_NORMAL                  |           ZONE_HIGHMEM          |
     |                            |                                                |                                 |
     +----------------------------+------------------------------------------------+---------------------------------+
     A                            A                                                A                                 A
     |                            |                                                |                                 |
     |                            o-- 0x70400000                                   |                                 |
     |                                                                             |                                 |
     o-- PHYS_OFFSET/0X70000000                                                    o-- 0x74400000      0x76400000 ---o
   


     BiscuitOS MMU Virtual Space Layout:


     | <--------------- 68MB ---------------> |      | <------------ 26MB ------------> |      | <--- 2MB ----> |
     +----------------------------------------+------+----------------------------------+------+----------------+------+--------+-+
     |                                        |      |                                  |      |                |      |        | |
     |          Linear Mapping Space          | Hole |           VMALLOC Space          | Hole |   Kmap Space   | Hole | FIXMAP | | 
     |                                        |      |                                  |      |                |      |        | |
     +----------------------------------------+------+----------------------------------+------+----------------+------+--------+-+
     A                                        A      A                                  A      A                A      A        A
     |                                        |      |                                  |      |                |      |        |
     |                                        |      |                                  |      |                |      |        o-- FIXADDR_TOP/0x963FF000
     |                                        |      o-- VMALLOC_START/0x9440A000       |      |                |      o----------- FIXADDR_START/0x96395000
     o-- PAGE_OFFSET/0x90000000               o--------- high_memory/0x94400000         |      |                o------------------ PKMAP_ADDR(LAST_PKMAP)/0x96200000
                                                                                        |      o-- PKMAP_BASE/0x96000000
                                                                                        o--------- VMALLOC_END/0x95E0A000



    Linux Virtual Address




    ERROR AREA   Userspace                                                              Kernel Space
     |<--->| <---------------> |                  | <-------------------------------------------------------------------------------------------> |
     +----------------------------------+---------+----+-------+--+--------------+-----------------+-----+------------------+--+------------+--+--+
     |                         |        |         |    |       |  |              |                 |     |                  |  |            |  |  |
     |                         |        |  PKMAP  |    |       |  | Kernel Image |                 |     |   VMALLOC AREA   |  |   FIXMAP   |  |  |
     |                         |        |         |    |       |  |              |                 |     |                  |  |            |  |  |
     +-------------------------+--------+---------+----+-------+--+--------------+-----------------+-----+------------------+--+------------+--+--+
                               A        A         A    A <---> |  A              A <- lowmemory -> | <-> |                  A  A            A  A
                               |        |         |    |   A      |              |                 A  A  A                  |  |            |  |
                               |        |         |    |   |      |              |                 |  |  |                  |  |            |  o-- FIXADDR_END(0xfff00000UL)
                               |        |         |    |   |      |              |                 |  |  |                  |  |            o----- FIXADDR_TOP
     TASK_SIZE ----------------o        |         |    |   |      |              |                 |  |  |                  |  o------------------ FIXADDR_START(0xffc00000UL)
     PKMAP_BASE ------------------------o         |    |   |      |              |                 |  |  |                  |
                              PAGE_OFFSET --------o    |   |      |              |                 |  |  |                  o--- VMALLOC_END(0xff800000UL)
                              swapper_pg_dir ----------o   |      |              |                 |  |  o---------------------- VMALLOC_START
                              Kernel page table directory -o      |              |                 |  o------------------------- VMALLOC_OFFSET(8M)
                              KERNEL_START/_stext ----------------o              |                 o---------------------------- high_memory
                              KERNEL_END/_end -----------------------------------o










       Bootmem

       +-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |.|.|.| | | | |.|.|.| | | ..... | | | | |.|.|.|.| | ...... | | | | | |.|.|.|.| | | | |.|.|
       +-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       A
       |
       |
       o-- NODE_DATA(0)->bdata->node_bootmem_map

       o-- NODE_DATA(0)->bdata->node_boot_start
       |
       |
       V <-------------------- Physical RAM -----------------> |
       +---------------------------+---------------------------+
       |                           |                           |
       |      meminfo.bank[0]      |      meminfo.bank[1]      |
       |                           |                           |
       +---------------------------+---------------------------+
                                   A
                                   |
                                   |
                                   o-- NODE_DATA(0)->bdata->node_low_pfn















                       start_kernel_bs
                          |
                          o-- setup_arch_bs
                                 |
                                 o-- paging_init_bs
                                        |
                                        o-- bootmem_init_bs



                      start_kernel_bs
                         |
                         o-- setup_per_cpu_areas_bs





                PERCPU Static [Linux 2.6.x]

                +---------+---------+------------------------------------------------------+
                |         |         |                                                      |
                |         | .percpu |                                                      |
                |         |         |                                                      |
                +---------+---------+------------------------------------------------------+
                |         A         A
                |         |         |
                |         |         o-- __per_cpu_end
                |         o------------ __per_cpu_start
                |
                | Bootmem
                |
                V                   | <- __per_cpu_offset -> |
                +---------+---------+------------------------+-------------+---------------+
                |         |         |                        |             |               |
                |         | .percpu |                        | PERCPU AREA |               |
                |         |         |                        |             |               |
                +---------+---------+------------------------+-------------+---------------+



                PERCPU Allocator[Linux 2.6.x]
                             
                struct percpu_data                                  
                +-----------------+               +---------+              +------+
                | ptrs[0]         |-------------->| Data[0] |<-------------| CPU0 |
                +-----------------+               +---------+              +------+
                | ptrs[1]         |-------------->| Data[1] |<-------------| CPU1 |
                +-----------------+               +---------+              +------+
                | .......         |
                +-----------------+               +---------+              +------+
                | ptrs[NR_CPUS-1] |-------------->| Data[n] |<-------------| CPUn |
                +-----------------+               +---------+              +------+
                | blkp            |
                +-----------------+








                struct zone
                +--------------+
                |              |
                +--------------+             +------+      +------+      +------+      +------+
                | free_area[0] | <---------> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ....
                +--------------+             +------+------+------+------+------+      +------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+







                | <- PAGE_SIZE -> | <- PAGE_SIZE -> |                 | <- PAGE_SIZE -> | <- PAGE_SIZE -> |
                +-----------------+-----------------+-----------------+-----------------+-----------------+
                |                 |                 |                 |                 |                 |
                |     Region0     |     Region1     |     .......     |     RegionM     |     RegionN     |
                |                 |                 |                 |                 |                 |
                +-----------------+-----------------+-----------------+-----------------+-----------------+
                A <--- Fram0 ---> | <--- Fram1 ---> |                 | <--- FramM ---> | <--- FramN ---> |
                |
                |
                o-- PHYS_OFFSET: [Start address of RAM]







                PhysAddr:
                32/64                            PAGE_SHIFT                 0
                +--------------------------------+--------------------------+
                |           Page Frame           |                          |
                +--------------------------------+--------------------------+
                                                 | <----- PAGE_SHIFT -----> |





                +----------------------------------------------------------+
                |                        Page Set                          |
                +----------------------------------------------------------+
                                            |
                                            |
                                            V
                +-----------------------------------+ +-------------+ +-------+
                | Page0.Page1.Page2.....Page2^(n-1) | | Page0.Page1 | | Page0 |
                +-----------------------------------+ +-------------+ +-------+



                                         +----------------------+
                                         | Page0.Page1....PageN |
                                         +----------------------+
                                                   |
                                                   | Insert 
                                                   | 
                                                   V
                +----------------+       +----------------------+
                | free_area[m]   | <---> | Page0.Page1....PageN |
                +----------------+       +----------------------+
                | free_area[m+1] |
                +----------------+



                +----------------+       +----------------------+   no-Buddy   +----------------------+
                | free_area[m]   | <---> | Page0.Page1....PageN | <----------> | Page0.Page1....PageN |
                +----------------+       +----------------------+              +----------------------+
                | free_area[m+1] |
                +----------------+



                +----------------+   
                | free_area[m]   | 
                +----------------+       +-----------------------------------------------+
                | free_area[m+1] | <---> | Page0.Page1.....PageN.Page(N+1).........PageM |
                +----------------+       +-----------------------------------------------+





                +---------------------+ ------------------------
       PageSet0 | Page0.Page1...PageN |                 A  A  A
                +---------------------+                 |  |  | Buddy
       PageSet1 | Page0.Page1...PageN |                 |  |  V
                +---------------------+ ----------------|--|----
       PageSet2 | Page0.Page1...PageN |                 |  | Buddy
                +---------------------+                 |  |
       PageSet3 | Page0.Page1...PageN |                 |  V
                +---------------------+ ----------------|---
       PageSet4 | Page0.Page1...PageN |                 |
                +---------------------+                 |
       PageSet5 | Page0.Page1...PageN |                 | Buddy
                +---------------------+                 |
       PageSet6 | Page0.Page1...PageN |                 |
                +---------------------+                 |
       PageSet7 | Page0.Page1...PageN |                 V
                +---------------------+ -----------------



                Buddy-DMA: ZONE_DMA
                +--------------+
                |              |
                +--------------+             +------+      +------+      +------+      +------+
                | free_area[0] | <---------> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ....
                +--------------+             +------+------+------+------+------+      +------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                Buddy-DMA32: ZONE_DMA32
                +--------------+
                |              |
                +--------------+             +------+      +------+      +------+      +------+
                | free_area[0] | <---------> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ....
                +--------------+             +------+------+------+------+------+      +------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                Buddy-Normal: ZONE_NORMAL
                +--------------+
                |              |
                +--------------+             +------+      +------+      +------+      +------+
                | free_area[0] | <---------> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ....
                +--------------+             +------+------+------+------+------+      +------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                Buddy-HighMem: Zone_HighMem
                +--------------+
                |              |
                +--------------+             +------+      +------+      +------+      +------+
                | free_area[0] | <---------> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ....
                +--------------+             +------+------+------+------+------+      +------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+




                
                                +----------+
               ZONE_DMA <-----> | ZONE_DMA |
                                +----------+

                                +------------+        +----------+
               ZONE_DMA32 <---> | ZONE_DMA32 | <----> | ZONE_DMA |
                                +------------+        +----------+

                                +-------------+       +------------+       +----------+
               ZONE_NORMAL <--> | ZONE_NORMAL | <---> | ZONE_DMA32 | <---> | ZONE_DMA |
                                +-------------+       +------------+       +----------+

                                +--------------+      +-------------+      +------------+      +----------+
               ZONE_HigMem <--> | ZONE_HighMem | <--> | ZONE_NORMAL | <--> | ZONE_DMA32 | <--> | ZONE_DMA |
                                +--------------+      +-------------+      +------------+      +----------+






                struct zone
                +--------------+
                |              |
                +--------------+             +-------+      +-------+
                | free_area[0] | <---------> | Page0 | <--> | Page0 | <--> ..
                +--------------+             +-------+-----++-------+-+-----------+      
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+



                struct zone
                +--------------+
                |              |
                +--------------+
                | free_area[0] |
                +--------------+             +-------------+      +-------------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                                                          |
                                                          |
                                                          | 
                                                          V

                struct zone
                +--------------+                                     +-------+
                |              |                                     | Page0 | -----> requestor
                +--------------+             +-------+               +-------+
                | free_area[0] | <---------> | Page1 |
                +--------------+             +-------+-----+   
                | free_area[1] | <---------> | Page0.Page1 | <--> ..
                +--------------+             +-------------+-----------+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+





                struct zone
                +--------------+
                |              |
                +--------------+
                | free_area[0] |
                +--------------+ 
                | free_area[1] | 
                +--------------+ 
                | free_area[2] | 
                +--------------+ 
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                                                          |
                                                          |
                                                          |
                                                          V

                struct zone
                +--------------+                                     +-------+
                |              |                                     | Page0 | -----> requestor
                +--------------+             +-------+               +-------+
                | free_area[0] | <---------> | Page1 |
                +--------------+             +-------+-----+
                | free_area[1] | <---------> | Page0.Page1 | 
                +--------------+             +-------------+-----------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | 
                +--------------+             +-------------------------+
                | .......      |
                +--------------+           
                | free_area[m] | 
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+





                struct zone
                +--------------+                                   +------+
                |              |                                   | Page | <--- Free
                +--------------+                                   +------+
                | free_area[0] | 
                +--------------+            
                | free_area[1] |
                +--------------+
                | free_area[2] |
                +--------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                                                          |
                                                          |
                                                          |
                                                          V


                struct zone
                +--------------+
                |              |
                +--------------+             +-------+
                | free_area[0] | <---------> | Page0 |
                +--------------+             +-------+
                | free_area[1] |
                +--------------+
                | free_area[2] |
                +--------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+






                struct zone
                +--------------+                                     +-------+
                |              |              "Buddy"                | Page0 | <--- Free
                +--------------+             +-------+               +-------+
                | free_area[0] | <---------> | Page1 |
                +--------------+             +-------+-----+
                | free_area[1] | <---------> | Page0.Page1 |
                +--------------+             +-------------+-----------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 |
                +--------------+             +-------------------------+
                | .......      |
                +--------------+
                | free_area[m] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                                                            |
                                                            |
                                                            V

                struct zone
                +--------------+                                   
                |              |                                   
                +--------------+                                      +-------------+
                | free_area[0] |              "Buddy"                 | Page0.Page1 |
                +--------------+             +-------------+          +-------------+
                | free_area[1] | <---------> | Page0.Page1 |
                +--------------+             +-------------+-----------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 |
                +--------------+             +-------------------------+
                | .......      |
                +--------------+
                | free_area[m] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                                                            |
                                                            |
                                                            V

                struct zone
                +--------------+                                  
                |              |                                 
                +--------------+                                  
                | free_area[0] |
                +--------------+
                | free_area[1] |
                +--------------+
                | free_area[2] |
                +--------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+



                struct zone
                +--------------+
                |              |
                +--------------+         +------+      +------+      +------+      +------+
                | Page0List    | <-----> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ..
                +--------------+         +------+      +------+      +------+      +------+
                |              |
                +--------------+


                struct zone
                +--------------+
                |              |
                +--------------+         +------+ 
                | Page0List    | <-----> | Page | 
                +--------------+         +------+ 
                |              |
                +--------------+


                struct zone
                +--------------+
                |              |
                +--------------+         +------+      +------+       N Page       +------+
                | Page0List    | <-----> | Page | <--> | Page | <--> ........ <--> | Page |
                +--------------+         +------+      +------+                    +------+
                |              |
                +--------------+





                struct zone
                +--------------+
                |              |
                +--------------+         +------+      +------+      +------+      +------+
                | Page0List    | <-----> | Page | <--> | Page | <--> | Page | <--> | Page |
                +--------------+         +------+      +------+      +------+      +------+
                |              |         | <---------------- M Page --------------------> |
                +--------------+



                struct zone
                +--------------+
                |              |                    | <---------------- M Page --------------------> |
                +--------------+           Hot      +------+      +------+      +------+      +------+
                |              |      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                +--------------+      |             +------+      +------+      +------+      +------+
                | Page0List    | -----+              
                +--------------+      |    Cold     +------+      +------+      +------+      +------+
                                      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                                                    +------+      +------+      +------+      +------+
                                                    | <---------------- M Page --------------------> |







                struct zone
                +--------------+
                |              |                    | <---------------- M Page --------------------> |
                +--------------+           Hot      +------+      +------+      +------+      +------+
                |              |      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                +--------------+      |             +------+      +------+      +------+      +------+
                | Page0List    | -----+        
                +--------------+      |    Cold     +------+      +------+      +------+      +------+
                | Page1List    |      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                +--------------+                    +------+      +------+      +------+      +------+
                | Page2List    |                    | <---------------- M Page --------------------> |
                +--------------+
                | ............ |                    | <---------------- M Page --------------------> |
                +--------------+           Hot      +------+      +------+      +------+      +------+
                | PageMList    |      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                +--------------+      |             +------+      +------+      +------+      +------+
                | PageNList    | -----+        
                +--------------+      |    Cold     +------+      +------+      +------+      +------+
                                      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                                                    +------+      +------+      +------+      +------+
                                                    | <---------------- M Page --------------------> |










                               start_kernel_bs
                                  |
                                  o-- setup_arch_bs
                                  |      |
                                  |      o-- paging_init_bs
                                  |             |
                                  |             o-- free_area_init_node_bs
                                  |                    |
                                  |                    o-- calculate_zone_totalpages_bs
                                  |                    |
                                  |                    o-- alloc_node_mem_map_bs
                                  |                    |
                                  |                    o-- free_area_init_core_bs
                                  |                           |
                                  |                           o-- memmap_init_bs
                                  |                           |
                                  |                           o-- zone_init_free_lists_bs
                                  |
                                  o-- build_all_zonelists_bs
                                  |      |
                                  |      o-- build_zonelists_bs
                                  |
                                  o-- mem_init_bs
                                         |
                                         o-- free_all_bootmem_node_bs
                                                |
                                                o-- free_all_bootmem_core_bs




                struct zone
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                |                    |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[0]         |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                | pageset[1]         |            o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ... 
                +--------------------+                             +--------+      +------+      +------+      +------+
                | pageset[2]         |
                +--------------------+
                | pageset[3]         |
                +--------------------+
                | .................. |
                +--------------------+
                | pageset[NR_CPUS-3] |
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-2] |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ... 
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-1] |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                                                  o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                                                                   +--------+      +------+      +------+      +------+








                PCP: ZONE_DMA
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                |                    |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[0]         |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                | pageset[1]         |            o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+                             +--------+      +------+      +------+      +------+
                | pageset[2]         |
                +--------------------+
                | pageset[3]         |
                +--------------------+
                | .................. |
                +--------------------+
                | pageset[NR_CPUS-3] |
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-2] |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-1] |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                                                  o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                                                                   +--------+      +------+      +------+      +------+


                PCP: ZONE_DMA32
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                |                    |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[0]         |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                | pageset[1]         |            o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+                             +--------+      +------+      +------+      +------+
                | pageset[2]         |
                +--------------------+
                | pageset[3]         |
                +--------------------+
                | .................. |
                +--------------------+
                | pageset[NR_CPUS-3] |
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-2] |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-1] |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                                                  o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                                                                   +--------+      +------+      +------+      +------+





                PCP: ZONE_NORMAL
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                |                    |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[0]         |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                | pageset[1]         |            o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+                             +--------+      +------+      +------+      +------+
                | pageset[2]         |
                +--------------------+
                | pageset[3]         |
                +--------------------+
                | .................. |
                +--------------------+
                | pageset[NR_CPUS-3] |
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-2] |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-1] |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                                                  o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                                                                   +--------+      +------+      +------+      +------+



                PCP: ZONE_HIGHMEM
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                |                    |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[0]         |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                | pageset[1]         |            o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+                             +--------+      +------+      +------+      +------+
                | pageset[2]         |
                +--------------------+
                | pageset[3]         |
                +--------------------+
                | .................. |
                +--------------------+
                | pageset[NR_CPUS-3] |
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-2] |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-1] |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                                                  o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                                                                   +--------+      +------+      +------+      +------+









                    
                    A
                    |
                    |                                     free             
                    |                                     .
               high |-------------------------------------.-------------
                    |..                                 .
                    |  .                  ...          .   ...
                    |   .      ......        .        .       .
                    |    .    .      .        .      .         ...
                    |     ....        .        ......
                    |                  .
                low |-------------------.-------------------------------           
                    |                    .
                    |                    alloc
                    |
                    +-------------------------------------------------->






                    vmalloc_bs()
                       |
                       o--> __vmalloc_bs
                               |
                               o--> get_vm_area_bs
                               |       |
                               |       o--> __get_vm_area_bs
                               |        
                               o--> __vmalloc_area_bs
                                       |
                                       o--> alloc_page_bs
                                       |
                                       o--> map_vm_area_bs
                                               |
                                               o--> vmap_pud_range_bs
                                                       |
                                                       o--> vmap_pmd_range_bs
                                                               |
                                                               o--> vmap_pte_range_bs
                                                                       |
                                                                       o--> set_pte_at_bs       






                    vfree_bs()
                       |
                       o--> __vunmap_bs
                               |
                               o--> remove_vm_area_bs
                               |       |
                               |       o--> __remove_vm_area_bs
                               |              |
                               |              o--> unmap_vm_area_bs
                               |                      |
                               |                      o--> vunmap_pud_range_bs
                               |                              |
                               |                              o--> vunmap_pmd_range_bs
                               |                                      |
                               |                                      o--> vunmap_pte_range_bs
                               |                                              |
                               |                                              o--> ptep_get_and_clear_bs
                               |
                               o--> __free_page_bs






                                              VMALLOC_START                               VMALLOC_END
                                              |                                           |
                                       +------+--+----+---+----+---+----+----------+----+-+----------+
                                       |      |  |    |   |    |   |    |          |    | |          |
                                       | .... |  | A0 |   | A1 |   | A2 |          | A3 | |   .....  |
                                       |      |  |    |   |    |   |    |          |    | |          |
                                       +------+--+----+---+----+---+----+----------+----+-+----------+
                                                   A         A        A               A
                                                   |         |        |               |
                                                   |         o-----o  |               |
                       vmlist                      |               |  |               |
                       +--------+      +--------+--o   +--------+--o  o+--------+     o+--------+
                       |        |      |        |      |        |      |        |      |        |
                       +--------+      +--------+      +--------+      +--------+      +--------+
                       |   next |----->|   next |----->|   next |----->|   next |----->|   next |
                       +--------+      +--------+      +--------+      +--------+      +--------+
                       |        |      |        |      |        |      |        |      |        |
                       +--------+      +--------+      +--------+      +--------+      +--------+




                               VMALLOC Virutal Address
                               64/32                                               12                    0
                               +------------+------------+------------+------------+---------------------+
                               | PGD_Offset | PUD_Offset | PMD_Offset | PTE_OFFSET |                     |
                               +------------+------------+------------+------------+---------------------+


                             
                               VMALLOC Virutal Address
                               64/32                                                            12       0
                               +------------+------------+------------+------------+------------+--------+
                               | PGD_Offset | P4D_Offset | PUD_Offset | PMD_Offset | PTE_Offset |        |
                               +------------+------------+------------+------------+------------+--------+






                               pkmap_count[LAST_PKMAP]

                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               | | | | | | | | | | | | | | | | |       | | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |       | | | | | | | | | | | | | | | | | | |
                               |+| | | | | | | | |+| | | | | | | ..... | | | | | | | | | |+|+| | | | | | | |
                               | | | | | | | | | | | | | | | | |       | | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |       | | | | | | | | | | | | | | | | | | |
                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                A                                                                         A
                                |                                                                         |
                                |                                                                         |
                                o-- PKMAP_ADDR(0)                              PKMAP_ADDR(LAST_PKMAP-1) --o







                                kmap_high_bs
                                   |
                                   o--> page_address_bs()
                                   |
                                   o--> map_new_virtual_bs()
                                           |
                                           o--> pkmap_count_bs[]
                                           |
                                           o--> PKMAP_ADDR_BS
                                           |
                                           o--> set_pte_at_bs
                                           |
                                           o--> set_page_address_bs
                                                   |
                                                   o--> page_slot_bs
                                                   |
                                                   o--> list_entry(page_address_pool_bs.next)




                                 kunmap_high_bs()
                                    |
                                    o--> page_address_bs()
                                            |
                                            o--> PKMAP_NR_BS()
                                            |
                                            o--> --pkmap_count[]


                               FIXADDR_TOP                                                                FIXADDR_END
                               |                         | <-FIX_KMAP-> |                                 |
                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | |+| | | | | | | | | | | | .....  | | | | | | | | | | | |+| | |+| | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               A A A A A A A A A A A     A              A                   A A A A A A A
                               | | | | | | | | | | |     |              |                   | | | | | | |
                               | | | | | | | | | | |     |              |                   | | | | | | |
                               | | | | | | | | | | |     |              |                   | | | | | | |
                               | | | | | | | | | | |     |              o-- FIX_KMAP_END    | | | | | | |
                               | | | | | | | | | | |     o----------------- FIX_KMAP_BEGIN  | | | | | | o-- FIX_WP_TEST
                               | | | | | | | | | | |                                        | | | | | o---- FIX_BTMAP_END
                               | | | | | | | | | | |                                        | | | | o------ ...
                               | | | | | | | | | | o-------  FIX_F00F_IDT                   | | | o-------- FIX_BTMAP_BEGIN
                               | | | | | | | | | o---------- FIX_LI_PCIB                    | | o---------- FIX_ACPI_END
                               | | | | | | | | o------------ FIX_LI_PCIA                    | o------------ ...
                               | | | | | | | o-------------- FIX_CO_APIC                    o-------------- FIX_ACPI_BEGIN
                               | | | | | | o---------------- FIX_CO_CPU
                               | | | | | o------------------ FIX_IO_APIC_BASE_END
                               | | | | o-------------------- ...
                               | | | o---------------------- FIX_IO_APIC_BASE_0
                               | | o------------------------ FIX_APIC_BASE
                               | o-------------------------- FIX_VSYSCALL
                               o---------------------------- FIX_HOLE  
                               
                         


                               FIX_KMAP_BEGIN                                                             FIX_KMAP_END
                               |                                                                          |
                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | |+| | | | | | | | | | | | .....  | | | | | | | | | | | |+| | |+| | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               A A A A A A A A A A A A A A A A                                      A A A 
                               | | | | | | | | | | | | | | | |                                      | | |
                               | | | | | | | | | | | | | | | |                                      | | |
                               | | | | | | | | | | | | | | | |                          ----        | | |
                               | | | | | | | | | | | | | | | |                            A         | | o------ KM_SOFTIRQ1  ----
                               | | | | | | | | | | | | | | | |                            |         | o-------- KM_SOFTIRQ0    A
                               | | | | | | | | | | | | | | | |                            .         o---------- KM_IRQ1        |
                               | | | | | | | | | | | | | | | |                            . CPU1                               .
                               | | | | | | | | | | | | | | | |                            .                                    . CPUn
                               | | | | | | | | | | | | | | | o-- KM_SKB_DATA_SOFTIRQ      |                                    .
                               | | | | | | | | | | | | | | o---- KM_SKB_SUNRPC_DATA       V                                    |
                               | | | | | | | | | | | | | o------ KM_BOUNCE_READ         ----                                   V
                               | | | | | | | | | | | | o-------- KM_SOFTIRQ1              A                                  ----
                               | | | | | | | | | | | o---------- KM_SOFTIRQ0              |
                               | | | | | | | | | | o------------ KM_IRQ1                  |
                               | | | | | | | | | o-------------- KM_IRQ0                  |
                               | | | | | | | | o---------------- KM_PTE1                  |
                               | | | | | | | o------------------ KM_PTE0                  | CPU0
                               | | | | | | o-------------------- KM_BIO_DST_IRQ           |
                               | | | | | o---------------------- KM_BIO_SRC_IRQ           |
                               | | | | o------------------------ KM_USER1                 |
                               | | | o-------------------------- KM_USER0                 |
                               | | o---------------------------- KM_SKB_DATA_SOFTIRQ      |
                               | o------------------------------ KM_SKB_SUNRPC_DATA       V
                               o-------------------------------- KM_BOUNCE_READ         ----












                             kmap_atomic_bs()                  kunmap_atomic_bs()
                                |                                 |
                                o-- inc_preempt_count()           o-- dec_preempt_count()
                                |                                 |
                                o-- page_address_bs()             o-- __fix_to_virt_bs()
                                |                                 |
                                o-- __fix_to_virt_bs()            o-- pte_clear_bs()
                                |                                 |
                                o-- set_pte_bs/mk_pte_bs          o-- __flush_tlb_one_bs()
                                |
                                o-- __flush_tlb_one_bs()




                            0                                                                              
                            +---------------+-----------------------------------------------------------------------------+
                            |               |                                                                             |
                            | Request Bytes |                               Waste Bytes                                   |
                            |               |                                                                             |
                            +---------------+-----------------------------------------------------------------------------+
                            | <------------------------------------- PAGE_SIZE -----------------------------------------> |









                                            +--------------------------+
                                            |           CPU            |
                                            |      Register/Cache      |
                                            +--------------------------+
                                                         A
                                                         |
                                                         V
                           +------------------------------------------------------------+
                           |                           Memory                           |
                           +------------------------------------------------------------+
                                   A                     A                  A
                                   |                     |                  |
                                   V                     V                  V
                              +---------+           +--------+          +--------+
                              | SSD/HDD | ........  | CD-ROM | ........ | Floppy |
                              +---------+           +--------+          +--------+




                                                    
                                                    +------------------------------------------------------------------------+
                                                    |                                                                        |
                                                    |                               Memory                                   |
                                                    |                                                                        |
                                                    +------------------------------------------------------------------------+
                                                    A
                                                    |
                                                    |
                                                   (+)-------(+)----------------(+)-------------- Address Bus
                                                              A                  |
                                                              |                  |
                                                              |                  V
                                                         +---------+       +-----------+
                                                         |   CPU   |       | Interrupt |
                                                         +---------+       +-----------+





                                                   32bit-Mechine
                                                   0                                              2^32
                                                   +----------------------------------------------+
                                                   |                                              |                           
                                                   |                                              |                           
                                                   |                                              |                           
                                                   +----------------------------------------------+
 
                                                   64bit-Mechine
                                                   0                                                                             2^64
                                                   +-----------------------------------------------------------------------------+
                                                   |                                                                             |
                                                   |                                                                             |
                                                   |                                                                             |
                                                   +-----------------------------------------------------------------------------+









                                                   0 
                                                   +------------+-+-------------------------------------------------------------+
                                                   |            | |                                                             |
                                                   |            | |               Virtual Space                                 |
                                                   |            | |                                                             |
                                                   +------------+-+-------------------------------------------------------------+
                                                                 |
                                                                 V
                                                   +-----------------------------+
                                                   |            MMU(on)          |
                                                   +-----------------------------+
                                                                 |
                                                                 o--------------------o
                                                                                      |
                                                                                      V 
                                                   +---------------------------------+-+---------+
                                                   |                                 | |         |
                                                   |        Physcial Space           | |         |
                                                   |                                 | |         |
                                                   +---------------------------------+-+---------+





                                                   0
                                                   +------------+-+-------------------------------------------------------------+
                                                   |            | |                                                             |
                                                   |            | |               Physical Space                                |
                                                   |            | |                                                             |
                                                   +------------+-+-------------------------------------------------------------+
                                                                 |
                                                                 V
                                                   +-----------------------------+
                                                   |            MMU(on)          |
                                                   +-----------------------------+
                                                                 |
                                                                 V






                                                                                                                          +-----------------+
                                                   +------------+------------+------------+------------+-------------+    |                 |
                                                   | PGD_OFFSET | PUD_OFFSET | PMD_OFFSET | PTE_OFFSET | PAGE_OFFSET |    +-----------------+
                                                   +------------+------------+------------+------------+-------------+    |                 |
                                                         |               |             |             |             |      +-----------------+
                                                         |               |             |             |             o----->|                 |
                                                         |               |             |             |                    +-----------------+
                                                         |   +--------+  |   +------+  |             |   +-----+          |                 |
                                                         |   |        |  |   |      |  |             |   |     |          +-----------------+
                                                         |   +--------+  |   +------+  |   +-----+   |   +-----+          |                 |
                                                         o-->|        |-(+)->|      |-(+)->|     |->(+)->|     |--------->+-----------------+
                                                             +--------+      +------+      +-----+       +-----+
                                                             | ...... |      |      |      |     |       |     |
                                                     PGTable +--------+      +------+      +-----+       +-----+
                                                                             | .... |      |     |       |     |
                                                                    PUDTable +------+      +-----+       +-----+
                                                                                           | ... |       |     |
                                                                                  PMDTable +-----+       +-----+
                                                                                                         | ... |
                                                                                                PTETable +-----+








                                                   Virtual Address                                                                                        +--------------------+
                                                   64/32                                                                                            0     |                    |
                                                   +------------------+------------------+------------------+------------------+--------------------+     +--------------------+
                                                   |    PGD_OFFSET    |    PUD_OFFSET    |    PMD_OFFSET    |    PTE_OFFSET    |     PAGE_OFFSET    |     |                    |
                                                   +------------------+------------------+------------------+------------------+--------------------+     +--------------------+
                                                       |                      |                      |                      |                     |       |                    |
                                                       |                      |                      |                      |                     |       +--------------------+
                                                       |                      |                      |                      |    +-------------+  o------>|                    | 
                                                       |                      |                      |                      |    | ........... |          +--------------------+
                                                       |                      |                      |                      |    +-------------+          |                    |
                                                       |                      |                      |    +-------------+   o--->|             |--------->+--------------------+
                                                       |                      |                      |    | ........... |        +-------------+
                                                       |                      |                      |    +-------------+        | ........... |
                                                       |                      |    +-------------+   o--->|             |------->+-------------+
                                                       |                      |    | ........... |        +-------------+        PTE Table
                                                       |                      |    +-------------+        | ........... |
                                                       |    +-------------+   o--->|             |------->+-------------+
                                                       |    | ........... |        +-------------+         PUDTable
                                                       |    +-------------+        | ........... |
                                                       o--->|             |------->+-------------+
                                                            +-------------+        PMDTable
                                                            | ........... |
                                                            +-------------+
                                                            PGTable



                                                 Virtual Space
                                                 0
                                                 +-------------------------------------------------------------------------------------------------+
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 +-------------------------------------------------------------------------------------------------+
                                                                     A
                                                                     |
                                                 MMU                 V
                                                 +-------------------------------------------+
                                                 |                Page Table                 |
                                                 +-------------------------------------------+
                                                                     A
                                                                     |
                                                 Physical Space      |
                                                 0                   V
                                                 +------------------------------------------------------+
                                                 |                                                      |
                                                 |                                                      |
                                                 |                                                      |
                                                 +------------------------------------------------------+




                                                 Virtual Space
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+

                                                 Bitmap
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                                                 | | | | | | | | ..... | | | | | | |                                      
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+




                                                 Virtual Memory Allocator: Initialize
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+

                                                 Bitmap
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+




                                                 Virtual Memory Allocator: Allocating
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                                                               |
                                                 Bitmap                                        |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                 |0|0|0|1|1|0|0| ..... |0|0|0|0|0|0|           |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                                                               V
                                                                                               +---------+---------+
                                                                                               |         |         |
                                                                                               | Region3 | Region4 |
                                                                                               |         |         |
                                                                                               +---------+---------+


                                                 Virtual Memory Allocator: Freeing
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                                                               A
                                                 Bitmap                                        |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|           |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                                                               |
                                                                                               +---------+---------+
                                                                                               |         |         |
                                                                                               | Region3 | Region4 |
                                                                                               |         |         |
                                                                                               +---------+---------+




                                                 Physical Space      |
                                                 0                   V
                                                 +-------+-------+-------+-------+-----------------+-------+-------+-------+-------+
                                                 |       |       |       |       |                 |       |       |       |       |
                                                 | Page0 | Page1 | Page2 | Page3 | ............... | PageN | PageM | PageY | PageZ |
                                                 |       |       |       |       |                 |       |       |       |       |
                                                 +-------+-------+-------+-------+-----------------+-------+-------+-------+-------+



                                                 Virtual Space
                                                 32Bit-Mechine
                                                 0                                                                                                 2^32
                                                 +-------------------------------------------------------------------------------------------------+
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 +-------------------------------------------------------------------------------------------------+


                                                 64Bit-Mechine
                                                 0                                                                                                 2^64
                                                 +-------------------------------------------------------------------------------------------------+
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 +-------------------------------------------------------------------------------------------------+






                                                 Physical Memory Allocator: Initialize
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+

                                                 Bitmap
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+


                                                 Physical Memory Allocator: Allocating
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                                                               |
                                                 Bitmap                                        |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                 |0|0|0|1|1|0|0| ..... |0|0|0|0|0|0|           |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                                                               V
                                                                                               +---------+---------+
                                                                                               |         |         |
                                                                                               | Region3 | Region4 |
                                                                                               |         |         |
                                                                                               +---------+---------+



                                                 Physical Memory Allocator: Freeing
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                                                               A
                                                 Bitmap                                        |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|           |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                                                               |
                                                                                               +---------+---------+
                                                                                               |         |         |
                                                                                               | Region3 | Region4 |
                                                                                               |         |         |
                                                                                               +---------+---------+







                                                
                                                 Virtual Space
                                                 V_START
                                                 | <------------ Linear Mapping Area ------------> |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |                                                 |
                                                 |                                                 |
                                                 |                                                 |
                                                 V                                                 V
                                                 +---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 |
                                                 |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+
                                                 P_START
                                                 Physical Space


                                                 V_START = K + P_START



                                                 Virtual Space

                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                                          |        |
                                                      o-------------------o        o---------o
                                                      |                                      |
                                                      |                                      |
                                                      V                                      V
                                                 +---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 |
                                                 |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+

                                                 Physical Space




                                                 Virtual Space
                                                 
                                                 +-----------+--------+--------+-------------------------------------------------------------------+
                                                 |           |        |        |                                                                   |
                                                 | PageTable | Bitmap | Bitmap |                                                                   |
                                                 |           |        |        |                                                                   |
                                                 +-----------+--------+--------+-------------------------------------------------------------------+
                                                 |                             |                    
                                                 | <----- Linear Mapping ----> |
                                                 V                             V
                                                 +-----------------------------+------------------------+
                                                 |                             |                        |
                                                 |                             |                        |
                                                 |                             |                        |
                                                 +-----------------------------+------------------------+
                                                 
                                                 Physical Space








                                                 Virtual Space

                                                 +-----------+--------+--------+---------+---------+---------+---------+-----------------+---------+
                                                 |           |        |        |         |         |         |         |                 |         |
                                                 | PageTable | Bitmap | Bitmap | Region0 | Region1 | Region2 | Region3 | ............... | RegionN |
                                                 |           |        |        |         |         |         |         |                 |         |
                                                 +-----------+--------+--------+---------+---------+---------+---------+-----------------+---------+
                                                 |                             |                                                                   |
                                                 | <----- Linear Mapping ----> | <------------------------- Cross Mapping -----------------------> |
                                                 V                             V
                                                 +-----------------------------+---------+----+---------+
                                                 |                             |         |    |         |
                                                 |                             | Region0 | .. | RegionM |
                                                 |                             |         |    |         |
                                                 +-----------------------------+---------+----+---------+

                                                 Physical Space





                                                 Kernel --> | Arch Init | --> | kernel init |



                                                 Virtual Space
                                                 BISCUITOS_PAGE_OFFSET
                                                 0x90000000                                                                                        0x96400000
                                                 +-------------------------------------------------------------------------------------------------+
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 +-------------------------------------------------------------------------------------------------+
                                                 | <---------------------------------- BISCUITOS_MEMORY_SIZE ------------------------------------->|

                                                 Physcial Space
                                                 BISCUITOS_RAM_BASE
                                                 0x70000000                                                                                        0x76400000
                                                 +-------------------------------------------------------------------------------------------------+
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 +-------------------------------------------------------------------------------------------------+
                                                 | <----------------------------------- BISCUITOS_RAM_SIZE --------------------------------------->|







                                                 Virtual Space
                                                 BISCUITOS_PAGE_OFFSET
                                                 0x90000000                                                                                        0x96400000
                                                 +-----------------------------+-------------------------------------------------------------------+
                                                 |                             |                                                                   |
                                                 |                             |                                                                   |
                                                 |                             |                                                                   |
                                                 +-----------------------------+-------------------------------------------------------------------+
                                                 | <---------------------------------- BISCUITOS_MEMORY_SIZE ------------------------------------> |
                                                 |                             A
                                                 | <-- Linear Mapping Area --> | <------------------ Non-Linear Mapping Area --------------------> |
                                                 Physcial Space                |
                                                 BISCUITOS_RAM_BASE            |
                                                 0x70000000                    V                                                                    0x76400000
                                                 +-----------------------------+-------------------------------------------------------------------+
                                                 |                             |                                                                   |
                                                 |                             |                                                                   |
                                                 |                             |                                                                   |
                                                 +-----------------------------+-------------------------------------------------------------------+
                                                 | <----------------------------------- BISCUITOS_RAM_SIZE --------------------------------------> |







                                                Virtual Linuear Space

                                                0x90000000
                                                | <---------------------------- BISCUITOS_LINEAR_SIZE ------------------------------> |
                                                +------+----------------+------+---------------------------+--------------------------+
                                                |      |                |      |                           |                          |
                                                | HOLE | PTE TABLE Area | HOLE | Physical Allocator Bitmap | Virtual Allocator Bitmap |
                                                |      |                |      |                           |                          |
                                                +------+----------------+------+---------------------------+--------------------------+
                                                A      A                       A                           A
                                                |      |                       |                           |
                                                |      |                       |                           o-- BISCUITOS_BITMAP_VIRT
                                                |      |                       o------------------------------ BISCUITOS_BITMAP_PHYS
                                                |      o-- BISCUITOS_PTETABLE_BASE
                                                o--------- BISCUITOS_PAGE_OFFSET
                                                 


 






                                                   Virtual Address                                                                                        +--------------------+
                                                   64/32                                                                                            0     |                    |
                                                   +------------------+------------------+------------------+------------------+--------------------+     +--------------------+
                                                   |    PGD_OFFSET    |    PUD_OFFSET    |    PMD_OFFSET    |    PTE_OFFSET    |     PAGE_OFFSET    |     |                    |
                                                   +------------------+------------------+------------------+------------------+--------------------+     +--------------------+
                                                       |                      |                      |                      |                     |       |                    |
                                                       |                      |                      |                      |                     |       +--------------------+
                                                       |                      |                      |                      |    +-------------+  o------>|                    |
                                                       |                      |                      |                      |    | ........... |          +--------------------+
                                                       |                      |                      |                      |    +-------------+          |                    |
                                                       |                      |                      |    +-------------+   o--->|             |--------->+--------------------+
                                                       |                      |                      |    | ........... |        +-------------+
                                                       |                      |                      |    +-------------+        | ........... |
                                                       |                      |    +-------------+   o--->|             |------->+-------------+
                                                       |                      |    | ........... |        +-------------+        PTE Table
                                                       |                      |    +-------------+        | ........... |
                                                       |    +-------------+   o--->|             |------->+-------------+
                                                       |    | ........... |        +-------------+         PUDTable
                                                       |    +-------------+        | ........... |
                                                       o--->|             |------->+-------------+
                                                            +-------------+        PMDTable
                                                            | ........... |
                                                            +-------------+
                                                            PGTable






                                                   Virtual Address                                                                                       
                                                   64/32                                                                                            0    
                                                   +------------------+------------------+------------------+------------------+--------------------+    
                                                   |    PGD_OFFSET    |    PUD_OFFSET    |    PMD_OFFSET    |    PTE_OFFSET    |     PAGE_OFFSET    |    
                                                   +------------------+------------------+------------------+------------------+--------------------+    
                                                       |                      |                      |                    
                                                       |                      |                      |                    
                                                       |                      |                      |                    
                                                       |                      |                      |                    
                                                       |                      |                      |                    
                                                       |                      |                      |    +-------------+ 
                                                       |                      |                      |    | ........... | 
                                                       |                      |                      |    +-------------+ 
                                                       |                      |    +-------------+   o--->|             |
                                                       |                      |    | ........... |        +-------------+ 
                                                       |                      |    +-------------+        | ........... |
                                                       |    +-------------+   o--->|             |------->+-------------+
                                                       |    | ........... |        +-------------+         PUDTable
                                                       |    +-------------+        | ........... |
                                                       o--->|             |------->+-------------+
                                                            +-------------+        PMDTable
                                                            | ........... |
                                                            +-------------+
                                                            PGTable







                                                Virtual Linuear Space

                                                BISCUITOS_PAGE_OFFSET
                                                0x90000000
                                                | <---------------------------- BISCUITOS_LINEAR_SIZE ------------------------------> |
                                                +-------------------------------------------------------------------------------------+
                                                |                                                                                     |
                                                |                                                                                     |
                                                |                                                                                     |
                                                +-------------------------------------------------------------------------------------+
                                                A                                                                                     A
                                                | <---------------------------- Linear Mapping -------------------------------------> |
                                                V                                                                                     V
                                                +-------------------------------------------------------------------------------------+
                                                |                                                                                     |
                                                |                                                                                     |
                                                |                                                                                     |
                                                +-------------------------------------------------------------------------------------+
                                                0x70000000
                                                BISCUITOS_RAM_BASE
                                                BISCUITOS_LINEAR_BASE
                                                Physical Space

                                                Virtual_Addr = Physical_Addr + 0x20000000




                                                 Physical Memory Allocator: Initialize
                                                 
                                                 | <------------------------------- BISCUITOS_CROSS_SIZE_PHYS -------------------------------------> |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 A
                                                 |
                                                 |
                                                 o-- BISCUITOS_CROSS_BASE_PHYS

                                                 Bitmap
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+




                                                 Virtual Memory Allocator: Initialize

                                                 | <------------------------------- BISCUITOS_CROSS_SIZE_VIRT -------------------------------------> |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 A
                                                 |
                                                 |
                                                 o-- BISCUITOS_CROSS_BASE_VIRT

                                                 Bitmap
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+














                                                 Application/Shell/Shared Library
                                            ---  -----------------------------------------------------------
                                             A                     A                               A
                                             |                     |                               |
                                             |                     |                               |
                                Kernel Space |                     V                               |
                                             |   ----------------------------------------          | Kernel Module
                                             |      Memory Manager Unit Subsystem(Host)            |
                                             V   ----------------------------------------          |
                                            ---  MEMBLOCK | Buddy | Slub | VMALLOC | ....          |
                                                                                                   |
                                                                                                   V
                                                                                          -------------------
                                                                                              MMU(Module)
                                                                                          -------------------
                                                                                            Memory Allocator




           struct list_head
           +-------------+          +------------+          +------------+          +------------+
           | cache_chain | <------> | kmem_cache | <------> | kmem_cache | <------> | kmem_cache |
           +-------------+          +------------+          +------------+          +------------+







           struct kmem_cache                                                                                             
           +------------------+                                                                                                                                  struct array_cache
           | array[0]         |--------------------------------------------------------------------------------------------------------------------------------->+-----------------+
           +------------------+                                                                                                                                  | avail           |
           | array[1]         |                                                                                                                                  +-----------------+
           +------------------+                                                                                                                                  | limit           |
           | ........         |                                                                                                                                  +-----------------+
           +------------------+                                                                                                                                  | batchcount      |
           | array[NR_CPUS-1] |                                                                                                                                  +-----------------+
           +------------------+                                                                                                                                  | touched         |
           | batchcount       |                                                                                                                              --- +-----------------+
           +------------------+                                                                                                                               A  | entry[0]        |------o
           | limit            |                                                                                                                               |  +-----------------+      |
           +------------------+                                                                                                                    batchcount |  | ........        |      |
           | shared           |                                                                                                                               |  +-----------------+      |
           +------------------+                                                                                                                               V  | entry[N]        |----o |
           | buffer_size      |                                                                                                                              --- +-----------------+    | |
           +------------------+                                                                                                                                                         | |
           | gfporder         |                                                               | <--------------------------- PAGE_SIZE --------------------------> |                    | |
           +------------------+                                                               +-+-------------+-------------------+--------+--------+-----+--------+                    | |
           | gfpflags         |                                                               | |             |                   |        |        |     |        |                    | |
           +------------------+                                                               | | struct slab | kmem_bufctl array | object | object | ... | object |                    | |
           | colour           |                                                               | |             |                   |        |        |     |        |                    | |
           +------------------+                                                               +-+-------------+-------------------+--------+--------+-----+--------+                    | |
           | colour_off       |                                                                    A                                           A              A                         | |
           +------------------+                                                                    |                                           |              |                         | |
           | slabp_cache      |                                                                    |                                           |              o-------------------------o |
           +------------------+                                                        o-----------o                                           o------------------------------------------o
           | slab_size        |                                                        |                                                       
           +------------------+                                                        |      | <--------------------------- PAGE_SIZE --------------------------> | 
           | name             |                                                        |      +-+-------------+-------------------+--------+--------+-----+--------+
           +------------------+                                                        |      | |             |                   |        |        |     |        |
           | next             |                                                        |      | | struct slab | kmem_bufctl array | object | object | ... | object |
           +------------------+              struct kmem_list3                         |      | |             |                   |        |        |     |        |
           | nodelists[0]     |------------->+-----------------+                       |      +-+-------------+-------------------+--------+--------+-----+--------+
           +------------------+              | slabs_partial   |<----------------------o           A
           | nodelists[1]     |              +-----------------+                                   |
           +------------------+              | slabs_full      |<----------------------------------o
           | ............     |              +-----------------+                               
           +------------------+              | slabs_free      |<----------------------------------o                  
           | nodelists[M-1]   |              +-----------------+                                   |
           +------------------+              | free_object     |                                   V    
                                             +-----------------+                              +-+-------------+-------------------+--------+--------+-----+--------+     
                                             | colour_next     |                              | |             |                   |        |        |     |        |   
                                             +-----------------+                              | | struct slab | kmem_bufctl array | object | object | ... | object |
                                                                                              | |             |                   |        |        |     |        |
                                                                                              +-+-------------+-------------------+--------+--------+-----+--------+
                                                                                              | <--------------------------- PAGE_SIZE --------------------------> |
                                                                                              









                                                                                
                                                     o------------- list        
                                                     | o----------- colouroff   
                                                     | | o--------- s_mem --------------o      
                                                     | | | o------- inuse               |
                                                     | | | | o----- free                |
                                                     | | | | | o--- nodeid              |
                                                     | | | | | |                        |
                                                     V V V V V V    colouroff           V
                                           | <----------------------------------------> |
                                           +--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+--------+--------+--------+--------+-------+--------+--------+-----------+
                                           |        | | | | | | | | | | | | | | | | | | |        |        |        |        |        |       |        |        |           |
                                           | COLOUR | | | | | | | | | | | | | | | | | | | Object | Object | Object | Object | Object | ..... | Object | Object | Left_Over |
                                           |        | | | | | | | | | | | | | | | | | | |        |        |        |        |        |       |        |        |           |
                                           +--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+--------+--------+--------+--------+-------+--------+--------+-----------+
                                                    | <-------> | <-------------------> |                
                                                    struct slab     kmem_bufctl array
                                                         


                                                         
                                                   
                                                   
                                                   
                                                   
                                                   
                                                   
                                                   
                                                                     kmem_bufctl array
                                                                  | <-----------------> |
                                           +--------+-------------+-+-+-+-+-+-+-+-+-+-+-+--------+--------+--------+--------+--------+-------+--------+--------+-----------+
                                           |        |             | | | | | | | | | | | |        |        |        |        |        |       |        |        |           |
                                           | COLOUR | struct slab |1|2|3|4|5|.|.|.|.|N| | Object | Object | Object | Object | Object | ..... | Object | Object | Left_Over |
                                           |        |             | | | | | | | | | | | |        |        |        |        |        |       |        |        |           |
                                           +--------+-------------+-+-+-+-+-+-+-+-+-+-+-+--------+--------+--------+--------+--------+-------+--------+--------+-----------+
                                                                                       A
                                                                                       |
                                                                                       o--- BUFCTL_END









                                            o------------- list
                                            | o----------- colouroff
                                            | | o--------- s_mem 
                                            | | | o------- inuse  
                                            | | | | o----- free   
                                            | | | | | o--- nodeid 
                                            | | | | | |           
                                            V V V V V V           
                                            struct slab    kmem_bufctl array
                                           | <-------> | <-------------------> |
                                           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                           | | | | | | | | | | | | | | | | | | |
                                           | | | | | | |1|2|3|4|5|6|7|8|9|.|N| |
                                           | | | | | | | | | | | | | | | | | | |
                                           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                |                             A
                                                |                             |
                                                o---o                         o--- BUFCTL_END
                                                    | s_mem
                                                    V
                                           +--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+-----------+
                                           |        |        |        |        |        |        |        |        |        |        |        |        |        |           |
                                           | COLOUR | Object | Object | Object | Object | Object | Object | Object | Object | Object | ...... | Object | Object | Left_Over |
                                           |        |        |        |        |        |        |        |        |        |        |        |        |        |           |
                                           +--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+-----------+












           struct kmem_cache
           +------------------+                                                                                                     struct array_cache
           | array[0]         |---------------------------------------------------------------------------------------------------->+-----------------+
           +------------------+                                                               struct array_cache                    | avail           |
           | array[1]         |---------------------------------------------------------------+-----------------+                   +-----------------+
           +------------------+                                                               | avail           |                   | limit           |
           | ........         |                                                               +-----------------+                   +-----------------+
           +------------------+                        struct array_cache                     | limit           |                   | batchcount      |
           | array[NR_CPUS-1] |----------------------->+-----------------+                    +-----------------+                   +-----------------+
           +------------------+                        | avail           |                    | batchcount      |                   | touched         |
           | batchcount       |                        +-----------------+                    +-----------------+               --- +-----------------+
           +------------------+                        | limit           |                    | touched         |                A  | entry[0]        |
           | limit            |                        +-----------------+                --- +-----------------+                |  +-----------------+
           +------------------+                        | batchcount      |                 A  | entry[0]        |     batchcount |  | ........        |
           | shared           |                        +-----------------+                 |  +-----------------+                |  +-----------------+
           +------------------+                        | touched         |      batchcount |  | ........        |                V  | entry[N]        |
           | buffer_size      |                    --- +-----------------+                 |  +-----------------+               --- +-----------------+
           +------------------+                     A  | entry[0]        |                 V  | entry[N]        |                                                       
                                                    |  +-----------------+                --- +-----------------+
                                         batchcount |  | ........        |
                                                    |  +-----------------+
                                                    V  | entry[N]        |
                                                   --- +-----------------+







                      start_kernel
                         |
                         o--- mm_init
                         |       |
                         |       o--- kmem_cache_init
                         |
                         o--- kmem_cache_init_late



                                                 ---------------------------------------------------------
                                                                  struct kmem_cache
                                                 ---------------------------------------------------------
                                                                     Local Cache
                                                 ---------------------------------------------------------
                                                                    Shared Cache
                                                 ---------------------------------------------------------
                                                                 


                                         +------------+       +-------------+       +--------------+       +-----------+       +-------+
                                         | kmem_cache | <---> | Local Cache | <---> | Shared Cache | <---> | Slab list | <---> | Buddy |
                                         +------------+       +-------------+       +--------------+       +-----------+       +-------+







                       struct page
                       +-------+--------+-----------+---------+---------+-------------------+               
                       | flags | _count | _mapcount | private | mapping | ....              |
                       +-------+--------+-------+---+----+----+-+------++-------------------+
                       | flags | _count | units | pad[2] | free | list | ....               |
                       +-------+--------+-------+--------+------+------+--------------------+
                       struct slob_page                      |
                                                             |
                                                             |
                                      o----------------------o
                                      |
                                      |
                                      V                      
                       | <------------------------------------- PAGE_SIZE --------------------------------------> |
                       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+----------+-+-+-+-+-+-+
                       | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | |          | | | | | | |
                       | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | ........ | | | | | | |
                       | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | |          | | | | | | |
                       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+----------+-+-+-+-+-+-+
                                      A A A <-------------------------- slob offset ----------------------------> |
                                      | | |
                                      | | o--- slob units
                                      | o----- slob offset
                                      o------- slob size



                        
                        Physical Memory
 
                        |<-16M->| <--------- 64M ---------> |      | <-- Reserved -> | <-- RAM --> | <- ACPI Reserved -> |     
                        +-------+---------------------------+------+-----------------+-------------+---------------------+
                        |       |                           |      |                 |             |                     |
                        |       |                           | ...  |                 |             |                     |
                        |       |                           |      |                 |             |                     |
                        +-------+---------------------------+------+-----------------+-------------+---------------------+
                        A       A                                  A                 A             A
                        |       |                                  |                 |             |
                        | o-----o                                  |                 |             |
                        | |       o--------------------------------o                 |             |
                        | |       | o------------------------------------------------o             |
                        | |       | | o------------------------------------------------------------o
                        | |       | | |
                        | |       | | |
                        | |       | | | 
                       +-+-+-----+-+-+-+-+-+-+-+-+-+
                       | | |     | | | | | | | | | |
                       | | | ... | | | | | | | | | |
                       | | |     | | | | | | | | | |
                       +-+-+-----+-+-+-+-+-+-+-+-+-+
                       e820_table







                                        | <- Exist Area -> |
                         +--------+-----+------------------+--------+-----------------------+
                         |        |     |                  |        |                       |
                         |        |     |                  |        |                       |
                         |        |     |                  |        |                       |
                         +--------+-----+------------------+--------+-----------------------+
                                  | <-------- Remove Area --------> |

                                                 |
                                                 V

                         +--------+---------------------------------+-----------------------+
                         |        |                                 |                       |
                         |        |                                 |                       |
                         |        |                                 |                       |
                         +--------+---------------------------------+-----------------------+
                                  | <-------- Remove Area --------> |




                                                   | <- Remove Area -> |
                         +--------------+----------+-------------------+-----------+---------------+
                         |              |          |                   |           |               |
                         |              |          |                   |           |               |
                         |              |          |                   |           |               |
                         +--------------+----------+-------------------+-----------+---------------+
                                        | <------------- Exist Area -------------> |


                                                            |
                                                            V
                                                 
                         +--------------+----------+-------------------+-----------+---------------+
                         |              |          |                   |           |               |
                         |              |          |                   |           |               |
                         |              |          |                   |           |               |
                         +--------------+----------+-------------------+-----------+---------------+
                                        | <- NA0-> |                   | <- NA1 -> |



                                        | <- Region -> |
                         +--------+-----+--------------+-------------+-----------------------+
                         |        |     |              |             |                       |
                         |        |     |              |             |                       |
                         |        |     |              |             |                       |
                         +--------+-----+--------------+-------------+-----------------------+
                                  | <-------- Search Range --------> |



                                           | <- Search Range -> |  
                         +--------+--------+--------------------+----------+-----------------------+
                         |        |        |                    |          |                       |
                         |        |        |                    |          |                       |
                         |        |        |                    |          |                       |
                         +--------+--------+--------------------+----------+-----------------------+
                                  | <-------------- Region --------------> |

                                                      |
                                                      V
                                  |<- R0 ->| <--- Region1 ----> | <- R2 -> |
                         +--------+--------+--------------------+----------+-----------------------+
                         |        |        |                    |          |                       |
                         |        |        |                    |          |                       |
                         |        |        |                    |          |                       |
                         +--------+--------+--------------------+----------+-----------------------+


                                          | <------- Region -------> |
                         +--------+-------+---+----------------------+-----------------------+
                         |        |       |   |                      |                       |
                         |        |       |   |                      |                       |
                         |        |       |   |                      |                       |
                         +--------+-------+---+----------------------+-----------------------+
                                  | <- SRs -> |



                                  | <----------- Region -----------> |
                         +--------+-------------------+--------------+--------+--------------+
                         |        |                   |              |        |              |
                         |        |                   |              |        |              |
                         |        |                   |              |        |              |
                         +--------+-------------------+--------------+--------+--------------+
                                                      | <-- Search Region --> |








               

                       arch/x86/boot/main.c

                       main
                         |
                         o-> detect_memory
                               |
                               o-> detect_memory_e820
                               |
                               o-> detect_memory_e801
                               |
                               o-> detect_memory_88

                  





                         Case0:

                                  | <-------- Exist Region --------> |
                         +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |
                         |        |                   |              |         |             |
                         |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+
                                                      | <---- New Region ----> |

                         Case1:

                                  | <------------ Exist Region ------------> |
                         +--------+-------------------+----------------------+---------------+
                         |        |                   |                      |               |
                         |        |                   |                      |               |
                         |        |                   |                      |               |
                         +--------+-------------------+----------------------+---------------+
                                                      | <--- New Region ---> |

                         Case2:

                                  | <------------ Exist Region ------------> |
                         +--------+-------------------+-----------------+----+---------------+
                         |        |                   |                 |    |               |
                         |        |                   |                 |    |               |
                         |        |                   |                 |    |               |
                         +--------+-------------------+-----------------+----+---------------+
                                                      | <-New Region -> |







                         Case0:
                                                                                                                                                                                  
                                  | <-------- Exist Region --------> |                                              | <-------------- New Region --------------> |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         |        |                   |              |         |             |   ----->    |        |                   |              |         |             |
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                                                      | <---- New Region ----> |

                         Case1:
                                                                                                                                                                                 
                                  | <------------ Exist Region ------------> |                                      | <------------- New Region -------------> |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                         |        |                   |                      |               |             |        |                   |                      |               |
                         |        |                   |                      |               |   ----->    |        |                   |                      |               |
                         |        |                   |                      |               |             |        |                   |                      |               |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                                                      | <--- New Region ---> |

                         Case2:
                                                                                                                                                                                
                                  | <------------ Exist Region ------------> |                                      | <------------- New Region -------------> |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         |        |                   |                 |    |               |   ----->    |        |                   |                 |    |               |
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                                                      | <-New Region -> |





                         Case0:
                                                                                                                                                        
                                  | <-------- Exist Region --------> |                                              | <-Split Region0-> | <---- New Region ----> |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         |        |                   |              |         |             |   ----->    |        |                   |              |         |             |
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                                                      | <---- New Region ----> |

                         Case1:
                                                                                               
                                  | <------------ Exist Region ------------> |                                      | <-Split Region0-> | <--- New Region ---> |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                         |        |                   |                      |               |             |        |                   |                      |               |
                         |        |                   |                      |               |   ----->    |        |                   |                      |               |
                         |        |                   |                      |               |             |        |                   |                      |               |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                                                      | <--- New Region ---> |

                         Case2:
                                                                                              
                                  | <------------ Exist Region ------------> |                                      | <-Split Region0-> | <-New Region0-> |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         |        |                   |                 |    |               |   ----->    |        |                   |                 |    |               |
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                                                      | <-New Region -> |                                                                                 |<-->|
                                                                                                                                                        Insert Region










                         Case0:

                                  | <--------- New Region ---------> |
                         +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |
                         |        |                   |              |         |             |
                         |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+
                                                      | <--- Exist Region ---> |

                         Case1:

                                  | <------------- New Region -------------> |
                         +--------+-------------------+----------------------+---------------+
                         |        |                   |                      |               |
                         |        |                   |                      |               |
                         |        |                   |                      |               |
                         +--------+-------------------+----------------------+---------------+
                                                      | <-- Exist Region --> |

                         Case2:

                                  | <------------- New Region -------------> |
                         +--------+-------------------+-----------------+----+---------------+
                         |        |                   |                 |    |               |
                         |        |                   |                 |    |               |
                         |        |                   |                 |    |               |
                         +--------+-------------------+-----------------+----+---------------+
                                                      |<-Exist Region ->|



                         Case1:

                                  | <------------- New Region -------------> |                                      | <------------- New Region -------------> |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                         |        |                   |                      |               |             |        |                   |                      |               |
                         |        |                   |                      |               |   ----->    |        |                   |                      |               |
                         |        |                   |                      |               |             |        |                   |                      |               |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                                                      | <-- Exist Region --> |

                         Case2:

                                  | <------------- New Region -------------> |                                      | <------------- New Region -------------> |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         |        |                   |                 |    |               |   ----->    |        |                   |                 |    |               |
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                                                      |<-Exist Region ->|



                         Case0:

                                  | <--------- New Region ---------> |                                              | <--------- New Region ---------> |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         |        |                   |              |         |             |   ----->    |        |                   |              |         |             |
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                                                      | <--- Exist Region ---> |                                                                       | <-----> |
                                                                                                                                                       Exist Region





                         Case0:

                                  | <--------- New Region ---------> |                                              | <-------------- New Region --------------> |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         |        |                   |              |         |             |   ----->    |        |                   |              |         |             |
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                                                      | <--- Exist Region ---> |                                                                    
                                                                                                                                                    






































dfasdf




  handle_post
    |
    o-> do_post
          |
          o-> qemu_preinit
          |     |
          |     o-> e820_add(0, RamSize, E820_RAM)
          |     |   0x00000000-0x40000000
          |     |
          |     o-> e820_add(0xFFFC0000, 256KB, E820_RESERVED)
          |         0xfffc0000-0x100000000
          |
          o-> coreboot_preinit
          |     |
          |     o-> !CONFIG_COREBOOT
          |
          o-> malloc_preinit
          |     |
          |     o-> e820_remove(BUILD_LOWRAM_END, BUILD_BIOS_ADDR-BUILD_LOWRAM_END)
          |     |   0xa0000-0x100000
          |     |
          |     o-> e820_add(BUILD_BIOS_ADDR, BUILD_BIOS_SIZE, E820_RESERVED)
          |     |   0xf0000-0xfffff
          |     |
          |     o-> e820_add(highram, BUILD_MAX_HIGHTABLE, E820_RESERVED)
          |         0x3ffc0000-0x40000000
          |
          o-> maininit
                |
                o-> interface_init
                |     |
                |     o->qemu_cfg_init
                |          |
                |          o-> qemu_cfg_e820
                |                |
                |                o-> e820_add(table[i].address, table[i].length, table[i].type)
                |                |   0xfeffc000-0xff000000
                |                |
                |                o-> e820_add(entry.address, entry.length, entry.type)
                |                |
                |                o-> e820_add(0xfffbc000, 4*4096, E820_RESERVED)
                |                |   0xfffbc000-0xfffc0000  
                |                |
                |                o-> e820_add(0x100000000ull, high, E820_RAM)
                |                    0x100000000-
                |
                o-> prepareboot
                      |
                      o-> malloc_prepboot
                      |     |
                      |     o-> e820_add(endlow, BUILD_LOWRAM_END-endlow, E820_RESERVED)
                      |     |   0x9fc00-0xa0000
                      |     |
                      |     o-> e820_add(info->range_start, giveback, E820_RAM)
                      |     |   0x3ffc0000-0x3ffe0000
                      |     |
                      |     o-> calcRamSize
                      |
                      o-> e820_prepboot
                            |
                            o-> dump_map

      handle_15
        |
        o-> handle_15e8
              |
              o-> handle_15e801
              |
              o-> handle_15e820
              |
              o-> handle_15e8XX






  +-------+-----------+---------+---------------+------------+------------+-----------------------------------------------------+
  |       |           |         |               |            |            |                                                     |
  |       |           |         |               |            |            |                                                     |
  |       |           |         |               |            |            |                                                     |
  +-------+-----------+---------+---------------+------------+------------+-----------------------------------------------------+
  | <---> | <-------> | <-----> | <-----------> | <--------> | <--------> |
  A   A   A     A     A
  |   |   |     |     |
  |   |   |     |     |
  |   |   |     |     |
  |   |   |     |     o- 0X4FF
  |   |   |     o------- BDA 







                           "Real mode Address Space (< 1 MiB)"

                                                        ----- +---------------------------------+ --> 0x100000
                                                        A  A  |                                 |  A
                                                        |  |  |                                 |  | Metherboard BIOS
                                                        |  |  |                                 |  V
                                                        |  |  +---------------------------------+ --> 0xF0000
                      [ROM and hardware mapped/Shadow RAM] |  |                                 |  A
                                                        |  |  |                                 |  |
                                                        |  |  |                                 |  | BIOS Expansion
                                                        |  |  |                                 |  |
                              "384 KiB System/Reserved" |  |  |                                 |  V
                                      "Upper Memory"    |  |  +---------------------------------+ --> 0xC8000
                                                        |  |  |                                 |  A
                                                        |  |  |                                 |  | Video BIOS
                                                        |  V  |                                 |  V
                                                        |  -- +---------------------------------+ --> 0xC0000
                                                        |  A  |                                 |  A
                                         [hardware mapped] |  |                                 |  | Video display memory
                                                        V  V  |                                 |  V
                                                        ----- +---------------------------------+ --> 0xA0000
                                                        A  A  |                                 |  A
                                  [partially used by EBDA] |  |                                 |  | EBDA (Extended BIOS Data Area)
                                                        |  V  |                                 |  V
                                                        |  -- +---------------------------------+ --> 0x80000
                                                        |  A  |                                 |  A
                                                        |  |  |                                 |  | Conventional memory
                                                        |  |  |                                 |  V
                                                        |  |  +---------------------------------+ --> 0x07E00
                                          [usable memory]  |  |                                 |  A
                                                        |  |  |                                 |  |
                                                        |  |  |                                 |  |  OS BootSector
                                          "640 KiB RAM" |  |  |                                 |  |
                                          "Low Memory"  |  |  |                                 |  V  
                                                        |  |  +---------------------------------+ --> 0x07C00
                                                        |  |  |                                 |  A
                                                        |  |  |                                 |  | Conventional memory
                                                        |  V  |                                 |  V
                                                        |  -- +---------------------------------+ --> 0x00500
                                                        |  A  |                                 |  | BDA (BIOS Data Area)
                                                        |  |  +---------------------------------+ --> 0x00400
                                   [unusable in real mode] |  |                                 |  A
                                                        |  |  |                                 |  | Real Mode IVT (Interrupt Table)
                                                        V  V  |                                 |  V
                                                        ----- +---------------------------------+ --> 0x00000










Offset    Size         Description                                          Info
00h       1 byte       Size of Extended BIOS Data Area                      1 = 1024 bytes; 2 = 2048 bytes
17h       1 byte       Number of POST error entries 	 
18h       5 byte       POST error log
22h       1 dword      Mouse device driver far call                         pointer to the mouse device driver in 
                                                                            segment:offset format
26h       1 byte       Mouse flags 1
                       Bit 7    Command in progress; 0 = no, 1 = yes
                       Bit 6    Mouse sent a Resend byte (FAh)
                       Bit 5    Mouse sent an Acknowledge byte (FEh)
                       Bit 4    Mouse sent an error byte (FCh)
                       Bit 3    Unexpected value received
                       Bit 2-0  Index count; used to retrieve up to 8 
                                bytes from the controller; successive
                                bytes are stored starting at offset 28h
27h       1 byte       Mouse flags 2
                       Bit 7    Device driver far call flag
                       Bit 6-3  Not used, or function unknown
                       Bit 2-0  Package count; the number of bytes received
                                from the mouse
28h       8 bytes      Mouse data
39h       1 word       Watchdog timer                                       Initial count value of the watchdog 
                                                                            timer; 0 = watchdog timer not active
3Dh       16 bytes     Hard disk 0 parameter table                          The structure of this table is equal
                                                                            to the hard disk drive parameter table.
4Dh       16 bytes     Hard disk 1 parameter table                          The structure of this table is equal to
                                                                            the hard disk drive parameter table.
68h       1 byte       Cache control
                       Bit 7-2  Not used                                    Primarily used for CPUs with on-chip
                       Bit 1    Cache test:                                 cache: 486 CPUs and IBM 386SLC.
                                0 = test successful
                                1 = test failed
                       Bit 0    CPU cache enable:
                                0 = enabled
                                1 = disabled
6Eh       1 byte       Keyboard repeat rate                                 Values saved are identical to the values
                                                                            used by Int 16h, function 03h.
6Fh       1 byte       Delay until keys repeat                              Values saved are identical to the values
                                                                            used by Int 16h, function 03h.
70h       1 byte       Number of hard disk drives installed                 Number of drives as detected by POST: 
                                                                            0, 1 or 2
71h       1 byte       DMA channel for hard disk drive                      Default: channel 5
72h       1 byte       Hard disk interrupt status                           1Fh = timeout has occurred
73h       1 byte       Hard disk operation flags
                       Bit 7    1 = controller issued an operation 
                                    complete interrupt
                       Bit 6    1 = controller has been reset
                       Bit 5-0  Not used
74h       1 dword      Old Int 76h vector pointer
78h       1 byte       Hard disk DMA type                                   This byte is used as temporary storage
                                                                            for the DMA extended mode register.
79h       1 byte       Hard disk: status of last operation                  The value stored is the value returned
                                                                            by Int 13h, function 01h.
7Ah       1 byte       Hard disk: timeout value                             The timeout value is set by POST to
                                                                            indicate how long BIOS disk services
                                                                            should wait for the controller to indicate
                                                                            the operate has completed.
7E        8 words      hHard disk controller: return status words           ESDI - PS/2
E7h       1 byte       Diskette drive type
                       Bit 	
                       Bit 	
                       Bit 	
ECh       1 byte       Hard disk parameters loaded
                       Bit 	
                       Bit 	
EEh       1 byte       CPU family ID                                        The value stored is the value returned
                                                                            by Int 15h, function C9h
EFh       1 byte       CPU stepping                                         The value stored is the value returned
                                                                            by Int 15h, function C9h
117h      1 word       Keyboard ID
11Ah      1 word       Non-BIOS Int 18h flag
                       Bit 7-1  Not used
                       Bit 0    Set to 1 before calling user Int 18h.
11D       1 dword      User Int 18h far pointer




                   CMOS --o
                          |     +--------------+  Interrup Vector Table    +------------------+ 
                    BDA -(+)--> | seaBIOS/BIOS | ------------------------> | Kernel Real mode | 
                          |     +--------------+                           +------------------+ 
                   EBDA --o





         
                   CMOS --o
                          |     +--------------+  IVT    +------------------+  E820 map   +---------------------+  E820 Firmware   +-----------+
                    BDA -(+)--> | seaBIOS/BIOS | ------> | Kernel Real mode | ----------> | Kernel Protect mode | ---------------> | Userspace |
                          |     +--------------+         +------------------+             +---------------------+                  +-----------+
                   EBDA --o





                                                  BDA --o
                                                        |
                                      o---->   hw_cfg --o
                +---------------+     |                 |     +--------------+  Interrup Vector Table    +------------------+
                | qemu/qemu-kvm |----(+)--->    CMOS --(+)--> | seaBIOS/BIOS | ------------------------> | Kernel Real mode | 
                +---------------+     |                 |     +--------------+                           +------------------+
                                      o----> etc/e820 --o
                                                        |
                                                 EBDA --o




        kvm_init
          |
          o- kvm_arch_init
               |
               o- kvm_check_extension(s, KVM_CAP_SET_IDENTITY_MAP_ADDR)
               |  identity_base = 0xfeffc000
               |
               o- e820_add_entry(identity_base, 0x4000, E820_RESERVED)

        pc_init_v3_1
          |
          o- pc_init1
               |
               o-> pcms->above_4g_mem_size
               |
               o-> pcms->below_4g_mem_size
               |
               o-> pc_memory_init
               |    |
               |    o-> e820_add_entry(0, pcms->below_4g_mem_size, E820_RAM)
               |    |
               |    o-> e820_add_entry(0x100000000ULL, pcms->above_4g_mem_size, E820_RAM)
               |    |
               |    o-> bochs_bios_init
               |          |
               |          o->fw_cfg_add_bytes(fw_cfg, FW_CFG_E820_TABLE, &e820_reserve, sizeof(e820_reserve))
               |          |
               |          o-> fw_cfg_add_file(fw_cfg, "etc/e820", e820_table, sizeof(struct e820_entry) * e820_entries)
               |          
               o-> pc_cmos_init
                     |
                     o-> rtc_set_memory           





  Real_mode:

  main
    |
    o-> detect_memory
          |
          o-> detect_memory_e820
          |     |
          |     o-> boot_params.e820_table
          |     |
          |     o-> boot_params.e820_entries
          |        
          o-> detect_memory_e801
          |     |
          |     o-> boot_params.alt_mem_k
          |
          o-> detect_memory_88
                |
                o-> boot_params.screen_info.ext_mem_k

  Protect_Mode:

  start_kernel
    |
    o-> setup_arch
          |
          o-> e820__memory_setup
          |     |
          |     o-> e820__memory_setup_default
          |     |     |
          |     |     o-> append_e820_table(boot_params.e820_table, boot_params.e820_entries)
          |     |     |
          |     |     o-> e820__update_table(e820_table)
          |     |
          |     o-> e820_table_kexec/e820_table_firmware
          |     |
          |     o-> e820__print_table("BIOS-e820")
          |
          o-> parse_setup_data
          |     |
          |     o-> e820__memory_setup_extended
          |           |
          |           o-> e820__print_table("extended")
          |
          o-> parse_early_param
          |     |
          |     .. parse_memopt("mem")
          |     |    |
          |     |    o-> e820__range_remove
          |     |
          |     .. parse_memmap_opt("memmap")
          |          |
          |          o-> parse_memmap_one
          |
          o-> e820__reserve_setup_data
          |     |
          |     o-> e820__update_table(e820_table/e820_table_kexec)
          |     |
          |     o-> e820__print_table("reserve setup_data")
          |
          o-> e820__finish_early_params
          |     |
          |     o-> e820__print_table("user")
          |
          o-> e820_add_kernel_range
          |     |
          |     o-> e820__mapped_all
          |           |
          |           o-> __e820__mapped_all
          |
          o-> e820__end_of_ram_pfn -> "max_pfn"/"max_low_pfn"
          |     |
          |     o-> e820_end_pfn
          |
          o-> e820__memblock_setup
          |
          o-> e820__memblock_alloc_reserved_map_new
          |
          o-> e820__reserve_resources
          |     |
          |     o-> firmware_map_add_early
          |
          o-> e820__setup_pci_gap
                |
                o-> e820_search_gap




             Physical Memory
             0
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------+------------------+
             |                                    | | | | | | | | | |       | | | | | | | | |         |                  |
             |                                    | | | | | | | | | | ..... | | | | | | | | |         |                  |
             |                                    | | | | | | | | | |       | | | | | | | | |         |                  |
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------+------------------+
                                                  A         A                               A         A
             struct bootmem_data                  |         |                               |         |
             +----------------+                   |         o-- goal                        |         o-- limit
             |   node_min_pfn |-------------------o                                         |
             +----------------+                                                             |
             |   node_low_pfn |-------------------------------------------------------------o
             +----------------+ 
             |   *bootmem_map |-----------o
             +----------------+           |       bitmap
                                          |       +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+
                                          o-----> | | | | | | | | ... | | | | | | | |
                                                  +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+
                                                         A                         A
                                                         |                         |                          
                                                        sidx                      midx




             Physical Memory
             0
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------+------------------+
             |                                    | | | | | | | | | |       | | | | | | | | |         |                  |
             |                                    | | | | | | | | | | ..... | | | | | | | | |         |                  |
             |                                    | | | | | | | | | |       | | | | | | | | |         |                  |
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------+------------------+
                                                  A         A                               A         A
             struct bootmem_data                  |         |                               |         |
             +----------------+                   |         o-- goal                        |         o-- limit
             |   node_min_pfn |-------------------o                                         |
             +----------------+                                                             |
             |   node_low_pfn |-------------------------------------------------------------o
             +----------------+
             |   *bootmem_map |-----------o
             +----------------+           |       bitmap
                                          |       +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+
                                          o-----> | | | | | | | | ... | | | | | | | |
                                                  +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+
                                                         A                   A     A
                                                         | <---------------> |     |
                                                        sidx    "range"     eidx  midx



             Physical Memory
             0  
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------------------------+
             |                                    | | | | | | | | | |       | | | | | | | | |                           |
             |                                    | | | | | | | | | | ..... | | | | | | | | |                           |
             |                                    | | | | | | | | | |       | | | | | | | | |                           |
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------------------------+
                                                  A         A                               A         
             struct bootmem_data                  |         |                               |         
             +----------------+                   |         |                               |         
             |   node_min_pfn |-------------------o         |                               |
             +----------------+                             |                               |
             |   last_end_off |-----------------------------o                               |
             +----------------+                                                             |
             |   node_low_pfn |-------------------------------------------------------------o
             +----------------+
             |       hint_idx |-----------------------------o
             +----------------+                             |
             |   *bootmem_map |-----------o                 |
             +----------------+           |       bitmap    V
                                          |       +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+
                                          o-----> | | | | | | | | ... | | | | | | | |
                                                  +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+









               ARM Architecture

               start_kernel
                 |    
                 o-> setup_arch
                 |    |
                 |    o-> parse_tags
                 |    |     .
                 |    |     o-> parse_tag_mem32
                 |    |           |
                 |    |           o-> arm_add_memory
                 |    |
                 |    o-> paging_init
                 |          |
                 |          o-> sort(meminfo)
                 |          |
                 |          o-> sanity_check_meminfo
                 |          |
                 |          o-> bootmem_init
                 |                |
                 |                o-> bootmem_init_node
                 |                |     |
                 |                |     o-> bootmem_bootmap_pages
                 |                |     |
                 |                |     o-> find_bootmap_pfn
                 |                |     |
                 |                |     o-> init_bootmem_node
                 |                |     
                 |                o-> bootmem_free_node
                 |                |     |
                 |                |     o-> free_area_init_node
                 |                |           |
                 |                |           o-> alloc_node_mem_map
                 |                |           |
                 |                |           o-> free_area_init_core
                 |                |
                 |                o-> high_memory/max_low_pfn/max_pfn
                 |
                 o-> mm_init
                       |
                       o-> mem_init
                             |
                             o-> free_all_bootmem_node
                                   |
                                   o-> free_all_bootmem_core
                                         |
                                         o-> __free_pages_bootmem
                                               |
                                               o-> __free_page/__free_pages 
             
             


                Physical Memory

                +----------------------------------------+----------------+----------------------------------------+
                |                                        |                |                                        |
                |                                        |                |                                        |
                |                                        |                |                                        |
                +----------------------------------------+----------------+----------------------------------------+
                | <--------- Available Memory ---------> | <--- Hole ---> | <--------- Available Memory ---------> |
                A                                        A                A                                        A
                |                                        |                |                                        |
                |                                        |                |                                        |
                o- 0x00000000                            o- 0x06000000    o- 0x08000000                0x0E000000 -o









                i386 Architecture

                start_kernel
                  |
                  o-> setup_arch
                  |     |
                  |     o-> initmem_init
                  |     |     |
                  |     |     o-> setup_bootmem_allocator
                  |     |           |
                  |     |           o-> bootmem_bootmap_pages
                  |     |           |
                  |     |           o-> setup_node_bootmem
                  |     |           |     |
                  |     |           |     o-> init_bootmem_node
                  |     |           |     |     |
                  |     |           |     |     o-> init_bootmem_core
                  |     |           |     |
                  |     |           |     o-> free_bootmem_with_active_region
                  |     |           |           |
                  |     |           |           o-> free_bootmem_node
                  |     |           |
                  |     |           o-> after_bootmem = 1
                  |     |
                  |     o-> dma32_reserve_bootmem
                  |
                  o-> mm_init
                        |
                        o-> mem_init
                              |
                              o-> free_all_bootmem
                                    |
                                    o-> free_all_bootmem_core





                X64 Architecture

                start_kernel
                  |
                  o-> setup_arch
                  |     |
                  |     o-> initmem_init
                  |     |     |
                  |     |     o-> bootmem_bootmap_pages
                  |     |     |
                  |     |     o-> init_bootmem_node
                  |     |     |
                  |     |     o-> free_bootmem_with_active_regions
                  |     |           |
                  |     |           o-> free_bootmem_node
                  |     |
                  |     o-> dma32_reserve_bootmem
                  |
                  o-> mm_init
                        |
                        o-> mem_init
                              |
                              o-> free_all_bootmem
                                    |
                                    o-> free_all_bootmem_core





                 Physical Memory
                 0                                                   
                 +----------------------------------+----------+----------------+-----+
                 |                                  |          |                |     |
                 |                                  |          |                |     |
                 |                                  |          |                |     |
                 +----------------------------------+----------+----------------+-----+
                                                    A          A                A
                                                    |          |                |
                                                    |          |                |
                        __brk_base/_brk_start ------o          |                |
                                     _brk_end -----------------o                |
                                  __brk_limit ----------------------------------o




            Load Kernel Image
            -----------------
            _brk_end   = __brk_base
            _brk_start = __brk_base
            RESERVE_BRK(early_pgt_alloc, INIT_PGT_BUF_SIZE)
            RESERVE_BRK(dmi_alloc, 65536)

            start_kernel
              |
              o-> setup_arch
                    |
                    o-> reserve_brk
             



          


        .bss/.data --> RESERVE_BRK --> Early_res --> Bootmem/MEMBLOCK --> Buddy




                                                        ---
          Application                                    A
          ---------------------------------------------  | 
          Virtual Address Space (GVA)                    |
          ---------------------------------------------  |
                                                         | 
          Guest OS                                       | 
                                                         | VMX Non-Root
          ---------------------------------------------  |
          Physical Address Space (GPA)                   |
          ---------------------------------------------  |
                                                         |
          +------+   +------+      +------+   +------+   |
          | VCPU |   | VCPU | .... | VCPU |   | VCPU |   | 
          +------+   +------+      +------+   +------+   V
                                                        ---



                                                                         ---
          Application                                                     A
          --------------------------------------------------------------  |
          Virtual Address Space (GVA)                                     |
          --------------------------------------------------------------  |
                                                                          |
          Guest OS                                                        | VMX Non-Root
                                                                          | 
          --------------------------------------------------------------  |
          Physical Address Space (GPA)                                    V
          ============================================================== ---
          Virtual Address Space (HVA)                                     A
          --------------------------------------------------------------  |
                                                                          |
          Host OS                                                         | VMX Root
                                                                          |
          --------------------------------------------------------------  |
          Physical Address Space (HPA)                                    V
          -------------------------------------------------------------- ---








          +-----------------+   +-----------------+  +-----------------+ ---
          | Virtual-Machine |   | Virtual-Machine |  | Virtual-Machine |  A
          +-----------------+   +-----------------+  +-----------------+  |
          |    qemu-kvm     |   |    qemu-kvm     |  |    qemu-kvm     |  |
          +-----------------+   +-----------------+  +-----------------+  | Userspace
                                                                          |
          ==============================================================  |
          Virtual Address Space (HVA)                                     V
          -------------------------------------------------------------- ---
                                                                          A
          Host OS                                                         | Kernel
                                                                          V
          -------------------------------------------------------------- ---
          Physical Address Space (HPA)                                   
          -------------------------------------------------------------- 




          -------------------------------------------------------------- 
          Virtual Address Space (HVA)                                     
          -------------------------------------------------------------- 
                                                                         
          Host OS                                                       
                                                                         
          -------------------------------------------------------------- 
          Physical Address Space (HPA)
          -------------------------------------------------------------- 



                                    Virtual Address
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |  +--------------+
                                              |                      |                      |                      |  +--------------+     |  |              |
                                              |                      |                      |                      |  |              |     |  +--------------+
                                              |                      |                      |                      |  +--------------+     o->|              |
                                              |                      |                      |                      |  |              |        +--------------+
                                              |                      |                      |                      |  +--------------+        |              |
                                              |                      |                      |  +--------------+    o->|   Physical   | -----> +--------------+
                                              |                      |                      |  |              |       +--------------+        Physical Address
                                              |                      |                      |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |  +--------------+    o->|   Physcial   | ----> +--------------+
                                              |  |              |       +--------------+
                                              |  +--------------+       |              |
                                              o->|   Physcial   | ----> +--------------+
                                                 +--------------+
                                                 |              |
                                CR3              +--------------+
                                +----------+     |              |
                                | Physical | --> +--------------+
                                +----------+

             
             
            



                                    Guest OS

                                    GVA 
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |  +--------------+
                                              |                      |                      |                      |  +--------------+     |  |              |
                                              |                      |                      |                      |  |              |     |  +--------------+
                                              |                      |                      |                      |  +--------------+     o->|              |
                                              |                      |                      |                      |  |              |        +--------------+
                                              |                      |                      |                      |  +--------------+        |              |
                                              |                      |                      |  +--------------+    o->|     GPA      | -----> +--------------+
                                              |                      |                      |  |              |       +--------------+        Guest Physiacl Address
                                              |                      |                      |  +--------------+       |              |
                                              |                      |  +--------------+    o->|     GPA      | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |  +--------------+    o->|     GPA      | ----> +--------------+
                                              |  |              |       +--------------+
                                              |  +--------------+       |              |
                                              o->|     GPA      | ----> +--------------+
                                                 +--------------+
                                                 |              |
                                gCR3             +--------------+
                                +----------+     |              |
                                |   GPA    | --> +--------------+
                                +----------+






                                    Guest OS

                                    GVA
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |  +--------------+
                                              |                      |                      |                      |  +--------------+     |  |              |
                                              |                      |                      |                      |  |              |     |  +--------------+  EPT   +-----------+
                                              |                      |                      |                      |  +--------------+     o->|     GPA      |------->|    HPA    | 
                                              |                      |                      |                      |  |              |        +--------------+  Walk  +-----------+
                                              |                      |                      |                      |  +--------------+        |              |
                                              |                      |                      |  +--------------+    o->|     GPA      |-o  o-->+--------------+
                                              |                      |                      |  |              |       +--------------+ |  |    
                                              |                      |                      |  +--------------+       |              | |  |
                                              |                      |  +--------------+    o->|     GPA      |-o  o->+--------------+ |  |
                                              |                      |  |              |       +--------------+ |  |                   |  |
                                              |                      |  +--------------+       |              | |  |                   V  |
                                              |                      |  |              |       +--------------+ |  |EPT            +---------+
                                              |                      |  +--------------+       |              | |  |Walk           |   HPA   |
                                              |  +--------------+    o->|     GPA      |-o  o->+--------------+ |  |               +---------+
                                              |  |              |       +--------------+ |  |                   |  |
                                              |  +--------------+       |              | |  |                   V  |
                                              o->|     GPA      |-o  o->+--------------+ |  |EPT            +---------+
                                                 +--------------+ |  |                   |  |Walk           |   HPA   |
                                                 |              | |  |                   V  |               +---------+
                                gCR3             +--------------+ |  |               +---------+
                                +----------+     |              | |  |EPT            |   HPA   |
                                |   GPA    |  o->+--------------+ |  |Walk           +---------+
                                +----------+  |                   |  |
                                     |Walk    |                   V  |
                                     V        |               +---------+
                                +----------+  |               |   HPA   |
                                |   HPA    |--o               +---------+
                                +----------+

             
















                                  
                               GPA
                               +-----------------------+----------------------+----------------------+----------------------+-----------------------+
                               |      PML4_OFFSET      |      PDP_OFFSET      |       PD_OFFSET      |       PT_OFFSET      |      PAGE_OFFSET      | 
                               +-----------------------+----------------------+----------------------+----------------------+-----------------------+
                                          |                      |                      |                      |                       |
                                          |                      |                      |                      |                       |
                                          |                      |                      |                      |                       |  +--------------+
                                          |                      |                      |                      |  +--------------+     |  |              |
                                          |                      |                      |                      |  |              |     |  +--------------+
                                          |                      |                      |                      |  +--------------+     o->|              |
                                          |                      |                      |                      |  |              |        +--------------+
                                          |                      |                      |                      |  +--------------+        |              |
                                          |                      |                      |  +--------------+    o->|     HPA      | -----> +--------------+
                                          |                      |                      |  |              |       +--------------+        Host Physical Memory
                                          |                      |                      |  +--------------+       |              |
                                          |                      |                      |  |              |       +--------------+
                                          |                      |                      |  +--------------+       |              |
                                          |                      |  +--------------+    o->|     HPA      | ----> +--------------+
                                          |                      |  |              |       +--------------+
                                          |                      |  +--------------+       |              |
                                          |  +--------------+    o->|     HPA      | ----> +--------------+
                                          |  |              |       +--------------+
                                          |  +--------------+       |              |
                                          |  |              |       +--------------+
                                          |  +--------------+       |              |
                                          o->|     HPA      | ----> +--------------+
                           EPTP              +--------------+
                           +-----------+     |              |
                           |    HPA    | --> +--------------+
                           +-----------+
     










                                +--------+  +--------+  +------------------------------------+
                                |  VMID  |  |  ASID  |  |               GVA                  |
                                +--------+  +--------+  +------------------------------------+
                                    |           | 
                                    |           |       +----------------------+-------------+
                                    |           |       |         GVPN         |    Offset   | -----------------------------------------------------o
                                    |           |       +----------------------+-------------+                                                      |
                                    |           |                                                                                                   |
                                    |           |       +-----+----------------+                                                                    |
                                    |           |       | tag |      index     |                                                                    |
                                    |           |       +-----+----------------+                                                                    |
                                    |           |          |                                                                                        |
                                    |           |          |              TLB                                                                       |
                                    |           |          |              +--------------+--------------+---------+----------+                      |
                                    |           |          |              | TLB VMID tag | TLB ASID tag | TLB tag | TLB data |                      |
                                    |           |          |              +--------------+--------------+---------+----------+                      |
                                    |           |          |                     |              |            |         |                            |
                                    |           |          |                     |              |            V         |                            |
                                    |           |          |                     |              |       +----------+   |                            |
                                    |           |          o---------------------+--------------+-----> | Miss/Hit |   |                            |
                                    |           |                                |              |       +----------+   |                            |
                                    |           |                                |              V                      |                            |
                                    |           |                                |         +----------+                V                            V
                                    |           o--------------------------------+-------> | Miss/Hit |                +----------------------+-------------+
                                    |                                            |         +----------+                |         HPPN         |    offset   |
                                    |                                            V                                     +----------------------+-------------+
                                    |                                       +----------+      
                                    o-------------------------------------> | Miss/Hit |                               +------------------------------------+
                                                                            +----------+                               |                HPA                 |
                                                                                                                       +------------------------------------+




                                                Guest OS                                             ---
                                                Physical memory region                                A
                                                +------------------------------------------+          |
                                                |                                          |          | Non-Root
                                                +------------------------------------------+          |
                                                                                                      V
                        ---------------------------------------------------------------------------- ---
                                                QEMU                                                  A
                                                struct kvm_userspace_memory_region                    |
                                                +------------------------------------------+          | Userspace
                                                |                                          |          |
                                                +------------------------------------------+          |
                                                                                                      V
                        ============================================================================ ===               
                                                                                                      A
                                                KVM                                                   |
                                                struct kvm_memory_slot                                |
                                                +------------------------------------------+          | Kernel
                                                |                                          |          |
                                                +------------------------------------------+          |
                                                                                                      V
                                                                                                     ---
                                                Physcial Memory                                       A
                                                +------------------------------------------+          | Hardware
                                                |                                          |          V
                                                +------------------------------------------+         ---





                                            QEMU
                                            struct kvm_userspace_memory_region
                                            +------------------+
                                            |             slot |
                                            +------------------+                                 +------------------------+
                                            |            flags |                         o-----> | Anonymous 4KiB Mmaping |
                                            +------------------+                         |       +------------------------+
                                            |  guest_phys_addr |                         |
                                            +------------------+                         |
                                            |      memory_size |                         |
                                            +------------------+                         |       +-----------------------------+
                                            |   userspace_addr | -----------------------(+)----> | Hugetlbfs/ HugePage mmaping |
                                            +------------------+                         |       +-----------------------------+
                                                                                         |
                                                                                         |
                                                                                         |
                                                                                         |       +---------------------+
                                                                                         o-----> | Private Memory Mmap |
                                                                                                 +---------------------+








                         struct kvm
                         +---------------+
                         |               |
                         +---------------+          struct kvm_memslots
                         |      memslots | -------> +------------------+
                         +---------------+          |                  |
                                                    +------------------+
                                                    |    id_to_index[] |
                                                    +------------------+
                                                    |       used_slots |
                                                    +------------------+
                                                    |      memslots[0] |
                                                    +------------------+            struct kvm_memory_slot
                                                    |      memslots[1] | ---------> +-----------------+
                                                    +------------------+            |        base_gfn |
                                                    |      .......     |            +-----------------+
                                                    +------------------+            |          npages |
                                                    |      memslots[M] |            +-----------------+
                                                    +------------------+            |  userspace_addr |
                                                    |      memslots[N] |            +-----------------+
                                                    +------------------+            |           flags |
                                                                                    +-----------------+
                                                                                    |              id |
                                                                                    +-----------------+
                                                                                    |            arch | 
                                                                                    +-----------------+








                                          Guest Physcial Memory
 
                                                                  Memory Space                                   IO Space              PCI Space
                                          | <----------------------------------------------------------> | <------------------> | <------------------> |
                                          +--------------------------------------------------------------+----------------------+----------------------+
                                          |                                                              |                      |                      |
                                          |                                                              |                      |                      |
                                          |                                                              |                      |                      |
                                          +--------------------------------------------------------------+----------------------+----------------------+
                          

                


                                                                                  Guest Physical Memory
                                     AddressSpace                
                                     +----------------+                           GPA:0    GPA:addr0                      GPA:addr1                      GPA:addr2                             GPA:MAX
                                     |                |                           |        |                              |                              |                                     |
                                     +----------------+                           +--------+------------------------------+---------------------+--------+-------------------------+-----------+
                                     |                |                           |        |                              |                     |        |                         |           |
                                     +----------------+                           |        |              R0              |          R1         |        |          R2             |           |
                                o----|           root |                           |        |                              |                     |        |                         |           |
                                |    +----------------+                           +--------+------------------------------+---------------------+--------+-------------------------+-----------+
                                |    |                |                                    A <---------- size0 ---------> A <----- size1 -----> |        A <------- size2 -------> |
                                |    +----------------+                                    |                              |                              |
                                |                                                          |                              |                              |
                                |                                                          |                              |                              |
                                |                                                          |                              |                              |
                                |                                                          |                              |                              |
                                |    MemoryRegion(Root)             MemoryRegion (R0)      |       MemoryRegion (R1)      |       MemoryRegion (R2)      |
                                |    +-----------------+            +-----------------+    |       +-----------------+    |       +-----------------+    |
                                |    |                 |            |                 |    |       |                 |    |       |                 |    |
                                |    +-----------------+            +-----------------+    |       +-----------------+    |       +-----------------+    |
                                |    |                 |            |            addr |----o       |            addr |----o       |            addr |----o
                                |    +-----------------+            +-----------------+            +-----------------+            +-----------------+
                                |    |      subregions | <--------> | subregions_link | <--------> | subregions_link | <--------> | subregions_link |
                                |    +-----------------+            +-----------------+            +-----------------+            +-----------------+
                                |    |                 |            |       container |----o       |       container |----o       |       container |----o
                                o--> +-----------------+ <----o     +-----------------+    |       +-----------------+    |       +-----------------+    |
                                                              |                            |                              |                              |
                                                              |                            |                              |                              |
                                                              o----------------------------o------------------------------o------------------------------o




                                                                                                                                 Guest Physcial Memory
                                                                                                                                 GPA:0                   GPA:addr3                                         GPA:MAX
                                                                                                                                 |                       |                                                 |
                                                                                                                                 +-----------------------+-------------------------------------------------+
                                                                                                                                 |                       |                                                 |
                                                                                                                                 |                       |                                                 |
                                                                                                                                 +-----------------------+-------------------------------------------------+
                                                                                                                                                         A
                                                                                                                                                         |
                                                                                                                                                         |
                                                                                                                         o-------------------------------o
                                                                                                                         |
                                                                                                                         |       QEMU Virtual Space
                                                                                                                         |       HVA:addr0                      HAV:addr1                                  HAV:addr2
                                                                                                  RAMBlock (RB0)         |       |                              |                                          |
                                                                                                  +-----------------+    |       +------------------------------+------------------------------------------+
                                                                                                  |          offset |----o       |                              |                                          |
                                                                                                  +-----------------+            |                              |                                          |
                                                                                                  |            host |----------> +------------------------------+------------------------------------------+
                                    AddressSpace                    MemoryRegion (R3)             +-----------------+            A <--------- size0 ----------> A <--------------- size1 ----------------> |
                                    +----------------+              +-----------------+           |            size |            |                              |
                                    |                |              |                 |           +-----------------+            |                              |
                                    +----------------+              +-----------------+           |                 |            |                              |
                                    |                |              |       ram_block | --------> +-----------------+            |                              |
                                    +----------------+              +-----------------+                                          |                              |
                               o----|           root |              |                 |                                          |                              |
                               |    +----------------+              +-----------------+                                          |                              |
                               |    |                |              |                 |                                          |                              |
                               |    +----------------+              +-----------------+ <--o------------------------------o      |                              |
                               |                                                           |                              |      |                              |
                               |                                                           |                              |      |                              |
                               |                                                           |   o-------------------------(+)-----o                              |
                               |                                                           |   |                          |                                     |
                               |                                                           |   |                          |                                     |
                               |     MemoryRegion(Root)             MemoryRegion (R0)      |   |   MemoryRegion (R1)      |                                     |
                               |     +-----------------+            +-----------------+    |   |   +-----------------+    |                                     |
                               |     |                 |            |           alias |----o   |   |            alias|----o                                     |
                               |     +-----------------+            +-----------------+        |   +-----------------+                                          |
                               |     |                 |            |    alias_offset |--------o   |    alias_offset | -----------------------------------------o
                               |     +-----------------+            +-----------------+            +-----------------+               
                               |     |      subregions | <--------> | subregions_link | <--------> | subregions_link |
                               |     +-----------------+            +-----------------+            +-----------------+               
                               |     |                 |            |       container |--o         |       container |--o            
                               o---> +-----------------+            +-----------------+  |         +-----------------+  |            
                               |                                                         |                              |            
                               o---------------------------------------------------------o------------------------------o




                                                                                                                                 QEMU Address Space
                                                                                                                                 
                                                                                                                                 HVA:addr0                      HAV:addr1                                  HAV:addr2
                                                                                                  RAMBlock (RB0)                 |                              |                                          |
                                                                                                  +-----------------+            +------------------------------+------------------------------------------+
                                                                                                  |                 |            |                              |                                          |
                                                                                                  +-----------------+            |                              |                                          |
                                                                                                  |            host | -------->  +------------------------------+------------------------------------------+ 
                                    AddressSpace                    MemoryRegion (R3)             +-----------------+            A <--------- size0 ----------> A <--------------- size1 ----------------> |
                                    +----------------+              +-----------------+           |            size |            |                              |
                                    |                |              |                 |           +-----------------+            |                              |
                                    +----------------+              +-----------------+           |                 |            |                              |
                                    |                |              |       ram_block | --------> +-----------------+            |                              |
                                    +----------------+              +-----------------+                                          |                              |
                               o----|           root |              |                 |                                          |                              |
                               |    +----------------+              +-----------------+                                          |                              |
                               |    |                |              |                 |                                          |                              |
                               |    +----------------+              +-----------------+ <--o------------------------------o      |  o---------------------------o
                               |                                                           |                              |      |  |
                               |                                                           |                              |      |  |
                               |                                                           |   o-------------------------(+)-----o  |
                               |                                                           |   |                          |         |
                               |                                                           |   |                          |         |                
                               |     MemoryRegion(Root)             MemoryRegion (R0)      |   |   MemoryRegion (R1)      |         |            MemoryRegion (R2)  
                               |     +-----------------+            +-----------------+    |   |   +-----------------+    |         |            +-----------------+
                               |     |                 |            |           alias |----o   |   |            alias|----o         |            |    alias_offset |--------o
                               |     +-----------------+            +-----------------+        |   +-----------------+              |            +-----------------+        |
                               |     |                 |            |    alias_offset |--------o   |    alias_offset | -------------o            |           alias |-----o  |
                               |     +-----------------+            +-----------------+            +-----------------+                           +-----------------+     |  |
                               |     |      subregions | <--------> | subregions_link | <--------> | subregions_link | <-----------------------> | subregions_link |     |  |
                               |     +-----------------+            +-----------------+            +-----------------+                           +-----------------+     |  |
                               |     |                 |            |       container |--o         |       container |--o                        |       container |--o  |  |
                               o---> +-----------------+            +-----------------+  |         +-----------------+  |                        +-----------------+  |  |  |
                               |                                                         |                              |                                             |  |  |
                               o---------------------------------------------------------o------------------------------o---------------------------------------------o  |  |
                                                                                                                                                                         |  |
                                                              o----------------------------------------------------------------------------------------------------------o  |
                                                              |                                                                                                             |
                                                              |                                                                  o------------------------------------------o
                                                              |                                                                  |
                                                              |                                                                  V
                                                              |                                     RAMBlock (RB1)               | <------------------------- size2 -------------------------> | 
                                                              |       MemoryRegion (R4)             +-----------------+          +-------------------------------------------------------------+
                                                              |       +-----------------+           |                 |          |                                                             |
                                                              |       |                 |           +-----------------+          |                                                             |
                                                              |       +-----------------+           |            host |--------> +-------------------------------------------------------------+
                                                              |       |                 |           +-----------------+          | 
                                                              |       +-----------------+           |            size |          HVA:adr3                                                      HVA:addr4
                                                              |       |                 |           +-----------------+
                                                              |       +-----------------+           |                 |          QEMU Address Space
                                                              |       |       ram_block | --------> +-----------------+
                                                              o-----> +-----------------+                              
                                                                                                   
                                                                                                    
                                                                                                    
                                                                      



                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                                GPA:0        GPA:addr3                                            GPA:MAX
                                                                                                                                |            |                                                    |
                                                                                                                                +------------+----------------------------------------------------+
                                                                                                                                |            |                                                    |
                                                                                                                                +------------+----------------------------------------------------+
                                                                                                  RAMBlock (RB0)                             A
                                                                                                  +-----------------+                        |
                                                                                                  |          offset | -----------------------o
                                                                                                  +-----------------+
                                                                                                  |                 |
                                    AddressSpace                    MemoryRegion (R3)             +-----------------+           HVA:addr0               HVA:addr4                                 HAV:addr1
                                    +----------------+              +-----------------+           |            size |           |                       |                                         |
                                    |                |              |                 |           +-----------------+           +-----------------------+----+------------------------------------+
                                    +----------------+              +-----------------+           |            host | --------> |                       |    |                                    |
                                    |                |              |       ram_block | --------> +-----------------+           +-----------------------+----+------------------------------------+
                                    +----------------+              +-----------------+                                         A                       |
                               o----|           root |              |                 |                                         |                       |
                               |    +----------------+              +-----------------+                                         |                       |
                               |    |                |              |                 |                                         |                       V
                               |    +----------------+              +-----------------+ <--o                                    |              +-----------------+
                               |                                                           |                                    |              |   Page Tables   |
                               |                                                           |                                    |              +-----------------+
                               |                                                           |                                    |                       |
                               |                                                           |                                    |                       |
                               |                                                           |                                    |  HPA:0                | HPA:addr5                               HPA:MAX
                               |     MemoryRegion(Root)             MemoryRegion (R0)      |                                    |  |                    V                                         |
                               |     +-----------------+            +-----------------+    |                                    |  +--------------------+----+------------------------------------+
                               |     |                 |            |           alias |----o                                    |  |                    |    |                                    |
                               |     +-----------------+            +-----------------+                                         |  +--------------------+----+------------------------------------+
                               |     |                 |            |    alias_offset |-----------------------------------------o
                               |     +-----------------+            +-----------------+     
                               |     |      subregions | <--------> | subregions_link |                          
                               |     +-----------------+            +-----------------+                          
                               |     |                 |            |       container |--o                       
                               o---> +-----------------+            +-----------------+  |  
                               |                                                         |  
                               o---------------------------------------------------------o






                 TH000991.png





                 +-----------------------+                                                             +-------------------------+                        +-------------------------+
                 |                       |                                                             |                         |                spool   |                         |
                 | struct vm_area_struct |                                                             | struct hugetlbfs_config |            o---------->| struct hugepage_subpool |
                 |                       |                                                             |                         |            |           |                         |
                 +-----------------------+                                                             +-------------------------+            |           +-------------------------+
                            | vm_file                                                                                |                        |
                            V                                                                                        V                        |
                     +-------------+         +--------------+         +--------------------+           +--------------------------+           |           +---------------+
                     |             | f_inode |              |  i_sb   |                    | s_fs_info |                          |           |   hstate  |               |
                     | struct file |-------->| struct inode |-------->| struct super_block |---------->| struct hugetlbfs_sb_info |-----------o---------->| struct hstate |
                     |             |         |              |         |                    |           |                          |                       |               |
                     +-------------+         +--------------+         +--------------------+           +--------------------------+                       +---------------+





            Total = (1 << huge_page_shift(h)) * h->max_huge_pages * (size_opt)
                                                                    ----------
                                                                       100




                     struct hstate
                     +---------------------------+
                     |                           |
                     |        Counts Area        | 
                     |                           |
                     |             nr_huge_pages |
                     |           free_huge_pages |
                     |           resv_huge_pages |
                     |        surplus_huge_pages |
                     |   nr_overcommit_huge_page |
                     |      nr_huge_pages_node[] |
                     |    free_huge_pages_node[] |
                     | surplus_huge_pages_node[] |
                     +---------------------------+
                     |                           |
                     |        Linker Ares        |
                     |                           |
                     |                           |      +----------+      +----------+      +----------+      +----------+               +----------+
                     |       hugepage_activelist | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> ... <--> | HugePage |
                     |                           |      +----------+      +----------+      +----------+      +----------+               +----------+
                     |                           |                                                       
                     |                           |                                                       
                     |                           |      +----------+      +----------+      +----------+      +----------+      +----------+               +----------+
                     | hugepage_freelists[NODE0] | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> ... <--> | HugePage |
                     |                           |      +----------+      +----------+      +----------+      +----------+      +----------+               +----------+
                     |                           |                                                       
                     |                   ....... |                                                       
                     |                           |                                                       
                     |                           |      +----------+      +----------+      +----------+      +----------+               +----------+
                     | hugepage_freelists[NODEn] | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> ... <--> | HugePage |
                     |                           |      +----------+      +----------+      +----------+      +----------+               +----------+
                     |                           |
                     +---------------------------+
                     |      Base Information     |
                     |                           |
                     |                    name[] |
                     |                     order |
                     |                      mask |
                     +---------------------------+






                     nr_huge_pages = max_huge_pages + surplus_huge_pages




                    The Hugepge Pool

                    +------------------------------------------+----------------------+ <- Total_HugePages
                    |                                          |                      |
                    |              Free HugePages              |                      | <- Total_HugePages = Active_HugePages + Free_HugePages
                    |                                          |                      |
                    |---------------------+--------------------|                      |
                    |                     |                    |   Active HugePages   |
                    |                     |                    |                      |
                    |   Alloc HugePages   | Reserved HugePages |                      | <- Total_HugePages = Active_HugePages + (Alloc_HugePages + Reserved_HugePages)
                    |                     |                    |                      |
                    |                     +-----------+--------+                      |
                    |                     | GLOBAL_Rs |  Spool |                      | <- Total_HugePages = Active_HugePages + (Alloc_HugePages + (GLOBAL_RS + Spool))
                    +---------------------+-----------+--------+----------------------+
                    


                   The HugePage Pool

                   | <----- Total HugePages -----> | <--- nr_overcommit_huge_pages ---> |
                   +-------------------------------+
                   |      Persistent HugePage      |                                      <- Total_HugePages = Persisten_HugePages
                   +-------------------------------+
                                  |
                                  | Expand Pool
                                  |
                                  V
                                                   | <--- nr_overcommit_huge_pages ---> |
                   | <-------------------- Total HugePages --------------------> |
                   +-------------------------------+-----------------------------+
                   |      Persistent HugePage      |      Surplus HugePages      |        <- Total_HugePages = Persisten_HugePages + Surplus_HugePages
                   +-------------------------------+-----------------------------+
                                  |
                                  | Shrink Pool
                                  |
                                  V
                                                   | <--- nr_overcommit_huge_pages ---> |
                   | <--------------- Total HugePages ---------------> |
                   +-------------------------------+-------------------+
                   |      Persistent HugePage      | Surplus HugePages |                  <- Total_HugePages = Persisten_HugePages + Surplus_HugePages
                   +-------------------------------+-------------------+
            









                    +----------------+  +----------------+  +----------------+
                    |                |  |                |  |                |
                    |  ProcessA:VMA  |  |  ProcessB:VMA  |  |  ProcessC:VMA  |
                    |                |  |                |  |                |
                    +----------------+  +----------------+  +----------------+
                             |                   |                   |
                             |                   |                   |
                             |                   |                   |
                             o------------------(+)------------------o
                                                 |
                                       Anonymous | shared
                                                 V
                                      +----------------------+
                                      |                      |
                                      |   Hugetlb Hugepage   |
                                      |                      |
                                      +----------------------+






     vcpu_run
       |
       o-> vcpu_enter_guest
             |
             o-> kvm_mmu_reload
                   |
                   o-> kvm_mmu_load
                         |
                         o-> mmu_topup_memory_caches
                         |
                         o-> mmu_alloc_roots 
                         |     |
                         |     o-> mmu_alloc_direct_roots
                         |     |     |
                         |     |     o-> make_mmu_pages_available
                         |     |
                         |     o-> kvm_mmu_get_page
                         |
                         o-> kvm_mmu_load_cr3
                         |
                         o-> vmx_tlb_flush




                           +----------------+       +----------------------------+       +----------------+ 
                           |        | ----> |                      | ----> |        |
                           +----------------+       +----------------------------+       +----------------+ 
                                   A                   |  A                |  A                  A
                                   |                   |  |                |  |                  |
                                   |             +-----|--|----------------|--|-----+            |
                                   |             |     V  |                V  |     |            |
                                   |             |  +--------+          +--------+  |            |
                                   |             |  |  |          |  |---------------o
                                   |             |  +--------+          +--------+  |
                                   |             |                           |      |
                                   o-----------------------------------------o      |
                                                 |                                  |
                                                 |                            CPU   |
                                                 +----------------------------------+



                                       
                                                         +-------------+    +------+                                         +-------------+
                                                         |             |    |      |                                         |             |
                                                         |             |    |      |                                         |             |
                                             |             |    |      |                                 |             |
                            +---------------+            |             |    |      |            +---------------+            |             | 
                            |               |            |             |    |      |            |               |            |             |
                            |               |            |             |    |      |            |               |            |             |
                            |               |            | Instruction |    |      |            |               |            |             |
                            |      CPU      | <--------> |      &      |    | Data | <--------> |      CPU      | <--------> | Instruction |
                            |               |            |    Data     |    |      |            |               |            |             |
                            |               |            |             |    |      |            |               |            |             |
                            |               |            |             |    |      |            |               |            |             |
                            +---------------+            |             |    |      |            +---------------+            |             |
                                                         |             |    |      |                                         |             |
                                                         |             |    |      |                                         |             |
                                                         |             |    |      |                                         |             |
                                                         +-------------+    +------+                                         +-------------+




                            +--------------------------------------------+     +--------------------------------------------+
                            |                                            |     |                                            |
                            |                                            |     |                                            |
                            |                    CPU                     |     |                    CPU                     |
                            |                                            |     |                                            |
                            |                                            |     |                                            |
                            +--------------------------------------------+     +--------------------------------------------+
                            |                CPU Register                |     |                CPU Register                |
                            +--------------------------------------------+     +--------------------------------------------+
                                               |     A                                            |     A                     
                                               V     |                                            V     |                     
                            +--------------------------------------------+     +--------------------------------------------+
                            |              CPU Cache Memory              |     |              CPU Cache Memory              |
                            +--------------------------------------------+     +--------------------------------------------+
                                               |     A                                            |     A                     
                                               V     |                                            V     |                     
                            +-----------------------------------------------------------------------------------------------+
                            |                                                                                               |
                            |                                         RAM Main Memory                                       |
                            |                                                                                               |
                            +-----------------------------------------------------------------------------------------------+
                                                                         |     A                                       
                                                                         |     |                                       
                                                                         V     |                                       
                            +-----------------------------------------------------------------------------------------------+
                            |                                                                                               |
                            |                         Storage: Disk/SSD/NVMe/STA/ESSD/Floppy/CD-ROM                         |
                            |                                                                                               |
                            +-----------------------------------------------------------------------------------------------+





                            +-------------+           +--------+            +---------+              +-------------+            +-------+              +----------+       +-----+
                            |             |  Compile  |        |  Install   |         |  read/write  |             |  Hit/Miss  |       |  load/store  |          |  MOV  |     |
                            | Source Code | --------> | Binary | ---------> | Storage | <----------> | Main Memory | <--------> | Cache | <----------> | Register | <---> | CPU |
                            |             |           |        |            |         |              |             |            |       |              |          |       |     |
                            +-------------+           +--------+            +---------+              +-------------+            +-------+              +----------+       +-----+




                            +----+
                            |    | Register
                            +----+
                            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                            | | | | | | | | | | | | | | | TLB
                            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                            +----+----+----+----+----+----+----+----+
                            |    |    |    |    |    |    |    |    | Cache
                            +----+----+----+----+----+----+----+----+
                            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                            | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | 
                            | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | Main Memory 
                            | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | |
                            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                            +----+----+----+----+-------------------------------------------------------------------------------+----+----+
                            |    |    |    |    |                                                                               |    |    |
                            |File|File|File|File| ............................................................................. |File|File| Disk Storage
                            |    |    |    |    |                                                                               |    |    |
                            +----+----+----+----+-------------------------------------------------------------------------------+----+----+

                            


                            +-----+                                                           +-----------------+
                            |     |-+                                                         |                 |
                            |     | |------addr[31]------>|                                   |                 |
                            |     | |------addr[30]------>|           Address Bus             |                 |
                            |     | |------........------>|=================================> |                 |
                            |     | |------addr[1]------->|                                   |                 |
                            |     | |------addr[0]------->|                                   |                 |
                            |     |-+                                                         |                 |
                            | CPU |                                                           |   Main Memory   |
                            |     |-+                                                         |                 |
                            |     | |<-----data[31]------>|                                   |                 |
                            |     | |<-----data[30]------>|             Data Bus              |                 |
                            |     | |<-----........------>|<================================> |                 |
                            |     | |<-----data[1]------->|                                   |                 |
                            |     | |<-----data[0]------->|                                   |                 |
                            |     |-+                                                         |                 |
                            |     |                                   Control Bus             |                 |
                            |     |=========================================================> |                 |
                            +-----+                                                           +-----------------+


                            +-----+                                                                    Main Memory
                            |     |                                                                    +-----------------+ -----
                            |     |                                                                    |       ...       |   A
                            |     |                                                                    +-----------------+   |
                            |     |                                                                    | ADR:0x100000001 | Unaddressable
                            |     |                                                                    +-----------------+   |
                            |     |                                                                    | ADR:0x100000000 |   V
                            |     |                                                                    +-----------------+ -----
                            | CPU |                                                                    | Addr:0xffffffff |   A
                            |     |                                                                    +-----------------+   |
                            |     |                                                                    | Addr:0xfffffffe |   |
                            |     |                                                                    +-----------------+   |
                            |     |                                                                    |       ...       |   |
                            |     |                                                                    +-----------------+   |
                            |     | Address Bus                                                        | Address:0x10002 |   |
                            |     | -----------------------addr[31]------------------------> |         +-----------------+   |
                            |     | -----------------------addr[30]------------------------> |         | Address:0x10001 | Addressable
                            |     | -----------------------addr[29]------------------------> |         +-----------------+   |
                            |     | -----------------------addr[28]------------------------> |         | Address:0x10000 |   |
                            |     | -----------------------.......-------------------------> |=======> +-----------------+   |
                            |     | -----------------------addr[3]-------------------------> |         | Address:0x0ffff |   |
                            |     | -----------------------addr[2]-------------------------> |         +-----------------+   |
                            |     | -----------------------addr[1]-------------------------> |         |       ...       |   |
                            |     | -----------------------addr[0]-------------------------> |         +-----------------+   |              
                            +-----+                                                                    | Adderss:0x00001 |   |
                                                                                                       +-----------------+   |
                                                                                                       | Address:0x00000 |   V
                                                                                                       +-----------------+ -----



                     


                          Physical Memory 

                          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+---------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                          | | | | | | | | | | | | | | | | | | | | | | |         | | | | | | | | | | | | | | | | | | | | | | | |
                          | | | | | | | | | | | | | | | | | | | | | | |  .....  | | | | | | | | | | | | | | | | | | | | | | | |
                          | | | | | | | | | | | | | | | | | | | | | | |         | | | | | | | | | | | | | | | | | | | | | | | |
                          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+---------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                           | | | | | | |  | |
                           0 1 2 3 4 5 6  | o----
                                          |    A
                                          |    |
                                          |  1 Byte
                                          |    |
                                          |    V
                                          o------

                          Physical Memory
                                            | <- PAGE_SIZE -> |
                          +-----------------+-----------------+---------+-----------------+----------------+-----------------+
                          |                 |                 |         |                 |                |                 |
                          |                 |                 |  ....   |                 |                |                 |
                          |                 |                 |         |                 |                |                 |
                          +-----------------+-----------------+---------+-----------------+----------------+-----------------+
                          |                 |                                          
                          PFN:0             PFN:1
                           


                                      +--------+     +-----------+      +------------+     +---------+
                                      |        |     |           |      |            |     |         |
                                      |  CMOS  |     | Interrupt |      |    DMA     |     |  Timer  |
                                      |        |     |           |      | Controller |     |         |
                                      +--------+     +-----------+      +------------+     +---------+
                                         A A A           A A A              A A A             A A A
                                         | | |           | | |              | | |             | | |
                         +-----------+   | | |           | | |              | | |             | | |
                         |           |--(+)|-|----------(+)|-|-------------(+)|-|------------(+)|-|----------> Address Bus
                         |    CPU    |<--|(+)|-----------|(+)|--------------|(+)|-------------|(+)|----------> Data Bus
                         |           |---|-|(+)----------|-|(+)-------------|-|(+)------------|-|(+)---------> Control Bus
                         +-----------+   | | |           | | |              | | |             | | |
                                         | | |           | | |              | | |             | | |
                                         V V V           V V V              V V V             V V V     
                                     +----------+     +---------+        +---------+       +--------+   
                                     |          |     |         |        |         |       |        |   
                                     |  Memory  |     | Display |        | Printer |       |  Disk  |   
                                     |          |     |         |        |         |       |        |   
                                     +----------+     +---------+        +---------+       +--------+   


                         Address Bus Space
                         0                                                                                           0x100000000
                         |                                                                                           |
                         +------+-------------+---------+-----------+-------------+---------+------+----------+--------+---------+
                         |      |             |         |           |             |         |      |          |        |         |
                         | CMOS | Main Memory | PCI BUS | Video ROM | Main Memory | PCI BUS | HPET | Reserved | IOAPCI | PCI BUS |
                         |      |             |         |           |             |         |      |          |        |         |
                         +------+-------------+---------+-----------+-------------+---------+------+----------+--------+---------+
                      

			 Main Memory
                                           | <- PAGE_SIZE -> |
                         +-----------------+-----------------+--------------+-----------------+----------------+-----------------+
                         |                 |                 |              |                 |                |                 |
                         |                 |                 |     ....     |                 |                |                 |
                         |                 |                 |              |                 |                |                 |
                         +-----------------+-----------------+--------------+-----------------+----------------+-----------------+
                         |                                                           
                         PFN = PHYS>>PAGE_SHIFT
                           



                         Virtual Memory Space                     
                       
                         +-------------------------------------------------------------------+----------------------------------+
                         |                                                                   |                                  |
                         |                                                                   |                                  |
                         |                                                                   |                                  |
                         +-------------------------------------------------------------------+----------------------------------+
                         | <-------------------------- UserSpace --------------------------> | <-------- Kernel Space --------> |
                         |                                                                   |
                         0                                                                   PAGE_OFFSET

                         Physical Memory Space

                         +---------------------------------------------------+
                         |                                                   |
                         |                                                   |
                         |                                                   |
                         +---------------------------------------------------+
                         |                                                   |
                         PFN:X                                               PFN:Y






                       Page Table on Translation to a 4KiB Page using 32-Bit Paging

                        31                         22 21                       12 11                             0
                       +-----------------------------+---------------------------+--------------------------------+
                       |          Directroy          |           Table           |             Offset             |
                       +-----------------------------+---------------------------+--------------------------------+
                                      |                            |
                                      |                            |
                                      |                            |
                                      |                            |   Page Table
                                      |                            |   +---------------+
                                      |                            |   |               |
                                      |   Page Directory           |   +---------------+
                                      |   +---------------+        |   |               |
                                      |   |               |        |   +---------------+
                                      |   +---------------+        o-> | PTE with PS=0 |
                                      |   |               |            +---------------+
                                      |   +---------------+            |               |
                                      |   |               |            +---------------+
                                      |   +---------------+            |               |
                                      |   |               |     o----> +---------------+
                                      |   +---------------+     |
                                      o-> | PDE with PS=0 | ----o
                                          +---------------+
                       +-----------+      |               |
                       |    CR3    | ---> +---------------+
                       +-----------+





                       Virtual Memory Space
                       0                                                           PAGE_OFFSET
                       | <---------------------- UserSpace ----------------------> | <--------- Kernel Space --------> |
                       +-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+-----+
                       |     |     |     |     |     |           |     |     |     |     |     |     |     |     |     |
                       |     |     |     |     |     |    ...    |     |     |     |     |     |     |     |     |     |
                       |     |     |     |     |     |           |     |     |     |     |     |     |     |     |     |
                       +-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+-----+
                                |     |           |
                                |     |           |
                          o-----o     |     o-----o
                          |           |     |
                          V           V     V
                       +-----+-----+-----+-----+-----+-----------+-----+-----+
                       |     |     |     |     |     |           |     |     |
                       |     |     |     |     |     |    ...    |     |     | Physical Memory Space
                       |     |     |     |     |     |           |     |     |
                       +-----+-----+-----+-----+-----+-----------+-----+-----+
                       |           |     |
                       PFN:n       PFN:m PFN:x
                  
                      


                       Virtual Memory Space
                       0                                                           PAGE_OFFSET
                       | <---------------------- UserSpace ----------------------> | <--------------- Kernel Space --------------> |
                       |                                                           | <- Linear Mapping Spaces -> |                 |
                       +-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+-----------+-----+
                       |     |     |     |     |     |           |     |     |     |     |     |     |     |     |           |     |
                       |     |     |     |     |     |    ...    |     |     |     |     |     |     |     |     |    ...    |     |
                       |     |     |     |     |     |           |     |     |     |     |     |     |     |     |           |     |
                       +-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+-----------+-----+
                                                                                      |     |     |     |     |
                                                                                      |     |     |     |     |
                                                                                      |     |     |     |     |
                                                                                      |     |     |     |     |
                                                                                      V     V     V     V     V
                                                                                   +-----+-----+-----+-----+-----+-----------+-----+
                                                                                   |     |     |     |     |     |           |     |
                                                             Physical Memory Space |     |     |     |     |     |    ...    |     |
                                                                                   |     |     |     |     |     |           |     |
                                                                                   +-----+-----+-----+-----+-----+-----------+-----+
                                                                                   |           |           |
                                                                                   PFN:n       PFN:n+2     PFN:n+4
                  
                      




                                                                    struct memblock_region
                                                  struct            +------+------+--------+------+
                                                  memblock_type     |      |      |        |      |
                                                  +----------+      | Reg0 | Reg1 | ...    | Regn |
                                                  |          |      |      |      |        |      |
                                                  | regions -|----->+------+------+--------+------+
                                                  | cnt      |      [memblock_memory_init_regions]
                                                  |          |
                            struct           o--->+----------+
                            memblock         |
                            +-----------+    |
                            |           |    |
                            | memory   -|----o
                            | reserved -|----o
                            |           |    |                      struct memblock_region
                            +-----------+    |    struct            +------+------+--------+------+
                                             |    memblock_type     |      |      |        |      |
                                             o--->+----------+      | Reg0 | Reg1 | ...    | Regn |
                                                  |          |      |      |      |        |      |
                                                  | regions -|----->+------+------+--------+------+
                                                  | cnt      |      [memblock_reserved_init_regions]
                                                  |          |
                                                  +----------+





                             MEMBLOCK Allocator

                                                               struct memblock_type       struct memblock_region                        
                                                               +-------------------+      +--------+--------+--------+---------+--------+
                                                               |                   |      |        |        |        |         |        |
                             struct memblock              o--> |                   |----> |  Reg0  |  Reg1  |  Reg2  |   ...   |  Regn  |
                             +--------------+             |    |                   |      |        |        |        |         |        |
                             |              |   memory    |    +-------------------+      +--------+--------+--------+---------+--------+
                             |              |-------------o
                             |              |            
                             |              |-------------o    struct memblock_type       struct memblock_region                        
                             |              |  reserved   |    +-------------------+      +--------+--------+--------+---------+--------+
                             +--------------+             |    |                   |      |        |        |        |         |        |
                                                          o--> |                   |----> |  Reg0  |  Reg1  |  Reg2  |   ...   |  Regn  |
                                                               |                   |      |        |        |        |         |        |
                                                               +-------------------+      +--------+--------+--------+---------+--------+



                            Flat Model

                            struct page mem_map[]
                            +-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                            | | | | | | | | | |       | | | | | | |
                            | | | | | | | | | |  ...  | | | | | | |
                            | | | | | | | | | |       | | | | | | |
                            +-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                             | | | | |
                             | | | | o---------------o
                             | | | o-----------o     |
                             | | o-------o     |     |
                             | o---o     |     |     |
                             |     |     |     |     |             Physical Memory Space
                             V     V     V     V     V                
                             +-----+-----+-----+-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+
                             |     |     |     |     |     |     |     |     |           |     |     |     |     |     |     |     |     |
                             |     |     |     |     |     |     |     |     |    ...    |     |     |     |     |     |     |     |     |
                             |     |     |     |     |     |     |     |     |           |     |     |     |     |     |     |     |     |
                             +-----+-----+-----+-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+
                             |           |           |
                             PFN:n       PFN:n+2     PFN:n+4


                           SPARSE Model

                           struct mem_section
                           +-+-+---+-+-+-+-+-+-+
                           | | |   | | | | | | |
                           | | | . | | | | | | | SECTION_ROOT
                           | | |   | | | | | | |
                           +-+-+---+-+-+-+-+-+-+                  struct mem_section                   struct page []                           
                              |       |                           +-----------------+                  +-+-+-+-+-+-----+-+-+-+-+
                              |       |                           |                 | section_mem_map  | | | | | |     | | | | |
                              |       o-------------------------> |                 |----------------> | | | | | | ... | | | | |
                              |                                   |                 |                  | | | | | |     | | | | |
                              |                                   +-----------------+                  +-+-+-+-+-+-----+-+-+-+-+
                              |                                                                         | |
                              |     struct mem_section                   struct page []                 | |
                              |     +-----------------+                  +-+-+-+-+-+-----+-+-+-+-+      | |
                              |     |                 | section_mem_map  | | | | | |     | | | | |      | | 
                              o---> |                 |----------------> | | | | | | ... | | | | |      | |
                                    |                 |                  | | | | | |     | | | | |      | |
                                    +-----------------+                  +-+-+-+-+-+-----+-+-+-+-+      | |
                                                                          | |                           | |
                                                                          | o---o                       | o---o
                                                                          |     |                       |     |
                              Physical Memory                             V     V                       V     V
                              +-----+-----+-----+-----+-------------------+-----+-----+-----+-----+     +-----+-----+-----+-----+
                              |     |     |     |     |                   |     |     |     |     |     |     |     |     |     |
                              |     |     | ... |     |        ...        |     |     | ... |     |     |     |     | ... |     |
                              |     |     |     |     |                   |     |     |     |     |     |     |     |     |     |
                              +-----+-----+-----+-----+-------------------+-----+-----+-----+-----+     +-----+-----+-----+-----+
                              |           |           |                   | <--- SECTION_SIZE --> |     | <--- SECTION_SIZE --> |
                              PFN:n       PFN:n+2     PFN:n+4



                                16MiB                 896MiB                  4G
                                |                     |                       |
               +----------------+---------------------+-----------------------+
               |                |                     |                       |
          IA32 |                |                     |                       |
               |                |                     |                       |
               +----------------+---------------------+-----------------------+
               | <- ZONE_DMA -> | <-- ZONE_NORMAL --> | <---- ZONE_HIGH ----> |


                                16MiB                                         4Gig                              
                                |                                             |                                 
               +----------------+---------------------------------------------+-----------------------------------------+
               |                |                                             |                                         |
         AMD64 |                |                                             |                                         |
               |                |                                             |                                         |
               +----------------+---------------------------------------------+-----------------------------------------+
               | <- ZONE_DMA -> | <-------------- ZONE_DMA32 ---------------> | <------------ ZONE_NORMAL ------------> |




               
                                   ---------------+---------------+------------------
                                                  |               |
               Kernel Space                       |               |
                                                  |               |
                                   ---------------+---------------+------------------
                                                  |               |                      
                                                  |               |                      
                                                  V               V
                                   ---------------+-------------------------+--------
                                                  |                         |        
               Physical Memory                    |         CMA/DMA         |        
                                                  |                         |        
                                   ---------------+-------------------------+--------



               Virtual Memory Space          
                                                                                    
               +------------------------------------------------+        +--------------------------------------+
               |                                                |        |                                      |
               |                    Userspace                   | <----> |             Kernel Space             |
               |                                                |        |                                      |
               +------------------------------------------------+        +--------------------------------------+
 


               IA32 Virtual Memory Space
                
               0                                                      PAGE_OFFSET                              4G
               |                                                      |                                        |
               +------------------------------------------------------+----------------------------------------+
               |                                                      |                                        |
               |                      Userspace                       |              Kernel Space              |
               |                                                      |                                        |
               +------------------------------------------------------+----------------------------------------+

               IA32 Virtual Address

                31                                                                                            0
               +-----------------------------------------------------------------------------------------------+
               |                                        Linear Address                                         |
               +-----------------------------------------------------------------------------------------------+



 

               AMD64 48-bit implementation Virtual Memory Space


               | <-------- USerspace -------> |                                        | <------ Kernel Space ------> |
               +------------------------------+----------------------------------------+------------------------------+
               |                              |                                        |                              |
               |    Canonical "Lower half"    |       Noncanonical Address Space       |    Canonical "Higer half"    |
               |                              |                                        |                              |
               +------------------------------+----------------------------------------+------------------------------+
               | <--------- 128TiB ---------> |                                        | <--------- 128TiB ---------> |
               0                              0x00007FFFFFFFFFFF                       0xFFFF800000000000             |
                                                                                                      0xFFFFFFFFFFFFFFF

               AMD64 56-bit implementation Virtual Memory Space

               | <----------- USerspace ----------> |                            | <--------- Kernel Space ---------> |
               +------------------------------------+----------------------------+------------------------------------+
               |                                    |                            |                                    |
               |       Canonical "Lower half"       | Noncanonical Address Space |       Canonical "Higer half"       |
               |                                    |                            |                                    |
               +------------------------------------+----------------------------+------------------------------------+
               | <------------ 32PiB -------------> |                            | <------------ 32PiB -------------> |
               0                                    0x007FFFFFFFFFFFFF           0xFF80000000000000                   |
                                                                                                      0xFFFFFFFFFFFFFFF
   
               AMD64 64-bit implementation Virtual Memory Space

               | <------------------ USerspace -----------------> | <---------------- Kernel Space -----------------> |
               +--------------------------------------------------+---------------------------------------------------+
               |                                                  |                                                   |
               |                    Lower half                    |                    Higher half                    |
               |                                                  |                                                   |
               +--------------------------------------------------+---------------------------------------------------+
               | <------------------- 16EiB --------------------> | <------------------- 16EiB ---------------------> |
               0                                                  0x8000000000000000                                  |
                                                                                                      0xFFFFFFFFFFFFFFF
                                       

                     
              AMD64/X64 Virtual Address

               63            48 47                                                                                   0
              +----------------+--------------------------------------------------------------------------------------+
              | Sign Extension |                                    Linear Address                                    |
              +----------------+--------------------------------------------------------------------------------------+




                        Process Address Space Layout          

                                 --- +------------------------------------+ <-- 0xffffffff
                                  A  |                                    |
                                  |  |                                    |
                            Share |  |            Kernel Space            |
                                  |  |                                    |
                                  V  |                                    |
                                 --- +------------------------------------+ <-- PAGE_OFFSET
                                  A  |            argv,environ            |
                                  |  +------------------------------------+ <-- Stack bottom
                                  |  |              Stack                 |
                                  |  |                |                   |
                                  |  |                |                   |
                                  |  |                V                   |
                                  |  +------------------------------------+ <-- Stack top
                                  |  |                                    |
                                  |  |                                    |
                                  |  |          Unallocate Areas          |
                                  |  |                                    |
                                  |  |                                    |
                                  |  +------------------------------------+ ---
                                  |  |                                    |  A
                                  |  |             MMAP Areas             |  | mmap()/malloc(big)
                                  |  |                                    |  V
                        Userspace |  +------------------------------------+ ---
                                  |  |                                    |
                                  |  |          Unallocate Areas          |
                                  |  |                                    |
                                  |  +------------------------------------+ ---
                                  |  |                A                   |  A
                                  |  |                |                   |  | brk()/malloc(small)
                                  |  |               Heap                 |  V
                                  |  +------------------------------------+ ---
                                  |  |              .bss                  |  A
                                  |  +------------------------------------+  |
                                  |  |                                    |  | Data Segment
                                  |  |              .data                 |  |
                                  |  |                                    |  V
                                  |  +------------------------------------+ ---
                                  |  |                                    |  A
                                  |  |              .text                 |  | Code Segment
                                  |  |                                    |  V
                                  |  +------------------------------------+ <-- __executable_start
                                  V  |            Reserved Area           |
                                 --- +------------------------------------+ <-- 0x00000000
    






                  Virtual Memory Space
                            
            
                            | <------------------------------- Userspace -------------------------------> |         | <---- Kernel Space ----> |

                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+
                            |     |       |       |      |         |     |        |     |           |     |
                  Process0  | RSV | .text | .data | .bss | Heap -> | ... |  MMAP  | ... | <- Stack  | Env | <--o
                            |     |       |       |      |         |     |        |     |           |     |    |
                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+    |
                                                                                                               |
                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+    |    +--------------------------+
                            |     |       |       |      |         |     |        |     |           |     |    o--> |                          |
                  Process1  | RSV | .text | .data | .bss | Heap -> | ... |  MMAP  | ... | <- Stack  | Env | <-----> |       Kernel Space       |
                            |     |       |       |      |         |     |        |     |           |     |    o--> |                          |
                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+    |    +--------------------------+
                                                                                                               |
                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+    |
                            |     |       |       |      |         |     |        |     |           |     |    |
                  Process2  | RSV | .text | .data | .bss | Heap -> | ... |  MMAP  | ... | <- Stack  | Env | <--o
                            |     |       |       |      |         |     |        |     |           |     |
                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+




                          32-Bit Paging

                           31                             22 21                             12 11                       0
                          +---------------------------------+---------------------------------+--------------------------+
                          |            Directory            |              Table              |          Offset          |
                          +---------------------------------+---------------------------------+--------------------------+
                                           |                                 |                              |
                                           |                                 |                              |   4KiB Page
                                           |                                 |                              |   +---------------+
                                           |                                 |                              |   |               |
                                           |                                 |                              |   +---------------+
                                           |                                 |                              o-> | Physical Addr |
                                           |                                 |   Page Table                     +---------------+
                                           |                                 |   +---------------+              |               |
                                           |                                 |   |               |              |               |
                                           |                                 |   |               |              |               |
                                           |                                 |   |               |              |               |
                                           |                                 |   +---------------+              |               |
                                           |   Page Directory                o-> |      PTE      | -----------> +---------------+
                                           |   +---------------+                 +---------------+
                                           |   |               |                 |               |
                                           |   |               |                 |               |
                                           |   +---------------+                 |               |
                                           o-> |      PDE      | ------------->  +---------------+
                                               +---------------+
                                               |               |
                                               |               |
                                               |               |
                          +-------+            |               |
                          |  CR3  | ---------> +---------------+
                          +-------+                           
                  



                          4-level Paging

                           47              39 38                  30 29              21 20                12 11                   0
                          +------------------+----------------------+------------------+--------------------+---------------------+
                          |       PML4       |    Directory Ptrs    |     Directory    |       Table        |        Offset       |
                          +------------------+----------------------+------------------+--------------------+---------------------+
                                   |                     |                    |                  |                      |
                                   |                     |                    |                  |                      |   4KiB Page
                                   |                     |                    |                  |                      |   +---------------+
                                   |                     |                    |                  |                      |   |               |
                                   |                     |                    |                  |                      |   +---------------+
                                   |                     |                    |                  |                      o-> | Physical Addr |
                                   |                     |                    |                  |   Page Table             +---------------+ 
                                   |                     |                    |                  |   +-----------+          |               |
                                   |                     |                    |                  |   |           |          |               |
                                   |                     |                    |                  |   |           |          |               |
                                   |                     |                    |   Page-Directory |   |           |          |               |
                                   |                     |                    |   +-----------+  |   +-----------+          |               |
                                   |                     |                    |   |           |  o-> |    PTE    | -------> +---------------+
                                   |                     |   Page-Directory   |   |           |      +-----------+      
                                   |                     |   Pointer Table    |   |           |      |           |      
                                   |                     |   +-----------+    |   +-----------+      |           |      
                                   |                     |   |           |    o-> |    PDE    | ---> +-----------+      
                                   |                     |   |           |        +-----------+                         
                                   |   PML4 Table        |   |           |        |           |                         
                                   |   +-----------+     |   +-----------+        |           |                         
                                   |   |           |     o-> |   PDPTE   | -----> +-----------+
                                   |   |           |         +-----------+                      
                                   |   |           |         |           |         
                                   |   +-----------+         |           |         
                                   o-> |   PML4E   | ------> +-----------+         
                                       +-----------+
                                       |           |
                          +-------+    |           |
                          |  CR3  | -> +-----------+
                          +-------+


                                                              5-level Paging
  
                                                               55              48 47              39 38                  30 29              21 20                12 11                   0
                                                              +------------------+------------------+----------------------+------------------+--------------------+---------------------+
                                                              |       PML5       |       PML4       |    Directory Ptrs    |     Directory    |       Table        |        Offset       |
                                                              +------------------+------------------+----------------------+------------------+--------------------+---------------------+
                                                                       |                  |                     |                    |                  |                      |
                                                                       |                  |                     |                    |                  |                      |   4KiB Page
                                                                       |                  |                     |                    |                  |                      |   +---------------+
                                                                       |                  |                     |                    |                  |                      |   |               |
                                                                       |                  |                     |                    |                  |                      |   +---------------+
                                                                       |                  |                     |                    |                  |                      o-> | Physical Addr |
                                                                       |                  |                     |                    |                  |   Page Table             +---------------+
                                                                       |                  |                     |                    |                  |   +-----------+          |               |
                                                                       |                  |                     |                    |                  |   |           |          |               |
                                                                       |                  |                     |                    |                  |   |           |          |               |
                                                                       |                  |                     |                    |   Page-Directory |   |           |          |               |
                                                                       |                  |                     |                    |   +-----------+  |   +-----------+          |               |
                                                                       |                  |                     |                    |   |           |  o-> |    PTE    | -------> +---------------+
                                                                       |                  |                     |   Page-Directory   |   |           |      +-----------+
                                                                       |                  |                     |   Pointer Table    |   |           |      |           |
                                                                       |                  |                     |   +-----------+    |   +-----------+      |           |
                                                                       |                  |                     |   |           |    o-> |    PDE    | ---> +-----------+
                                                                       |                  |                     |   |           |        +-----------+
                                                                       |                  |   PML4 Table        |   |           |        |           |
                                                                       |                  |   +-----------+     |   +-----------+        |           |
                                                                       |                  |   |           |     o-> |   PDPTE   | -----> +-----------+
                                                                       |                  |   |           |         +-----------+
                                                                       |   PML5 Table     |   |           |         |           |
                                                                       |   +-----------+  |   +-----------+         |           |
                                                                       |   |           |  o-> |   PML4E   | ------> +-----------+
                                                                       |   |           |      +-----------+
                                                                       |   |           |      |           |
                                                                       |   +-----------+      |           |
                                                                       o-> |   PML5E   | ---> +-----------+
                                                                           +-----------+
                                                                           |           |
                                                              +-------+    |           |
                                                              |  CR3  | -> +-----------+
                                                              +-------+



                         

                                                                                                   +----------------------+ ---
                                                                                                   |       BiscuitOS      |  Nested Guest OS
                                                                                                   +----------------------+ ---
                                                                                                   |        Broiler       |  Nested 
                                   +----------------------+        +----------------------+        +----------------------+ ---
                                   |                      |        |                      |        |                      |  A
                                   |       BiscuitOS      |        |       BiscuitOS      |        |       BiscuitOS      |  | Guest OS
                                   |                      |        |                      |        |                      |  V
                                   +----------------------+        +----------------------+        +----------------------+ ---
                                   |         QEMU         |        |        Broiler       |        |        Broiler       | Host Userspace
                                   +----------------------+        +----------------------+        +----------------------+ ---
                                   ======================================================================================== 
                                   +----------------------+        +----------------------+        +----------------------+ --- 
                                   |    KVM(Intel-VMX)    |        |    KVM(Intel-VMX)    |        |    KVM(Intel-VMX)    | Host Kernel Space 
                                   +----------------------+        +----------------------+        +----------------------+ ---
                                   |  Intel Hardware(i7)  |        |  Intel Hardware(i7)  |        |  Intel Hardware(i7)  | Hardware
                                   +----------------------+        +----------------------+        +----------------------+ ---
                                           QEMU+KVM                       Broiler+KVM                 Nested(Broiler+KVM)




 

                                                                                                                                +----------------------+ ---
                                                                                                                                |       BiscuitOS      |  Nested Guest OS
                                                                                                                                +----------------------+ ---
                                                                                                                                |        Broiler       |  Nested
                                   +----------------------+       +----------------------+       +----------------------+       +----------------------+ ---
                                   |                      |       |                      |       |                      |       |                      |  A
                                   |        Broiler       |       |       Broiler        |       |      BiscuitOS       |       |       BiscuitOS      |  | Guest OS
                                   |                      |       |                      |       |                      |       |                      |  V
                                   +----------------------+       +----------------------+       +----------------------+       +----------------------+ ---
                                   |     Linux Distro     |       |      BiscuitOS       |       |       Broiler        |       |        Broiler       | Host Userspace
                                   +----------------------+       +----------------------+       +----------------------+       +----------------------+ ---
                                   =====================================================================================================================
                                   +----------------------+       +----------------------+       +----------------------+       +----------------------+ ---
                                   |    KVM(Intel-VMX)    |       |    KVM(Intel-VMX)    |       |    KVM(Intel-VMX)    |       |    KVM(Intel-VMX)    | Host Kernel Space
                                   +----------------------+       +----------------------+       +----------------------+       +----------------------+ ---
                                   |  Intel Hardware(i7)  |       |  Intel Hardware(i7)  |       |  Intel Hardware(i7)  |       |  Intel Hardware(i7)  | Hardware
                                   +----------------------+       +----------------------+       +----------------------+       +----------------------+ ---
                                           Broiler                    BiscuitOS+Broiler              Broiler+BiscuitOS               Broiler+Broiler           
                                            PlanA                          PlanB                          PlanC                           PlanD








                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                     Linux Distro(Default BiscuitOS)                     |  | Guest OS
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                                 Broiler                                 |  | HypV
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                     Linux Distro(Default BiscuitOS)                     |  | Userspace
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---
                                  ===========================================================================
                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                              Linux Kernel                  +------------+  | Kernel
                                  |                                                            | KVM Module |  V
                                  +------------------------------------------------------------+------------+ ---
                                  |                                                            | VT-x  VT-d |  A
                                  |                        Intel Hardware(CORE/Xeon)           +------------+  | Hardware
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---



                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                                BiscuitOS                                |  | Guest
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                                 Broiler                                 |  | Guest OS HypV
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                                BiscuitOS                                |  | HypV
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                     Linux Distro(Default BiscuitOS)                     |  | Userspace
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---
                                  ===========================================================================
                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                              Linux Kernel                  +------------+  | Kernel
                                  |                                                            | KVM Module |  V
                                  +------------------------------------------------------------+------------+ ---
                                  |                                                            | VT-x  VT-d |  A
                                  |                        Intel Hardware(CORE/Xeon)           +------------+  | Hardware
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---



                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                                BiscuitOS                                |  | Guest
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                                 Broiler                                 |  | HypV
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                     Linux Distro(Default BiscuitOS)                     |  | Userspace
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---
                                  ===========================================================================
                                  +-------------------------------------------------------------------------+ ---
                                  |                                                                         |  A
                                  |                              Linux Kernel                  +------------+  | Kernel
                                  |                                                            | KVM Module |  V
                                  +------------------------------------------------------------+------------+ ---
                                  |                                                            | VT-x  VT-d |  A
                                  |                        Intel Hardware(CORE/Xeon)           +------------+  | Hardware
                                  |                                                                         |  V
                                  +-------------------------------------------------------------------------+ ---



                                  Broiler Physical Memory Space

                                  +-------------------------------+------------------+---------------------------+---------+
                                  |                               |                  |                           |         |
                                  |         System Memory         | PCI Region(MMIO) |       System Memory       |   ...   |
                                  |                               |                  |                           |         |
                                  +-------------------------------+------------------+---------------------------+---------+
                                  |                               |                  |                                    
                                  0x00000000                      0xC0000000         0x100000000








                         Host/System View

              512Gig --> +-----------------------+
                         |                       |
                         | PCI Memory Add. Range |
          TOUUD BASE     |                       |
       Reclaim Limit --> +-----------------------+ ------------o
                         |                       |             |                 DRAM Controller View
                         |  Main Memory Reclaim  |             |
                         |       Add Range       |             |                 +-----------------------+ <-- TOM
                         |                       |             |                 |        ME-UMA         |
        Reclaim Base --> +-----------------------+ -----o-----(+)--------------> +-----------------------+ <-- MESEG BASE
                         |                       |      |      |                 |                       |
                         |      Main Memory      |      |      |                 |      OS visible       |
                         |     Address Range     |      |      |                 |        > 4Gig         |
                         |                       |      |      |                 |                       |
                4GiB --> +-----------------------+ ----(+)-----o---------------> +-----------------------+
                         | Flash, APIC LT(20MiB) |      |                        |                       |
          0xFEC00000 --> +-----------------------+      |                        |                       |
                         |                       |      |                        | OS  Invisible Reclaim |
                         | PCI Memory Add. Range |      |                        |                       |
                         |                       |      |                        |                       |
          0xC0000000 --> +-----------------------+ -----o----------------------> +-----------------------+ <- Reclaim Base
                         |                       |                               |                       |
                         |      Main Memory      |                               |                       |
                         |     Address Range     |                               |   OS VISIBLE < 4Gig   |
                         |                       |                               |                       |
               16MiB --> +-----------------------+                               |                       |
                         | Legacy Address. Range |                               |                       |
                   0 --> +-----------------------+                               +-----------------------+ <-- 0
                   




                                                       +-------------+
                                                       | memory_tree |
                                                       +-------------+
                                                              |
                                                      o-------o-------o
                                                      |               |
                                              o-------o-------o       o-------o
                                              |               |               |
                                          +---o---+       +---o---+       +---o---+
                                          |  MR0  |       |  MR1  |       |  MR2  |
                                          +-------+       +-------+       +-------+

                                    




                          
                          +--------------------------------------+ <-- 0x00100000 (1MiB)
                          |                                      |
                          |           Motherboard BIOS           |
                          |                                      |
                          +--------------------------------------+ <-- 0x000F0000
                          |              ROMs  unus              |
                          +--------------------------------------+ <-- 0x000C8000
                          |           Video ROM (BIOS)           |
                          +--------------------------------------+ <-- 0x000C0000
                          |              Video  RAM              |
                          +--------------------------------------+ <-- 0x000A0000 (640KiB)
                          |                                      |
                          |     Expansion Area (EBDA) 128KiB     |
                          |                                      |
                          +--------------------------------------+ <-- 0x0009FC00
                          |                                      |
                          |                                      |
                          |       Conventional LOW Memory        |
                          |                                      |
                          |                                      |
                          +--------------------------------------+ <-- 0x00000500
                          |                                      |
                          |            DOS Area (BDA)            |
                          |                                      |
                          +--------------------------------------+ <-- 0x00000400
                          |   Real Mode Interrupt Vector Table   |
                          +--------------------------------------+ <-- 0x00000000





                          +------------------------------------------------------------+
                          |                                                            |
                          |                                                            |
                          |                                                            |
                          |                  Guest OS (BiscuitOS Linux)                | 
                          |                                                            |
                          |                   +-------------------+                    |
                          |                   | Front-end drivers |                    |
                          +-------------------+-------------------+--------------------+
                                                       A |        
                                                       | o------------------------------------o
                                                       o-------------------------------------o|
                          +--------------------+------------------+--------------------+     ||
                          |                    | Back-end drivers |                    |     ||
                          |                    +------------------+                    |     ||
                          |                    | Device Emulation |                    |     || 
                          |                    +------------------+                    |     ||
                          |                          Broiler                           |     ||
                          |                                                        | A |     ||
                          +--------------------------------------------------------|-|-+     ||
                          |                        Linux Distro                    | | |     ||
                          +------------------------------------------------------+-V-|-+     ||
                          |                                                      |     |-----o|
                          |                          Kernel                      | KVM | <----o
                          |                                                      |     |
                          +------------------------------------------------------+-----+
                          |                         Hardware                           |
                          +------------------------------------------------------------+



                          +---------------------+                                                                                 +-----------------------+
                          |                     |                                                                                 |                       |
                          |  Guest OS (I/O Eit) |                                                                                 | Guest OS (I/O Finish) |
                          |                     |                                                                                 |                       |
                          +---------------------+                                                                                 +-----------------------+
                                                |                                                                                 A
                                                |                                                                                 |
                                                |                           +----------------------------+                        |
                                                |                           |                            |                        |
                                                |                           | Broiler (Emulate Hardware) |                        |
                                                |                           |                            |                        |
                                                |                           +----------------------------+                        |
                                                |                           A                            |                        |
                                                V                           |                            V                        |
                                                +---------------------------+                            +------------------------+
                                                |                           |                            |                        |
                                                | Kernel (KVM pass Broiler) |                            | Kernel (KVM Resume VM) |
                                                |                           |                            |                        |
                                                +---------------------------+                            +------------------------+



                          +----------+                                                     +------------+
                          |          |                                                     |            |
                          | I/O Exit |                                                     | I/O Finish |
                          | Guest OS |                                                     |  Guest OS  |
                          +----------+                                                     +------------+
                                     |                                                     A
                                     |                                                     |
                                     |                  +------------------+               |
                                     |                  |                  |               |
                                     |                  | Emulate Hardware |               |
                                     |                  |     Broiler      |               |
                                     |                  +------------------+               |
                                     |                  A                  |               |
                                     V                  |                  V               |
                                     +------------------+                  +---------------+
                                     |                  |                  |               |
                                     | KVM pass Broiler |                  | KVM Resume VM |
                                     |      Kernel      |                  |    Kernel     |
                                     +------------------+                  +---------------+






             ----------------------------------------------------------------------------------------------------------->

             -------------+----------+-----------------------------------------------------+------------+----------------
                Guest OS  | Guest OS |                                                     |  Guest OS  |
                          |          |                   Geust  Stopping                   |            | Guest Running 
               Access I/O | I/O Exit |                                                     | I/O Finish |
             -------------+----------+-----------------------------------------------------+------------+----------------
                                     |                                                     A
                                     |                                                     | ------
                                     |                                                     |     A
                                     |                  +------------------+               |     |
                                     |                  |     Broiler      |               |     |
                                     |     thread ----->|                  |----->         |     | Userspace
                                     |                  | Emulate Hardware |               |     |
                                     |                  +------------------+               |     |
                                     |                  A                  |               |     V
                               ------|------------------|------------------|---------------| ------
                                     V                  |                  V               |     A
                                     +------------------+                  +---------------+     |
                                     |      Kernel      |                  |    Kernel     |     | Kernel
                                     |                  |                  |               |     | 
                                     | KVM Pass Broiler |                  | KVM Resume VM |     V
                                     +------------------+                  +---------------+ ------







             ----------------------------------------------------------------------------------------------------------->

             -------------+----------+-----------------------------------------------------+------------+----------------
                Guest OS  | Guest OS |                                                     |  Guest OS  |
                          |          |                   Geust  Stopping                   |            | Guest Running
               Access I/O | I/O Exit |                                                     | I/O Finish |
             -------------+----------+-----------------------------------------------------+------------+----------------
                                     |                                                     A
                                     |                                                     | ------
                                     |                                                     |     A
                                     |                  +------------------+               |     |
                                     |                  |     Broiler      |               |     |
                                     |                  |  Control  Plane  |               |     | Userspace
                                     |                  | Device Emulation |               |     |
                                     |                  +------------------+               |     |
                                     |                  A                  |               |     V
                               ------|------------------|------------------|---------------| ------
                                     |                  |                  V               |     A
                                     |                  +------------------+               |     |
                                     |                  |    Data Plane    |               |     | 
                                     |  kernel thread ->|                  |--->           |     |
                                     |                  | Device Emulation |               |     |
                                     |                  +------------------+               |     | Kernel
                                     V                  |                  V               |     |
                                     +------------------+                  +---------------+     |
                                     |      Kernel      |                  |    Kernel     |     |
                                     |                  |                  |               |     |        
                                     | KVM Pass Broiler |                  | KVM Resume VM |     V
                                     +------------------+                  +---------------+ ------






             ----------------------------------------------------------------------------------------------------------->

             -------------+----------+-----------------------------------------------------+------------+----------------
                Guest OS  | Guest OS |                                                     |  Guest OS  |
                          |          |                   Geust  Stopping                   |            | Guest Running
               Access I/O | I/O Exit |                                                     | I/O Finish |
             -------------+----------+-----------------------------------------------------+------------+----------------
                                     |                                                     A
                                     |                                                     | ------
                                     |                                                     |     A
                                     |                  +------------------+               |     |
                                     |                  |     Broiler      |               |     |
                                     |     thread ----->|     Partial      |----->         |     | Userspace
                                     |                  | Emulate Hardware |               |     |
                                     |                  +------------------+               |     |
                                     |                  A                  |               |     V
                               ------|------------------|------------------|---------------| ------
                                     V                  |                  V               |     A
                                     +------------------+                  +---------------+     |
                                     |      Kernel      |                  |    Kernel     |     | Kernel
                                     |                  |                  |               |     |
                                     | KVM Pass Broiler |                  | KVM Resume VM |     V
                                     +------------------+                  +---------------+ ------






                          +------------------------------------------------+            +------------------------------------------------+
                          |                                                |            |                                                | 
                          |                                                |            |                                                |
                          |                                                |            |                                                |  
                          |            Guest OS (BiscuitOS Linux)          |            |            Guest OS (BiscuitOS Linux)          |   
                          |                                                |            |                                                | 
                          |             +-------------------+              |            |             +-------------------+              |  
                          |             | Front-end drivers |              |            |             | Front-end drivers |              |       
                          +-------------+-------------------+--------------+            +-------------+-------------------+--------------+  
                                                 A |                                                           A |                           
                                                 | o------------------------------o                            | |
                                                 o-------------------------------o|                            | V
                          +--------------+------------------+--------------+     ||     +--------------+------------------+--------------+
                          |              | Back-end drivers |              |     ||     |              | Back-end drivers |              |
                          |              +------------------+              |     ||     |              +------------------+              |
                          |              | Device Emulation |              |     ||     |              | Device Emulation |              |
                          |              +------------------+              |     ||     |              +------------------+              |
                          |                    Broiler                     |     ||     |                    Broiler                     |
                          |                                            | A |     ||     |                                            | A |
                          +--------------------------------------------|-|-+     ||     +--------------------------------------------|-|-+
                          |                  Linux Distro              | | |     ||     |                  Linux Distro              | | |
                          +------------------------------------------+-V-|-+     ||     +------------------------------------------+-V-|-+
                          |                                          |     |-----o|     |                                          |     |
                          |                    Kernel                | KVM | <----o     |                    Kernel                | KVM |
                          |                                          |     |            |                                          |     |
                          +------------------------------------------+-----+            +------------------------------------------+-----+
                          |                   Hardware                     |            |                   Hardware                     |
                          +------------------------------------------------+            +------------------------------------------------+



                                                                                                      
                                                                                                      
                                         +-----------------------------------------------------------+
                                         |                 Virtual Filesystems (VFS)                 |
                                         +--------------o------------------------------o-------------+
                                                        |                              |              
                                           +------------o------------+                 |              
                                           | Disk Cache (Page cache) |                 |              
                                           +------------o------------+                 |              
                                                        |                              |              
                                         +--------------|------------------------------|-------------+
                                         |              |                              |             |
                                         | +------------o------------+   +-------------o-----------+ |
                                         | |     Disk Filesystem     |   |    Block  Filesystem    | |
                                         | +-------------------------+   +-------------------------+ |
                                         |                       Mapping Layer                       |
                                         +-----------------------------o-----------------------------+
                                                                       |                              
                                         +-----------------------------o-----------------------------+    +---------------+
                                         |                    Generic Block Layer                    | <--|      bio      |
                                         +--------------o-----------------------------o--------------+    +---------------+
                                                        |                             |                     A  A  A  A  A
                                         +--------------o-----------------------------o--------------+    +---------------+
                                         |                    I/O Scheduler Layer                    | <--| request_queue |
                                         +--------------o-----------------------------o--------------+    +---------------+
                                                        |                             |                           A
                                           +------------o------------+   +------------o------------+              | I/O quest
                                           |   Block Device Driver   |   |   Block Device Driver   |--------------o
                                           +------------o------------+   +------------o------------+  
                                                        |                             |               
                                                  +-----o-----+                 +-----o-----+
                                                  |           |                 |           |     +----------------+
                                                  | Hard Disk |                 | Hard Disk | <-- | file_operation |
                                                  |           |                 |           |     +----------------+
                                                  +-----------+                 +-----------+






                                                  virtqueue_push                        virtqueue_pop
                                                        |                                     A
                                   o update:avail_idx   |                                     |
                                   |                    |                                     |            o update:last_used_idx
                                   |                    |                                     |            |
                                   |         Avail-Ring V              Desc-Ring              |  Used-Ring |
                                   |    ------------------------------------------------------------------------ Guest OS(GPA)
                                   |     +------------------+     +------------------+     +------------------+
                                   |     |                  |     |                  |     |                  |
                                   |     +------------------+     +------------------+     +------------------+
                                   |     |                  |     |   Desc:Entry_A   | <-- |   Used:Entry_A   | <---o
                                   |     +------------------+     +------------------+     +------------------+     |
                                   o---> |   Avai:Entry_A   | --> |   Desc:Entry_B   |     |                  |     |
                                         +------------------+     +------------------+     +------------------+     |
                                         |                  |     |                  |     |                  |     |
                                         |                  |     |                  |     |                  |     |
                               virtqueue |     ........     |     |     ........     |     |     ........     |     |
                                         |                  |     |                  |     |                  |     |
                                         |                  |     |                  |     |                  |     |
                                         +------------------+     +------------------+     +------------------+     |
                                         |                  |     |                  |     |                  |     |
                                         +------------------+     +------------------+     +------------------+     |
                                         |                  |     |                  |     |                  |     |
                                         +------------------+     +------------------+     +------------------+     |
                           Broiler(HVA) ------------------------------------------------------------------------    | 
                                           |  Avail-Ring |             Desc-Ring              A  Used-Ring          |
                                           |             |                                    |                     |
                     update:last_avail_idx o             |                                    |     update:used_idx o
                                                         |                                    |
                                                         V                                    |
                                                      Get_buf                              Add_buf






                                    o update:avail_idx
                                    |
                                    |             virtqueue_push
                                    |                   |
                                    |                   |
                                    |        Avail-Ring V                 Desc-Ring                    Used-Ring  
                                    |   ------------------------------------------------------------------------------ Guest OS(GPA)
                                    |    +------------------+        +------------------+        +------------------+
                                    |    |                  |        |                  |        |                  |
                                    |    +------------------+        +------------------+        +------------------+
                                  o----> |                  |   o--> |   Desc:Entry_A   |        |   Used:Entry_A   |
                                  | |    +------------------+   |    +------------------+        +------------------+
                                  | o--> |   Avai:Entry_A   | --o    |   Desc:Entry_B   |        |                  |
                                  |      +------------------+        +------------------+        +------------------+
                                  |      |                  |        |                  |        |                  |
                                  |      |                  |        |                  |        |                  |
                                  |      |     ........     |        |     ........     |        |     ........     | virtqueue
                                  |      |                  |        |                  |        |                  |
                                  |      |                  |        |                  |        |                  |
                                  |      +------------------+        +------------------+        +------------------+
                                  |      |                  |        |                  |        |                  |
                                  |      +------------------+        +------------------+        +------------------+
                                  |      |                  |        |                  |        |                  |
                                  |      +------------------+        +------------------+        +------------------+
                                  |     ------------------------------------------------------------------------------ Broiler(HVA)
                                  |          Avail-Ring |                  Desc-Ring                    Used-Ring
                                  |                     |
                                  |                     V
                                  |                  Get_buf
                                  |        
                                  o update:last_avai_idx        




                                                                                                      update:last_used_idx o
                                                                                                                           |
                                                                                               virtqueue_pop               |
                                                                                                     A                     |
                                                                                                     |                     |
                                             Avail-Ring                   Desc-Ring                  | Used-Ring           |
                         Guest OS(GPA)  ------------------------------------------------------------------------------     |
                                         +------------------+        +------------------+        +------------------+      |
                                         |                  |        |                  |        |                  |      |
                                         +------------------+        +------------------+        +------------------+      |
                                         |                  |   o--> |   Desc:Entry_A   | <----- |   Used:Entry_A   | <--o |
                                         +------------------+   |    +------------------+        +------------------+    | |
                                         |   Avai:Entry_A   | --o    |   Desc:Entry_B   |        |                  | <----o
                                         +------------------+        +------------------+        +------------------+    |
                                         |                  |        |                  |        |                  |    |
                                         |                  |        |                  |        |                  |    |
                              Virtqueue  |     ........     |        |     ........     |        |     ........     |    |
                                         |                  |        |                  |        |                  |    |
                                         |                  |        |                  |        |                  |    |
                                         +------------------+        +------------------+        +------------------+    |
                                         |                  |        |                  |        |                  |    |
                                         +------------------+        +------------------+        +------------------+    |
                                         |                  |        |                  |        |                  |    |
                                         +------------------+        +------------------+        +------------------+    |
                           Broiler(GPA) ------------------------------------------------------------------------------   |
                                              Avail-Ring                  Desc-Ring                 A Used-Ring          |
                                                                                                    |                    |
                                                                                                    |                    |
                                                                                                 Add_buf                 |
                                                                                                                         |
                                                                                                         update:used_idx o





                    

                    

                                             Avail-Ring                   Desc-Ring                    Used-Ring
                                        ------------------------------------------------------------------------------ Guest OS(GPA)
                                         +------------------+        +------------------+        +------------------+
                                         |                  |        |                  |        |                  |
                                         +------------------+        +------------------+        +------------------+
                                         |                  |   o--> |   Desc:Entry_A   |    o-- |   Used:Entry_A   |
                                         +------------------+   |    +------------------+    |   +------------------+
                                         |   Avai:Entry_A   | --o    |   Desc:Entry_B   | <--o   |                  |
                                         +------------------+        +------------------+        +------------------+
                                         |                  |        |                  |        |                  |
                                         |                  |        |                  |        |                  |
                                         |     ........     |        |     ........     |        |     ........     |  Virtqueue
                                         |                  |        |                  |        |                  |
                                         |                  |        |                  |        |                  |
                                         +------------------+        +------------------+        +------------------+
                                         |                  |        |                  |        |                  |
                                         +------------------+        +------------------+        +------------------+
                                         |                  |        |                  |        |                  |
                                         +------------------+        +------------------+        +------------------+
                                        ------------------------------------------------------------------------------ Broiler(HVA)
                                              Avail-Ring                  Desc-Ring                    Used-Ring


                    
                 








                                                  virtqueue_push                        virtqueue_pop
                                                        |                                     A
                                   o update:avail_idx   |                                     |
                                   |                    |                                     |            o update:last_used_idx
                                   |                    |                                     |            |
                                   |         Avail-Ring V              Desc-Ring              |  Used-Ring |
                                   |    ------------------------------------------------------------------------ Guest OS(GPA)
                                   |     +------------------+     +------------------+     +------------------+
                                   |     |                  |     |                  |     |                  |
                                   |     +------------------+     +------------------+     +------------------+
                                   |     |                  |     |   Desc:Entry_A   | <-- |   Used:Entry_A   | <---o
                                   |     +------------------+     +------------------+     +------------------+     |
                                   o---> |   Avai:Entry_A   | --> |   Desc:Entry_B   |     |                  |     |
                                         +------------------+     +------------------+     +------------------+     |
                                         |                  |     |                  |     |                  |     |
                                         |                  |     |                  |     |                  |     |
                               virtqueue |     ........     |     |     ........     |     |     ........     |     |
                                         |                  |     |                  |     |                  |     |
                                         |                  |     |                  |     |                  |     |
                                         +------------------+     +------------------+     +------------------+     |
                                         |                  |     |                  |     |                  |     |
                                         +------------------+     +------------------+     +------------------+     |
                                         |                  |     |                  |     |                  |     |
                                         +------------------+     +------------------+     +------------------+     |
                           Broiler(HVA) ------------------------------------------------------------------------    |
                                           |  Avail-Ring |             Desc-Ring              A  Used-Ring          |
                                           |             |                                    |                     |
                     update:last_avail_idx o             |                                    |     update:used_idx o
                                                         |                                    |
                                                         V                                    |
                                                      Get_buf                              Add_buf







                                     31                                 16 15               8 7                0
                                    +------------------+------------------+------------------+------------------+
                                    |                         Device Feature Bits (RO)                          | 0x00
                                    +---------------------------------------------------------------------------+
                                    |                         Guest Features Bits (R/W)                         | 0x04
                                    +---------------------------------------------------------------------------+
                                    |                            Queue Address (R/W)                            | 0x08
                                    +-------------------------------------+-------------------------------------+
                                    |         Queue  Select (R/W)         |           Queue Size (RO)           | 0x0C
                                    +------------------+------------------+-------------------------------------+
                                    |  ISR Status(RO)  | DeviceStatus(RW) |          Queue Notify(R/W)          | 0x10
                                    +------------------+------------------+-------------------------------------+
                                    |          Queue Vector(R/W)          |      Configuration Vector(R/W)      | 0x14
                                    +-------------------------------------+-------------------------------------+







                                    Virtio-blk BAR0 Bitmap

                                     31                                 16 15               8 7                0
                                    +------------------+------------------+------------------+------------------+
                                    |                         Device Feature Bits (RO)                          | 0x00
                                    +---------------------------------------------------------------------------+
                                    |                         Guest Features Bits (R/W)                         | 0x04
                                    +---------------------------------------------------------------------------+
                                    |                            Queue Address (R/W)                            | 0x08
                                    +-------------------------------------+-------------------------------------+
                                    |         Queue  Select (R/W)         |           Queue Size (RO)           | 0x0C
                                    +------------------+------------------+-------------------------------------+
                                    |  ISR Status(RO)  | DeviceStatus(RW) |          Queue Notify(R/W)          | 0x10
                                    +------------------+------------------+-------------------------------------+
                                    |          Queue Vector(R/W)          |      Configuration Vector(R/W)      | 0x14
                                    +-------------------------------------+-------------------------------------+
                                    |                                  Capacity                                 | 0x18
                                    |                                                                           | 0x1C
                                    +---------------------------------------------------------------------------+
                                    |              The maximum segment size (VIRTIO_BLK_F_SIZE_MAX)             | 0x20
                                    +---------------------------------------------------------------------------+
                                    |           The maximum number of segments (VIRTIO_BLK_F_SEG_MAX)           | 0x24
                                    +------------------+------------------+-------------------------------------+
                                    |     Sectors      |       heads      |              cylinders              | 0x28
                                    +------------------+------------------+-------------------------------------+
                                    |               Block size of device  (VIRTIO_BLK_F_BLK_SIZE)               | 0x2C
                                    +-------------------------------------+------------------+------------------+
                                    |  Min I/O size without performances  | Aligment  offset | PhysicalBlockExp | 0x30
                                    +-------------------------------------+------------------+------------------+
                                    |               Optimal sustained I/O size in logical blocks                | 0x34
                                    +-------------------------------------+------------------+------------------+
                                    |   Number of vqs (VIRTIO_BLK_F_MQ)   |       Unsed      |  Writeback mode  | 0x38
                                    +-------------------------------------+------------------+------------------+
                                    |           The next 3 entries are guarded by VIRTIO_BLK_F_DISCARD          | 0x3C
                                    +---------------------------------------------------------------------------+
                                    |         The maximum number of discard segments in discard command         | 0x40
                                    +---------------------------------------------------------------------------+
                                    |         Discard commands must be aligned to this number of sectors        | 0x44
                                    +---------------------------------------------------------------------------+
                                    |        The next 3 entries are guarded by VIRTIO_BLK_F_WRITE_ZEROES        | 0x48
                                    +---------------------------------------------------------------------------+
                                    |          The maximum number of segments in a write zeros command          | 0x4C
                                    +------------------+------------------+------------------+------------------+
                                    |    unused1[2]    |    unsed1[1]     |    unused1[0]    |   write  zeros   | 0x50
                                    +------------------+------------------+------------------+------------------+







                                         Access Begin(Read: IN AX, DX)
                                               |
                                            IN | 
                                               V
                                         +------------+-------------+-------------+
                                         |   BAR-IO   |   BAR-MEM   |   BAR-MEM   | vritio-blk       Guest OS    
                                        =====================================================================
                                        vmx_handle_exit                                              VMX: KVM
                                          |                                                           VM_EXIT
                                          o-> handle_io                            EXIT_REASON_IO_INSTRUCTION
                                               |                                     
                                               o-> kvm_fast_pio                      
                                                     |                               
                                                     o-> kvm_fast_pio_in (IN instruction)                       
                                                           |                                                |
                                                           o-> emulator_pio_in                              |
                                                                 |                                          |
                                                                 o-> emulator_pio_in_out                    V
                                                                       + kvm_run->exit_reason: KVM_EXIT_IO
                                                                       + kvm_run->io_port
                                                                       + kvm_run->io.size            VMX: KVM
                                        =====================================================================
                                        broiler_cpu_start                                             Broiler 
                                          | 
                                          o-> KVM_EXIT_IO
                                                |
                                                o-> broiler_cpu_emulate_io
                                                      |                                                     |
                                                      o-> mmio_get                                          |
                                                            |                                               |
                                                            o-> virtio_pci_io_mmio_callback                 V
                                                                  |
                                                                  o-> virtio_pci_data_in
                                                                        + kvm_run->mmio.data         
                                        
                                        broiler_cpu_run                                               Broiler
                                        =====================================================================
                                        kvm_vcpu_ioctl                                               VMX: KVM
                                          |
                                          o-> kvm_arch_vcpu_ioctl_run                                       |
                                                |                                                           |
                                                o-> vcpu_run                                                V
                                                      |                                              VM_ENTRY
                                                      o-> vcpu_enter_guest                           VMX: KVM
                                        =====================================================================
                                         |   BAR-IO   |   BAR-MEM   |   BAR-MEM   | vritio-blk       Guest OS    
                                         +------------+-------------+-------------+
                                               |
                                            IN | 
                                               V
                                         Access Finish(Read: IN AX, DX)
                                        
                                         



                                         Access Begin(Write: OUT DX, AX)
                                               |
                                           OUT |
                                               V
                                         +------------+-------------+-------------+
                                         |   BAR-IO   |   BAR-MEM   |   BAR-MEM   | vritio-blk       Guest OS
                                        =====================================================================
                                        vmx_handle_exit                                              VMX: KVM
                                          |                                                           VM_EXIT
                                          o-> handle_io                            EXIT_REASON_IO_INSTRUCTION
                                               |
                                               o-> kvm_fast_pio
                                                     |
                                                     o-> kvm_fast_pio_out (OUT instruction)
                                                           |                                                |
                                                           o-> kvm_rax_read                                 |
                                                           |                                                |
                                                           o-> emulator_pio_out                             |
                                                                 |                                          |
                                                                 o-> emulator_pio_in_out                    V
                                                                       + kvm_run->exit_reason: KVM_EXIT_IO
                                                                       + kvm_run->io_port
                                                                       + kvm_run->io.size            VMX: KVM
                                        =====================================================================
                                        broiler_cpu_start                                             Broiler
                                          |
                                          o-> KVM_EXIT_IO
                                                |
                                                o-> broiler_cpu_emulate_io
                                                      |                                                     |
                                                      o-> mmio_get                                          |
                                                            |                                               |
                                                            o-> virtio_pci_io_mmio_callback                 V
                                                                  |
                                                                  o-> virtio_pci_data_out

                                        broiler_cpu_run                                               Broiler
                                        =====================================================================
                                        kvm_vcpu_ioctl                                               VMX: KVM
                                          |
                                          o-> kvm_arch_vcpu_ioctl_run                                       |
                                                |                                                           |
                                                o-> vcpu_run                                                V
                                                      |                                              VM_ENTRY
                                                      o-> vcpu_enter_guest                           VMX: KVM
                                        =====================================================================
                                         |   BAR-IO   |   BAR-MEM   |   BAR-MEM   | vritio-blk       Guest OS
                                         +------------+-------------+-------------+
                                               |
                                           OUT |
                                               V
                                         Access Finish(Write: OUT DX, AX)

                                         
                                          



                                         Request Begin(Write Kick: OUT DX, AX)
                                               |
                                           OUT |
                                               V                  virtio-blk: Virtqueue
                                         +------------+ +------------+-----------+-----------+
                                         |   BAR-IO   | | Avail-Ring | Desc-Ring | Used-Ring |       Guest OS
                                        =====================================================================
                                        vmx_handle_exit                                              VMX: KVM
                                          |                                                           VM_EXIT
                                          o-> handle_io                            EXIT_REASON_IO_INSTRUCTION
                                               |
                                               o-> kvm_fast_pio
                                                     |
                                                     o-> kvm_fast_pio_out (OUT instruction)
                                                           |                                                |
                                                           o-> kvm_rax_read                                 |
                                                           |                                                |
                                                           o-> emulator_pio_out                             |
                                                                 |                                          |
                                                                 o-> emulator_pio_in_out                    V
                                                                       |
                                                                       o-> kernel_pio
                                                                             |
                                                                             o-> kvm_io_bus_write
                                                                                   |
                                                                                   o-> __kvm_io_bus_write
                                                                                         |
                                                                                         o-> kvm_iodevice_write
                                                                                               |
                                                                                               | ioeventfd
                                                                                               |
                                                                                               |     VMX: KVM
                                        =======================================================|=============
                                        virtio_pci_ioevent_callback                            V      Broiler
                                          |
                                          o-> notify_vq
                                                |
                                                o-> wakeup: virtio_blk_do_io
                                                      |                                                     |
                                                      o-> virtio_blk_do_io_request                          |
                                                            |                                               |
                                                            o-> virtio_pci_io_mmio_callback                 V
                                                                  |
                                                                  o-> Handle IO Request:
                                                                       + Avail-Ring: update last_avail_idx
                                                                       + Desc-Ring
                                                                       |
                                                                       o-> virtio_blk_complete
                                                                             + Used-Ring: update used_idx
                                                                             + Inject MSI interrupt
                                                                                               |      Broiler
                                        =======================================================|=============
                                        Inject Interrupt                                       V     VMX: KVM
                                          |
                                          o-> vcpu_run                                                
                                                |                                                    VM_ENTRY
                                                o-> vcpu_enter_guest                                 VMX: KVM
                                        =====================================================================
                                         |   BAR-IO   | | Avail-Ring | Desc-Ring | Used-Ring |       Guest OS
                                         +------------+ +------------+-----------+-----------+
                                                |                 virtio-blk: Virtqueue
                                                |
                                                V
                                         Request Finish







                 Virtqueueu layout


                                                                                         | <--------- PAGE_SIZE ---------> |     
                 | <---------- Desc-Ring ----------> |   | <------------ Avail-Ring -----------> | <--- pad[] -------> |   | <----------- Used-Ring -----------> |
                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+
                 | | | | | | | |       | | | | | | | | | | | | | | | | | |       | | | | | | | | | | | | | | | | | | | | | | | | | | | | |       | | | | | | | | | |
                 | | | | | | | |  ...  | | | | | | | | | | | | | | | | | |  ...  | | | | | | | | | | | | | | | | | | | | | | | | | | | | |  ...  | | | | | | | | | |
                 | | | | | | | |       | | | | | | | | | | | | | | | | | |       | | | | | | | | | | | | | | | | | | | | | | | | | | | | |       | | | | | | | | | |
                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+
                  A                                 A A A A                                     A A                     A A A                                   A A
                  |                                 | | | |                                     | |                     | | |                                   | |
                  |                                 | | | |                                     | |                     | | |                                   | |
                  o desc[0]                         | | | |  avaiable[VIRTIO_BLK_QUEUE_SIZE-1] -o |         used_flags -o | |   used[VIRTIO_BLK_QUEUE_SIZE-1] --o |
                    desc[VIRTIO_BLK_QUEUE_SIZE-1] --o | | |                     used_event_idx ---o           used_idx ---o |                 avail_event_idx ----o
                                      avail_flags ----o | |                                                    used[0] -----o
                                        avail_idx ------o |
                                     available[0] --------o







                                    Virtio-blk BAR0 Bitmap

                                     31                                 16 15               8 7                0
                                    +------------------+------------------+------------------+------------------+
                                    |                         Device Feature Bits (RO)                          | 0x00
                                    +---------------------------------------------------------------------------+
                                    |                         Guest Features Bits (R/W)                         | 0x04
                                    +---------------------------------------------------------------------------+
                                    |                            Queue Address (R/W)                            | 0x08
                                    +-------------------------------------+-------------------------------------+
                                    |         Queue  Select (R/W)         |           Queue Size (RO)           | 0x0C
                                    +------------------+------------------+-------------------------------------+
                                    |  ISR Status(RO)  | DeviceStatus(RW) |          Queue Notify(R/W)          | 0x10
                                    +------------------+------------------+-------------------------------------+
                                    |          Queue Vector(R/W)          |      Configuration Vector(R/W)      | 0x14
                                    +-------------------------------------+-------------------------------------+

                                        Add IO Request

                                        virtio_queue_rq
                                          |
                                          o- virtblk_add_req
                                              |
                                              o- virtqueue_notify
                                                   |
                                                   V              virtio-blk: Virtqueue
                                         +------------+ +------------+-----------+-----------+
                                         |   BAR-IO   | | Avail-Ring | Desc-Ring | Used-Ring |       Guest OS
                                        =====================================================================
                                        vmx_handle_exit                                              VMX: KVM
                                          |                                                           VM_EXIT
                                          o-> handle_io                            EXIT_REASON_IO_INSTRUCTION
                                               |
                                               o-> kvm_fast_pio
                                                     |
                                                     o-> kvm_fast_pio_out (OUT instruction)
                                                           |                                                |
                                                           o-> kvm_rax_read                                 |
                                                           |                                                |
                                                           o-> emulator_pio_out                             |
                                                                 |                                          |
                                                                 o-> emulator_pio_in_out                    V
                                                                       |
                                                                       o-> kernel_pio
                                                                             |
                                                                             o-> kvm_io_bus_write
                                                                                   |
                                                                                   o-> __kvm_io_bus_write
                                                                                         |
                                                                                         o-> kvm_iodevice_write
                                                                                               |
                                                                                               | ioeventfd
                                                                                               |
                                                                                               |     VMX: KVM
                                        =======================================================|=============
                                        virtio_pci_ioevent_callback                            V      Broiler
                                          |
                                          o-> notify_vq
                                                |
                                                o-> wakeup: virtio_blk_do_io
                                                      |                                                     |
                                                      o-> virtio_blk_do_io_request                          |
                                                            |                                               |
                                                            o-> virtio_pci_io_mmio_callback                 V
                                                                  |
                                                                  o-> Handle IO Request:
                                                                       + Avail-Ring: update last_avail_idx
                                                                       + Desc-Ring
                                                                       |
                                                                       o-> virtio_blk_complete
                                                                             + Used-Ring: update used_idx
                                                                             + Inject MSI interrupt
                                                                                               |      Broiler
                                        =======================================================|=============
                                        Inject Interrupt                                       V     VMX: KVM
                                          |
                                          o-> vcpu_run
                                                |                                                    VM_ENTRY
                                                o-> vcpu_enter_guest                                 VMX: KVM
                                        =====================================================================
                                         |   BAR-IO   | | Avail-Ring | Desc-Ring | Used-Ring |       Guest OS
                                         +------------+ +------------+-----------+-----------+
                                                |                 virtio-blk: Virtqueue
                                                |
                                                o-> virtblk_done
                                                      |
                                                      o-> blk_mq_complete_request
                                                            |
                                                            o-> virtblk_request_done
                                         Request Finish                                                                               






virtio_blk




                                         Broiler PIO Read: IN AX, DX(0x6800)
                                                |
                                             IN |
                                                V
                                         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                         | | | | | | | | | | | | | | | | | | | | | | IO Space        
                                         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                                        =====================================================================
                                        vmx_handle_exit                                              VMX: KVM
                                          |                                                           VM_EXIT
                                          o-> handle_io                            EXIT_REASON_IO_INSTRUCTION
                                               |
                                               o-> kvm_fast_pio
                                                     |
                                                     o-> kvm_fast_pio_in (IN instruction)
                                                           |                                                |
                                                           o-> emulator_pio_in                              |
                                                                 |                                          |
                                                                 o-> emulator_pio_in_out                    V
                                                                       + kvm_run->exit_reason: KVM_EXIT_IO
                                                                       + kvm_run->io_port
                                                                       + kvm_run->io.size            VMX: KVM
                                        =====================================================================
                                        broiler_cpu_start                                             Broiler
                                          |
                                          o-> KVM_EXIT_IO
                                                |
                                                o-> broiler_cpu_emulate_io
                                                      |                                                     |
                                                      o-> mmio_get                                          |
                                                            |                                               |
                                                            o-> BiscuitOS_pio_callback                      V
                                                                  + kvm_run->mmio.data

                                        broiler_cpu_run                                               Broiler
                                        =====================================================================
                                        kvm_vcpu_ioctl                                               VMX: KVM
                                          |
                                          o-> kvm_arch_vcpu_ioctl_run                                       |
                                                |                                                           |
                                                o-> vcpu_run                                                V
                                                      |                                              VM_ENTRY
                                                      o-> vcpu_enter_guest                           VMX: KVM
                                        =====================================================================
                                         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                                         | | | | | | | | | | | | | | | | | | | | | | IO Space        
                                         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                |
                                             IN |
                                                V
                                         Broiler PIO Read Finish: IN AX(0x20), DX(0x6800)





                                         Broiler PIO Write: OUT DX(0x6804), AX(0x02)
                                                |
                                            OUT |
                                                V
                                         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                         | | | | | | | | | | | | | | | | | | | | | | IO Space        
                                         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                                        =====================================================================
                                        vmx_handle_exit                                              VMX: KVM
                                          |                                                           VM_EXIT
                                          o-> handle_io                            EXIT_REASON_IO_INSTRUCTION
                                               |
                                               o-> kvm_fast_pio
                                                     |
                                                     o-> kvm_fast_pio_out (OUT instruction)
                                                           |                                                |
                                                           o-> kvm_rax_read                                 |
                                                           |                                                |
                                                           o-> emulator_pio_out                             |
                                                                 |                                          |
                                                                 o-> emulator_pio_in_out                    V
                                                                       + kvm_run->exit_reason: KVM_EXIT_IO
                                                                       + kvm_run->io_port
                                                                       + kvm_run->io.size            VMX: KVM
                                        =====================================================================
                                        broiler_cpu_start                                             Broiler
                                          |
                                          o-> KVM_EXIT_IO
                                                |
                                                o-> broiler_cpu_emulate_io
                                                      |                                                     |
                                                      o-> mmio_get                                          |
                                                            |                                               |
                                                            o-> BiscuitOS_pio_callback                      V

                                        broiler_cpu_run                                               Broiler
                                        =====================================================================
                                        kvm_vcpu_ioctl                                               VMX: KVM
                                          |
                                          o-> kvm_arch_vcpu_ioctl_run                                       |
                                                |                                                           |
                                                o-> vcpu_run                                                V
                                                      |                                              VM_ENTRY
                                                      o-> vcpu_enter_guest                           VMX: KVM
                                        =====================================================================
                                         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                                         | | | | | | | | | | | | | | | | | | | | | | IO Space        
                                         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                |
                                            OUT |
                                                V
                                         Broiler PIO Write Finish: OUT DX(0x6804), AX(0x02)











                                        31                 24 23                 16 15                  8 7                   0
                                       +---------------------+---------------------+---------------------+---------------------+
                                       |                     |                     |                     |                     |
                                       +-------------------------------------------+-------------------------------------------+
                                       |                                           |                                           |
                                       +---------------------------------------------------------------------------------------+
                                       |                                                                                       |



                                        31                 24 23                 16 15                  8 7                   0
                                       +---------------------+---------------------+---------------------+---------------------+
                                       |                               VMCS revision identifier                                | 0x0000
                                       +---------------------------------------------------------------------------------------+
                                       |                                  VMX-abort indicator                                  | 0x0004
                                       +---------------------------------------------------------------------------------------+
                                       |                       VMCS data(Implementation-specific format)                       | 0x0008
                                       +---------------------------------------------------------------------------------------+

 
                                        31                 24 23                 16 15                  8 7                   0
                                       +---------------------+---------------------+---------------------+---------------------+
                                       |                                          CR0                                          | 0x000C
                                       |                                          CR0                                          | 0x0010
                                       +---------------------------------------------------------------------------------------+
                                       |                                          CR3                                          | 0x0014
                                       |                                          CR3                                          | 0x0018
                                       +---------------------------------------------------------------------------------------+
                                       |                                          CR4                                          | 0x001C
                                       |                                          CR4                                          | 0x0020
                                       +---------------------------------------------------------------------------------------+


681a

    

                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |           GUEST_CR0           |           GUEST_CR3           |           GUEST_CR4           |           GUEST_DR7           |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |           GUEST_DR7           |           GUEST_RSP           |           GUEST_RIP           |         GUEST_RPLAGS          |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |       GUEST_CS_SELECTOR       |         GUEST_CS_BASE         |        GUEST_CS_LIMIT         |       GUEST_CS_AR_BYTES       |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |       GUEST_SS_SELECTOR       |         GUEST_SS_BASE         |        GUEST_SS_LIMIT         |       GUEST_SS_AR_BYTES       |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |       GUEST_DS_SELECTOR       |         GUEST_DS_BASE         |        GUEST_DS_LIMIT         |       GUEST_DS_AR_BYTES       |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |       GUEST_ES_SELECTOR       |         GUEST_ES_BASE         |        GUEST_ES_LIMIT         |       GUEST_ES_AR_BYTES       |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |       GUEST_FS_SELECTOR       |         GUEST_FS_BASE         |        GUEST_FS_LIMIT         |       GUEST_FS_AR_BYTES       |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |       GUEST_GS_SELECTOR       |         GUEST_GS_BASE         |        GUEST_GS_LIMIT         |       GUEST_GS_AR_BYTES       |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |      GUEST_LDTR_SELECTOR      |        GUEST_LDTR_BASE        |       GUEST_LDTR_LIMIT        |      GUEST_LDTR_AR_BYTES      |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |       GUEST_TR_SELECTOR       |         GUEST_TR_BASE         |        GUEST_TR_LIMIT         |       GUEST_TR_AR_BYTES       |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |        GUEST_GDTR_BASE        |        GUEST_GDTR_LIMIT       |        GEUST_IDTR_BASE        |        GUEST_IDTR_LIMIT       |
                                      +-------------------------------+-------------------------------+-------------------------------+-------------------------------+
                                      |      GUEST_IA32_DEBUGCTL      |   GUEST_IA32_DEBUGCTL_HIGH    |       GUEST_SYSENTER_CS       |






                  
                                  CPU Running       CPU Wait IO       CPU Running           CPU Running       CPU Running       CPU Running
                                 -------------ooooooooooooooooooooooo-------------->       --------------------------------------------------->
                                              |||||||||||||||||||||||A                                  |                      A
                                   IO Request |||||||||||||||||||||||| IO Ready              IO Request |                      | Interrupt
                                              VVVVVVVVVVVVVVVVVVVVVVV|                                  V                      | IO Ready
                                              +----------------------+                                  +----------------------+
                                              |                      |                                  |                      |
                                              | Device (handling IO) |                                  | Device (handling IO) |
                                              |                      |                                  |                      |
                                              +----------------------+                                  +----------------------+
                                              ----------------------->                                  ----------------------->
                                               Synchronization handle                                      Asynchronous handle









                                                         +---------------------------+
                                                         |                           |
                                                         |                           |
                                                         |                           -- NMI
                                                         |          X86 CPU          |
                                                         |                           -- INTR
                                                         |                           |
                                                         |                           |
                                                         +---------------------------+














                                                     +------------------------------------------+
                                                     |                                          |
                                                     |                                          |
                                                     |                                          |
                                                     +-|-|-|-|-|-|------------------------------+
                                                       | | | | | |










                                                                    +---------+              +--------------+
                                                                    |    INTR | <------------| INT          |
                                                                    |         |              |          IR0 |<--------------------------- System Clock0
                                                                    |         |              |          IR1 |<--------------------------- Keyboard
                                                                    |   CPU   |              |          IR2 |<-----------------o
                                                                    |         |  Data[7:0]   |   8259A  IR3 |<-----------------|--------- COM2/COM4/NetCard
                                                                    |         | <-----o----> |   Master IR4 |<-----------------|--------- COM1/COM3
                                                                    |         |       |      |          IR5 |<-----------------|--------- Parallel1
                                                                    +---------+       |      |          IR6 |<-----------------|--------- Floppy Controller
                                                                                      |      |          IR7 |<-----------------|--------- Parallel2
                                                                                      |      |              |                  |
                                                                                      |      |           A0 |<--o   +-+        |
                                                                                      |      |              |   |<--|&|<-------|--------- Address[0x20, 0x3F]
                                                                                      |      | CAS[2:0]  CS |<--o   +-+        |
                                                                                      |      +--------------+                  |
                                                                                      |           |                            |
                                                                                      |           |                            |
                                                                                      |           V                            |
                                                                                      |      +--------------+                  |
                                                                                      |      |          INT |------------------o
                                                                                      |      |          IR0 |<--------------------------- CMOS Clock
                                                                                      |      |          IR1 |<--------------------------- EGA/VGA
                                                                                      |      |          IR2 |<--------------------------- Reserved
                                                                                      |      |   8259A  IR3 |<--------------------------- Reserved
                                                                                      o----> |   Slave  IR4 |<--------------------------- Mouse
                                                                                             |          IR5 |<--------------------------- FPU-Error/DMA
                                                                                             |          IR6 |<--------------------------- Disk Controller(Major)
                                                                                             |          IR7 |<--------------------------- Disk Controller(Minor)
                                                                                             |              |
                                                                                             |           A0 |<--o   +-+
                                                                                             |              |   |<--|&|<----------------- Address[0xA0,0x3BF]
                                                                                             |           CS |<--o   +-+
                                                                                             +--------------+           





                                                                                                                             ----
                                                                                                                             INTA                             INT
                                                                                                                              |                                A
                                                                                                                              V                                |
                                                                                                                              o                                |
                                                                                            +------------+        A     +--------------------------------------------+
                                                                                            |  DATA BUS  |        |     |                                            |
                                                                                  D[7:0]<-->|            |<----->(+)    |               CONTROL LOGIC                |
                                                                                            |   BUFFER   |        |     |                                            |
                                                                                            +------------+  o---------->+--------------------------------------------+
                                                                                                            |     |           |              A|               A 
                                                                                                            |     |           |              ||               |
                                                                                                            |    (+)-------(+)|--------------||---------------|(+)--->
                                                                                                            |     |         A |              ||               | A
                                                                                                            |     |         | V              |V               | |
                                                                                      --    +------------+  |     |     +---------+     +----------+     +-----------+
                                                                                      RD-->o|            |  |     |     |         |     |          |     |           |<--- IR0                   
                                                                                      --    |   READ     |  |     |     |         |     |          |     |           |<--- IR1
                                                                                      WR-->o|   WRITE    |<-o     |     |   IN    |     |          |     | INTERRUPT |<--- IR2
                                                                                  --  A0--->|   LOGIC    |  |     |     | SERVICE |     | PRIORITY |     |  REQUEST  |<--- IR3
                                                                                  CS------>o|            |  |     |     |   REG   | <-> | RESOLVER | <---|    REG    |<--- IR4
                                                                                            +------------+  |     |     |  (ISR)  |     |          |     |   (IRR)   |<--- IR5
                                                                                                            |     |     |         |     |          |     |           |<--- IR6
                                                                                            +------------+  |     |     |         |     |          |     |           |<--- IR7
                                                                                    CAS0<-->|            |  |     |     +---------+     +----------+     +-----------+
                                                                                    CAS1<-->|   CASCADE  |  |     |          A                A                A
                                                                                    CAS2<-->|   BUFFER   |<-o     |          |                |                |
                                                                                  -- --     | COMPARATOR |        |     +--------------------------------------------+
                                                                                  SP/EN<-->o|            |       (+)<-->|          INTERRUPT MASK REG (IMR)          |
                                                                                            +------------+        |     +--------------------------------------------+
                                                                                                                  V
                                                                                                             INTERNAL BUS

                                                                                   







                                                                            Processor#1                 Processor#2                Processor#3               Processor#4
                                                                     +-----------------------+   +-----------------------+  +-----------------------+  +-----------------------+
                                                                     |                       |   |                       |  |                       |  |                       |
                                                                     |          CPU          |   |          CPU          |  |          CPU          |  |          CPU          |
                                                                     |                       |   |                       |  |                       |  |                       |
                                                                     +-----------------------+   +-----------------------+  +-----------------------+  +-----------------------+
                                                                     |      Local  APIC      |   |      Local  APIC      |  |      Local  APIC      |  |      Local  APIC      |
                                                                     +-----------------------+   +-----------------------+  +-----------------------+  +-----------------------+
                                                                                A A                         A A                        A A                        A A          
                                                                      Interrupt | |               Interrupt | |              Interrupt | |              Interrupt | |
                                                                       Messages | | IPIs           Messages | | IPIs          Messages | | IPIs          Messages | | IPIs
                                                                                V V                         V V                        V V                        V V
                                                                     <--------------------------------------------------------------------------------------------------------->
                                                                                               A                              Processor System Bus
                                                                                               |
                                                                                               |
                                                                                               V
                                                                                        +-------------+
                                                                                        | PCI  Bridge |
                                                                                        +-------------+
                                                                                               A
                                                                                               |
                                                                                               V
                                                                     <----------------------------------------------------> PCI Bus
                                                                                                                 A
                                                                                                                 |
                                                                                                                 V
                                                                                                           +-----------+
                                                                                                           |           |
                                                                                                           | I/O  APIC |<---- External
                                                                                                           |           |<---- Interrups
                                                                                                           +-----------+
                                



                                                                        Intel Processor with Intel                            Intel Processor with Intel
                                                                        Hyper-Threading  Technology                           Hyper-Threading  Technology                 
                                                                   +-----------------+-----------------+                 +-----------------+-----------------+                 
                                                                   |     Logical     |     Logical     |                 |     Logical     |     Logical     |
                                                                   |   Processor 0   |   Processor 1   |                 |   Processor 0   |   Processor 1   |
                                                                   +-----------------+-----------------+                 +-----------------+-----------------+
                                                                   |          Processor  Core          |                 |          Processor  Core          |
                                                                   +-----------------+-----------------+                 +-----------------+-----------------+
                                                         LINT0 --->|   Local  APIC   |   Local  APIC   |                 |   Local  APIC   |   Local  APIC   |<--- LINT0
                                                         LINT1 --->|                 |                 |                 |                 |                 |<--- LINT1
                                                                   +-----------------+-----------------+                 +-----------------+-----------------+
                                                                   |           Bus Interface           |                 |           Bus Interface           | 
                                                                   +-----------------------------------+                 +-----------------------------------+            
                                                                            A                 A                                   A                 A
                                                         Interrupt Messages |                 | IPIs                         IPIs |                 | Interrupt Messages
                                                                            V                 V                                   V                 V            
                                                         <------------------------------------------------------------------------------------------------------------->
                                                                                        
                                                                                        
                                                                                        


                                                                                
                                                      CPU Running                CPU Continue Running               CPU Running
                                                   ---------------------------->------------------------>---------------------->
                                                                                 Synchronous Interrupt

                                                                   
                                                      CPU Running                  Current Task Stop          CPU Resume Running
                                                   ---------------------------->                        o---------------------->
                                                                               |                        A
                                                                               |                        |
                                                       Asynchronous Interrupt  V  CPU handle Interrupt  |
                                                     -------------------------->------------------------>
                                                                 Device 









                                                    IDTR Register

                                                     47                                       16 15              0
                                                    +-------------------------------------------+-----------------+
                                                    |             IDT  Base Address             |    IDT Limit    |
                                                    +-------------------------------------------+--------o--------+
                                                                          |            |                 |
                                                                          |            |                 |
                                                                          |            o-------(+)-------o
                                                                          |                     |
                                                                          V                     V
                                                    +---------------------+-+-+-+-+-----+-+-+-+-+--------------------------------------+
                                                    |                     | | | | |     | | | | |                                      |
                                                    |                     | | | | | ... | | | | |                                      |
                                                    |                     | | | | |     | | | | |                                      |
                                                    +---------------------+-+-+-+-+-----+-+-+-+-+--------------------------------------+
                                                                           A A A A       A A A A
                                                                           | | | |       | | | |
                                                                           | | | |       | | | o--- Interrupt #n
                                                                           | | | |       | | o----- Interrupt #(n-1)
                                                                           | | | |       | o------- Interrupt #(n-2)
                                                                           | | | |       o--------- Interrupt #(n-3)
                                                                           | | | |                  ...
                                                                           | | | o----------------- Interrupt #4
                                                                           | | o------------------- Interrupt #3
                                                                           | o--------------------- Interrupt #2
                                                                           o----------------------- Interrupt #1





                                                                    +----------+
                                                               0 -->|          |--> INTI_0                                  0
                                                               1 -->|          |--> INTI_1                                  1
                                                               2 -->|          |--> INTI_2                                  2
                                                   24-Input         | IO-APIC0 |                                            ..
                                                   I/O APIC   21 -->|          |--> INTI_21                                 21
                                                              22 -->|          |--> INTI_22                                 22
                                                              23 -->|          |--> INII_23                                 23
                                                                    +----------+     
                                                                    +----------+
                                                              24 -->|          |--> INIT_0                                  24
                                                              25 -->|          |--> INIT_1                                  25
                                                   16-Input         | IO-APIC1 |                                            ..
                                                   I/O APIC   38 -->|          |--> INIT_14                                 38
                                                              39 -->|          |--> INIT_15                                 39
                                                                    +----------+     
                                                                    +----------+
                                                              40 -->|          |--> INIT_0                                  40
                                                              41 -->|          |--> INIT_1                                  41
                                                              42 -->|          |--> INIT_2                                  42
                                                   24-Input         | IO-APIC2 |                                            ..
                                                   I/O APIC   53 -->|          |--> INIT_21                                 53
                                                              54 -->|          |--> INIT_22                                 54
                                                              55 -->|          |--> INIT_23                                 55
                                                                    +----------+     
                                                               A                       A                                    A
                                                               |                       |                                    |
                                                         Global System          Interrupt Input                     System Vector Base
                                                        Interrupt Vecotr        Lines on IOAPIC                  reported in IOAPIC Struct
                                                        (APIC PnP IRQ#)














                                                             +---------------+                        +---------------+
                                                             |               |                        |               |
                                                             |     VCPU0     |                        |     VCPU1     |
                                                             |               |                        |               |
                                                             +---------------+                        +---------------+
                                                                     A                                        A                  Guest OS
                                                                     | VM ENTRY                      VM ENTRY |               VMX no-root
                                                     ----------------|----------------------------------------|--------------------------
                                                                     | Interrupt Inject      Interrupt Inject |                  VMX root
                                                                     |                                        |
                                                             +----------------+                       +----------------+
                                                             |                |                       |                |
                                                             | vLocal  APIC-0 |                       | vLocal  APIC-1 |
                                                             |                |                       |                |
                                                             +----------------+                       +----------------+
                                                                     A                                        A
                                                                     |                                        |
                                                                     o--------------------o-------------------o
                                                                                          |
                                                                                          |                      
                                                                  +------------+  +----------------+                    +----------------------------+
                                                                  |            |  |                |<-------------------|  In-Kernel Virtual Device  |
                                                                  |    vPIC    |  |   vI/O  APIC   |<------------o      +----------------------------+   
                                                                  |            |  |                |<---------o  |      +----------------------------+
                                                                  +------------+  +----------------+          |  o------| QEMU/Broiler Virtul Device |
                                                                                                              |         +----------------------------+
                                                                                                              |         +----------------------------+
                                                                                                              o---------|    Pass-through  Device    |
                                                                                                                        +----------------------------+











                                                     KVM_CREATE_IRQCHIP                                                 Broiler
                                                     ==========================================================================
                                                     kvm_arch_vm_ioctl                                                      KVM
                                                       |
                                                       o-> case: KVM_CREATE_IRQCHIP
                                                             |
                                                             o-> kvm_pic_init
                                                                   |
                                                                   o-> kvm_iodevice_init
                                                                   |     |
                                                                   |     o-> picdev_master_ops/picdev_slave_ops/picdev_eclr_ops
                                                                   |           |
                                                                   |           o-> picdev_master_read
                                                                   |           |     |
                                                                   |           |     o-> picdev_read
                                                                   |           | 
                                                                   |           o-> picdev_write 
                                                                   |                 |
                                                                   |                 o-> picdev_write
                                                                   |      
                                                                   o-> kvm_io_bus_register_dev: 0x20/0xa0/0x4d0                           






                                                broiler_irq_line <- irq_alloc_line
                                                  |
                                                  o-> KVM_IRQ_LINE                                                 Broiler
                                                ==========================================================================
                                                kvm_vm_ioctl                                                           KVM
                                                  |
                                                  o-> case: KVM_IRQ_LINE
                                                        |
                                                        o-> kvm_vm_ioctl_irq_line
                                                              |
                                                              o-> kvm_set_irq
                                                                    |
                                                                    o-> kvm_irq_map_gsi





                                               broiler_base_init
                                                 |
                                                 o-> kvm_init
                                                       |
                                                       o-> ioctl: KVM_CREATE_IRQCHIP                              Broiler
                                               ==========================================================================
                                               kvm_arch_vm_ioctl                                                      KVM
                                                 |
                                                 o-> case: KVM_CREATE_IRQCHIP
                                                       |
                                                       o-> kvm_pic_init
                                                       |     |
                                                       |     o-> kvm_iodevice_init
                                                       |     |     |
                                                       |     |     o-> picdev_master_ops/picdev_slave_ops/picdev_eclr_ops
                                                       |     |           |
                                                       |     |           o-> picdev_master_read
                                                       |     |           |     |
                                                       |     |           |     o-> picdev_read
                                                       |     |           | 
                                                       |     |           o-> picdev_write 
                                                       |     |                 |
                                                       |     |                 o-> picdev_write
                                                       |     |      
                                                       |     o-> kvm_io_bus_register_dev: 0x20/0xa0/0x4d0                      
                                                       |
                                                       o-> kvm_setup_default_irq_routing
                                                             |
                                                             o-> kvm_set_irq_routing
                                                                   |
                                                                   o-> setup_routing_entry
                                                                         |
                                                                         o-> kvm_set_routing_entry
                                                                         |     |
                                                                         |     o-> e->set: kvm_set_pic_irq
                                                                         |
                                                                         o-> hlist_add_head





                                               broiler_base_init
                                                 |
                                                 o-> kvm_init
                                                       |
                                                       o-> ioctl: KVM_CREATE_IRQCHIP                              Broiler
                                               ==========================================================================
                                               kvm_arch_vm_ioctl                                                      KVM
                                                 |
                                                 o-> case: KVM_CREATE_IRQCHIP
                                                       |
                                                       o-> kvm_setup_default_irq_routing
                                                             |
                                                             o-> kvm_set_irq_routing
                                                                   |
                                                                   o-> setup_routing_entry
                                                                         |
                                                                         o-> kvm_set_routing_entry
                                                                         |     |
                                                                         |     o-> e->set: kvm_set_pic_irq
                                                                         |
                                                                         o-> hlist_add_head                     




                                      struct kvm_irq_routing_table

                                      | <---------------------- chip -----------------------> | <------- map[] -------> |
                                      +-+-+-+-------+-+-+-+-+-+-+------+-+-+-+-+-+-+------+-+-+-+-+-+-+---------+-+-+-+-+
                                      | | | |       | | | | | | |      | | | | | | |      | | | | | | |         | | | | |
                                      | | | |  ...  | | | | | | | ...  | | | | | | | ...  | | |0|1|2|3|   ...   |y|x|m|n|
                                      | | | |       | | | | | | |      | | | | | | |      | | | | | | |         | | | | |
                                      +-+-+-+-------+-+-+-+-+-+-+------+-+-+-+-+-+-+------+-+-+-+-+-+-+---------+-+-+-+-+
                                      | <- vPIC-Master -> | <- vPIC-Slave -> | <-- IOAPIC --> |  A A             A A
                                                                                                 | |             | |  +--+ 
                                                                                                 | |             | o->|e0| 
                                                                                                 | |             |    +--+ 
                                                                                                 | |             |  +--+   +--+
                                                                                                 | |             o->|e0|<->|e1|
                                                                                                 | |                +--+   +--+
                                                                                                 | |  +--+   +--+   
                                                                                                 | o->|e0|<->|e1|     
                                                                                                 |    +--+   +--+
                                                                                                 |  +--+
                                                                                                 o->|e0|  
                                                                                                    +--+




                                       broiler_base_init
                                         |
                                         o-> broiler_irq_init
                                               |
                                               o-> ioctl: KVM_SET_GSI_ROUTING                             Broiler
                                       ==========================================================================
                                       kvm_vm_ioctl
                                         |
                                         o-> case: KVM_SET_GSI_ROUTING
                                               |
                                               o-> kvm_set_irq_routing
                                                     |
                                                     o-> kvm_set_routing_entry                
                                                     |     |
                                                     |     o-> e->set: kvm_set_pic_irq
                                                     |
                                                     o-> hlist_add_head                     









                                                             +---------------+                        +---------------+
                                                             |               |                        |               |
                                                             |     VCPU0     |                        |     VCPU1     |
                                                             |               |                        |               |
                                                             +---------------+                        +---------------+
                                                                     A                                        A                  Guest OS
                                                                     | VM ENTRY                      VM ENTRY |               VMX no-root
                                                     ----------------|----------------------------------------|--------------------------
                                                                     | Interrupt Inject      Interrupt Inject |                  VMX root
                                                                     |                                        |
                                                             +----------------+                       +----------------+
                                                             |                |                       |                |
                                                             | vLocal  APIC-0 |                       | vLocal  APIC-1 |
                                                             |                |                       |                |
                                                             +----------------+                       +----------------+
                                                                     A                                        A
                                                                     |                                        |
                                                                     o--------------------o-------------------o
                                                                       A                  |                 A
                                                                       |                  |                 |
                                                                  +--------+ +------------------------+ +--------+
                                                                  |        | |                        | |        |
                                                                  | 8259AS | |         IOAPIC         | | 8259AM |
                                                                  |        | |                        | |        |
                                                                  +--------+ +------------------------+ +--------+
                                                                   ||||||||   ||||||||||||||||||||||||   ||||||||
                                                                       ||||               ||||  
                                                                       oooo               oooo
                                                                         |                 |   
                                                                         o-----------------o
                                                                                ||||









                                                                  ||||||||||||||||||||||||  
                                                                 +------------------------+
                                                                 |                       o|
                                                                 |         IOAPIC         |
                                                                 |                        |
                                                                 +------------------------+
                                                                  |||||||||||||||||||||||| 









                                      struct kvm_irq_routing_table

                                      | <---------------------- chip -----------------------> | <------- map[] -------> |
                                      +-+-+-+-------+-+-+-+-+-+-+------+-+-+-+-+-+-+------+-+-+-+-+-+-+---------+-+-+-+-+
                                      | | | |       | | | | | | |      | | | | | | |      | | | | | | |         | | | | |
                                      | | | |  ...  | | | | | | | ...  | | | | | | | ...  | | |0|.|C|D|   ...   |F|x|m|n|
                                      | | | |       | | | | | | |      | | | | | | |      | | | | | | |         | | | | |
                                      +-+-+-+-------+-+-+-+-+-+-+------+-+-+-+-+-+-+------+-+-+-+-+-+-+---------+-+-+-+-+
                                      | <- vPIC-Master -> | <- vPIC-Slave -> | <-- IOAPIC --> |  A A             A A
                                                                                                 | |             | |  +--+
                                                                                                 | |             | o->|e0|
                                                                                                 | |             |    +--+
                                                                                                 | |             |  +--+   +--+
                                                                                                 | |             o->|e0|<->|e1|
                                                                                                 | |                +--+   +--+
                                                                                                 | |  +--+   +--+
                                                                                                 | o->|e0|<->|e1|
                                                                                                 |    +--+   +--+
                                                                                                 |  +--+
                                                                                                 o->|e0|
                                                                                                    +--+







o












                                                broiler_irq_line
                                                  |
                                                  o-> KVM_IRQ_LINE                                       Asynchronous Broiler
                                                =============================================================================
                                                kvm_vm_ioctl                                                 Asynchronous KVM
                                                  |
                                                  o-> case: KVM_IRQ_LINE
                                                        |
                                                        o-> kvm_vm_ioctl_irq_line
                                                              |
                                                              o-> kvm_set_irq
                                                                    |
                                                                    o-> kvm_set_pic_irq
                                                                          |
                                                                          o-> kvm_pic_set_irq
                                                                                |
                                                                                o-> __kvm_irq_line_state
                                                                                |
                                                                                o-> pic_set_irq1
                                                                                |
                                                                                o-> pic_update_irq
                                                                                |     |
                                                                                |     o-> pic_irq_request ----> s->output = 1
                                                                                |
                                                                                o-> pic_unlock
                                                                                      |
                                                                                      o-> kvm_make_request ---> KVM_REQ_EVENT
                                                                                      |
                                                                                      o-> kvm_vcpu_kick ---------> Inject IPI
                                                                                            |
                                                                                            |                Asynchronous KVM
                                                ============================================|================================
                                                                                            | VM_EXIT         Synchronous KVM
                                                                                            V
                                                vcpu_enter_guest
                                                  |
                                                  o-> kvm_check_request: KVM_REQ_EVENT
                                                  |
                                                  o-> inject_pending_event
                                                        |
                                                        o-> kvm_cpu_has_injectable_intr
                                                        |     |
                                                        |     o-> kvm_cpu_has_extint -------------> v->kvm->arch.vpic->output
                                                        |
                                                        o-> kvm_queue_interrupt
                                                        |
                                                        o-> vmx_inject_irq
                                                              |
                                                              o-> vmcs_write32: VM_ENTRY_INTR_INFO_FIELD
                                                                    
                                                                    | VM_ENTRY                                Synchronous KVM
                                                ====================|========================================================
                                                                    | Inject Interrupt                               Guest OS              
                                                                    V
                                                                Guest-PIC






                                                          7   6   5   4   3   2   1   0
                                                        +---+---+---+---+---+---+---+---+
                                                        | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 1 |          ICW1 Register
                                                        +---+---+---+---+---+---+---+---+
                                                                      A   A       A   A
                                                                      |   |       |   |
                                                                      |   |       |   o----------- 1: ICW4 NEEDED
                                                                      |   |       |                0: NO ICW4 NEEDED
                                                                      |   |       |   
                                                                      |   |       o--------------- 1: SINGLE
                                                                      |   |                        0: CASCADE MODE
                                                                      |   |      
                                                                      |   o----------------------- 0: LEVEL TRIGGERED MODE  
                                                                      |                            1: EDGE  TRIGGERED MODE
                                                                      |   
                                                                      o--------------------------- ICW1 MUST 1




                                                          7   6   5   4   3   2   1   0
                                                        +---+---+---+---+---+---+---+---+
                                                        | X | X | X | X | X | 0 | 0 | 0 |          ICW2 Register
                                                        +---+---+---+---+---+---+---+---+
                                                        | <---------------> | <-------> |
                                                              First IRQ        IR0-IR7
                                                                              


                                                          7   6   5   4   3   2   1   0
                                                        +---+---+---+---+---+---+---+---+        
                                                        | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 |          Master 8259A ICW3 Register
                                                        +---+---+---+---+---+---+---+---+        
                                                                                                 
                                                                                                 
                                                          7   6   5   4   3   2   1   0          
                                                        +---+---+---+---+---+---+---+---+        
                                                        | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |          Slave 8259A ICW3 Register
                                                        +---+---+---+---+---+---+---+---+









                                                          7   6   5   4   3   2   1   0
                                                        +---+---+---+---+---+---+---+---+
                                                        | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 1 |          ICW4 Register
                                                        +---+---+---+---+---+---+---+---+
                                                                      A   A   A   A   A
                                                                      |   |   |   |   |
                                                                      |   o---o   |   o----------- 1: 8085/8088 MODE
                                                                      |     |     |                0: MCS-80/85 MODE
                                                                      |     |     |   
                                                                      |     |     o--------------- 1: AUTO EOI
                                                                      |     |                      0: NORMAL EOI
                                                                      |     | 
                                                                      |     o--------------------- 0X: NON BUFFERED MODE 
                                                                      |                            10: BUFFERED MODE/SLAVE
                                                                      |                            11: BUFFERED MODE/MASTER
                                                                      |   
                                                                      o--------------------------- 1: SPECIAL FULLY NESTED MODE
                                                                                                   0: NOT SPECIAL FULLY NESTED MODE





                                                           7    6    5    4    3    2    1    0
                                                        +----+----+----+----+----+----+----+----+
                                                        | M7 | M6 | M5 | M4 | M3 | M2 | M1 | M0 |          OCW1 Register
                                                        +----+----+----+----+----+----+----+----+
                                                           A    A    A    A    A    A    A    A
                                                           |    |    |    |    |    |    |    |           INTERRUPT MASK
                                                           o----o----o----o----o----o----o----o----------> 1: MASK SET
                                                                                                           0: MASK RESET







                                                          7    6   5   4   3    2    1    0
                                                        +---+----+---+---+---+----+----+----+
                                                        | R | SL |EOI| 0 | 0 | L2 | L1 | L0 |          OCW2 Register
                                                        +---+----+---+---+---+----+----+----+
                                                          A    A   A            A    A    A
                                                          |    |   |            |    |    | 
                                                          |    |   |            |    |    |      +---+---+---+---+---+---+---+---+
                                                          |    |   |            |    |    o----> | 0 | 1 | 0 | 1 | 0 | 1 | 0 | 1 |
                                                          |    |   |            |    |           +---+---+---+---+---+---+---+---+
                                                          |    |   |            |    o---------> | 0 | 0 | 1 | 1 | 0 | 0 | 1 | 1 |
                                                          |    |   |            |                +---+---+---+---+---+---+---+---+
                                                          |    |   |            o--------------> | 0 | 0 | 0 | 0 | 1 | 1 | 1 | 1 |
                                                          |    |   |                             +---+---+---+---+---+---+---+---+
                                                          |    |   |                         IRQ   0   1   2   3   4   5   6   7 
                                                          |    |   |
                                                          V    V   V
                                                        +---+----+---+
                                                        | 0 |  0 | 1 | NON-SPECIFIC EOI COMMAND                 o--o
                                                        +---+----+---+                                             |---> END OF INTERRUPT
                                                        | 0 |  1 | 1 | SPECIFIC EOI COMMAND                     o--o
                                                        +---+----+---+ 
                                                        | 1 |  0 | 1 | ROTATE ON NO-SPECIFIC EOI COMMAND        o--o
                                                        +---+----+---+                                             |
                                                        | 1 |  0 | 0 | ROTATE IN AUTOMATIC EOI MODE(SET)        o--o---> AUTOMATIC ROTATION
                                                        +---+----+---+                                             |
                                                        | 0 |  0 | 0 | ROTATE IN AUTOMATIC EOI MODE(CLEAN)      o--o
                                                        +---+----+---+
                                                        | 1 |  1 | 1 | *ROTATE ON SPECIFIC EOI COMMAND          o--o
                                                        +---+----+---+                                             |---> SPECIFIC ROTATION
                                                        | 1 |  1 | 0 | *SET PRORITY COMMAND                     o--o
                                                        +---+----+---+
                                                        | 0 |  1 | 0 | NO OPERATION
                                                        +---+----+---+
                                                  



                                                          7    6   5   4   3   2   1   0
                                                        +---+----+---+---+---+---+----+---+
                                                        | 0 |ESMM|SMM| 0 | 1 | P | RR |RIS|          OCW3 Register
                                                        +---+----+---+---+---+---+----+---+
                                                               A   A           A    A   A
                                                               |   |           |    |   |      +-----------+-----------+-----------+-----------+
                                                               |   |           |    |   o----> |     0     |     1     |     0     |     1     |
                                                               |   |           |    |          +-----------+-----------+-----------+-----------+
                                                               |   |           |    o--------> |     0     |     0     |     1     |     1     |
                                                               |   |           |               +-----------+-----------+-----------+-----------+
                                                               |   |           |               |                       | READ      | READ      |
                                                               |   |           |               |       NO ACTION       | IR REG    | IS REG    |
                                                               |   |           |               |                       | ON NEXT   | ON NEXT   |
                                                               |   |           |               |                       | RD PULSE  | RD PULSE  |
                                                               |   |           |               +-----------------------+-----------+-----------+
                                                               |   |           |   
                                                               |   |           o-------------> 1: POLL COMMAND   
                                                               |   |                           0: NO POLL COMMAND
                                                               |   |          
                                                               |   |                          +-----------+-----------+-----------+-----------+  
                                                               |   o------------------------> |     0     |     1     |     0     |     1     |
                                                               |                              +-----------+-----------+-----------+-----------+
                                                               o----------------------------> |     0     |     0     |     1     |     1     |
                                                                                              +-----------+-----------+-----------+-----------+
                                                                                              |                       | RESET     | SET       |
                                                                                              |       NO ACTION       | SPECIAL   | SEPECIAL  |
                                                                                              |                       | MASK      | MASK      |
                                                                                              +-----------------------+-----------+-----------+
















                                               broiler_base_init
                                                 |
                                                 o-> kvm_init
                                                       |
                                                       o-> ioctl: KVM_CREATE_IRQCHIP                                            Broiler
                                               ========================================================================================
                                               kvm_arch_vm_ioctl                                                                    KVM
                                                 |
                                                 o-> case: KVM_CREATE_IRQCHIP
                                                       |
                                                       o-> kvm_ioapic_init
                                                       |     |
                                                       |     o-> kvm_ioapic_reset
                                                       |     |
                                                       |     o-> kvm_iodevice_init
                                                       |     |     |
                                                       |     |     o-> ioapic_mmio_ops
                                                       |     |           |
                                                       |     |           o-> ioapic_mmio_read
                                                       |     |           |
                                                       |     |           o-> ioapic_mmio_write
                                                       |     |
                                                       |     o-> kvm_io_bus_register_dev: IOAPIC_DEFAULT_BASE_ADDRESS/IOAPIC_MEM_LENGTH
                                                       |
                                                       o-> kvm_setup_default_irq_routing
                                                             |
                                                             o-> kvm_set_irq_routing
                                                                   |
                                                                   o-> setup_routing_entry
                                                                         |
                                                                         o-> kvm_set_routing_entry
                                                                         |     |
                                                                         |     o-> e->set: kvm_set_ioapic_irq
                                                                         |
                                                                         o-> hlist_add_head





                                               broiler_base_init
                                                 |
                                                 o-> kvm_init
                                                       |
                                                       o-> ioctl: KVM_CREATE_IRQCHIP                              Broiler
                                               ==========================================================================
                                               kvm_arch_vm_ioctl                                                      KVM
                                                 |
                                                 o-> case: KVM_CREATE_IRQCHIP
                                                       |
                                                       o-> kvm_setup_default_irq_routing
                                                             |
                                                             o-> kvm_set_irq_routing
                                                                   |
                                                                   o-> setup_routing_entry
                                                                         |
                                                                         o-> kvm_set_routing_entry
                                                                         |     |
                                                                         |     o-> e->set: kvm_set_pic_irq
                                                                         |
                                                                         o-> hlist_add_head







				     Direct Access Register

                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     |      Register      |   Start Address   |   Width(bits)   | R/W |          Description           |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     |   Index Register   |    0xFEC00000H    |        8        | R/W |              |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     |   Data  Register   |    0xFEC00010H    |       32        | R/W |              |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     |      IRQ  Pin      |    0xFEC00020H    |       32        | WO  |  MSI IRQ Number  |
                                     | Assertion Register |                   |                 |     |  [4:0],[31.5]  |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     |    EOI Register    |    0xFEC00040H    |       32        | WO  |  |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     
                                     Indirect Access Register

                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     |      Register      |   Index Address   |   Width(bits)   | R/W |          Description           |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     | Identification Reg |        0x00       |       32        | R/W | APIC ID                        |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     |  Version Register  |        0x01       |       32        | RO  | IOAPIC Version                 |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     |      Reserved      |     0x02-0x0F     |       -         | RO  | Reserved                       |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     | Redirection  Table |     0x10-0x11     |       64        | R/W | PRT                            |
                                     |     Register 0     |                   |                 | RO  |                                |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     | Redirection  Table |     0x12-0x13     |       64        | R/W | PRT                            |
                                     |     Register 1     |                   |                 | RO  |                                |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     | Redirection  Table |        ---        |       64        | R/W | PRT                            |
                                     |     Register n     |                   |                 | RO  |                                |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                                     |      Reserved      |        0xFE       |       -         | RO  | Reserved                       |
                                     +--------------------+-------------------+-----------------+-----+--------------------------------+
                         












                                    63            56 55           17 16 15 14 13 12 11 10   8 7         0
                                   +----------------+---------------+--+--+--+--+--+--+------+-----------+
                                   |                |               |  |  |  |  |  |  |      |           |
                                   +----------------+---------------+--+--+--+--+--+--+------+-----------+
                                           A                         A  A  A  A  A  A    A         A
                                           |                         |  |  |  |  |  |    |         |
                                           |                         |  |  |  |  |  |    |         |
                                           |                         |  |  |  |  |  |    |         |
                                           |                         |  |  |  |  |  |    |         o--------------- Interrupt Vector
                                           |                         |  |  |  |  |  |    o------------------------- Delivery Mode
                                           |                         |  |  |  |  |  o------------------------------ Destination Mode
                                           |                         |  |  |  |  o--------------------------------- Delivery Status
                                           |                         |  |  |  o------------------------------------ Interrupt Pin Polarity
                                           |                         |  |  o--------------------------------------- Remote IRR
                                           |                         |  o------------------------------------------ Trigger Mode
                                           |                         o--------------------------------------------- Interrupt Mask
                                           o----------------------------------------------------------------------- Destination Field












                                               broiler_base_init
                                                 |
                                                 o-> kvm_init
                                                       |
                                                       o-> ioctl: KVM_CREATE_IRQCHIP                                            Broiler
                                               ========================================================================================
                                               kvm_arch_vm_ioctl                                                                    KVM
                                                 |
                                                 o-> case: KVM_CREATE_IRQCHIP
                                                       |
                                                       o-> kvm_ioapic_init
                                                             |
                                                             o-> kvm_ioapic_reset
                                                             |
                                                             o-> kvm_iodevice_init
                                                             |     |
                                                             |     o-> ioapic_mmio_ops
                                                             |           |
                                                             |           o-> ioapic_mmio_read
                                                             |           |
                                                             |           o-> ioapic_mmio_write
                                                             |
                                                             o-> kvm_io_bus_register_dev: IOAPIC_DEFAULT_BASE_ADDRESS/IOAPIC_MEM_LENGTH










                                               broiler_base_init
                                                 |
                                                 o-> kvm_init
                                                       |
                                                       o-> ioctl: KVM_CREATE_IRQCHIP                                            Broiler
                                               ========================================================================================
                                               kvm_arch_vm_ioctl                                                                    KVM
                                                 |
                                                 o-> case: KVM_CREATE_IRQCHIP
                                                       |
                                                       o-> kvm_setup_default_irq_routing
                                                             |
                                                             o-> kvm_set_irq_routing
                                                                   |
                                                                   o-> setup_routing_entry
                                                                         |
                                                                         o-> kvm_set_routing_entry
                                                                         |     |
                                                                         |     o-> e->set: kvm_set_ioapic_irq
                                                                         |
                                                                         o-> hlist_add_head









                                       broiler_base_init
                                         |
                                         o-> broiler_irq_init
                                               |
                                               o-> ioctl: KVM_SET_GSI_ROUTING                             Broiler
                                       ==========================================================================
                                       kvm_vm_ioctl                                                           KVM
                                         |
                                         o-> case: KVM_SET_GSI_ROUTING
                                               |
                                               o-> kvm_set_irq_routing
                                                     |
                                                     o-> kvm_set_routing_entry
                                                     |     |
                                                     |     o-> e->set: kvm_set_ioapic_irq
                                                     |
                                                     o-> hlist_add_head









                                                broiler_irq_line
                                                  |
                                                  o-> KVM_IRQ_LINE                                                                   Asynchronous Broiler
                                                =========================================================================================================
                                                kvm_vm_ioctl                                                                             Asynchronous KVM
                                                  |
                                                  o-> case: KVM_IRQ_LINE
                                                        |
                                                        o-> kvm_vm_ioctl_irq_line
                                                              |
                                                              o-> kvm_set_irq
                                                                    |
                                                                    o-> kvm_set_ioapic_irq
                                                                          |
                                                                          o-> kvm_ioapic_set_irq
                                                                                |
                                                                                o-> __kvm_irq_line_state
                                                                                |
                                                                                o-> ioapic_set_irq
                                                                                      |
                                                                                      o-> ioapic_service
                                                                                            |
                                                                                            o-> kvm_irq_delivery_to_apic
                                                                                                  |
                                                                                                  o-> kvm_irq_delivery_to_apic_fast
                                                                                                  |
                                                                                                  o-> kvm_apic_present
                                                                                                  |
                                                                                                  o-> kvm_apic_match_dest
                                                                                                  |
                                                                                                  o-> kvm_lowest_prio_delivery
                                                                                                  |
                                                                                                  o-> kvm_apic_set_irq
                                                                                                        |
                                                                                                        o-> __apic_accept_irq
                                                                                                              |
                                                                                                              o-> kvm_lapic_set_irr --> apic->irr_pending
                                                                                                              |
                                                                                                              o-> kvm_make_request -------> KVM_REQ_EVENT
                                                                                                              |
                                                                                                              o-> kvm_vcpu_kick -------------> Inject IPI
                                                                                                                    |
                                                                                                                    |                    Asynchronous KVM
                                                ====================================================================|====================================
                                                                                                                    | VM_EXIT             Synchronous KVM
                                                                                                                    V
                                                vcpu_enter_guest
                                                  |
                                                  o-> kvm_check_request: KVM_REQ_EVENT
                                                  |
                                                  o-> inject_pending_event
                                                        |
                                                        o-> kvm_cpu_has_injectable_intr
                                                        |     |
                                                        |     o-> kvm_apic_has_interrupt
                                                        |           |
                                                        |           o-> apic_find_highest_irr --------> apic->irr_pending
                                                        |
                                                        o-> kvm_queue_interrupt
                                                        |
                                                        o-> vmx_inject_irq
                                                              |
                                                              o-> vmcs_write32: VM_ENTRY_INTR_INFO_FIELD

                                                                    | VM_ENTRY                                                            Synchronous KVM
                                                ====================|====================================================================================
                                                                    | Inject Interrupt                                                           Guest OS
                                                                    V
                                                                Guest-LAPIC




                                         VM_ENTRY_INTR_INFO_FIELD
 
                                            30                               12   10      8 7               0
                                         +-+-----------------------------------+-+---------+-----------------+
                                         | |              Reserved             | |         |                 |
                                         +-+-----------------------------------+-+---------+-----------------+
                                          A                                     A     A             A      
                                          |                                     |     |             |
                                          |                                     |     |             |
                                          |                                     |     |             |
                                          |                                     |     |             o------------ Vector
                                          |                                     |     o-------------------------- Interrupt Type
                                          |                                     o-------------------------------- Deliver err Code
                                          o---------------------------------------------------------------------- Valid



               






                                                                            Processor#1                 Processor#2                Processor#3               Processor#4
                                                                     +-----------------------+   +-----------------------+  +-----------------------+  +-----------------------+
                                                                     |                       |   |                       |  |                       |  |                       |
                                                                     |          CPU          |   |          CPU          |  |          CPU          |  |          CPU          |
                                                                     |                       |   |                       |  |                       |  |                       |
                                                                     +-----------------------+   +-----------------------+  +-----------------------+  +-----------------------+
                                                                     |      Local  APIC      |   |      Local  APIC      |  |      Local  APIC      |  |      Local  APIC      |
                                                                     +-----------------------+   +-----------------------+  +-----------------------+  +-----------------------+
                                                                                A A                         A A                        A A                        A A
                                                                      Interrupt | |               Interrupt | |              Interrupt | |              Interrupt | |
                                                                       Messages | | IPIs           Messages | | IPIs          Messages | | IPIs          Messages | | IPIs
                                                                                V V                         V V                        V V                        V V
                                                                     <--------------------------------------------------------------------------------------------------------->
                                                                                               A                              Processor System Bus
                                                                                               |
                                                                                               |
                                                                                               V
                                                                                        +-------------+
                                                                                        | PCI  Bridge |
                                                                                        +-------------+
                                                                                               A
                                                                                               |
                                                                                               V
                                                                     <----------------------------------------------------> PCI Bus
                                                                                A                                A
                                                                                | MSI                            |
                                                                                |                                V
                                                                       +--------o--------+                 +-----------+              +-----------+
                                                                       |                 |                 |           |       INTX#  |           |
                                                                       | PCI/PCIe  Agent |                 | I/O  APIC |<------------ | PCI Agent |
                                                                       |                 |                 |           |        PIRQ  |           |
                                                                       +-----------------+                 +-----------+              +-----------+










                                                     +--------------+
                                                     |              |
                                                     | PCI Device A |
                                                     |              |
                                                     |        INTA# |-----------------o                                       
                                                     |        INTB# |                 |                     
                                                     |        INTC# |--------------o  |                     
                                                     |        INTD# |              |  |                     
                                                     |              |              |  |                     
                                                     +--------------+              |  |                          +-----------------+
                                                                                   |  |                          |                 |
                                                     +--------------+              |  |                          |  Source Bridge  |
                                                     |              |              |  |                          |                 |
                                                     | PCI Device B |              |  o------------------------> | PIRQA   (IRQ10) |
                                                     |              |              |            o--------------> | PIRQB   (IRQ9)  |
                                                     |        INTA# |--------------|------------|--------------> | PIRQC   (IRQ11) |
                                                     |        INTB# |             (+)-----------|--------------> | PIRQD   (IRQ12) | ----> PIC/IOAPIC
                                                     |        INTC# |              |            |                | PIRQE           |
                                                     |        INTD# |--------------o            |                | PIRQF           |
                                                     |              |                           | o------------> | PIRQG   (IRQ7)  |
                                                     +--------------+                           | |              | PRQH            |
                                                                                                | |              |                 |
                                                     +--------------+                           | |              +-----------------+
                                                     |              |                           | |         
                                                     | PCI Device C |                           | |         
                                                     |              |                           | |
                                                     |        INTA# |---------------------------o |
                                                     |        INTB# |                             |
                                                     |        INTC# |-----------------------------o
                                                     |        INTD# |
                                                     |              |
                                                     +--------------+








                                                     |7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|
                                                  -- +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                  A  | Fmt |  Type   |R| TC  |R|A|R|T|T|E|ATT|AT |      Length       | 
                                                  |  |0 1 1|0 0 0 0 0| |     | |T| |H|D|P|0 0|   |0 0 0 0 0 0 0 0 0 1| Byte 0
                                                  |  +-----+---------+-+-----+-+-+-+-+-+-+---+-------+-------+-------+
                                                  |  |         Requester  ID         |      Tag      |Last DW|FirstDW| 
                                           Header |  |                               |               |0 0 0 0|1 1 1 1| Byte 4
                                                  |  +-------------------------------+---------------+-------+-------+ 
                                                  |  |                  MSI Message Address [63:32]                  | Byte 8
                                                  |  +-----------------------------------------------------------+---+ 
                                                  V  |                  MSI Message Address [31:00]              |0 0| Byte 12
                                                  -- +-------------------------------+---------------------------+---+
                                             Data    |       MSI Message Data        |             0000h             | Byte 16
                                                     +-------------------------------+-------------------------------+




o

                                                   Capability Structure for 32-bit Message Address

                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |             Message Control             |    Next Pointer    |   Capability  ID   | Capability Pointer + 0x0h
                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |                                 Message  Address                                  | Capability Pointer + 0x4h
                                                   +-----------------------------------------+-----------------------------------------+
                                                                                             |              Message  Data              | Capability Pointer + 0x8h
                                                                                             +-----------------------------------------+

                                                   Capability Structure for 64-bit Message Address

                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |             Message Control             |    Next Pointer    |   Capability  ID   | Capability Pointer + 0x0h
                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |                                 Message  Address                                  | Capability Pointer + 0x4h
                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |                               Message Upper Address                               | Capability Pointer + 0x8h
                                                   +-----------------------------------------+-----------------------------------------+
                                                                                             |              Message  Data              | Capability Pointer + 0xCh
                                                                                             +-----------------------------------------+

                                                   Capablity Structure for 32-bit Message Address and Per-vector Masking

                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |             Message Control             |    Next Pointer    |   Capability  ID   | Capability Pointer + 0x0h
                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |                                 Message  Address                                  | Capability Pointer + 0x4h
                                                   +-----------------------------------------+-----------------------------------------+
                                                   |                 Reserved                |              Message  Data              | Capability Pointer + 0x8h
                                                   +-----------------------------------------+-----------------------------------------+
                                                   |                                     Mask Bits                                     | Capability Pointer + 0xCh
                                                   +-----------------------------------------------------------------------------------+
                                                   |                                   Pending Bits                                    | Capability Pointer + 0x10h
                                                   +-----------------------------------------------------------------------------------+

						   Capability Structure for 64-bit Message Address and Per-vector Masking
						
                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |             Message Control             |    Next Pointer    |   Capability  ID   | Capability Pointer + 0x0h
                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |                                 Message  Address                                  | Capability Pointer + 0x4h
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Message Upper Address                               | Capability Pointer + 0x8h
                                                   +-----------------------------------------+-----------------------------------------+
                                                   |                 Reserved                |              Message  Data              | Capability Pointer + 0xCh
                                                   +-----------------------------------------+-----------------------------------------+
                                                   |                                     Mask Bits                                     | Capability Pointer + 0x10h
                                                   +-----------------------------------------------------------------------------------+
                                                   |                                   Pending Bits                                    | Capability Pointer + 0x14h
                                                   +-----------------------------------------------------------------------------------+






                                                   PCI Configuration Space

                                                   +-----------------------------------------+-----------------------------------------+
                                                   |                Device ID                |                Vendor ID                | 0x0H
                                                   +-----------------------------------------+-----------------------------------------+
                                                   |                  Status                 |                 Command                 | 0x04H
                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |                          Class Code                          |  Cache Line Size   | 0x08H
                                                   +--------------------+--------------------+--------------------+--------------------+
                                                   |        BIST        |    Header  Type    |   Latency  Timer   |  Cache Line Size   | 0x0CH
                                                   +--------------------+--------------------+--------------------+--------------------+
                                                   |                               Base Address 0 (BAR0)                               | 0x10H
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Base Address 1 (BAR1)                               | 0x14H
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Base Address 2 (BAR2)                               | 0x18H
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Base Address 3 (BAR3)                               | 0x1CH
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Base Address 4 (BAR4)                               | 0x20H
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Base Address 5 (BAR5)                               | 0x24H
                                                   +-----------------------------------------------------------------------------------+
                                                   |                                CarBus CIS Pointer                                 | 0x28H
                                                   +-----------------------------------------+-----------------------------------------+
                                                   |           Subsystem Device ID           |           Subsystem Vendor ID           | 0x2CH
                                                   +-----------------------------------------+-----------------------------------------+
                                                   |                             Expansion ROM Base Address                            | 0x30H
                                                   +--------------------------------------------------------------+--------------------+
                                                   |                            Rserved                           | Capability Pointer |----o 
                                                   +--------------------------------------------------------------+--------------------+    |  
                                                                                                                                  0x80H     |
                                                                                                                                            |
                                                   MSI Capability Regsiter                                                                  |
                                                   +-----------------------------------------+--------------------+--------------------+    |
                                                   |             Message Control             |    Next Pointer    |   Capability  ID   | <--o
                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |                                 Message  Address                                  | 0x84H
                                                   +-----------------------------------------+-----------------------------------------+
                                                                                             |              Message  Data              | 0x88H
                                                                                             +-----------------------------------------+



                                                    Message Control
                                                     
                                                     15                                  11   9 8 7 6   4 3   1 0
                                                    +--------------------------------------+-+-+-+-+-----+-----+-+
                                                    |                RsvdP                 | | | | |     |     | |
                                                    +--------------------------------------+-+-+-+-+-----+-----+-+
                                                                                            A A A A   A     A   A
                                                                                            | | | |   |     |   |
                                                                                            | | | |   |     |   o----- MSI Enable
                                                                                            | | | |   |     o--------- Multiple Message Capable
                                                                                            | | | |   o--------------- Multiple Message Enable
                                                                                            | | | o------------------- 64-bit Address Capable
                                                                                            | | o--------------------- Per-Vector Masking Capable
                                                                                            | o----------------------- Extended Message Data Capable    
                                                                                            o------------------------- Extended Message Data Enable
 







                                                   31                  20 19                 12 11               4  3    2   1  0
                                                  +----------------------+---------------------+------------------+----+----+----+
                                                  |        0XFEEH        |   Destination  ID   |     Reserved     | RH | DM | XX |
                                                  +----------------------+---------------------+------------------+----+----+----+




                                                  MSI Message Address Register

                                                   31                  20 19                 12 11               4 3 2 1 0
                                                  +----------------------+---------------------+------------------+-+-+---+
                                                  |        0xFEEH        |                     |     Reserved     | | |   |
                                                  +----------------------+---------------------+------------------+-+-+---+
                                                                                    A                              A A  A
                                                                                    |                              | |  |                     
                                                                                    |                              | |  o------- XX                     
                                                                                    |                              | o---------- DM           
                                                                                    |                              o------------ RH           
                                                                                    o------------------------------------------- Destination ID           



                                                  MSI Message Data Register

                                                   31                                                                     0
                                                  +------------------------------------------------------------------------+
                                                  |                                  Reserved                              |
                                                  +------------------------------------------------------------------------+

                                                   31                                  16     13        11    8 7         0
                                                  +--------------------------------------+-+-+------------+----+-----------+
                                                  |               Reserved               | | |  Reserved  |    |  Vector   |
                                                  +--------------------------------------+-+-+------------+----+-----------+
                                                                                          A A                A
                                                                                          | |                |
                                                                                          | |                o----------------- Delivery Mode
                                                                                          | |                                     000 - Fixed
                                                                                          | |                                     001 - Lowest Priority
                                                                                          | |                                     010 - SMI
                                                                                          | |                                     011 - Reserved
                                                                                          | |                                     100 - NMI
                                                                                          | |                                     101 - INTR
                                                                                          | |                                     110 - Reserved
                                                                                          | |                                     111 - ExtINT
                                                                                          | | 
                                                                                          | o---------------------------------- Level for Trigger Mode = 0 
                                                                                          |                                       X - Don't Care
                                                                                          |                                     Level for Trigger Mode = 1
                                                                                          |                                       0 - Deassert
                                                                                          |                                       1 - Assert
                                                                                          |  
                                                                                          o------------------------------------ Trigger Mode
                                                                                                                                  0 - Edge
                                                                                                                                  1 - Level









                                               MSI Mask Register
                                                31                                                              0
                                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                               | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | |
                                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                                               MSI Pending Register
                                                31                                                              0
                                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                               | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | |
                                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+










                                           pci_enable_msi
                                             |
                                             o-> __pci_enable_msi_range
                                                   |
                                                   o-> pci_msi_vec_count
                                                   |
                                                   o-> msi_capability_init
                                                         |
                                                         o-> pci_msi_set_enable
                                                         |
                                                         o-> msi_setup_entry
                                                         |     |
                                                         |     o-> alloc_msi_entry
                                                         |
                                                         o-> pci_msi_setup_msi_irqs
                                                               |
                                                               o-> msi_domain_alloc_irqs
                                                                     |
                                                                     o-> __msi_domain_alloc_irqs
                                                                           |
                                                                           o-> __irq_domain_alloc_irqs -------> alloc irq/vector
                                                                           |
                                                                           o-> irq_domain_get_irq_data 
                                                                           |
                                                                           o-> irq_domain_activate_irq
                                                                                 |
                                                                                 o-> __irq_domain_activate_irq
                                                                                       |
                                                                                       o-> msi_domain_activate
                                                                                             |
                                                                                             o-> irq_chip_compose_msi_msg
                                                                                             |     |
                                                                                             |     o-> x86_vector_msi_compose_msg
                                                                                             |           |
                                                                                             |           o-> __irq_msi_compose_msg --> Constructure msg_addr/msg_data
                                                                                             |
                                                                                             o-> irq_chip_write_msi_msg
                                                                                                   |
                                                                                                   o-> pci_msi_domain_write_msg
                                                                                                         |
                                                                                                         o-> __pci_write_msi_msg ----> Write msi_msg To MSI Capability Register










                                             Memory Write TLP

                                                     |7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|
                                                     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                     | Fmt |  Type   |R| TC  |R|A|R|T|T|E|ATT|AT |      Length       |
                                                     |0 1 1|0 0 0 0 0| |     | |T| |H|D|P|0 0|   |0 0 0 0 0 0 0 0 0 1| Byte 0
                                                     +-----+---------+-+-----+-+-+-+-+-+-+---+-------+-------+-------+
                                                     |         Requester  ID         |      Tag      |Last DW|FirstDW|
                                                     |                               |               |0 0 0 0|1 1 1 1| Byte 4
                                                     +-------------------------------+---------------+-------+-------+
                                              o----> |                  MSI Message Address [63:32]                  | Byte 8
                                              |      +-----------------------------------------------------------+---+
                                              | o--> |                  MSI Message Address [31:00]              |0 0| Byte 12
                                              | |    +-------------------------------+---------------------------+---+
                                            o------> |       MSI Message Data        |             0000h             | Byte 16
                                            | | |    +-------------------------------+-------------------------------+
                                            | | |
                                            | | |
                                            | | |
                                            | | |                                   
                                            | | |    +-------------------------------+---------------+---------------+
                                            | | |    |        Message Control        | Next  Pointer | Capability ID |
                                            | | |    +-------------------------------+-------------------------------+
                                            | | o----|                        Message Address                        |
                                            | |      +---------------------------------------------------------------+
                                            | o------|                     Message Upper Address                     |
                                            |        +-------------------------------+-------------------------------+
                                            o----------------------------------------|         Message  Data         |
                                                                                     +-------------------------------+









                                                   MSI Capability Regsiter                                                                  
                                                   +-----------------------------------------+--------------------+--------------------+    
                                                   |             Message Control             |    Next Pointer    |   Capability  ID   | 
                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |                                 Message  Address                                  | 
                                                   +-----------------------------------------+-----------------------------------------+
                                                                                             |              Message  Data              |
                                                                                             +-----------------------------------------+





                                             irq_signal_msi
                                               |
                                               o-> irq_default_signal_msi
                                                     |
                                                     o-> KVM_SIGNAL_MSI                                              Asynchronous Broiler
                                             ============================================================================================
                                             kvm_vm_ioctl                                                                Asynchronous KVM
                                               |
                                               o-> case: KVM_SIGNAL_MSI
                                                     |
                                                     o-> kvm_send_userspace_msi
                                                           |
                                                           o-> kvm_set_msi
                                                                 |
                                                                 o-> kvm_set_msi_irq
                                                                 |
                                                                 o-> kvm_irq_delivery_to_apic
                                                                       |
                                                                       o-> kvm_irq_delivery_to_apic_fast
                                                                             |
                                                                             o-> kvm_apic_map_get_dest_lapic
                                                                             |
                                                                             o-> kvm_apic_set_irq
                                                                                   |
                                                                                   o-> __apic_accept_irq
                                                                                         |
                                                                                         o-> case: APIC_DM_FIXED
                                                                                               |
                                                                                               o-> vmx_deliver_posted_interrupt

                                                                                                     | Posted interrupt descriptor
                                                                                                     |
                                                                                                     |                   Asynchronous KVM
                                             ========================================================|===================================
                                                                                                     |                           Guest OS           
                                                                                                     | Deliver Interrupt 
                                                                                                     V
                                                                                         +----------------------+
                                                                                         |        LAPIC         |
                                                                                         |  virtual-apic-page   |
                                                                                         | virtuial-access page |
                                                                                         +----------------------+
                                                                                                     |
                                                                                                     | Deliver Vector
                                                                                                     V
                                                                                              +-------------+
                                                                                              |             |
                                                                                              |     CPU     |
                                                                                              |             |
                                                                                              +-------------+









https://zhuanlan.zhihu.com/p/372958922









                                                                            Processor#1                 Processor#2                Processor#3               Processor#4
                                                                     +-----------------------+   +-----------------------+  +-----------------------+  +-----------------------+
                                                                     |                       |   |                       |  |                       |  |                       |
                                                                     |          CPU          |   |          CPU          |  |          CPU          |  |          CPU          |
                                                                     |                       |   |                       |  |                       |  |                       |
                                                                     +-----------------------+   +-----------------------+  +-----------------------+  +-----------------------+
                                                                     |      Local  APIC      |   |      Local  APIC      |  |      Local  APIC      |  |      Local  APIC      |
                                                                     +-----------------------+   +-----------------------+  +-----------------------+  +-----------------------+
                                                                                A A                         A A                        A A                        A A
                                                                      Interrupt | |               Interrupt | |              Interrupt | |              Interrupt | |
                                                                       Messages | | IPIs           Messages | | IPIs          Messages | | IPIs          Messages | | IPIs
                                                                                V V                         V V                        V V                        V V
                                                                     <--------------------------------------------------------------------------------------------------------->
                                                                                               A                              Processor System Bus
                                                                                               |
                                                                                               |
                                                                                               V
                                                                                        +-------------+
                                                                                        | PCI  Bridge |
                                                                                        +-------------+
                                                                                               A
                                                                                               |
                                                                                               V
                                                                     <----------------------------------------------------> PCI Bus
                                                                                A                   A                A
                                                                                | MSI               | MSIX           |
                                                                                |                   |                V
                                                                       +--------o--------+ +--------o--------+ +-----------+              +-----------+
                                                                       |                 | |                 | |           |       INTX#  |           |
                                                                       | PCI/PCIe  Agent | | PCI/PCIe  Agent | | I/O  APIC |<------------ | PCI Agent |
                                                                       |                 | |                 | |           |        PIRQ  |           |
                                                                       +-----------------+ +-----------------+ +-----------+              +-----------+








                                                   PCI Configuration Space

                                                   +-----------------------------------------+-----------------------------------------+
                                                   |                Device ID                |                Vendor ID                | 0x0H
                                                   +-----------------------------------------+-----------------------------------------+
                                                   |                  Status                 |                 Command                 | 0x04H
                                                   +-----------------------------------------+--------------------+--------------------+
                                                   |                          Class Code                          |  Cache Line Size   | 0x08H
                                                   +--------------------+--------------------+--------------------+--------------------+
                                                   |        BIST        |    Header  Type    |   Latency  Timer   |  Cache Line Size   | 0x0CH
                                                   +--------------------+--------------------+--------------------+--------------------+
                                                   |                               Base Address 0 (BAR0)                               | 0x10H
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Base Address 1 (BAR1)                               | 0x14H
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Base Address 2 (BAR2)                               | 0x18H
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Base Address 3 (BAR3)                               | 0x1CH
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Base Address 4 (BAR4)                               | 0x20H
                                                   +-----------------------------------------------------------------------------------+
                                                   |                               Base Address 5 (BAR5)                               | 0x24H
                                                   +-----------------------------------------------------------------------------------+
                                                   |                                CarBus CIS Pointer                                 | 0x28H
                                                   +-----------------------------------------+-----------------------------------------+
                                                   |           Subsystem Device ID           |           Subsystem Vendor ID           | 0x2CH
                                                   +-----------------------------------------+-----------------------------------------+
                                                   |                             Expansion ROM Base Address                            | 0x30H
                                                   +--------------------------------------------------------------+--------------------+
                                                   |                            Rserved                           | Capability Pointer |----o
                                                   +--------------------------------------------------------------+--------------------+    |
                                                                                                                                  0x80H     |
                                                                                                                                            |
                                                   MSIX Capability Regsiter                                                                 |
                                                   +-----------------------------------------+--------------------+--------------------+    |
                                                   |             Message Control             |    Next Pointer    |   Capability  ID   | <--o
                                                   +-----------------------------------------+--------------------+--------+-----------+
                                                   |                             Table  Offset                             | Table BIR | 0x84
                                                   +-----------------------------------------------------------------------+-----------+
                                                   |                              PBA  Offset                              |  PBA BIR  | 0x88
                                                   +-----------------------------------------------------------------------+-----------+





                                                         Message Control Register for MSI-X

                                                          15  13            11 10                              0 
                                                         +-+-+----------------+---------------------------------+
                                                         | | |     RsvdP      |           Table  Size           |
                                                         +-+-+----------------+---------------------------------+
                                                          A A
                                                          | |
                                                          | |
                                                          | o-------------------------------------------------------- Function Mask
                                                          o---------------------------------------------------------- MSI-X Enable

                                            



                                                         MSIX Table Vector Control Register

                                                          31                                                   1 0
                                                         +------------------------------------------------------+-+
                                                         |                       Reserved                       | |
                                                         +------------------------------------------------------+-+
                                                                                                                 A
                                                                                                                 |
                                                                                                                 o--- Per Vector Mask





                                                    31                                                                    3 2         0
                                                   +-----------------------------------------------------------------------+-----------+
                                                   |                             Table  Offset                             | Table BIR |
                                                   +-----------------------------------------------------------------------+-----------+
                                                   |                              PBA  Offset                              |  PBA BIR  |
                                                   +-----------------------------------------------------------------------+-----------+




                                                   MSI-X Table                                                   

                                                    31                 0 31                 0 31                 0 31                 0
                                                   +--------------------+--------------------+--------------------+--------------------+
                                                   |   Vector Control   |      Msg Data      |   Msg Upper Addr   |      Msg Addr      | Entry0      Base
                                                   +--------------------+--------------------+--------------------+--------------------+
                                                   |   Vector Control   |      Msg Data      |   Msg Upper Addr   |      Msg Addr      | Entry1      Base + 1*16Byte
                                                   +--------------------+--------------------+--------------------+--------------------+
                                                   |   Vector Control   |      Msg Data      |   Msg Upper Addr   |      Msg Addr      | Entry2      Base + 2*16Byte
                                                   +--------------------+--------------------+--------------------+--------------------+
                                                   |        ...         |        ...         |        ...         |        ...         |
                                                   +--------------------+--------------------+--------------------+--------------------+
                                                   |   Vector Control   |      Msg Data      |   Msg Upper Addr   |      Msg Addr      | Entry(N-1)  Base + (N-1)*16Byte
                                                   +--------------------+--------------------+--------------------+--------------------+













                                                  MSIX Table Message Address Register

                                                   31                  20 19                 12 11               4 3 2 1 0
                                                  +----------------------+---------------------+------------------+-+-+---+
                                                  |        0xFEEH        |                     |     Reserved     | | |   |
                                                  +----------------------+---------------------+------------------+-+-+---+
                                                                                    A                              A A  A
                                                                                    |                              | |  |
                                                                                    |                              | |  o------- XX
                                                                                    |                              | o---------- DM
                                                                                    |                              o------------ RH
                                                                                    o------------------------------------------- Destination ID



                                                  MSIX Table Message Data Register

                                                   31                                                                     0
                                                  +------------------------------------------------------------------------+
                                                  |                                  Reserved                              |
                                                  +------------------------------------------------------------------------+

                                                   31                                  16     13        11    8 7         0
                                                  +--------------------------------------+-+-+------------+----+-----------+
                                                  |               Reserved               | | |  Reserved  |    |  Vector   |
                                                  +--------------------------------------+-+-+------------+----+-----------+
                                                                                          A A                A
                                                                                          | |                |
                                                                                          | |                o----------------- Delivery Mode
                                                                                          | |                                     000 - Fixed
                                                                                          | |                                     001 - Lowest Priority
                                                                                          | |                                     010 - SMI
                                                                                          | |                                     011 - Reserved
                                                                                          | |                                     100 - NMI
                                                                                          | |                                     101 - INTR
                                                                                          | |                                     110 - Reserved
                                                                                          | |                                     111 - ExtINT
                                                                                          | |
                                                                                          | o---------------------------------- Level for Trigger Mode = 0
                                                                                          |                                       X - Don't Care
                                                                                          |                                     Level for Trigger Mode = 1
                                                                                          |                                       0 - Deassert
                                                                                          |                                       1 - Assert
                                                                                          |
                                                                                          o------------------------------------ Trigger Mode
                                                                                                                                  0 - Edge
                                                                                                                                  1 - Level





                                                         MSIX Table Pending Table

                                                          63                                                            0
                                                         +---------------------------------------------------------------+
                                                         |                   Pending Bits 0 Through 63                   | QWORD 0
                                                         +---------------------------------------------------------------+
                                                         |                  Pending Bits 64 Through 127                  | QWORD 1
                                                         +---------------------------------------------------------------+
                                                         |                             ...                               | ...
                                                         +---------------------------------------------------------------+
                                                         |           Pending Bits (N-1 div 64) * 64 Though N-1           | QWORD((N-1) div 64)
                                                         +---------------------------------------------------------------+



                                     pci_enable_msix_range
                                       |
                                       o-> __pci_enable_msix_range
                                             |
                                             o-> __pci_enable_msix
                                                   |
                                                   o-> pci_msix_vec_count
                                                   |
                                                   o-> msix_capability_init
                                                         |
                                                         o-> msix_map_region
                                                         |
                                                         o-> msix_setup_entries
                                                         |
                                                         o-> pci_msi_setup_msi_irqs
                                                               |
                                                               o-> msi_domain_alloc_irqs
                                                                     |
                                                                     o-> __msi_domain_alloc_irqs
                                                                           |
                                                                           o-> __irq_domain_alloc_irqs -------> alloc irq/vector
                                                                           |
                                                                           o-> irq_domain_get_irq_data
                                                                           |
                                                                           o-> irq_domain_activate_irq
                                                                                 |
                                                                                 o-> __irq_domain_activate_irq
                                                                                       |
                                                                                       o-> msi_domain_activate
                                                                                             |
                                                                                             o-> irq_chip_compose_msi_msg
                                                                                             |     |
                                                                                             |     o-> x86_vector_msi_compose_msg
                                                                                             |           |
                                                                                             |           o-> __irq_msi_compose_msg --> Constructure msg_addr/msg_data
                                                                                             |
                                                                                             o-> irq_chip_write_msi_msg
                                                                                                   |
                                                                                                   o-> pci_msi_domain_write_msg
                                                                                                         |
                                                                                                         o-> writel ----> Write msi_msg To MSIX Table Entry








                                                     Memory Write TLP

                                                     |7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|
                                                     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                     | Fmt |  Type   |R| TC  |R|A|R|T|T|E|ATT|AT |      Length       |
                                             Byte 0  |0 1 1|0 0 0 0 0| |     | |T| |H|D|P|0 0|   |0 0 0 0 0 0 0 0 0 1|
                                                     +-----+---------+-+-----+-+-+-+-+-+-+---+-------+-------+-------+
                                                     |         Requester  ID         |      Tag      |Last DW|FirstDW|
                                             Byte 4  |                               |               |0 0 0 0|1 1 1 1|
                                                     +-------------------------------+---------------+-------+-------+
                                             Byte 8  |                  MSI Message Address [63:32]                  |<---o
                                                     +-----------------------------------------------------------+---+    |
                                             Byte 12 |                  MSI Message Address [31:00]              |0 0|<-o |
                                                     +-------------------------------+---------------------------+---+  | |
                                             Byte 16 |       MSI Message Data        |             0000h             |  | |
                                                     +-------------------------------+-------------------------------+  | |
                                                                       A                                                | |
                                                                       |                                                | |
                                        MISX Table                     |                    o-----------------------------o
                                                                       |                    |                           |
                                         31                 0 31       |         0 31       |         0 31              |  0
                                        +--------------------+--------------------+--------------------+--------------------+
                                        |   Vector Control   |      Msg Data      |   Msg Upper Addr   |      Msg Addr      | Entry0     
                                        +--------------------+--------------------+--------------------+--------------------+
                                        |   Vector Control   |      Msg Data      |   Msg Upper Addr   |      Msg Addr      | Entry1     
                                        +--------------------+--------------------+--------------------+--------------------+
                                        |   Vector Control   |      Msg Data      |   Msg Upper Addr   |      Msg Addr      | Entry2     
                                        +--------------------+--------------------+--------------------+--------------------+
                                        |        ...         |        ...         |        ...         |        ...         |
                                        +--------------------+--------------------+--------------------+--------------------+
                                        |   Vector Control   |      Msg Data      |   Msg Upper Addr   |      Msg Addr      | Entry(N-1) 
                                        +--------------------+--------------------+--------------------+--------------------+




                                       Synchronous IO

                                                     IO R/W                          IO Finish
                                                       |                               |
                                                       |                               |
                                       System Running  V        System Waiting         V  System Running
                                       --------------->o------------------------------>o------------------->
                                                       | | | | | | | | | | | | | | | |A
                                                       | | | | | | | | | | | | | | | ||
                                                       V V V V V V V V V V V V V V V V|
                                                       o------------------------------>o
                                                               Device Handle IO

                                       Asynchronous IO

                                                     IO R/W                          IO Finish
                                                       |                               |
                                                       |                               |
                                       System Running  V        System Running         V  System Running
                                       --------------->o------------------------------>o------------------->
                                                       |                               A
                                                       |                               |
                                                       V                               | Interrupt
                                                       o------------------------------>o
                                                               Device Handle IO
                    





                                       IO Port                          MMIO
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                +----------------------------------+
                             | | | | | | | | | | | | | |                |                                  |
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                +----------------------------------+  Guest OS
                  =============================|====================================|=================================
                                   A           |                 A                  |            A     Synchronous KVM
                                   |   VM-EXIT |        VM-ENTRY | Read/Write       | VM-EXIT    |
                          VM-ENTRY |           V                 | Emulate          V            | VM-ENTRY
                                   |     o-----o-----o           |            o-----o-----o      |
                                   |     |           |           |            |           |      |
                                   |     |           V           |            V           |      |
                                   |     |     +-----------------o------------------+     |      |
                                   |     |     |                                    |     |      |
                                   |     |     |          In-Kernel Device          |     |      |
                                   |     |     |                                    |     |      |
                                   |     |     +------------------------------------+     |      |
                                   |     |                                                |      |     Synchronous KVM
                  =================|=====|================================================|======|====================
                                   |     |                                                |      |             Broiler
                        Read/Write |     |                                                |      | Read/Write
                           Emulate |     |                                                |      | Emulate
                                   |     V                                                V      |
                                +------------------------------------------------------------------+
                                |                                                                  |
                                |                        In-Broiler Device                         |
                                |                                                                  |
                                +------------------------------------------------------------------+





https://www.cnblogs.com/wuchanming/p/4732595.html




                                Exit Qualification for I/O Instructions

                                 63                                                                32
                                +--------------------------------------------------------------------+
                                |                        Reserved(Clear to 0)                        |
                                +--------------------------------------------------------------------+
                                 31                             16 15                   6 5 4 3 2 1 0
                                +---------------------------------+--------------------+-+-+-+-+-----+
                                |                                 | Reserved(Clear 0)  | | | | |     |
                                +---------------------------------+--------------------+-+-+-+-+-----+
                                                A                                       A A A A   A
                                                |                                       | | | |   |
                                                |                                       | | | |   o--- Size of access
                                                |                                       | | | |          0: 1-Byte
                                                |                                       | | | |          1: 2-Byte
                                                |                                       | | | |          3: 4-Byte
                                                |                                       | | | o------- Direction
                                                |                                       | | |            0: OUT
                                                |                                       | | |            1: IN
                                                |                                       | | o--------- String Instrution
                                                |                                       | |              0: not string
                                                |                                       | |              1: string
                                                |                                       | o----------- REP frefixed
                                                |                                       |                0: not REP
                                                |                                       |                1: REP
                                                |                                       o------------- Operand Encoding
                                                |                                                        0: DX
                                                |                                                        1: Immediate
                                                |                            
                                                o----------------------------------------------------- Port Number





                                        Synchronous IO Read On Broiler Device

                                                    PIO Read Begin: IN AX,DX
                                                             |
                                                             V
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                        | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                         Guest OS
                                        =====|================================================================================
                                             | VM-EXIT: EXIT_REASON_IO_INSTRUCTION                             Synchronous KVM
                                             V
                                        vmx_handle_exit                                                 
                                          |
                                          o-> handle_io
                                                |
                                                o-> kvm_fast_pio
                                                      |
                                                      o-> kvm_fast_pio_in
                                                            |
                                                            o-> emulator_pio_in
                                                                  |
                                                                  o-> emulator_pio_in_out: vcpu->run
                                                                        |                                      Synchronous KVM
                                        ================================|=====================================================
                                                                        | Return From IOCTL: KVM_RUN       Synchronous Broiler
                                                                        V
                                        broiler_cpu_start
                                          |
                                          o-> case: KVM_EXIT_IO
                                          |     |
                                          |     o-> broiler_cpu_emulate_io: vcpu->kvm_run
                                          |           |
                                          |           o-> Broiler_pio_callback                      
                                          |
                                          o-> broiler_cpu_run
                                                |
                                                o-> ioctl: KVM_RUN                                         Synchronous Broiler 
                                        ==============|=======================================================================
                                                      V                                                        Synchronous KVM
                                        kvm_vcpu_ioctl
                                          |
                                          o-> case: KVM_RUN
                                                |
                                                o-> kvm_arch_vcpu_ioctl_run
                                                      |
                                                      o-> vcpu_run
                                                            |
                                                            | VM-ENTRY                                         Synchronous KVM
                                        ====================|=================================================================
                                                            V                                                         Guest OS
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                        | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                         
                                                            |
                                                            V
                                                PIO Read Finish: IN AX,DX
                     









                                        Synchronous IO Write On Broiler Device

                                                    PIO Write Begin: OUT DX,AX
                                                             |
                                                             V
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                        | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                         Guest OS
                                        =====|================================================================================
                                             | VM-EXIT: EXIT_REASON_IO_INSTRUCTION                             Synchronous KVM
                                             V
                                        vmx_handle_exit        
                                          |  
                                          o-> handle_io
                                                |
                                                o-> kvm_fast_pio
                                                      |
                                                      o-> kvm_fast_pio_out
                                                            |
                                                            o-> kvm_rax_read
                                                            |
                                                            o-> emulator_pio_out
                                                                  |
                                                                  o-> emulator_pio_in_out: vcpu->run
                                                                        |                                      Synchronous KVM
                                        ================================|=====================================================
                                                                        | Return From IOCTL: KVM_RUN       Synchronous Broiler
                                                                        V
                                        broiler_cpu_start
                                          |
                                          o-> case: KVM_EXIT_IO
                                          |     |
                                          |     o-> broiler_cpu_emulate_io: vcpu->kvm_run
                                          |           |
                                          |           o-> Broiler_pio_callback
                                          |
                                          o-> broiler_cpu_run
                                                |
                                                o-> ioctl: KVM_RUN                                         Synchronous Broiler
                                        ==============|=======================================================================
                                                      V                                                        Synchronous KVM
                                        kvm_vcpu_ioctl
                                          |
                                          o-> case: KVM_RUN
                                                |
                                                o-> kvm_arch_vcpu_ioctl_run
                                                      |
                                                      o-> vcpu_run
                                                            |
                                                            | VM-ENTRY                                         Synchronous KVM
                                        ====================|=================================================================
                                                            V                                                         Guest OS
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                        | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                            |
                                                            V
                                                PIO Write Finish: OUT DX,AX









                                        Synchronous IO Read On In-Kernel Device

                                                    PIO Read Begin: IN AX,DX
                                                             |
                                                             V
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                        | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                         Guest OS
                                        =====|================================================================================
                                             | VM-EXIT: EXIT_REASON_IO_INSTRUCTION                             Synchronous KVM
                                             V
                                        vmx_handle_exit
                                          |
                                          o-> handle_io
                                                |
                                                o-> kvm_fast_pio
                                                      |
                                                      o-> kvm_fast_pio_in
                                                            |
                                                            o-> emulator_pio_in
                                                            |     |
                                                            |     o-> emulator_pio_in_out
                                                            |           |
                                                            |           o-> kernel_pio
                                                            |                 |
                                                            |                 o-> kvm_io_bus_read
                                                            |                       |
                                                            |                       o-> __kvm_io_bus_read
                                                            |                             |
                                                            |                             o-> kvm_iodevice_read
                                                            |
                                                            o-> kvm_rax_write
                                        
                                        vcpu_run
                                          |
                                          | VM-ENTRY                                                           Synchronous KVM
                                        ==|===================================================================================
                                          V                                                                           Guest OS
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                        | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                            |
                                                            V
                                                PIO Read Finish: IN AX,DX








                                        Synchronous IO Write On In-Kernel Device

                                                    PIO Write Begin: OUT DX,AX
                                                             |
                                                             V
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                        | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                         Guest OS
                                        =====|================================================================================
                                             | VM-EXIT: EXIT_REASON_IO_INSTRUCTION                             Synchronous KVM
                                             V
                                        vmx_handle_exit
                                          |
                                          o-> handle_io
                                                |
                                                o-> kvm_fast_pio
                                                      |
                                                      o-> kvm_fast_pio_out
                                                            |
                                                            o-> kvm_rax_read
                                                            |
                                                            o-> emulator_pio_out
                                                                  |
                                                                  o-> emulator_pio_in_out
                                                                        |
                                                                        o-> kernel_pio
                                                                              |
                                                                              o-> kvm_io_bus_write
                                                                                    |
                                                                                    o-> __kvm_io_bus_write
                                                                                          |
                                                                                          o-> kvm_iodevice_write
                                        vcpu_run
                                          |
                                          | VM-ENTRY                                                           Synchronous KVM
                                        ==|===================================================================================
                                          V                                                                           Guest OS
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                        | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                            |
                                                            V
                                                PIO Write Finish: OUT DX,AX








                                       IO Port                         
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+               
                             | | | | | | | | | | | | | |               
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                  =============================|=================================
                                   A           |                  Synchronous KVM
                                   |           |
                          VM-ENTRY |           | VM-EXIT
                                   |           |
                                   |           |      
                                   |           |     
                                   |           |                  Synchronous KVM
                  =================|===========|=================================
                                   |           |                          Broiler
                        Read/Write |           |                             
                           Emulate |           |                             
                                   |           V                             
                        +---------------------------------+
                        |                                 |
                        |        In-Broiler Device        |
                        |                                 |
                        +---------------------------------+





                                       IO Port
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+
                             | | | | | | | | | | | | | |
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                  =============================|=================================
                                   A           |                  Synchronous KVM
                                   |           |
                          VM-ENTRY |           | VM-EXIT
                                   |           |
                        Read/Write |           |
                           Emulate |           |
                                   |           V
                        +---------------------------------+
                        |                                 |
                        |        In-Kernel  Device        |
                        |                                 |
                        +---------------------------------+



                        PCI Agent
                        +------------------------+-----------------+
                        |         IO-BAR         |     MEM-BAR     |
                        +------------------------+-----------------+     Guest OS
                  =============================|=================================
                                   A           |                  Synchronous KVM
                                   |           |
                          VM-ENTRY |           | VM-EXIT
                                   |           |
                                   |           |
                                   |           |
                                   |           |                  Synchronous KVM
                  =================|===========|=================================
                                   |           |                          Broiler
                        Read/Write |           |
                           Emulate |           |
                                   |           V
                        +---------------------------------+
                        |                                 |
                        |      In-Broiler PCI Device      |
                        |                                 |
                        +---------------------------------+







                                        Asynchronous IO Write On Broiler Device

                                                    PIO Write Begin: OUT DX,AX
                                                             |
                                                             V
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                        | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
                                        =====|====================================================================================================
                                             | VM-EXIT: EXIT_REASON_IO_INSTRUCTION                                                 Synchronous KVM
                                             V
                                        vmx_handle_exit
                                          |
                                          o-> handle_io
                                                |
                                                o-> kvm_fast_pio
                                                      |
                                                      o-> kvm_fast_pio_out
                                                            |
                                                            o-> kvm_rax_read
                                                            |
                                                            o-> emulator_pio_out
                                                                  |
                                                                  o-> emulator_pio_in_out
                                                                        |
                                                                        o-> kernel_pio
                                                                              |
                                                                              o-> kvm_io_bus_write
                                                                                    |
                                                                                    o-> __kvm_io_bus_write: KVM_PIO_BUS
                                                                                          |
                                                                                          o-> kvm_iodevice_write
                                                                                                |
                                                                                                o-> ioeventfd_write
                                                                                                      |  | 
                                                                                             VM-ENTRY |  | evnetfd_signal          Synchronous KVM
                                        ==============================================================|===========================================
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+         V  :                                Guest OS
                                        | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space   :  
                                        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+            :  
                                                             |                                           :  
                                                             V                                           :  
                                                    PIO Write Finish: OUT DX,AX                          :
                                                                                                         :
                                        ==========================================================================================================
                                                                                        eventfd from KVM |                    Asynchronous Broiler
                                                                                                         V 
                                        read(eventfd)
                                          |
                                          o-> Emulate-PIO-write
                                                |
                                                o-> broiler_irq_line
                                                      |                                                                       Asynchronous Broiler
                                        ==============|===========================================================================================
                                                      V                                                                           Asynchronous KVM
                                                      o-> Inject Interrupt
                                                            |                                                                     Asynchronous KVM
                                        ====================|=====================================================================================
o                                                           V Interrupt                                                                   Guest OS





                                        Create An Asynchronous PIO on Broiler Device

                                        eventfd(0, 0)
                                        ioctl: KVM_IOEVENTFD                                                           Broiler
                                        ==|===================================================================================
                                          V                                                                                KVM
                                        kvm_vm_ioctl: KVM_IOEVENTFD
                                          |
                                          o-> kvm_ioeventfd
                                                |
                                                o-> kvm_assign_ioeventfd
                                                      |
                                                      o-> kvm_assign_ioeventfd_idx
                                                            |
                                                            o-> eventfd_ctx_fdget
                                                            |
                                                            o-> kvm_iodevice_init: ioeventfd_ops
                                                            |
                                                            o-> kvm_io_bus_register_dev
                                                                     

   
                                                     +--------------+     +--------------+     +--------------+     +--------------+
                                                 o-> | KVM_MMIO_BUS | <-> | kvm_io_range | <-> | kvm_io_range | <-> | kvm_io_range |
                                                 |   +--------------+     +--------------+     +--------------+     +--------------+
                                                 |
                                                 |   +-------------+     +--------------+     +--------------+     +--------------+
                                                 o-> | KVM_PIO_BUS | <-> | kvm_io_range | <-> | kvm_io_range | <-> | kvm_io_range |
                                      +-----+    |   +-------------+     +--------------+     +--------------+     +--------------+
                                      | KVM |----o
                                      +-----+    |   +---------------------------+     +--------------+     +--------------+     +--------------+
                                                 o-> | KVM_VIRTIO_CCW_NOTIFY_BUS | <-> | kvm_io_range | <-> | kvm_io_range | <-> | kvm_io_range |
                                                 |   +---------------------------+     +--------------+     +--------------+     +--------------+
                                                 |
                                                 |   +-------------------+     +--------------+     +--------------+
                                                 o-> | KVM_FAST_MMIO_BUS | <-> | kvm_io_range | <-> | kvm_io_range |
                                                     +-------------------+     +--------------+     +--------------+





                                       IO Port
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+
                             | | | | | | | | | | | | | |
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                  =============================|=================================
                             A              A  |                  Synchronous KVM
                             |              |  |
                             |     VM-ENTRY |  | VM-EXIT
                             |              |  |
                             |              |  |
                             |              |  | Eventfd Notify
                             |              o--V                  Synchronous KVM
                  ===========|=================|=================================
                     Inject  |         eventfd |             Asynchronous Broiler
                   Interrupt |                 |
                             |                 V
                        +---------------------------------+
                        |                                 |
                        |        In-Broiler Device        |
                        |          Write Emulate          |
                        +---------------------------------+







                                       Synchronous MMIO

                                                   MMIO R/W                        MMIO Finish
                                                       |                               |
                                                       |                               |
                                       System Running  V        System Waiting         V  System Running
                                       --------------->o------------------------------>o------------------->
                                                       | | | | | | | | | | | | | | | |A
                                                       | | | | | | | | | | | | | | | ||
                                                       V V V V V V V V V V V V V V V V|
                                                       o------------------------------>o
                                                               Device Handle IO

                                       Asynchronous MMIO

                                                    MMIO W                         MMIO Finish
                                                       |                               |
                                                       |                               |
                                       System Running  V        System Running         V  System Running
                                       --------------->o------------------------------>o------------------->
                                                       |                               A
                                                       |                               |
                                                       V                               | Interrupt
                                                       o------------------------------>o
                                                               Device Handle IO









https://blog.csdn.net/u014022631/article/details/83895821

https://www.it610.com/article/1293804501379129344.htm





                   First MMIO Read Begin: MOV EDI, imm32
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_VIOLATION                                                  Synchronous KVM
                V
           handle_ept_violation
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> kvm_mmu_do_page_fault
                   |     |
                   |     o-> kvm_tdp_page_fault
                   |           |
                   |           o-> direct_page_fault
                   |                 |
                   |                 o-> __direct_map
                   |                      |
                   |                      o-> mmu_set_spte
                   |                            |
                   |                            o-> set_spte
                   |                                  |
                   |                                  o-> set_mmio_spte
                   |                                        |
                   |                                        o-> mark_mmio_spte --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> segmented_read
                         |           |
                         |           o-> read_emulated
                         |                 |
                         |                 o-> emulator_read_emulated
                         |                       |
                         |                       o-> emulator_read_write
                         |                             |
                         |                             o-> emulator_read_write_onepage --> kvm_run --> KVM_EXIT_MMIO
                         |                                   |
                         |                                   o-> vcpu_mmio_read
                         |
                         o-> if: vcpu->mmio_needed
                               |
                               o-> vcpu->arch.complete_userspace_io: complete_emulated_mmio      
                                           |                                                          Synchronous KVM
           ================================|=========================================================================
                                           | Return From IOCTL: KVM_RUN                           Synchronous Broiler
                                           V
           broiler_cpu_start
             |
             o-> case: KVM_EXIT_MMIO
             |     |
             |     o-> broiler_cpu_emulate_mmio: vcpu->kvm_run
             |           |
             |           o-> Broiler_pio_callback
             |
             o-> broiler_cpu_run
                   |
                   o-> ioctl: KVM_RUN                                                             Synchronous Broiler
           ==============|===========================================================================================
                         V                                                                            Synchronous KVM
           kvm_vcpu_ioctl
             |
             o-> case: KVM_RUN
                   |
                   o-> kvm_arch_vcpu_ioctl_run
                         |
                         o-> if: vcpu->arch.complete_userspace_io
                         |     |
                         |     o-> complete_emulated_mmio
                         |           |
                         |           o-> complete_emulated_io
                         |                 |
                         |                 o-> kvm_emulate_instruction --> EMULTYPE_NO_DECODE
                         |                       |
                         |                       o-> x86_emulate_instruction
                         |                             |
                         |                             o-> x86_emulate_insn
                         |                                   |
                         |                                   o-> segmented_read
                         |                                   |
                         |                                   o-> writeback_registers
                         |                                         |
                         |                                         o-> emulator_write_gpr
                         |                                               |
                         |                                               o-> kvm_register_write
                         |
                         o-> vcpu_run
                               |
                               | VM-ENTRY                                                             Synchronous KVM
           ====================|=====================================================================================
                               V                                                                             Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
               First MMIO Read Finish: MOV EDI, imm32








                 Not First MMIO Read Begin: MOV EDI, imm32
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_MISCONFIG                                                  Synchronous KVM
                V
           handle_ept_misconfig
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> handle_mmio_page_fault
                   |     |
                   |     o-> mmio_info_in_cache --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> segmented_read
                         |           |
                         |           o-> read_emulated
                         |                 |
                         |                 o-> emulator_read_emulated
                         |                       |
                         |                       o-> emulator_read_write
                         |                             |
                         |                             o-> emulator_read_write_onepage --> kvm_run --> KVM_EXIT_MMIO
                         |                                   |
                         |                                   o-> vcpu_mmio_read
                         |                                   |
                         |                                   o-> read_exit_mmio
                         |
                         o-> if: vcpu->mmio_needed
                               |
                               o-> vcpu->arch.complete_userspace_io: complete_emulated_mmio      
                                           |                                                          Synchronous KVM
           ================================|=========================================================================
                                           | Return From IOCTL: KVM_RUN                           Synchronous Broiler
                                           V
           broiler_cpu_start
             |
             o-> case: KVM_EXIT_MMIO
             |     |
             |     o-> broiler_cpu_emulate_mmio: vcpu->kvm_run
             |           |
             |           o-> Broiler_pio_callback
             |
             o-> broiler_cpu_run
                   |
                   o-> ioctl: KVM_RUN                                                             Synchronous Broiler
           ==============|===========================================================================================
                         V                                                                            Synchronous KVM
           kvm_vcpu_ioctl
             |
             o-> case: KVM_RUN
                   |
                   o-> kvm_arch_vcpu_ioctl_run
                         |
                         o-> if: vcpu->arch.complete_userspace_io
                         |     |
                         |     o-> complete_emulated_mmio
                         |           |
                         |           o-> complete_emulated_io
                         |                 |
                         |                 o-> kvm_emulate_instruction --> EMULTYPE_NO_DECODE
                         |                       |
                         |                       o-> x86_emulate_instruction
                         |                             |
                         |                             o-> x86_emulate_insn
                         |                                   |
                         |                                   o-> segmented_read
                         |                                   |
                         |                                   o-> writeback_registers
                         |                                         |
                         |                                         o-> emulator_write_gpr
                         |                                               |
                         |                                               o-> kvm_register_write
                         |
                         o-> vcpu_run
                               |
                               | VM-ENTRY                                                             Synchronous KVM
           ====================|=====================================================================================
                               V                                                                             Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
             Not First MMIO Read Finish: MOV EDI, imm32





                                    Virtual Address
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |  +--------------+
                                              |                      |                      |                      |  +--------------+     |  |              |
                                              |                      |                      |                      |  |              |     |  +--------------+
                                              |                      |                      |                      |  +--------------+     o->|              |
                                              |                      |                      |                      |  |              |        +--------------+
                                              |                      |                      |                      |  +--------------+        |              |
                                              |                      |                      |  +--------------+    o->|   Physical   | -----> +--------------+
                                              |                      |                      |  |              |       +--------------+         MMIO
                                              |                      |                      |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |  +--------------+    o->|   Physcial   | ----> +--------------+
                                              |  |              |       +--------------+
                                              |  +--------------+       |              |
                                              o->|   Physcial   | ----> +--------------+
                                                 +--------------+
                                                 |              |
                                CR3              +--------------+
                                +----------+     |              |
                                | Physical | --> +--------------+
                                +----------+







                              +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


                             +----------------------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                             |                      | | | | | | | | | | | | | | | | | | |
                             +----------------------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | o--- 1: Data Read
                                                     | | | | | | | | | | | | | | | | o----- 1: Data Write
                                                     | | | | | | | | | | | | | | | o------- 1: Instruction Fetch
                                                     | | | | | | | | | | | | | | o--------- 
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |
                                                     | | | | | | | | | | | | | | | | | |







             C Code:

             mmio = ioremap(BROILER_MMIO_BASE, BROILER_MMIO_LEN);
             data = *(uint32_t *)mmio

	     X86 Machine Code        Assembly Code:

             bf 00 00 00 d0          mov	$0xd0000000,%edi






            +--------------+----------+----------+-------+----------------+-------------+
            | Instructions |          |          |       |                |             |
            |   Prefixes   |  Opcode  |  ModR/M  |  SIB  |  displacement  |  immediate  |
            |              |          |          |       |                |             |
            +--------------+----------+----------+-------+----------------+-------------+





                     PIO Read Begin: IN AX, DX
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_IO_INSTRUCTION                                                 Synchronous KVM
                V
           handle_io
             |
             o-> kvm_fast_pio
                   |
                   o-> kvm_fast_pio_in
                         |
                         o-> kvm_fast_pio_in --> vcpu->arch.complete_userspace_io: complete_fast_pio_in
                               |
                               o-> emulator_pio_in
                                     |
                                     o-> emulator_pio_in_out --> KVM_EXIT_IO/KVM_EXIT_IO_IN
                                              |                                                       Synchronous KVM
           ===================================|======================================================================
                                              | Return From IOCTL: KVM_RUN                                    Broiler
                                              V
           broiler_cpu_start
             |
             o-> case: KVM_EXIT_IO
             |     |
             |     o-> broiler_cpu_emulate_io: vcpu->kvm_run
             |           |
             |           o-> Broiler_pio_callback
             |   
             o-> broiler_cpu_run
                   |
                   o-> ioctl: KVM_RUN                                                                         Broiler
           ==============|===========================================================================================
                         V                                                                            Synchronous KVM
           kvm_vcpu_ioctl
             |
             o-> case: KVM_RUN
                   |
                   o-> kvm_arch_vcpu_ioctl_run
                         |
                         o-> if: vcpu->arch.complete_userspace_io
                         |         |
                         |         o-> complete_fast_pio_in
                         |               |
                         |               o-> emulator_pio_in
                         |               |     |
                         |               |     o-> memcpy: val <-- vcpu->arch.pio_data
                         |               |           
                         |               o-> kvm_rax_write: RAX <-- val           
                         |               |
                         |               o-> vmx_skip_emulated_instruction
                         |
                         o-> vcpu_run
                               |
                               | VM-ENTRY                                                             Synchronous KVM
           ====================|=====================================================================================
                               V                                                                             Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
                   PIO Read Finish: IN AX, DX





                    PIO Read Begin: IN AX, DX
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_IO_INSTRUCTION                                                 Synchronous KVM
                V
           handle_io
             |
             o-> kvm_fast_pio
                   |
                   o-> kvm_fast_pio_in
                   |     |
                   |     o-> kvm_fast_pio_in
                   |           |
                   |           o-> emulator_pio_in:
                   |           |     |
                   |           |     o-> emulator_pio_in_out
                   |           |     |     |
                   |           |     |     o-> kernel_pio
                   |           |     |           |
                   |           |     |           o-> kvm_io_bus_read
                   |           |     |                 |
                   |           |     |                 o-> __kvm_io_bus_read
                   |           |     |                       |
                   |           |     |                       o-> kvm_iodevice_read
                   |           |     |                             |
                   |           |     |                             o-> broiler_synchronous_pio_read (In-Kernel Device)
                   |           |     |
                   |           |     o-> memcpy: val <- vcpu->arch.pio_data
                   |           |     
                   |           o-> kvm_rax_write: RAX <- val
                   |
                   o-> kvm_skip_emulated_instruction
         
           vcpu_enter_guest
             |
             | VM_ENTRY                                                                               Synchronous KVM
           ==|=======================================================================================================
             V                                                                                               Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
                   PIO Read Finish: IN AX, DX








                                                       +------------+
                                                       |  pio_tree  |
                                                       +------------+
                                                              |
                                                      o-------o-------o
                                                      |               |
                                              o-------o-------o       o-------o
                                              |               |               |
                                         +----o----+     +----o----+     +----o----+     +-------------------+
                                         | IO PORT |     | IO PORT |     | IO PORT |---> | In-Broiler Device |
                                         +---------+     +---------+     +---------+     +-------------------+
                                              |               |               |
                                              V               V               V
                                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                   | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
                                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+










                   First MMIO Read Begin: MOV EDI, imm32
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_VIOLATION                                                  Synchronous KVM
                V
           handle_ept_violation
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> kvm_mmu_do_page_fault
                   |     |
                   |     o-> kvm_tdp_page_fault
                   |           |
                   |           o-> direct_page_fault
                   |                 |
                   |                 o-> __direct_map
                   |                      |
                   |                      o-> mmu_set_spte
                   |                            |
                   |                            o-> set_spte
                   |                                  |
                   |                                  o-> set_mmio_spte
                   |                                        |
                   |                                        o-> mark_mmio_spte --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> segmented_read
                         |     |     |
                         |     |     o-> read_emulated
                         |     |           |
                         |     |           o-> emulator_read_emulated
                         |     |           |     |
                         |     |           |     o-> emulator_read_write
                         |     |           |           |
                         |     |           |           o-> emulator_read_write_onepage
                         |     |           |                 |
                         |     |           |                 o-> vcpu_mmio_read
                         |     |           |                       |
                         |     |           |                       o-> kvm_io_bus_read
                         |     |           |                             |
                         |     |           |                             o-> __kvm_io_bus_read
                         |     |           |                                  |
                         |     |           |                                  o-> kvm_iodevice_read
                         |     |           |                                        |
                         |     |           |                                        o-> broiler_synchronous_mmio_read
                         |     |           |
                         |     |           o-> memcpy: ctxt->src.valptr <-- mc->data
                         |     |
                         |     o-> if: ctxt->execute
                         |     |     |
                         |     |     o-> em_mov
                         |     |
                         |     o-> writeback_registers 
                         |     
                         o-> if: writeback     
                               |
                               o-> kvm_rip_write
                               |
                               o-> vmx_update_emulated_instruction

           for(;;)
             |
             o-> vcpu_enter_guest
                   |
                   | VM-ENTRY                                                                         Synchronous KVM
           ========|=================================================================================================
                   V                                                                                         Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
               First MMIO Read Finish: MOV EDI, imm32





                 Not First MMIO Read Begin: MOV EDI, imm32
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_MISCONFIG                                                  Synchronous KVM
                V
           handle_ept_misconfig
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> handle_mmio_page_fault
                   |     |
                   |     o-> mmio_info_in_cache --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> segmented_read
                         |     |     |
                         |     |     o-> read_emulated
                         |     |           |
                         |     |           o-> emulator_read_emulated
                         |     |           |     |
                         |     |           |     o-> emulator_read_write
                         |     |           |           |
                         |     |           |           o-> emulator_read_write_onepage
                         |     |           |                 |
                         |     |           |                 o-> vcpu_mmio_read
                         |     |           |                       |
                         |     |           |                       o-> kvm_io_bus_read
                         |     |           |                             |
                         |     |           |                             o-> __kvm_io_bus_read
                         |     |           |                                  |
                         |     |           |                                  o-> kvm_iodevice_read
                         |     |           |                                        |
                         |     |           |                                        o-> broiler_synchronous_mmio_read
                         |     |           |
                         |     |           o-> memcpy: ctxt->src.valptr <-- mc->data
                         |     |
                         |     o-> if: ctxt->execute
                         |     |     |
                         |     |     o-> em_mov
                         |     |
                         |     o-> writeback_registers 
                         |     
                         o-> if: writeback     
                               |
                               o-> kvm_rip_write
                               |
                               o-> vmx_update_emulated_instruction

           for(;;)
             |
             o-> vcpu_enter_guest
                   |
                   | VM-ENTRY                                                                         Synchronous KVM
           ========|=================================================================================================
                   V                                                                                         Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
              Not First MMIO Read Begin: MOV EDI, imm32









                                                        +-----------+
                                                        | mmio_tree |
                                                        +-----------+
                                                              |
                                                      o-------o-------o
                                                      |               |
                                              o-------o-------o       o-------o
                                              |               |               |
                                       +------o---=--+ +------o------+ +------o------+     +-------------------+
                                       | MMIO  Range | | MMIO  Range | | MMIO  Range |---> | In-Broiler Device |
                                       +-------------+ +-------------+ +-------------+     +-------------------+
                                              |               |               |
                                              V               V               V
                                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                   | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
                                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+






                                       MMIO
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+
                             | | | | | | | | | | | | | |
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                  =============================|=================================
                                   A           |                  Synchronous KVM
                                   |           |
                          VM-ENTRY |           | VM-EXIT
                                   |           |
                                   |           |
                                   |           |
                                   |           |                  Synchronous KVM
                  =================|===========|=================================
                                   |           |                          Broiler
                        Read/Write |           |
                           Emulate |           |
                                   |           V
                        +---------------------------------+
                        |                                 |
                        |        In-Broiler Device        |
                        |                                 |
                        +---------------------------------+









                                        MMIO
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+
                             | | | | | | | | | | | | | |
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                  =============================|=================================
                                   A           |                  Synchronous KVM
                                   |           |
                          VM-ENTRY |           | VM-EXIT
                                   |           |
                        Read/Write |           |
                           Emulate |           |
                                   |           V
                        +---------------------------------+
                        |                                 |
                        |        In-Kernel  Device        |
                        |                                 |
                        +---------------------------------+

















                   First MMIO Write Begin: MOV imm32, EDI
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_VIOLATION                                                  Synchronous KVM
                V
           handle_ept_violation
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> kvm_mmu_do_page_fault
                   |     |
                   |     o-> kvm_tdp_page_fault
                   |           |
                   |           o-> direct_page_fault
                   |                 |
                   |                 o-> __direct_map
                   |                      |
                   |                      o-> mmu_set_spte
                   |                            |
                   |                            o-> set_spte
                   |                                  |
                   |                                  o-> set_mmio_spte
                   |                                        |
                   |                                        o-> mark_mmio_spte --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> writeback
                         |           |
                         |           o-> OP_MEM: segmented_write
                         |                 |
                         |                 o-> emulator_write_emulated
                         |                       |
                         |                       o-> emulator_read_write
                         |                             |
                         |                             o-> emulator_read_write_onepage
                         |                             |
                         |                             o-> vcpu->mmio_needed: 1
                         |                             |
                         |                             o-> vcpu->run->exit_reason: KVM_EXIT_MMIO
                         |                             |
                         |                             o-> write_exit_mmio
                         |
                         o-> if: vcpu->mmio_needed
                               |
                               o-> vcpu->arch.complete_userspace_io: complete_emulated_mmio
                                           |                                                          Synchronous KVM
           ================================|=========================================================================
                                           | Return From IOCTL: KVM_RUN                           Synchronous Broiler
                                           V
           broiler_cpu_start
             |
             o-> case: KVM_EXIT_MMIO
             |     |
             |     o-> broiler_cpu_emulate_mmio: vcpu->kvm_run
             |           |
             |           o-> Broiler_mmio_callback
             |
             o-> broiler_cpu_run
                   |
                   o-> ioctl: KVM_RUN                                                             Synchronous Broiler
           ==============|===========================================================================================
                         V                                                                            Synchronous KVM
           kvm_vcpu_ioctl
             |
             o-> case: KVM_RUN
                   |
                   o-> kvm_arch_vcpu_ioctl_run
                         |
                         o-> if: vcpu->arch.complete_userspace_io
                         |     |
                         |     o-> complete_emulated_mmio
                         |           |
                         |           o-> if: vcpu->mmio_is_write
                         |                 |
                         |                 o-> return 1
                         |
                         o-> vcpu_run
                               |
                               | VM-ENTRY                                                             Synchronous KVM
           ====================|=====================================================================================
                               V                                                                             Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
               First MMIO Write Finish: MOV imm32, EDI







                   First MMIO Write Begin: MOV imm32, EDI
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_VIOLATION                                                  Synchronous KVM
                V
           handle_ept_violation
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> kvm_mmu_do_page_fault
                   |     |
                   |     o-> kvm_tdp_page_fault
                   |           |
                   |           o-> direct_page_fault
                   |                 |
                   |                 o-> __direct_map
                   |                      |
                   |                      o-> mmu_set_spte
                   |                            |
                   |                            o-> set_spte
                   |                                  |
                   |                                  o-> set_mmio_spte
                   |                                        |
                   |                                        o-> mark_mmio_spte --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> writeback
                         |           |
                         |           o-> OP_MEM: segmented_write
                         |                 |
                         |                 o-> emulator_write_emulated
                         |                       |
                         |                       o-> emulator_read_write
                         |                             |
                         |                             o-> emulator_read_write_onepage
                         |                             |
                         |                             o-> vcpu->mmio_needed: 1
                         |                             |
                         |                             o-> vcpu->run->exit_reason: KVM_EXIT_MMIO
                         |                             |
                         |                             o-> write_exit_mmio
                         |
                         o-> if: vcpu->mmio_needed
                               |
                               o-> vcpu->arch.complete_userspace_io: complete_emulated_mmio
                                           |                                                          Synchronous KVM
           ================================|=========================================================================
                                           | Return From IOCTL: KVM_RUN                           Synchronous Broiler
                                           V
           broiler_cpu_start
             |
             o-> case: KVM_EXIT_MMIO
             |     |
             |     o-> broiler_cpu_emulate_mmio: vcpu->kvm_run
             |           |
             |           o-> Broiler_mmio_callback
             |
             o-> broiler_cpu_run
                   |
                   o-> ioctl: KVM_RUN                                                             Synchronous Broiler
           ==============|===========================================================================================
                         V                                                                            Synchronous KVM
           kvm_vcpu_ioctl
             |
             o-> case: KVM_RUN
                   |
                   o-> kvm_arch_vcpu_ioctl_run
                         |
                         o-> if: vcpu->arch.complete_userspace_io
                         |     |
                         |     o-> complete_emulated_mmio
                         |           |
                         |           o-> if: vcpu->mmio_is_write
                         |                 |
                         |                 o-> return 1
                         |
                         o-> vcpu_run
                               |
                               | VM-ENTRY                                                             Synchronous KVM
           ====================|=====================================================================================
                               V                                                                             Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
               First MMIO Write Finish: MOV imm32, EDI













                Not First MMIO Write Begin: MOV imm32, EDI
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_MISCONFIG                                                  Synchronous KVM
                V
           handle_ept_misconfig
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> handle_mmio_page_fault
                   |     |
                   |     o-> mmio_info_in_cache --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> writeback
                         |           |
                         |           o-> OP_MEM: segmented_write
                         |                 |
                         |                 o-> emulator_write_emulated
                         |                       |
                         |                       o-> emulator_read_write
                         |                             |
                         |                             o-> emulator_read_write_onepage
                         |                             |
                         |                             o-> vcpu->mmio_needed: 1
                         |                             |
                         |                             o-> vcpu->run->exit_reason: KVM_EXIT_MMIO
                         |                             |
                         |                             o-> write_exit_mmio
                         |
                         o-> if: vcpu->mmio_needed
                               |
                               o-> vcpu->arch.complete_userspace_io: complete_emulated_mmio
                                           |                                                          Synchronous KVM
           ================================|=========================================================================
                                           | Return From IOCTL: KVM_RUN                           Synchronous Broiler
                                           V
           broiler_cpu_start
             |
             o-> case: KVM_EXIT_MMIO
             |     |
             |     o-> broiler_cpu_emulate_mmio: vcpu->kvm_run
             |           |
             |           o-> Broiler_mmio_callback
             |
             o-> broiler_cpu_run
                   |
                   o-> ioctl: KVM_RUN                                                             Synchronous Broiler
           ==============|===========================================================================================
                         V                                                                            Synchronous KVM
           kvm_vcpu_ioctl
             |
             o-> case: KVM_RUN
                   |
                   o-> kvm_arch_vcpu_ioctl_run
                         |
                         o-> if: vcpu->arch.complete_userspace_io
                         |     |
                         |     o-> complete_emulated_mmio
                         |           |
                         |           o-> if: vcpu->mmio_is_write
                         |                 |
                         |                 o-> return 1
                         |
                         o-> vcpu_run
                               |
                               | VM-ENTRY                                                             Synchronous KVM
           ====================|=====================================================================================
                               V                                                                             Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
             Not First MMIO Write Finish: MOV imm32, EDI









                   First MMIO Write Begin: MOV imm32, EDI
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_VIOLATION                                                  Synchronous KVM
                V
           handle_ept_violation
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> kvm_mmu_do_page_fault
                   |     |
                   |     o-> kvm_tdp_page_fault
                   |           |
                   |           o-> direct_page_fault
                   |                 |
                   |                 o-> __direct_map
                   |                      |
                   |                      o-> mmu_set_spte
                   |                            |
                   |                            o-> set_spte
                   |                                  |
                   |                                  o-> set_mmio_spte
                   |                                        |
                   |                                        o-> mark_mmio_spte --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> if: ctxt->execute
                         |     |     |
                         |     |     o-> em_mov
                         |     |
                         |     o-> writeback
                         |     |     |
                         |     |     o-> OP_MEM: segmented_write
                         |     |           |
                         |     |           o-> emulator_write_emulated
                         |     |                 |
                         |     |                 o-> emulator_read_write
                         |     |                       |
                         |     |                       o-> emulator_read_write_onepage
                         |     |                             |
                         |     |                             o-> ops->read_write_mmio: write_mmio
                         |     |                                   |
                         |     |                                   o-> vcpu_mmio_write
                         |     |                                         |
                         |     |                                         o-> kvm_io_bus_write
                         |     |                                               |
                         |     |                                               o-> __kvm_io_bus_write 
                         |     |                                                     |
                         |     |                                                     o-> kvm_iodevice_write
                         |     |                                                           |
                         |     |                                                           o-> broiler_synchronous_mmio_write
                         |     |
                         |     o-> writeback_registers 
                         |     
                         o-> if: writeback     
                               |
                               o-> kvm_rip_write
                               |
                               o-> vmx_update_emulated_instruction

           for(;;)
             |
             o-> vcpu_enter_guest
                   |
                   | VM-ENTRY                                                                         Synchronous KVM
           ========|=================================================================================================
                   V                                                                                         Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
               First MMIO Write Finish: MOV imm32, EDI





                Not First MMIO Write Begin: MOV imm32, EDI
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_MISCONFIG                                                  Synchronous KVM
                V
           handle_ept_misconfig
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> handle_mmio_page_fault
                   |     |
                   |     o-> mmio_info_in_cache --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> if: ctxt->execute
                         |     |     |
                         |     |     o-> em_mov
                         |     |
                         |     o-> writeback
                         |     |     |
                         |     |     o-> OP_MEM: segmented_write
                         |     |           |
                         |     |           o-> emulator_write_emulated
                         |     |                 |
                         |     |                 o-> emulator_read_write
                         |     |                       |
                         |     |                       o-> emulator_read_write_onepage
                         |     |                             |
                         |     |                             o-> ops->read_write_mmio: write_mmio
                         |     |                                   |
                         |     |                                   o-> vcpu_mmio_write
                         |     |                                         |
                         |     |                                         o-> kvm_io_bus_write
                         |     |                                               |
                         |     |                                               o-> __kvm_io_bus_write
                         |     |                                                     |
                         |     |                                                     o-> kvm_iodevice_write
                         |     |                                                           |
                         |     |                                                           o-> broiler_synchronous_mmio_write
                         |     |
                         |     o-> writeback_registers
                         |
                         o-> if: writeback
                               |
                               o-> kvm_rip_write
                               |
                               o-> vmx_update_emulated_instruction

           for(;;)
             |
             o-> vcpu_enter_guest
                   |
                   | VM-ENTRY                                                                         Synchronous KVM
           ========|=================================================================================================
                   V                                                                                         Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
              Not First MMIO Write Finish: MOV imm32, EDI




                        PCI Agent
                        +-----------------------------------------+
                        |                 MEM-BAR                 |
                        +-----------------------------------------+      Guest OS
                  =============================|=================================
                                   A           |                  Synchronous KVM
                                   |           |
                          VM-ENTRY |           | VM-EXIT
                                   |           |
                                   |           |
                                   |           |
                                   |           |                  Synchronous KVM
                  =================|===========|=================================
                                   |           |                          Broiler
                        Read/Write |           |
                           Emulate |           |
                                   |           V
                        +---------------------------------+
                        |                                 |
                        |      In-Broiler PCI Device      |
                        |                                 |
                        +---------------------------------+












                    PIO Write Begin: OUT DX, AX
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_IO_INSTRUCTION                                                 Synchronous KVM
                V
           handle_io
             |
             o-> kvm_fast_pio
                   |
                   o-> kvm_fast_pio_out
                         |
                         o-> kvm_rax_read: <-- RAX/AX
                         |
                         o-> emulator_pio_out: vcpu->arch.pio_data <-- RAX/AX
                         |     |
                         |     o-> emulator_pio_in_out --> KVM_EXIT_IO/KVM_EXIT_IO_OUT
                         |
                         o-> vcpu->arch.complete_userspace_io: complete_fast_pio_out
                                     |                                                                Synchronous KVM
           ==========================|===============================================================================
                                     | Return From IOCTL: KVM_RUN                                             Broiler
                                     V        
           broiler_cpu_start
             |
             o-> case: KVM_EXIT_IO
             |     |
             |     o-> broiler_cpu_emulate_io: vcpu->kvm_run
             |           |
             |           o-> Broiler_pio_callback
             |   
             o-> broiler_cpu_run
                   |
                   o-> ioctl: KVM_RUN                                                                         Broiler
           ==============|===========================================================================================
                         V                                                                            Synchronous KVM
           kvm_vcpu_ioctl
             |
             o-> case: KVM_RUN
                   |
                   o-> kvm_arch_vcpu_ioctl_run
                         |
                         o-> if: vcpu->arch.complete_userspace_io
                         |         |
                         |         o-> complete_fast_pio_out
                         |               |
                         |               o-> kvm_skip_emulated_instruction
                         |
                         o-> vcpu_run
                               |
                               | VM-ENTRY                                                             Synchronous KVM
           ====================|=====================================================================================
                               V                                                                             Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
                   PIO Write Finish: IN DX, AX





                    PIO Write Begin: IN DX, AX
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_IO_INSTRUCTION                                                 Synchronous KVM
                V
           handle_io
             |
             o-> kvm_fast_pio
                   |
                   o-> kvm_fast_pio_in
                   |     |
                   |     o-> kvm_fast_pio_out
                   |           |
                   |           o-> kvm_rax_read: <-- RAX/AX
                   |           |
                   |           o-> emulator_pio_out: vcpu->arch.pio_data <-- RAX/AX
                   |                 |
                   |                 o-> emulator_pio_in_out
                   |                       |
                   |                       o-> kernel_pio
                   |                             |
                   |                             o-> kvm_io_bus_write
                   |                                   |
                   |                                   o-> __kvm_io_bus_write
                   |                                         |
                   |                                         o-> kvm_iodevice_write
                   |                                               |
                   |                                               o-> broiler_synchronous_pio_write (In-Kernel Device)
                   |
                   o-> kvm_skip_emulated_instruction
         
           vcpu_enter_guest
             |
             | VM_ENTRY                                                                               Synchronous KVM
           ==|=======================================================================================================
             V                                                                                               Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
                   PIO Write Finish: IN DX, AX






                                       IO Port                          MMIO
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                +----------------------------------+
                             | | | | | | | | | | | | | |                |                                  |
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                +----------------------------------+  Guest OS
                  =============================|====================================|=================================
                                   A           |                 A                  |            A     Synchronous KVM
                                   |   VM-EXIT |        VM-ENTRY | Read/Write       | VM-EXIT    |
                          VM-ENTRY |           V                 | Emulate          V            | VM-ENTRY
                                   |     o-----o-----o           |            o-----o-----o      |
                                   |     |           |           |            |           |      |
                                   |     |           V           |            V           |      |
                                   |     |     +-----------------o------------------+     |      |
                                   |     |     |                                    |     |      |
                                   |     |     |          In-Kernel Device          |     |      |
                                   |     |     |                                    |     |      |
                                   |     |     +------------------------------------+     |      |
                                   |     |                                                |      |     Synchronous KVM
                  =================|=====|================================================|======|====================
                                   |     |                                                |      |             Broiler
                        Read/Write |     |                                                |      | Read/Write
                           Emulate |     |                                                |      | Emulate
                                   |     V                                                V      |
                                +------------------------------------------------------------------+
                                |                                                                  |
                                |                        In-Broiler Device                         |
                                |                                                                  |
                                +------------------------------------------------------------------+


                            MMIO
                            +--------------------------------------+
                            |                                      |
                            +--------------------------------------+
                  =============================|====================================|=================================
                                               |A
                                       VM-EXIT || VM-ENTRY
                                               ||
                                               ||
                                               ||
                                               ||
                                               ||
                                               V|
                  ==============================|===================================|=================================

                                       

             ----------------------------------------------------------------------------------------------------------->

             ------------------------+------------------+----------------------------------+-----------+----------------
                                     |                  |                                  |  Guest OS |
             Guest Running           |  Geust Stopping  |          Guest  Running          | handle on | Guest Running
                         Access MMIO |                  |                                  | Interrupt |
             ------------------------+------------------+----------------------------------+-----------+----------------
                                     |                  A                                  A
                             VM-EXIT |                  | VM-ENTRY                         |
                                     V                  |                                  |
                                     +------------------+                  +---------------+
                                     |      Kernel      |                  |    Kernel     |
                                     |                  |                  |  KVM  Inject  |
                                     | KVM Pass Broiler |                  |   Interrupt   |
                                     +------------------+                  +---------------+
                                                        |                  A                                        KVM
             -------------------------------------------|------------------|--------------------------------------------
                                                        |                  |                                   Userspace
                                                        V                  |
                                                        +------------------+
                                                        |     Broiler      |
                                           thread ----->|                  | MMIO Finish
                                                        | Emulate Hardware |
                                                        +------------------+














             ----------------------------------------------------------------------------------------------------------->

             ------------------------+------------------+----------------------------------+-----------+----------------
                                     |                  |                                  |  Guest OS |
             Guest Running           |  Geust Stopping  |          Guest  Running          | handle on | Guest Running
                          Access I/O |                  |                                  | Interrupt |
             ------------------------+------------------+----------------------------------+-----------+----------------
                                     |                  A                                  A
                             VM-EXIT |                  | VM-ENTRY                         |
                                     V                  |                                  |
                                     +------------------+                  +---------------+
                                     |      Kernel      |                  |    Kernel     |
                                     |                  |                  |  KVM  Inject  |
                                     | KVM Pass Broiler |                  |   Interrupt   |
                                     +------------------+                  +---------------+
                                                        |                  A                                        KVM
             -------------------------------------------|------------------|--------------------------------------------
                                                        |                  |                                   Userspace
                                                        V                  |              
                                                        +------------------+              
                                                        |     Broiler      |              
                                           thread ----->|                  | I/O Finish            
                                                        | Emulate Hardware |              
                                                        +------------------+              







                   First MMIO Write Begin: MOV imm32, EDI
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_VIOLATION                                                  Synchronous KVM
                V
           handle_ept_violation
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> kvm_mmu_do_page_fault
                   |     |
                   |     o-> kvm_tdp_page_fault
                   |           |
                   |           o-> direct_page_fault
                   |                 |
                   |                 o-> __direct_map
                   |                      |
                   |                      o-> mmu_set_spte
                   |                            |
                   |                            o-> set_spte
                   |                                  |
                   |                                  o-> set_mmio_spte
                   |                                        |
                   |                                        o-> mark_mmio_spte --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> writeback
                         |           |
                         |           o-> OP_MEM: segmented_write
                         |                 |
                         |                 o-> emulator_write_emulated
                         |                       |
                         |                       o-> emulator_read_write
                         |                             |
                         |                             o-> emulator_read_write_onepage
                         |                             |
                         |                             o-> vcpu->mmio_needed: 1
                         |                             |
                         |                             o-> vcpu->run->exit_reason: KVM_EXIT_MMIO
                         |                             |
                         |                             o-> write_exit_mmio
                         |
                         o-> if: vcpu->mmio_needed
                               |
                               o-> vcpu->arch.complete_userspace_io: complete_emulated_mmio
                                           |                                                          Synchronous KVM
           ================================|=========================================================================
                                           | Return From IOCTL: KVM_RUN                           Synchronous Broiler
                                           V
           broiler_cpu_start
             |
             o-> case: KVM_EXIT_MMIO
             |     |
             |     o-> broiler_cpu_emulate_mmio: vcpu->kvm_run
             |           |
             |           o-> Broiler_mmio_callback
             |
             o-> broiler_cpu_run
                   |
                   o-> ioctl: KVM_RUN                                                             Synchronous Broiler
           ==============|===========================================================================================
                         V                                                                            Synchronous KVM
           kvm_vcpu_ioctl
             |
             o-> case: KVM_RUN
                   |
                   o-> kvm_arch_vcpu_ioctl_run
                         |
                         o-> if: vcpu->arch.complete_userspace_io
                         |     |
                         |     o-> complete_emulated_mmio
                         |           |
                         |           o-> if: vcpu->mmio_is_write
                         |                 |
                         |                 o-> return 1
                         |
                         o-> vcpu_run
                               |
                               | VM-ENTRY                                                             Synchronous KVM
           ====================|=====================================================================================
                               V                                                                             Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
               First MMIO Write Finish: MOV imm32, EDI













                Not First MMIO Write Begin: MOV imm32, EDI
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                             Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_MISCONFIG                                                  Synchronous KVM
                V
           handle_ept_misconfig
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> handle_mmio_page_fault
                   |     |
                   |     o-> mmio_info_in_cache --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> writeback
                         |           |
                         |           o-> OP_MEM: segmented_write
                         |                 |
                         |                 o-> emulator_write_emulated
                         |                       |
                         |                       o-> emulator_read_write
                         |                             |
                         |                             o-> emulator_read_write_onepage
                         |                                   |
                         |                                   o-> ops->read_write_mmio: write_mmio
                         |                                         |
                         |                                         o-> vcpu_mmio_write
                         |                                               |
                         |                                               o->
                         |                                               |
                         |                                               |
                         |                                               |
                         |                                               



                                           |                                                          Synchronous KVM
           ================================|=========================================================================
                                           | Return From IOCTL: KVM_RUN                           Synchronous Broiler
                                           V
           broiler_cpu_start
             |
             o-> case: KVM_EXIT_MMIO
             |     |
             |     o-> broiler_cpu_emulate_mmio: vcpu->kvm_run
             |           |
             |           o-> Broiler_mmio_callback
             |
             o-> broiler_cpu_run
                   |
                   o-> ioctl: KVM_RUN                                                             Synchronous Broiler
           ==============|===========================================================================================
                         V                                                                            Synchronous KVM
           kvm_vcpu_ioctl
             |
             o-> case: KVM_RUN
                   |
                   o-> kvm_arch_vcpu_ioctl_run
                         |
                         o-> if: vcpu->arch.complete_userspace_io
                         |     |
                         |     o-> complete_emulated_mmio
                         |           |
                         |           o-> if: vcpu->mmio_is_write
                         |                 |
                         |                 o-> return 1
                         |
                         o-> vcpu_run
                               |
                               | VM-ENTRY                                                             Synchronous KVM
           ====================|=====================================================================================
                               V                                                                             Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               |
                               V
             Not First MMIO Write Finish: MOV imm32, EDI






                   First MMIO Write Begin: MOV imm32, EDI
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                                   Guest OS
           =====|==========================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_VIOLATION                                                        Synchronous KVM
                V                                                                                    
           handle_ept_violation
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> kvm_mmu_do_page_fault
                   |     |
                   |     o-> kvm_tdp_page_fault
                   |           |
                   |           o-> direct_page_fault
                   |                 |
                   |                 o-> __direct_map
                   |                      |
                   |                      o-> mmu_set_spte
                   |                            |
                   |                            o-> set_spte
                   |                                  |
                   |                                  o-> set_mmio_spte
                   |                                        |
                   |                                        o-> mark_mmio_spte --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> if: ctxt->execute
                         |     |     |
                         |     |     o-> em_mov
                         |     |
                         |     o-> writeback
                         |     |     |
                         |     |     o-> OP_MEM: segmented_write
                         |     |           |
                         |     |           o-> emulator_write_emulated
                         |     |                 |
                         |     |                 o-> emulator_read_write
                         |     |                       |
                         |     |                       o-> emulator_read_write_onepage
                         |     |                             |
                         |     |                             o-> ops->read_write_mmio: write_mmio
                         |     |                                   |
                         |     |                                   o-> vcpu_mmio_write
                         |     |                                         |
                         |     |                                         o-> kvm_io_bus_write
                         |     |                                               |
                         |     |                                               o-> __kvm_io_bus_write 
                         |     |                                                     |
                         |     |                                                     o-> kvm_iodevice_write
                         |     |                                                           |
                         |     |                                                           o-> ioeventfd_write
                         |     |                                                                 |
                         |     o-> writeback_registers                                           |
                         |                                                                       |
                         o-> if: writeback                                                       |
                               |                                                                 |
                               o-> kvm_rip_write                                                 |
                               |                                                                 |
                               o-> vmx_update_emulated_instruction                               |
           for(;;)                                                                               |
             |                                                                                   |
             o-> vcpu_enter_guest                                                                |
                   |                                                                             |
                   | VM-ENTRY                                                                    |          Synchronous KVM
           ========|=======================================================================================================
                   V                                                                             :                 Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                 :      
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space                    :
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                 :
                               |                                                                 :
                               V                                                                 :
               First MMIO Write Finish: MOV imm32, EDI                                           :
                                                                                                 :
                                                                A Interrupt                      :                Guest OS
           =====================================================|==========================================================
                                                                :                                |     Asynchronous Broiler
           read(eventfd) <-----------------------------------------------------------------------o
             |                                                  :
             o-> Emulate-MMIO-Write: Asynchronous Task          :
                   |                                            :
                   o-> broiler_irq_line                         :
                         |                                      :                                      Asynchronous Broiler
           ==============|=================================================================================================
                         V                                      |                                          Asynchronous KVM
                         o-> Inject Interrupt ------------------o
                                                                                                          















                Not First MMIO Write Begin: MOV imm32, EDI
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                                   Guest OS
           =====|==========================================================================================================
                | VM-EXIT: EXIT_REASON_EPT_MISCONFIG                                                        Synchronous KVM
                V
           handle_ept_misconfig
             |
             o-> kvm_mmu_page_fault
                   |
                   o-> handle_mmio_page_fault
                   |     |
                   |     o-> mmio_info_in_cache --> RET_PF_EMULATE
                   |
                   o-> x86_emulate_instruction
                         |
                         o-> x86_decode_insn
                         |
                         o-> x86_emulate_insn
                         |     |
                         |     o-> if: ctxt->execute
                         |     |     |
                         |     |     o-> em_mov
                         |     |
                         |     o-> writeback
                         |     |     |
                         |     |     o-> OP_MEM: segmented_write
                         |     |           |
                         |     |           o-> emulator_write_emulated
                         |     |                 |
                         |     |                 o-> emulator_read_write
                         |     |                       |
                         |     |                       o-> emulator_read_write_onepage
                         |     |                             |
                         |     |                             o-> ops->read_write_mmio: write_mmio
                         |     |                                   |
                         |     |                                   o-> vcpu_mmio_write
                         |     |                                         |
                         |     |                                         o-> kvm_io_bus_write
                         |     |                                               |
                         |     |                                               o-> __kvm_io_bus_write
                         |     |                                                     |
                         |     |                                                     o-> kvm_iodevice_write
                         |     |                                                           |
                         |     |                                                           o-> ioeventfd_write
                         |     |                                                                 |
                         |     o-> writeback_registers                                           |
                         |                                                                       |
                         o-> if: writeback                                                       |
                               |                                                                 |
                               o-> kvm_rip_write                                                 |
                               |                                                                 |
                               o-> vmx_update_emulated_instruction                               |
           for(;;)                                                                               |
             |                                                                                   |
             o-> vcpu_enter_guest                                                                |
                   |                                                                             |
                   | VM-ENTRY                                                                    |          Synchronous KVM
           ========|=======================================================================================================
                   V                                                                             :                 Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                 :
           | | | | | | | | | | | | | | | | | | | | | | | | | | | Memory Space                    :
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                 :
                               |                                                                 :
                               V                                                                 :
             Not First MMIO Write Finish: MOV imm32, EDI                                         :
                                                                                                 :
                                                                A Interrupt                      :                Guest OS
           =====================================================|==========================================================
                                                                :                                |     Asynchronous Broiler
           read(eventfd) <-----------------------------------------------------------------------o
             |                                                  :
             o-> Emulate-MMIO-Write: Asynchronous Task          :
                   |                                            :
                   o-> broiler_irq_line                         :
                         |                                      :                                      Asynchronous Broiler
           ==============|=================================================================================================
                         V                                      |                                          Asynchronous KVM
                         o-> Inject Interrupt ------------------o










                                       MMIO
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+
                             | | | | | | | | | | | | | |
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                  =============================|=================================
                             A              A  |                  Synchronous KVM
                             |              |  |
                             |     VM-ENTRY |  | VM-EXIT
                             |              |  |
                             |              |  |
                             |              |  | Eventfd Notify
                             |              o--V                  Synchronous KVM
                  ===========|=================|=================================
                     Inject  |         eventfd |             Asynchronous Broiler
                   Interrupt |                 |
                             |                 V
                        +---------------------------------+
                        |                                 |
                        |        In-Broiler Device        |
                        |    Handle Asynchronous Task     |
                        +---------------------------------+






                                       MMIO
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+
                             | | | | | | | | | | | | | |
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                  =============================|=================================
                             A              A  |                  Synchronous KVM
                             |              |  |
                             |     VM-ENTRY |  | VM-EXIT
                             |              |  |
                             |              |  |
                             |              |  | Eventfd Notify
                             |              o--V                  Synchronous KVM
                  ===========|=================|=================================
                     Inject  |         eventfd |             Asynchronous Broiler
                   Interrupt |                 |
                             |                 V
                        +---------------------------------+
                        |                                 |
                        |           PCI  Device           |
                        |    Handle Asynchronous Task     |
                        +---------------------------------+










                    PIO Write Begin: IN DX, AX
                                |
                                V
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           | | | | | | | | | | | | | | | | | | | | | | | | | IO Space
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                                 Guest OS
           =====|====================================================================================================
                | VM-EXIT: EXIT_REASON_IO_INSTRUCTION                                                 Synchronous KVM
                V
           handle_io
             |
             o-> kvm_fast_pio
                   |
                   o-> kvm_fast_pio_in
                   |     |
                   |     o-> kvm_fast_pio_out
                   |           |
                   |           o-> kvm_rax_read: <-- RAX/AX
                   |           |
                   |           o-> emulator_pio_out: vcpu->arch.pio_data <-- RAX/AX
                   |                 |
                   |                 o-> emulator_pio_in_out
                   |                       |
                   |                       o-> kernel_pio
                   |                             |
                   |                             o-> kvm_io_bus_write
                   |                                   |
                   |                                   o-> __kvm_io_bus_write
                   |                                         |
                   |                                         o-> kvm_iodevice_write
                   |                                               |
                   |                                               o-> ioeventfd_write
                   |                                                     |
                   o-> kvm_skip_emulated_instruction                     |
                                                                         |
           vcpu_enter_guest                                              |
             |                                                           |
             | VM_ENTRY                                                  |                            Synchronous KVM
           ==|=======================================================================================================
             V                                                           :                                   Guest OS
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+             :
           | | | | | | | | | | | | | | | | | | | | | | | | | IO Space    :
           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+             :
                               |                                         :
                               V                                         :
                   PIO Write Finish: IN DX, AX                           :
                                                                         :
                                                      Interrupt A        :                                   Guest OS
           =====================================================|====================================================
                                                                :        |                       Asynchronous Broiler
           read(eventfd) <-----------------------------------------------o
             |                                                  :
             o-> Emulate-PIO-Write: Asynchronous Task           :
                   |                                            :
                   o-> broiler_irq_line                         :
                         |                                      :                                Asynchronous Broiler
           ==============|===========================================================================================
                         V                                      |                                    Asynchronous KVM
                         o-> Inject Interrupt ------------------o








                                      IO Port
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+
                             | | | | | | | | | | | | | |
                             +-+-+-+-+-+-+-+-+-+-+-+-+-+                 Guest OS
                  =============================|=================================
                             A              A  |                  Synchronous KVM
                             |              |  |
                             |     VM-ENTRY |  | VM-EXIT
                             |              |  |
                             |              |  |
                             |              |  | Eventfd Notify
                             |              o--V                  Synchronous KVM
                  ===========|=================|=================================
                     Inject  |         eventfd |             Asynchronous Broiler
                   Interrupt |                 |
                             |                 V
                        +---------------------------------+
                        |                                 |
                        |           PCI  Device           |
                        |    Handle Asynchronous Task     |
                        +---------------------------------+


INS
ins

                                                   
                                                   
                                                   init_mem_mapping
                                                  probe_page_size_mask 

                                                   
                                                   
                                                   o








                       Compile/Assembly/Link      Load/boot             Running          Stop
                    | <---------------------> | <-----------> | <--------------> | <-------->

                    o-----------------------------------------------------------------------> Permanent Mapping Memory Allocator
                                              o---------------------------------------------> Fixed Mapping Memory Allocator
                                              o--------------->                               Early-IO Memory Allocator
                                              o--------------->                               Early-REVDMEM Memory Allocator
                                              o--------------->                               MEMBLOCK Memory Allocator
                                                              o-----------------------------> Buddy Memory Allocator
                                                                  o-------------------------> SLAB/SLOB/SLUB
                                                                  


                                FIXADDR_TOP                                                 FIXADDR_START
                                |                        FIXADDR_SIZE                       |
                                | <-------------------------------------------------------> |
                                V                                                           V                      0
                        +-------+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+----------------------+
                        |       |     |     |     |     |     |     |     |     |     |     |                      |
                        |  ...  |     |     |     |     |     |     |     |     |     |     |        ......        | Virtual Address Space
                        |       |     |     |     |     |     |     |     |     |     |     |                      |
                        +-------+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+----------------------+
                                      A     A     A     A                                   A
                                      |     |     |     |                                   |
                                      |     | o---o     |                                   |
                                      |     | | o-------o                             o-----o
                                      |     | | |                                     |  
                                     +-+---+-+-+-+-+-+-+-------+-+-+-------+-+-+-+-+-+-+
                                     | |   | | | | | | |       | | |       | | | | | | |
                                     | | . | | | | | | |  ...  | | |  ...  | | | | | | | Permanent Mapping Aear
                                     | |   | | | | | | |       | | |       | | | | | | |
                                     +-+---+-+-+-+-+-+-+-------+-+-+-------+-+-+-+-+-+-+
                                      A     A A A A A A         A A         A A A A A A
                                      |     | | | | | |         | |         | | | | | |
                                      |     | | | | | |         | |         | | | | | o--------- __end_of_permanent_fixed_addresses,
                                      |     | | | | | |         | |         | | | | o----------- FIX_APEI_GHES_NMI
                                      |     | | | | | |         | |         | | | o------------- FIX_APEI_GHES_IRQ
                                      |     | | | | | |         | |         | | o--------------- FIX_PARAVIRT_BOOTMAP
                                      |     | | | | | |         | |         | o----------------- FIX_PCIE_MCFG
                                      |     | | | | | |         | |         o------------------- FIX_KMAP_END
                                      |     | | | | | |         | |                              A
                                      |     | | | | | |         | |                              |
                                      |     | | | | | |         | |                              | KM_MAX_IDX * NR_CPUS
                                      |     | | | | | |         | |                              |
                                      |     | | | | | |         | |                              V
                                      |     | | | | | |         | o----------------------------- FIX_KMAP_BEGIN 
                                      |     | | | | | |         o------------------------------- FIX_IO_APIC_BASE_END
                                      |     | | | | | |                                          A
                                      |     | | | | | |                                          |
                                      |     | | | | | |                                          | MAX_IO_APICS
                                      |     | | | | | |                                          |
                                      |     | | | | | |                                          V
                                      |     | | | | | o----------------------------------------- FIX_IO_APIC_BASE_0
                                      |     | | | | o------------------------------------------- FIX_APIC_BASE
                                      |     | | | o--------------------------------------------- FIX_OHCI1394_BASE
                                      |     | | o----------------------------------------------- FIX_EARLYCON_MEM_BASE
                                      |     | o------------------------------------------------- FIX_DBGP_BASE
                                      |     o--------------------------------------------------- VSYSCALL_PAGE
                                      |                                                          A    
                                      |                                                          | 
                                      |                                                          V
                                      o--------------------------------------------------------- FIX_HOLE







                                FIXADDR_TOP                                                 FIXADDR_START
                                |                        FIXADDR_SIZE                       |
                                | <-------------------------------------------------------> |
                                V                                                           V                      0
                        +-------+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+----------------------+
                        |       |     |     |     |     |     |     |     |     |     |     |                      |
                        |  ...  |     |     |     |     |     |     |     |     |     |     |        ......        | Virtual Address Space
                        |       |     |     |     |     |     |     |     |     |     |     |                      |
                        +-------+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+----------------------+
                                         








                                    Permanent Virtual Address

                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |  +--------------+
                                              |                      |                      |                      |  +--------------+     |  |              |
                                              |                      |                      |                      |  |              |     |  +--------------+
                                              |                      |                      |                      |  +--------------+     o->|              |
                                              |                      |                      |                      |  |              |        +--------------+
                                              |                      |                      |                      |  +--------------+        |              |
                                              |                      |                      |  +--------------+    o->|   Physical   | -----> +--------------+
                                              |                      |                      |  |              |       +--------------+         MMIO/Memory
                                              |                      |                      |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |  +--------------+    o->|   Physcial   | ----> +--------------+
                                              |  |              |       +--------------+
                                              |  +--------------+       |              |
                                              o->|   Physcial   | ----> +--------------+
                                                 +--------------+
                                                 |              |
                                CR3              +--------------+
                                +----------+     |              |
                                | Physical | --> +--------------+
                                +----------+




                               set_fixmap_offset
                                 |
                                 o-> __set_fixmap_offset: FIXMAP_PAGE_NORMAL
                                       |
                                       o-> __set_fixmap
                                       |     |
                                       |     o-> native_set_fixmap
                                       |           |
                                       |           o-> __native_set_fixmap
                                       |                 |
                                       |                 o-> __fix_to_virt
                                       |                 |
                                       |                 o-> set_pte_vaddr
                                       |                       |
                                       |                       o-> pgd_offset_k
                                       |                       |
                                       |                       o-> p4d_offset
                                       |                       |
                                       |                       o-> set_pte_vaddr_p4d
                                       |                             |
                                       |                             o-> fill_pud
                                       |                             |
                                       |                             o-> __set_pte_vaddr
                                       |                                   |
                                       |                                   o-> fill_pmd
                                       |                                   |
                                       |                                   o-> fill_pte
                                       |                                   |
                                       |                                   o-> set_pte: PTE/NEW-PTE
                                       |                                   |
                                       |                                   o-> flush_tlb_one_kernel
                                       |
                                       o-> fix_to_virt


                        startup_64
                          |
                          o-> __startup_64
                                |
                                o->secondary_startup_64
                                     |
                                     o-> initial_code(%rip)
                                           |
                                           o->x86_64_start_kernel
                                                |
                                                o-> init_top_pgt[511] = early_top_pgt[511]
                                                |
                                                o-> x86_64_start_reservations 
                                                      |
                                                      o-> start_kernel



                        startup_64
                          |
                          o-> __startup_64
                                |
                                o->secondary_startup_64
                                     |
                                     o-> initial_code(%rip)
                                           |
                                           o->x86_64_start_kernel
                                                |
                                                o-> reset_early_page_tables
                                                      |
                                                      o-> write_cr3: early_top_pgt /* Kill off the identity-map trampoline */
                       

early_idt_handler_array
early_idt_handler_common
do_early_exception


kernel/head_64.S

       _




                                    Early Identity-Mapping Stage: Permanent Mapping PageTable

                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                                           
                                              |                      |                      |                                           
                                              |                      |                      |                         level1_fixmap_pgt 
                                              |                      |                      |                         +--------------+  
                                              |                      |                      |                         |              |  
                                              |                      |                      |                         +--------------+  
                                              |                      |                      |                         |              |  
                                              |                      |                      |  level2_fixmap_pgt      +--------------+  
                                              |                      |                      |  +--------------+       |   Physical   | 
                                              |                      |                      |  |              |       +--------------+ 
                                              |                      |  level3_kernel_pgt   |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |  early_top_pgt       |  +--------------+       |              |
                                              |  +--------------+    |  |              |   o-> +--------------+
                                              |  |              |    |  +--------------+   |
                                              |  +--------------+    o->|   Physical   | --o
                                              |  |              |   o-> +--------------+
                                              |  +--------------+   |
                                              |  |              |   |
                                CR3           |  +--------------+   |
                                +----------+  o->|   Physical   | --o
                                | Physical | --> +--------------+
                                +----------+     




                                    Full-Boot Stage: Permanent Mapping PageTable

                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |
                                              |                      |                      |
                                              |                      |                      |                         level1_fixmap_pgt
                                              |                      |                      |                         +--------------+
                                              |                      |                      |                         |              |
                                              |                      |                      |                         +--------------+
                                              |                      |                      |                         |              |
                                              |                      |                      |  level2_fixmap_pgt      +--------------+
                                              |                      |                      |  +--------------+       |   Physical   |
                                              |                      |                      |  |              |       +--------------+
                                              |                      |  level3_kernel_pgt   |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |  init_top_pgt        |  +--------------+       |              |
                                              |  +--------------+    |  |              |   o-> +--------------+
                                              |  |              |    |  +--------------+   |
                                              |  +--------------+    o->|   Physical   | --o
                                              |  |              |   o-> +--------------+
                                              |  +--------------+   |
                                              |  |              |   |
                                CR3           |  +--------------+   |
                                +----------+  o->|   Physical   | --o
                                | Physical | --> +--------------+
                                +----------+     #define swapper_pg_dir init_top_pgt









                                    Full-Boot Stage: Permanent Mapping PageTable

                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |
                                              |                      |                      |                      |
                                              |                      |                      |                      |  level1_fixmap_pgt
                                              |                      |                      |                      |  +--------------+
                                              |                      |                      |                      |  |              |
                                              |                      |                      |                      |  +--------------+
                                              |                      |                      |                      |  |              |     +----------------------+
                                              |                      |                      |  level2_fixmap_pgt   |  +--------------+     |                      |
                                              |                      |                      |  +--------------+    o->|   Physical   | --> | Physical Memory/MMIO |
                                              |                      |                      |  |              |       +--------------+     |                      |
                                              |                      |  level3_kernel_pgt   |  +--------------+       |              |     +----------------------+
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |  init_top_pgt        |  +--------------+       |              |
                                              |  +--------------+    |  |              |   o-> +--------------+
                                              |  |              |    |  +--------------+   |
                                              |  +--------------+    o->|   Physical   | --o
                                              |  |              |   o-> +--------------+
                                              |  +--------------+   |
                                              |  |              |   |
                                CR3           |  +--------------+   |
                                +----------+  o->|   Physical   | --o
                                | Physical | --> +--------------+
                                +----------+     #define swapper_pg_dir init_top_pgt





                                    Full-Boot Stage: Permanent Mapping PageTable

                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |
                                              |                      |                      |                      |
                                              |                      |                      |                      |  level1_fixmap_pgt
                                              |                      |                      |                      |  +--------------+
                                              |                      |                      |                      |  |              |
                                              |                      |                      |                      |  +--------------+
                                              |                      |                      |                      |  |              |
                                              |                      |                      |  level2_fixmap_pgt   |  +--------------+
                                              |                      |                      |  +--------------+    o->|       0      |
                                              |                      |                      |  |              |       +--------------+
                                              |                      |  level3_kernel_pgt   |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |  init_top_pgt        |  +--------------+       |              |
                                              |  +--------------+    |  |              |   o-> +--------------+
                                              |  |              |    |  +--------------+   |
                                              |  +--------------+    o->|   Physical   | --o
                                              |  |              |   o-> +--------------+
                                              |  +--------------+   |
                                              |  |              |   |
                                CR3           |  +--------------+   |
                                +----------+  o->|   Physical   | --o
                                | Physical | --> +--------------+
                                +----------+     #define swapper_pg_dir init_top_pgt



                               clear_fixmap:
                                 |
                                 o-> __set_fixmap_offset: FIXMAP_PAGE_CLEAR
                                       |
                                       o-> __set_fixmap
                                             |
                                             o-> native_set_fixmap
                                                   |
                                                   o-> __native_set_fixmap
                                                         |
                                                         o-> __fix_to_virt
                                                         |
                                                         o-> set_pte_vaddr
                                                               |
                                                               o-> pgd_offset_k
                                                               |
                                                               o-> p4d_offset
                                                               |
                                                               o-> set_pte_vaddr_p4d
                                                                     |
                                                                     o-> __set_pte_vaddr
                                                                           |
                                                                           o-> set_pte: PTE/0
                                                                           |
                                                                           o-> flush_tlb_one_kernel
                                        

                                    Early IO/RSVD-MEM Memory Allocator                                       

                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |  +--------------+
                                              |                      |                      |                      |  +--------------+     |  |              |
                                              |                      |                      |                      |  |              |     |  +--------------+
                                              |                      |                      |                      |  +--------------+     o->|              |
                                              |                      |                      |                      |  |              |        +--------------+
                                              |                      |                      |                      |  +--------------+        |              |
                                              |                      |                      |  +--------------+    o->|   Physical   | -----> +--------------+
                                              |                      |                      |  |              |       +--------------+         MMIO/RSVD-Memory
                                              |                      |                      |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |  +--------------+    o->|   Physcial   | ----> +--------------+
                                              |  |              |       +--------------+
                                              |  +--------------+       |              |
                                              o->|   Physcial   | ----> +--------------+
                                                 +--------------+
                                                 |              |
                                CR3              +--------------+
                                +----------+     |              |
                                | Physical | --> +--------------+
                                +----------+





                                fix_to_virt(FIX_BTMAP_END)                                  fix_to_virt(FIX_BTMAP_BEGIN)
                                |                                                           |
                                | <-------------------------------------------------------> |
                                V                                                           V                      0
                        +-------+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+----------------------+
                        |       |     |     |     |     |     |     |     |     |     |     |                      |
                        |  ...  |     |     |     |     |     |     |     |     |     |     |        ......        | Virtual Address Space
                        |       |     |     |     |     |     |     |     |     |     |     |                      |
                        +-------+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+----------------------+
                                                              A     A     A     A     A     A
                                                              |     |     |     |     |     |
                                                              |     |     |     |     o---o |
                                                              |     |     |     o-------o | |
                                                              |     |     o-----------o | | |
                                                              |     o---------------o | | | |
                                                              o-------------------o | | | | |
                                                                                  | | | | | |
                                                                                  | | | | | |
                         +-+---+-+-+---+-+-+---+-+-+---+-+-+---+-+-+-+-+-+-+-----+-+-+-+-+-+-+
                         | |   | | |   | | |   | | |   | | |   | | | | | | |     | | | | | | |
                         | | . | | | . | | | . | | | . | | | . | | | | | | | ... | | | | | | | Early IO/RSVD-MEM Mapping Area
                         | |   | | |   | | |   | | |   | | |   | | | | | | |     | | | | | | |
                         +-+---+-+-+---+-+-+---+-+-+---+-+-+---+-+-+-+-+-+-+-----+-+-+-+-+-+-+
                         | <---> | <---> | <---> | ..... | <---> | <------- Slot0 ---------> | 
                           Slot7   Slot6   Slot5           Slot1  A A A A A       A A A A A A 
                                                                  | | | | |       | | | | | |
                                                                  | | | | |       | | | | | |
                                                                  | | | | |       | | | | | o---- Mapped 1st MMIO/Page  ---
                                                                  | | | | |       | | | | o------ Mapped 2nd MMIO/Page   A
                                                                  | | | | |       | | | o-------- Mapped 3rd MMIO/Page   |
                                                                  | | | | |       | | o---------- Mapped 4th MMIO/Page   |
                                                                  | | | | |       | o------------ Mapped 5th MMIO/Page   |
                                                                  | | | | |       o-------------- Mapped 6th MMIO/Page   |
                                                                  | | | | |                       A                      |
                                                                  | | | | |                       | Mapped X MMIO/Page   | NR_FIX_BTMAPS
                                                                  | | | | |                       V                      |
                                                                  | | | | o---------------------- Mapped 59th MMIO/Page  |
                                                                  | | | o------------------------ Mapped 60th MMIO/Page  |
                                                                  | | o-------------------------- Mapped 61th MMIO/Page  |
                                                                  | o---------------------------- Mapped 62th MMIO/Page  V
                                                                  o------------------------------ Mapped 63th MMIO/Page ---





                 start_kernel
                   |
                   o-> setup_arch
                         |
                         o-> early_ioremap_init
                               |
                               o-> early_ioremap_setup
                               |
                               o-> early_ioremap_pmd
                               |
                               o-> pmd_populate_kernel
                               




                                    Before Initialize: Early IO/RSVD-MEM Mapping PageTable

                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                     
                                              |                      |                      |                     
                                              |                      |                      |                     
                                              |                      |                      |                     
                                              |                      |                      |                     
                                              |                      |                      |                     
                                              |                      |                      |                     
                                              |                      |                      |  level2_fixmap_pgt  
                                              |                      |                      |  +--------------+   
                                              |                      |                      |  |              |   
                                              |                      |  level3_kernel_pgt   |  +--------------+   
                                              |                      |  +--------------+    o->|       0      |
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |  init_top_pgt        |  +--------------+       |              |
                                              |  +--------------+    |  |              |   o-> +--------------+
                                              |  |              |    |  +--------------+   |
                                              |  +--------------+    o->|   Physical   | --o
                                              |  |              |   o-> +--------------+
                                              |  +--------------+   |
                                              |  |              |   |
                                CR3           |  +--------------+   |
                                +----------+  o->|   Physical   | --o
                                | Physical | --> +--------------+
                                +----------+     #define swapper_pg_dir init_top_pgt






                                    After Initialize: Early IO/RSVD-MEM Mapping PageTable

                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |
                                              |                      |                      |                      |
                                              |                      |                      |                      |  bm_pte
                                              |                      |                      |                      |  +--------------+
                                              |                      |                      |                      |  |              |
                                              |                      |                      |                      |  +--------------+
                                              |                      |                      |                      |  |              |
                                              |                      |                      |  level2_fixmap_pgt   |  +--------------+
                                              |                      |                      |  +--------------+    o->|       0      |
                                              |                      |                      |  |              |       +--------------+
                                              |                      |  level3_kernel_pgt   |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |  init_top_pgt        |  +--------------+       |              |
                                              |  +--------------+    |  |              |   o-> +--------------+
                                              |  |              |    |  +--------------+   |
                                              |  +--------------+    o->|   Physical   | --o
                                              |  |              |   o-> +--------------+
                                              |  +--------------+   |
                                              |  |              |   |
                                CR3           |  +--------------+   |
                                +----------+  o->|   Physical   | --o
                                | Physical | --> +--------------+
                                +----------+     #define swapper_pg_dir init_top_pgt








                                  Early IO/RSVD-MEM Memory Allocator


                                  prev_map[]                     prev_virt[]                    slot_size[]
                                  +------------+                 +------------+                 +------------+
                                  |            |                 |            |                 |            |
                                  +------------+                 +------------+                 +------------+
                                  |            |                 |            |                 |            |
                                  +------------+                 +------------+                 +------------+
                                  |            |                 |            |                 |            |
                                  +------------+                 +------------+                 +------------+
                                  |            |                 |            |                 |            |
                                  +------------+ <-------------> +------------+ <-------------> +------------+
                                  |            |                 |            |                 |            |
                                  +------------+                 +------------+                 +------------+
                                  |            |                 |            |                 |            |
                                  +------------+                 +------------+                 +------------+
                                  |            |                 |            |                 |            |
                                  +------------+                 +------------+                 +------------+
                                  |            |                 |            |                 |            |
                                  +------------+                 +------------+                 +------------+





                              /* Remap an IO device */
                              void __init __iomem * early_ioremap(resource_size_t phys_addr, unsigned long size)
                            
                              /* Remap memory */
                              void __init * early_memremap(resource_size_t phys_addr, unsigned long size)
                            
                              /* Remap RO memory */
                              void __init * early_memremap_ro(resource_size_t phys_addr, unsigned long size)
                            
                              /* Remap memory with prot attribute */
                              void __init * early_memremap_prot(resource_size_t phys_addr,
                                                                   unsigned long size, unsigned long prot_val)
                            
                              /* Build temp mapping and copy data */
                              void __init copy_from_early_mem(void *dest, phys_addr_t src, unsigned long size)










                            __early_ioremap
                              |
                              o-> prev_map[idx]: Available member for prev_map[]
                              |
                              o-> prev_size[idx]: Store Mapping Size
                              |
                              o-> offset_in_page
                              |
                              o-> while: npages
                              |     |
                              |     o-> __early_set_fixmap
                              |           |
                              |           o-> early_ioremap_pte
                              |           |     |
                              |           |     o-> bm_pte[pte_index(addr)]
                              |           |
                              |           o-> set_pte
                              |           |
                              |           o-> flush_tlb_one_kernel
                              |
                              o-> prev_map[idx]: Store Virtual Address





                                    Early IO/RSVD-MEM Mapping PageTable

                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |
                                              |                      |                      |                      |                         +-----------------+
                                              |                      |                      |                      |  bm_pte                 |                 |
                                              |                      |                      |                      |  +--------------+       |                 |
                                              |                      |                      |                      |  |              |       |  MMIO/RSVD-MEM  |
                                              |                      |                      |                      |  +--------------+       |                 |
                                              |                      |                      |                      |  |              |       |                 |
                                              |                      |                      |  level2_fixmap_pgt   |  +--------------+       |                 |
                                              |                      |                      |  +--------------+    o->|   Physical   | ----> +-----------------+
                                              |                      |                      |  |              |       +--------------+
                                              |                      |  level3_kernel_pgt   |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |  init_top_pgt        |  +--------------+       |              |
                                              |  +--------------+    |  |              |   o-> +--------------+
                                              |  |              |    |  +--------------+   |
                                              |  +--------------+    o->|   Physical   | --o
                                              |  |              |   o-> +--------------+
                                              |  +--------------+   |
                                              |  |              |   |
                                CR3           |  +--------------+   |
                                +----------+  o->|   Physical   | --o
                                | Physical | --> +--------------+
                                +----------+     #define swapper_pg_dir init_top_pgt









                            early_memunmap
                              |
                              o-> early_iounmap
                                    |
                                    o-> prev_map[idx]: Find index with Vadr
                                    |
                                    o-> npages: Caculate total pages need relase
                                    |
                                    o-> while: npages
                                    |     |
                                    |     o-> __early_set_fixmap
                                    |          |
                                    |          o-> early_ioremap_pte
                                    |          |     |
                                    |          |     o-> bm_pte[pte_index(addr)]
                                    |          |
                                    |          o-> pte_clear
                                    |          |
                                    |          o-> flush_tlb_one_kernel
                                    |
                                    o-> prev_map[slot] = NULL: Mark Slot as free







https://developer.aliyun.com/mirror/?spm=a2c6h.25603864.0.0.59b75a23sgT9y3

http://t.zoukankan.com/dream397-p-13558436.html
![DMAR](https://zhuanlan.zhihu.com/p/492749752?utm_medium=social&utm_oi=50718148919296)



     start_kernel
       |
       o-> mm_init
             |
             o-> mem_init 
                   |
                   o-> pci_iommu_alloc
                         |
                         o-> detect_intel_iommu                              
                               |
                               o-> dmar_validate_one_drhd
                                     |
                                     o-> early_ioremap
                              
                              
                              



         setup_early_printk
           |
           o-> buf: "xdbc"
                 |
                 o-> early_xdbc_parse_parameter             
                       |
                       o-> xdbc_map_pci_mmio
                             |
                             o-> early_ioremap                              
                              



               start_kernel                    
                 |
                 o-> setup_arch                  
                       |
                       o-> early_quirks
                             |
                             o-> early_pci_scan_bus
                                   |
                                   o-> check_dev_quirk
                                         |
                                         o-> early_qrk
                                               |
                                               o-> apple_airport_reset
                                                     |
                                                     o-> early_ioremap









                start_kernel
                  |
                  o-> setup_arch
                        |
                        o-> vsmp_init
                              |
                              o-> vsmp_cap_cpus
                                    |
                                    o-> early_ioremap






native_smp_prepare_cpus
uv_system_init
apic_x2apic_uv_x
uv_acpi_madt_oem_check
uv_set_system_type
early_get_pnodeid
uv_early_read_mmr














early_pci_serial_init




                 start_kernel
                   |
                   o-> setup_arch
                   |     |
                   |     o-> early_ioremap_init
                   |           |
                   |           o-> early_ioremap_setup
                   |           |
                   |           o-> early_ioremap_pmd
                   |           |
                   |           o-> pmd_populate_kernel
                   |
                   |==> Early IO/RSVD-MEM Using
                   |
                   o-> arch_call_rest_init
                         |
                         o-> rest_init
                               |
                               o-> kernel_init
                               |     |
                               |     o-> kernel_init_freeable
                               |     |     |
                               |     |     o-> do_basic_setup
                               |     |           |
                               |     |           o-> do_initcalls
                               |     |                 |
                               |     |                 o-> late_initcall: check_early_ioremap_leak
                               |     |
                               |     o-> free_initmem
                               |
                               o-> system_state = SYSTEM_RUNNING






arch_call_rest_init
rest_init
kernel_init
kernel_init_freeable
do_basic_setup
do_initcalls
                                                  



                                                 struct memblock_region
                       struct memblock_type      memblock_memory_init_regions[INIT_MEMBLOCK_MEMORY_REGIONS]
                               +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                               |          |      |     |     |     |     |     |     |     |      |    |     |
                         o---> |  memory  |----> | R00 | R01 | R02 | R03 | R04 | R05 | R06 |  R07 |... | RXY | 
       struct memblock   |     |          |      |     |     |     |     |     |     |     |      |    |     |
       +------------+    |     +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
       |            |----o
       |  memblock  |
       |            |----o
       +------------+    |     +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                         |     |          |      |     |     |     |     |     |     |     |      |    |     |
                         o---> | reserved |----> | R00 | R01 | R02 | R03 | R04 | R05 | R06 |  R07 |... | RXY | 
                               |          |      |     |     |     |     |     |     |     |      |    |     |
                               +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                       struct memblock_type      memblock_reserved_init_regions[INIT_MEMBLOCK_RESERVED_REGIONS]
                                                 struct memblock_region




struct memblock_region {
        phys_addr_t base;
        phys_addr_t size;
        enum memblock_flags flags;
#ifdef CONFIG_NUMA
        int nid;
#endif
};

struct memblock_type {
        unsigned long cnt;
        unsigned long max;
        phys_addr_t total_size;
        struct memblock_region *regions;
        char *name;
};

struct memblock {
        bool bottom_up;  /* is bottom up direction? */
        phys_addr_t current_limit;
        struct memblock_type memory;
        struct memblock_type reserved;
};



#define __meminit        __section(".meminit.text") __cold notrace \
                                                  __latent_entropy
#define __meminitdata    __section(".meminit.data")
#define __meminitconst   __section(".meminit.rodata")
#define __memexit        __section(".memexit.text") __exitused __cold notrace
#define __memexitdata    __section(".memexit.data")
#define __memexitconst   __section(".memexit.rodata")


#ifndef CONFIG_ARCH_KEEP_MEMBLOCK
#define __init_memblock __meminit
#define __initdata_memblock __meminitdata
#else
#define __init_memblock
#define __initdata_memblock
#endif




reserve_brk
  |
  o-> memblock_reserve: [_brk_start, _brk_end]

early_reserve_initrd
  |
  o-> memblock_reserve: [ramdisk_image, ramdisk_end]

memblock_x86_reserve_range_setup_data
  |
  o-> memblock_reserve: [boot_params.hdr.setup_data, len]


                 start_kernel
                   |
                   o-> setup_arch
                         |
                         o-> early_reserve_memory
                         |     |
                         |     o-> memblock_reserve: [_text, __end_of_kernel_reserve]
                         |     |
                         |     o-> memblock_reserve: [0, SZ_64K]
                         |     |
                         |     o-> early_reserve_initrd
                         |     |     |
                         |     |     o-> memblock_reserve: [ramdisk_image, ramdisk_end]
                         |     |
                         |     o-> memblock_x86_reserve_range_setup_data
                         |     |     |
                         |     |     o-> memblock_reserve: [boot_params.hdr.setup_data, len]
                         |     |
                         |     o-> reserve_ibft_region
                         |     |     |
                         |     |     o-> memblock_reserve: [ibft_phys_addr, len]
                         |     |
                         |     o-> reserve_bios_regions
                         |     |     |
                         |     |     o-> memblock_reserve: [bios_start, 0x100000 - bios_start]
                         |     |
                         |     o-> trim_snb_memory
                         |           |
                         |           o-> memblock_reserve: [bad_pages[i], PAGE_SIZE]
                         |     
                         o-> reserve_brk     
                         |     |
                         |     o-> memblock_reserve: [_brk_start, _brk_end]
                         |     
                         o-> e820__memblock_setup
                         |     |
                         |     o-> memblock_allow_resize
                         |     |
                         |     o-> memblock_reserve: E820_TYPE_SOFT_RESERVED
                         |     |
                         |     o-> memblock_add: E820_TYPE_RAM/E820_TYPE_RESERVED_KERN     
                         |     
                         o-> memblock_set_current_limit: get_max_mapped()
                                            







             MEMBLOCK Allocator Layout

             Bottom                                                                                           UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |
             |      |      | R |        | R |         | R |      | R |    | R |            |                  |
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
                        A    A      A     A      A      A          A    A   A        A
                        |    |      |     |      |      |          |    |   |        |
                        |    |      |     |      |      |          |    |   |        o-- FreeArea[0]
                        |    |      |     |      |      |          |    |   o----------- reserved.regions[0]
                        |    |      |     |      |      |          |    o--------------- FreeArea[1]
                        |    |      |     |      |      |          o-------------------- reserved.regions[1]
                        |    |      |     |      |      o------------------------------- reserved.regions[2]
                        |    |      |     |      o-------------------------------------- FreeArea[2]
                        |    |      |     o--------------------------------------------- reserved.regions[3]
                        |    |      o--------------------------------------------------- FreeArea[3]
                        |    o---------------------------------------------------------- reserved.regions[4]
                        o--------------------------------------------------------------- FreeArea[4]






            MEMBLOCK Allocator Layout

                    | <------------------------ Allocatable Area ------------------------> |
                    +------+   +--------+   +---------+              +----+   +------------+  
                    |      |   |        |   |         |              |    |   |            |
                    |      |   |        |   |         |              |    |   |            |
                    |      |   |        |   |         |              |    |   |            |
                    +------+   +--------+   +---------+              +----+   +------------+  
                                                        A
                                                        |
             Bottom                                     |                                                     UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |      
             |      |      | R |        | R |         | R |      | R |    | R |            |                  |      
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |      
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
                                                        |
                                                        |
                                                        V
                           +---+        +---+         +---+      +---+    +---+
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           +---+        +---+         +---+      +---+    +---+
                           | <--------------- Allocated Area ---------------> |







                       memblock_alloc
                         |
                         o-> memblock_alloc_try_nid
                               |
                               o-> memblock_alloc_internal
                               |     |
                               |     o-> memblock_alloc_range_nid
                               |     |     |
                               |     |     o-> memblock_find_in_range_node
                               |     |     |     |
                               |     |     |     o-> __memblock_find_range_top_down/__memblock_find_range_bottom_up
                               |     |     |           |
                               |     |     |           o-> for_each_free_mem_range/for_each_free_mem_range_reverse
                               |     |     |
                               |     |     o-> memblock_reserve
                               |     |     
                               |     o-> phys_to_virt     
                               |           
                               o-> memset: 0



             MEMBLOCK Allocator Layout

             Bottom                                                                                            UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                   |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+-------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                   |
             |      |      | R |        | R |         | R |      | R |    | R |            |                   |
             |      |      |   |        |   |         |   |      |   |    |   |            |                   |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+-------------------+
             | <-------------- NUMA NODE 0 -------------> | <-------- NUMA NODE 1 -------> | <- NUMA NODE 2 -> |

           
                                           
                                           



  
             MEMBLOCK Allocator Layout


             Bottom to UP
             ----------------------->

             Bottom                                                                                            UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                   |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+-------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                   |
             |      |      | R |        | R |         | R |      | R |    | R |            |                   |
             |      |      |   |        |   |         |   |      |   |    |   |            |                   |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+-------------------+


                                                                                                   UP to Bottom
                                                                                         <---------------------

             Bottom                                                                                            UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                   |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+-------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                   |
             |      |      | R |        | R |         | R |      | R |    | R |            |                   |
             |      |      |   |        |   |         |   |      |   |    |   |            |                   |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+-------------------+





             MEMBLOCK Allocator Layout

             Bottom                                                                                            UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                   |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+-------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                   |
             |      |      | R |        | R |         | R |      | R |    | R |            |                   |
             |      |      |   |        |   |         |   |      |   |    |   |            |                   |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+-------------------+
                                        | <----- Speical Area -----> |









                 X86 Architecture Virtual Memory

                 0                                                         PAGE_OFFSET: 0xffff888000000000      MAX
                 |                                                         |                                    |
                 | <------------ Userspace ------------> |                 | <--------- Kernel Space ---------> |
                 +---------------------------------------+-----------------+------------------------------------+
                 |                                       |                 |                                    |
                 |                                       |                 |                                    |
                 |                                       |                 |                                    |
                 +---------------------------------------+-----------------+-------------------------------+----+
                                                                           | <------ Linear Mapping -----> |
                                                                           |                               |
                                                                           |                               |
                                                                           V                               V 
                                                                           +-------------------------------+
                                                                           |                               |                          
                                                                           |                               |                          
                                                                           |                               |                          
                                                                           +-------------------------------+
                                                                           |                               |
                                                                           0                               (max_pfn << PAGE_SHIFT)
                                                                           
                                                                           Physical Memory









                                    Kernel Space Linear Mapping PageTable

                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |
                                              |                      |                      |                      |                         +-----------------+
                                              |                      |                      |                      |                         |                 |
                                              |                      |                      |                      |                         |                 |
                                              |                      |                      |                      |  +--------------+       |       4KiB      |
                                              |                      |                      |                      |  |              |       | Physical Memory |
                                              |                      |                      |                      |  +--------------+       |                 |
                                              |                      |                      |                      |  |              |       |                 |
                                              |                      |                      |                      |  +--------------+       |                 |
                                              |                      |                      |  +--------------+    o->|   Physical   | ----> +-----------------+
                                              |                      |                      |  |              |       +--------------+
                                              |                      |  level3_kernel_pgt   |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |  init_top_pgt        |  +--------------+       |              |
                                              |  +--------------+    |  |              |   o-> +--------------+
                                              |  |              |    |  +--------------+   |
                                              |  +--------------+    o->|   Physical   | --o
                                              |  |              |   o-> +--------------+
                                              |  +--------------+   |
                                              |  |              |   |
                                CR3           |  +--------------+   |
                                +----------+  o->|   Physical   | --o
                                | Physical | --> +--------------+
                                +----------+     #define swapper_pg_dir init_top_pgt


				    PTE Entry
                                  
                                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                                    



                                    X86 Architecture PTE Entry

                                       62   59 58         52 51         M                         12 11  9 8 7 6 5 4 3 2 1 0
                                    +-+-------+-------------+------------+--------------------------+-----+-+-+-+-+-+-+-+-+-+
                                    |X|       |             |            |                          |     | |P| | |P|P|U|R| |
                                    | | Prote |   Ignored   |  Reserved  | Physical Address of 4KiB | Ign |G|A|D|A|C|W|/|/|P|
                                    |D|       |             |            |                          |     | |T| | |D|T|S|W| |
                                    +-+-------+-------------+------------+--------------------------+-----+-+-+-+-+-+-+-+-+-+
                                     A                                                A                    A A A A A A A A A
                                     |                                                |                    | | | | | | | | |
                                     |                                                |                    | | | | | | | | o-- Present: 1
                                     |                                                |                    | | | | | | | o---- Read/Write: 1 
                                     |                                                |                    | | | | | | o------ User/Superviosr: 0
                                     |                                                |                    | | | | | o-------- Page-level Write-Through: None
                                     |                                                |                    | | | | o---------- Page-level cache Disable: None
                                     |                                                |                    | | | o------------ Accessed: 1
                                     |                                                |                    | | o-------------- Dirty: 1
                                     |                                                |                    | o---------------- Memory type: None
                                     |                                                |                    o------------------ Global: 1
                                     |                                                |                    
                                     |                                                o--------------------------------------- Physical Address Offset
                                     |                                               
                                     o---------------------------------------------------------------------------------------- Execute-Disable: 1



                               

                                    Kernel Space Linear Mapping PageTable

                                    +----------------------+----------------------+----------------------+---------------------------------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |                 PAGE_OFFSET                 |
                                    +----------------------+----------------------+----------------------+---------------------------------------------+
                                              |                      |                      |                           
                                              |                      |                      |                           
                                              |                      |                      |                           
                                              |                      |                      |                            +-----------------+
                                              |                      |                      |                            |                 |
                                              |                      |                      |                            |                 |
                                              |                      |                      |                            |       2MiB      |
                                              |                      |                      |                            | Physical Memory |
                                              |                      |                      |  +--------------+          |                 |
                                              |                      |                      |  |              |          |                 |
                                              |                      |  level3_kernel_pgt   |  +--------------+          |                 |
                                              |                      |  +--------------+    o->|   Physical   | -------> +-----------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |  init_top_pgt        |  +--------------+       |              |
                                              |  +--------------+    |  |              |   o-> +--------------+
                                              |  |              |    |  +--------------+   |
                                              |  +--------------+    o->|   Physical   | --o
                                              |  |              |   o-> +--------------+
                                              |  +--------------+   |
                                              |  |              |   |
                                CR3           |  +--------------+   |
                                +----------+  o->|   Physical   | --o
                                | Physical | --> +--------------+
                                +----------+     #define swapper_pg_dir init_top_pgt






                                    X86 Architecture PMD Entry
      
                                       62   59 58         52 51         M                         21 20  13   11  9 8 7 6 5 4 3 2 1 0
                                    +-+-------+-------------+------------+--------------------------+------+-+-----+-+-+-+-+-+-+-+-+-+
                                    |X|       |             |            |                          |      |P|     | |P| | |P|P|U|R| |
                                    | | Prote |   Ignored   |  Reserved  | Physical Address of 2MiB | RSVD |A| Ign |G| |D|A|C|W|/|/|P|
                                    |D|       |             |            |                          |      |T|     | |S| | |D|T|S|W| |
                                    +-+-------+-------------+------------+--------------------------+------+-+-----+-+-+-+-+-+-+-+-+-+
                                     A                                                A                     A       A A A A A A A A A
                                     |                                                |                     |       | | | | | | | | |
                                     |                                                |                     |       | | | | | | | | o-- Present: 1
                                     |                                                |                     |       | | | | | | | o---- Read/Write: 1
                                     |                                                |                     |       | | | | | | o------ User/Superviosr: 0
                                     |                                                |                     |       | | | | | o-------- Page-level Write-Through: None
                                     |                                                |                     |       | | | | o---------- Page-level cache Disable: None
                                     |                                                |                     |       | | | o------------ Accessed: 1
                                     |                                                |                     |       | | o-------------- Dirty: 1
                                     |                                                |                     |       | o---------------- Page Size: 1
                                     |                                                |                     |       o------------------ Global: 1
                                     |                                                |                     o-------------------------- Memory Type: None
                                     |                                                |
                                     |                                                o------------------------------------------------ Physical Address Offset
                                     |
                                     o------------------------------------------------------------------------------------------------- Execute-Disable: 1







                                     /* Linear: PHYS TO VIRT */
				     static inline void *phys_to_virt(phys_addr_t address);

				     #define __va(x)	((void *)((unsigned long)(x)+PAGE_OFFSET))

                                     /* Linear: VIRT TO PHYS */
				     static inline phys_addr_t virt_to_phys(volatile void *address);

                                     #define __pa(x)	__phys_addr((unsigned long)(x))







                 start_kernel
                   |
                   o-> setup_arch
                         |
                         o-> early_reserve_memory
                         |
                         o-> reserve_brk
                         |     |
                         |     o-> memblock_reserve: [_brk_start, _brk_end]
                         |
                         o-> e820__memblock_setup
                         |     |
                         |     o-> memblock_allow_resize
                         |     |
                         |     o-> memblock_reserve: E820_TYPE_SOFT_RESERVED
                         |     |
                         |     o-> memblock_add: E820_TYPE_RAM/E820_TYPE_RESERVED_KERN
                         |           |
                         |           o-> MEMBLOCK Allocator Can Allocate
                         |
                         o-> memblock_set_current_limit: get_max_mapped()









		/* Allocate Physical Memory anywhere */
                 static __always_inline phys_addr_t memblock_phys_alloc(phys_addr_t size,
                                                                       phys_addr_t align);
                 static __always_inline void *memblock_alloc(phys_addr_t size, phys_addr_t align);
                 static inline void *memblock_alloc_raw(phys_addr_t size, phys_addr_t align);

		/* Allocate Physical Memory on Speical NUMA NODE */
                 phys_addr_t memblock_alloc_range_nid(phys_addr_t size,
                                                      phys_addr_t align, phys_addr_t start,
                                                      phys_addr_t end, int nid, bool exact_nid);
                 phys_addr_t memblock_phys_alloc_try_nid(phys_addr_t size, phys_addr_t align, int nid);
                 void *memblock_alloc_exact_nid_raw(phys_addr_t size, phys_addr_t align,
                        			phys_addr_t min_addr, phys_addr_t max_addr,int nid);
                 void *memblock_alloc_try_nid_raw(phys_addr_t size, phys_addr_t align,
                        			phys_addr_t min_addr, phys_addr_t max_addr, int nid);
                 void *memblock_alloc_try_nid(phys_addr_t size, phys_addr_t align,
                        			phys_addr_t min_addr, phys_addr_t max_addr, int nid);

		/* Allocate Physical Memory on Special Area */
                 phys_addr_t memblock_phys_alloc_range(phys_addr_t size, phys_addr_t align,
                                                      phys_addr_t start, phys_addr_t end);
                 static inline void *memblock_alloc_from(phys_addr_t size,
                 				phys_addr_t align, phys_addr_t min_addr);
                 static inline void *memblock_alloc_low(phys_addr_t size, phys_addr_t align);
                 static inline void *memblock_alloc_node(phys_addr_t size, phys_addr_t align, int nid)
		



                /* Iterate through memblock areas from type_a and not included in type_b*/
                 __for_each_mem_range(i, type_a, type_b, nid, flags, p_start, p_end, p_nid);
                /* Reverse iterate through memblock areas from type_a and not included in type_b */
                __for_each_mem_range_rev(i, type_a, type_b, nid, flags, p_start, p_end, p_nid);
		/* Iterate through memory areas */
                for_each_mem_range(i, p_start, p_end);
		/* Reverse iterate through memblock areas from type_a and not included in type_b */
		for_each_mem_range_rev(i, p_start, p_end);
		/* Iterate over all reserved memblock areas */
		for_each_reserved_mem_range(i, p_start, p_end);
		/* Early memory pfn range iterato */
		for_each_mem_pfn_range(i, nid, p_start, p_end, p_nid);
		/* Iterate through free memblock areas */
		for_each_free_mem_range(i, nid, flags, p_start, p_end, p_nid);
		/* Rev-iterate through free memblock areas */
		for_each_free_mem_range_reverse(i, nid, flags, p_start, p_end, p_nid);
		/* Itereate over memory regions */
		for_each_mem_region(region);
		/* Itereate over reserved memory regions */
		for_each_reserved_mem_region(region);




		/* Check Whether Physical Memory has reserved */
		bool __init_memblock memblock_is_reserved(phys_addr_t addr);
		/* Check Whether Physical Memory is Available Memory */
		bool __init_memblock memblock_is_memory(phys_addr_t addr);
		/* Check Whether Physical Memory has mapped */
		bool __init_memblock memblock_is_map_memory(phys_addr_t addr);
		/* Check Whether Region belong to memblock.memory */
		bool memblock_is_region_memory(phys_addr_t base, phys_addr_t size);
		/* Check Whether Region belong to memblock.reserved */
		bool memblock_is_region_reserved(phys_addr_t base, phys_addr_t size);
		/* Check Whether Region is Hot-Plug */
		static inline bool memblock_is_hotpluggable(struct memblock_region *m);
		/* Check Whether Region is Mirror memory */
		static inline bool memblock_is_mirror(struct memblock_region *m);
		/* Check Whether Region is no mapped */
		static inline bool memblock_is_nomap(struct memblock_region *m);
		/* Obtain Total Size For All Available Physical Memory */
		phys_addr_t memblock_phys_mem_size(void);
		/* Obtain Total Size For memblock.reserved */
		phys_addr_t memblock_reserved_size(void);
		/* Obtain First Physical Address for DRAM */
		phys_addr_t memblock_start_of_DRAM(void);
		/* Obtain Last Physical Address for DRAM */
		phys_addr_t memblock_end_of_DRAM(void);








            MEMBLOCK Allocator Layout

             Bottom                                                                                           UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |
             |      |      | R |        | R |         | R |      | R |    | R |            |                  |
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
                                                        |
                                                        V
                           | <--------------- Allocated Area ---------------> |
                           +---+        +---+         +---+      +---+    +---+
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           +---+        +---+         +---+      +---+    +---+
                                                                   |
                                                                   | Free
                                                                   V
                    +------+   +--------+   +---------+          +---+----+   +------------+
                    |      |   |        |   |         |          |   |    |   |            |
                    |      |   |        |   |         |          |   |    |   |            |
                    |      |   |        |   |         |          |   |    |   |            |
                    +------+   +--------+   +---------+          +---+----+   +------------+
                    | <------------------------ Allocatable Area ------------------------> |
                                                        |
                                                        |
             Bottom                                     V                                                     UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                  |
             +------+------+---+--------+---+---------+---+------+--------+---+------------+------------------+
             |      |      |   |        |   |         |   |      |        |   |            |                  |
             |      |      | R |        | R |         | R |      |        | R |            |                  |
             |      |      |   |        |   |         |   |      |        |   |            |                  |
             +------+------+---+--------+---+---------+---+------+--------+---+------------+------------------+




                         memblock_free
                           |
                           o-> memblock_phys_free: __pa(va)
                                 |
                                 o-> memblock_remove_range
                                       |
                                       o-> memblock_isolate_range
                                       |     |
                                       |     o-> for_each_memblock_type: memblock.reserved 
                                       |           |
                                       |           o-> A: rbase < base
                                       |           |      |
                                       |           |      o-> memblock_insert_region
                                       |           |
                                       |           o-> B: rend > end
                                       |           |      |
                                       |           |      o-> memblock_insert_region
                                       |           |
                                       |           o-> C: [rbase, rend] == [base, end]
                                       |                  | 
                                       |                  o-> start_rgn/end_rgn
                                       |
                                       o-> for: start_rgn -- end_rgn
                                             |
                                             o-> memblock_remove_region






                                                 struct memblock_region
                       struct memblock_type      memblock_memory_init_regions[INIT_MEMBLOCK_MEMORY_REGIONS]
                               +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                               |          |      |     |     |     |     |     |     |     |      |    |     |
                         o---> |  memory  |----> | R00 | R01 | R02 | R03 | R04 | R05 | R06 |  R07 |... | RXY |
       struct memblock   |     |          |      |     |     |     |     |     |     |     |      |    |     |
       +------------+    |     +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
       |            |----o
       |  memblock  |
       |            |----o
       +------------+    |     +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                         |     |          |      |     |     |     |     |     |     |     |      |    |     |
                         o---> | reserved |----> | R00 | R01 | R02 | R03 | R04 | R05 | R06 |  R07 |... | RXY |
                               |          |      |     |     |     |     |     |     |     |      |    |     |
                               +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                       struct memblock_type      memblock_reserved_init_regions[INIT_MEMBLOCK_RESERVED_REGIONS]
                                                 struct memblock_region




                                   Physical Address Space

                                   LOW                                                                        HIGH
                                   |                                                                          |
                                   +----------------+--+-----------+-------+-------------+---+----------------+
                                   |                |  |           |       |             |   |                |
                                   |                |  |           |  ...  |             |   |                |
                                   |                |  |           |       |             |   |                |
                                   +----------------+--+-----------+-------+-------------+---+----------------+
                                   A                   A                   A                 A
                                   |                   |                   |                 |
                                   o----------------o  o--o                |      o----------o
                                                    |     |                |      |          
                                                    |     |                |      |          
          struct memblock                           |     |                |      |          
          +--------------+     +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
          |              |     |          |      |     |     |     |     |     |     |     |      |    |     |
          |   memblock   |---> |  memory  |----> | R00 | R01 | R02 | R03 | R04 | R05 | R06 |  R07 |... | RXY |
          |              |     |          |      |     |     |     |     |     |     |     |      |    |     |
          +--------------+     +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                       struct memblock_type      struct memblock_region
                                                 memblock_memory_init_regions[INIT_MEMBLOCK_MEMORY_REGIONS]
       
       
       
       
                     
                     
                     
                     
                     
                     




                                                                                +--------------+                            +--------------+
                                                                                |              |                            |              |
                                                                                | Data Writing |                            | Data Reading |
                                                                                |              |                            |              |
                                                                                +--------------+                            +--------------+
                                                                                       |                                           A
                                                                                       |                                           |
                                                                                       V                                           |
                                                                               +----------------+                          +----------------+
                                                                               | Memory  Access |                          | Memory  Access |
                                                                               |   Controller   |                          |   Controller   |
                                                                               +----------------+                          +----------------+
                                                                                       |                                           A
                                                                               o-------o--------o                                  | Compared
                                                                               |                |                          o-------o--------o
                                                                               |                |                          |                |
                                                                               V                V                          |                |
                                                                          +----------+     +----------+               +----------+     +----------+
                                                                          |          |     |          |               |          |     |          |
                                                                          | Memory A |     | Memory B |               | Memory A |     | Memory B |
                                                                          |          |     |          |               |          |     |          |
                                                                          +----------+     +----------+               +----------+     +----------+








                                                                                       +--------------+                                +--------------+
                                                                                       |              |                                |              |
                                                                                       | Data Reading |                                | Data Reading |
                                                                                       |              |                                |              |
                                                                                       +--------------+                                +--------------+
                                                                                              A                                               A
                                                                                              |                                               |
                                                                                              |                                               |
                                                                                      +----------------+                              +----------------+
                                                                                      | Memory  Access |                              | Memory  Access |
                                                                                      |   Controller   |                              |   Controller   |
                                                                                      +----------------+                              +----------------+
                                                                                              A                                               A
                                                                                              | Compared                                      | 
                                                                                      o-------o--------o                                      o--------o
                                                                                      |                |                              A                |
                                                                                      |                |                           UE |                |
                                                                                 +----------+     +----------+                   +----------+     +----------+
                                                                                 |          |     |          |                   |          |     |          |
                                                                                 | Memory A |     | Memory B |                   | Memory A |     | Memory B |
                                                                                 |          |     |          |                   |          |     |          |
                                                                                 +----------+     +----------+                   +----------+     +----------+









                                   Physical Address Space

                                   LOW                                                                        HIGH
                                   |                                       | <- Mirror --> |                    |
                                   +----------------+--+-----------+-------+---------------+---+----------------+
                                   |                |  |           |       |               |   |                |
                                   |                |  |           |  ...  | Memory Mirror |   |                |
                                   |                |  |           |       |               |   |                |
                                   +----------------+--+-----------+-------+---------------+---+----------------+
                                   A                   A                   A                   A
                                   |                   |                   |                   |
                                   o----------------o  o--o                |      o------------o
                                                    |     |                |      |
                                                    |     |                |      |
          struct memblock                           |     |                |      |
          +--------------+     +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
          |              |     |          |      |     |     |     |     |     |     |     |      |    |     |
          |   memblock   |---> |  memory  |----> | R00 | R01 | R02 | R03 | R04 | R05 | R06 |  R07 |... | RXY |
          |              |     |          |      |     |     |     |     |     |     |     |      |    |     |
          +--------------+     +----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                       struct memblock_type      struct memblock_region
                                                 memblock_memory_init_regions[INIT_MEMBLOCK_MEMORY_REGIONS]







            MEMBLOCK Allocator Layout

                    | <------------------------ Allocatable Area ------------------------> |
                    +------+   +--------+   +---------+              +----+   +------------+
                    |      |   |        |   |         |              |    |   |            |
                    |      |   |        |   |         |              |    |   |            |
                    |      |   |        |   |         |              |    |   |            |
                    +------+   +--------+   +---------+              +----+   +------------+
                                                        A                     | <-mirror-> |
                                                        |
             Bottom                                     |                                                     UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |
             |      |      | R |        | R |         | R |      | R |    | R |            |                  |
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
                                                        |                     | <-mirror-> |
                                                        |
                                                        V
                           +---+        +---+         +---+      +---+    +---+
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           +---+        +---+         +---+      +---+    +---+
                           | <--------------- Allocated Area ---------------> |






            MEMBLOCK Allocator Layout

                    | <---------------- Allocatable Area ---------------> |
                    +------+   +--------+   +---------+              +----+   
                    |      |   |        |   |         |              |    |   
                    |      |   |        |   |         |              |    |   
                    |      |   |        |   |         |              |    |   
                    +------+   +--------+   +---------+              +----+   
                    | <----------------- Un-Mirrorable -----------------> |
                                                        A                     
                                                        |
             Bottom                                     |                                                     UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |
             |      |      | R |        | R |         | R |      | R |    | R |            |                  |
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
                                                        |                     | <-mirror-> |
                                                        |
                                                        V                 
                           +---+        +---+         +---+      +---+    +----------------+
                           |   |        |   |         |   |      |   |    |                |
                           |   |        |   |         |   |      |   |    |                |
                           |   |        |   |         |   |      |   |    |                |
                           +---+        +---+         +---+      +---+    +----------------+
                           | <--------------------- Allocated Area ----------------------> |







WordPress



            MEMBLOCK Allocator Layout

                    | <------------------------ Allocatable Area ------------------------> |
                    +------+   +--------+   +---------+              +----+   +------------+
                    |      |   |        |   |         |              |    |   |            |
                    |      |   |        |   |         |              |    |   |            |
                    |      |   |        |   |         |              |    |   |            |
                    +------+   +--------+   +---------+              +----+   +------------+
                                                        A
                                                        |
             Bottom                                     |                                                                 UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                              |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                              |
             |      |      | R |        | R |         | R |      | R |    | R |            |                              |
             |      |      |   |        |   |         |   |      |   |    |   |            |                              |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------------------+
                                                        |                                  | <- System Reserved Memory -> |
                                                        |
                                                        V
                           +---+        +---+         +---+      +---+    +---+
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           +---+        +---+         +---+      +---+    +---+
                           | <--------------- Allocated Area ---------------> |





                                                   
                               +-----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                               |           |      |     |     |     |     |     |     |     |      |    |     |
                               |  physmem  |----> | R00 | R01 | R02 | R03 | R04 | R05 | R06 |  R07 |... | RXY |
                               |           |      |     |     |     |     |     |     |     |      |    |     |
                               +-----------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                        struct memblock_type      struct memblock_region
                                                  memblock_physmem_init_regions[INIT_PHYSMEM_REGIONS]








                                   Physical Address Space

                                   LOW                                                                         HIGH
                                   |                                       | <- Reserved -> |                     |
                                   +----------------+--+-----------+-------+----------------+---+-----------------+
                                   |                |  |           |       |                |   |                 |
                                   |                |  |           |  ...  |                |   |                 |
                                   |                |  |           |       |                |   |                 |
                                   +----------------+--+-----------+-------+----------------+---+-----------------+
                                   A                   A                   A                    A <- Avail-mem -> |
                                   |                   |                   |                    |
                                   o----------------o  o--o                |      o-------------o
                                                    |     |                |      |
                                                    |     |                |      |
                                                    |     |                |      |
                                +---------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                                |         |      |     |     |     |     |     |     |     |      |    |     |
                                | physmem |----> | R00 | R01 | R02 | R03 | R04 | R05 | R06 |  R07 |... | RXY |
                                |         |      |     |     |     |     |     |     |     |      |    |     |
                                +---------+      +-----+-----+-----+-----+-----+-----+-----+------+----+-----+
                       struct memblock_type      struct memblock_region
                                                 memblock_physmem_init_regions[INIT_PHYSMEM_REGIONS]





            MEMBLOCK Allocator Layout

                    | <------------------------ Allocatable Area ------------------------> |
                    +------+   +--------+   +---------+              +----+   +------------+
                    |      |   |        |   |         |              |    |   |            |
                    |      |   |        |   |         |              |    |   |            |
                    |      |   |        |   |         |              |    |   |            |
                    +------+   +--------+   +---------+              +----+   +------------+
                                                        A
                                                        |
                           +---+        +---+         +---+      +---+    +---+
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           +---+        +---+         +---+      +---+    +---+
                           | <--------------- Allocated Area ---------------> |
                                                        A
             Bottom                                     |                                                                 UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                              |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                              |
             |      |      | R |        | R |         | R |      | R |    | R |            |                              |
             |      |      |   |        |   |         |   |      |   |    |   |            |                              |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------------------+
                    | <------- physmem.region[0] -------> |      | <---------------- physmem.region[1] -----------------> |
                                                                                                          |
                                                                                                          V
                                                                                           +------------------------------+
                                                                                           |                              |
                                                                                           |                              |
                                                                                           |                              |
                                                                                           +------------------------------+
                                                                                           | <- System Reserved Memory -> |                         










                 MEMBLOCK Allocator Layout
 
                 Bottom                                                                                                        UP
                 |                                                                                                             |
                 | <-- memory.region[0] --> | <- memory.region[1] -> |     | <- memory.region[n] -> | <- memblock.region[m] -> |
                 +------------+-------------+------------------------+-----+------------------------+--------------------------+
                 |            |             |                        |     |                        |                          |
                 |            |             |                        | ... |                        |                          |
                 |            |             |                        |     |                        |                          |
                 +------------+-------------+------------------------+-----+------------------------+--------------------------+
                       A              A     | <-- MEMBLOCK_NOMAP --> |        A                     | <-- MEMBLOCK_HOTPLUG --> |
                       |              |                                       |
                       |              |                                       |
                       |              o------ MEMBLOCK_MIRROR                 |
                       o--------------------- MEMBLOCK_NONE                   o--- MEMBLOCK_DRIVER_MANAGED


                       





                   add_memory_resource
                     |
                     o-> if: IS_ENABLED(CONFIG_ARCH_KEEP_MEMBLOCK)
                     |     |
                     |     o-> if: res->flags & IORESOURCE_SYSRAM_DRIVER_MANAGED
                     |           |
                     |           o-> memblock_flags = MEMBLOCK_DRIVER_MANAGED
                     |
                     o-> memblock_add_node: memblock_flags
                     |
                     o-> __try_online_node
                     |
                     o-> arch_add_memory
                     |
                     o-> create_memory_block_devices
                     |
                     o-> register_memory_blocks_under_node







CRASH
SYSCALL_DEFINE4(kexec_load
crashk_res


 parse_crashkernel_dummy
 

                    start_kernel
                      |
                      o-> setup_arch
                            |
                            o-> reserve_crashkernel
                                  |
                                  o-> parse_crashkernel: crash_size, crash_base
                                  |     |
                                  |     o-> __parse_crashkernel
                                  |
                                  o-> memblock_phys_alloc_range: [crash_base, crash_base + crash_size]
                                  |
                                  o-> crash_res.start: crash_base
                                  |
                                  o-> crash_res.end: crash_base + crash_size - 1
                                  |
                                  o-> insert_resource: iomem_reserouce












                        start_kernel
                          |
                          o-> setup_arch
                                |
                                o-> initmem_init
                                      |
                                      o-> x86_numa_init
                                            |
                                            o-> numa_init
                                            |     |
                                            |     o-> acpi_numa_init
                                            |           |
                                            |           o-> acpi_parse_memory_affinity
                                            |                 |
                                            |                 o-> acpi_numa_memory_affinity_init
                                            |                       |
                                            |                       o-> hutplugable: CONFIG_MEMORY_HOTPLUG &
                                            |                       |                ACPI_SRAT_MEM_HOT_PLUGGABLE
                                            |                       |
                                            |                       o-> if: hutplugable
                                            |                             |
                                            |                             o-> memblock_mark_hotplug
                                            |
                                            o-> numa_register_memblks
                                                  |
                                                  o-> numa_clear_kernel_node_hotplug
                                                        |
                                                        o-> memblock_clear_hotplug






            MEMBLOCK Allocator Layout

                    | <------------------------ Allocatable Area ------------------------> |
                    +------+   +--------+   +---------+              +----+   +------------+
                    |      |   |        |   |         |              |    |   |            |
                    |      |   |        |   |         |              |    |   |            |
                    |      |   |        |   |         |              |    |   |            |
                    +------+   +--------+   +---------+              +----+   +------------+
                                                        A                     | <-mirror-> |
                                                        |
             Bottom                                     |                                                     UP
             |      | <------- memory.regions[0] -------> |      | <- memory.regions[1] -> |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |
             |      |      | R |        | R |         | R |      | R |    | R |            |                  |
             |      |      |   |        |   |         |   |      |   |    |   |            |                  |
             +------+------+---+--------+---+---------+---+------+---+----+---+------------+------------------+
                                                        |                     | <-mirror-> |
                                                        |
                                                        V
                           | <--------------- Allocated Area ---------------> |
                           +---+        +---+         +---+      +---+    +---+
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           |   |        |   |         |   |      |   |    |   |
                           +---+        +---+         +---+      +---+    +---+
                                                                   A        A
                                                                   |        |
                                                                   |        o---- MEMBLOCK_NOMAP
                                                                   o------------- MEMBLOCK_NOMAP





	fdt_init_reserved_mem
          |
          o-> of_get_flat_dt_prop: "no-map"
          |
          o-> __reserved_mem_alloc_size
                |
                o-> of_get_flat_dt_prop: "size"
                |
                o-> of_get_flat_dt_prop: "alignment"
                |
                o-> of_get_flat_dt_prop: "no-map"
                |
                o-> of_get_flat_dt_prop: "alloc-ranges"
                      |
                      o-> early_init_dt_alloc_reserved_memory_arch
                            |
                            o-> memblock_phys_alloc_range: [start, end]
                            |
                            o-> memblock_mark_nomap




                       MEMBLOCK Region Separation


                                 +-----------------+                                                +-----------------+ 
                                 |                 |                                                |                 |
                                 |                 |                                                |                 |
                                 |                 |                                                |                 |
                                 +-----------------+                                                +-----------------+
                                          |                                                                  |         
                                          |                                                                  |         
                                          V                                                                  V         
                       -----------------------------------+-----------------------------------+-----------------------------
                                                          |                                   |
                                                          | <---------- Region[0] ----------> |
                                                          |                                   |
                       -----------------------------------+-----------------------------------+-----------------------------
                                                                            |
                                                                            |
                                                                            V
                       ----------+-----------------+------+-----------------------------------+-----+-----------------+-----
                                 |                 |      |                                   |     |                 |
                                 | <- Region[0] -> |      | <---------- Region[1] ----------> |     | <- Region[2] -> |
                                 |                 |      |                                   |     |                 |
                       ----------+-----------------+------+-----------------------------------+-----+-----------------+-----







                       MEMBLOCK Region Adjacent


                                 +-----------------+                                   +-----------------+
                                 |                 |                                   |                 |
                                 |                 |                                   |                 |
                                 |                 |                                   |                 |
                                 +-----------------+                                   +-----------------+
                                          |                                                    |
                                          |                                                    |
                                          V                                                    V
                       ----------------------------+-----------------------------------+-----------------------
                                                   |                                   |
                                                   | <---------- Region[0] ----------> |
                                                   |                                   |
                       ----------------------------+-----------------------------------+-----------------------
                                                                     |
                                                                     |
                                                                     V
                       ----------+-----------------------------------------------------------------------+-----
                                 |                                                                       |
                                 | <---------------------------- Region[0] ----------------------------> |
                                 |                                                                       |
                       ----------+-----------------------------------------------------------------------+-----






                       MEMBLOCK Region Adjacent with Diff flags


                                 +-----------------+                                   +-----------------+
                                 |                 |                                   |                 |
                                 |                 |                                   |                 |
                                 |                 |                                   |                 |
                                 +-----------------+                                   +-----------------+
                                          |                                                    |
                                          |                                                    |
                                          V                                                    V
                       ----------------------------+-----------------------------------+-----------------------
                                                   |                                   |
                                                   | <---------- Region[0] ----------> |
                                                   |                                   |
                       ----------------------------+-----------------------------------+-----------------------
                                                                     |
                                                                     |
                                                                     V
                       ----------+-----------------+-----------------------------------+-----------------+-----
                                 |                 |                                   |                 |
                                 | <- Region[0] -> | <---------- Region[1] ----------> | <- Region[2] -> |
                                 |                 |                                   |                 |
                       ----------+-----------------+-----------------------------------+-----------------+-----







                       MEMBLOCK Region intersection


                                 +-----------------+                       +-----------------+
                                 |                 |                       |                 |
                                 |                 |                       |                 |
                                 |                 |                       |                 |
                                 +-----------------+                       +-----------------+
                                          |                                         |
                                          |                                         |
                                          V                                         V
                       -----------------------+-----------------------------------+-------------
                                              |                                   |
                                              | <---------- Region[0] ----------> |
                                              |                                   |
                       -----------------------+-----------------------------------+-------------
                                                                            |
                                                                            |
                                                                            V
                       ----------+-----------------------------------------------------------+---
                                 |                                                           |   
                                 | <---------------------- Region[0] ----------------------> |   
                                 |                                                           |   
                       ----------+-----------------------------------------------------------+---








                                         Correct Way                                                                                                                    Uncorrect Way

                                               +--------------+                  +--------------+              |             +--------------+                 +--------------+
                                               |              |                  |              |              |             |              |                 |              |
                                               | Data Writing |                  | Data Reading |              |             | Data Reading |                 | Data Reading |
                                               |              |                  |              |              |             |              |                 |              |
                                               +--------------+                  +--------------+              |             +--------------+                 +--------------+
                                                      |                                 A                      |                    A                                A
                                                      |                                 |                      |                    |                                |
                                                      V                                 |                      |                    |                                |
                                              +----------------+                +----------------+             |            +----------------+               +----------------+
                                              | Memory  Access |                | Memory  Access |             |            | Memory  Access |               | Memory  Access |
                                              |   Controller   |                |   Controller   |             |            |   Controller   |               |   Controller   |
                                              +----------------+                +----------------+             |            +----------------+               +----------------+
                                                      |                                 A                      |                    A                                A
                                              o-------o--------o                        | Compared             |                    | Compared                       |
                                              |                |                o-------o--------o             |            o-------o--------o                       o--------o
                                              |                |                |                |             |            |                |               A                |
                                              V                V                |                |             |            |                |            UE |                |
                                         +----------+     +----------+     +----------+     +----------+       |       +----------+     +----------+    +----------+     +----------+
                                         |          |     |          |     |          |     |          |       |       |          |     |          |    |          |     |          |
                                         | Memory A |     | Memory B |     | Memory A |     | Memory B |       |       | Memory A |     | Memory B |    | Memory A |     | Memory B |
                                         |          |     |          |     |          |     |          |       |       |          |     |          |    |          |     |          |
                                         +----------+     +----------+     +----------+     +----------+       |       +----------+     +----------+    +----------+     +----------+








                                                                                       +--------------+                                +--------------+
                                                                                       |              |                                |              |
                                                                                       | Data Reading |                                | Data Reading |
                                                                                       |              |                                |              |
                                                                                       +--------------+                                +--------------+
                                                                                              A                                               A
                                                                                              |                                               |
                                                                                              |                                               |
                                                                                      +----------------+                              +----------------+
                                                                                      | Memory  Access |                              | Memory  Access |
                                                                                      |   Controller   |                              |   Controller   |
                                                                                      +----------------+                              +----------------+
                                                                                              A                                               A
                                                                                              | Compared                                      |
                                                                                      o-------o--------o                                      o--------o
                                                                                      |                |                              A                |
                                                                                      |                |                           UE |                |
                                                                                 +----------+     +----------+                   +----------+     +----------+
                                                                                 |          |     |          |                   |          |     |          |
                                                                                 | Memory A |     | Memory B |                   | Memory A |     | Memory B |
                                                                                 |          |     |          |                   |          |     |          |
                                                                                 +----------+     +----------+                   +----------+     +----------+






                          start_kernel
                            |
                            o-> setup_arch
                                  |
                                  o-> efi_find_mirror
                                        |
                                        o-> for_each_efi_memory_desc
                                              |
                                              o-> if: md->attribute & EFI_MEMORY_MORE_RELIABLE
                                                    |
                                                    o-> memblock_mark_mirror











   __setup("hugepages=", hugepages_setup)
     |
     o-> hugepages_setup
           |
           o-> if: hugetlb_max_hstate && hstate_is_gigantic
                 |
                 o-> hugetlb_hstate_alloc_pages
                       |
                       o-> for: h->max_huge_pages
                             |
                             o-> if: hstate_is_gigantic
                                   |
                                   o-> alloc_bootmem_huge_page
                                         |
                                         o-> memblock_alloc_try_nid_raw







    start_kernel
      |
      o-> setup_arch
      |
      o-> mm_init
            |
            o-> mem_init
                  |
                  o-> memblock_free_all
                        |
                        o-> reset_all_zones_managed_pages
                        |     |
                        |     o-> for_each_online_pgdat
                        |           |
                        |           o-> reset_node_managed_pages
                        |                 |
                        |                 o-> for: [pgdat->node_zones, pgdat->node_zones + MAX_NR_ZONES]
                        |                       |
                        |                       o-> atomic_long_set ==> z->managed_pages: 0
                        |
                        o-> free_low_memory_core_early
                        |     |
                        |     o-> memblock_clear_hotplug
                        |     |
                        |     o-> memmap_init_reserved_pages
                        |     |     |
                        |     |     o-> for_each_reserved_mem_range
                        |     |           |
                        |     |           o-> reserve_bootmem_region
                        |     |                 |
                        |     |                 o-> __SetPageReserved
                        |     |
                        |     o-> for_each_mem_region
                        |     |     |
                        |     |     o-> memblock_is_nomap
                        |     |           |
                        |     |           o-> reserve_bootmem_region
                        |     |
                        |     o-> for_each_free_mem_range
                        |           |
                        |           o-> __free_memory_core
                        |                 |
                        |                 o-> __free_pages_memory
                        |                       |
                        |                       o-> memblock_free_pages
                        |                             |
                        |                             o-> __free_pages_core
                        |                                   |
                        |                                   o-> __ClearPageReserved
                        |                                   |
                        |                                   o-> atomic_long_add ==> page_zone(page)->managed_pages
                        |                                   |
                        |                                   o-> __free_pages_ok ==> Buddy
                        |
                        o-> totalram_pages_add
                              |
                              o-> atomic_long_add ==> _totalram_pages













                 MEMBLOCK Allocator Layout

                 Bottom                                                                                                        UP
                 |                                                                                                             |
                 | <-- memory.region[0] --> | <- memory.region[1] -> |     | <- memory.region[n] -> | <- memblock.region[m] -> |
                 +------------+-------------+------------------------+-----+------------------------+--------------------------+
                 |            |             |                        |     |                        |                          |
                 |            |             |                        | ... |                        |                          |
                 |            |             |                        |     |                        |                          |
                 +------------+-------------+------------------------+-----+------------------------+--------------------------+
                       A              A            A                          A                     | <-- MEMBLOCK_MIRROR ---> |
                       |              |            |                          |
                       |              |            |                          |
                       |              |            |                          o--- MEMBLOCK_DRIVER_MANAGED ==> Driver
                       |              |            |                          
                       |              |            |                          
                       |              |            o-- MEMBLOCK_NOMAP    ==> PageReserved                      
                       |              o--------------- MEMBLOCK_HOTPLUG  ==> Buddy      
                       o------------------------------ MEMBLOCK_NONE     ==> Buddy     









